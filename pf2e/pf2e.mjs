var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,"name",{value,configurable:!0});var __defProp2=Object.defineProperty,__name2=__name((target,value)=>__defProp2(target,"name",{value,configurable:!0}),"__name");import{s as state,p as proxy,g as get,a as set,m as mount$1,u as unmount,e,b as e$1,n,c as e$2,d as n$1,t,f as t$1,h as t$2,i as t$3,j as e$3,k as t$4,l as from_html,o as if_block,q as each,r as template_effect,v as bind_value,w as append,x as pop,y as sibling,z as push,A as child,B as index,C as user_derived,D as set_text,E as set_attribute,F as text,G as comment,H as first_child,I as set_class,J as event$1,K as t$5,L as e$4,M as t$6,N as t$7,O as t$8,P as t$9,Q as getDefaultExportFromCjs,R as requireTagify_min,S as Sortable,T as e$5,U as e$6,V as n$2,W as set_checked,X as bind_select_value,Y as delegate,Z as to_array,_ as MiniSearch,$ as t$a,a0 as t$b,a1 as n$3,a2 as Duration,a3 as Interval,a4 as DateTime,a5 as noUiSlider,a6 as PipsMode,a7 as prop,a8 as clsx,a9 as enable_legacy_mode_flag,aa as from_svg,ab as t$c,ac as t$d,ad as set_value,ae as e$7,af as r,ag as t$e,ah as t$f,ai as t$g,aj as t$h,ak as v5,al as n$4,am as t$i,an as t$j,ao as Svelecte,ap as spread_props,aq as rest_props,ar as user_effect,as as noop,at as EditorView,au as basicSetup,av as keymap,aw as json,ax as linter,ay as autocompletion,az as indentWithTab,aA as syntaxTree,aB as jsonParseLinter,aC as html,aD as transition,aE as attribute_effect,aF as snippet,aG as update_version,aH as source,aI as increment,aJ as onMount,aK as action$J,aL as init_select,aM as select_option,aN as bind_this,aO as t$k,aP as r$1,aQ as untrack,aR as t$l,aS as t$m}from"./vendor.mjs";function SvelteApplicationMixin(Base){class SvelteApplication extends Base{static{__name(this,"SvelteApplication")}static{__name2(this,"SvelteApplication")}static DEFAULT_OPTIONS={classes:["pf2e"]};#$state=state(proxy({}));get $state(){return get(this.#$state)}set $state(value){set(this.#$state,value,!0)}#mount={};async _renderHTML(context){return context}_replaceHTML(result,content,options){Object.assign(this.$state,result.state),options.isFirstRender&&(this.#mount=mount$1(this.root,{target:content,props:{...result,state:this.$state}}))}_onClose(options){super._onClose(options),unmount(this.#mount)}}return SvelteApplication}__name(SvelteApplicationMixin,"SvelteApplicationMixin"),__name2(SvelteApplicationMixin,"SvelteApplicationMixin");const MAGIC_TRADITIONS=new Set(["arcane","divine","occult","primal"]);class DelegatedCollection{static{__name(this,"DelegatedCollection")}static{__name2(this,"DelegatedCollection")}#data;constructor(entries=[]){this.#data=new Collection(entries)}[Symbol.iterator](){return this.#data.values()}get size(){return this.#data.size}get contents(){return this.#data.contents}values(){return this.#data.values()}get(key,options){return this.#data.get(key,options)}getName(name2,options){return this.#data.getName(name2,options)}set(key,value){return this.#data.set(key,value),this}has(key){return this.#data.has(key)}find(predicate){return this.#data.find(predicate)}some(predicate){return this.#data.some(predicate)}filter(predicate){return this.#data.filter(predicate)}map(callback){return this.#data.map(callback)}flatMap(callback){return this.#data.contents.flatMap(callback)}delete(key){return this.#data.delete(key)}clear(){this.#data.clear()}}function createHTMLElement(nodeName,{id,classes=[],dataset={},aria={},children=[],innerHTML}={}){const element=document.createElement(nodeName);id&&(element.id=id),classes.length>0&&element.classList.add(...classes);for(const[key,value]of Object.entries(dataset))e(value)||value===!1||(element.dataset[key]=value===!0?"":String(value));for(const[key,value]of Object.entries(aria))e(value)||value===!1||element.setAttribute(`aria-${key}`,value);if(innerHTML)element.innerHTML=innerHTML;else for(const child2 of children){const childElement=child2 instanceof HTMLElement?child2:new Text(child2);element.appendChild(childElement)}return element}__name(createHTMLElement,"createHTMLElement"),__name2(createHTMLElement,"createHTMLElement");function htmlQuery(parent,selectors){return parent instanceof Element||parent instanceof Document?parent.querySelector(selectors):null}__name(htmlQuery,"htmlQuery"),__name2(htmlQuery,"htmlQuery");function htmlQueryAll(parent,selectors){return parent instanceof Element||parent instanceof Document?Array.from(parent.querySelectorAll(selectors)):[]}__name(htmlQueryAll,"htmlQueryAll"),__name2(htmlQueryAll,"htmlQueryAll");function htmlClosest(child2,selectors){return child2 instanceof Element?child2.closest(selectors):null}__name(htmlClosest,"htmlClosest"),__name2(htmlClosest,"htmlClosest");function htmlSelectorFor(element){const nodeName=element.nodeName.toLowerCase(),classes=element.className.split(" ").filter(e$1),classesString=classes.length>0?`.${classes.join(".")}`:"",datasetString=Object.entries(element.dataset).map(([k,v])=>[k.replace(/([A-Z])/g,"-$1").toLowerCase(),v]).map(([k,v])=>`[data-${k}="${v}"]`).join("");return`${nodeName}${classesString}${datasetString}`}__name(htmlSelectorFor,"htmlSelectorFor"),__name2(htmlSelectorFor,"htmlSelectorFor");function groupBy(array,criterion){const result=new Map;for(const elem of array){const key=criterion(elem),group=result.get(key);group?group.push(elem):result.set(key,[elem])}return result}__name(groupBy,"groupBy"),__name2(groupBy,"groupBy");function applyNTimes(func,times,start){let result=start;for(let i=0;i<times;i+=1)result=func(result);return result}__name(applyNTimes,"applyNTimes"),__name2(applyNTimes,"applyNTimes");function objectHasKey(obj,key){return(typeof key=="string"||typeof key=="number")&&key in obj}__name(objectHasKey,"objectHasKey"),__name2(objectHasKey,"objectHasKey");function tupleHasValue(array,value){return array.includes(value)}__name(tupleHasValue,"tupleHasValue"),__name2(tupleHasValue,"tupleHasValue");function setHasElement(set2,value){return set2.has(value)}__name(setHasElement,"setHasElement"),__name2(setHasElement,"setHasElement");let intlNumberFormat;function signedInteger(value,{emptyStringZero=!1,zeroIsNegative=!1}={}){if(value===0&&emptyStringZero)return"";const nf=intlNumberFormat??=new Intl.NumberFormat(game.i18n.lang,{maximumFractionDigits:0,signDisplay:"always"}),maybeNegativeZero=zeroIsNegative&&value===0?-0:value;return nf.format(maybeNegativeZero)}__name(signedInteger,"signedInteger"),__name2(signedInteger,"signedInteger");const wordCharacter=String.raw`[\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,nonWordCharacter=String.raw`[^\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]`,nonWordBoundary=String.raw`(?=^|$|${wordCharacter})`,lowerCaseLetter=String.raw`\p{Lowercase_Letter}`,upperCaseLetter=String.raw`\p{Uppercase_Letter}`,nonWordCharacterRE=new RegExp(nonWordCharacter,"gu"),lowerCaseThenUpperCaseRE=new RegExp(`(${lowerCaseLetter})(${upperCaseLetter}${nonWordBoundary})`,"gu"),nonWordCharacterHyphenOrSpaceRE=/[^-\p{White_Space}\p{Alphabetic}\p{Mark}\p{Decimal_Number}\p{Join_Control}]/gu,upperOrWordBoundariedLowerRE=new RegExp(`${upperCaseLetter}|${nonWordCharacter}${lowerCaseLetter}`,"gu");function sluggify(text2,{camel=null}={}){if(typeof text2!="string")return console.warn("Non-string argument passed to `sluggify`"),"";if(text2==="-")return text2;switch(camel){case null:return text2.replace(lowerCaseThenUpperCaseRE,"$1-$2").toLowerCase().replace(/['â€™]/g,"").replace(nonWordCharacterRE," ").trim().replace(/[-\s]+/g,"-");case"bactrian":{const dromedary=sluggify(text2,{camel:"dromedary"});return dromedary.charAt(0).toUpperCase()+dromedary.slice(1)}case"dromedary":return text2.replace(nonWordCharacterHyphenOrSpaceRE,"").replace(/[-_]+/g," ").replace(upperOrWordBoundariedLowerRE,(part,index2)=>index2===0?part.toLowerCase():part.toUpperCase()).replace(/\s+/g,"");default:throw ErrorPF2e("I don't think that's a real camel.")}}__name(sluggify,"sluggify"),__name2(sluggify,"sluggify");function parseHTML(unparsed){const fragment=document.createElement("template");fragment.innerHTML=unparsed;const element=fragment.content.firstElementChild;if(!(element instanceof HTMLElement))throw ErrorPF2e("Unexpected error parsing HTML");return element}__name(parseHTML,"parseHTML"),__name2(parseHTML,"parseHTML");const actionGlyphMap={0:"F",free:"F",1:"1",2:"2",3:"3","1 or 2":"1/2","1 to 3":"1 - 3","2 or 3":"2/3","2 rounds":"3,3",reaction:"R"};function getActionGlyph(action2){if(!action2&&action2!==0)return"";const value=typeof action2!="object"?action2:action2.type==="action"?action2.value:action2.type,sanitized=String(value??"").toLowerCase().trim();return actionGlyphMap[sanitized]?.replace("-","\u2013")??""}__name(getActionGlyph,"getActionGlyph"),__name2(getActionGlyph,"getActionGlyph");function ErrorPF2e(message){return Error(`PF2e System | ${message}`)}__name(ErrorPF2e,"ErrorPF2e"),__name2(ErrorPF2e,"ErrorPF2e");let pluralRules;function ordinalString(value){pluralRules??=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"});const suffix=game.i18n.localize(`PF2E.OrdinalSuffixes.${pluralRules.select(value)}`);return game.i18n.format("PF2E.OrdinalNumber",{value,suffix})}__name(ordinalString,"ordinalString"),__name2(ordinalString,"ordinalString");function localizeList(items,{conjunction="or"}={}){items=[...items].sort((a,b)=>a.localeCompare(b,game.i18n.lang));const parts=conjunction==="or"?"PF2E.ListPartsOr":"PF2E.ListPartsAnd";if(items.length===0)return"";if(items.length===1)return items[0];if(items.length===2)return game.i18n.format(`${parts}.two`,{first:items[0],second:items[1]});let result=game.i18n.format(`${parts}.start`,{first:items[0],second:"{second}"});for(let i=1;i<=items.length-2;i++)if(i===items.length-2){const end=game.i18n.format(`${parts}.end`,{first:items[i],second:items[items.length-1]});result=result.replace("{second}",end)}else{const newSegment=game.i18n.format(`${parts}.middle`,{first:items[i],second:"{second}"});result=result.replace("{second}",newSegment)}return result}__name(localizeList,"localizeList"),__name2(localizeList,"localizeList");function splitListString(str,{delimiter=",",unique=!0}={}){const list=str.split(delimiter).map(el=>el.trim()).filter(el=>el!=="");return unique?n(list):list}__name(splitListString,"splitListString"),__name2(splitListString,"splitListString");function fontAwesomeIcon(glyph,{style="solid",fixedWidth=!1}={}){const styleClass=`fa-${style}`,glyphClass=glyph.startsWith("fa-")?glyph:`fa-${glyph}`,icon=document.createElement("i");return icon.classList.add(styleClass,glyphClass),icon.inert=!0,fixedWidth&&icon.classList.add("fa-fw"),icon}__name(fontAwesomeIcon,"fontAwesomeIcon"),__name2(fontAwesomeIcon,"fontAwesomeIcon");function sortLabeledRecord(record){return Object.entries(record).sort((a,b)=>a[1].label.localeCompare(b[1].label,game.i18n.lang)).reduce((copy,[key,value])=>foundry.utils.mergeObject(copy,{[key]:value}),{})}__name(sortLabeledRecord,"sortLabeledRecord"),__name2(sortLabeledRecord,"sortLabeledRecord");function sortStringRecord(record){return Object.fromEntries(Object.entries(record).map(entry=>(entry[1]=game.i18n.localize(entry[1]),entry)).sort((a,b)=>a[1].localeCompare(b[1],game.i18n.lang)))}__name(sortStringRecord,"sortStringRecord"),__name2(sortStringRecord,"sortStringRecord");function recursiveReplaceString(source2,replace){const clone=Array.isArray(source2)||e$2(source2)?foundry.utils.deepClone(source2):source2;if(typeof clone=="string")return replace(clone);if(Array.isArray(clone))return clone.map(e2=>recursiveReplaceString(e2,replace));if(e$2(clone))for(const[key,value]of Object.entries(clone))clone[key]=recursiveReplaceString(value,replace);return clone}__name(recursiveReplaceString,"recursiveReplaceString"),__name2(recursiveReplaceString,"recursiveReplaceString");function localizer(prefix){return(...[suffix,formatArgs])=>formatArgs?game.i18n.format(`${prefix}.${suffix}`,formatArgs):game.i18n.localize(`${prefix}.${suffix}`)}__name(localizer,"localizer"),__name2(localizer,"localizer");function configFromLocalization(localization,prefix){return Object.entries(localization).reduce((result,[key,value])=>(result[key]=typeof value=="string"?`${prefix}.${key}`:configFromLocalization(value,`${prefix}.${key}`),result),{})}__name(configFromLocalization,"configFromLocalization"),__name2(configFromLocalization,"configFromLocalization");function isImageFilePath(path){return typeof path=="string"&&foundry.helpers.media.ImageHelper.hasImageExtension(path)}__name(isImageFilePath,"isImageFilePath"),__name2(isImageFilePath,"isImageFilePath");function isVideoFilePath(path){return typeof path=="string"&&foundry.helpers.media.VideoHelper.hasVideoExtension(path)}__name(isVideoFilePath,"isVideoFilePath"),__name2(isVideoFilePath,"isVideoFilePath");function isImageOrVideoPath(path){return typeof path=="string"&&(foundry.helpers.media.ImageHelper.hasImageExtension(path)||foundry.helpers.media.VideoHelper.hasVideoExtension(path))}__name(isImageOrVideoPath,"isImageOrVideoPath"),__name2(isImageOrVideoPath,"isImageOrVideoPath");const SORTABLE_BASE_OPTIONS={animation:200,direction:"vertical",dragClass:"drag-preview",dragoverBubble:!0,easing:"cubic-bezier(1, 0, 0, 1)",fallbackOnBody:!0,filter:"div.item-summary",ghostClass:"drag-gap",group:"inventory",preventOnFilter:!1,swapThreshold:.25,scroll:!0,scrollSensitivity:30,scrollSpeed:15,delay:500,delayOnTouchOnly:!0};class DegreeOfSuccess{static{__name(this,"DegreeOfSuccess")}static{__name2(this,"DegreeOfSuccess")}value;unadjusted;adjustment;dieResult;rollTotal;dc;constructor(roll,dc,dosAdjustments=null){roll instanceof Roll?(this.dieResult=(roll.isDeterministic?roll.terms.find(t2=>t2 instanceof foundry.dice.terms.NumericTerm):roll.dice.find(d=>d instanceof foundry.dice.terms.Die&&d.faces===20))?.total??1,this.rollTotal=roll.total):(this.dieResult=roll.dieValue,this.rollTotal=roll.dieValue+roll.modifier),this.dc=typeof dc=="number"?{value:dc}:dc,this.unadjusted=this.#calculateDegreeOfSuccess(),this.adjustment=this.#getDegreeAdjustment(this.unadjusted,dosAdjustments),this.value=this.adjustment?this.#adjustDegreeOfSuccess(this.adjustment.amount,this.unadjusted):this.unadjusted}static CRITICAL_FAILURE=0;static FAILURE=1;static SUCCESS=2;static CRITICAL_SUCCESS=3;#getDegreeAdjustment(degree,adjustments){if(!adjustments)return null;for(const outcome of["all",...DEGREE_OF_SUCCESS_STRINGS]){const{label,amount}=adjustments[outcome]??{};if(amount&&label&&!(degree===DegreeOfSuccess.CRITICAL_SUCCESS&&amount===DEGREE_ADJUSTMENT_AMOUNTS.INCREASE)&&!(degree===DegreeOfSuccess.CRITICAL_FAILURE&&amount===DEGREE_ADJUSTMENT_AMOUNTS.LOWER)&&(outcome==="all"||DEGREE_OF_SUCCESS_STRINGS.indexOf(outcome)===degree))return{label,amount}}return null}#adjustDegreeOfSuccess(amount,degreeOfSuccess){switch(amount){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamp(degreeOfSuccess+amount,0,3)}}#adjustDegreeByDieValue(degree){return this.dieResult===20?this.#adjustDegreeOfSuccess(DEGREE_ADJUSTMENT_AMOUNTS.INCREASE,degree):this.dieResult===1?this.#adjustDegreeOfSuccess(DEGREE_ADJUSTMENT_AMOUNTS.LOWER,degree):degree}#calculateDegreeOfSuccess(){const dc=this.dc.value;return this.rollTotal-dc>=10?this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_SUCCESS):dc-this.rollTotal>=10?this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_FAILURE):this.rollTotal>=dc?this.#adjustDegreeByDieValue(DegreeOfSuccess.SUCCESS):this.#adjustDegreeByDieValue(DegreeOfSuccess.FAILURE)}}const DEGREE_ADJUSTMENT_AMOUNTS={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},DEGREE_OF_SUCCESS={CRITICAL_SUCCESS:3,SUCCESS:2,FAILURE:1,CRITICAL_FAILURE:0},DEGREE_OF_SUCCESS_STRINGS=["criticalFailure","failure","success","criticalSuccess"],PHYSICAL_DAMAGE_TYPES=["bludgeoning","piercing","slashing","bleed"],LIFE_ENERGY_DAMAGE_TYPES=["vitality","void"],ENERGY_DAMAGE_TYPES=["acid","cold","electricity","fire","sonic","force",...LIFE_ENERGY_DAMAGE_TYPES],DAMAGE_CATEGORIES_UNIQUE=["persistent","precision","splash"],MATERIAL_DAMAGE_EFFECTS=new Set(["adamantine","cold-iron","dawnsilver","duskwood","orichalcum","silver","sisterstone-dusk","sisterstone-scarlet","warpglass"]);[...DAMAGE_CATEGORIES_UNIQUE,...MATERIAL_DAMAGE_EFFECTS];const DAMAGE_DIE_SIZES=["d4","d6","d8","d10","d12"],DAMAGE_DICE_FACES=[4,6,8,10,12],DAMAGE_TYPES=new Set([...PHYSICAL_DAMAGE_TYPES,...ENERGY_DAMAGE_TYPES,"mental","poison","spirit","untyped"]),BASE_DAMAGE_TYPES_TO_CATEGORIES={bludgeoning:"physical",piercing:"physical",slashing:"physical",bleed:"physical",acid:"energy",cold:"energy",electricity:"energy",fire:"energy",sonic:"energy",vitality:"energy",void:"energy",force:"energy",mental:null,poison:null,spirit:null,untyped:null},DAMAGE_TYPE_ICONS={bleed:"droplet",acid:"vial",bludgeoning:"hammer",cold:"snowflake",electricity:"bolt",fire:"fire",force:"sparkles",mental:"brain",piercing:"bow-arrow",poison:"spider",slashing:"axe",sonic:"waveform-lines",spirit:"ghost",vitality:"sun",void:"skull",untyped:null},PERSISTENT_DAMAGE_IMAGES={acid:"icons/magic/acid/dissolve-arm-flesh.webp",bludgeoning:"systems/pf2e/icons/equipment/weapons/bola.webp",cold:"icons/magic/water/ice-snowman.webp",electricity:"systems/pf2e/icons/spells/chain-lightning.webp",fire:"icons/magic/fire/flame-burning-creature-skeleton.webp",force:"systems/pf2e/icons/spells/magic-missile.webp",mental:"systems/pf2e/icons/spells/modify-memory.webp",piercing:"systems/pf2e/icons/equipment/weapons/throwing-knife.webp",poison:"systems/pf2e/icons/spells/acidic-burst.webp",slashing:"systems/pf2e/icons/equipment/weapons/scimitar.webp",sonic:"systems/pf2e/icons/spells/cry-of-destruction.webp",spirit:"icons/magic/unholy/hand-claw-fire-blue.webp",vitality:"systems/pf2e/icons/spells/moment-of-renewal.webp",void:"systems/pf2e/icons/spells/grim-tendrils.webp"},CRITICAL_INCLUSION={DOUBLE_ON_CRIT:null,CRITICAL_ONLY:!0,DONT_DOUBLE_ON_CRIT:!1};function createDamageFormula(damage,degree=DEGREE_OF_SUCCESS.SUCCESS){if(damage={...foundry.utils.deepClone(n$1(damage,["dice"])),dice:damage.dice.map(d=>d.clone())},degree===DEGREE_OF_SUCCESS.CRITICAL_FAILURE)return null;degree===DEGREE_OF_SUCCESS.FAILURE&&(damage.dice=damage.dice.filter(d=>d.category==="splash"),damage.modifiers=damage.modifiers.filter(m=>m.damageCategory==="splash"));const critical=degree===DEGREE_OF_SUCCESS.CRITICAL_SUCCESS;if(damage.base.length===0)return null;applyDamageDiceOverrides(damage.base,damage.dice,{critical,maxIncreases:damage.maxIncreases});const typeMap=new Map;for(const baseEntry of damage.base){const list=typeMap.get(baseEntry.damageType)??[];if(typeMap.set(baseEntry.damageType,list),baseEntry.terms)list.push(...baseEntry.terms.map(t2=>({...baseEntry,...t2,label:null,critical:null})));else if(baseEntry.diceNumber&&baseEntry.dieSize||baseEntry.modifier){const{diceNumber,dieSize,damageType}=baseEntry,modifier=baseEntry.modifier??0,label=(()=>{const diceSection=diceNumber?`${diceNumber}${dieSize}`:null;if(!diceSection)return String(modifier);const displayedModifier=modifier?Math.abs(modifier):null,operator=modifier<0?" - ":" + ";return[diceSection,displayedModifier].filter(p=>p!==null).join(operator)})(),diceFaces=Number(dieSize?.replace("d",""));list.push({label,dice:diceNumber&&tupleHasValue(DAMAGE_DICE_FACES,diceFaces)?{number:diceNumber,faces:diceFaces}:null,modifier,critical:null,damageType,category:baseEntry.category,materials:baseEntry.materials??[]})}}const BONUS_BASE_LABELS=["PF2E.ConditionTypePersistent"].map(l=>game.i18n.localize(l)),outcomeMatches=__name2(m=>critical||m.critical!==!0,"outcomeMatches");for(const dice of damage.dice.filter(d=>d.enabled&&outcomeMatches(d))){const matchingBase=damage.base.find(b=>b.damageType===dice.damageType)??damage.base[0],baseDieSize=Number(matchingBase.dieSize?.replace("d",""))||matchingBase.terms?.[0].dice?.faces,faces=Number(dice.dieSize?.replace("d",""))||baseDieSize||null,damageType=dice.damageType??matchingBase.damageType;if(dice.diceNumber>0&&tupleHasValue(DAMAGE_DICE_FACES,faces)){const list=typeMap.get(damageType)??[];list.push({label:BONUS_BASE_LABELS.includes(dice.label)?null:`${dice.label} +${dice.diceNumber}d${faces}`,dice:{number:dice.diceNumber,faces},modifier:0,damageType,category:dice.category,critical:dice.critical}),typeMap.set(damageType,list)}}const bonusableDamage=[...damage.base,...damage.dice.filter(d=>d.enabled),...damage.modifiers.filter(m=>m.enabled&&m.value>0&&m.type==="untyped")];for(const modifier of damage.modifiers.filter(m=>m.enabled&&outcomeMatches(m))){const matchingDamage=modifier.kind==="modifier"?bonusableDamage.find(b=>b.damageType===(modifier.damageType??b.damageType))??damage.base.at(0):bonusableDamage.find(b=>b.damageType===(modifier.damageType??b.damageType)&&b.category===modifier.category);if(!matchingDamage)continue;const damageType=modifier.damageType??matchingDamage.damageType??"untyped",list=typeMap.get(damageType)??[];list.push({label:BONUS_BASE_LABELS.includes(modifier.label)?null:`${modifier.label} ${modifier.signedValue}`,dice:null,modifier:modifier.value,damageType,category:modifier.damageCategory,critical:modifier.critical}),typeMap.set(damageType,list)}const instances=[instancesFromTypeMap(typeMap,{degree,kinds:damage.kinds}),instancesFromTypeMap(typeMap,{degree,persistent:!0})].flat(),commaSeparated=instances.map(i=>i.formula).join(","),breakdown=instances.flatMap(i=>i.breakdown);return{formula:`{${commaSeparated}}`,breakdown}}__name(createDamageFormula,"createDamageFormula"),__name2(createDamageFormula,"createDamageFormula");function instancesFromTypeMap(typeMap,{degree,kinds=new Set(["damage"]),persistent=!1}){return Array.from(typeMap.entries()).flatMap(([damageType,typePartials])=>{const partials=typePartials.filter(p=>p.category==="persistent"===persistent);if(partials.length===0)return[];const groups=groupBy(partials,partial=>partial.category),nonCriticalDamage=(()=>{const criticalInclusion=degree===DEGREE_OF_SUCCESS.CRITICAL_SUCCESS?[CRITICAL_INCLUSION.DOUBLE_ON_CRIT]:[CRITICAL_INCLUSION.DOUBLE_ON_CRIT,CRITICAL_INCLUSION.DONT_DOUBLE_ON_CRIT],doubleDice=degree===DEGREE_OF_SUCCESS.CRITICAL_SUCCESS&&criticalInclusion.includes(null)&&game.settings.get("pf2e","critRule")==="doubledice",double=degree===DEGREE_OF_SUCCESS.CRITICAL_SUCCESS&&!doubleDice;return sumExpression(createPartialFormulas(groups,{criticalInclusion,doubleDice}),{double})})(),criticalDamage=(()=>{if(degree!==DEGREE_OF_SUCCESS.CRITICAL_SUCCESS)return null;const criticalInclusion=[CRITICAL_INCLUSION.CRITICAL_ONLY,CRITICAL_INCLUSION.DONT_DOUBLE_ON_CRIT];return sumExpression(createPartialFormulas(groups,{criticalInclusion}))})(),summedDamage=sumExpression(degree?[nonCriticalDamage,criticalDamage]:[nonCriticalDamage]),enclosed=ensureValidFormulaHead(summedDamage)||"0";if(enclosed==="0"&&persistent)return[];const flavor=(()=>{const kindFlavor=kinds.has("damage")?kinds.has("healing")?["damage","healing"]:[]:["healing"],typeFlavor=damageType==="untyped"&&!persistent?[]:[damageType],persistentFlavor=persistent?["persistent"]:[],materialFlavor=typePartials.flatMap(p=>p.materials??[]),allFlavor=[kindFlavor,typeFlavor,persistentFlavor,materialFlavor].flat().join(",");return allFlavor.length>0?`[${allFlavor}]`:""})(),breakdown=(()=>{const flattenedDamage=[null,"persistent","precision","splash"].flatMap(c=>{const partials2=groups.get(c)??[],breakdownDamage2=partials2.filter(e2=>e2.label!==null),leadingTerms=partials2.filter(p=>p.label===null&&(p.modifier||p.dice?.number||partials2.every(pp=>pp.label===null)));if(leadingTerms.length){const append2=c==="splash"?` ${game.i18n.localize("PF2E.TraitSplash")}`:"",label=createSimpleFormula(leadingTerms)+append2;breakdownDamage2.unshift({...leadingTerms[0],label})}return breakdownDamage2}),breakdownDamage=flattenedDamage.filter(d=>d.critical!==!0);if(degree===DEGREE_OF_SUCCESS.CRITICAL_SUCCESS&&breakdownDamage.push(...flattenedDamage.filter(d=>d.critical===!0)),breakdownDamage.length===0)return[];const damageTypeLabel=breakdownDamage[0].category==="persistent"?game.i18n.format("PF2E.Damage.PersistentTooltip",{damageType:game.i18n.localize(CONFIG.PF2E.damageTypes[damageType]??damageType)}):game.i18n.localize(CONFIG.PF2E.damageTypes[damageType]??damageType),labelParts=breakdownDamage.map(d=>d.label);return labelParts[0]=`${labelParts[0].replace(/^\s+\+/,"")} ${damageTypeLabel}`,labelParts})(),formula=enclosed&&flavor?`${enclosed}${flavor}`:enclosed;return formula?{formula,breakdown}:[]})}__name(instancesFromTypeMap,"instancesFromTypeMap"),__name2(instancesFromTypeMap,"instancesFromTypeMap");function createPartialFormulas(partials,{criticalInclusion,doubleDice=!1}){return[null,"persistent","precision","splash"].flatMap(category=>{const requestedPartials=(partials.get(category)??[]).filter(p=>criticalInclusion.includes(p.critical)),term=(()=>{const expression=createSimpleFormula(requestedPartials,{doubleDice});return expression==="0"?"":["precision","splash"].includes(category??"")&&hasOperators(expression)?`(${expression})`:expression})();return(term&&category&&category!=="persistent"?term.endsWith("]")?`(${term})[${category}]`:`${term}[${category}]`:term)||[]})}__name(createPartialFormulas,"createPartialFormulas"),__name2(createPartialFormulas,"createPartialFormulas");function combinePartialTerms(terms2){const modifier=terms2.reduce((total,p)=>total+p.modifier,0),constantTerm=modifier?{dice:null,modifier}:null,dice=t(terms2.filter(p=>!!p.dice&&p.dice.number>0),t2=>-t2.dice.faces),combined=[...[...groupBy(dice,t2=>t2.dice.faces).values()].map(terms22=>({modifier:0,dice:{...terms22[0].dice,number:t$1(terms22,t2=>t2.dice.number)}})),constantTerm].filter(e$1);return combined.length?combined:[{dice:null,modifier:0}]}__name(combinePartialTerms,"combinePartialTerms"),__name2(combinePartialTerms,"combinePartialTerms");function createSimpleFormula(terms2,{doubleDice}={}){terms2=combinePartialTerms(terms2);const constant=terms2.find(t2=>!!t2.modifier)?.modifier??0,diceTerms=terms2.filter(t2=>!!t2.dice&&t2.dice.number>0).map(term=>{const number=doubleDice?term.dice.number*2:term.dice.number,faces=term.dice.faces;return doubleDice?`${number}d${faces}[doubled]`:`${number}d${faces}`});return diceTerms.length?[diceTerms.join(" + "),Math.abs(constant)].filter(e2=>!!e2).map(e2=>typeof e2=="number"&&doubleDice?`2 * ${e2}`:e2).join(constant>0?" + ":" - "):doubleDice&&constant?`2 * ${constant}`:String(constant)}__name(createSimpleFormula,"createSimpleFormula"),__name2(createSimpleFormula,"createSimpleFormula");function parseTermsFromSimpleFormula(formula,options){return(formula instanceof Roll?formula:new Roll(formula,options?.rollData)).terms.reduceRight((result,term)=>{if(term.expression===" + ")return result;if(term.expression===" - "){const termToModify=result[0];return termToModify&&(termToModify.modifier&&(termToModify.modifier*=-1),termToModify.dice&&(termToModify.dice.number*=-1)),result}return result.unshift({modifier:term instanceof foundry.dice.terms.NumericTerm?term.number:0,dice:term instanceof foundry.dice.terms.Die?{faces:term.faces,number:term.number}:null}),result},[])}__name(parseTermsFromSimpleFormula,"parseTermsFromSimpleFormula"),__name2(parseTermsFromSimpleFormula,"parseTermsFromSimpleFormula");function sumExpression(terms2,{double=!1}={}){if(terms2.every(t2=>!t2))return null;const summed=terms2.filter(p=>!!p).join(" + ").replaceAll(/ \+ -(\d+)/g," - $1");if(summed==="")return null;const enclosed=double&&hasOperators(summed)?`(${summed})`:summed;return double?`2 * ${enclosed}`:enclosed}__name(sumExpression,"sumExpression"),__name2(sumExpression,"sumExpression");function hasOperators(formula){return/[-+*/]/.test(formula??"")}__name(hasOperators,"hasOperators"),__name2(hasOperators,"hasOperators");function ensureValidFormulaHead(formula){if(!formula)return null;const isWrapped=/^\(.*\)$/.test(formula),isSimple=/^\d+(d\d+)?$/.test(formula);return isWrapped||isSimple?formula:`(${formula})`}__name(ensureValidFormulaHead,"ensureValidFormulaHead"),__name2(ensureValidFormulaHead,"ensureValidFormulaHead");const terms$1=foundry.dice.terms;class ArithmeticExpression extends terms$1.RollTerm{static{__name(this,"ArithmeticExpression")}static{__name2(this,"ArithmeticExpression")}operator;operands;constructor(termData){super(termData),this.operator=termData.operator,this.operands=termData.operands.slice(0,2).map(datum=>{if(datum instanceof terms$1.RollTerm)return datum;const TermCls=CONFIG.Dice.termTypes[datum.class??""]??Object.values(CONFIG.Dice.terms).find(t2=>t2.name===datum.class)??terms$1.Die;return simplifyTerm(TermCls.fromData(datum))})}static SERIALIZE_ATTRIBUTES=["operator","operands"];static fromData(data){return super.fromData({...data,class:"ArithmeticExpression"})}static totalOf(operator,left,right){if(!(left===void 0||right===void 0))switch(operator){case"+":return left+right;case"-":return left-right;case"*":return left*right;case"/":return left/right;case"%":return left%right}}get dice(){return this.operands.flatMap(o=>o instanceof terms$1.DiceTerm?o:o instanceof Grouping||o instanceof ArithmeticExpression||o instanceof IntermediateDie?o.dice:[])}get expression(){if(this.isDeterministic&&typeof this.total=="number"&&!Number.isNaN(this.total)&&!isUnsimplifableArithmetic(this))return this.total.toString();const{operator,operands}=this;return`${operands[0].expression} ${operator} ${operands[1].expression}`}get formula(){const{operator,operands}=this;return`${operands[0].formula} ${operator} ${operands[1].formula}`}get total(){if(!this._evaluated&&!this.isDeterministic)return;const operands=[Number(this.operands[0].total),Number(this.operands[1].total)];return ArithmeticExpression.totalOf(this.operator,...operands)}get critImmuneTotal(){if(!this._evaluated)return;const[left,right]=this.operands;if(left instanceof terms$1.NumericTerm&&left.number===2&&this.operator==="*")return typeof right.total=="string"?Number(right.total):right.total;const undoubledLeft=left instanceof ArithmeticExpression||left instanceof Grouping?Number(left.critImmuneTotal):Number(left.total),undoubledRight=right instanceof ArithmeticExpression||right instanceof Grouping?Number(right.critImmuneTotal):Number(right.total);return ArithmeticExpression.totalOf(this.operator,undoubledLeft,undoubledRight)}get isDeterministic(){return this.operands.every(o=>o.isDeterministic)}get minimumValue(){const left=DamageInstance.getValue(this.operands[0],"minimum"),right=DamageInstance.getValue(this.operands[1],"minimum");return ArithmeticExpression.totalOf(this.operator,left,right)}get expectedValue(){const left=DamageInstance.getValue(this.operands[0]),right=DamageInstance.getValue(this.operands[1]);return ArithmeticExpression.totalOf(this.operator,left,right)}get maximumValue(){const left=DamageInstance.getValue(this.operands[0],"maximum"),right=DamageInstance.getValue(this.operands[1],"maximum");return ArithmeticExpression.totalOf(this.operator,left,right)}render(){const fragment=new DocumentFragment,{operator,operands}=this;if(operator==="*"&&operands[0]instanceof terms$1.NumericTerm&&operands[1]instanceof terms$1.NumericTerm)return fragment.append((operands[0].total*operands[1].total).toString()),fragment;const[left,right]=operands.map(o=>["precision","splash"].includes(o.flavor)?renderComponentDamage(o):isSystemDamageTerm(o)?o.render():o.expression);return fragment.append(left,` ${this.operator} `,right),fragment}async _evaluate(options={}){for(const operand of this.operands)operand._evaluated||await operand.evaluate(options);return this._evaluated=!0,this}toJSON(){return{...super.toJSON(),operands:[this.operands[0].toJSON(),this.operands[1].toJSON()]}}}class Grouping extends terms$1.RollTerm{static{__name(this,"Grouping")}static{__name2(this,"Grouping")}term;constructor(termData){const TermCls=CONFIG.Dice.termTypes[termData.term.class??""]??Object.values(CONFIG.Dice.terms).find(t2=>t2.name===termData.term.class)??terms$1.NumericTerm,childTerm=simplifyTerm(TermCls.fromData(termData.term));childTerm instanceof Grouping?(super(childTerm.toJSON()),this.term=childTerm.term):(super(termData),this.term=childTerm,this.#dataIsCriticalDoubling(termData.term)&&(this.options.crit=2)),this._evaluated=termData.evaluated??this.term._evaluated??!0}static SERIALIZE_ATTRIBUTES=["term"];static fromData(data){return super.fromData({...data,class:"Grouping"})}get dice(){if(this.term instanceof terms$1.DiceTerm)return[this.term];const childDice="dice"in this.term?this.term.dice:null;return Array.isArray(childDice)&&childDice.every(d=>d instanceof terms$1.DiceTerm)?childDice:[]}get expression(){return this.isDeterministic&&typeof this.total=="number"&&!Number.isNaN(this.total)&&!isUnsimplifableArithmetic(this.term)?this.total.toString():this.term instanceof terms$1.DiceTerm||this.term instanceof terms$1.FunctionTerm?this.term.expression:`(${this.term.expression})`}get formula(){const termFormula=this.term.formula,flavor=this.flavor?`[${this.flavor}]`:"";return`(${termFormula})${flavor}`}get total(){return this._evaluated||this.isDeterministic?Number(this.term.total):void 0}get critImmuneTotal(){const thisTotal=this.total;return typeof thisTotal=="number"&&this.options.crit?thisTotal/2:this.term instanceof ArithmeticExpression||this.term instanceof Grouping?this.term.critImmuneTotal:thisTotal}get isDeterministic(){return this.term.isDeterministic}get minimumValue(){return DamageInstance.getValue(this.term,"minimum")}get expectedValue(){return DamageInstance.getValue(this.term)}get maximumValue(){return DamageInstance.getValue(this.term,"maximum")}#dataIsCriticalDoubling(data){return"operator"in data&&data.operator==="*"&&"operands"in data&&Array.isArray(data.operands)&&data.operands.length===2&&data.operands.every(o=>e$2(o))&&data.operands[0].number===2}async _evaluate(options={}){return this.term._evaluated||await this.term.evaluate(options),this._evaluated=!0,this}toJSON(){return{...super.toJSON(),term:this.term.toJSON()}}render(){const expression=["precision","splash"].includes(this.flavor)?renderComponentDamage(this.term):isSystemDamageTerm(this.term)?this.term.render():this.expression,fragment=new DocumentFragment,nodes=this.term instanceof terms$1.NumericTerm||this.term instanceof terms$1.Die?[expression]:["(",expression,")"];return fragment.append(...nodes),fragment}}class IntermediateDie extends terms$1.RollTerm{static{__name(this,"IntermediateDie")}static{__name2(this,"IntermediateDie")}number;faces;die;constructor(data){super(data);const setTerm=__name2(termData=>{if(typeof termData=="number")return termData;const TermCls=CONFIG.Dice.termTypes[termData.class??"NumericTerm"],term=simplifyTerm(TermCls.fromData(termData));return term instanceof terms$1.NumericTerm?term.number:term.isDeterministic?Roll.safeEval(term.formula):term instanceof Grouping?(term.isIntermediate=!0,term):(term instanceof terms$1.FunctionTerm||console.warn(`Unexpected term type: ${term.constructor.name}`),term)},"setTerm");this.number=setTerm(data.number),this.faces=setTerm(data.faces),this.die=data.die?terms$1.Die.fromData({...data.die,class:"Die"}):typeof this.number=="number"&&typeof this.faces=="number"?terms$1.Die.fromData({number:this.number,faces:this.faces,evaluated:this._evaluated,options:this.options}):null}static SERIALIZE_ATTRIBUTES=["number","faces","die"];get expression(){if(this.die)return this.die.expression;const number=typeof this.number=="number"?this.number:this.number.expression,faces=typeof this.faces=="number"?this.faces:this.faces.expression;return`${number}d${faces}`}get total(){return this.isDeterministic?Number(this.number)*Number(this.faces):this.die?.total}get dice(){return this.die?[this.die]:[]}get isDeterministic(){return this.number===0||this.faces===0||this.faces===1}get minimumValue(){return DamageInstance.getValue(this.die??new terms$1.Die({number:Number(this.number),faces:Number(this.faces)}),"minimum")}get expectedValue(){return DamageInstance.getValue(this.die??new terms$1.Die({number:Number(this.number),faces:Number(this.faces)}))}get maximumValue(){return DamageInstance.getValue(this.die??new terms$1.Die({number:Number(this.number),faces:Number(this.faces)}),"maximum")}async _evaluate(){return typeof this.number!="number"&&(this.number=(await this.number.evaluate()).total),typeof this.faces!="number"&&(this.faces=(await this.faces.evaluate()).total),this.die=await new terms$1.Die({number:this.number,faces:this.faces,options:this.options}).evaluate(),this._evaluated=!0,this}toJSON(){return this.die?this.die.toJSON():typeof this.number=="number"&&typeof this.faces=="number"?terms$1.Die.fromData({class:"Die",number:this.number,faces:this.faces,evaluated:this._evaluated,options:this.options}):{...super.toJSON(),number:typeof this.number=="number"?this.number:this.number.toJSON(),faces:typeof this.faces=="number"?this.faces:this.faces.toJSON()}}}class InstancePool extends terms$1.PoolTerm{static{__name(this,"InstancePool")}static{__name2(this,"InstancePool")}static fromRolls(rolls=[]){const allEvaluated=rolls.every(r2=>r2._evaluated),noneEvaluated=!rolls.some(r2=>r2._evaluated);if(!(allEvaluated||noneEvaluated))return super.fromRolls(rolls);const pool=new this({terms:rolls.map(r2=>r2._formula),modifiers:[],rolls,results:allEvaluated?rolls.map(r2=>({result:r2.total,active:!0})):[]});return pool._evaluated=allEvaluated,pool}}function nextDamageDieSize(next){const[faces,direction]="upgrade"in next?[next.upgrade,1]:[next.downgrade,-1];return DAMAGE_DIE_SIZES[DAMAGE_DIE_SIZES.indexOf(faces)+direction]??faces}__name(nextDamageDieSize,"nextDamageDieSize"),__name2(nextDamageDieSize,"nextDamageDieSize");const DamageCategorization={fromDamageType:__name2(damageType=>BASE_DAMAGE_TYPES_TO_CATEGORIES[damageType],"fromDamageType"),allCategories:__name2(()=>new Set(Object.values(BASE_DAMAGE_TYPES_TO_CATEGORIES)),"allCategories"),baseCategories:__name2(()=>new Set(Object.values(BASE_DAMAGE_TYPES_TO_CATEGORIES)),"baseCategories"),toDamageTypes:__name2(category=>{const types=Object.entries(BASE_DAMAGE_TYPES_TO_CATEGORIES).filter(([_key,value])=>value===category).map(([key])=>key);return new Set(types)},"toDamageTypes")};function applyBaseDamageAlterations({actor,item,base,domains,rollOptions}){const alterationsRecord=actor?.synthetics.damageAlterations??{},modifierAdjustments=extractModifierAdjustments(actor.synthetics.modifierAdjustments,domains,"base"),damageAlterations=[item?.isOfType("action","feat")?item.system.traits.toggles?.getDamageAlterations()??[]:[],extractDamageAlterations(alterationsRecord,domains,"base")].flat();if(item&&damageAlterations.length+modifierAdjustments.length>0){for(const partial of base)for(const term of partial.terms??[])if(term.dice){const damage=new DamageDicePF2e({selector:"damage",slug:"base",damageType:partial.damageType,category:partial.category,diceNumber:term.dice.number,dieSize:`d${term.dice.faces}`});for(const alteration of damageAlterations)alteration.applyTo(damage,{item,test:rollOptions});partial.damageType=damage.damageType??partial.damageType,term.dice.number=damage.diceNumber,term.dice.faces=damage.dieSize?damageDieSizeToFaces(damage.dieSize):term.dice.faces}else if(term.modifier){const modifier=new Modifier({label:"PF2E.ModifierTitle",slug:"base",modifier:term.modifier,damageCategory:partial.category,damageType:partial.damageType,adjustments:modifierAdjustments});modifier.applyAdjustments({rollOptions});for(const alteration of damageAlterations)alteration.applyTo(modifier,{item,test:rollOptions});term.modifier=modifier.value,partial.damageType=modifier.damageType??partial.damageType}}}__name(applyBaseDamageAlterations,"applyBaseDamageAlterations"),__name2(applyBaseDamageAlterations,"applyBaseDamageAlterations");const FACES=[4,6,8,10,12];function applyDamageDiceOverrides(baseEntries,dice,options={}){const critical=options.critical??!1,maxIncreases=options.maxIncreases??1/0,overrideDice=dice.filter(d=>!d.ignored&&!!d.override);if(overrideDice.length!==0)for(const base of baseEntries){const die=base.terms?.find(t2=>!!t2.dice);if(base.terms&&!die)continue;const adjustments=overrideDice.filter(m=>(m.critical===null||critical&&m.critical||!critical&&!m.critical)&&(!m.damageType||m.damageType===base.damageType)),numUpgrades=Math.min(maxIncreases,adjustments.filter(d=>d.override?.upgrade).length),numDowngrades=Math.min(maxIncreases,adjustments.filter(d=>d.override?.downgrade).length),delta=numUpgrades-numDowngrades;for(let i=0;i<Math.abs(delta);i++)if(die){const direction=delta>0?1:-1,newFaces=FACES[FACES.indexOf(die.dice.faces)+direction];die.dice.faces=tupleHasValue(DAMAGE_DICE_FACES,newFaces)?newFaces:die.dice.faces}else base.dieSize&&(base.dieSize=delta>0?nextDamageDieSize({upgrade:base.dieSize}):nextDamageDieSize({downgrade:base.dieSize}));for(const adjustment of adjustments)if(adjustment.override){base.damageType=adjustment.override.damageType??base.damageType;for(const die2 of dice.filter(d=>/^(?:deadly|fatal)-/.test(d.slug)))die2.damageType=adjustment.override.damageType??die2.damageType;if(die){if(die.dice.number=adjustment.override.diceNumber??die.dice.number,adjustment.override.dieSize){const faces=Number(/\d{1,2}/.exec(adjustment.override.dieSize)?.shift());tupleHasValue(DAMAGE_DICE_FACES,faces)&&(die.dice.faces=faces)}}else base.dieSize=adjustment.override.dieSize??base.dieSize,base.diceNumber=adjustment.override.diceNumber??base.diceNumber}}}__name(applyDamageDiceOverrides,"applyDamageDiceOverrides"),__name2(applyDamageDiceOverrides,"applyDamageDiceOverrides");function extractBaseDamage(roll){function recursiveExtractTerms(expression,{category=null}={}){if(category=tupleHasValue(DAMAGE_CATEGORIES_UNIQUE,expression.options.flavor)?expression.options.flavor:category,expression instanceof Grouping)return recursiveExtractTerms(expression.term,{category});if(expression instanceof foundry.dice.terms.Die)return[{dice:t$3(expression,["number","faces"]),modifier:0,category}];if(expression instanceof IntermediateDie){if(typeof expression.number!="number"||typeof expression.faces!="number")throw ErrorPF2e("Unable to parse DamageRoll with non-deterministic intermediate expressions.");const faces=tupleHasValue(DAMAGE_DICE_FACES,expression.faces)?expression.faces:4;return[{dice:{number:expression.number,faces},modifier:0,category}]}if(expression.isDeterministic)return[{dice:null,modifier:DamageInstance.getValue(expression,"expected"),category}];if(expression instanceof ArithmeticExpression){const operator=expression.operator;if(operator==="*"||operator==="/")throw ErrorPF2e(`Cannot use ${operator} on non-deterministic artithmetic terms`);const leftTerms=recursiveExtractTerms(expression.operands[0],{category}),rightTerms=recursiveExtractTerms(expression.operands[1],{category});if(operator==="-")for(const term of rightTerms)term.dice&&(term.dice.number*=-1),term.modifier*=-1;const groups=t$2([...leftTerms,...rightTerms],t2=>t2.category??"");return Object.values(groups).flatMap(terms2=>{const category2=terms2[0].category;return combinePartialTerms(terms2).map(t2=>({...t2,category:category2}))})}throw expression.isDeterministic?ErrorPF2e("Unrecognized roll term type "+expression.constructor.name):ErrorPF2e(`Unable to parse DamageRoll with non-deterministic ${expression.constructor.name}.`)}return __name(recursiveExtractTerms,"recursiveExtractTerms"),__name2(recursiveExtractTerms,"recursiveExtractTerms"),roll.instances.flatMap(instance=>{const category=tupleHasValue(DAMAGE_CATEGORIES_UNIQUE,instance.category)?instance.category:null,terms2=recursiveExtractTerms(instance.head,{category});return Object.values(t$2(terms2,t2=>t2.category??"")).map(terms3=>{const category2=instance.persistent?"persistent":terms3[0].category;return{damageType:instance.type,category:category2,terms:terms3.map(t2=>n$1(t2,["category"]))}})})}__name(extractBaseDamage,"extractBaseDamage"),__name2(extractBaseDamage,"extractBaseDamage");function renderComponentDamage(term){if(!["precision","splash"].includes(term.flavor))throw ErrorPF2e("Unexpected error rendering damage roll");const span=document.createElement("span");span.className=term.flavor;const[title,faClass]=term.flavor==="precision"?[game.i18n.localize("PF2E.Damage.Precision"),"crosshairs"]:[game.i18n.localize("PF2E.TraitSplash"),"burst"];span.title=title;const icon=fontAwesomeIcon(faClass);return icon.classList.add("icon"),span.append(term.expression," ",icon),span}__name(renderComponentDamage,"renderComponentDamage"),__name2(renderComponentDamage,"renderComponentDamage");function isSystemDamageTerm(term){return term instanceof ArithmeticExpression||term instanceof Grouping}__name(isSystemDamageTerm,"isSystemDamageTerm"),__name2(isSystemDamageTerm,"isSystemDamageTerm");function deepFindTerms(term,{flavor}){const childTerms=term instanceof Grouping?[term.term]:term instanceof ArithmeticExpression?term.operands:[];return[term.flavor.split(",").includes(flavor)?[term]:[],childTerms.map(t2=>deepFindTerms(t2,{flavor})).flat()].flat()}__name(deepFindTerms,"deepFindTerms"),__name2(deepFindTerms,"deepFindTerms");function damageDieSizeToFaces(size){const maybeFaces=Number(size.replace(/^d/,""));return tupleHasValue(DAMAGE_DICE_FACES,maybeFaces)?maybeFaces:null}__name(damageDieSizeToFaces,"damageDieSizeToFaces"),__name2(damageDieSizeToFaces,"damageDieSizeToFaces");function simplifyTerm(term){if(term instanceof IntermediateDie)return term.die??term;const shouldPreserve=__name2(t2=>!t2.isDeterministic||t2 instanceof foundry.dice.terms.NumericTerm||isUnsimplifableArithmetic(t2),"shouldPreserve");if(shouldPreserve(term)||term instanceof Grouping&&shouldPreserve(term.term))return term;try{const total=term.total??Roll.defaultImplementation.safeEval(term.expression);if(typeof total!="number"||Number.isNaN(total))throw Error(`Unable to evaluate deterministic term: ${term.expression}`);return foundry.dice.terms.NumericTerm.fromData({class:"NumericTerm",number:total,evaluated:term._evaluated,options:term.options})}catch{return term}}__name(simplifyTerm,"simplifyTerm"),__name2(simplifyTerm,"simplifyTerm");function isUnsimplifableArithmetic(term){return term instanceof ArithmeticExpression&&(term.operator==="*"||term.operands.some(o=>o.options.flavor))}__name(isUnsimplifableArithmetic,"isUnsimplifableArithmetic"),__name2(isUnsimplifableArithmetic,"isUnsimplifableArithmetic");function processBaseDamage(selector,unprocessed,{actor,item,domains,options}){const damageCategory="category"in unprocessed?unprocessed.category:null,dice=unprocessed.dice>0?new DamageDicePF2e({selector,slug:"base",category:damageCategory,damageType:unprocessed.damageType,diceNumber:unprocessed.dice,dieSize:unprocessed.die}):null,modifier=unprocessed.modifier!==0?new Modifier({slug:"base",label:"Base",damageCategory,damageType:unprocessed.damageType,modifier:unprocessed.modifier}):null,persistent=unprocessed.persistent?unprocessed.persistent.faces?new DamageDicePF2e({selector,slug:"base-persistent",category:"persistent",damageType:unprocessed.persistent.type,diceNumber:unprocessed.persistent.number,dieSize:`d${unprocessed.persistent.faces}`}):new Modifier({slug:"base-persistent",label:"Base",damageCategory:"persistent",damageType:unprocessed.persistent.type,modifier:unprocessed.persistent.number}):null,alterations=extractDamageAlterations(actor.synthetics.damageAlterations,domains,"base");for(const alteration of alterations)dice&&alteration.applyTo(dice,{item,test:options}),modifier&&alteration.applyTo(modifier,{item,test:options}),persistent&&alteration.applyTo(persistent,{item,test:options});return{category:damageCategory,damageType:dice?.damageType??modifier?.damageType??unprocessed.damageType,dice:dice?.diceNumber??0,die:dice?.dieSize??null,modifier:modifier?.value??0,persistent:persistent?{type:persistent.damageType??unprocessed.persistent?.type??unprocessed.damageType,number:unprocessed.persistent?.number??0,faces:"dieSize"in persistent?persistent.faces:null}:null}}__name(processBaseDamage,"processBaseDamage"),__name2(processBaseDamage,"processBaseDamage");function looksLikeDamageRoll(roll){const{dice}=roll;return dice.length===0||dice.some(d=>[4,6,8,10,12].includes(d.faces??20))&&!dice.some(d=>[2,20].includes(d.faces??20))}__name(looksLikeDamageRoll,"looksLikeDamageRoll"),__name2(looksLikeDamageRoll,"looksLikeDamageRoll");function damageDiceIcon(roll,{fixedWidth=!1}={}){const firstTerm=roll instanceof DamageRoll&&roll.instances[0]?.head instanceof IntermediateDie?roll.instances[0]?.head:null;if(firstTerm?.faces instanceof foundry.dice.terms.NumericTerm&&[4,8,6,10,12].includes(firstTerm.faces.number))return fontAwesomeIcon(`dice-d${firstTerm.faces.number}`,{fixedWidth});const firstDice=roll.dice.at(0),glyph=firstDice instanceof foundry.dice.terms.Die&&[4,8,6,10,12].includes(firstDice.faces)?`dice-d${firstDice.faces}`:firstDice?"dice-d20":"calculator";return fontAwesomeIcon(glyph,{fixedWidth})}__name(damageDiceIcon,"damageDiceIcon"),__name2(damageDiceIcon,"damageDiceIcon");function getDamageDiceValueLabel(d,props={}){return d.diceNumber&&d.dieSize?`${props.sign?"+":""}${d.diceNumber}${d.dieSize}`:d.diceNumber?game.i18n.format("PF2E.Roll.Dialog.Damage.Dice",{dice:signedInteger(d.diceNumber)}):""}__name(getDamageDiceValueLabel,"getDamageDiceValueLabel"),__name2(getDamageDiceValueLabel,"getDamageDiceValueLabel");function getDamageDiceOverrideLabel(d){const parts=[d.override?.upgrade?game.i18n.localize("PF2E.Roll.Dialog.Damage.DieSizeUpgrade"):null,d.override?.diceNumber||d.override?.dieSize?game.i18n.format("PF2E.Roll.Dialog.Damage.Override",{value:d.override.diceNumber&&d.override.dieSize?`${d.override.diceNumber}${d.override.dieSize}`:d.override.diceNumber?game.i18n.format("PF2E.Roll.Dialog.Damage.Dice",{dice:d.override.diceNumber}):d.override.dieSize??""}):null].filter(e$1);return parts.length===0&&d.override?.damageType?game.i18n.format("PF2E.Roll.Dialog.Damage.OverrideLabel"):parts.join(" + ")}__name(getDamageDiceOverrideLabel,"getDamageDiceOverrideLabel"),__name2(getDamageDiceOverrideLabel,"getDamageDiceOverrideLabel");const terms=foundry.dice.terms;class AbstractDamageRoll extends Roll{static{__name(this,"AbstractDamageRoll")}static{__name2(this,"AbstractDamageRoll")}static replaceFormulaData(formula,data,options={}){return super.replaceFormulaData(formula.trim(),data,options).replace(/(?<![a-z])\((\d+)\)/gi,"$1")}}class DamageRoll extends AbstractDamageRoll{static{__name(this,"DamageRoll")}static{__name2(this,"DamageRoll")}static CHAT_TEMPLATE="systems/pf2e/templates/dice/damage-roll.hbs";static TOOLTIP_TEMPLATE="systems/pf2e/templates/dice/damage-tooltip.hbs";static parse(formula,data){const replaced=this.replaceFormulaData(formula,data,{missing:"0"}),poolData=(()=>{try{return this.parser.parse(replaced)}catch{return console.error(`Failed to parse damage formula "${formula}"`),null}})();if(poolData){if(!["PoolTerm","InstancePool"].includes(poolData.class??""))throw ErrorPF2e("A damage roll must consist of a single InstancePool")}else return[];return this.classifyDice(poolData),[InstancePool.fromData(poolData)]}constructor(formula,data={},options={}){formula=formula.trim();const wrapped=formula.startsWith("{")?formula:`{${formula}}`;if(super(wrapped,data,options),this.options.showBreakdown??=!0,tupleHasValue(["double-damage","double-dice"],options.critRule))for(const instance of this.instances)instance.critRule=options.critRule;else delete options.critRule;if(options.evaluatePersistent)for(const instance of this.instances)instance.options.evaluatePersistent=!0}get roller(){return game.users.get(this.options.rollerId??"")??null}static validate(formula){formula=formula.trim();const wrapped=this.replaceFormulaData(formula.startsWith("{")?formula:`{${formula}}`,{});try{const result=this.parser.parse(wrapped.replace(/@([a-z.0-9_-]+)/gi,"1"));return e$2(result)&&"class"in result&&["PoolTerm","InstancePool"].includes(String(result.class))}catch{return!1}}static classifyDice(data){const isDiceTerm=__name2(v=>e$2(v)&&v.class==="DiceTerm","isDiceTerm"),deepFindDice=__name2(value=>{const accumulated=[];if(isDiceTerm(value))accumulated.push(value);else if(e$3(value)){const objects=Object.values(value).filter(v=>e$3(v));accumulated.push(...objects.flatMap(o=>deepFindDice(o)))}return accumulated},"deepFindDice"),diceTerms=deepFindDice(data);for(const term of diceTerms)if(typeof term.faces=="number"||e$2(term.faces))term.class="Die";else if(typeof term.faces=="string"){const termClassName=CONFIG.Dice.terms[term.faces]?.name;if(!termClassName)throw ErrorPF2e(`No matching DiceTerm class for "${term.faces}"`);term.class=termClassName}}get pool(){const firstTerm=this.terms.at(0);return firstTerm instanceof InstancePool?firstTerm:null}get formula(){const{instances}=this,firstInstance=instances.at(0);if(firstInstance){if(instances.length===1&&firstInstance.head instanceof Grouping){const instanceFormula=firstInstance.formula;return instanceFormula.startsWith("(")?instanceFormula.slice(1).replace(/\)([^)]*)$/i,"$1"):instanceFormula}}else return super.formula;return instances.map(i=>i.formula).join(" + ")}get instances(){return this.pool?.rolls.filter(r2=>r2 instanceof DamageInstance)??[]}get kinds(){return new Set(this.instances.flatMap(i=>Array.from(i.kinds)))}get materials(){return new Set(this.instances.flatMap(i=>Array.from(i.materials)))}get dice(){const{instances}=this;return instances.length>0?instances.flatMap(i=>i.dice):super.dice}get minimumValue(){return this.instances.reduce((sum,i)=>sum+i.minimumValue,0)}get expectedValue(){return this.instances.reduce((sum,i)=>sum+i.expectedValue,0)}get maximumValue(){return this.instances.reduce((sum,i)=>sum+i.maximumValue,0)}static fromData(data){for(const term of data.terms)this.classifyDice(term);return super.fromData(data)}async _evaluateASTAsync(node,options){const total=await super._evaluateASTAsync(node,options);return typeof total!="number"?total:this.instances.some(i=>!i.persistent||this.options.evaluatePersistent)&&total<=0?(this.options.increasedFrom=total,Promise.resolve().then(()=>{this.alter(1,1-total)}),1):total}async getTooltip(){const instances=this.instances.filter(i=>i.dice.length>0&&(!i.persistent||i.options.evaluatePersistent)).map(i=>({type:i.type,typeLabel:i.typeLabel,iconClass:i.iconClass,dice:i.dice.map(d=>({...d.getTooltipData()}))})),showBreakdown=this.options.showBreakdown;return foundry.applications.handlebars.renderTemplate(this.constructor.TOOLTIP_TEMPLATE,{instances,showBreakdown})}async render({flavor,template=this.constructor.CHAT_TEMPLATE,isPrivate=!1}={}){const{instances}=this;if(!instances.at(-1))return super.render({flavor,template,isPrivate});this._evaluated||await this.evaluate({allowInteractive:!isPrivate});const formula=isPrivate?"???":(await Promise.all(instances.map(i=>i.render()))).join(" + "),total=this.total??NaN,damageKinds=this.kinds,showBreakdown=this.options.showBreakdown,showTotalInstances=instances.length>1||!(showBreakdown||game.user.isGM),tooltip=isPrivate||this.dice.length===0||!(showBreakdown||game.user.isGM)?"":await this.getTooltip(),chatData={formula,tooltip,instances:isPrivate?[]:instances,total:isPrivate?"?":Math.floor(total*100/100),increasedFrom:this.options.increasedFrom,splashOnly:!!this.options.splashOnly,damageOnly:!damageKinds.has("healing"),healingOnly:!damageKinds.has("damage"),allPersistent:this.instances.every(i=>i.persistent),persistentEvaluated:this.instances.some(i=>i.persistent&&i.options.evaluatePersistent),showBreakdown,showButtons:!isPrivate,showTotalInstances,showTripleDamage:game.pf2e.settings.critFumble.buttons,user:game.user};return foundry.applications.handlebars.renderTemplate(template,chatData)}alter(multiplier,addend,{multiplyNumeric=!0}={}){const instances=this.instances;if(!this._evaluated||instances.length===0)return super.alter(multiplier,addend,{multiplyNumeric});if(multiplier===1&&addend===0)return this;const instanceClones=multiplier===1?this.instances.map(i=>DamageInstance.fromData(i.toJSON())):instances.map(instance=>{const{head}=instance,rightOperand=head instanceof ArithmeticExpression&&["+","-"].includes(head.operator)?{class:"Grouping",term:head.toJSON()}:head.toJSON(),multiplierTerm={class:"NumericTerm",number:multiplier},expression=ArithmeticExpression.fromData({operator:"*",operands:[foundry.utils.deepClone(multiplierTerm),rightOperand]});return[2,3].includes(multiplier)&&(expression.options.crit=multiplier),DamageInstance.fromTerms([expression],foundry.utils.deepClone(instance.options))});if(addend!==0){const firstInstance=instanceClones[0],term=firstInstance.head.toJSON(),options=term.options??{};delete term.options;const termClone={class:"Grouping",term,options},addendTerm={class:"NumericTerm",number:Math.abs(addend)},expression=ArithmeticExpression.fromData({operator:addend>0?"+":"-",operands:[termClone,addendTerm],evaluated:!0});instanceClones[0]=DamageInstance.fromTerms([expression],foundry.utils.deepClone(firstInstance.options))}return DamageRoll.fromTerms([InstancePool.fromRolls(instanceClones)])}}class DamageInstance extends AbstractDamageRoll{static{__name(this,"DamageInstance")}static{__name2(this,"DamageInstance")}kinds;type;persistent;materials;critRule=null;constructor(formula,data={},{flavor="damage,healing",...options}={}){super(formula.trim(),data,{flavor,...options});const flavorIdentifiers=flavor?.replace(/[^a-z,_-]/g,"").split(",")??[];this.type=flavorIdentifiers.find(i=>i in CONFIG.PF2E.damageTypes)??"untyped",this.persistent=flavorIdentifiers.includes("persistent")||flavorIdentifiers.includes("bleed"),this.materials=new Set(flavorIdentifiers.filter(i=>i in CONFIG.PF2E.materialDamageEffects)),!this.persistent&&this.materials.size===0&&["vitality","void","untyped"].includes(this.type)&&flavorIdentifiers.includes("healing")?flavorIdentifiers.includes("damage")?this.kinds=new Set(["damage","healing"]):this.kinds=new Set(["healing"]):this.kinds=new Set(["damage"])}static parse(formula,data){const replaced=this.replaceFormulaData(formula,data,{missing:"0"}),syntaxTree2=(()=>{try{return this.parser.parse(replaced)}catch{return console.error(`Failed to parse damage formula "${formula}"`),null}})();return syntaxTree2?(DamageRoll.classifyDice(syntaxTree2),[terms.RollTerm.fromData(syntaxTree2)]):[]}static fromData(data){for(const term of data.terms)DamageRoll.classifyDice(term);const roll=super.fromData(data);return roll.terms=roll.terms.map(t2=>simplifyTerm(t2)),roll}static getValue(term,type2="expected"){if(term instanceof terms.NumericTerm)return term.number;if(term instanceof terms.FunctionTerm)try{return Roll.safeEval(term.formula)}catch{return 0}switch(type2){case"minimum":if(term instanceof terms.Die)return term.number;if(term instanceof ArithmeticExpression||term instanceof Grouping||term instanceof IntermediateDie)return term.minimumValue;break;case"maximum":if(term instanceof terms.Die)return term.number*term.faces;if(term instanceof ArithmeticExpression||term instanceof Grouping||term instanceof IntermediateDie)return term.maximumValue;break;default:{if(term instanceof terms.Die)return term.number*((term.faces+1)/2);if(term instanceof ArithmeticExpression||term instanceof Grouping||term instanceof IntermediateDie)return term.expectedValue}}return 0}get formula(){const typeFlavor=game.i18n.localize(CONFIG.PF2E.damageRollFlavors[this.type]??this.type),damageType=this.persistent&&this.type!=="bleed"?game.i18n.format("PF2E.Damage.RollFlavor.persistent",{damageType:typeFlavor}):this.type!=="untyped"?typeFlavor:"";return[this.head.expression,damageType].join(" ").trim()}get total(){if(this.persistent&&!this.options.evaluatePersistent)return 0;const maybeNumber=super.total;return typeof maybeNumber=="number"?Math.max(Math.floor(maybeNumber),0):maybeNumber}get minimumValue(){return DamageInstance.getValue(this.head,"minimum")}get expectedValue(){return DamageInstance.getValue(this.head)}get maximumValue(){return DamageInstance.getValue(this.head,"maximum")}get formalDescription(){const typeCategory=DamageCategorization.fromDamageType(this.type);return new Set(["damage",`damage:type:${this.type}`,typeCategory?`damage:category:${typeCategory}`:[],this.persistent?"damage:category:persistent":[],Array.from(this.materials).map(m=>`damage:material:${m}`)].flat())}get iconClass(){return DAMAGE_TYPE_ICONS[this.type]}_evaluateTotal(){return this.persistent&&!this.options.evaluatePersistent?0:super._evaluateTotal()}async render({tooltips=!0}={}){const span=document.createElement("span");if(span.classList.add(this.type,"damage","instance","color"),tooltips&&(span.dataset.tooltip=this.typeLabel),span.append(this.#renderFormula()),this.persistent&&this.type!=="bleed"){const icon=fontAwesomeIcon("hourglass",{style:"duotone"});icon.classList.add("icon"),span.append(" ",icon)}const{iconClass}=this;if(iconClass){(!this.persistent||this.type==="bleed")&&span.append(" ");const icon=fontAwesomeIcon(iconClass);icon.classList.add("icon"),span.append(icon)}return span.outerHTML}#renderFormula(){const head=this.head instanceof Grouping?this.head.term:this.head;return head instanceof ArithmeticExpression?head.render():["precision","splash"].includes(head.flavor)?renderComponentDamage(head):head.expression}get dice(){return this._dice.concat(this.terms.reduce((dice,term)=>(term instanceof terms.DiceTerm?dice.push(term):(term instanceof Grouping||term instanceof ArithmeticExpression||term instanceof IntermediateDie)&&dice.push(...term.dice),dice),[...this._dice]).flat())}get head(){return this.terms[0]}get category(){return DamageCategorization.fromDamageType(this.type)}get typeLabel(){const damageType=game.i18n.localize(CONFIG.PF2E.damageTypes[this.type]);return this.persistent&&this.type!=="bleed"?game.i18n.format("PF2E.Damage.PersistentTooltip",{damageType}):damageType}get critImmuneTotal(){if(this.total===void 0)return;const head=this.head,undoubledTotal=head instanceof ArithmeticExpression||head instanceof Grouping?head.critImmuneTotal??0:this.total;if(this.critRule==="double-damage")return undoubledTotal;{const secondHalf=this.dice.filter(d=>/\bdoubled\b/.test(d.flavor)).flatMap(d=>d.results.slice(Math.ceil(d.results.length/2)));return undoubledTotal-secondHalf.reduce((sum,r2)=>sum+r2.result,0)}}componentTotal(component){if(!this._evaluated)throw ErrorPF2e("Component totals may only be accessed from an evaluated damage instance");const rawTotal=deepFindTerms(this.head,{flavor:component}).reduce((total,t2)=>total+(Number(t2.total)||0),0),critMultiplier=Number(this.head.options.crit)||1;return rawTotal*critMultiplier}async _evaluate(params){if(await super._evaluate(params),this.persistent&&!this.options.evaluatePersistent){const results=this.dice.flatMap(d=>d.results);for(const result of results)result.hidden=!0}return this}}Promise.resolve().then(()=>{const Evaluator=function(){}.constructor;new Evaluator("AbstractDamageRoll",`// @generated by Peggy 5.0.6.
//
// https://peggyjs.org/
(function() {
  "use strict";

  function createNumericTerm(number, { flavor = null, truncate = false } = {}) {
    number = truncate ? Math.trunc(number) : number;
    const formula = flavor ? \`\${number}[\${flavor}]\` : number.toString();
    const obj = {
      class: "NumericTerm",
      number,
      formula,
      evaluated: false,
    };
    if (flavor) obj.options = { flavor };

    return obj;
  }

class peg$SyntaxError extends SyntaxError {
  constructor(message, expected, found, location) {
    super(message);
    this.expected = expected;
    this.found = found;
    this.location = location;
    this.name = "SyntaxError";
  }

  format(sources) {
    let str = "Error: " + this.message;
    if (this.location) {
      let src = null;
      const st = sources.find(s => s.source === this.location.source);
      if (st) {
        src = st.text.split(/\\r\\n|\\n|\\r/g);
      }
      const s = this.location.start;
      const offset_s = (this.location.source && (typeof this.location.source.offset === "function"))
        ? this.location.source.offset(s)
        : s;
      const loc = this.location.source + ":" + offset_s.line + ":" + offset_s.column;
      if (src) {
        const e = this.location.end;
        const filler = "".padEnd(offset_s.line.toString().length, " ");
        const line = src[s.line - 1];
        const last = s.line === e.line ? e.column : line.length + 1;
        const hatLen = (last - s.column) || 1;
        str += "\\n --> " + loc + "\\n"
            + filler + " |\\n"
            + offset_s.line + " | " + line + "\\n"
            + filler + " | " + "".padEnd(s.column - 1, " ")
            + "".padEnd(hatLen, "^");
      } else {
        str += "\\n at " + loc;
      }
    }
    return str;
  }

  static buildMessage(expected, found) {
    function hex(ch) {
      return ch.codePointAt(0).toString(16).toUpperCase();
    }

    const nonPrintable = Object.prototype.hasOwnProperty.call(RegExp.prototype, "unicode")
      ? new RegExp("[\\\\p{C}\\\\p{Mn}\\\\p{Mc}]", "gu")
      : null;
    function unicodeEscape(s) {
      if (nonPrintable) {
        return s.replace(nonPrintable,  ch => "\\\\u{" + hex(ch) + "}");
      }
      return s;
    }

    function literalEscape(s) {
      return unicodeEscape(s
        .replace(/\\\\/g, "\\\\\\\\")
        .replace(/"/g,  "\\\\\\"")
        .replace(/\\0/g, "\\\\0")
        .replace(/\\t/g, "\\\\t")
        .replace(/\\n/g, "\\\\n")
        .replace(/\\r/g, "\\\\r")
        .replace(/[\\x00-\\x0F]/g,          ch => "\\\\x0" + hex(ch))
        .replace(/[\\x10-\\x1F\\x7F-\\x9F]/g, ch => "\\\\x"  + hex(ch)));
    }

    function classEscape(s) {
      return unicodeEscape(s
        .replace(/\\\\/g, "\\\\\\\\")
        .replace(/\\]/g, "\\\\]")
        .replace(/\\^/g, "\\\\^")
        .replace(/-/g,  "\\\\-")
        .replace(/\\0/g, "\\\\0")
        .replace(/\\t/g, "\\\\t")
        .replace(/\\n/g, "\\\\n")
        .replace(/\\r/g, "\\\\r")
        .replace(/[\\x00-\\x0F]/g,          ch => "\\\\x0" + hex(ch))
        .replace(/[\\x10-\\x1F\\x7F-\\x9F]/g, ch => "\\\\x"  + hex(ch)));
    }

    const DESCRIBE_EXPECTATION_FNS = {
      literal(expectation) {
        return "\\"" + literalEscape(expectation.text) + "\\"";
      },

      class(expectation) {
        const escapedParts = expectation.parts.map(
          part => (Array.isArray(part)
            ? classEscape(part[0]) + "-" + classEscape(part[1])
            : classEscape(part))
        );

        return "[" + (expectation.inverted ? "^" : "") + escapedParts.join("") + "]" + (expectation.unicode ? "u" : "");
      },

      any() {
        return "any character";
      },

      end() {
        return "end of input";
      },

      other(expectation) {
        return expectation.description;
      },
    };

    function describeExpectation(expectation) {
      return DESCRIBE_EXPECTATION_FNS[expectation.type](expectation);
    }

    function describeExpected(expected) {
      const descriptions = expected.map(describeExpectation);
      descriptions.sort();

      if (descriptions.length > 0) {
        let j = 1;
        for (let i = 1; i < descriptions.length; i++) {
          if (descriptions[i - 1] !== descriptions[i]) {
            descriptions[j] = descriptions[i];
            j++;
          }
        }
        descriptions.length = j;
      }

      switch (descriptions.length) {
        case 1:
          return descriptions[0];

        case 2:
          return descriptions[0] + " or " + descriptions[1];

        default:
          return descriptions.slice(0, -1).join(", ")
            + ", or "
            + descriptions[descriptions.length - 1];
      }
    }

    function describeFound(found) {
      return found ? "\\"" + literalEscape(found) + "\\"" : "end of input";
    }

    return "Expected " + describeExpected(expected) + " but " + describeFound(found) + " found.";
  }
}

function peg$parse(input, options) {
  options = options !== undefined ? options : {};

  const peg$FAILED = {};
  const peg$source = options.grammarSource;

  const peg$startRuleFunctions = {
    Expression: peg$parseExpression,
  };
  let peg$startRuleFunction = peg$parseExpression;

  const peg$c0 = "(";
  const peg$c1 = ",";
  const peg$c2 = ")";
  const peg$c3 = "{";
  const peg$c4 = "}";
  const peg$c5 = "[";
  const peg$c6 = "]";
  const peg$c7 = ".";

  const peg$r0 = /^[+\\-]/;
  const peg$r1 = /^[*\\/]/;
  const peg$r2 = /^[dD]/;
  const peg$r3 = /^[\\-+]/;
  const peg$r4 = /^[0-9]/;
  const peg$r5 = /^[a-z$_]/i;
  const peg$r6 = /^[a-z$_0-9]/i;
  const peg$r7 = /^[^ (){}[\\]+\\-*\\/,]/;
  const peg$r8 = /^[^[\\]]/;
  const peg$r9 = /^[ ]/;

  const peg$e0 = peg$classExpectation(["+", "-"], false, false, false);
  const peg$e1 = peg$classExpectation(["*", "/"], false, false, false);
  const peg$e2 = peg$literalExpectation("(", false);
  const peg$e3 = peg$literalExpectation(",", false);
  const peg$e4 = peg$literalExpectation(")", false);
  const peg$e5 = peg$classExpectation(["d", "D"], false, false, false);
  const peg$e6 = peg$literalExpectation("{", false);
  const peg$e7 = peg$literalExpectation("}", false);
  const peg$e8 = peg$literalExpectation("[", false);
  const peg$e9 = peg$literalExpectation("]", false);
  const peg$e10 = peg$classExpectation(["-", "+"], false, false, false);
  const peg$e11 = peg$classExpectation([["0", "9"]], false, false, false);
  const peg$e12 = peg$literalExpectation(".", false);
  const peg$e13 = peg$classExpectation([["a", "z"], "$", "_"], false, true, false);
  const peg$e14 = peg$classExpectation([["a", "z"], "$", "_", ["0", "9"]], false, true, false);
  const peg$e15 = peg$classExpectation([" ", "(", ")", "{", "}", "[", "]", "+", "-", "*", "/", ","], true, false, false);
  const peg$e16 = peg$otherExpectation("string");
  const peg$e17 = peg$classExpectation(["[", "]"], true, false, false);
  const peg$e18 = peg$classExpectation([" "], false, false, false);

  function peg$f0(head, tail) {
    return tail.reduce((result, elements) => {
      const operator = elements[1];
      const operands = [
        result,
        elements.find((e) => typeof e === "number" || e instanceof Object && e.class)
      ].map((e) => typeof e === "number" ? createNumericTerm(e, { truncate: true }) : e);
      return {
        class: "ArithmeticExpression",
        formula: text(),
        operator,
        operands,
        evaluated: false,
      };
    }, head);
  }
  function peg$f1(head, tail) {
    return tail.reduce((result, elements) => {
      const operator = elements[1];
      const operands = [
        result,
        elements.find((e) => typeof e === "number" || e instanceof Object && e.class)
      ].map((e) => typeof e === "number" ? createNumericTerm(e) : e);

      return {
        class: "ArithmeticExpression",
        formula: text(),
        operator,
        operands,
        evaluated: false,
      };
    }, head);
  }
  function peg$f2(fn, head, tail) {
    const terms = head !== null
      ? [head, ...tail].map((t) => typeof t === "number" ? t.toString() : t.formula)
      : [];
    return {
      class: "FunctionTerm",
      formula: text(),
      fn,
      terms,
      evaluated: false,
    };
  }
  function peg$f3(number, faces, modifiers, flavor) {
    const obj =
      number instanceof Object || faces instanceof Object
        ? {
              class: "IntermediateDie",
              formula: text(),
              number: typeof number === "number" ? createNumericTerm(number) : number,
              faces: typeof faces === "number" ? createNumericTerm(faces) : faces,
              evaluated: false,
          }
        : {
              class: "DiceTerm",
              formula: text(),
              number: number ?? 1,
              faces,
              evaluated: false,
          };

    if (modifiers) obj.modifiers = modifiers;
    if (flavor) obj.options = { flavor };

    return obj;
  }
  function peg$f4(expression, flavor) {
    const obj = {
      class: "Grouping",
      formula: text(),
      term: typeof expression === "number" ? createNumericTerm(expression) : expression,
      evaluated: false,
    };
    if (flavor) obj.options = { flavor };

    return obj;
  }
  function peg$f5(head, tail, modifiers, flavor) {
    const headTerm = typeof head === "number" ? createNumericTerm(head) : head;
    const tailTerms = tail.map((t) => typeof t === "number" ? createNumericTerm(t) : t);
    const terms = [headTerm.formula, ...tailTerms.map((t) => t.formula)];
    const firstRoll = {
      class: "DamageInstance",
      formula: headTerm.formula,
      terms: [headTerm],
      evaluated: false
    };
    if (headTerm.options?.flavor) {
      firstRoll.options = { flavor: headTerm.options.flavor };
    }

    const rolls = [
      firstRoll,
      ...tailTerms.map((term) => {
        const obj = {
          class: "DamageInstance",
          formula: term.formula,
          terms: [term],
          evaluated: false,
        };
        if (term.options?.flavor) {
          obj.options = { flavor: term.options.flavor };
        }

        return obj;
      }),
    ];

    const obj = {
      class: "InstancePool",
      formula: text(),
      terms,
      rolls,
      evaluated: false,
    };

    if (flavor) obj.options = { flavor };
    if (modifiers) obj.modifiers = modifiers;

    return obj;
  }
  function peg$f6(string) {
    return string;
  }
  function peg$f7() {
    const numified = Number(text());
    return input === text() ? createNumericTerm(numified) : numified;
  }
  function peg$f8(number, flavor) {
    return createNumericTerm(number, { flavor });
  }
  function peg$f9() {
    return Array.from(text().matchAll(/([A-z]+)([^A-z\\s()+\\-*\\/]+)?/g)).map((m) => m[0]);
  }
  let peg$currPos = options.peg$currPos | 0;
  let peg$savedPos = peg$currPos;
  const peg$posDetailsCache = [{ line: 1, column: 1 }];
  let peg$maxFailPos = peg$currPos;
  let peg$maxFailExpected = options.peg$maxFailExpected || [];
  let peg$silentFails = options.peg$silentFails | 0;

  let peg$result;

  if (options.startRule) {
    if (!(options.startRule in peg$startRuleFunctions)) {
      throw new Error("Can't start parsing from rule \\"" + options.startRule + "\\".");
    }

    peg$startRuleFunction = peg$startRuleFunctions[options.startRule];
  }

  function text() {
    return input.substring(peg$savedPos, peg$currPos);
  }

  function offset() {
    return peg$savedPos;
  }

  function range() {
    return {
      source: peg$source,
      start: peg$savedPos,
      end: peg$currPos,
    };
  }

  function location() {
    return peg$computeLocation(peg$savedPos, peg$currPos);
  }

  function expected(description, location) {
    location = location !== undefined
      ? location
      : peg$computeLocation(peg$savedPos, peg$currPos);

    throw peg$buildStructuredError(
      [peg$otherExpectation(description)],
      input.substring(peg$savedPos, peg$currPos),
      location
    );
  }

  function error(message, location) {
    location = location !== undefined
      ? location
      : peg$computeLocation(peg$savedPos, peg$currPos);

    throw peg$buildSimpleError(message, location);
  }

  function peg$getUnicode(pos = peg$currPos) {
    const cp = input.codePointAt(pos);
    if (cp === undefined) {
      return "";
    }
    return String.fromCodePoint(cp);
  }

  function peg$literalExpectation(text, ignoreCase) {
    return { type: "literal", text, ignoreCase };
  }

  function peg$classExpectation(parts, inverted, ignoreCase, unicode) {
    return { type: "class", parts, inverted, ignoreCase, unicode };
  }

  function peg$anyExpectation() {
    return { type: "any" };
  }

  function peg$endExpectation() {
    return { type: "end" };
  }

  function peg$otherExpectation(description) {
    return { type: "other", description };
  }

  function peg$computePosDetails(pos) {
    let details = peg$posDetailsCache[pos];
    let p;

    if (details) {
      return details;
    } else {
      if (pos >= peg$posDetailsCache.length) {
        p = peg$posDetailsCache.length - 1;
      } else {
        p = pos;
        while (!peg$posDetailsCache[--p]) {}
      }

      details = peg$posDetailsCache[p];
      details = {
        line: details.line,
        column: details.column,
      };

      while (p < pos) {
        if (input.charCodeAt(p) === 10) {
          details.line++;
          details.column = 1;
        } else {
          details.column++;
        }

        p++;
      }

      peg$posDetailsCache[pos] = details;

      return details;
    }
  }

  function peg$computeLocation(startPos, endPos, offset) {
    const startPosDetails = peg$computePosDetails(startPos);
    const endPosDetails = peg$computePosDetails(endPos);

    const res = {
      source: peg$source,
      start: {
        offset: startPos,
        line: startPosDetails.line,
        column: startPosDetails.column,
      },
      end: {
        offset: endPos,
        line: endPosDetails.line,
        column: endPosDetails.column,
      },
    };
    if (offset && peg$source && (typeof peg$source.offset === "function")) {
      res.start = peg$source.offset(res.start);
      res.end = peg$source.offset(res.end);
    }
    return res;
  }

  function peg$fail(expected) {
    if (peg$currPos < peg$maxFailPos) { return; }

    if (peg$currPos > peg$maxFailPos) {
      peg$maxFailPos = peg$currPos;
      peg$maxFailExpected = [];
    }

    peg$maxFailExpected.push(expected);
  }

  function peg$buildSimpleError(message, location) {
    return new peg$SyntaxError(message, null, null, location);
  }

  function peg$buildStructuredError(expected, found, location) {
    return new peg$SyntaxError(
      peg$SyntaxError.buildMessage(expected, found),
      expected,
      found,
      location
    );
  }

  function peg$parseExpression() {
    let s0, s1, s2, s3, s4, s5, s6, s7;

    s0 = peg$currPos;
    s1 = peg$parsePool();
    if (s1 === peg$FAILED) {
      s1 = peg$parseTerm();
    }
    if (s1 !== peg$FAILED) {
      s2 = [];
      s3 = peg$currPos;
      s4 = peg$parse_();
      s5 = input.charAt(peg$currPos);
      if (peg$r0.test(s5)) {
        peg$currPos++;
      } else {
        s5 = peg$FAILED;
        if (peg$silentFails === 0) { peg$fail(peg$e0); }
      }
      if (s5 !== peg$FAILED) {
        s6 = peg$parse_();
        s7 = peg$parsePool();
        if (s7 === peg$FAILED) {
          s7 = peg$parseTerm();
        }
        if (s7 !== peg$FAILED) {
          s4 = [s4, s5, s6, s7];
          s3 = s4;
        } else {
          peg$currPos = s3;
          s3 = peg$FAILED;
        }
      } else {
        peg$currPos = s3;
        s3 = peg$FAILED;
      }
      while (s3 !== peg$FAILED) {
        s2.push(s3);
        s3 = peg$currPos;
        s4 = peg$parse_();
        s5 = input.charAt(peg$currPos);
        if (peg$r0.test(s5)) {
          peg$currPos++;
        } else {
          s5 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e0); }
        }
        if (s5 !== peg$FAILED) {
          s6 = peg$parse_();
          s7 = peg$parsePool();
          if (s7 === peg$FAILED) {
            s7 = peg$parseTerm();
          }
          if (s7 !== peg$FAILED) {
            s4 = [s4, s5, s6, s7];
            s3 = s4;
          } else {
            peg$currPos = s3;
            s3 = peg$FAILED;
          }
        } else {
          peg$currPos = s3;
          s3 = peg$FAILED;
        }
      }
      peg$savedPos = s0;
      s0 = peg$f0(s1, s2);
    } else {
      peg$currPos = s0;
      s0 = peg$FAILED;
    }

    return s0;
  }

  function peg$parseTerm() {
    let s0, s1, s2, s3, s4, s5, s6, s7;

    s0 = peg$currPos;
    s1 = peg$parseTermOperand();
    if (s1 !== peg$FAILED) {
      s2 = [];
      s3 = peg$currPos;
      s4 = peg$parse_();
      s5 = input.charAt(peg$currPos);
      if (peg$r1.test(s5)) {
        peg$currPos++;
      } else {
        s5 = peg$FAILED;
        if (peg$silentFails === 0) { peg$fail(peg$e1); }
      }
      if (s5 !== peg$FAILED) {
        s6 = peg$parse_();
        s7 = peg$parseTermOperand();
        if (s7 !== peg$FAILED) {
          s4 = [s4, s5, s6, s7];
          s3 = s4;
        } else {
          peg$currPos = s3;
          s3 = peg$FAILED;
        }
      } else {
        peg$currPos = s3;
        s3 = peg$FAILED;
      }
      while (s3 !== peg$FAILED) {
        s2.push(s3);
        s3 = peg$currPos;
        s4 = peg$parse_();
        s5 = input.charAt(peg$currPos);
        if (peg$r1.test(s5)) {
          peg$currPos++;
        } else {
          s5 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e1); }
        }
        if (s5 !== peg$FAILED) {
          s6 = peg$parse_();
          s7 = peg$parseTermOperand();
          if (s7 !== peg$FAILED) {
            s4 = [s4, s5, s6, s7];
            s3 = s4;
          } else {
            peg$currPos = s3;
            s3 = peg$FAILED;
          }
        } else {
          peg$currPos = s3;
          s3 = peg$FAILED;
        }
      }
      peg$savedPos = s0;
      s0 = peg$f1(s1, s2);
    } else {
      peg$currPos = s0;
      s0 = peg$FAILED;
    }

    return s0;
  }

  function peg$parseTermOperand() {
    let s0;

    s0 = peg$parseDiceTerm();
    if (s0 === peg$FAILED) {
      s0 = peg$parseFunctionTerm();
      if (s0 === peg$FAILED) {
        s0 = peg$parseGrouping();
        if (s0 === peg$FAILED) {
          s0 = peg$parseFlavoredNumber();
          if (s0 === peg$FAILED) {
            s0 = peg$parseNumber();
          }
        }
      }
    }

    return s0;
  }

  function peg$parseFunctionTerm() {
    let s0, s1, s2, s3, s4, s5, s6, s7, s8, s9, s10, s11;

    s0 = peg$currPos;
    s1 = peg$parseIdentifier();
    if (s1 !== peg$FAILED) {
      if (input.charCodeAt(peg$currPos) === 40) {
        s2 = peg$c0;
        peg$currPos++;
      } else {
        s2 = peg$FAILED;
        if (peg$silentFails === 0) { peg$fail(peg$e2); }
      }
      if (s2 !== peg$FAILED) {
        s3 = peg$parse_();
        s4 = peg$parseExpression();
        if (s4 === peg$FAILED) {
          s4 = null;
        }
        s5 = peg$parse_();
        s6 = [];
        s7 = peg$currPos;
        s8 = peg$parse_();
        if (input.charCodeAt(peg$currPos) === 44) {
          s9 = peg$c1;
          peg$currPos++;
        } else {
          s9 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e3); }
        }
        if (s9 !== peg$FAILED) {
          s10 = peg$parse_();
          s11 = peg$parseExpression();
          if (s11 !== peg$FAILED) {
            s7 = s11;
          } else {
            peg$currPos = s7;
            s7 = peg$FAILED;
          }
        } else {
          peg$currPos = s7;
          s7 = peg$FAILED;
        }
        while (s7 !== peg$FAILED) {
          s6.push(s7);
          s7 = peg$currPos;
          s8 = peg$parse_();
          if (input.charCodeAt(peg$currPos) === 44) {
            s9 = peg$c1;
            peg$currPos++;
          } else {
            s9 = peg$FAILED;
            if (peg$silentFails === 0) { peg$fail(peg$e3); }
          }
          if (s9 !== peg$FAILED) {
            s10 = peg$parse_();
            s11 = peg$parseExpression();
            if (s11 !== peg$FAILED) {
              s7 = s11;
            } else {
              peg$currPos = s7;
              s7 = peg$FAILED;
            }
          } else {
            peg$currPos = s7;
            s7 = peg$FAILED;
          }
        }
        s7 = peg$parse_();
        if (input.charCodeAt(peg$currPos) === 41) {
          s8 = peg$c2;
          peg$currPos++;
        } else {
          s8 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e4); }
        }
        if (s8 !== peg$FAILED) {
          peg$savedPos = s0;
          s0 = peg$f2(s1, s4, s6);
        } else {
          peg$currPos = s0;
          s0 = peg$FAILED;
        }
      } else {
        peg$currPos = s0;
        s0 = peg$FAILED;
      }
    } else {
      peg$currPos = s0;
      s0 = peg$FAILED;
    }

    return s0;
  }

  function peg$parseDiceTerm() {
    let s0, s1, s2, s3, s4, s5;

    s0 = peg$currPos;
    s1 = peg$parseGrouping();
    if (s1 === peg$FAILED) {
      s1 = peg$parseFunctionTerm();
      if (s1 === peg$FAILED) {
        s1 = peg$parseNumber();
      }
    }
    if (s1 === peg$FAILED) {
      s1 = null;
    }
    s2 = input.charAt(peg$currPos);
    if (peg$r2.test(s2)) {
      peg$currPos++;
    } else {
      s2 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e5); }
    }
    if (s2 !== peg$FAILED) {
      s3 = peg$parseGrouping();
      if (s3 === peg$FAILED) {
        s3 = peg$parseFunctionTerm();
        if (s3 === peg$FAILED) {
          s3 = peg$parseNumber();
          if (s3 === peg$FAILED) {
            s3 = peg$parseIdentifier();
          }
        }
      }
      if (s3 !== peg$FAILED) {
        s4 = peg$parseModifiers();
        if (s4 === peg$FAILED) {
          s4 = null;
        }
        s5 = peg$parseFlavor();
        if (s5 === peg$FAILED) {
          s5 = null;
        }
        peg$savedPos = s0;
        s0 = peg$f3(s1, s3, s4, s5);
      } else {
        peg$currPos = s0;
        s0 = peg$FAILED;
      }
    } else {
      peg$currPos = s0;
      s0 = peg$FAILED;
    }

    return s0;
  }

  function peg$parseGrouping() {
    let s0, s1, s2, s3, s4, s5, s6;

    s0 = peg$currPos;
    if (input.charCodeAt(peg$currPos) === 40) {
      s1 = peg$c0;
      peg$currPos++;
    } else {
      s1 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e2); }
    }
    if (s1 !== peg$FAILED) {
      s2 = peg$parse_();
      s3 = peg$parseExpression();
      if (s3 !== peg$FAILED) {
        s4 = peg$parse_();
        if (input.charCodeAt(peg$currPos) === 41) {
          s5 = peg$c2;
          peg$currPos++;
        } else {
          s5 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e4); }
        }
        if (s5 !== peg$FAILED) {
          s6 = peg$parseFlavor();
          if (s6 === peg$FAILED) {
            s6 = null;
          }
          peg$savedPos = s0;
          s0 = peg$f4(s3, s6);
        } else {
          peg$currPos = s0;
          s0 = peg$FAILED;
        }
      } else {
        peg$currPos = s0;
        s0 = peg$FAILED;
      }
    } else {
      peg$currPos = s0;
      s0 = peg$FAILED;
    }

    return s0;
  }

  function peg$parsePool() {
    let s0, s1, s2, s3, s4, s5, s6, s7, s8;

    s0 = peg$currPos;
    if (input.charCodeAt(peg$currPos) === 123) {
      s1 = peg$c3;
      peg$currPos++;
    } else {
      s1 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e6); }
    }
    if (s1 !== peg$FAILED) {
      s2 = peg$parse_();
      s3 = peg$parseExpression();
      if (s3 !== peg$FAILED) {
        s4 = [];
        s5 = peg$currPos;
        if (input.charCodeAt(peg$currPos) === 44) {
          s6 = peg$c1;
          peg$currPos++;
        } else {
          s6 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e3); }
        }
        if (s6 !== peg$FAILED) {
          s7 = peg$parse_();
          s8 = peg$parseExpression();
          if (s8 !== peg$FAILED) {
            s5 = s8;
          } else {
            peg$currPos = s5;
            s5 = peg$FAILED;
          }
        } else {
          peg$currPos = s5;
          s5 = peg$FAILED;
        }
        while (s5 !== peg$FAILED) {
          s4.push(s5);
          s5 = peg$currPos;
          if (input.charCodeAt(peg$currPos) === 44) {
            s6 = peg$c1;
            peg$currPos++;
          } else {
            s6 = peg$FAILED;
            if (peg$silentFails === 0) { peg$fail(peg$e3); }
          }
          if (s6 !== peg$FAILED) {
            s7 = peg$parse_();
            s8 = peg$parseExpression();
            if (s8 !== peg$FAILED) {
              s5 = s8;
            } else {
              peg$currPos = s5;
              s5 = peg$FAILED;
            }
          } else {
            peg$currPos = s5;
            s5 = peg$FAILED;
          }
        }
        if (input.charCodeAt(peg$currPos) === 125) {
          s5 = peg$c4;
          peg$currPos++;
        } else {
          s5 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e7); }
        }
        if (s5 !== peg$FAILED) {
          s6 = peg$parseModifiers();
          if (s6 === peg$FAILED) {
            s6 = null;
          }
          s7 = peg$parseFlavor();
          if (s7 === peg$FAILED) {
            s7 = null;
          }
          peg$savedPos = s0;
          s0 = peg$f5(s3, s4, s6, s7);
        } else {
          peg$currPos = s0;
          s0 = peg$FAILED;
        }
      } else {
        peg$currPos = s0;
        s0 = peg$FAILED;
      }
    } else {
      peg$currPos = s0;
      s0 = peg$FAILED;
    }

    return s0;
  }

  function peg$parseFlavor() {
    let s0, s1, s2, s3;

    s0 = peg$currPos;
    if (input.charCodeAt(peg$currPos) === 91) {
      s1 = peg$c5;
      peg$currPos++;
    } else {
      s1 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e8); }
    }
    if (s1 !== peg$FAILED) {
      s2 = peg$currPos;
      s3 = peg$parseFlavorString();
      if (s3 !== peg$FAILED) {
        s2 = input.substring(s2, peg$currPos);
      } else {
        s2 = s3;
      }
      if (s2 !== peg$FAILED) {
        if (input.charCodeAt(peg$currPos) === 93) {
          s3 = peg$c6;
          peg$currPos++;
        } else {
          s3 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e9); }
        }
        if (s3 !== peg$FAILED) {
          peg$savedPos = s0;
          s0 = peg$f6(s2);
        } else {
          peg$currPos = s0;
          s0 = peg$FAILED;
        }
      } else {
        peg$currPos = s0;
        s0 = peg$FAILED;
      }
    } else {
      peg$currPos = s0;
      s0 = peg$FAILED;
    }

    return s0;
  }

  function peg$parseNumber() {
    let s0, s1, s2, s3, s4, s5, s6, s7;

    s0 = peg$currPos;
    s1 = peg$parse_();
    s2 = input.charAt(peg$currPos);
    if (peg$r3.test(s2)) {
      peg$currPos++;
    } else {
      s2 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e10); }
    }
    if (s2 === peg$FAILED) {
      s2 = null;
    }
    s3 = [];
    s4 = input.charAt(peg$currPos);
    if (peg$r4.test(s4)) {
      peg$currPos++;
    } else {
      s4 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e11); }
    }
    if (s4 !== peg$FAILED) {
      while (s4 !== peg$FAILED) {
        s3.push(s4);
        s4 = input.charAt(peg$currPos);
        if (peg$r4.test(s4)) {
          peg$currPos++;
        } else {
          s4 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e11); }
        }
      }
    } else {
      s3 = peg$FAILED;
    }
    if (s3 !== peg$FAILED) {
      s4 = peg$currPos;
      if (input.charCodeAt(peg$currPos) === 46) {
        s5 = peg$c7;
        peg$currPos++;
      } else {
        s5 = peg$FAILED;
        if (peg$silentFails === 0) { peg$fail(peg$e12); }
      }
      if (s5 !== peg$FAILED) {
        s6 = [];
        s7 = input.charAt(peg$currPos);
        if (peg$r4.test(s7)) {
          peg$currPos++;
        } else {
          s7 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e11); }
        }
        if (s7 !== peg$FAILED) {
          while (s7 !== peg$FAILED) {
            s6.push(s7);
            s7 = input.charAt(peg$currPos);
            if (peg$r4.test(s7)) {
              peg$currPos++;
            } else {
              s7 = peg$FAILED;
              if (peg$silentFails === 0) { peg$fail(peg$e11); }
            }
          }
        } else {
          s6 = peg$FAILED;
        }
        if (s6 !== peg$FAILED) {
          s5 = [s5, s6];
          s4 = s5;
        } else {
          peg$currPos = s4;
          s4 = peg$FAILED;
        }
      } else {
        peg$currPos = s4;
        s4 = peg$FAILED;
      }
      if (s4 === peg$FAILED) {
        s4 = null;
      }
      peg$savedPos = s0;
      s0 = peg$f7();
    } else {
      peg$currPos = s0;
      s0 = peg$FAILED;
    }

    return s0;
  }

  function peg$parseFlavoredNumber() {
    let s0, s1, s2;

    s0 = peg$currPos;
    s1 = peg$parseNumber();
    if (s1 !== peg$FAILED) {
      s2 = peg$parseFlavor();
      if (s2 !== peg$FAILED) {
        peg$savedPos = s0;
        s0 = peg$f8(s1, s2);
      } else {
        peg$currPos = s0;
        s0 = peg$FAILED;
      }
    } else {
      peg$currPos = s0;
      s0 = peg$FAILED;
    }

    return s0;
  }

  function peg$parseIdentifier() {
    let s0, s1, s2, s3, s4;

    s0 = peg$currPos;
    s1 = peg$currPos;
    s2 = input.charAt(peg$currPos);
    if (peg$r5.test(s2)) {
      peg$currPos++;
    } else {
      s2 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e13); }
    }
    if (s2 !== peg$FAILED) {
      s3 = [];
      s4 = input.charAt(peg$currPos);
      if (peg$r6.test(s4)) {
        peg$currPos++;
      } else {
        s4 = peg$FAILED;
        if (peg$silentFails === 0) { peg$fail(peg$e14); }
      }
      while (s4 !== peg$FAILED) {
        s3.push(s4);
        s4 = input.charAt(peg$currPos);
        if (peg$r6.test(s4)) {
          peg$currPos++;
        } else {
          s4 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e14); }
        }
      }
      s2 = [s2, s3];
      s1 = s2;
    } else {
      peg$currPos = s1;
      s1 = peg$FAILED;
    }
    if (s1 !== peg$FAILED) {
      s0 = input.substring(s0, peg$currPos);
    } else {
      s0 = s1;
    }

    return s0;
  }

  function peg$parseModifiers() {
    let s0, s1, s2;

    s0 = peg$currPos;
    s1 = [];
    s2 = input.charAt(peg$currPos);
    if (peg$r7.test(s2)) {
      peg$currPos++;
    } else {
      s2 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e15); }
    }
    if (s2 !== peg$FAILED) {
      while (s2 !== peg$FAILED) {
        s1.push(s2);
        s2 = input.charAt(peg$currPos);
        if (peg$r7.test(s2)) {
          peg$currPos++;
        } else {
          s2 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e15); }
        }
      }
    } else {
      s1 = peg$FAILED;
    }
    if (s1 !== peg$FAILED) {
      peg$savedPos = s0;
      s1 = peg$f9();
    }
    s0 = s1;

    return s0;
  }

  function peg$parseFlavorString() {
    let s0, s1;

    peg$silentFails++;
    s0 = [];
    s1 = input.charAt(peg$currPos);
    if (peg$r8.test(s1)) {
      peg$currPos++;
    } else {
      s1 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e17); }
    }
    if (s1 !== peg$FAILED) {
      while (s1 !== peg$FAILED) {
        s0.push(s1);
        s1 = input.charAt(peg$currPos);
        if (peg$r8.test(s1)) {
          peg$currPos++;
        } else {
          s1 = peg$FAILED;
          if (peg$silentFails === 0) { peg$fail(peg$e17); }
        }
      }
    } else {
      s0 = peg$FAILED;
    }
    peg$silentFails--;
    if (s0 === peg$FAILED) {
      s1 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e16); }
    }

    return s0;
  }

  function peg$parse_() {
    let s0, s1;

    peg$silentFails++;
    s0 = [];
    s1 = input.charAt(peg$currPos);
    if (peg$r9.test(s1)) {
      peg$currPos++;
    } else {
      s1 = peg$FAILED;
      if (peg$silentFails === 0) { peg$fail(peg$e18); }
    }
    while (s1 !== peg$FAILED) {
      s0.push(s1);
      s1 = input.charAt(peg$currPos);
      if (peg$r9.test(s1)) {
        peg$currPos++;
      } else {
        s1 = peg$FAILED;
        if (peg$silentFails === 0) { peg$fail(peg$e18); }
      }
    }
    peg$silentFails--;

    return s0;
  }

  peg$result = peg$startRuleFunction();

  const peg$success = (peg$result !== peg$FAILED && peg$currPos === input.length);
  function peg$throw() {
    if (peg$result !== peg$FAILED && peg$currPos < input.length) {
      peg$fail(peg$endExpectation());
    }

    throw peg$buildStructuredError(
      peg$maxFailExpected,
      peg$maxFailPos < input.length ? peg$getUnicode(peg$maxFailPos) : null,
      peg$maxFailPos < input.length
        ? peg$computeLocation(peg$maxFailPos, peg$maxFailPos + 1)
        : peg$computeLocation(peg$maxFailPos, peg$maxFailPos)
    );
  }
  if (options.peg$library) {
    return /** @type {any} */ ({
      peg$result,
      peg$currPos,
      peg$FAILED,
      peg$maxFailExpected,
      peg$maxFailPos,
      peg$success,
      peg$throw: peg$success ? undefined : peg$throw,
    });
  }
  if (peg$success) {
    return peg$result;
  } else {
    peg$throw();
  }
}
  AbstractDamageRoll.parser = { StartRules: ["Expression"], SyntaxError: peg$SyntaxError, parse: peg$parse };
})()
`).call(void 0,AbstractDamageRoll)});class PersistentDamageEditor extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"PersistentDamageEditor")}static{__name2(this,"PersistentDamageEditor")}static DEFAULT_OPTIONS={classes:["persistent-damage-editor"],tag:"form",window:{icon:"fa-solid fa-droplet",contentClasses:["standard-form"]},position:{width:420},actions:{add:PersistentDamageEditor.#onClickAdd,delete:PersistentDamageEditor.#onClickDelete,roll:PersistentDamageEditor.#onClickRoll}};static PARTS={main:{template:"systems/pf2e/templates/items/persistent-damage-editor.hbs",root:!0}};actor;selectedItemId;constructor(options){options.uniqueId=`persistent-damage-editor-${options.actor.uuid.replaceAll(".","-")}`,super(options),this.actor=options.actor,this.selectedItemId=options.selectedItemId??null,this.actor.apps[this.id]=this}get id(){return`persistent-damage-${this.actor.id}`}get title(){return game.i18n.format("PF2E.Item.Condition.PersistentDamage.Dialog.Title",{actor:this.actor.name})}async _prepareContext(){const existing=this.actor.itemTypes.condition.filter(c=>c.slug==="persistent-damage").map(c=>({id:c.id,active:c.active,...t$3(c.system.persistent,["formula","damageType","dc"])}));return{selectedItemId:this.selectedItemId,existing,damageTypes:this.#prepareDamageTypes()}}#prepareDamageTypes(){const labels=CONFIG.PF2E.damageTypes;return t$4(labels).map(type2=>({type:type2,label:game.i18n.localize(labels[type2]??type2)})).sort((a,b)=>a.label.localeCompare(b.label))}#reportFormulaValidity(formula,input){return input?(formula.length>0&&DamageRoll.validate(formula)&&new DamageRoll(formula,{evaluatePersistent:!0}).maximumValue>=0?input.setCustomValidity(""):(input.setCustomValidity(game.i18n.localize("PF2E.Item.Condition.PersistentDamage.Dialog.Invalid")),input.addEventListener("input",()=>input.setCustomValidity(""),{once:!0})),input.reportValidity()):!1}#getInputElements(section){return{formula:htmlQuery(section,"input[type=text]"),damageType:htmlQuery(section,"select"),dc:htmlQuery(section,"input[type=number]")}}_onChangeForm(formConfig,event2){super._onChangeForm(formConfig,event2);const section=htmlClosest(event2.target,"[data-id]");if(!section)return;const id=section.dataset.id,existing=this.actor.items.get(id,{strict:!0}),elements=this.#getInputElements(section),formula=elements.formula?.value.trim()??"",damageType=elements.damageType?.value,dc=Number(elements.dc?.value)||15;this.#reportFormulaValidity(formula,elements.formula)&&existing.update({system:{persistent:{formula,damageType,dc}}})}static async#onClickAdd(event2){const section=htmlClosest(event2.target,".form-group");if(!section)return;const elements=this.#getInputElements(section),formula=elements.formula?.value.trim()||"1d6",damageType=elements.damageType?.value,dc=Number(elements.dc?.value)||15;if(this.#reportFormulaValidity(`(${formula})[${damageType}]`,elements.formula)){const baseConditionSource=game.pf2e.ConditionManager.getCondition("persistent-damage").toObject(),persistentSource=foundry.utils.mergeObject(baseConditionSource,{system:{persistent:{formula,damageType,dc}}});await this.actor.createEmbeddedDocuments("Item",[persistentSource])}}static async#onClickDelete(event2){const existingId=htmlClosest(event2.target,"[data-id]")?.dataset.id;await this.actor.items.get(existingId,{strict:!0}).delete()}static async#onClickRoll(){const existing=this.actor.itemTypes.condition.filter(c=>c.slug==="persistent-damage");await Promise.all(existing.map(c=>c.onEndTurn()))}}const CONDITION_SLUGS=new Set(["blinded","broken","clumsy","concealed","confused","controlled","cursebound","dazzled","deafened","doomed","drained","dying","encumbered","enfeebled","fascinated","fatigued","fleeing","friendly","frightened","grabbed","helpful","hidden","hostile","immobilized","indifferent","invisible","malevolence","observed","off-guard","paralyzed","persistent-damage","petrified","prone","quickened","restrained","sickened","slowed","stunned","stupefied","unconscious","undetected","unfriendly","unnoticed","wounded"]);function isContainerCycle(item,container){return item===container?!0:container.container?isContainerCycle(item,container.container):!1}__name(isContainerCycle,"isContainerCycle"),__name2(isContainerCycle,"isContainerCycle");function hasExtraDimensionalParent(item,encountered=new Set){if(encountered.has(item.id))return!1;encountered.add(item.id);const parent=item.container;return parent?parent.traits.has("extradimensional")?!0:(encountered.add(parent.id),hasExtraDimensionalParent(parent)):!1}__name(hasExtraDimensionalParent,"hasExtraDimensionalParent"),__name2(hasExtraDimensionalParent,"hasExtraDimensionalParent");const createDisintegrateEffect=__name2(()=>{const rule={key:"TokenImage",value:"systems/pf2e/icons/effects/fine-powder.svg",animation:{transition:foundry.canvas.rendering.filters.TextureTransitionFilter.TYPES.DOTS}};return{_id:null,type:"effect",name:game.i18n.localize("PF2E.Item.Effect.Disintegrated.Name"),img:"systems/pf2e/icons/effects/fine-powder.svg",system:{slug:"effect-fine-powder",description:{value:game.i18n.localize("PF2E.Item.Effect.Disintegrated.Description")},rules:[rule],tokenIcon:{show:!1}}}},"createDisintegrateEffect");function normalizeActionChangeData(document2,changed){if(changed.system&&("actionType"in changed.system||"actions"in changed.system)){const actionType=changed.system?.actionType?.value??document2.system.actionType.value,actionCount=Number(changed.system?.actions?.value??document2.system.actions.value);changed.system=foundry.utils.mergeObject(changed.system,{actionType:{value:actionType},actions:{value:actionType!=="action"?null:Math.clamp(actionCount,1,3)}})}}__name(normalizeActionChangeData,"normalizeActionChangeData"),__name2(normalizeActionChangeData,"normalizeActionChangeData");function activateActionSheetListeners(item,html2){htmlQuery(html2,"a[data-action=frequency-add]")?.addEventListener("click",()=>{const frequency={max:1,per:"day"};item.update({system:{frequency}})}),htmlQuery(html2,"a[data-action=frequency-delete]")?.addEventListener("click",()=>{item.update({"system.frequency":null})}),item.isOfType("action","feat")&&htmlQuery(html2,"a[data-action=delete-effect]")?.addEventListener("click",()=>{item._source.system.selfEffect&&item.update({"system.selfEffect":null})})}__name(activateActionSheetListeners,"activateActionSheetListeners"),__name2(activateActionSheetListeners,"activateActionSheetListeners");function getActionCostRollOptions(prefix,item){const actionCost=item.actionCost;if(!actionCost)return[];const value=actionCost.type==="free"?0:actionCost.type==="reaction"?1:actionCost.value??0;return[`${prefix}:action:type:${actionCost.type}`,`${prefix}:action:cost:${value}`]}__name(getActionCostRollOptions,"getActionCostRollOptions"),__name2(getActionCostRollOptions,"getActionCostRollOptions");function createSelfEffectSheetData(data){if(!data)return null;const indexEntry=fromUuidSync(data.uuid);indexEntry?.name&&isImageFilePath(indexEntry.img)&&(data.name=indexEntry.name,data.img=indexEntry.img);const parsedUUID=foundry.utils.parseUuid(data.uuid),linkData={id:parsedUUID?.id??null,type:parsedUUID?.type??null,pack:parsedUUID?.collection instanceof foundry.documents.collections.CompendiumCollection?parsedUUID.collection.metadata.id:null};return{...data,...linkData}}__name(createSelfEffectSheetData,"createSelfEffectSheetData"),__name2(createSelfEffectSheetData,"createSelfEffectSheetData");async function handleSelfEffectDrop(sheet,item){return!sheet.isEditable||sheet.item.system.actionType.value==="passive"||!item?.isOfType("effect")?!1:(await sheet.item.update({"system.selfEffect":{uuid:item.uuid,name:item.name}}),!0)}__name(handleSelfEffectDrop,"handleSelfEffectDrop"),__name2(handleSelfEffectDrop,"handleSelfEffectDrop");function createActionRangeLabel(range){if(!range?.max)return null;const[key,value]=range.increment?["PF2E.Action.Range.IncrementN",range.increment]:["PF2E.Action.Range.MaxN",range.max];return game.i18n.format(key,{n:value})}__name(createActionRangeLabel,"createActionRangeLabel"),__name2(createActionRangeLabel,"createActionRangeLabel");function processSanctification(item){const itemTraits=item.system.traits;if(!itemTraits.value.includes("sanctified"))return;const actorTraits=item.actor?.system.traits?.value??[],isHoly=actorTraits.includes("holy"),isUnholy=actorTraits.includes("unholy");(isHoly||isUnholy)&&!(isHoly&&isUnholy)&&(itemTraits.value=n([...itemTraits.value,isHoly?"holy":"unholy"]).sort())}__name(processSanctification,"processSanctification"),__name2(processSanctification,"processSanctification");const PHYSICAL_ITEM_TYPES=new Set(["ammo","armor","backpack","book","consumable","equipment","shield","treasure","weapon"]),PRECIOUS_MATERIAL_TYPES=new Set(["abysium","adamantine","cold-iron","duskwood","djezet","dragonhide","dreamweb","grisantian-pelt","inubrix","keep-stone","dawnsilver","noqual","orichalcum","peachwood","siccatite","silver","sisterstone","sisterstone-dusk","sisterstone-scarlet","sloughstone","sovereign-steel","warpglass"]),PRECIOUS_MATERIAL_GRADES=new Set(["low","standard","high"]),COIN_DENOMINATIONS=["pp","gp","sp","cp"],CURRENCY_TYPES=[...COIN_DENOMINATIONS,"credits","upb"],DENOMINATION_RATES={cp:1,sp:10,gp:100,pp:1e3,credits:10,upb:10},PC_ITEM_TYPES=["ancestry","background","class","deity","feat","heritage"],ITEM_TYPES=["action","affliction","ammo","ancestry","armor","background","backpack","book","campaignFeature","class","condition","consumable","deity","effect","equipment","feat","heritage","kit","lore","melee","shield","spell","spellcastingEntry","treasure","weapon"],EFFECT_AREA_SHAPES=["burst","cone","cube","cylinder","emanation","line","square"];function itemIsOfType(item,...types){return typeof item.name=="string"&&types.some(t2=>t2==="physical"?setHasElement(PHYSICAL_ITEM_TYPES,item.type):item.type===t2)}__name(itemIsOfType,"itemIsOfType"),__name2(itemIsOfType,"itemIsOfType");function reduceItemName(label){return label.includes(":")?label.replace(/^[^:]+:\s*|\s*\([^)]+\)$/g,""):label}__name(reduceItemName,"reduceItemName"),__name2(reduceItemName,"reduceItemName");function performLatePreparation(item){const actor=item.actor;if(actor){for(const alteration of actor.synthetics.itemAlterations.filter(a=>!a.isLazy))alteration.applyAlteration({singleItem:item});item.isOfType("spell","feat","action")&&processSanctification(item)}}__name(performLatePreparation,"performLatePreparation"),__name2(performLatePreparation,"performLatePreparation");let mdConverter=null;function markdownToHTML(markdown){const converter=mdConverter??=new showdown.Converter,withSubbedBrackets=createHTMLElement("div",{innerHTML:game.i18n.localize(markdown).trim()}).innerText.replaceAll("[","\u27E6").replaceAll("]","\u27E7"),stringyHTML=converter.makeHtml(withSubbedBrackets).replace(/<\/?p[^>]*>/g,"").replaceAll("\u27E6","[").replaceAll("\u27E7","]");return foundry.applications.ux.TextEditor.implementation.truncateHTML(createHTMLElement("div",{innerHTML:stringyHTML})).innerHTML.trim()}__name(markdownToHTML,"markdownToHTML"),__name2(markdownToHTML,"markdownToHTML");const VERSATILE_DAMAGE_TYPES={b:"bludgeoning",p:"piercing",s:"slashing"};function addOrUpgradeTrait(traits,newTrait,{mode="upgrade"}={}){const isArray=Array.isArray(traits),value=isArray?traits:traits.value,config=isArray?null:traits.config??={},specialTraitRegex=/^(area|versatile)-(.*)$/,[_,specialTraitBase,specialTraitValue]=newTrait.match(specialTraitRegex)??[null,null,null];if(specialTraitBase==="versatile"&&config){config.versatile??=[];const damageType=VERSATILE_DAMAGE_TYPES[specialTraitValue??""]??specialTraitValue;objectHasKey(CONFIG.PF2E.damageTypes,damageType)&&!config.versatile.includes(damageType)&&(config.versatile.push(damageType),value.push(newTrait));return}else if(specialTraitBase==="area"){const areaMatch=specialTraitValue?.match(/^([\w]+)(?:-(\d+))?/)??[],type2=areaMatch.at(1),range=areaMatch.at(2)?Number(areaMatch.at(2)):null;if(!tupleHasValue(EFFECT_AREA_SHAPES,type2)){console.error(`Unexpected area shape ${type2}`);return}if(mode==="override"||!config?.area||config.area.type!==type2||range&&config.area.value&&range>config.area.value){config&&(config.area={type:type2,value:range});const existing=value.find(t2=>t2.startsWith("area-"));existing?value.splice(value.indexOf(existing),1,newTrait):value.push(newTrait)}return}const annotatedTraitMatch=newTrait.match(/^([a-z][-a-z]+)-(\d*d?\d+)$/);if(!annotatedTraitMatch){value.includes(newTrait)||value.push(newTrait);return}const traitBase=annotatedTraitMatch[1],upgradeAnnotation=annotatedTraitMatch[2],traitPattern=new RegExp(String.raw`${traitBase}-(\d*d?\d*)`),existingTrait=value.find(t2=>traitPattern.test(t2)),existingAnnotation=existingTrait?.match(traitPattern)?.at(1),configValue=["deadly","fatal"].includes(traitBase)?upgradeAnnotation:Number(upgradeAnnotation);existingTrait&&existingAnnotation?(mode==="override"||_expectedValueOf(upgradeAnnotation)>_expectedValueOf(existingAnnotation))&&(value.splice(value.indexOf(existingTrait),1,newTrait),config&&(config[traitBase]=configValue)):(value.includes(newTrait)||value.push(newTrait),config&&(config[traitBase]=configValue))}__name(addOrUpgradeTrait,"addOrUpgradeTrait"),__name2(addOrUpgradeTrait,"addOrUpgradeTrait");function removeTrait(traits,trait){const config=traits.config,idx=traits.value.findIndex(t2=>t2===trait);if(idx<0)return;traits.value.splice(idx,1);const annotatedTraitMatch=trait.match(/^([a-z][-a-z]+)-(\d*d?\d+)$/)??trait.match(/^(area|versatile)-(.*)$/);if(annotatedTraitMatch&&config){const traitBase=annotatedTraitMatch[1];if(traitBase==="versatile"&&config.versatile){const value=annotatedTraitMatch[2],damageType=VERSATILE_DAMAGE_TYPES[value??""]??value;config.versatile=config.versatile.filter(d=>d!==damageType),config.versatile.length===0&&delete config.versatile}else delete config[traitBase]}}__name(removeTrait,"removeTrait"),__name2(removeTrait,"removeTrait");function _expectedValueOf(annotation){const traitValueMatch=annotation.match(/(\d*)d(\d+)/);return traitValueMatch?Number(traitValueMatch[1]||1)*((Number(traitValueMatch[2])+1)/2):Number(annotation)}__name(_expectedValueOf,"_expectedValueOf"),__name2(_expectedValueOf,"_expectedValueOf");function createEffectAreaLabel(areaData){const formatString="PF2E.Item.Spell.Area",shape=game.i18n.localize(`PF2E.Area.Shape.${areaData.type}`),largeAreaLabel={1320:"PF2E.Area.Size.Quarter",2640:"PF2E.Area.Size.Half",5280:"1"}[areaData.value];if(largeAreaLabel){const size2=game.i18n.localize(largeAreaLabel),unit2=game.i18n.localize("PF2E.Area.Size.Mile");return game.i18n.format(formatString,{shape,size:size2,unit:unit2,units:unit2})}const size=Number(areaData.value),unit=game.i18n.localize("PF2E.Foot.Label"),units=game.i18n.localize("PF2E.Foot.Plural");return game.i18n.format(formatString,{shape,size,unit,units})}__name(createEffectAreaLabel,"createEffectAreaLabel"),__name2(createEffectAreaLabel,"createEffectAreaLabel");function placeItemTemplate(area,{message,item}){if(!canvas.ready)throw ErrorPF2e("No canvas");const templateType={burst:"circle",cone:"cone",cube:"rect",cylinder:"circle",emanation:"circle",line:"ray",square:"rect"}[area.type],templateData={t:templateType,distance:Number(area.value)/5*canvas.dimensions.distance,fillColor:game.user.color.toString(),flags:{pf2e:{messageId:message?.id,origin:{name:item.name,slug:item.slug,traits:foundry.utils.deepClone(item.system.traits.value),...item.getOriginData()},areaShape:area.type}}};switch(templateType){case"ray":templateData.width=CONFIG.MeasuredTemplate.defaults.width*(canvas.dimensions?.distance??1);break;case"cone":templateData.angle=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{const distance=templateData.distance??0;templateData.distance=Math.hypot(distance,distance),templateData.width=distance,templateData.direction=45;break}}return canvas.templates.createPreview(templateData)}__name(placeItemTemplate,"placeItemTemplate"),__name2(placeItemTemplate,"placeItemTemplate");class Coins{static{__name(this,"Coins")}static{__name2(this,"Coins")}#givenUnit;constructor(data){this.#givenUnit=e$3(data)?t$4(data)[0]:null;const object=typeof data=="number"?{cp:data}:data??{};for(const type2 of CURRENCY_TYPES)this[type2]=Math.max(Math.floor(Math.abs(object[type2]??0)),0)}get copperValue(){return CURRENCY_TYPES.reduce((r2,t2)=>r2+this[t2]*DENOMINATION_RATES[t2],0)}get goldValue(){return this.copperValue/100}plus(coins){const other=new Coins(coins);return new Coins({pp:this.pp+other.pp,gp:this.gp+other.gp,sp:this.sp+other.sp,cp:this.cp+other.cp,credits:this.credits+other.credits,upb:this.upb+other.upb})}scale(factor){const result=new Coins(this);for(const type2 of CURRENCY_TYPES)result[type2]*=factor;if(factor%1!==0){result.gp+=result.pp%1*10,result.sp+=result.gp%1*10,result.cp+=result.sp%1*10;for(const denomination of CURRENCY_TYPES)result[denomination]=Math.floor(Number(result[denomination].toFixed(1)))}return result}adjustForSize(size){const basePrice=new Coins(this);switch(size){case"lg":return basePrice.scale(2);case"huge":return basePrice.scale(4);case"grg":return basePrice.scale(8);default:return basePrice}}toObject(){const result={};for(const denomination of COIN_DENOMINATIONS){const value=this[denomination]+(denomination==="sp"?this.credits+this.upb:0);value&&(result[denomination]=value)}return result}static fromString(coinString,quantity=1){/^\s*\d+\s*$/.test(coinString)&&(coinString=`${coinString.trim()} gp`);const priceTag=CURRENCY_TYPES.reduce((s,denomination)=>{const localizedDenomination=game.i18n.localize(`PF2E.CurrencyAbbreviations.${denomination}`);if(localizedDenomination===denomination)return s;const pattern=new RegExp(`(?!<\\p{L})${localizedDenomination}(?!\\p{L})`,"u");return s.replace(pattern,denomination)},coinString.trim().replace(/,/g,"")),result={};for(const match of priceTag.matchAll(/(\d+)\s*([pgsc]p|credits|upb)/g)){const[value,denominationRaw]=match.slice(1,3),denomination=denominationRaw==="credits"?"sp":denominationRaw,computedValue=(Number(value)||0)*quantity;tupleHasValue(COIN_DENOMINATIONS,denomination)&&(result[denomination]=computedValue)}return new Coins(result)}static fromPrice(price,factor){const per=Math.max(1,price.per??1);return new Coins(price.value).scale(factor/per)}toString({short=!1,unit="primary",decimal=!1}={}){const normalize=unit==="primary";if(tupleHasValue(COIN_DENOMINATIONS,unit)||unit==="primary"&&decimal){const denomination=unit==="primary"?"gp":unit,divider=DENOMINATION_RATES[denomination],value=this.copperValue/divider,unitLabel=game.i18n.localize(`PF2E.CurrencyAbbreviations.${denomination}`);return`${decimal?value.toFixed(2):value} ${unitLabel}`}else if(unit==="credits"){const value=Math.ceil(this.copperValue/10);return short?String(value):`${value} ${game.i18n.localize("PF2E.CurrencyAbbreviations.credits")}`}const coins=normalize?this.#normalized():this;if(CURRENCY_TYPES.every(denomination=>!coins[denomination])){const zeroUnit=(unit==="raw"?this.#givenUnit:null)??"gp";return`0 ${game.i18n.localize(`PF2E.CurrencyAbbreviations.${zeroUnit}`)}`}const parts=[];for(const partialDenom of CURRENCY_TYPES){const value=coins[partialDenom],unitLabel=game.i18n.localize(`PF2E.CurrencyAbbreviations.${partialDenom}`);value&&parts.push(`${value} ${unitLabel}`)}return parts.join(", ")}#normalized(){const coins=new Coins({cp:this.copperValue});return coins.sp=Math.floor(coins.cp/10),coins.cp=coins.cp%10,coins.gp=Math.floor(coins.sp/10),coins.sp=coins.sp%10,coins}}const SIZES=Object.freeze(["tiny","sm","med","lg","huge","grg"]),SIZE_SLUGS=["tiny","small","medium","large","huge","gargantuan"],RARITIES=Object.freeze(["common","uncommon","rare","unique"]);function goesToEleven(value){return value>=0&&value<=11}__name(goesToEleven,"goesToEleven"),__name2(goesToEleven,"goesToEleven");const PROFICIENCY_RANKS=["untrained","trained","expert","master","legendary"];class ActorSizePF2e{static{__name(this,"ActorSizePF2e")}static{__name2(this,"ActorSizePF2e")}value;long;wide;get tokenDimensions(){return{width:this.wide/5,height:this.long/5}}static#defaultSpaces={tiny:{long:2.5,wide:2.5},sm:{long:5,wide:5},med:{long:5,wide:5},lg:{long:10,wide:10},huge:{long:15,wide:15},grg:{long:20,wide:20}};static#sizeRanks={grg:5,huge:4,lg:3,med:2,sm:1,tiny:0};constructor(params){(typeof params.value!="string"||params.smallIsMedium&&params.value==="sm")&&(params.value="med"),this.value=params.value;const spaces=ActorSizePF2e.#defaultSpaces[params.value]??ActorSizePF2e.#defaultSpaces.med;this.long=params.long??spaces.long,this.wide=params.wide??spaces.wide}equals(size,{smallIsMedium=!1}={}){const other=size instanceof ActorSizePF2e?size:new ActorSizePF2e({value:size}),thisSize=this.getEffectiveSize(this.value,{smallIsMedium}),otherSize=this.getEffectiveSize(other.value,{smallIsMedium});return thisSize===otherSize}isLargerThan(size,{smallIsMedium=!1}={}){const other=size instanceof ActorSizePF2e?size:new ActorSizePF2e({value:size}),thisSize=this.getEffectiveSize(this.value,{smallIsMedium}),otherSize=this.getEffectiveSize(other.value,{smallIsMedium});return ActorSizePF2e.#sizeRanks[thisSize]>ActorSizePF2e.#sizeRanks[otherSize]}isSmallerThan(size,{smallIsMedium=!1}={}){const other=size instanceof ActorSizePF2e?size:new ActorSizePF2e({value:size}),thisSize=this.getEffectiveSize(this.value,{smallIsMedium}),otherSize=this.getEffectiveSize(other.value,{smallIsMedium});return ActorSizePF2e.#sizeRanks[thisSize]<ActorSizePF2e.#sizeRanks[otherSize]}difference(size,{smallIsMedium=!1}={}){const thisSize=this.getEffectiveSize(this.value,{smallIsMedium}),otherSize=this.getEffectiveSize(size.value,{smallIsMedium});return ActorSizePF2e.#sizeRanks[thisSize]-ActorSizePF2e.#sizeRanks[otherSize]}getEffectiveSize(size,{smallIsMedium}){return smallIsMedium&&size==="sm"?"med":size}increment({skipSmall=!1}={}){this.value=this.value==="tiny"&&skipSmall?"med":this.value==="sm"&&skipSmall?"lg":this.value==="grg"?"grg":SIZES[SIZES.indexOf(this.value)+1];const newSpace=ActorSizePF2e.#defaultSpaces[this.value];this.long=newSpace.long,this.wide=newSpace.wide}decrement({skipSmall=!1}={}){const toTiny=this.value==="med"&&skipSmall||this.value==="tiny";this.value=toTiny?"tiny":SIZES[SIZES.indexOf(this.value)-1];const newSpace=ActorSizePF2e.#defaultSpaces[this.value];this.long=newSpace.long,this.wide=newSpace.wide}toString(){return game.i18n.localize(CONFIG.PF2E.actorSizes[this.value])}}var root_2$c=from_html('<span class="tag tag_alt svelte-lbdy4q"> </span>'),root_1$d=from_html('<div class="tags domains svelte-lbdy4q"></div>'),root_3$a=from_html('<li class="svelte-lbdy4q"> </li>'),root_5$7=from_html('<li class="svelte-lbdy4q"> </li>'),root_4$6=from_html('<ul class="sub-list svelte-lbdy4q"><li class="header svelte-lbdy4q"> </li> <!></ul>'),root_8$1=from_html('<li class="empty svelte-lbdy4q"> </li>'),root_10$1=from_html('<li class="empty svelte-lbdy4q"> </li>'),root_11=from_html('<li data-type="dice"><header class="svelte-lbdy4q"><span class="label-slug"> </span> <i class="fa-solid fa-circle-info svelte-lbdy4q"></i></header> <div class="svelte-lbdy4q"><span> <!></span> <span> </span></div></li>'),root_13=from_html('<li data-type="modifier"><header class="svelte-lbdy4q"><span class="label-slug"> </span> <i class="fa-solid fa-circle-info svelte-lbdy4q"></i></header> <div class="svelte-lbdy4q"><span> <!></span> <span> </span></div></li>'),root$j=from_html('<div class="content standard-form svelte-lbdy4q" data-tooltip-class="pf2e"><section class="summary svelte-lbdy4q"><div class="type svelte-lbdy4q"><span> </span> <span class="value svelte-lbdy4q"> </span></div> <!></section> <section class="roll-options svelte-lbdy4q"><header class="svelte-lbdy4q"> </header> <input type="search" class="filter svelte-lbdy4q"/> <ul class="scrollable svelte-lbdy4q"><!> <!></ul></section> <section class="modifiers svelte-lbdy4q"><header class="svelte-lbdy4q"><!></header> <ul class="modifier-list svelte-lbdy4q"><!> <!> <!></ul></section></div>');function App$7($$anchor,$$props){push($$props,!0);const localize=game.i18n.localize.bind(game.i18n);let searchTerm=state("");const context=user_derived(()=>$$props.state.context),modifiers=user_derived(()=>$$props.state.modifiers),dice=user_derived(()=>$$props.state.dice),results=user_derived(()=>({rollOptions:$$props.state.rollOptions.filter(r2=>r2.includes(get(searchTerm))),contextualOptions:$$props.state.contextualOptions.map(c=>({header:c.header,options:c.options.filter(o=>o.includes(get(searchTerm)))})).filter(c=>c.options.length>0)}));function getCriticalLabel(critical){return typeof critical=="boolean"?game.i18n.localize(`PF2E.RuleEditor.General.CriticalBehavior.${critical}`):null}__name(getCriticalLabel,"getCriticalLabel"),__name2(getCriticalLabel,"getCriticalLabel");async function showOptionsTooltip(element,object){const rollOptions=t(object.getRollOptions().sort(),o=>o.includes(":")),content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/system/roll-options-tooltip.hbs",{description:game.i18n.localize("PF2E.ChatRollDetails.DiceRollOptionsHint"),rollOptions});game.tooltip.dismissLockedTooltips(),game.tooltip.activate(element,{html:createHTMLElement("div",{innerHTML:content}),locked:!0,direction:"RIGHT"})}__name(showOptionsTooltip,"showOptionsTooltip"),__name2(showOptionsTooltip,"showOptionsTooltip");var div=root$j(),section=child(div),div_1=child(section),span=child(div_1),text$1=child(span),span_1=sibling(span,2),text_1=child(span_1),node=sibling(div_1,2);{var consequent=__name2($$anchor2=>{var div_2=root_1$d();each(div_2,21,()=>$$props.state.domains,index,($$anchor3,domain)=>{var span_2=root_2$c(),text_2=child(span_2);template_effect(()=>set_text(text_2,get(domain))),append($$anchor3,span_2)}),append($$anchor2,div_2)},"consequent");if_block(node,$$render=>{$$props.state.domains&&$$render(consequent)})}var section_1=sibling(section,2),header=child(section_1),text_3=child(header),input=sibling(header,2),ul=sibling(input,2),node_1=child(ul);each(node_1,17,()=>get(results).rollOptions,index,($$anchor2,option)=>{var li=root_3$a(),text_4=child(li);template_effect(()=>set_text(text_4,get(option))),append($$anchor2,li)});var node_2=sibling(node_1,2);each(node_2,17,()=>get(results).contextualOptions,index,($$anchor2,list)=>{var ul_1=root_4$6(),li_1=child(ul_1),text_5=child(li_1),node_3=sibling(li_1,2);each(node_3,17,()=>get(list).options,index,($$anchor3,option)=>{var li_2=root_5$7(),text_6=child(li_2);template_effect(()=>set_text(text_6,get(option))),append($$anchor3,li_2)}),template_effect(()=>set_text(text_5,get(list).header)),append($$anchor2,ul_1)});var section_2=sibling(section_1,2),header_1=child(section_2),node_4=child(header_1);{var consequent_1=__name2($$anchor2=>{var text_7=text();template_effect($0=>set_text(text_7,$0),[()=>localize("PF2E.ChatRollDetails.DiceAndModifiers")]),append($$anchor2,text_7)},"consequent_1"),alternate=__name2($$anchor2=>{var text_8=text();template_effect($0=>set_text(text_8,$0),[()=>localize("PF2E.ModifiersTitle")]),append($$anchor2,text_8)},"alternate");if_block(node_4,$$render=>{get(dice)?$$render(consequent_1):$$render(alternate,!1)})}var ul_2=sibling(header_1,2),node_5=child(ul_2);{var consequent_2=__name2($$anchor2=>{var li_3=root_8$1(),text_9=child(li_3);template_effect($0=>set_text(text_9,$0),[()=>localize("PF2E.ChatRollDetails.FlatCheckNoModifiers")]),append($$anchor2,li_3)},"consequent_2"),alternate_1=__name2($$anchor2=>{var fragment_2=comment(),node_6=first_child(fragment_2);{var consequent_3=__name2($$anchor3=>{var li_4=root_10$1(),text_10=child(li_4);template_effect($0=>set_text(text_10,$0),[()=>localize("None")]),append($$anchor3,li_4)},"consequent_3");if_block(node_6,$$render=>{!get(modifiers).length&&!get(dice).length&&$$render(consequent_3)},!0)}append($$anchor2,fragment_2)},"alternate_1");if_block(node_5,$$render=>{get(context).type==="flat-check"?$$render(consequent_2):$$render(alternate_1,!1)})}var node_7=sibling(node_5,2);each(node_7,17,()=>get(dice),index,($$anchor2,d,idx)=>{const value=user_derived(()=>[getDamageDiceValueLabel(get(d),{sign:!0}),getDamageDiceOverrideLabel(get(d))].filter(e$1).join(" "));var li_5=root_11();let classes;set_attribute(li_5,"data-idx",idx);var header_2=child(li_5),span_3=child(header_2),text_11=child(span_3),i=sibling(span_3,2),div_3=sibling(header_2,2),span_4=child(div_3),text_12=child(span_4),node_8=sibling(text_12);{var consequent_4=__name2($$anchor3=>{var text_13=text();template_effect(()=>set_text(text_13,`(${get(d).category??""})`)),append($$anchor3,text_13)},"consequent_4");if_block(node_8,$$render=>{get(d).category&&$$render(consequent_4)})}var span_5=sibling(span_4,2),text_14=child(span_5);template_effect(($0,$1)=>{classes=set_class(li_5,1,"modifier svelte-lbdy4q",null,classes,$0),set_text(text_11,`${get(d).label??""} (${get(d).slug??""})`),set_text(text_12,`${get(value)??""}
                            ${get(d).damageType??""} `),set_text(text_14,$1)},[()=>({disabled:!get(d).enabled}),()=>getCriticalLabel(get(d).critical)]),event$1("pointerenter",i,evt=>showOptionsTooltip(evt.currentTarget,new DamageDicePF2e(get(d)))),append($$anchor2,li_5)});var node_9=sibling(node_7,2);each(node_9,17,()=>get(modifiers),index,($$anchor2,m,idx)=>{var li_6=root_13();let classes_1;set_attribute(li_6,"data-idx",idx);var header_3=child(li_6),span_6=child(header_3),text_15=child(span_6),i_1=sibling(span_6,2),div_4=sibling(header_3,2),span_7=child(div_4),text_16=child(span_7),node_10=sibling(text_16);{var consequent_5=__name2($$anchor3=>{var text_17=text();template_effect(()=>set_text(text_17,`(${get(m).damageCategory??""})`)),append($$anchor3,text_17)},"consequent_5");if_block(node_10,$$render=>{get(m).damageCategory&&$$render(consequent_5)})}var span_8=sibling(span_7,2),text_18=child(span_8);template_effect(($0,$1,$2,$3)=>{classes_1=set_class(li_6,1,"modifier svelte-lbdy4q",null,classes_1,$0),set_text(text_15,`${get(m).label??""} (${get(m).slug??""})`),set_text(text_16,`${$1??""}
                            ${$2??""}
                            ${get(m).damageType??""} `),set_text(text_18,$3)},[()=>({disabled:!get(m).enabled}),()=>localize(`PF2E.ModifierType.${get(m).type}`),()=>signedInteger(get(m).modifier),()=>getCriticalLabel(get(m).critical)]),event$1("pointerenter",i_1,evt=>showOptionsTooltip(evt.currentTarget,new Modifier(get(m)))),append($$anchor2,li_6)}),template_effect(($0,$1,$2)=>{set_text(text$1,`${$0??""}:`),set_text(text_1,get(context).type),set_text(text_3,$1),set_attribute(input,"placeholder",$2)},[()=>localize("PF2E.Roll.Type"),()=>localize("PF2E.ChatRollDetails.RollOptions"),()=>localize("PF2E.CompendiumBrowser.Filter.SearchPlaceholder")]),bind_value(input,()=>get(searchTerm),$$value=>set(searchTerm,$$value)),append($$anchor,div),pop()}__name(App$7,"App$7"),__name2(App$7,"App$7");class RollInspector extends SvelteApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"RollInspector")}static{__name2(this,"RollInspector")}static DEFAULT_OPTIONS={position:{width:650,height:500},window:{icon:"fa-solid fa-face-monocle",title:"PF2E.ChatRollDetails.Title",resizable:!0}};root=App$7;message;constructor(options){super(options),this.message=options.message}async _prepareContext(){const context=this.message.flags.pf2e.context;if(!context)throw new Error("RollInspector must receive a context");const contextualOptions=context&&"contextualOptions"in context?context.contextualOptions:{},rollOptions=t(context?.options?.sort()??[],o=>o.includes(":"));return{foundryApp:this,state:{context,dice:this.message.flags.pf2e.dice??[],domains:context?.domains?.sort()??[],modifiers:this.message.flags.pf2e.modifiers??[],rollOptions,contextualOptions:Object.entries(contextualOptions??{}).map(([key,value])=>({header:game.i18n.localize(`PF2E.ChatRollDetails.ContextualOptions.${key}`),options:value??[]})).filter(o=>!!o.options.length)}}}}let auraCheckLock=Promise.resolve();const checkAuras=foundry.utils.debounce(async function(){if(!(canvas.ready&&this.isInFocus&&this.canHaveAuras))return;await auraCheckLock;const lock={release:__name2(()=>{},"release")};auraCheckLock=new Promise(resolve=>{lock.release=resolve});try{const tokens=this.tokens.reduce((list,token)=>(token.isLinked&&list.some(t2=>t2.actor===token.actor)||list.push(token),list),[]);for(const token of tokens)await token.object?.animation;for(const aura of tokens.flatMap(t2=>Array.from(t2.auras.values())))await aura.notifyActors();const sceneActors=new Set(tokens.flatMap(t2=>t2.actor?.primaryUpdater===game.user?t2.actor:[]));for(const actor of sceneActors)actor.checkAreaEffects()}finally{lock.release()}},100);function isDefaultTokenImage(token){return[ActorPF2e.DEFAULT_ICON,`systems/pf2e/icons/default-icons/${token.actor?.type}.svg`].some(path=>token.texture.src?.endsWith(path))}__name(isDefaultTokenImage,"isDefaultTokenImage"),__name2(isDefaultTokenImage,"isDefaultTokenImage");var LightLevels=(LightLevels2=>(LightLevels2[LightLevels2.DARKNESS=.25]="DARKNESS",LightLevels2[LightLevels2.BRIGHT_LIGHT=.75]="BRIGHT_LIGHT",LightLevels2))(LightLevels||{});class ScenePF2e extends Scene{static{__name(this,"ScenePF2e")}static{__name2(this,"ScenePF2e")}get rulesBasedVision(){return this.tokenVision?this.flags.pf2e.rulesBasedVision??game.pf2e.settings.rbv:!1}get canHaveAuras(){return this.grid.type===CONST.GRID_TYPES.SQUARE}get hearingRange(){return this.flags.pf2e.hearingRange}get darknessSyncedToTime(){return this.flags.pf2e.syncDarkness==="enabled"||this.flags.pf2e.syncDarkness==="default"&&game.pf2e.settings.worldClock.syncDarkness}get lightLevel(){return 1-this.environment.darknessLevel}get isBright(){return this.lightLevel>=LightLevels.BRIGHT_LIGHT}get isDimlyLit(){return!this.isBright&&!this.isDark}get isDark(){return this.lightLevel<=LightLevels.DARKNESS}get isInFocus(){const soleUserIsGM=game.user.isGM&&game.users.filter(u=>u.active).length===1;return this.active&&!soleUserIsGM||this.isView&&soleUserIsGM}#sizeSyncBatch=new Map;prepareData(){super.prepareData(),Promise.resolve().then(()=>{this.checkAuras()})}prepareBaseData(){super.prepareBaseData(),this.flags.pf2e=foundry.utils.mergeObject({hearingRange:null,rulesBasedVision:null,syncDarkness:"default"},this.flags.pf2e??{}),this.rulesBasedVision&&(this.environment.globalLight.enabled=!0,this.environment.globalLight.darkness.max=1-(LightLevels.DARKNESS+.001))}#refreshTerrainAwareness(){if(this.regions.some(r2=>r2.behaviors.some(b=>!b.disabled&&b.type==="environmentFeature")))for(const token of this.tokens.filter(t2=>t2.isLinked)){const rollOptionsAll=token.actor?.rollOptions.all??{};(rollOptionsAll["self:position:difficult-terrain"]?rollOptionsAll["self:position:difficult-terrain:greater"]?2:1:0)!==token.difficultTerrain&&token.actor?.reset()}}syncTokenDimensions(tokenDoc,dimensions){tokenDoc.parent?.tokens.has(tokenDoc.id)&&(this.#sizeSyncBatch.set(tokenDoc.id,dimensions),this.#processSyncBatch())}#processSyncBatch=foundry.utils.debounce(()=>{const entries=this.#sizeSyncBatch.entries().toArray().map(([_id2,{width,height}])=>({_id:_id2,width,height}));this.#sizeSyncBatch.clear(),this.updateEmbeddedDocuments("Token",entries,{animation:{movementSpeed:1.5}})},0);_onUpdate(changed,options,userId){super._onUpdate(changed,options,userId);const flagChanges=changed.flags?.pf2e??{};if(this.isView&&["rulesBasedVision","hearingRange"].some(k=>flagChanges[k]!==void 0)&&canvas.perception.update({initializeLighting:!0,initializeVision:!0}),(changed.active===!0||this.active&&changed.flags?.pf2e?.environmentTypes)&&this.#refreshTerrainAwareness(),changed.active!==!1&&canvas.scene===this)for(const token of canvas.tokens.placeables)token.auras.reset()}_onUpdateDescendantDocuments(parent,collection,documents,changes,options,userId){super._onUpdateDescendantDocuments(parent,collection,documents,changes,options,userId),["behaviors","regions","tokens"].includes(collection)&&this.#refreshTerrainAwareness()}_onDeleteDescendantDocuments(parent,collection,documents,ids,options,userId){super._onDeleteDescendantDocuments(parent,collection,documents,ids,options,userId),documents.some(d=>d instanceof TokenDocumentPF2e&&!(d._source.light.dim||d._source.light.bright)&&d.actor?.synthetics.tokenOverrides.light)&&canvas.perception.update({initializeLighting:!0,initializeVision:!0})}}Object.defineProperty(ScenePF2e.prototype,"checkAuras",{configurable:!1,enumerable:!1,writable:!1,value:checkAuras});class AmbientLightDocumentPF2e extends AmbientLightDocument{static{__name(this,"AmbientLightDocumentPF2e")}static{__name2(this,"AmbientLightDocumentPF2e")}}class MeasuredTemplateDocumentPF2e extends MeasuredTemplateDocument{static{__name(this,"MeasuredTemplateDocumentPF2e")}static{__name2(this,"MeasuredTemplateDocumentPF2e")}get actor(){const uuid=this.flags.pf2e?.origin?.actor;if(!uuid)return null;const document2=fromUuidSync(uuid);return document2 instanceof ActorPF2e?document2:this.item?.actor??null}get item(){const origin=this.flags.pf2e?.origin,uuid=origin?.uuid;if(!uuid)return null;const item=fromUuidSync(uuid);if(!(item instanceof ItemPF2e))return null;if(item?.isOfType("spell")){const overlayIds=origin?.variant?.overlays,castRank=origin?.castRank??item.rank;return item.loadVariant({overlayIds,castRank})??item}return item}get message(){return game.messages.get(this.flags.pf2e?.messageId??"")??null}get areaShape(){return this.flags.pf2e.areaShape}_initializeSource(data,options){const initialized=super._initializeSource(data,options),areaShape=initialized.t==="cone"?"cone":initialized.t==="ray"?"line":null;return initialized.flags.pf2e=foundry.utils.mergeObject({areaShape},initialized.flags.pf2e??{}),initialized}_onCreate(data,options,userId){super._onCreate(data,options,userId),toggleClearTemplatesButton(this.message)}_onDelete(options,userId){super._onDelete(options,userId),toggleClearTemplatesButton(this.message)}}const NPC_ATTACK_ACTIONS={strike:"PF2E.Actions.Strike.Title","area-fire":"PF2E.Actions.AreaFire.Title","auto-fire":"PF2E.Actions.AutoFire.Title"};class Predicate extends Array{static{__name(this,"Predicate")}static{__name2(this,"Predicate")}isValid;constructor(...statements){super(...Array.isArray(statements[0])?statements[0]:statements),this.isValid=Predicate.isValid(this),Object.defineProperty(this,"isValid",{enumerable:!1})}static isValid(statements){return this.isArray(statements)}static isArray(statements){return super.isArray(statements)&&statements.every(s=>StatementValidator.isStatement(s))}static test(predicate=[],options){return predicate instanceof Predicate?predicate.test(options):new Predicate(...predicate).test(options)}test(options){if(this.length===0)return!0;if(!this.isValid)return console.warn("PF2e System | The provided predicate set is malformed."),!1;const domain=options instanceof Set?options:new Set(options);return this.every(s=>this.#isTrue(s,domain))}toObject(){return foundry.utils.deepClone([...this])}clone(){return new Predicate(this.toObject())}#isTrue(statement,domain){return typeof statement=="string"&&domain.has(statement)||StatementValidator.isBinaryOp(statement)&&this.#testBinaryOp(statement,domain)||StatementValidator.isCompound(statement)&&this.#testCompound(statement,domain)}#testBinaryOp(statement,domain){if("eq"in statement)return typeof statement.eq[1]=="string"?statement.eq[0]===statement.eq[1]:domain.has(`${statement.eq[0]}:${statement.eq[1]}`);{const[operator,[left,right]]=Object.entries(statement)[0],getValues=__name2(operand=>{const maybeNumber=Number(operand);if(!Number.isNaN(maybeNumber))return[maybeNumber];const pattern=new RegExp(String.raw`^${operand}:([^:]+)$`),values=domain.values().map(s=>Number(pattern.exec(s)?.[1]||NaN)).filter(v=>!Number.isNaN(v)).toArray();return values.length>0?values:[NaN]},"getValues"),leftValues=getValues(left),rightValues=getValues(right);switch(operator){case"gt":return leftValues.some(l=>rightValues.every(r2=>l>r2));case"gte":return leftValues.some(l=>rightValues.every(r2=>l>=r2));case"lt":return leftValues.some(l=>rightValues.every(r2=>l<r2));case"lte":return leftValues.some(l=>rightValues.every(r2=>l<=r2));default:return console.warn("PF2e System | Malformed binary operation encountered"),!1}}}#testCompound(statement,domain){return"and"in statement&&statement.and.every(s=>this.#isTrue(s,domain))||"nand"in statement&&!statement.nand.every(s=>this.#isTrue(s,domain))||"or"in statement&&statement.or.some(s=>this.#isTrue(s,domain))||"xor"in statement&&statement.xor.filter(s=>this.#isTrue(s,domain)).length===1||"nor"in statement&&!statement.nor.some(s=>this.#isTrue(s,domain))||"not"in statement&&!this.#isTrue(statement.not,domain)||"if"in statement&&!(this.#isTrue(statement.if,domain)&&!this.#isTrue(statement.then,domain))||"iff"in statement&&(statement.iff.every(s=>this.#isTrue(s,domain))||statement.iff.every(s=>!this.#isTrue(s,domain)))}}class StatementValidator{static{__name(this,"StatementValidator")}static{__name2(this,"StatementValidator")}static isStatement(statement){return e$2(statement)?this.isCompound(statement)||this.isBinaryOp(statement):typeof statement=="string"?this.isAtomic(statement):!1}static isAtomic(statement){return typeof statement=="string"&&statement.length>0||this.isBinaryOp(statement)}static#binaryOperators=new Set(["eq","gt","gte","lt","lte"]);static isBinaryOp(statement){if(!e$2(statement))return!1;const entries=Object.entries(statement);if(entries.length>1)return!1;const[operator,operands]=entries[0];return this.#binaryOperators.has(operator)&&Array.isArray(operands)&&operands.length===2&&typeof operands[0]=="string"&&["string","number"].includes(typeof operands[1])}static isCompound(statement){return e$2(statement)&&(this.#isAnd(statement)||this.#isOr(statement)||this.#isNand(statement)||this.#isXor(statement)||this.#isNor(statement)||this.#isNot(statement)||this.#isIf(statement)||this.#isIff(statement))}static#isAnd(statement){return Object.keys(statement).length===1&&Array.isArray(statement.and)&&statement.and.every(subProp=>this.isStatement(subProp))}static#isNand(statement){return Object.keys(statement).length===1&&Array.isArray(statement.nand)&&statement.nand.every(subProp=>this.isStatement(subProp))}static#isOr(statement){return Object.keys(statement).length===1&&Array.isArray(statement.or)&&statement.or.every(subProp=>this.isStatement(subProp))}static#isXor(statement){return Object.keys(statement).length===1&&Array.isArray(statement.xor)&&statement.xor.every(subProp=>this.isStatement(subProp))}static#isNor(statement){return Object.keys(statement).length===1&&Array.isArray(statement.nor)&&statement.nor.every(subProp=>this.isStatement(subProp))}static#isNot(statement){return Object.keys(statement).length===1&&!!statement.not&&this.isStatement(statement.not)}static#isIf(statement){return Object.keys(statement).length===2&&this.isStatement(statement.if)&&this.isStatement(statement.then)}static#isIff(statement){return Object.keys(statement).length===1&&Array.isArray(statement.iff)&&statement.iff.every(s=>this.isStatement(s))}}let AutomaticBonusProgression$1=class{static{__name(this,"AutomaticBonusProgression2")}static{__name2(this,"AutomaticBonusProgression")}static isEnabled(actor){if(actor&&!actor.flags?.pf2e)return!1;const settingEnabled=game.pf2e.settings.variants.abp!=="noABP",abpDisabledForActor=!!actor?.flags.pf2e.disableABP;return settingEnabled&&!abpDisabledForActor}static getStrikingDice(level){return level<4?0:level<12?1:level<19?2:3}static concatModifiers(actor){if(!this.isEnabled(actor))return;const{level,synthetics}=actor,values=this.abpValues(level),ac=values.ac,perception=values.perception,save=values.save,setting=game.pf2e.settings.variants.abp;if(save>0&&(synthetics.modifiers["saving-throw"]??=[]).push(()=>new Modifier({slug:"save-potency",label:"PF2E.AutomaticBonusProgression.savePotency",modifier:save,type:"potency"})),ac>0&&(synthetics.modifiers.ac??=[]).push(()=>new Modifier({slug:"defense-potency",label:"PF2E.AutomaticBonusProgression.defensePotency",modifier:ac,type:"potency"})),perception>0&&(synthetics.modifiers.perception??=[]).push(()=>new Modifier({slug:"perception-potency",label:"PF2E.AutomaticBonusProgression.perceptionPotency",modifier:perception,type:"potency"})),setting==="ABPRulesAsWritten"){const attack=this.abpValues(level).attack;attack>0&&(synthetics.modifiers["strike-attack-roll"]??=[]).push(()=>new Modifier({slug:"attack-potency",label:"PF2E.AutomaticBonusProgression.attackPotency",modifier:attack,type:"potency"}))}if(setting==="ABPFundamentalPotency"){const attack=this.abpValues(level).attack;if(attack>0){const potency={label:game.i18n.localize("PF2E.AutomaticBonusProgression.attackPotency"),type:"potency",bonus:attack,predicate:new Predicate};(synthetics.weaponPotency["strike-attack-roll"]??=[]).push(potency)}}}static cleanupRunes(item){this.isEnabled(item.actor)&&(item.system.grade&&="commercial",item.system.runes.potency=0,item.isOfType("weapon")?item.system.runes.striking=0:item.system.runes.resilient=0,game.pf2e.settings.variants.abp==="ABPRulesAsWritten"&&(item.system.runes.property=[]))}static suppressRuleElement(rule,value){return this.isEnabled(rule.actor)&&rule.type==="item"&&value>=0&&rule.fromEquipment}static getAttackPotency(level){return level<2?0:level<10?1:level<16?2:3}static getDefensePotency(level){return level<5?0:level<11?1:level<18?2:3}static abpValues(level){const attack=this.getAttackPotency(level),ac=this.getDefensePotency(level);let perception,save;return level>=7&&level<13?perception=1:level>=13&&level<19?perception=2:level>=19?perception=3:perception=0,level>=8&&level<14?save=1:level>=14&&level<20?save=2:level>=20?save=3:save=0,{attack,ac,perception,save}}};function getPropertyRuneSlots(item){if(item.system.grade)return 0;const fromMaterial=item.system.material.type==="orichalcum"?1:0,getABPPotency=item.isOfType("weapon")?AutomaticBonusProgression$1.getAttackPotency:AutomaticBonusProgression$1.getDefensePotency,fromPotency=AutomaticBonusProgression$1.isEnabled(item.actor)?getABPPotency(!item.actor||item.actor.isOfType("loot")?20:item.actor.level):item.system.runes.potency;return fromMaterial+fromPotency}__name(getPropertyRuneSlots,"getPropertyRuneSlots"),__name2(getPropertyRuneSlots,"getPropertyRuneSlots");function prunePropertyRunes(runes,validTypes){const runeSet=new Set(runes);return Array.from(runeSet).filter(r2=>!!r2&&r2 in validTypes&&!runeSet.has(`greater${r2.titleCase()}`)&&!runeSet.has(`major${r2.replace(/^greater/,"").titleCase()}`)&&!runeSet.has(`true${r2.replace(/^greater|^major/,"").titleCase()}`))}__name(prunePropertyRunes,"prunePropertyRunes"),__name2(prunePropertyRunes,"prunePropertyRunes");function getRuneValuationData(item){if(!item.isOfType("armor","shield","weapon"))return[];const itemRunes=item.system.runes,data=item.isOfType("armor")?{runes:RUNE_DATA.armor,weaponRunes:{},secondaryFundamental:"resilient"}:item.isOfType("shield")?{runes:RUNE_DATA.shield,weaponRunes:RUNE_DATA.weapon,secondaryFundamental:""}:{runes:RUNE_DATA.weapon,weaponRunes:{},secondaryFundamental:"striking"};return(item.isOfType("shield")?[data.runes.reinforcing[item.system.runes.reinforcing],data.weaponRunes.potency[item.system.traits.integrated?.runes.potency??0],data.weaponRunes.striking[item.system.traits.integrated?.runes.striking??0],item.system.traits.integrated?.runes.property.map(p=>data.weaponRunes.property[p])??[]].flat():[data.runes.potency[item.system.runes.potency],data.runes[data.secondaryFundamental]?.[itemRunes[data.secondaryFundamental]??""],item.system.runes.property.map(p=>data.runes.property[p])].flat()).filter(e$1)}__name(getRuneValuationData,"getRuneValuationData"),__name2(getRuneValuationData,"getRuneValuationData");function getPropertyRuneDegreeAdjustments(item){return n([item.system.runes.property.map(p=>WEAPON_PROPERTY_RUNES[p].attack?.dosAdjustments),item.system.runes.effects.map(p=>WEAPON_PROPERTY_RUNES[p].attack?.dosAdjustments)].flat(2)).filter(e$1)}__name(getPropertyRuneDegreeAdjustments,"getPropertyRuneDegreeAdjustments"),__name2(getPropertyRuneDegreeAdjustments,"getPropertyRuneDegreeAdjustments");function getPropertyRuneDamage(weapon,runes,options){return runes.flatMap(rune=>{const runeData=WEAPON_PROPERTY_RUNES[rune];return foundry.utils.deepClone(runeData.damage?.additional??[]).map(data=>{const slug=sluggify(rune);if("modifier"in data){const resolvables=weapon.getRollData(),value=typeof data.modifier=="string"?Number(Roll.replaceFormulaData(data.modifier,resolvables))||0:data.modifier;return new Modifier({...data,slug,modifier:value})}else{const dice=new DamageDicePF2e({selector:"strike-damage",slug,label:RUNE_DATA.weapon.property[rune]?.name,diceNumber:data.diceNumber??1,dieSize:data.dieSize??"d6",damageType:data.damageType,category:data.category??null,predicate:data.predicate,critical:data.critical??null});return dice.test(options),dice}})})}__name(getPropertyRuneDamage,"getPropertyRuneDamage"),__name2(getPropertyRuneDamage,"getPropertyRuneDamage");function getPropertyRuneStrikeAdjustments(runes){return runes.flatMap(r2=>RUNE_DATA.weapon.property[r2].strikeAdjustments??[])}__name(getPropertyRuneStrikeAdjustments,"getPropertyRuneStrikeAdjustments"),__name2(getPropertyRuneStrikeAdjustments,"getPropertyRuneStrikeAdjustments");function getPropertyRuneModifierAdjustments(runes){return runes.flatMap(r2=>RUNE_DATA.weapon.property[r2].damage?.adjustments??[])}__name(getPropertyRuneModifierAdjustments,"getPropertyRuneModifierAdjustments"),__name2(getPropertyRuneModifierAdjustments,"getPropertyRuneModifierAdjustments");const FUNDAMENTAL_ARMOR_RUNE_DATA={potency:{0:null,1:{name:"PF2E.ArmorPotencyRune1",value:1,level:5,price:160,rarity:"common",traits:[]},2:{name:"PF2E.ArmorPotencyRune2",value:2,level:11,price:1060,rarity:"common",traits:[]},3:{name:"PF2E.ArmorPotencyRune3",value:3,level:18,price:20560,rarity:"common",traits:[]},4:{name:"PF2E.ArmorPotencyRune4",value:4,level:20,price:7e4,rarity:"rare",traits:["mythic"]}},resilient:{0:null,1:{name:"PF2E.ArmorResilientRune",level:8,price:340,rarity:"common",slug:"resilient",traits:[]},2:{name:"PF2E.ArmorGreaterResilientRune",level:14,price:3440,rarity:"common",slug:"greaterResilient",traits:[]},3:{name:"PF2E.ArmorMajorResilientRune",level:20,price:49440,rarity:"common",slug:"majorResilient",traits:[]},4:{name:"PF2E.ArmorMythicResilientRune",level:20,price:7e4,rarity:"rare",slug:"mythicResilient",traits:["mythic"]}}},FUNDAMENTAL_WEAPON_RUNE_DATA={potency:{0:null,1:{name:"PF2E.WeaponPotencyRune1",value:1,level:2,price:35,rarity:"common",traits:[]},2:{name:"PF2E.WeaponPotencyRune2",value:2,level:10,price:935,rarity:"common",traits:[]},3:{name:"PF2E.WeaponPotencyRune3",value:3,level:16,price:8935,rarity:"common",traits:[]},4:{name:"PF2E.WeaponPotencyRune4",value:4,level:20,price:7e4,rarity:"rare",traits:["mythic"]}},striking:{0:null,1:{name:"PF2E.Item.Weapon.Rune.Striking.Striking",level:4,price:65,rarity:"common",slug:"striking",traits:[]},2:{name:"PF2E.Item.Weapon.Rune.Striking.Greater",level:12,price:1065,rarity:"common",slug:"greaterStriking",traits:[]},3:{name:"PF2E.Item.Weapon.Rune.Striking.Major",level:19,price:31065,rarity:"common",slug:"majorStriking",traits:[]},4:{name:"PF2E.Item.Weapon.Rune.Striking.Mythic",level:20,price:7e4,rarity:"rare",slug:"mythicStriking",traits:["mythic"]}}},FUNDAMENTAL_SHIELD_RUNE_DATA={reinforcing:{0:null,1:{name:"PF2E.Item.Shield.Rune.Reinforcing.Minor",level:4,price:75,rarity:"common",traits:["magical"],hardness:{increase:3,max:8},maxHP:{increase:44,max:64}},2:{name:"PF2E.Item.Shield.Rune.Reinforcing.Lesser",level:7,price:300,rarity:"common",traits:["magical"],hardness:{increase:3,max:10},maxHP:{increase:52,max:80}},3:{name:"PF2E.Item.Shield.Rune.Reinforcing.Moderate",level:10,price:900,rarity:"common",traits:["magical"],hardness:{increase:3,max:13},maxHP:{increase:64,max:104}},4:{name:"PF2E.Item.Shield.Rune.Reinforcing.Greater",level:13,price:2500,rarity:"common",traits:["magical"],hardness:{increase:5,max:15},maxHP:{increase:80,max:120}},5:{name:"PF2E.Item.Shield.Rune.Reinforcing.Major",level:16,price:8e3,rarity:"common",traits:["magical"],hardness:{increase:5,max:17},maxHP:{increase:84,max:136}},6:{name:"PF2E.Item.Shield.Rune.Reinforcing.Supreme",level:19,price:32e3,rarity:"common",traits:["magical"],hardness:{increase:7,max:20},maxHP:{increase:108,max:160}}}},ARMOR_PROPERTY_RUNES={acidResistant:{name:"PF2E.ArmorPropertyRuneAcidResistant",level:8,price:420,rarity:"common",slug:"acidResistant",traits:["magical"]},advancing:{name:"PF2E.ArmorPropertyRuneAdvancing",level:9,price:625,rarity:"common",slug:"advancing",traits:["magical"]},aimAiding:{name:"PF2E.ArmorPropertyRuneAimAiding",level:6,price:225,rarity:"common",slug:"aimAiding",traits:["magical"]},antimagic:{name:"PF2E.ArmorPropertyRuneAntimagic",level:15,price:6500,rarity:"uncommon",slug:"antimagic",traits:["magical"]},assisting:{name:"PF2E.ArmorPropertyRuneAssisting",level:5,price:125,rarity:"common",slug:"assisting",traits:["magical"]},bitter:{name:"PF2E.ArmorPropertyRuneBitter",level:9,price:135,rarity:"uncommon",slug:"bitter",traits:["magical","poison"]},coldResistant:{name:"PF2E.ArmorPropertyRuneColdResistant",level:8,price:420,rarity:"common",slug:"coldResistant",traits:["magical"]},deathless:{name:"PF2E.ArmorPropertyRuneDeathless",level:7,price:330,rarity:"uncommon",slug:"deathless",traits:["healing","magical"]},electricityResistant:{name:"PF2E.ArmorPropertyRuneElectricityResistant",level:8,price:420,rarity:"common",slug:"electricityResistant",traits:["magical"]},energyAdaptive:{name:"PF2E.ArmorPropertyRuneEnergyAdaptive",level:13,price:2600,rarity:"common",slug:"energyAdaptive",traits:["magical"]},ethereal:{name:"PF2E.ArmorPropertyRuneEthereal",level:17,price:13500,rarity:"common",slug:"ethereal",traits:["magical"]},fireResistant:{name:"PF2E.ArmorPropertyRuneFireResistant",level:8,price:420,rarity:"common",slug:"fireResistant",traits:["magical"]},fortification:{name:"PF2E.ArmorPropertyRuneFortification",level:12,price:2e3,rarity:"common",slug:"fortification",traits:["magical"]},glamered:{name:"PF2E.ArmorPropertyRuneGlamered",level:5,price:140,rarity:"common",slug:"glamered",traits:["illusion","magical"]},gliding:{name:"PF2E.ArmorPropertyRuneGliding",level:8,price:450,rarity:"common",slug:"gliding",traits:["magical"]},greaterAcidResistant:{name:"PF2E.ArmorPropertyRuneGreaterAcidResistant",level:12,price:1650,rarity:"common",slug:"greaterAcidResistant",traits:["magical"]},greaterAdvancing:{name:"PF2E.ArmorPropertyRuneGreaterAdvancing",level:16,price:8e3,rarity:"common",slug:"greaterAdvancing",traits:["magical"]},greaterColdResistant:{name:"PF2E.ArmorPropertyRuneGreaterColdResistant",level:12,price:1650,rarity:"common",slug:"greaterColdResistant",traits:["magical"]},greaterDread:{name:"PF2E.ArmorPropertyRuneGreaterDread",level:18,price:21e3,rarity:"uncommon",slug:"greaterDread",traits:["emotion","fear","magical","mental","visual"]},greaterElectricityResistant:{name:"PF2E.ArmorPropertyRuneGreaterElectricityResistant",level:12,price:1650,rarity:"common",slug:"greaterElectricityResistant",traits:["magical"]},greaterFireResistant:{name:"PF2E.ArmorPropertyRuneGreaterFireResistant",level:12,price:1650,rarity:"common",slug:"greaterFireResistant",traits:["magical"]},greaterFortification:{name:"PF2E.ArmorPropertyRuneGreaterFortification",level:19,price:24e3,rarity:"common",slug:"greaterFortification",traits:["magical"]},greaterInvisibility:{name:"PF2E.ArmorPropertyRuneGreaterInvisibility",level:10,price:1e3,rarity:"common",slug:"greaterInvisibility",traits:["illusion","magical"]},greaterReady:{name:"PF2E.ArmorPropertyRuneGreaterReady",level:11,price:1200,rarity:"common",slug:"greaterReady",traits:["magical"]},greaterShadow:{name:"PF2E.ArmorPropertyRuneGreaterShadow",level:9,price:650,rarity:"common",slug:"greaterShadow",traits:["magical"]},greaterSlick:{name:"PF2E.ArmorPropertyRuneGreaterSlick",level:8,price:450,rarity:"common",slug:"greaterSlick",traits:["magical"]},greaterStanching:{name:"PF2E.ArmorPropertyRuneGreaterStanching",level:9,price:600,rarity:"uncommon",slug:"greaterStanching",traits:["magical"]},greaterQuenching:{name:"PF2E.ArmorPropertyRuneGreaterQuenching",level:10,price:1e3,rarity:"common",slug:"greaterQuenching",traits:["magical"]},greaterSwallowSpike:{name:"PF2E.ArmorPropertyRuneGreaterSwallowSpike",level:12,price:1750,rarity:"common",slug:"greaterSwallowSpike",traits:["magical"]},greaterWinged:{name:"PF2E.ArmorPropertyRuneGreaterWinged",level:19,price:35e3,rarity:"common",slug:"greaterWinged",traits:["magical"]},immovable:{name:"PF2E.ArmorPropertyRuneImmovable",level:12,price:1800,rarity:"uncommon",slug:"immovable",traits:["magical"]},implacable:{name:"PF2E.ArmorPropertyRuneImplacable",level:11,price:1200,rarity:"uncommon",slug:"implacable",traits:["magical"]},invisibility:{name:"PF2E.ArmorPropertyRuneInvisibility",level:8,price:500,rarity:"common",slug:"invisibility",traits:["illusion","magical"]},lesserDread:{name:"PF2E.ArmorPropertyRuneLesserDread",level:6,price:225,rarity:"uncommon",slug:"lesserDread",traits:["emotion","fear","magical","mental","visual"]},magnetizing:{name:"PF2E.ArmorPropertyRuneMagnetizing",level:10,price:900,rarity:"common",slug:"magnetizing",traits:["magical"]},majorQuenching:{name:"PF2E.ArmorPropertyRuneMajorQuenching",level:14,price:4500,rarity:"common",slug:"majorQuenching",traits:["magical"]},majorShadow:{name:"PF2E.ArmorPropertyRuneMajorShadow",level:17,price:14e3,rarity:"common",slug:"majorShadow",traits:["magical"]},majorSlick:{name:"PF2E.ArmorPropertyRuneMajorSlick",level:16,price:9e3,rarity:"common",slug:"majorSlick",traits:["magical"]},majorStanching:{name:"PF2E.ArmorPropertyRuneMajorStanching",level:13,price:2500,rarity:"uncommon",slug:"majorStanching",traits:["magical"]},majorSwallowSpike:{name:"PF2E.ArmorPropertyRuneMajorSwallowSpike",level:16,price:19250,rarity:"common",slug:"majorSwallowSpike",traits:["magical"]},malleable:{name:"PF2E.ArmorPropertyRuneMalleable",level:9,price:650,rarity:"common",slug:"malleable",traits:["magical","metal"]},misleading:{name:"PF2E.ArmorPropertyRuneMisleading",level:16,price:8e3,rarity:"common",slug:"misleading",traits:["illusion","magical"]},moderateDread:{name:"PF2E.ArmorPropertyRuneModerateDread",level:12,price:1800,rarity:"uncommon",slug:"moderateDread",traits:["emotion","fear","magical","mental","visual"]},portable:{name:"PF2E.ArmorPropertyRunePortable",level:9,price:660,rarity:"common",slug:"portable",traits:["magical"]},quenching:{name:"PF2E.ArmorPropertyRuneQuenching",level:6,price:250,rarity:"common",slug:"quenching",traits:["magical"]},raiment:{name:"PF2E.ArmorPropertyRuneRaiment",level:5,price:140,rarity:"common",slug:"raiment",traits:["illusion","magical"]},ready:{name:"PF2E.ArmorPropertyRuneReady",level:6,price:200,rarity:"common",slug:"ready",traits:["magical"]},rockBraced:{name:"PF2E.ArmorPropertyRuneRockBraced",level:13,price:3e3,rarity:"rare",slug:"rockBraced",traits:["dwarf","magical","saggorak"]},shadow:{name:"PF2E.ArmorPropertyRuneShadow",level:5,price:55,rarity:"common",slug:"shadow",traits:["magical"]},sinisterKnight:{name:"PF2E.ArmorPropertyRuneSinisterKnight",level:8,price:500,rarity:"uncommon",slug:"sinisterKnight",traits:["illusion","magical"]},sizeChanging:{name:"PF2E.ArmorPropertyRuneSizeChanging",level:7,price:350,rarity:"common",slug:"sizeChanging",traits:["magical"]},slick:{name:"PF2E.ArmorPropertyRuneSlick",level:5,price:45,rarity:"common",slug:"slick",traits:["magical"]},soaring:{name:"PF2E.ArmorPropertyRuneSoaring",level:14,price:3750,rarity:"common",slug:"soaring",traits:["magical"]},spellwatch:{name:"PF2E.ArmorPropertyRuneSpellwatch",level:13,price:3e3,rarity:"common",slug:"spellwatch",traits:["magical"]},stanching:{name:"PF2E.ArmorPropertyRuneStanching",level:5,price:130,rarity:"uncommon",slug:"stanching",traits:["magical"]},swallowSpike:{name:"PF2E.ArmorPropertyRuneSwallowSpike",level:6,price:200,rarity:"common",slug:"swallowSpike",traits:["magical"]},trueQuenching:{name:"PF2E.ArmorPropertyRuneTrueQuenching",level:18,price:24e3,rarity:"common",slug:"trueQuenching",traits:["magical"]},trueStanching:{name:"PF2E.ArmorPropertyRuneTrueStanching",level:17,price:12500,rarity:"uncommon",slug:"trueStanching",traits:["magical"]},winged:{name:"PF2E.ArmorPropertyRuneWinged",level:13,price:2500,rarity:"common",slug:"winged",traits:["magical"]}},WEAPON_PROPERTY_RUNES={ancestralEchoing:{level:15,name:"PF2E.WeaponPropertyRune.ancestralEchoing.Name",price:9500,rarity:"rare",slug:"ancestralEchoing",traits:["dwarf","magical","saggorak"]},anchoring:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.anchoring.Name",text:"PF2E.WeaponPropertyRune.anchoring.Note.criticalSuccess"}]},level:10,name:"PF2E.WeaponPropertyRune.anchoring.Name",price:900,rarity:"uncommon",slug:"anchoring",traits:["magical"]},ashen:{damage:{additional:[{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d4"}],notes:[{title:"PF2E.WeaponPropertyRune.ashen.Name",text:"PF2E.WeaponPropertyRune.ashen.Note.success"}]},level:9,name:"PF2E.WeaponPropertyRune.ashen.Name",price:700,rarity:"common",slug:"ashen",traits:["magical"]},astral:{level:8,name:"PF2E.WeaponPropertyRune.astral.Name",price:450,rarity:"common",slug:"astral",traits:["magical","spirit"],damage:{additional:[{damageType:"spirit",diceNumber:1,dieSize:"d6"}]}},authorized:{level:3,name:"PF2E.WeaponPropertyRune.authorized.Name",price:50,rarity:"common",slug:"authorized",traits:["magical"]},bane:{level:4,name:"PF2E.WeaponPropertyRune.bane.Name",price:100,rarity:"uncommon",slug:"bane",traits:["magical"]},bloodbane:{level:8,name:"PF2E.WeaponPropertyRune.bloodbane.Name",price:475,rarity:"uncommon",slug:"bloodbane",traits:["dwarf","magical"]},bloodthirsty:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.bloodbane.Name",text:"PF2E.WeaponPropertyRune.bloodthirsty.Note.criticalSuccess"}]},level:16,name:"PF2E.WeaponPropertyRune.bloodthirsty.Name",price:8500,rarity:"uncommon",slug:"bloodthirsty",traits:["magical"]},bolkasBlessing:{level:5,name:"PF2E.WeaponPropertyRune.bolkasBlessing.Name",price:160,rarity:"uncommon",slug:"bolkasBlessing",traits:["divine"]},brilliant:{damage:{additional:[{damageType:"fire",diceNumber:1,dieSize:"d4"},{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:["target:trait:fiend"]},{damageType:"vitality",diceNumber:1,dieSize:"d4",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.brilliant.Name",text:"PF2E.WeaponPropertyRune.brilliant.Note.criticalSuccess"}]},level:12,name:"PF2E.WeaponPropertyRune.brilliant.Name",price:2e3,rarity:"common",slug:"brilliant",traits:["magical"]},called:{level:7,name:"PF2E.WeaponPropertyRune.called.Name",price:350,rarity:"common",slug:"called",traits:["magical"]},coating:{level:9,name:"PF2E.WeaponPropertyRune.coating.Name",price:700,rarity:"common",slug:"coating",traits:["extradimensional","magical"]},conducting:{level:7,name:"PF2E.WeaponPropertyRune.conducting.Name",price:300,rarity:"common",slug:"conducting",traits:["magical"]},corrosive:{damage:{additional:[{damageType:"acid",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.corrosive.Name",text:"PF2E.WeaponPropertyRune.corrosive.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.corrosive.Name",price:500,rarity:"common",slug:"corrosive",traits:["acid","magical"]},crushing:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.crushing.Name",text:"PF2E.WeaponPropertyRune.crushing.Note.criticalSuccess"}]},level:3,name:"PF2E.WeaponPropertyRune.crushing.Name",price:50,rarity:"uncommon",slug:"crushing",traits:["magical"]},cunning:{level:5,name:"PF2E.WeaponPropertyRune.cunning.Name",price:140,rarity:"common",slug:"cunning",traits:["magical"]},dancing:{level:13,name:"PF2E.WeaponPropertyRune.dancing.Name",price:2700,rarity:"uncommon",slug:"dancing",traits:["magical"]},decaying:{damage:{additional:[{slug:"decaying",damageType:"void",diceNumber:1,dieSize:"d4"},{slug:"decaying-persistent",category:"persistent",damageType:"void",diceNumber:2,dieSize:"d4",critical:!0}]},level:8,name:"PF2E.WeaponPropertyRune.decaying.Name",price:500,rarity:"common",slug:"decaying",traits:["acid","magical","void"]},deathdrinking:{damage:{additional:[{slug:"deathdrinking-negative",damageType:"void",diceNumber:1,dieSize:"d6",critical:!0,predicate:["target:mode:living",{not:"target:negative-healing"}]},{slug:"deathdrinking-positive",damageType:"vitality",diceNumber:1,dieSize:"d6",critical:!0,predicate:["target:negative-healing"]}]},level:7,name:"PF2E.WeaponPropertyRune.deathdrinking.Name",price:360,rarity:"rare",slug:"deathdrinking",traits:["magical"]},demolishing:{damage:{additional:[{damageType:"force",category:"persistent",diceNumber:1,dieSize:"d6",predicate:["target:trait:construct"]}]},level:6,name:"PF2E.WeaponPropertyRune.demolishing.Name",price:225,rarity:"rare",slug:"demolishing",traits:["magical"]},disrupting:{damage:{additional:[{category:"persistent",damageType:"vitality",diceNumber:1,dieSize:"d6",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.disrupting.Name",text:"PF2E.WeaponPropertyRune.disrupting.Note.criticalSuccess",predicate:["target:negative-healing"]}]},level:5,name:"PF2E.WeaponPropertyRune.disrupting.Name",price:150,rarity:"common",slug:"disrupting",traits:["magical"]},earthbinding:{level:5,name:"PF2E.WeaponPropertyRune.earthbinding.Name",price:125,rarity:"common",slug:"earthbinding",traits:["magical"]},energizing:{level:6,name:"PF2E.WeaponPropertyRune.energizing.Name",price:250,rarity:"uncommon",slug:"energizing",traits:["magical"]},extending:{level:7,name:"PF2E.WeaponPropertyRune.extending.Name",price:700,rarity:"common",slug:"extending",traits:["magical"]},fanged:{level:2,name:"PF2E.WeaponPropertyRune.fanged.Name",price:30,rarity:"uncommon",slug:"fanged",traits:["magical"]},fearsome:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.fearsome.Name",text:"PF2E.WeaponPropertyRune.fearsome.Note.criticalSuccess"}]},level:5,name:"PF2E.WeaponPropertyRune.fearsome.Name",price:160,rarity:"common",slug:"fearsome",traits:["emotion","fear","magical","mental"]},flaming:{damage:{additional:[{damageType:"fire",diceNumber:1,dieSize:"d6"},{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d10",critical:!0}]},level:8,name:"PF2E.WeaponPropertyRune.flaming.Name",price:500,rarity:"common",slug:"flaming",traits:["fire","magical"]},flickering:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.flickering.Name",text:"PF2E.WeaponPropertyRune.flickering.Note.criticalSuccess"}]},level:6,name:"PF2E.WeaponPropertyRune.flickering.Name",price:250,rarity:"uncommon",slug:"flickering",traits:["illusion","magical"]},flurrying:{level:7,name:"PF2E.WeaponPropertyRune.flurrying.Name",price:360,rarity:"common",slug:"flurrying",traits:["magical"]},frost:{damage:{additional:[{damageType:"cold",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.frost.Name",text:"PF2E.WeaponPropertyRune.frost.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.frost.Name",price:500,rarity:"common",slug:"frost",traits:["cold","magical"]},ghostTouch:{level:4,name:"PF2E.WeaponPropertyRune.ghostTouch.Name",price:75,rarity:"common",slug:"ghostTouch",traits:["magical"]},giantKilling:{damage:{additional:[{slug:"giantKilling",damageType:"mental",diceNumber:1,dieSize:"d6",predicate:["target:trait:giant"]}],notes:[{outcome:["criticalSuccess"],predicate:["target:trait:giant"],title:"PF2E.WeaponPropertyRune.giantKilling.Name",text:"PF2E.WeaponPropertyRune.giantKilling.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.giantKilling.Name",price:450,rarity:"rare",slug:"giantKilling",traits:["magical"]},greaterAnchoring:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",text:"PF2E.WeaponPropertyRune.greaterAnchoring.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",text:"PF2E.WeaponPropertyRune.greaterAnchoring.Note.success"}]},level:18,name:"PF2E.WeaponPropertyRune.greaterAnchoring.Name",price:22e3,rarity:"uncommon",slug:"greaterAnchoring",traits:["magical"]},greaterAshen:{damage:{additional:[{damageType:"fire",category:"persistent",diceNumber:1,dieSize:"d8"}],notes:[{title:"PF2E.WeaponPropertyRune.greaterAshen.Name",text:"PF2E.WeaponPropertyRune.greaterAshen.Note.success"}]},level:16,name:"PF2E.WeaponPropertyRune.greaterAshen.Name",price:9e3,rarity:"common",slug:"greaterAshen",traits:["magical"]},greaterAstral:{level:15,name:"PF2E.WeaponPropertyRune.greaterAstral.Name",price:6e3,rarity:"common",slug:"greaterAstral",traits:["magical","spirit"],damage:{additional:[{damageType:"spirit",diceNumber:1,dieSize:"d6"}],ignoredResistances:[{type:"spirit",max:1/0}]}},greaterBloodbane:{level:13,name:"PF2E.WeaponPropertyRune.greaterBloodbane.Name",price:2800,rarity:"uncommon",slug:"greaterBloodbane",traits:["dwarf","magical"]},greaterBolkasBlessing:{level:11,name:"PF2E.WeaponPropertyRune.greaterBolkasBlessing.Name",price:1400,rarity:"uncommon",slug:"greaterBolkasBlessing",traits:["divine"]},greaterBrilliant:{damage:{additional:[{damageType:"fire",diceNumber:1,dieSize:"d4"},{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:["target:trait:fiend"]},{damageType:"vitality",diceNumber:1,dieSize:"d4",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",text:"PF2E.WeaponPropertyRune.greaterBrilliant.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",text:"PF2E.WeaponPropertyRune.greaterBrilliant.Note.success"}],ignoredResistances:[{type:"fire",max:1/0},{type:"spirit",max:1/0},{type:"vitality",max:1/0}]},level:18,name:"PF2E.WeaponPropertyRune.greaterBrilliant.Name",price:24e3,rarity:"common",slug:"greaterBrilliant",traits:["magical"]},greaterCorrosive:{damage:{additional:[{damageType:"acid",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",text:"PF2E.WeaponPropertyRune.greaterCorrosive.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",text:"PF2E.WeaponPropertyRune.greaterCorrosive.Note.success"}],ignoredResistances:[{type:"acid",max:1/0}]},level:15,name:"PF2E.WeaponPropertyRune.greaterCorrosive.Name",price:6500,rarity:"common",slug:"greaterCorrosive",traits:["acid","magical"]},greaterCrushing:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterCrushing.Name",text:"PF2E.WeaponPropertyRune.greaterCrushing.Note.criticalSuccess"}]},level:9,name:"PF2E.WeaponPropertyRune.greaterCrushing.Name",price:650,rarity:"uncommon",slug:"greaterCrushing",traits:["magical"]},greaterDecaying:{damage:{additional:[{slug:"decaying",damageType:"void",diceNumber:1,dieSize:"d4"},{slug:"decaying-persistent",category:"persistent",damageType:"void",diceNumber:4,dieSize:"d4",critical:!0}],ignoredResistances:[{type:"void",max:1/0}]},level:15,name:"PF2E.WeaponPropertyRune.greaterDecaying.Name",price:6500,rarity:"common",slug:"greaterDecaying",traits:["acid","magical","void"]},greaterDisrupting:{damage:{additional:[{category:"persistent",damageType:"vitality",diceNumber:2,dieSize:"d6",predicate:["target:negative-healing"]}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterDisrupting.Name",text:"PF2E.WeaponPropertyRune.greaterDisrupting.Note.criticalSuccess",predicate:["target:negative-healing"]}]},level:14,name:"PF2E.WeaponPropertyRune.greaterDisrupting.Name",price:4300,rarity:"uncommon",slug:"greaterDisrupting",traits:["magical"]},greaterExtending:{level:13,name:"PF2E.WeaponPropertyRune.greaterExtending.Name",price:3e3,rarity:"common",slug:"greaterExtending",traits:["magical"]},greaterFanged:{level:8,name:"PF2E.WeaponPropertyRune.greaterFanged.Name",price:425,rarity:"uncommon",slug:"greaterFanged",traits:["magical"]},greaterFearsome:{damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFearsome.Name",text:"PF2E.WeaponPropertyRune.greaterFearsome.Note.criticalSuccess"}]},level:12,name:"PF2E.WeaponPropertyRune.greaterFearsome.Name",price:2e3,rarity:"common",slug:"greaterFearsome",traits:["emotion","fear","magical","mental"]},greaterFlaming:{damage:{additional:[{damageType:"fire",diceNumber:1,dieSize:"d6"},{damageType:"fire",category:"persistent",diceNumber:2,dieSize:"d10",critical:!0}],ignoredResistances:[{type:"fire",max:1/0}]},level:15,name:"PF2E.WeaponPropertyRune.greaterFlaming.Name",price:6500,rarity:"common",slug:"greaterFlaming",traits:["fire","magical"]},greaterFrost:{damage:{additional:[{damageType:"cold",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterFrost.Name",text:"PF2E.WeaponPropertyRune.greaterFrost.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterFrost.Name",text:"PF2E.WeaponPropertyRune.greaterFrost.Note.success"}],ignoredResistances:[{type:"cold",max:1/0}]},level:15,name:"PF2E.WeaponPropertyRune.greaterFrost.Name",price:6500,rarity:"common",slug:"greaterFrost",traits:["cold","magical"]},greaterGiantKilling:{damage:{additional:[{slug:"greaterGiantKilling",damageType:"mental",diceNumber:2,dieSize:"d6",predicate:["target:trait:giant"]}],ignoredResistances:[{type:"mental",max:1/0}],notes:[{outcome:["criticalSuccess"],predicate:["target:trait:giant"],title:"PF2E.WeaponPropertyRune.greaterGiantKilling.Name",text:"PF2E.WeaponPropertyRune.greaterGiantKilling.Note.criticalSuccess"}]},level:15,name:"PF2E.WeaponPropertyRune.greaterGiantKilling.Name",price:6e3,rarity:"rare",slug:"greaterGiantKilling",traits:["magical"]},greaterHauling:{level:11,name:"PF2E.WeaponPropertyRune.greaterHauling.Name",price:1300,rarity:"uncommon",slug:"greaterHauling",traits:["magical"]},greaterImpactful:{damage:{additional:[{damageType:"force",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterImpactful.Name",text:"PF2E.WeaponPropertyRune.greaterImpactful.Note.criticalSuccess"}]},level:17,name:"PF2E.WeaponPropertyRune.greaterImpactful.Name",price:15e3,rarity:"common",slug:"greaterImpactful",traits:["force","magical"]},greaterKolssOath:{level:11,name:"PF2E.WeaponPropertyRune.greaterKolssOath.Name",price:1400,rarity:"uncommon",slug:"greaterKolssOath",traits:["divine"]},greaterRooting:{level:11,name:"PF2E.WeaponPropertyRune.greaterRooting.Name",price:1400,rarity:"common",slug:"greaterRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterRooting.Name",text:"PF2E.WeaponPropertyRune.greaterRooting.Note.criticalSuccess"}]}},greaterShock:{damage:{additional:[{damageType:"electricity",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterShock.Name",text:"PF2E.WeaponPropertyRune.greaterShock.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterShock.Name",text:"PF2E.WeaponPropertyRune.greaterShock.Note.success"}],ignoredResistances:[{type:"electricity",max:1/0}]},level:15,name:"PF2E.WeaponPropertyRune.greaterShock.Name",price:6500,rarity:"common",slug:"greaterShock",traits:["electricity","magical"]},greaterThundering:{damage:{additional:[{damageType:"sonic",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.greaterThundering.Name",text:"PF2E.WeaponPropertyRune.greaterThundering.Note.criticalSuccess"},{outcome:["success"],title:"PF2E.WeaponPropertyRune.greaterThundering.Name",text:"PF2E.WeaponPropertyRune.greaterThundering.Note.success"}],ignoredResistances:[{type:"sonic",max:1/0}]},level:15,name:"PF2E.WeaponPropertyRune.greaterThundering.Name",price:6500,rarity:"common",slug:"greaterThundering",traits:["magical","sonic"]},greaterTruddsStrength:{level:11,name:"PF2E.WeaponPropertyRune.greaterTruddsStrength.Name",price:1400,rarity:"uncommon",slug:"greaterTruddsStrength",traits:["divine"]},grievous:{damage:{additional:[{damageType:"bleed",diceNumber:1,dieSize:"d6",critical:!0,predicate:["critical-specialization","item:group:dart"]}],notes:[{outcome:["criticalSuccess"],predicate:["item:group:axe"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Axe"},{outcome:["criticalSuccess"],predicate:["item:group:bow"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Bow"},{outcome:["criticalSuccess"],predicate:[{or:["item:group:brawling","item:group:firearm"]}],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Brawling"},{outcome:["criticalSuccess"],predicate:["item:group:club"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Club"},{outcome:["criticalSuccess"],predicate:["item:group:crossbow"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Crossbow"},{outcome:["criticalSuccess"],predicate:["item:group:flail"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Flail"},{outcome:["criticalSuccess"],predicate:["item:group:hammer"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Hammer"},{outcome:["criticalSuccess"],predicate:["item:group:knife"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Knife"},{outcome:["criticalSuccess"],predicate:["item:group:polearm"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Polearm"},{outcome:["criticalSuccess"],predicate:["item:group:shield"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Shield"},{outcome:["criticalSuccess"],predicate:["item:group:sling"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Sling"},{outcome:["criticalSuccess"],predicate:["item:group:spear"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Spear"},{outcome:["criticalSuccess"],predicate:["item:group:sword"],title:"PF2E.WeaponPropertyRune.grievous.Name",text:"PF2E.WeaponPropertyRune.grievous.Note.Sword"}],adjustments:[{slug:"critical-specialization",test:__name2(options=>new Predicate("item:group:pick").test(options),"test"),getNewValue:__name2(current=>current*2,"getNewValue")}]},level:9,name:"PF2E.WeaponPropertyRune.grievous.Name",price:700,rarity:"common",slug:"grievous",traits:["magical"]},hauling:{level:6,name:"PF2E.WeaponPropertyRune.hauling.Name",price:225,rarity:"uncommon",slug:"hauling",traits:["magical"]},holy:{level:11,name:"PF2E.WeaponPropertyRune.holy.Name",price:1400,rarity:"common",slug:"holy",traits:["holy","magical"],damage:{additional:[{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:[{not:"target:trait:unholy"}]},{damageType:"spirit",diceNumber:2,dieSize:"d4",predicate:["target:trait:unholy"]}]},strikeAdjustments:[{adjustTraits:__name2((_weapon,traits)=>{traits.includes("holy")||traits.push("holy")},"adjustTraits")}]},hopeful:{attack:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.hopeful.Name",text:"PF2E.WeaponPropertyRune.hopeful.Note.criticalSuccess"}]},level:11,name:"PF2E.WeaponPropertyRune.hopeful.Name",price:1200,rarity:"uncommon",slug:"hopeful",traits:["magical"]},hooked:{level:5,name:"PF2E.WeaponPropertyRune.hooked.Name",price:140,rarity:"rare",slug:"hooked",traits:["magical"],strikeAdjustments:[{adjustWeapon:__name2(weapon=>{weapon.system.traits.value.includes("trip")||weapon.system.traits.value.push("trip")},"adjustWeapon")}]},impactful:{damage:{additional:[{damageType:"force",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.impactful.Name",text:"PF2E.WeaponPropertyRune.impactful.Note.criticalSuccess"}]},level:10,name:"PF2E.WeaponPropertyRune.impactful.Name",price:1e3,rarity:"common",slug:"impactful",traits:["force","magical"]},impossible:{level:20,name:"PF2E.WeaponPropertyRune.impossible.Name",price:7e4,rarity:"common",slug:"impossible",traits:["magical"],strikeAdjustments:[{adjustWeapon:__name2(weapon=>{if(weapon.isOfType("weapon")&&weapon.system.range&&weapon._source.system.range){const sourceRange=weapon._source.system.range,preparedRange=weapon.system.range;weapon.system.range=sourceRange*2+Math.abs(preparedRange-sourceRange)}},"adjustWeapon")}]},keen:{attack:{dosAdjustments:[{adjustments:{success:{label:"PF2E.WeaponPropertyRune.keen.Name",amount:"criticalSuccess"}},predicate:new Predicate(["check:total:natural:19",{or:["item:damage:type:slashing","item:damage:type:piercing"]}])}]},level:13,name:"PF2E.WeaponPropertyRune.keen.Name",price:3e3,rarity:"uncommon",slug:"keen",traits:["magical"]},kinWarding:{level:3,name:"PF2E.WeaponPropertyRune.kinWarding.Name",price:52,rarity:"uncommon",slug:"kinWarding",traits:["dwarf","magical"]},kolssOath:{level:5,name:"PF2E.WeaponPropertyRune.kolssOath.Name",price:160,rarity:"uncommon",slug:"kolssOath",traits:["divine"]},majorFanged:{level:15,name:"PF2E.WeaponPropertyRune.majorFanged.Name",price:6e3,rarity:"uncommon",slug:"majorFanged",traits:["magical"]},majorRooting:{level:15,name:"PF2E.WeaponPropertyRune.majorRooting.Name",price:6500,rarity:"common",slug:"majorRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.majorRooting.Name",text:"PF2E.WeaponPropertyRune.majorRooting.Note.criticalSuccess"}]}},merciful:{strikeAdjustments:[{adjustWeapon:__name2(weapon=>{weapon.system.traits.value.includes("nonlethal")||weapon.system.traits.value.push("nonlethal")},"adjustWeapon")}],level:4,name:"PF2E.WeaponPropertyRune.merciful.Name",price:70,rarity:"common",slug:"merciful",traits:["magical","mental"]},nightmare:{damage:{additional:[{damageType:"mental",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.nightmare.Name",text:"PF2E.WeaponPropertyRune.nightmare.Note.criticalSuccess"}]},level:9,name:"PF2E.WeaponPropertyRune.nightmare.Name",price:250,rarity:"uncommon",slug:"nightmare",traits:["magical"]},pacifying:{level:5,name:"PF2E.WeaponPropertyRune.pacifying.Name",price:150,rarity:"uncommon",slug:"pacifying",traits:["magical"]},returning:{attack:{notes:[{title:"PF2E.WeaponPropertyRune.returning.Name",text:"PF2E.WeaponPropertyRune.returning.Note"}]},level:3,name:"PF2E.WeaponPropertyRune.returning.Name",price:55,rarity:"common",slug:"returning",traits:["magical"]},rooting:{level:7,name:"PF2E.WeaponPropertyRune.rooting.Name",price:360,rarity:"common",slug:"rooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.rooting.Name",text:"PF2E.WeaponPropertyRune.rooting.Note.criticalSuccess"}]}},serrating:{damage:{additional:[{damageType:"slashing",diceNumber:1,dieSize:"d4"}]},level:10,name:"PF2E.WeaponPropertyRune.serrating.Name",price:1e3,rarity:"uncommon",slug:"serrating",traits:["magical"]},shifting:{level:6,name:"PF2E.WeaponPropertyRune.shifting.Name",price:225,rarity:"common",slug:"shifting",traits:["magical"]},shock:{damage:{additional:[{damageType:"electricity",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.shock.Name",text:"PF2E.WeaponPropertyRune.shock.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.shock.Name",price:500,rarity:"common",slug:"shock",traits:["electricity","magical"]},shockwave:{damage:{additional:[{damageCategory:"splash",damageType:"bludgeoning",label:"PF2E.WeaponPropertyRune.shockwave.Name",modifier:"@item.baseDamage.dice",predicate:["item:melee","item:damage:type:bludgeoning"]}],notes:[{outcome:["success","criticalSuccess"],predicate:["item:melee","item:damage:type:bludgeoning"],title:"PF2E.WeaponPropertyRune.shockwave.Name",text:"PF2E.WeaponPropertyRune.shockwave.Note"}]},level:13,name:"PF2E.WeaponPropertyRune.shockwave.Name",price:3e3,rarity:"common",slug:"shockwave",traits:["electricity","magical"]},speed:{level:16,name:"PF2E.WeaponPropertyRune.speed.Name",price:1e4,rarity:"rare",slug:"speed",traits:["magical"]},spellStoring:{level:13,name:"PF2E.WeaponPropertyRune.spellStoring.Name",price:2700,rarity:"uncommon",slug:"spellStoring",traits:["magical"]},swarming:{level:9,name:"PF2E.WeaponPropertyRune.swarming.Name",price:700,rarity:"common",slug:"swarming",traits:["magical"]},thundering:{damage:{additional:[{damageType:"sonic",diceNumber:1,dieSize:"d6"}],notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.thundering.Name",text:"PF2E.WeaponPropertyRune.thundering.Note.criticalSuccess"}]},level:8,name:"PF2E.WeaponPropertyRune.thundering.Name",price:500,rarity:"common",slug:"thundering",traits:["magical","sonic"]},truddsStrength:{level:5,name:"PF2E.WeaponPropertyRune.truddsStrength.Name",price:160,rarity:"uncommon",slug:"truddsStrength",traits:["divine"]},trueRooting:{level:19,name:"PF2E.WeaponPropertyRune.trueRooting.Name",price:4e4,rarity:"common",slug:"trueRooting",traits:["plant","magical","wood"],damage:{notes:[{outcome:["criticalSuccess"],title:"PF2E.WeaponPropertyRune.trueRooting.Name",text:"PF2E.WeaponPropertyRune.trueRooting.Note.criticalSuccess"}]}},underwater:{level:3,name:"PF2E.WeaponPropertyRune.underwater.Name",price:50,rarity:"common",slug:"underwater",traits:["magical","water"]},unholy:{level:11,name:"PF2E.WeaponPropertyRune.unholy.Name",price:1400,rarity:"common",slug:"unholy",traits:["unholy","magical"],damage:{additional:[{damageType:"spirit",diceNumber:1,dieSize:"d4",predicate:[{not:"target:trait:holy"}]},{damageType:"spirit",diceNumber:2,dieSize:"d4",predicate:["target:trait:holy"]}]},strikeAdjustments:[{adjustTraits:__name2((_weapon,traits)=>{traits.includes("unholy")||traits.push("unholy")},"adjustTraits")}]},vorpal:{level:17,name:"PF2E.WeaponPropertyRune.vorpal.Name",price:15e3,rarity:"rare",slug:"vorpal",traits:["magical"]},wounding:{damage:{additional:[{damageType:"bleed",diceNumber:1,dieSize:"d6"}]},level:7,name:"PF2E.WeaponPropertyRune.wounding.Name",price:340,rarity:"common",slug:"wounding",traits:["magical"]}},RUNE_DATA={armor:{...FUNDAMENTAL_ARMOR_RUNE_DATA,property:ARMOR_PROPERTY_RUNES},shield:FUNDAMENTAL_SHIELD_RUNE_DATA,weapon:{...FUNDAMENTAL_WEAPON_RUNE_DATA,property:WEAPON_PROPERTY_RUNES}};class MigrationRunnerBase{static{__name(this,"MigrationRunnerBase")}static{__name2(this,"MigrationRunnerBase")}migrations;static LATEST_SCHEMA_VERSION=.953;static MINIMUM_SAFE_VERSION=.7;static RECOMMENDED_SAFE_VERSION=.84;static FOUNDRY_SCHEMA_VERSIONS={.8:.634,9:.7,10:.781,11:.841,12:.927,13:.936};constructor(migrations=[]){this.migrations=migrations.sort((a,b)=>a.version-b.version)}needsMigration(currentVersion){return currentVersion<this.constructor.LATEST_SCHEMA_VERSION}diffCollection(orig,updated){const diffs={inserted:[],deleted:[],updated:[]},origSources=new Map;for(const source2 of orig)origSources.set(source2._id,source2);for(const source2 of updated){const origSource=origSources.get(source2._id);origSource?(JSON.stringify(origSource)!==JSON.stringify(source2)&&diffs.updated.push(source2),origSources.delete(source2._id)):diffs.inserted.push(source2)}for(const source2 of origSources.values())diffs.deleted.push(source2._id);return diffs}async getUpdatedActor(actor,migrations){const currentActor=foundry.utils.deepClone(actor);for(const migration of migrations)for(const currentItem of currentActor.items)if(await migration.preUpdateItem?.(currentItem,currentActor),currentItem.type==="consumable"&&currentItem.system.spell&&await migration.preUpdateItem?.(currentItem.system.spell),itemIsOfType(currentItem,"armor","equipment","shield","weapon"))for(const subitem of currentItem.system.subitems)migration.preUpdateItem?.(subitem);for(const migration of migrations){await migration.updateActor?.(currentActor);for(const currentItem of currentActor.items)if(await migration.updateItem?.(currentItem,currentActor),currentItem.type==="consumable"&&currentItem.system.spell&&await migration.updateItem?.(currentItem.system.spell,currentActor),itemIsOfType(currentItem,"armor","equipment","shield","weapon"))for(const subitem of currentItem.system.subitems)migration.updateItem?.(subitem)}if("game"in globalThis){const latestMigration=migrations.slice(-1)[0];currentActor.system._migration??={version:null,previous:null},this.#updateMigrationRecord(currentActor.system._migration,latestMigration);for(const itemSource of currentActor.items)itemSource.system._migration??={version:null,previous:null},this.#updateMigrationRecord(itemSource.system._migration,latestMigration)}return currentActor}async getUpdatedItem(item,migrations){const current=foundry.utils.deepClone(item);for(const migration of migrations)if(await migration.preUpdateItem?.(current),current.type==="consumable"&&current.system.spell&&await migration.preUpdateItem?.(current.system.spell),itemIsOfType(current,"armor","equipment","shield","weapon"))for(const subitem of current.system.subitems)migration.preUpdateItem?.(subitem);for(const migration of migrations)if(await migration.updateItem?.(current),current.type==="consumable"&&current.system.spell&&await migration.updateItem?.(current.system.spell),itemIsOfType(current,"armor","equipment","shield","weapon"))for(const subitem of current.system.subitems)migration.updateItem?.(subitem);return migrations.length>0&&this.#updateMigrationRecord(current.system._migration,migrations.slice(-1)[0]),current}async getUpdatedTable(tableSource,migrations){const current=foundry.utils.deepClone(tableSource);for(const migration of migrations)try{await migration.updateTable?.(current)}catch(err){console.error(err)}return current}async getUpdatedMacro(macroSource,migrations){const current=foundry.utils.deepClone(macroSource);for(const migration of migrations)try{await migration.updateMacro?.(current)}catch(err){console.error(err)}return current}async getUpdatedJournalEntry(source2,migrations){const clone=foundry.utils.deepClone(source2);for(const migration of migrations)try{await migration.updateJournalEntry?.(clone)}catch(err){console.error(err)}return clone}async getUpdatedToken(token,migrations){const current=token.toObject();for(const migration of migrations)await migration.updateToken?.(current,token.actor,token.scene);return current}async getUpdatedUser(userData,migrations){const current=foundry.utils.deepClone(userData);for(const migration of migrations)try{await migration.updateUser?.(current)}catch(err){console.error(err)}return current}#updateMigrationRecord(migrations,latestMigration){if(!("game"in globalThis&&latestMigration))return;const fromVersion=typeof migrations.version=="number"?migrations.version:null;migrations.version=latestMigration.version,migrations.previous={schema:fromVersion,foundry:game.version,system:game.system.version}}}class Progress{static{__name(this,"Progress")}static{__name2(this,"Progress")}value=0;max;label;notification;constructor({max,label=""}){this.max=max,this.label=label,this.notification=ui.notifications.info(this.label,{progress:!0})}advance({by=1,label=this.label}={}){this.value!==this.max&&(this.value+=Math.abs(by),this.notification.update({message:label,pct:this.value/this.max}))}close({label=""}={}){this.notification.update({message:label,pct:1})}}class MigrationRunner extends MigrationRunnerBase{static{__name(this,"MigrationRunner")}static{__name2(this,"MigrationRunner")}needsMigration(){return super.needsMigration(game.settings.get("pf2e","worldSchemaVersion"))}static async ensureSchemaVersion(document2,migrations){if(migrations.length===0)return;const currentVersion=this.LATEST_SCHEMA_VERSION;if((Number(document2.schemaVersion)||0)<currentVersion){const runner=new this(migrations),source2=document2._source,updated=await(async()=>{try{return"items"in source2?await runner.getUpdatedActor(source2,runner.migrations):await runner.getUpdatedItem(source2,runner.migrations)}catch{return null}})();if(updated){if("items"in updated&&"items"in document2._source){for(const updatedItem of updated.items)updatedItem._id??=foundry.utils.randomID();const itemSources=document2._source.items;for(const itemSource of[...itemSources])updated.items.some(i=>i._id===itemSource._id)||itemSources.splice(itemSources.indexOf(itemSource),1)}document2.updateSource(updated)}}if(document2.updateSource({"system._migration.version":currentVersion}),"items"in document2&&"prototypeToken"in document2)for(const item of document2.items)item.schemaVersion||item.updateSource({"system._migration.version":currentVersion})}async#migrateDocuments(collection,migrations,progress){const DocumentClass=collection.documentClass,pack="metadata"in collection?collection.metadata.id:null,updateGroup=[];for(const document2 of collection.contents.sort(a=>a.type==="familiar"?1:-1)){if(updateGroup.length===100)try{await DocumentClass.updateDocuments(updateGroup,{noHook:!0,pack}),progress?.advance({by:updateGroup.length})}catch(error){console.warn(error)}finally{updateGroup.length=0}const updated="prototypeToken"in document2?await this.#migrateActor(migrations,document2,{pack}):await this.#migrateItem(migrations,document2);updated&&updateGroup.push(updated)}if(updateGroup.length>0)try{await DocumentClass.updateDocuments(updateGroup,{noHook:!0,pack}),progress?.advance({by:updateGroup.length})}catch(error){console.warn(error)}}#removeSpecialKeys(data){if(Array.isArray(data))for(const value of data)this.#removeSpecialKeys(value);else if(e$2(data))for(const key of Object.keys(data))key.startsWith("-=")?delete data[key]:this.#removeSpecialKeys(data[key]);return data}async#migrateItem(migrations,item){const baseItem=this.#removeSpecialKeys(item.toObject());try{return await this.getUpdatedItem(baseItem,migrations)}catch(error){return ui.notifications.error(`Error thrown while migrating ${item.name} (${item.uuid})`),console.error(error),null}}async#migrateActor(migrations,actor,options={}){const pack=options.pack,baseActor=this.#removeSpecialKeys(actor.toObject()),updatedActor=await(async()=>{try{return await this.getUpdatedActor(baseActor,migrations)}catch(error){return error instanceof Error&&console.error(`Error thrown while migrating ${actor.uuid}: ${error.message}`),null}})();if(!updatedActor)return null;actor._source.effects.some(e2=>e2.statuses.some(s=>s!=="dead"))&&await actor.deleteEmbeddedDocuments("ActiveEffect",[],{deleteAll:!0});const baseItems=[...baseActor.items],updatedItems=[...updatedActor.items],itemDiff=this.diffCollection(baseItems,updatedItems),finalDeleted=itemDiff.deleted.filter(id=>actor.items.has(id));if(finalDeleted.length>0)try{await actor.deleteEmbeddedDocuments("Item",finalDeleted,{noHook:!0,pack})}catch(error){console.warn(error)}const finalUpdated=itemDiff.updated.filter(i=>actor.items.has(i._id));return updatedActor.items=[...itemDiff.inserted,...finalUpdated],updatedActor}async#migrateWorldJournalEntry(journalEntry,migrations){if(migrations.some(migration=>!!migration.updateJournalEntry))try{const updated=await this.getUpdatedJournalEntry(journalEntry.toObject(),migrations),changes=foundry.utils.diffObject(journalEntry.toObject(),updated);Object.keys(changes).length>0&&await journalEntry.update(changes,{noHook:!0})}catch(error){console.warn(error)}}async#migrateWorldMacro(macro,migrations){if(migrations.some(migration=>!!migration.updateMacro))try{const updatedMacro=await this.getUpdatedMacro(macro.toObject(),migrations),changes=foundry.utils.diffObject(macro.toObject(),updatedMacro);Object.keys(changes).length>0&&await macro.update(changes,{noHook:!0})}catch(error){console.warn(error)}}async#migrateWorldTable(table,migrations){if(migrations.some(migration=>!!migration.updateTable))try{const updatedMacro=await this.getUpdatedTable(table.toObject(),migrations),changes=foundry.utils.diffObject(table.toObject(),updatedMacro);Object.keys(changes).length>0&&table.update(changes,{noHook:!0})}catch(error){console.warn(error)}}async#migrateSceneToken(token,migrations){if(!migrations.some(migration=>!!migration.updateToken))return token.toObject();try{const updatedToken=await this.getUpdatedToken(token,migrations),changes=foundry.utils.diffObject(token.toObject(),updatedToken);if(Object.keys(changes).length>0)try{await token.update(changes,{noHook:!0})}catch(error){console.warn(error)}return updatedToken}catch(error){return console.error(error),null}}async#migrateUser(user,migrations){if(migrations.some(migration=>!!migration.updateUser))try{const baseUser=user.toObject(),updatedUser=await this.getUpdatedUser(baseUser,migrations),changes=foundry.utils.diffObject(user.toObject(),updatedUser);Object.keys(changes).length>0&&await user.update(changes,{noHook:!0})}catch(error){console.error(error)}}async runCompendiumMigration(compendium){const pack=compendium.metadata.id;ui.notifications.info(game.i18n.format("PF2E.Migrations.Starting",{version:game.system.version}));const documents=await compendium.getDocuments();await compendium.documentClass.updateDocuments(documents.map(d=>d.toObject()),{diff:!1,recursive:!1,pack}),ui.notifications.info(game.i18n.format("PF2E.Migrations.Finished",{version:game.system.version}))}async runMigrations(migrations){if(migrations.length===0)return;const progress=new Progress({label:game.i18n.localize("PF2E.Migrations.Running"),max:game.actors.size+game.items.size+game.scenes.contents.flatMap(s=>s.tokens.contents).filter(t2=>!t2.actorLink).length});await this.#migrateDocuments(game.actors,migrations,progress),await this.#migrateDocuments(game.items,migrations,progress);for(const entry of game.journal)await this.#migrateWorldJournalEntry(entry,migrations);const promises=[];for(const macro of game.macros)promises.push(this.#migrateWorldMacro(macro,migrations));for(const table of game.tables)promises.push(this.#migrateWorldTable(table,migrations));for(const user of game.users)promises.push(this.#migrateUser(user,migrations));for(const migration of migrations)migration.migrate&&promises.push(migration.migrate());await Promise.allSettled(promises);for(const scene of game.scenes)for(const token of scene.tokens){const{actor}=token;if(!actor||!!!await this.#migrateSceneToken(token,migrations))continue;const deltaSource=token.delta?._source,hasMigratableData=!!deltaSource&&!!deltaSource.flags?.pf2e||((deltaSource??{}).items??[]).length>0||Object.keys(deltaSource?.system??{}).length>0;if(actor.isToken){if(hasMigratableData){const updated=await this.#migrateActor(migrations,actor);if(updated)try{await actor.update(updated,{noHook:!0})}catch(error){console.warn(error)}}progress.advance()}}progress.value<progress.max&&progress.close()}async runMigration(force=!1){const schemaVersion={latest:MigrationRunner.LATEST_SCHEMA_VERSION,current:game.settings.get("pf2e","worldSchemaVersion")},systemVersion=game.system.version;ui.notifications.info(game.i18n.format("PF2E.Migrations.Starting",{version:systemVersion}));const migrationsToRun=force?this.migrations:this.migrations.filter(x=>schemaVersion.current<x.version),migrationPhases=[[]];for(const migration of migrationsToRun)migrationPhases[migrationPhases.length-1].push(migration),migration.requiresFlush&&migrationPhases.push([]);for(const migrationPhase of migrationPhases)migrationPhase.length>0&&await this.runMigrations(migrationPhase);await game.settings.set("pf2e","worldSchemaVersion",schemaVersion.latest)}}class MigrationBase{static{__name(this,"MigrationBase")}static{__name2(this,"MigrationBase")}static version;version=this.constructor.version;requiresFlush=!1}class Migration700SingleClassFeatures extends MigrationBase{static{__name(this,"Migration700SingleClassFeatures")}static{__name2(this,"Migration700SingleClassFeatures")}static version=.7;itemIds={alertness:["D8CSi8c9XiRpVc5M","OZaJz4exCoz6vuuv","qJ4fwGpoNC36ZQ8I","2o1Cj7hDayDlslqY","TAIOtk5VvPZvv4nu"],"armor-expertise":["x5jaCJxsmD5sx3KB","fRifyINZF5SKDfib"],"armor-mastery":["CGB1TczFhQhdQxml","IPDwS5pTgU3Cq6Nl"],evasion:["MV6XIuAgN9uSA0Da","EZuWfYSv3ASLyKtu","DqWr3LqUpT3Xi2xq"],"expert-spellcaster":["cD3nSupdCvONuHiE","mdzk070ixIDpid7V"],"great-fortitude":["F57Na5VxfBp56kke","25GSAotUcDwInYgG"],"improved-evasion":["L5D0NwFXdLiVSnk5","6XwGONPdr9SFDtDc"],"incredible-senses":["nLwPMPLRne1HnL00","iyb5FU2BpsCCan8Q","kktZhQPJgC5F4hgU"],"iron-will":["wMyDcVNmA7xGK83S","JVCxv4HuLaaFhAf4"],juggernaut:["OMZs5y16jZRW9KQK","sHCFQZM0xHCOYOId","Ba97T4anGhizfaCt","pzTRQxuoNOeWAalC","ojB0UJWpSekQPjT7"],"lightning-reflexes":["TUOeATt52P43r5W0","rz87RgR1crWTd7j5","Xqd0vrxq2bLXxdaB","tfugXJHITCnArN1b","7PzcKaDGy6tIkQh4","EJzjY6AIsTYqW0ee"],"magical-fortitude":["70jqXP2eS4tRZ0Ok","MzyPNlxrNA5OKVd7"],"master-spellcaster":["l1InYvhnQSz6Ucxc","zu9PcxvfoZlqQVk5"],"medium-armor-expertise":["FCEp9jjxxgRJDJV3","tzUaTqB6GHAeffOl"],"medium-armor-mastery":["cGMSYAErbUG5E8X2","NcEpvnIZfKzG1Iou"],resolve:["JQAujUXjczVnYDEI","D2g6sZQAWaTccviQ","vv63fioCtOvDIdF2","9WjZSliQZJlyGvUi"],"vigilant-senses":["0npO4rPscGm0dX13","NTp146fjLreL5zsj"],"weapon-expertise":["9XLUh9iMepZesdmc","F5BHEav90oOJ2LwN","O99eXctsEjEpuBwe"],"weapon-specialization":["9EqIasqfI8YIM3Pt","WiM7X4xmpMx4s6LD","1NGTc0gqEtwaFqUK"]};features=["Alertness","Armor Expertise","Armor Mastery","Evasion","Expert Spellcaster","Great Fortitude","Improved Evasion","Incredible Senses","Iron Will","Juggernaut","Lightning Reflexes","Magical Fortitude","Master Spellcaster","Medium Armor Expertise","Medium Armor Mastery","Resolve","Vigilant Senses","Weapon Expertise","Weapon Specialization"].map(name2=>({slug:sluggify(name2),name:name2}));#migrateClass(itemSource){for(const refId in itemSource.system.items){const itemRef=itemSource.system.items[refId];itemRef.level=Number(itemRef.level)||1;for(const feature of this.features)itemSource.system.slug==="swashbuckler"&&feature.slug==="weapon-expertise"||this.itemIds[feature.slug].includes(itemRef.id??"")&&(itemRef.id=this.itemIds[feature.slug][0],itemRef.name=feature.name)}}#migrateFeature(source2){if(this.#isClassFeature(source2))for(const feature of this.features)source2.system.slug==="swashbuckler"&&feature.slug==="weapon-expertise"||source2.system.slug?.startsWith(`${feature.slug}-level-`)&&(source2.system.slug=feature.slug,source2.name.startsWith(`${feature.name} `)&&(source2.name=feature.name),source2.system.traits.value=[])}#isClassFeature(source2){return source2.type==="feat"&&"featType"in source2.system&&e$2(source2.system.featType)&&source2.system.featType.value==="classfeature"}async updateItem(source2){source2.type==="class"?this.#migrateClass(source2):source2.type==="feat"&&this.#migrateFeature(source2)}}class Migration701ModifierNameToSlug extends MigrationBase{static{__name(this,"Migration701ModifierNameToSlug")}static{__name2(this,"Migration701ModifierNameToSlug")}static version=.701;async updateItem(itemSource){const rules=itemSource.system.rules.filter(r2=>["FlatModifier","DamageDice"].includes(String(r2.key)));for(const rule of rules)rule.name&&(rule.label?rule.slug=sluggify(rule.name):rule.label=rule.name,delete rule.name),rule.label==="Rage"&&(rule.label="PF2E.TraitRage")}}class Migration702REFormulasAtInstanceLevel extends MigrationBase{static{__name(this,"Migration702REFormulasAtInstanceLevel")}static{__name2(this,"Migration702REFormulasAtInstanceLevel")}static version=.702;raiseToInstanceLevel(value){return value.replace(/@[a-z.]+/gi,match=>["@mod","@castLevel","@heighten","@item.badge.value"].includes(match)||match.indexOf("@spell")>=0?match:match==="@details.level.value"||match==="@actor.details.level.value"?"@actor.level":match==="@item.value.value"?"@item.badge.value":match.startsWith("@abilities.")?match.replace(/\babilities\b/,"actor.abilities"):match.startsWith("@attributes.")?match.replace(/\battributes\b/,"actor.attributes"):match==="@item.level.value"?"@item.level":/^@item\.[a-z]+$/.test(match)?match:match.replace(/@item\.(?!data\b)/,"@item.system.").replace(/@(?!(?:item|actor|[A-Z]\w+))/,"@actor.system."))}async updateItem(itemSource){const rules=itemSource.system.rules;for(const rule of rules)try{if(typeof rule.value=="string")rule.value=this.raiseToInstanceLevel(rule.value);else if(e$2(rule.value)&&"brackets"in rule.value&&Array.isArray(rule.value.brackets))for(const bracket of rule.value.brackets)e$2(bracket)&&typeof bracket.value=="string"&&(bracket.value=this.raiseToInstanceLevel(bracket.value));rule.key==="Note"&&rule.text&&(rule.text=this.raiseToInstanceLevel(rule.text))}catch{continue}}}class Migration703SpellDamageStructure extends MigrationBase{static{__name(this,"Migration703SpellDamageStructure")}static{__name2(this,"Migration703SpellDamageStructure")}static version=.703;async updateItem(source2){if(source2.type==="spell"){const system2=source2.system;e$2(system2.damage)?(!("value"in system2.damage)||!e$2(system2.damage.value))&&(system2.damage.value={}):system2.damage={value:{}}}}}class Migration704MartialProficiencyRE extends MigrationBase{static{__name(this,"Migration704MartialProficiencyRE")}static{__name2(this,"Migration704MartialProficiencyRE")}static version=.704;async updateItem(itemSource){const rules=itemSource.system.rules.filter(r2=>r2.key==="LinkedProficiency");for(const rule of rules)if(rule.key="MartialProficiency",rule.definition=rule.predicate,delete rule.predicate,typeof rule.slug=="string"&&itemSource.system.slug?.endsWith("-weapon-familiarity")&&!rule.label){const key=sluggify(rule.slug,{camel:"bactrian"});rule.label=`PF2E.SpecificRule.MartialProficiency.${key}`}if(itemSource.type==="class"&&itemSource.system.slug==="gunslinger"&&itemSource.system.rules.length===0){const gunslingerRules=[{definition:{all:["weapon:category:simple"],any:["weapon:group:firearm","weapon:tag:crossbow"]},key:"MartialProficiency",label:"PF2E.SpecificRule.MartialProficiency.SimpleFirearmsCrossbows",slug:"simple-firearms-crossbows",value:2},{definition:{all:["weapon:category:martial"],any:["weapon:group:firearm","weapon:tag:crossbow"]},key:"MartialProficiency",label:"PF2E.SpecificRule.MartialProficiency.MartialFirearmsCrossbows",slug:"martial-firearms-crossbows",value:2},{definition:{all:["weapon:category:advanced"],any:["weapon:group:firearm","weapon:tag:crossbow"]},key:"MartialProficiency",label:"PF2E.SpecificRule.MartialProficiency.AdvancedFirearmsCrossbows",slug:"advanced-firearms-crossbows",value:1}];itemSource.system.rules=gunslingerRules}}}class Migration705GunslingerCatchUp extends MigrationBase{static{__name(this,"Migration705GunslingerCatchUp")}static{__name2(this,"Migration705GunslingerCatchUp")}static version=.705;#isClassFeature(source2){return source2.type==="feat"&&"featType"in source2.system&&e$2(source2.system.featType)&&source2.system.featType.value==="classfeature"}async updateItem(source2){if(this.#isClassFeature(source2))switch(source2.system.slug){case"singular-expertise":{const rules=[{key:"FlatModifier",selector:"firearm-weapon-group-damage",type:"circumstance",value:1},{key:"FlatModifier",predicate:{all:["weapon:tag:crossbow"]},selector:"bow-weapon-group-damage",type:"circumstance",value:1}];source2.system.rules=rules;break}case"gunslinger-weapon-mastery":{const rules=[{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.unarmed.rank",value:2},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.simple.rank",value:2},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.martial.rank",value:2},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.advanced-firearms-crossbows.rank",value:2},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.simple-firearms-crossbows.rank",value:3},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.martial-firearms-crossbows.rank",value:3}];source2.system.rules=rules;break}case"gunslinging-legend":{const rules=[{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.unarmed.rank",value:3},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.simple.rank",value:3},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.martial.rank",value:3},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.advanced-firearms-crossbows.rank",value:3},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.simple-firearms-crossbows.rank",value:4},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.martial-firearms-crossbows.rank",value:4}];source2.system.rules=rules;break}}}}class Migration706FormulasAtInstanceLevelEverythingElse extends Migration702REFormulasAtInstanceLevel{static{__name(this,"Migration706FormulasAtInstanceLevelEverythingElse")}static{__name2(this,"Migration706FormulasAtInstanceLevelEverythingElse")}static version=.706;async updateItem(source2){if(source2.system.description.value&&(source2.system.description.value=this.replaceInlineRolls(source2.system.description.value)),source2.type==="spell")for(const value of Object.values(source2.system.damage.value))value.value=this.raiseToInstanceLevel(value.value);if(source2.type==="melee")for(const value of Object.values(source2.system.damageRolls))value.damage=this.raiseToInstanceLevel(value.damage)}replaceInlineRolls(value){return value.replace(/\[\[(.*)\]\]/g,match=>this.raiseToInstanceLevel(match))}}class Migration707BracketedFormulasAtInstanceLevel extends Migration702REFormulasAtInstanceLevel{static{__name(this,"Migration707BracketedFormulasAtInstanceLevel")}static{__name2(this,"Migration707BracketedFormulasAtInstanceLevel")}static version=.707}class Migration708SpecificRuleLabel extends MigrationBase{static{__name(this,"Migration708SpecificRuleLabel")}static{__name2(this,"Migration708SpecificRuleLabel")}static version=.708;async updateItem(source2){for(const rule of source2.system.rules)rule.label&&(rule.label=String(rule.label).replace(/\bSpecificRules\b/,"SpecificRule"))}}class Migration709REFormulasAtInstanceLevelRedux extends Migration702REFormulasAtInstanceLevel{static{__name(this,"Migration709REFormulasAtInstanceLevelRedux")}static{__name2(this,"Migration709REFormulasAtInstanceLevelRedux")}static version=.709;walkObject(obj){if(Array.isArray(obj))for(let i=0;i<obj.length;i++)obj[i]=this.findAndMigrateFormulas(obj[i]);else for(const[key,value]of Object.entries(obj))obj[key]=this.findAndMigrateFormulas(value)}findAndMigrateFormulas(value){return typeof value=="string"&&value.includes("@")?this.raiseToInstanceLevel(value):((e$2(value)||Array.isArray(value))&&this.walkObject(value),value)}async updateItem(itemSource){const rules=itemSource.system.rules.filter(r2=>r2.key==="BattleForm");for(const rule of rules)this.walkObject(rule);itemSource.type==="spell"&&itemSource.system.slug==="wild-shape"&&(itemSource.system.rules=[])}}class Migration710RarityToString extends MigrationBase{static{__name(this,"Migration710RarityToString")}static{__name2(this,"Migration710RarityToString")}static version=.71;updateTraits(traits){typeof traits?.rarity=="object"&&traits.rarity!==null&&(traits.rarity=traits.rarity.value)}async updateActor(actorSource){"traits"in actorSource.system&&this.updateTraits(actorSource.system.traits??null)}async updateItem(itemSource){"traits"in itemSource.system&&this.updateTraits(itemSource.system.traits??null)}}const ancestryTraits={aiuvarin:"PF2E.TraitAiuvarin",anadi:"PF2E.TraitAnadi",android:"PF2E.TraitAndroid",aphorite:"PF2E.TraitAphorite",ardande:"PF2E.TraitArdande",athamaru:"PF2E.TraitAthamaru",automaton:"PF2E.TraitAutomaton","awakened-animal":"PF2E.TraitAwakenedAnimal",azarketi:"PF2E.TraitAzarketi",beastkin:"PF2E.TraitBeastkin",bugbear:"PF2E.TraitBugbear",catfolk:"PF2E.TraitCatfolk",centaur:"PF2E.TraitCentaur",changeling:"PF2E.TraitChangeling",conrasu:"PF2E.TraitConrasu",dhampir:"PF2E.TraitDhampir",dragonblood:"PF2E.TraitDragonblood",dragonet:"PF2E.TraitDragonet",dromaar:"PF2E.TraitDromaar",duskwalker:"PF2E.TraitDuskwalker",dwarf:"PF2E.TraitDwarf",elf:"PF2E.TraitElf",fetchling:"PF2E.TraitFetchling",fleshwarp:"PF2E.TraitFleshwarp",ganzi:"PF2E.TraitGanzi",geniekin:"PF2E.TraitGeniekin",ghoran:"PF2E.TraitGhoran",gnoll:"PF2E.TraitGnoll",gnome:"PF2E.TraitGnome",goblin:"PF2E.TraitGoblin",goloma:"PF2E.TraitGoloma",grippli:"PF2E.TraitGrippli",halfling:"PF2E.TraitHalfling",hobgoblin:"PF2E.TraitHobgoblin",human:"PF2E.TraitHuman",hungerseed:"PF2E.TraitHungerseed",jotunborn:"PF2E.TraitJotunborn",kashrishi:"PF2E.TraitKashrishi",kitsune:"PF2E.TraitKitsune",kobold:"PF2E.TraitKobold",leshy:"PF2E.TraitLeshy",lizardfolk:"PF2E.TraitLizardfolk",merfolk:"PF2E.TraitMerfolk",minotaur:"PF2E.TraitMinotaur",nagaji:"PF2E.TraitNagaji",naari:"PF2E.TraitNaari",nephilim:"PF2E.TraitNephilim",orc:"PF2E.TraitOrc",oread:"PF2E.TraitOread",poppet:"PF2E.TraitPoppet",ratfolk:"PF2E.TraitRatfolk",reflection:"PF2E.TraitReflection",samsaran:"PF2E.TraitSamsaran",sarangay:"PF2E.TraitSarangay",shisk:"PF2E.TraitShisk",shoony:"PF2E.TraitShoony",skeleton:"PF2E.TraitSkeleton",sprite:"PF2E.TraitSprite",strix:"PF2E.TraitStrix",suli:"PF2E.TraitSuli",surki:"PF2E.TraitSurki",sylph:"PF2E.TraitSylph",tanuki:"PF2E.TraitTanuki",talos:"PF2E.TraitTalos",tengu:"PF2E.TraitTengu",undine:"PF2E.TraitUndine",vanara:"PF2E.TraitVanara",vishkanya:"PF2E.TraitVishkanya",wayang:"PF2E.TraitWayang",yaksha:"PF2E.TraitYaksha",yaoguai:"PF2E.TraitYaoguai"},elementTraits={air:"PF2E.TraitAir",earth:"PF2E.TraitEarth",fire:"PF2E.TraitFire",metal:"PF2E.TraitMetal",water:"PF2E.TraitWater",wood:"PF2E.TraitWood"},energyDamageTypes={acid:"PF2E.TraitAcid",cold:"PF2E.TraitCold",electricity:"PF2E.TraitElectricity",fire:"PF2E.TraitFire",force:"PF2E.TraitForce",sonic:"PF2E.TraitSonic",vitality:"PF2E.TraitVitality",void:"PF2E.TraitVoid"},magicTraditions={arcane:"PF2E.TraitArcane",divine:"PF2E.TraitDivine",occult:"PF2E.TraitOccult",primal:"PF2E.TraitPrimal"},sanctificationTraits={holy:"PF2E.TraitHoly",unholy:"PF2E.TraitUnholy"},creatureTraits={...ancestryTraits,...elementTraits,...energyDamageTypes,...magicTraditions,...sanctificationTraits,aberration:"PF2E.TraitAberration",aeon:"PF2E.TraitAeon",aesir:"PF2E.TraitAesir",agathion:"PF2E.TraitAgathion",alchemical:"PF2E.TraitAlchemical",amphibious:"PF2E.TraitAmphibious",angel:"PF2E.TraitAngel",animal:"PF2E.TraitAnimal",anugobu:"PF2E.TraitAnugobu",aquatic:"PF2E.TraitAquatic",archon:"PF2E.TraitArchon",astral:"PF2E.TraitAstral",asura:"PF2E.TraitAsura",azata:"PF2E.TraitAzata",beast:"PF2E.TraitBeast",blight:"PF2E.TraitBlight",boggard:"PF2E.TraitBoggard",bugbear:"PF2E.TraitBugbear",caligni:"PF2E.TraitCaligni",celestial:"PF2E.TraitCelestial",centaur:"PF2E.TraitCentaur","charau-ka":"PF2E.TraitCharauKa",clockwork:"PF2E.TraitClockwork",construct:"PF2E.TraitConstruct",couatl:"PF2E.TraitCouatl",daemon:"PF2E.TraitDaemon",darvakka:"PF2E.TraitDarvakka",demon:"PF2E.TraitDemon",dero:"PF2E.TraitDero",devil:"PF2E.TraitDevil",dinosaur:"PF2E.TraitDinosaur",div:"PF2E.TraitDiv",dragon:"PF2E.TraitDragon",dream:"PF2E.TraitDream",drow:"PF2E.TraitDrow",duergar:"PF2E.TraitDuergar",eidolon:"PF2E.TraitEidolon",elemental:"PF2E.TraitElemental",ethereal:"PF2E.TraitEthereal",experiment:"PF2E.TraitExperiment",fey:"PF2E.TraitFey",fiend:"PF2E.TraitFiend",formian:"PF2E.TraitFormian",fungus:"PF2E.TraitFungus",genie:"PF2E.TraitGenie",ghoran:"PF2E.TraitGhoran",ghost:"PF2E.TraitGhost",ghoul:"PF2E.TraitGhoul",ghul:"PF2E.TraitGhul",giant:"PF2E.TraitGiant",gigas:"PF2E.TraitGigas",girtablilu:"PF2E.TraitGirtablilu",golem:"PF2E.TraitGolem",graveknight:"PF2E.TraitGraveknight",gremlin:"PF2E.TraitGremlin",grioth:"PF2E.TraitGrioth",hag:"PF2E.TraitHag",hantu:"PF2E.TraitHantu",herald:"PF2E.TraitHerald",hryngar:"PF2E.TraitHryngar",humanoid:"PF2E.TraitHumanoid",ikeshti:"PF2E.TraitIkeshti",illusion:"PF2E.TraitIllusion",incorporeal:"PF2E.TraitIncorporeal",inevitable:"PF2E.TraitInevitable",kami:"PF2E.TraitKami",kaiju:"PF2E.TraitKaiju",kovintus:"PF2E.TraitKovintus",light:"PF2E.TraitLight",lilu:"PF2E.TraitLilu",locathah:"PF2E.TraitLocathah",maftet:"PF2E.TraitMaftet",mental:"PF2E.TraitMental",merfolk:"PF2E.TraitMerfolk",mindless:"PF2E.TraitMindless",minion:"PF2E.TraitMinion",monitor:"PF2E.TraitMonitor",morlock:"PF2E.TraitMorlock",mortic:"PF2E.TraitMortic",mummy:"PF2E.TraitMummy",munavri:"PF2E.TraitMunavri",mutant:"PF2E.TraitMutant",mythic:"PF2E.TraitMythic",nindoru:"PF2E.TraitNindoru",nymph:"PF2E.TraitNymph",oni:"PF2E.TraitOni",ooze:"PF2E.TraitOoze",oread:"PF2E.TraitOread",paaridar:"PF2E.TraitPaaridar",palinthanos:"PF2E.TraitPalinthanos","persona-flirt":"PF2E.TraitPersonaFlirt","persona-guardian":"PF2E.TraitPersonaGuardian","persona-leader":"PF2E.TraitPersonaLeader","persona-scholar":"PF2E.TraitPersonaScholar","persona-scoundrel":"PF2E.TraitPersonaScoundrel","persona-underdog":"PF2E.TraitPersonaUnderdog","persona-warrior":"PF2E.TraitPersonaWarrior","persona-wildcard":"PF2E.TraitPersonaWildcard",petitioner:"PF2E.TraitPetitioner",phantom:"PF2E.TraitPhantom",plant:"PF2E.TraitPlant",poison:"PF2E.TraitPoison",protean:"PF2E.TraitProtean",psychopomp:"PF2E.TraitPsychopomp",qlippoth:"PF2E.TraitQlippoth",rakshasa:"PF2E.TraitRakshasa",reflection:"PF2E.TraitReflection",sahkil:"PF2E.TraitSahkil","sea-devil":"PF2E.TraitSeaDevil",sedacthy:"PF2E.TraitSedacthy",serpentfolk:"PF2E.TraitSerpentfolk",seugathi:"PF2E.TraitSeugathi",shabti:"PF2E.TraitShabti",shade:"PF2E.TraitShade",shadow:"PF2E.TraitShadow",shobhad:"PF2E.TraitShobhad",siktempora:"PF2E.TraitSiktempora",skelm:"PF2E.TraitSkelm",skulk:"PF2E.TraitSkulk",soulbound:"PF2E.TraitSoulbound",spirit:"PF2E.TraitSpirit",sporeborn:"PF2E.TraitSporeborn",spriggan:"PF2E.TraitSpriggan",stheno:"PF2E.TraitStheno",summoned:"PF2E.TraitSummoned",swarm:"PF2E.TraitSwarm",tane:"PF2E.TraitTane",tanggal:"PF2E.TraitTanggal",time:"PF2E.TraitTime",titan:"PF2E.TraitTitan",troll:"PF2E.TraitTroll",troop:"PF2E.TraitTroop",undead:"PF2E.TraitUndead",urdefhan:"PF2E.TraitUrdefhan",vampire:"PF2E.TraitVampire",vanara:"PF2E.TraitVanara",velstrac:"PF2E.TraitVelstrac",wayang:"PF2E.TraitWayang",werecreature:"PF2E.TraitWerecreature",wight:"PF2E.TraitWight","wild-hunt":"PF2E.TraitWildHunt",wraith:"PF2E.TraitWraith",wraithvine:"PF2E.TraitWraithvine",wyrwood:"PF2E.TraitWyrwood",xulgath:"PF2E.TraitXulgath",zombie:"PF2E.TraitZombie"},classTraits={alchemist:"PF2E.TraitAlchemist",animist:"PF2E.TraitAnimist",barbarian:"PF2E.TraitBarbarian",bard:"PF2E.TraitBard",champion:"PF2E.TraitChampion",cleric:"PF2E.TraitCleric",commander:"PF2E.TraitCommander",druid:"PF2E.TraitDruid",exemplar:"PF2E.TraitExemplar",fighter:"PF2E.TraitFighter",guardian:"PF2E.TraitGuardian",gunslinger:"PF2E.TraitGunslinger",inventor:"PF2E.TraitInventor",investigator:"PF2E.TraitInvestigator",kineticist:"PF2E.TraitKineticist",magus:"PF2E.TraitMagus",monk:"PF2E.TraitMonk",oracle:"PF2E.TraitOracle",psychic:"PF2E.TraitPsychic",ranger:"PF2E.TraitRanger",rogue:"PF2E.TraitRogue",sorcerer:"PF2E.TraitSorcerer",summoner:"PF2E.TraitSummoner",swashbuckler:"PF2E.TraitSwashbuckler",thaumaturge:"PF2E.TraitThaumaturge",witch:"PF2E.TraitWitch",wizard:"PF2E.TraitWizard"},damageTraits={...elementTraits,...energyDamageTypes,...sanctificationTraits,light:"PF2E.TraitLight",magical:"PF2E.TraitMagical",mental:"PF2E.TraitMental",nonlethal:"PF2E.TraitNonlethal",plant:"PF2E.TraitPlant",radiation:"PF2E.TraitRadiation",spirit:"PF2E.TraitSpirit",vitality:"PF2E.TraitVitality",void:"PF2E.TraitVoid"},spellTraits={...classTraits,...damageTraits,...elementTraits,...magicTraditions,...sanctificationTraits,amp:"PF2E.TraitAmp",attack:"PF2E.TraitAttack",auditory:"PF2E.TraitAuditory",aura:"PF2E.TraitAura",beast:"PF2E.TraitBeast",cantrip:"PF2E.TraitCantrip",composition:"PF2E.TraitComposition",concentrate:"PF2E.TraitConcentrate",consecration:"PF2E.TraitConsecration",contingency:"PF2E.TraitContingency",curse:"PF2E.TraitCurse",cursebound:"PF2E.TraitCursebound",darkness:"PF2E.TraitDarkness",death:"PF2E.TraitDeath",detection:"PF2E.TraitDetection",disease:"PF2E.TraitDisease",dream:"PF2E.TraitDream",eidolon:"PF2E.TraitEidolon",emotion:"PF2E.TraitEmotion",exploration:"PF2E.TraitExploration",extradimensional:"PF2E.TraitExtradimensional",fear:"PF2E.TraitFear",focus:"PF2E.TraitFocus",fortune:"PF2E.TraitFortune",fungus:"PF2E.TraitFungus",healing:"PF2E.TraitHealing",hex:"PF2E.TraitHex",illusion:"PF2E.TraitIllusion",incapacitation:"PF2E.TraitIncapacitation",incarnate:"PF2E.TraitIncarnate",incorporeal:"PF2E.TraitIncorporeal",inhaled:"PF2E.TraitInhaled",light:"PF2E.TraitLight",linguistic:"PF2E.TraitLinguistic",litany:"PF2E.TraitLitany",manipulate:"PF2E.TraitManipulate",misfortune:"PF2E.TraitMisfortune",morph:"PF2E.TraitMorph",move:"PF2E.TraitMove",mythic:"PF2E.TraitMythic",nonlethal:"PF2E.TraitNonlethal",olfactory:"PF2E.TraitOlfactory",plant:"PF2E.TraitPlant",poison:"PF2E.TraitPoison",polymorph:"PF2E.TraitPolymorph",possession:"PF2E.TraitPossession",prediction:"PF2E.TraitPrediction",psyche:"PF2E.TraitPsyche",rage:"PF2E.TraitRage",revelation:"PF2E.TraitRevelation",sanctified:"PF2E.TraitSanctified",scrying:"PF2E.TraitScrying",shadow:"PF2E.TraitShadow",sleep:"PF2E.TraitSleep",spellshape:"PF2E.TraitSpellshape",stance:"PF2E.TraitStance",structure:"PF2E.TraitStructure",subtle:"PF2E.TraitSubtle",summon:"PF2E.TraitSummon",summoned:"PF2E.TraitSummoned",teleportation:"PF2E.TraitTeleportation",trial:"PF2E.TraitTrial","true-name":"PF2E.TraitTrueName",visual:"PF2E.TraitVisual"},weaponTraits={...ancestryTraits,...elementTraits,...energyDamageTypes,...magicTraditions,...sanctificationTraits,adjusted:"PF2E.TraitAdjusted",agile:"PF2E.TraitAgile",alchemical:"PF2E.TraitAlchemical",analog:"PF2E.TraitAnalog",apex:"PF2E.TraitApex",artifact:"PF2E.TraitArtifact",attached:"PF2E.TraitAttached","attached-to-shield":"PF2E.TraitAttachedToShield","attached-to-crossbow-or-firearm":"PF2E.TraitAttachedToCrossbowOrFirearm",auditory:"PF2E.TraitAuditory",automatic:"PF2E.TraitAutomatic",backstabber:"PF2E.TraitBackstabber",backswing:"PF2E.TraitBackswing",bomb:"PF2E.TraitBomb",brace:"PF2E.TraitBrace",brutal:"PF2E.TraitBrutal","capacity-2":"PF2E.TraitCapacity2","capacity-3":"PF2E.TraitCapacity3","capacity-4":"PF2E.TraitCapacity4","capacity-5":"PF2E.TraitCapacity5",climbing:"PF2E.TraitClimbing",clockwork:"PF2E.TraitClockwork",cobbled:"PF2E.TraitCobbled",combination:"PF2E.TraitCombination",concealable:"PF2E.TraitConcealable",concussive:"PF2E.TraitConcussive",consumable:"PF2E.TraitConsumable","critical-fusion":"PF2E.TraitCriticalFusion",cursed:"PF2E.TraitCursed","deadly-d4":"PF2E.TraitDeadlyD4","deadly-d6":"PF2E.TraitDeadlyD6","deadly-d8":"PF2E.TraitDeadlyD8","deadly-d10":"PF2E.TraitDeadlyD10","deadly-d12":"PF2E.TraitDeadlyD12",death:"PF2E.TraitDeath",disarm:"PF2E.TraitDisarm",disease:"PF2E.TraitDisease","double-barrel":"PF2E.TraitDoubleBarrel",emotion:"PF2E.TraitEmotion",extradimensional:"PF2E.TraitExtradimensional","fatal-aim-d10":"PF2E.TraitFatalAimD10","fatal-aim-d12":"PF2E.TraitFatalAimD12","fatal-d8":"PF2E.TraitFatalD8","fatal-d10":"PF2E.TraitFatalD10","fatal-d12":"PF2E.TraitFatalD12",fear:"PF2E.TraitFear",finesse:"PF2E.TraitFinesse",forceful:"PF2E.TraitForceful",fortune:"PF2E.TraitFortune","free-hand":"PF2E.TraitFreeHand",fungus:"PF2E.TraitFungus",grapple:"PF2E.TraitGrapple",hampering:"PF2E.TraitHampering",healing:"PF2E.TraitHealing",illusion:"PF2E.TraitIllusion",infused:"PF2E.TraitInfused",inhaled:"PF2E.TraitInhaled",injection:"PF2E.TraitInjection",intelligent:"PF2E.TraitIntelligent",invested:"PF2E.TraitInvested","jousting-d4":"PF2E.TraitJoustingD4","jousting-d6":"PF2E.TraitJoustingD6","jousting-d8":"PF2E.TraitJoustingD8","jousting-d10":"PF2E.TraitJoustingD10",kickback:"PF2E.TraitKickback",light:"PF2E.TraitLight",magical:"PF2E.TraitMagical",mental:"PF2E.TraitMental",modular:"PF2E.TraitModular",monk:"PF2E.TraitMonk",mythic:"PF2E.TraitMythic",nonlethal:"PF2E.TraitNonlethal",olfactory:"PF2E.TraitOlfactory",parry:"PF2E.TraitParry",plant:"PF2E.TraitPlant",poison:"PF2E.TraitPoison",propulsive:"PF2E.TraitPropulsive","ranged-trip":"PF2E.TraitRangedTrip",razing:"PF2E.TraitRazing",reach:"PF2E.TraitReach",recovery:"PF2E.TraitRecovery",relic:"PF2E.TraitRelic",repeating:"PF2E.TraitRepeating",resonant:"PF2E.TraitResonant",saggorak:"PF2E.TraitSaggorak","scatter-5":"PF2E.TraitScatter5","scatter-10":"PF2E.TraitScatter10","scatter-15":"PF2E.TraitScatter15","scatter-20":"PF2E.TraitScatter20",scrying:"PF2E.TraitScrying",shadow:"PF2E.TraitShadow",shove:"PF2E.TraitShove",spirit:"PF2E.TraitSpirit",splash:"PF2E.TraitSplash",staff:"PF2E.TraitStaff",sweep:"PF2E.TraitSweep",tearing:"PF2E.TraitTearing",tech:"PF2E.TraitTech",teleportation:"PF2E.TraitTeleportation",tethered:"PF2E.TraitTethered",thrown:"PF2E.TraitThrown","thrown-10":"PF2E.TraitThrown10","thrown-15":"PF2E.TraitThrown15","thrown-20":"PF2E.TraitThrown20","thrown-30":"PF2E.TraitThrown30","thrown-40":"PF2E.TraitThrown40","thrown-50":"PF2E.TraitThrown50","thrown-60":"PF2E.TraitThrown60","thrown-80":"PF2E.TraitThrown80","thrown-100":"PF2E.TraitThrown100","thrown-200":"PF2E.TraitThrown200",time:"PF2E.TraitTime",training:"PF2E.TraitTraining","tracking-1":"PF2E.TraitTracking1","tracking-2":"PF2E.TraitTracking2","tracking-3":"PF2E.TraitTracking3",trip:"PF2E.TraitTrip",twin:"PF2E.TraitTwin","two-hand-d6":"PF2E.TraitTwoHandD6","two-hand-d8":"PF2E.TraitTwoHandD8","two-hand-d10":"PF2E.TraitTwoHandD10","two-hand-d12":"PF2E.TraitTwoHandD12",unarmed:"PF2E.TraitUnarmed",vehicular:"PF2E.TraitVehicular",venomous:"PF2E.TraitVenomous","versatile-acid":"PF2E.TraitVersatileAcid","versatile-b":"PF2E.TraitVersatileB","versatile-cold":"PF2E.TraitVersatileCold","versatile-electricity":"PF2E.TraitVersatileElectricity","versatile-fire":"PF2E.TraitVersatileFire","versatile-force":"PF2E.TraitVersatileForce","versatile-mental":"PF2E.TraitVersatileMental","versatile-p":"PF2E.TraitVersatileP","versatile-poison":"PF2E.TraitVersatilePoison","versatile-s":"PF2E.TraitVersatileS","versatile-sonic":"PF2E.TraitVersatileSonic","versatile-spirit":"PF2E.TraitVersatileSpirit","versatile-vitality":"PF2E.TraitVersatileVitality","versatile-void":"PF2E.TraitVersatileVoid",visual:"PF2E.TraitVisual","volley-20":"PF2E.TraitVolley20","volley-30":"PF2E.TraitVolley30","volley-50":"PF2E.TraitVolley50","volley-60":"PF2E.TraitVolley60",wand:"PF2E.TraitWand"},preciousMaterials={abysium:"PF2E.PreciousMaterialAbysium",adamantine:"PF2E.PreciousMaterialAdamantine","cold-iron":"PF2E.PreciousMaterialColdIron",dawnsilver:"PF2E.PreciousMaterialDawnsilver",duskwood:"PF2E.PreciousMaterialDuskwood",djezet:"PF2E.PreciousMaterialDjezet",dragonhide:"PF2E.PreciousMaterialDragonhide",dreamweb:"PF2E.PreciousMaterialDreamweb","grisantian-pelt":"PF2E.PreciousMaterialGrisantianPelt",inubrix:"PF2E.PreciousMaterialInubrix","keep-stone":"PF2E.PreciousMaterialKeepStone",noqual:"PF2E.PreciousMaterialNoqual",orichalcum:"PF2E.PreciousMaterialOrichalcum",peachwood:"PF2E.PreciousMaterialPeachwood",siccatite:"PF2E.PreciousMaterialSiccatite",silver:"PF2E.PreciousMaterialSilver",sisterstone:"PF2E.PreciousMaterialSisterstone","sisterstone-dusk":"PF2E.PreciousMaterialSisterstoneDusk","sisterstone-scarlet":"PF2E.PreciousMaterialSisterstoneScarlet",sloughstone:"PF2E.PreciousMaterialSloughstone","sovereign-steel":"PF2E.PreciousMaterialSovereignSteel",warpglass:"PF2E.PreciousMaterialWarpglass"},otherArmorTags={shoddy:"PF2E.Item.Physical.OtherTag.Shoddy"},otherConsumableTags={"alchemical-food":"PF2E.Item.Physical.OtherTag.AlchemicalFood","alchemical-tool":"PF2E.Item.Physical.OtherTag.AlchemicalTool",herbal:"PF2E.Item.Physical.OtherTag.Herbal"},otherWeaponTags={"handwraps-of-mighty-blows":"PF2E.Item.Physical.OtherTag.HandwrapsOfMightyBlows",improvised:"PF2E.Item.Physical.OtherTag.Improvised",shoddy:"PF2E.Item.Physical.OtherTag.Shoddy"},npcAttackTraits={...weaponTraits,...preciousMaterials,area:"PF2E.TraitArea",concentrate:"PF2E.TraitConcentrate",curse:"PF2E.TraitCurse","deadly-2d8":"PF2E.TraitDeadly2D8","deadly-3d8":"PF2E.TraitDeadly3D8","deadly-4d8":"PF2E.TraitDeadly4D8","deadly-2d10":"PF2E.TraitDeadly2D10","deadly-3d10":"PF2E.TraitDeadly3D10","deadly-4d10":"PF2E.TraitDeadly4D10","deadly-2d12":"PF2E.TraitDeadly2D12","deadly-3d12":"PF2E.TraitDeadly3D12","deadly-4d12":"PF2E.TraitDeadly4D12",illusion:"PF2E.TraitIllusion",impulse:"PF2E.TraitImpulse",incorporeal:"PF2E.TraitIncorporeal",radiation:"PF2E.TraitRadiation","reach-0":"PF2E.TraitReach0","reach-10":"PF2E.TraitReach10","reach-15":"PF2E.TraitReach15","reach-20":"PF2E.TraitReach20","reach-25":"PF2E.TraitReach25","reach-30":"PF2E.TraitReach30","reach-40":"PF2E.TraitReach40","reach-50":"PF2E.TraitReach50","reach-60":"PF2E.TraitReach60","reach-100":"PF2E.TraitReach100","reach-120":"PF2E.TraitReach120","reach-200":"PF2E.TraitReach200","reach-1000":"PF2E.TraitReach1000","reload-0":"PF2E.TraitReload0","reload-1":"PF2E.TraitReload1","reload-2":"PF2E.TraitReload2","reload-1-min":"PF2E.TraitReload1Min",sanctified:"PF2E.TraitSanctified"},featTraits={...ancestryTraits,...classTraits,...damageTraits,...magicTraditions,...spellTraits,additive:"PF2E.TraitAdditive",additive1:"PF2E.TraitAdditive1",additive2:"PF2E.TraitAdditive2",additive3:"PF2E.TraitAdditive3",aftermath:"PF2E.TraitAftermath",alchemical:"PF2E.TraitAlchemical",apparition:"PF2E.TraitApparition",archetype:"PF2E.TraitArchetype",artifact:"PF2E.TraitArtifact",auditory:"PF2E.TraitAuditory",aura:"PF2E.TraitAura",brandish:"PF2E.TraitBrandish",bravado:"PF2E.TraitBravado",calling:"PF2E.TraitCalling",circus:"PF2E.TraitCircus",class:"TYPES.Item.class",coagulant:"PF2E.TraitCoagulant",composite:"PF2E.TraitComposite",concentrate:"PF2E.TraitConcentrate",dedication:"PF2E.TraitDedication",destiny:"PF2E.TraitDestiny",detection:"PF2E.TraitDetection",deviant:"PF2E.TraitDeviant",downtime:"PF2E.TraitDowntime",emotion:"PF2E.TraitEmotion",evolution:"PF2E.TraitEvolution",esoterica:"PF2E.TraitEsoterica",exploration:"PF2E.TraitExploration",fear:"PF2E.TraitFear",finisher:"PF2E.TraitFinisher",flourish:"PF2E.TraitFlourish",fortune:"PF2E.TraitFortune",general:"PF2E.TraitGeneral",ikon:"PF2E.TraitIkon",impulse:"PF2E.TraitImpulse",infusion:"PF2E.TraitInfusion",injury:"PF2E.TraitInjury",lineage:"PF2E.TraitLineage",manipulate:"PF2E.TraitManipulate",mindshift:"PF2E.TraitMindshift",modification:"PF2E.TraitModification",move:"PF2E.TraitMove",multiclass:"PF2E.TraitMulticlass",oath:"PF2E.TraitOath",olfactory:"PF2E.TraitOlfactory",overflow:"PF2E.TraitOverflow","pervasive-magic":"PF2E.TraitPervasiveMagic",poison:"PF2E.TraitPoison",press:"PF2E.TraitPress",rage:"PF2E.TraitRage",reckless:"PF2E.TraitReckless",reincarnated:"PF2E.TraitReincarnated",reflection:"PF2E.TraitReflection",secret:"PF2E.TraitSecret",skill:"PF2E.TraitSkill",social:"PF2E.TraitSocial",spellshot:"PF2E.TraitSpellshot",stamina:"PF2E.TraitStamina",stance:"PF2E.TraitStance",tactic:"PF2E.TraitTactic",talisman:"PF2E.TraitTalisman",tandem:"PF2E.TraitTandem",time:"PF2E.TraitTime",transcendence:"PF2E.TraitTranscendence","true-name":"PF2E.TraitTrueName",unstable:"PF2E.TraitUnstable",vigilante:"PF2E.TraitVigilante",virulent:"PF2E.TraitVirulent",vitality:"PF2E.TraitVitality",void:"PF2E.TraitVoid",wandering:"PF2E.TraitWandering"},consumableTraits={...spellTraits,additive:"PF2E.TraitAdditive",additive1:"PF2E.TraitAdditive1",additive2:"PF2E.TraitAdditive2",additive3:"PF2E.TraitAdditive3",alchemical:"PF2E.TraitAlchemical",attack:"PF2E.TraitAttack",auditory:"PF2E.TraitAuditory",aura:"PF2E.TraitAura","bottled-breath":"PF2E.TraitBottledBreath",catalyst:"PF2E.TraitCatalyst",coagulant:"PF2E.TraitCoagulant",clockwork:"PF2E.TraitClockwork",consumable:"PF2E.TraitConsumable",contact:"PF2E.TraitContact",curse:"PF2E.TraitCurse",cursed:"PF2E.TraitCursed",drug:"PF2E.TraitDrug",elixir:"PF2E.TraitElixir",emotion:"PF2E.TraitEmotion",expandable:"PF2E.TraitExpandable",fear:"PF2E.TraitFear",fey:"PF2E.TraitFey",fortune:"PF2E.TraitFortune",fulu:"PF2E.TraitFulu",gadget:"PF2E.TraitGadget",healing:"PF2E.TraitHealing",incapacitation:"PF2E.TraitIncapacitation",infused:"PF2E.TraitInfused",ingested:"PF2E.TraitIngested",inhaled:"PF2E.TraitInhaled",injury:"PF2E.TraitInjury",kobold:"PF2E.TraitKobold",light:"PF2E.TraitLight",linguistic:"PF2E.TraitLinguistic",lozenge:"PF2E.TraitLozenge",magical:"PF2E.TraitMagical",mechanical:"PF2E.TraitMechanical",misfortune:"PF2E.TraitMisfortune",missive:"PF2E.TraitMissive",morph:"PF2E.TraitMorph",mutagen:"PF2E.TraitMutagen",oil:"PF2E.TraitOil",olfactory:"PF2E.TraitOlfactory",poison:"PF2E.TraitPoison",polymorph:"PF2E.TraitPolymorph",possession:"PF2E.TraitPossession",potion:"PF2E.TraitPotion",precious:"PF2E.TraitPrecious",processed:"PF2E.TraitProcessed",scroll:"PF2E.TraitScroll",scrying:"PF2E.TraitScrying",spirit:"PF2E.TraitSpirit",sleep:"PF2E.TraitSleep",snare:"PF2E.TraitSnare",spellgun:"PF2E.TraitSpellgun",splash:"PF2E.TraitSplash",structure:"PF2E.TraitStructure",talisman:"PF2E.TraitTalisman",tea:"PF2E.TraitTea",teleportation:"PF2E.TraitTeleportation",trap:"PF2E.TraitTrap",virulent:"PF2E.TraitVirulent",visual:"PF2E.TraitVisual",wand:"PF2E.TraitWand",whetstone:"PF2E.TraitWhetstone"},weaponActionTraits=t$3(weaponTraits,["agile","propulsive","backswing","forceful","reach","sweep","thrown","volley-20","volley-30","volley-50","volley-60"]),actionTraits={...featTraits,...consumableTraits,...spellTraits,...weaponActionTraits,"certain-kill":"PF2E.TraitCertainKill",summon:"PF2E.TraitSummon"},effectTraits=n$1(actionTraits,[...t$4(ancestryTraits),...t$4(classTraits),...t$4(weaponActionTraits),"additive","additive1","additive2","additive3","aftermath","amp","archetype","attack","backswing","beast","bottled-breath","cantrip","catalyst","circus","class","clockwork","coagulant","composite","composition","concentrate","consumable","dedication","deviant","eidolon","elixir","esoterica","expandable","exploration","finisher","flourish","focus","forceful","fulu","gadget","general","infused","lineage","litany","lozenge","manipulate","missive","modification","multiclass","mutagen","oath","oil","overflow","pervasive-magic","potion","precious","press","processed","propulsive","reckless","reincarnated","revelation","sanctified","scroll","secret","skill","snare","spellgun","splash","structure","subtle","talisman","tandem","tea","trap","unstable","vigilante","wand"]),hazardTraits={...creatureTraits,...damageTraits,...magicTraditions,alchemical:"PF2E.TraitAlchemical",auditory:"PF2E.TraitAuditory",consumable:"PF2E.TraitConsumable",curse:"PF2E.TraitCurse",environmental:"PF2E.TraitEnvironmental",haunt:"PF2E.TraitHaunt",inhaled:"PF2E.TraitInhaled",kaiju:"PF2E.TraitKaiju",mechanical:"PF2E.TraitMechanical",nightmare:"PF2E.TraitNightmare",poison:"PF2E.TraitPoison",polymorph:"PF2E.TraitPolymorph",snare:"PF2E.TraitSnare",steam:"PF2E.TraitSteam",technological:"PF2E.TraitTechnological",teleportation:"PF2E.TraitTeleportation",trap:"PF2E.TraitTrap",virulent:"PF2E.TraitVirulent",visual:"PF2E.TraitVisual"},vehicleTraits={artifact:"PF2E.TraitArtifact",clockwork:"PF2E.TraitClockwork",magical:"PF2E.TraitMagical",tech:"PF2E.TraitTech",teleportation:"PF2E.TraitTeleportation"},equipmentTraits={...ancestryTraits,...elementTraits,...energyDamageTypes,...magicTraditions,...sanctificationTraits,additive:"PF2E.TraitAdditive",additive0:"PF2E.TraitAdditive0",additive1:"PF2E.TraitAdditive1",adjusted:"PF2E.TraitAdjusted",adjustment:"PF2E.TraitAdjustment",alchemical:"PF2E.TraitAlchemical",analog:"PF2E.TraitAnalog",apex:"PF2E.TraitApex",artifact:"PF2E.TraitArtifact",auditory:"PF2E.TraitAuditory",aura:"PF2E.TraitAura",barding:"PF2E.TraitBarding",censer:"PF2E.TraitCenser",clockwork:"PF2E.TraitClockwork",coagulant:"PF2E.TraitCoagulant",coda:"PF2E.TraitCoda",companion:"PF2E.TraitCompanion",consecration:"PF2E.TraitConsecration",contract:"PF2E.TraitContract",cursed:"PF2E.TraitCursed",darkness:"PF2E.TraitDarkness",death:"PF2E.TraitDeath",detection:"PF2E.TraitDetection",dream:"PF2E.TraitDream",eidolon:"PF2E.TraitEidolon",emotion:"PF2E.TraitEmotion",expandable:"PF2E.TraitExpandable",extradimensional:"PF2E.TraitExtradimensional",fear:"PF2E.TraitFear",figurehead:"PF2E.TraitFigurehead",focused:"PF2E.TraitFocused",fortune:"PF2E.TraitFortune",fulu:"PF2E.TraitFulu",gadget:"PF2E.TraitGadget",graft:"PF2E.TraitGraft",grimoire:"PF2E.TraitGrimoire","harrow-court":"PF2E.TraitHarrowCourt",healing:"PF2E.TraitHealing",illusion:"PF2E.TraitIllusion",incapacitation:"PF2E.TraitIncapacitation",incorporeal:"PF2E.TraitIncorporeal",infused:"PF2E.TraitInfused",intelligent:"PF2E.TraitIntelligent",invested:"PF2E.TraitInvested",light:"PF2E.TraitLight",magical:"PF2E.TraitMagical",mechanical:"PF2E.TraitMechanical",mental:"PF2E.TraitMental",misfortune:"PF2E.TraitMisfortune",morph:"PF2E.TraitMorph",mounted:"PF2E.TraitMounted",mythic:"PF2E.TraitMythic",nonlethal:"PF2E.TraitNonlethal",plant:"PF2E.TraitPlant",poison:"PF2E.TraitPoison",polymorph:"PF2E.TraitPolymorph",portable:"PF2E.TraitPortable",precious:"PF2E.TraitPrecious",prediction:"PF2E.TraitPrediction",relic:"PF2E.TraitRelic",revelation:"PF2E.TraitRevelation",saggorak:"PF2E.TraitSaggorak",scrying:"PF2E.TraitScrying",shadow:"PF2E.TraitShadow",sleep:"PF2E.TraitSleep",spellgun:"PF2E.TraitSpellgun",spellheart:"PF2E.TraitSpellheart",spirit:"PF2E.TraitSpirit",staff:"PF2E.TraitStaff",steam:"PF2E.TraitSteam",structure:"PF2E.TraitStructure",tattoo:"PF2E.TraitTattoo",tech:"PF2E.TraitTech",teleportation:"PF2E.TraitTeleportation",visual:"PF2E.TraitVisual",wand:"PF2E.TraitWand"},shieldTraits={...sanctificationTraits,...damageTraits,...magicTraditions,alchemical:"PF2E.TraitAlchemical",analog:"PF2E.TraitAnalog",apex:"PF2E.TraitApex",artifact:"PF2E.TraitArtifact",aura:"PF2E.TraitAura","deflecting-bludgeoning":"PF2E.TraitDeflectingBludgeoning","deflecting-physical-ranged":"PF2E.TraitDeflectingPhysicalRanged","deflecting-piercing":"PF2E.TraitDeflectingPiercing","deflecting-slashing":"PF2E.TraitDeflectingSlashing",foldaway:"PF2E.TraitFoldaway",harnessed:"PF2E.TraitHarnessed","hefty-2":"PF2E.TraitHefty2",inscribed:"PF2E.TraitInscribed","integrated-1d6-b":"PF2E.TraitIntegrated1d6B","integrated-1d6-p":"PF2E.TraitIntegrated1d6P","integrated-1d6-s":"PF2E.TraitIntegrated1d6S","integrated-1d6-s-versatile-p":"PF2E.TraitIntegrated1d6SVersatileP",invested:"PF2E.TraitInvested","launching-dart":"PF2E.TraitLaunching",magical:"PF2E.TraitMagical",mythic:"PF2E.TraitMythic",relic:"PF2E.TraitRelic","shield-throw-20":"PF2E.TraitShieldThrow20","shield-throw-30":"PF2E.TraitShieldThrow30",tech:"PF2E.TraitTech"},armorTraits={...sanctificationTraits,...damageTraits,...magicTraditions,adjusted:"PF2E.TraitAdjusted",alchemical:"PF2E.TraitAlchemical",analog:"PF2E.TraitAnalog",apex:"PF2E.TraitApex",aquadynamic:"PF2E.TraitAquadynamic",artifact:"PF2E.TraitArtifact",auditory:"PF2E.TraitAuditory",aura:"PF2E.TraitAura",barding:"PF2E.TraitBarding",bulwark:"PF2E.TraitBulwark",clockwork:"PF2E.TraitClockwork",comfort:"PF2E.TraitComfort",companion:"PF2E.TraitCompanion",cursed:"PF2E.TraitCursed","entrench-melee":"PF2E.TraitEntrenchMelee","entrench-ranged":"PF2E.TraitEntrenchRanged",extradimensional:"PF2E.TraitExtradimensional",flexible:"PF2E.TraitFlexible",focused:"PF2E.TraitFocused",force:"PF2E.TraitForce",healing:"PF2E.TraitHealing",hindering:"PF2E.TraitHindering",illusion:"PF2E.TraitIllusion",inscribed:"PF2E.TraitInscribed",intelligent:"PF2E.TraitIntelligent",invested:"PF2E.TraitInvested",laminar:"PF2E.TraitLaminar",light:"PF2E.TraitLight",magical:"PF2E.TraitMagical",mythic:"PF2E.TraitMythic",noisy:"PF2E.TraitNoisy",plant:"PF2E.TraitPlant",ponderous:"PF2E.TraitPonderous",relic:"PF2E.TraitRelic","resilient-1":"PF2E.TraitResilient1","resilient-2":"PF2E.TraitResilient2","resilient-3":"PF2E.TraitResilient3",tech:"PF2E.TraitTech"},kingmakerTraits={...actionTraits,army:"PF2E.Kingmaker.Trait.army",cavalry:"PF2E.Kingmaker.Trait.cavalry",civic:"PF2E.Kingmaker.Trait.civic",commerce:"PF2E.Kingmaker.Trait.commerce",infantry:"PF2E.Kingmaker.Trait.infantry",kingdom:"PF2E.Kingmaker.Trait.kingdom",leadership:"PF2E.Kingmaker.Trait.leadership",maneuver:"PF2E.Kingmaker.Trait.maneuver",morale:"PF2E.Kingmaker.Trait.morale",region:"PF2E.Kingmaker.Trait.region",siege:"PF2E.Kingmaker.Trait.siege",skirmisher:"PF2E.Kingmaker.Trait.skirmisher",upkeep:"PF2E.Kingmaker.Trait.upkeep"},kingmakerDescriptions={cavalry:"PF2E.Kingmaker.TraitDescription.cavalry",infantry:"PF2E.Kingmaker.TraitDescription.infantry",siege:"PF2E.Kingmaker.TraitDescription.siege",skirmisher:"PF2E.Kingmaker.TraitDescription.skirmisher"},preciousMaterialDescriptions={abysium:"PF2E.PreciousMaterialAbysiumDescription",adamantine:"PF2E.PreciousMaterialAdamantineDescription","cold-iron":"PF2E.PreciousMaterialColdIronDescription",duskwood:"PF2E.PreciousMaterialDuskwoodDescription",djezet:"PF2E.PreciousMaterialDjezetDescription",dragonhide:"PF2E.PreciousMaterialDragonhideDescription",dreamweb:"PF2E.PreciousMaterialDreamwebDescription","grisantian-pelt":"PF2E.PreciousMaterialGrisantianPeltDescription",inubrix:"PF2E.PreciousMaterialInubrixDescription",dawnsilver:"PF2E.PreciousMaterialDawnsilverDescription",noqual:"PF2E.PreciousMaterialNoqualDescription",orichalcum:"PF2E.PreciousMaterialOrichalcumDescription",siccatite:"PF2E.PreciousMaterialSiccatiteDescription",silver:"PF2E.PreciousMaterialSilverDescription",sisterstone:"PF2E.PreciousMaterialSisterstoneDescription","sisterstone-dusk":"PF2E.PreciousMaterialSisterstoneDescription","sisterstone-scarlet":"PF2E.PreciousMaterialSisterstoneDescription",sloughstone:"PF2E.PreciousMaterialSloughstoneDescription","sovereign-steel":"PF2E.PreciousMaterialSovereignSteelDescription",warpglass:"PF2E.PreciousMaterialWarpglassDescription"},traitDescriptions={...kingmakerDescriptions,aasimar:"PF2E.TraitDescriptionAasimar",aberration:"PF2E.TraitDescriptionAberration",abjuration:"PF2E.TraitDescriptionAbjuration",acid:"PF2E.TraitDescriptionAcid",additive:"PF2E.TraitDescriptionAdditive",additive0:"PF2E.TraitDescriptionAdditive",additive1:"PF2E.TraitDescriptionAdditive",additive2:"PF2E.TraitDescriptionAdditive",additive3:"PF2E.TraitDescriptionAdditive",adjusted:"PF2E.TraitDescriptionAdjusted",adjustment:"PF2E.TraitDescriptionAdjustment",aeon:"PF2E.TraitDescriptionAeon",aesir:"PF2E.TraitDescriptionAesir",aftermath:"PF2E.TraitDescriptionAftermath",agathion:"PF2E.TraitDescriptionAgathion",agile:"PF2E.TraitDescriptionAgile",air:"PF2E.TraitDescriptionAir",aiuvarin:"PF2E.TraitDescriptionAiuvarin",alchemical:"PF2E.TraitDescriptionAlchemical",alchemist:"PF2E.TraitDescriptionAlchemist",amphibious:"PF2E.TraitDescriptionAmphibious",anadi:"PF2E.TraitDescriptionAnadi",analog:"PF2E.TraitDescriptionAnalog",android:"PF2E.TraitDescriptionAndroid",angel:"PF2E.TraitDescriptionAngel",animal:"PF2E.TraitDescriptionAnimal",animist:"PF2E.TraitDescriptionAnimist",apex:"PF2E.TraitDescriptionApex",aphorite:"PF2E.TraitDescriptionAphorite",apparition:"PF2E.TraitDescriptionApparition",aquadynamic:"PF2E.TraitDescriptionAquadynamic",aquatic:"PF2E.TraitDescriptionAquatic",arcane:"PF2E.TraitDescriptionArcane",archetype:"PF2E.TraitDescriptionArchetype",archon:"PF2E.TraitDescriptionArchon",ardande:"PF2E.TraitDescriptionArdande",astral:"PF2E.TraitDescriptionAstral",asura:"PF2E.TraitDescriptionAsura",artifact:"PF2E.TraitDescriptionArtifact",athamaru:"PF2E.TraitDescriptionAthamaru",attached:"PF2E.TraitDescriptionAttached","attached-to-crossbow-or-firearm":"PF2E.TraitDescriptionAttached","attached-to-shield":"PF2E.TraitDescriptionAttached",attack:"PF2E.TraitDescriptionAttack",auditory:"PF2E.TraitDescriptionAuditory",aura:"PF2E.TraitDescriptionAura",automaton:"PF2E.TraitDescriptionAutomaton","awakened-animal":"PF2E.TraitDescriptionAwakenedAnimal",azarketi:"PF2E.TraitDescriptionAzarketi",azata:"PF2E.TraitDescriptionAzata",backstabber:"PF2E.TraitDescriptionBackstabber",backswing:"PF2E.TraitDescriptionBackswing",barbarian:"PF2E.TraitDescriptionBarbarian",bard:"PF2E.TraitDescriptionBard",beast:"PF2E.TraitDescriptionBeast",beastkin:"PF2E.TraitDescriptionBeastkin",blight:"PF2E.TraitDescriptionBlight",boggard:"PF2E.TraitDescriptionBoggard",bomb:"PF2E.TraitDescriptionBomb","bottled-breath":"PF2E.TraitDescriptionBottledBreath",brace:"PF2E.TraitDescriptionBrace",brutal:"PF2E.TraitDescriptionBrutal",bugbear:"PF2E.TraitDescriptionBugbear",bulwark:"PF2E.TraitDescriptionBulwark",bravado:"PF2E.TraitDescriptionBravado",caligni:"PF2E.TraitDescriptionCaligni",calling:"PF2E.TraitDescriptionCalling",cantrip:"PF2E.TraitDescriptionCantrip","capacity-2":"PF2E.TraitDescriptionCapacity","capacity-3":"PF2E.TraitDescriptionCapacity","capacity-4":"PF2E.TraitDescriptionCapacity","capacity-5":"PF2E.TraitDescriptionCapacity",catalyst:"PF2E.TraitDescriptionCatalyst",celestial:"PF2E.TraitDescriptionCelestial",catfolk:"PF2E.TraitDescriptionCatfolk",censer:"PF2E.TraitDescriptionCenser",centaur:"PF2E.TraitDescriptionCentaur","certain-kill":"PF2E.TraitDescriptionCertainKill",champion:"PF2E.TraitDescriptionChampion",changeling:"PF2E.TraitDescriptionChangeling","charau-ka":"PF2E.TraitDescriptionCharauKa",class:"PF2E.TraitDescriptionClass",cleric:"PF2E.TraitDescriptionCleric",climbing:"PF2E.TraitDescriptionClimbing",clockwork:"PF2E.TraitDescriptionClockwork",coatl:"PF2E.TraitDescriptionCoatl",cobbled:"PF2E.TraitDescriptionCobbled",coagulant:"PF2E.TraitDescriptionCoagulant",coda:"PF2E.TraitDescriptionCoda",cold:"PF2E.TraitDescriptionCold",combination:"PF2E.TraitDescriptionCombination",comfort:"PF2E.TraitDescriptionComfort",common:"PF2E.TraitDescriptionCommon",companion:"PF2E.TraitDescriptionCompanion",complex:"PF2E.TraitDescriptionComplex",composite:"PF2E.TraitDescriptionComposite",composition:"PF2E.TraitDescriptionComposition",concealable:"PF2E.TraitDescriptionConcealable",concentrate:"PF2E.TraitDescriptionConcentrate",concussive:"PF2E.TraitDescriptionConcussive",conrasu:"PF2E.TraitDescriptionConrasu",consecration:"PF2E.TraitDescriptionConsecration",construct:"PF2E.TraitDescriptionConstruct",consumable:"PF2E.TraitDescriptionConsumable",contact:"PF2E.TraitDescriptionContact",contingency:"PF2E.TraitDescriptionContingency",contract:"PF2E.TraitDescriptionContract","critical-fusion":"PF2E.TraitDescriptionCriticalFusion",curse:"PF2E.TraitDescriptionCurse",cursebound:"PF2E.TraitDescriptionCursebound",cursed:"PF2E.TraitDescriptionCursed",daemon:"PF2E.TraitDescriptionDaemon",darkness:"PF2E.TraitDescriptionDarkness",darvakka:"PF2E.TraitDescriptionDarvakka","deadly-2d10":"PF2E.TraitDescriptionDeadly","deadly-2d12":"PF2E.TraitDescriptionDeadly","deadly-2d8":"PF2E.TraitDescriptionDeadly","deadly-3d10":"PF2E.TraitDescriptionDeadly","deadly-3d12":"PF2E.TraitDescriptionDeadly","deadly-3d8":"PF2E.TraitDescriptionDeadly","deadly-4d10":"PF2E.TraitDescriptionDeadly","deadly-4d12":"PF2E.TraitDescriptionDeadly","deadly-4d8":"PF2E.TraitDescriptionDeadly","deadly-d10":"PF2E.TraitDescriptionDeadly","deadly-d12":"PF2E.TraitDescriptionDeadly","deadly-d6":"PF2E.TraitDescriptionDeadly","deadly-d8":"PF2E.TraitDescriptionDeadly","deadly-d4":"PF2E.TraitDescriptionDeadly",death:"PF2E.TraitDescriptionDeath","deflecting-bludgeoning":"PF2E.TraitDescriptionDeflecting","deflecting-physical-ranged":"PF2E.TraitDescriptionDeflecting","deflecting-slashing":"PF2E.TraitDescriptionDeflecting",dedication:"PF2E.TraitDescriptionDedication",demon:"PF2E.TraitDescriptionDemon",dero:"PF2E.TraitDescriptionDero",destiny:"PF2E.TraitDescriptionDestiny",detection:"PF2E.TraitDescriptionDetection",deviant:"PF2E.TraitDescriptionDeviant",devil:"PF2E.TraitDescriptionDevil",dhampir:"PF2E.TraitDescriptionDhampir",dinosaur:"PF2E.TraitDescriptionDinosaur",disarm:"PF2E.TraitDescriptionDisarm",disease:"PF2E.TraitDescriptionDisease",divination:"PF2E.TraitDescriptionDivination",div:"PF2E.TraitDescriptionDiv",divine:"PF2E.TraitDescriptionDivine","double-barrel":"PF2E.TraitDescriptionDoubleBarrel",downtime:"PF2E.TraitDescriptionDowntime",dragon:"PF2E.TraitDescriptionDragon",dragonblood:"PF2E.TraitDescriptionDragonblood",dragonet:"PF2E.TraitDescriptionDragonet",dream:"PF2E.TraitDescriptionDream",dromaar:"PF2E.TraitDescriptionDromaar",drug:"PF2E.TraitDescriptionDrug",druid:"PF2E.TraitDescriptionDruid",duskwalker:"PF2E.TraitDescriptionDuskwalker",dwarf:"PF2E.TraitDescriptionDwarf",earth:"PF2E.TraitDescriptionEarth",eidolon:"PF2E.TraitDescriptionEidolon",electricity:"PF2E.TraitDescriptionElectricity",elemental:"PF2E.TraitDescriptionElemental",elf:"PF2E.TraitDescriptionElf",elixir:"PF2E.TraitDescriptionElixir",emotion:"PF2E.TraitDescriptionEmotion","entrench-melee":"PF2E.TraitDescriptionEntrench","entrench-ranged":"PF2E.TraitDescriptionEntrench",environmental:"PF2E.TraitDescriptionEnvironmental",esoterica:"PF2E.TraitDescriptionEsoterica",ethereal:"PF2E.TraitDescriptionEthereal",evolution:"PF2E.TraitDescriptionEvolution",exemplar:"PF2E.TraitDescriptionExemplar",expandable:"PF2E.TraitDescriptionExpandable",experiment:"PF2E.TraitDescriptionExperiment",exploration:"PF2E.TraitDescriptionExploration",extradimensional:"PF2E.TraitDescriptionExtradimensional","fatal-aim-d10":"PF2E.TraitDescriptionFatalAim","fatal-aim-d12":"PF2E.TraitDescriptionFatalAim","fatal-d10":"PF2E.TraitDescriptionFatal","fatal-d12":"PF2E.TraitDescriptionFatal","fatal-d8":"PF2E.TraitDescriptionFatal",fear:"PF2E.TraitDescriptionFear",fetchling:"PF2E.TraitDescriptionFetchling",fey:"PF2E.TraitDescriptionFey",fiend:"PF2E.TraitDescriptionFiend",fighter:"PF2E.TraitDescriptionFighter",figurehead:"PF2E.TraitDescriptionFigurehead",finesse:"PF2E.TraitDescriptionFinesse",finisher:"PF2E.TraitDescriptionFinisher",fire:"PF2E.TraitDescriptionFire",fleshwarp:"PF2E.TraitDescriptionFleshwarp",flexible:"PF2E.TraitDescriptionFlexible",flourish:"PF2E.TraitDescriptionFlourish",focus:"PF2E.TraitDescriptionFocus",focused:"PF2E.TraitDescriptionFocused",foldaway:"PF2E.TraitDescriptionFoldaway",force:"PF2E.TraitDescriptionForce",forceful:"PF2E.TraitDescriptionForceful",fortune:"PF2E.TraitDescriptionFortune","free-hand":"PF2E.TraitDescriptionFreeHand",fulu:"PF2E.TraitDescriptionFulu",fungus:"PF2E.TraitDescriptionFungus",gadget:"PF2E.TraitDescriptionGadget",ganzi:"PF2E.TraitDescriptionGanzi",graft:"PF2E.TraitDescriptionGraft",general:"PF2E.TraitDescriptionGeneral",genie:"PF2E.TraitDescriptionGenie",geniekin:"PF2E.TraitDescriptionGeniekin",ghoran:"PF2E.TraitDescriptionGhoran",ghost:"PF2E.TraitDescriptionGhost",ghoul:"PF2E.TraitDescriptionGhoul",ghul:"PF2E.TraitDescriptionGhul",giant:"PF2E.TraitDescriptionGiant",girtablilu:"PF2E.TraitDescriptionGirtablilu",gnoll:"PF2E.TraitDescriptionGnoll",gnome:"PF2E.TraitDescriptionGnome",goblin:"PF2E.TraitDescriptionGoblin",goloma:"PF2E.TraitDescriptionGoloma",grapple:"PF2E.TraitDescriptionGrapple",gremlin:"PF2E.TraitDescriptionGremlin",grimoire:"PF2E.TraitDescriptionGrimoire",grippli:"PF2E.TraitDescriptionGrippli",grioth:"PF2E.TraitDescriptionGrioth",gunslinger:"PF2E.TraitDescriptionGunslinger",hag:"PF2E.TraitDescriptionHag",halfling:"PF2E.TraitDescriptionHalfling","jousting-d4":"PF2E.TraitDescriptionJousting","jousting-d6":"PF2E.TraitDescriptionJousting","jousting-d8":"PF2E.TraitDescriptionJousting","jousting-d10":"PF2E.TraitDescriptionJousting",hampering:"PF2E.TraitDescriptionHampering",harnessed:"PF2E.TraitDescriptionHarnessed",haunt:"PF2E.TraitDescriptionHaunt",healing:"PF2E.TraitDescriptionHealing","hefty-14":"PF2E.TraitDescriptionHefty",herald:"PF2E.TraitDescriptionHerald",hex:"PF2E.TraitDescriptionHex",hindering:"PF2E.TraitDescriptionHindering",hobgoblin:"PF2E.TraitDescriptionHobgoblin",holy:"PF2E.TraitDescriptionHoly",hryngar:"PF2E.TraitDescriptionHryngar",human:"PF2E.TraitDescriptionHuman",humanoid:"PF2E.TraitDescriptionHumanoid",naari:"PF2E.TraitDescriptionNaari",nightmare:"PF2E.TraitDescriptionNightmare",ikon:"PF2E.TraitDescriptionIkon",illusion:"PF2E.TraitDescriptionIllusion",impulse:"PF2E.TraitDescriptionImpulse",incapacitation:"PF2E.TraitDescriptionIncapacitation",incarnate:"PF2E.TraitDescriptionIncarnate",incorporeal:"PF2E.TraitDescriptionIncorporeal",inevitable:"PF2E.TraitDescriptionInevitable",infused:"PF2E.TraitDescriptionInfused",infusion:"PF2E.TraitDescriptionInfusion",ingested:"PF2E.TraitDescriptionIngested",inhaled:"PF2E.TraitDescriptionInhaled",injection:"PF2E.TraitDescriptionInjection",injury:"PF2E.TraitDescriptionInjury",inscribed:"PF2E.TraitDescriptionInscribed","integrated-1d6-b":"PF2E.TraitDescriptionIntegrated","integrated-1d6-p":"PF2E.TraitDescriptionIntegrated","integrated-1d6-s":"PF2E.TraitDescriptionIntegrated","integrated-1d6-s-versatile-p":"PF2E.TraitDescriptionIntegrated",intelligent:"PF2E.TraitDescriptionIntelligent",inventor:"PF2E.TraitDescriptionInventor",invested:"PF2E.TraitDescriptionInvested",investigator:"PF2E.TraitDescriptionInvestigator",kami:"PF2E.TraitDescriptionKami",kashrishi:"PF2E.TraitDescriptionKashrishi","keep-stone":"PF2E.PreciousMaterialKeepStoneDescription",kholo:"PF2E.TraitDescriptionKholo",kickback:"PF2E.TraitDescriptionKickback",kineticist:"PF2E.TraitDescriptionKineticist",kitsune:"PF2E.TraitDescriptionKitsune",kobold:"PF2E.TraitDescriptionKobold",kovintus:"PF2E.TraitDescriptionKovintus",laminar:"PF2E.TraitDescriptionLaminar","launching-dart":"PF2E.TraitDescriptionLaunching",leshy:"PF2E.TraitDescriptionLeshy",light:"PF2E.TraitDescriptionLight",linguistic:"PF2E.TraitDescriptionLinguistic",litany:"PF2E.TraitDescriptionLitany",lizardfolk:"PF2E.TraitDescriptionLizardfolk",lozenge:"PF2E.TraitDescriptionLozenge",maftet:"PF2E.TraitDescriptionMaftet",magical:"PF2E.TraitDescriptionMagical",magus:"PF2E.TraitDescriptionMagus",manipulate:"PF2E.TraitDescriptionManipulate",mechanical:"PF2E.TraitDescriptionMechanical",mental:"PF2E.TraitDescriptionMental",merfolk:"PF2E.TraitDescriptionMerfolk",metal:"PF2E.TraitDescriptionMetal",mindless:"PF2E.TraitDescriptionMindless",mindshift:"PF2E.TraitDescriptionMindshift",minion:"PF2E.TraitDescriptionMinion",minotaur:"PF2E.TraitDescriptionMinotaur",misfortune:"PF2E.TraitDescriptionMisfortune",missive:"PF2E.TraitDescriptionMissive",modification:"PF2E.TraitDescriptionModification",modular:"PF2E.TraitDescriptionModular",monitor:"PF2E.TraitDescriptionMonitor",monk:"PF2E.TraitDescriptionMonk",morlock:"PF2E.TraitDescriptionMorlock",morph:"PF2E.TraitDescriptionMorph",mortic:"PF2E.TraitDescriptionMortic",mounted:"PF2E.TraitDescriptionMounted",move:"PF2E.TraitDescriptionMove",multiclass:"PF2E.TraitDescriptionMulticlass",mummy:"PF2E.TraitDescriptionMummy",munavri:"PF2E.TraitDescriptionMunavri",mutagen:"PF2E.TraitDescriptionMutagen",mutant:"PF2E.TraitDescriptionMutant",mythic:"PF2E.TraitDescriptionMythic",nagaji:"PF2E.TraitDescriptionNagaji",nephilim:"PF2E.TraitDescriptionNephilim",nindoru:"PF2E.TraitDescriptionNindoru",noisy:"PF2E.TraitDescriptionNoisy",nonlethal:"PF2E.TraitDescriptionNonlethal",nymph:"PF2E.TraitDescriptionNymph",oath:"PF2E.TraitDescriptionOath",occult:"PF2E.TraitDescriptionOccult",oil:"PF2E.TraitDescriptionOil",olfactory:"PF2E.TraitDescriptionOlfactory",oni:"PF2E.TraitDescriptionOni",ooze:"PF2E.TraitDescriptionOoze",oracle:"PF2E.TraitDescriptionOracle",orc:"PF2E.TraitDescriptionOrc",oread:"PF2E.TraitDescriptionOread",overflow:"PF2E.TraitDescriptionOverflow",paaridar:"PF2E.TraitDescriptionPaaridar",palinthanos:"PF2E.TraitDescriptionPalinthanos",parry:"PF2E.TraitDescriptionParry",peachwood:"PF2E.PreciousMaterialPeachwoodDescription","persona-flirt":"PF2E.TraitPersonaFlirtDescription","persona-guardian":"PF2E.TraitPersonaGuardianDescription","persona-leader":"PF2E.TraitPersonaLeaderDescription","persona-scholar":"PF2E.TraitPersonaScholarDescription","persona-scoundrel":"PF2E.TraitPersonaScoundrelDescription","persona-underdog":"PF2E.TraitPersonaUnderdogDescription","persona-warrior":"PF2E.TraitPersonaWarriorDescription","persona-wildcard":"PF2E.TraitPersonaWildcardDescription",phantom:"PF2E.TraitDescriptionPhantom",plant:"PF2E.TraitDescriptionPlant",poison:"PF2E.TraitDescriptionPoison",polymorph:"PF2E.TraitDescriptionPolymorph",ponderous:"PF2E.TraitDescriptionPonderous",poppet:"PF2E.TraitDescriptionPoppet",portable:"PF2E.TraitDescriptionPortable",possession:"PF2E.TraitDescriptionPossession",potion:"PF2E.TraitDescriptionPotion",precious:"PF2E.TraitDescriptionPrecious",prediction:"PF2E.TraitDescriptionPrediction",processed:"PF2E.TraitDescriptionProcessed",press:"PF2E.TraitDescriptionPress",primal:"PF2E.TraitDescriptionPrimal",propulsive:"PF2E.TraitDescriptionPropulsive",protean:"PF2E.TraitDescriptionProtean",psyche:"PF2E.TraitDescriptionPsyche",psychic:"PF2E.TraitDescriptionPsychic",psychopomp:"PF2E.TraitDescriptionPsychopomp",qlippoth:"PF2E.TraitDescriptionQlippoth",radiation:"PF2E.TraitDescriptionRadiation",rage:"PF2E.TraitDescriptionRage",akshasa:"PF2E.TraitDescriptionRakshasa",ranger:"PF2E.TraitDescriptionRanger","ranged-trip":"PF2E.TraitDescriptionRangedTrip",rare:"PF2E.TraitDescriptionRare",ratfolk:"PF2E.TraitDescriptionRatfolk",razing:"PF2E.TraitDescriptionRazing",reach:"PF2E.TraitDescriptionReach","reach-0":"PF2E.TraitDescriptionReach","reach-10":"PF2E.TraitDescriptionReach","reach-100":"PF2E.TraitDescriptionReach","reach-120":"PF2E.TraitDescriptionReach","reach-1000":"PF2E.TraitDescriptionReach","reach-15":"PF2E.TraitDescriptionReach","reach-20":"PF2E.TraitDescriptionReach","reach-200":"PF2E.TraitDescriptionReach","reach-25":"PF2E.TraitDescriptionReach","reach-30":"PF2E.TraitDescriptionReach","reach-40":"PF2E.TraitDescriptionReach","reach-50":"PF2E.TraitDescriptionReach","reach-60":"PF2E.TraitDescriptionReach",recovery:"PF2E.TraitDescriptionRecovery",reincarnated:"PF2E.TraitDescriptionReincarnated",reflection:"PF2E.TraitDescriptionReflection",relic:"PF2E.TraitDescriptionRelic",reload:"PF2E.TraitDescriptionReload","reload-0":"PF2E.TraitDescriptionReload","reload-1":"PF2E.TraitDescriptionReload","reload-1-min":"PF2E.TraitDescriptionReload","reload-2":"PF2E.TraitDescriptionReload",repeating:"PF2E.TraitDescriptionRepeating",resonant:"PF2E.TraitDescriptionResonant",revelation:"PF2E.TraitDescriptionRevelation",rogue:"PF2E.TraitDescriptionRogue",saggorak:"PF2E.TraitDescriptionSaggorak",sahkil:"PF2E.TraitDescriptionSahkil",samsaran:"PF2E.TraitDescriptionSamsaran",sanctified:"PF2E.TraitDescriptionSanctified","scatter-10":"PF2E.TraitDescriptionScatter","scatter-15":"PF2E.TraitDescriptionScatter","scatter-20":"PF2E.TraitDescriptionScatter","scatter-5":"PF2E.TraitDescriptionScatter",scroll:"PF2E.TraitDescriptionScroll",scrying:"PF2E.TraitDescriptionScrying","sea-devil":"PF2E.TraitDescriptionSeaDevil",secret:"PF2E.TraitDescriptionSecret",sedacthy:"PF2E.TraitDescriptionSedacthy",serpentfolk:"PF2E.TraitDescriptionSerpentfolk",shabti:"PF2E.TraitDescriptionShabti",shadow:"PF2E.TraitDescriptionShadow","shield-throw-20":"PF2E.TraitDescriptionShieldThrow","shield-throw-30":"PF2E.TraitDescriptionShieldThrow",shisk:"PF2E.TraitDescriptionShisk",shoony:"PF2E.TraitDescriptionShoony",shove:"PF2E.TraitDescriptionShove",skeleton:"PF2E.TraitDescriptionSkeleton",skelm:"PF2E.TraitDescriptionSkelm",skill:"PF2E.TraitDescriptionSkill",skulk:"PF2E.TraitDescriptionSkulk",sleep:"PF2E.TraitDescriptionSleep",snare:"PF2E.TraitDescriptionSnare",social:"PF2E.TraitDescriptionSocial",sonic:"PF2E.TraitDescriptionSonic",sorcerer:"PF2E.TraitDescriptionSorcerer",soulbound:"PF2E.TraitDescriptionSoulbound",spellgun:"PF2E.TraitDescriptionSpellgun",spellheart:"PF2E.TraitDescriptionSpellheart",spellshape:"PF2E.TraitDescriptionSpellshape",spellshot:"PF2E.TraitNoDescription",spirit:"PF2E.TraitDescriptionSpirit",splash:"PF2E.TraitDescriptionSplash","splash-10":"PF2E.TraitDescriptionSplash10",spriggan:"PF2E.TraitDescriptionSpriggan",sprite:"PF2E.TraitDescriptionSprite",staff:"PF2E.TraitDescriptionStaff",stance:"PF2E.TraitDescriptionStance",steam:"PF2E.TraitDescriptionSteam",stheno:"PF2E.TraitDescriptionStheno",strix:"PF2E.TraitDescriptionStrix",structure:"PF2E.TraitDescriptionStructure",subtle:"PF2E.TraitDescriptionSubtle",suli:"PF2E.TraitDescriptionSuli","subjective-gravity":"PF2E.TraitDescriptionSubjectiveGravity",summon:"PF2E.TraitDescriptionSummon",summoned:"PF2E.TraitDescriptionSummoned",summoner:"PF2E.TraitDescriptionSummoner",surki:"PF2E.TraitDescriptionSurki",swashbuckler:"PF2E.TraitDescriptionSwashbuckler",swarm:"PF2E.TraitDescriptionSwarm",sweep:"PF2E.TraitDescriptionSweep",sylph:"PF2E.TraitDescriptionSylph",talisman:"PF2E.TraitDescriptionTalisman",talos:"PF2E.TraitDescriptionTalos",tandem:"PF2E.TraitDescriptionTandem",tane:"PF2E.TraitDescriptionTane",tanggal:"PF2E.TraitDescriptionTanggal",tattoo:"PF2E.TraitDescriptionTattoo",tea:"PF2E.TraitDescriptionTea",tearing:"PF2E.TraitDescriptionTearing",tech:"PF2E.TraitDescriptionTech",telepathy:"PF2E.TraitDescriptionTelepathy",teleportation:"PF2E.TraitDescriptionTeleportation",tengu:"PF2E.TraitDescriptionTengu",tethered:"PF2E.TraitDescriptionTethered",thaumaturge:"PF2E.TraitDescriptionThaumaturge",thrown:"PF2E.TraitDescriptionThrown","thrown-10":"PF2E.TraitDescriptionThrown","thrown-100":"PF2E.TraitDescriptionThrown","thrown-15":"PF2E.TraitDescriptionThrown","thrown-20":"PF2E.TraitDescriptionThrown","thrown-200":"PF2E.TraitDescriptionThrown","thrown-25":"PF2E.TraitDescriptionThrown","thrown-30":"PF2E.TraitDescriptionThrown","thrown-40":"PF2E.TraitDescriptionThrown","thrown-50":"PF2E.TraitDescriptionThrown","thrown-60":"PF2E.TraitDescriptionThrown","thrown-80":"PF2E.TraitDescriptionThrown",tiefling:"PF2E.TraitDescriptionTiefling",time:"PF2E.TraitDescriptionTime",titan:"PF2E.TraitDescriptionTitan",training:"PF2E.TraitDescriptionTraining",transcendence:"PF2E.TraitDescriptionTranscendence",trap:"PF2E.TraitDescriptionTrap",trip:"PF2E.TraitDescriptionTrip",troll:"PF2E.TraitDescriptionTroll",troop:"PF2E.TraitDescriptionTroop","true-name":"PF2E.TraitDescriptionTrueName",twin:"PF2E.TraitDescriptionTwin","two-hand-d10":"PF2E.TraitDescriptionTwoHand","two-hand-d12":"PF2E.TraitDescriptionTwoHand","two-hand-d6":"PF2E.TraitDescriptionTwoHand","two-hand-d8":"PF2E.TraitDescriptionTwoHand",unarmed:"PF2E.TraitDescriptionUnarmed",uncommon:"PF2E.TraitDescriptionUncommon",undine:"PF2E.TraitDescriptionUndine",undead:"PF2E.TraitDescriptionUndead",unholy:"PF2E.TraitDescriptionUnholy",unique:"PF2E.TraitDescriptionUnique",unstable:"PF2E.TraitDescriptionUnstable",urdefhan:"PF2E.TraitDescriptionUrdefhan",vampire:"PF2E.TraitDescriptionVampire",vanara:"PF2E.TraitDescriptionVanara",vishkanya:"PF2E.TraitDescriptionVishkanya",vehicular:"PF2E.TraitDescriptionVehicular",velstrac:"PF2E.TraitDescriptionVelstrac",venomous:"PF2E.TraitDescriptionVenomous","versatile-acid":"PF2E.TraitDescriptionVersatile","versatile-b":"PF2E.TraitDescriptionVersatile","versatile-cold":"PF2E.TraitDescriptionVersatile","versatile-electricity":"PF2E.TraitDescriptionVersatile","versatile-fire":"PF2E.TraitDescriptionVersatile","versatile-force":"PF2E.TraitDescriptionVersatile","versatile-p":"PF2E.TraitDescriptionVersatile","versatile-poison":"PF2E.TraitDescriptionVersatile","versatile-s":"PF2E.TraitDescriptionVersatile","versatile-sonic":"PF2E.TraitDescriptionVersatile","versatile-spirit":"PF2E.TraitDescriptionVersatile","versatile-vitality":"PF2E.TraitDescriptionVersatile","versatile-void":"PF2E.TraitDescriptionVersatile",vigilante:"PF2E.TraitDescriptionVigilante",virulent:"PF2E.TraitDescriptionVirulent",visual:"PF2E.TraitDescriptionVisual",vitality:"PF2E.TraitDescriptionVitality",void:"PF2E.TraitDescriptionVoid","volley-20":"PF2E.TraitDescriptionVolley","volley-30":"PF2E.TraitDescriptionVolley","volley-50":"PF2E.TraitDescriptionVolley","volley-60":"PF2E.TraitDescriptionVolley",wand:"PF2E.TraitDescriptionWand",wandering:"PF2E.TraitDescriptionWandering",water:"PF2E.TraitDescriptionWater",wayang:"PF2E.TraitDescriptionWayang",werecreature:"PF2E.TraitDescriptionWerecreature",wight:"PF2E.TraitDescriptionWight",witch:"PF2E.TraitDescriptionWitch",wizard:"PF2E.TraitDescriptionWizard",wraith:"PF2E.TraitDescriptionWraith",wood:"PF2E.TraitDescriptionWood",wyrwood:"PF2E.TraitDescriptionWyrwood",xulgath:"PF2E.TraitDescriptionXulgath",zombie:"PF2E.TraitDescriptionZombie",...preciousMaterialDescriptions},toDelete=["featType","actionCategory","actions","actionType","level","location"];class Migration711HeritageItems extends MigrationBase{static{__name(this,"Migration711HeritageItems")}static{__name2(this,"Migration711HeritageItems")}static version=.711;#isHeritageFeature(feature){return feature.type==="feat"&&feature.system.featType?.value==="heritage"}#officialAncestries={tengu:{name:"Tengu",uuid:"Compendium.pf2e.ancestries.Item.18xDKYPDBLEv2myX"},kitsune:{name:"Kitsune",uuid:"Compendium.pf2e.ancestries.Item.4BL5wf1VF9feC2rY"},poppet:{name:"Poppet",uuid:"Compendium.pf2e.ancestries.Item.6F2fSFC1Eo1JdpY4"},kobold:{name:"Kobold",uuid:"Compendium.pf2e.ancestries.Item.7oQxL6wgsokD3QXG"},catfolk:{name:"Catfolk",uuid:"Compendium.pf2e.ancestries.Item.972EkpJOPv9KkQIW"},dwarf:{name:"Dwarf",uuid:"Compendium.pf2e.ancestries.Item.BYj5ZvlXZdpaEgA6"},gnome:{name:"Gnome",uuid:"Compendium.pf2e.ancestries.Item.CYlfsYLJcBOgqKtD"},fleshwarp:{name:"Fleshwarp",uuid:"Compendium.pf2e.ancestries.Item.FXlXmNBFiiz9oasi"},strix:{name:"Strix",uuid:"Compendium.pf2e.ancestries.Item.GXcC6oVa5quzgNHD"},android:{name:"Android",uuid:"Compendium.pf2e.ancestries.Item.GfLwE884NoRC7cRi"},halfling:{name:"Halfling",uuid:"Compendium.pf2e.ancestries.Item.GgZAHbrjnzWOZy2v"},lizardfolk:{name:"Lizardfolk",uuid:"Compendium.pf2e.ancestries.Item.HWEgF7Gmoq55VhTL"},human:{name:"Human",uuid:"Compendium.pf2e.ancestries.Item.IiG7DgeLWYrSNXuX"},ratfolk:{name:"Ratfolk",uuid:"Compendium.pf2e.ancestries.Item.P6PcVnCkh4XMdefw"},elf:{name:"Elf",uuid:"Compendium.pf2e.ancestries.Item.PgKmsA2aKdbLU6O0"},anadi:{name:"Anadi",uuid:"Compendium.pf2e.ancestries.Item.TQEqWqc7BYiadUdY"},sprite:{name:"Sprite",uuid:"Compendium.pf2e.ancestries.Item.TRqoeYfGAFjQbviF"},goloma:{name:"Goloma",uuid:"Compendium.pf2e.ancestries.Item.c4secsSNG2AO7I5i"},leshy:{name:"Leshy",uuid:"Compendium.pf2e.ancestries.Item.cdhgByGG1WtuaK73"},fetchling:{name:"Fetchling",uuid:"Compendium.pf2e.ancestries.Item.hIA3qiUsxvLZXrFP"},grippli:{name:"Grippli",uuid:"Compendium.pf2e.ancestries.Item.hXM5jXezIki1cMI2"},automaton:{name:"Automaton",uuid:"Compendium.pf2e.ancestries.Item.kYsBAJ103T44agJF"},orc:{name:"Orc",uuid:"Compendium.pf2e.ancestries.Item.lSGWXjcbOa6O5fTx"},hobgoblin:{name:"Hobgoblin",uuid:"Compendium.pf2e.ancestries.Item.piNLXUrm9iaGqD2i"},shoony:{name:"Shoony",uuid:"Compendium.pf2e.ancestries.Item.q6rsqYARyOGXZA8F"},goblin:{name:"Goblin",uuid:"Compendium.pf2e.ancestries.Item.sQfjTMDaZbT9DThq"},conrasu:{name:"Conrasu",uuid:"Compendium.pf2e.ancestries.Item.tZn4qIHCUA6wCdnI"},gnoll:{name:"Gnoll",uuid:"Compendium.pf2e.ancestries.Item.vxbQ1Yw4qwgjTzqo"},shisk:{name:"Shisk",uuid:"Compendium.pf2e.ancestries.Item.x1YinOddgUxwOLqP"},azarketi:{name:"Azarketi",uuid:"Compendium.pf2e.ancestries.Item.yFoojz6q3ZjvceFw"}};#heritagesWithoutAncestryInName={"half-elf":"human","half-orc":"human","skilled-heritage":"human","versatile-heritage":"human",draxie:"sprite",grig:"sprite",melixie:"sprite",nyktera:"sprite",pixie:"sprite","deep-rat":"ratfolk","desert-rat":"ratfolk","longsnout-rat":"ratfolk","sewer-rat":"ratfolk","shadow-rat":"ratfolk","snow-rat":"ratfolk","tunnel-rat":"ratfolk","rite-of-invocation":"conrasu","rite-of-knowing":"conrasu","rite-of-light":"conrasu","rite-of-passage":"conrasu","rite-of-reinforcement":"conrasu"};#ancestrySlugs=Object.keys(this.#officialAncestries);#heritageFromFeat(feature){const featureSlug=feature.system.slug??"",ancestrySlug=this.#heritagesWithoutAncestryInName[featureSlug]??this.#ancestrySlugs.find(s=>featureSlug.includes(s)),ancestryReference=this.#officialAncestries[ancestrySlug??""]??null,traits=feature.system.traits;return feature._stats.compendiumSource&&(feature._stats.compendiumSource=feature._stats.compendiumSource.replace("ancestryfeatures","heritages")),{_id:foundry.utils.randomID(),type:"heritage",img:feature.img.endsWith("/feat.svg")?"systems/pf2e/icons/default-icons/heritage.svg":feature.img,name:feature.name,effects:[],folder:feature.folder,flags:feature.flags,sort:feature.sort,ownership:feature.ownership,system:{description:feature.system.description,rules:feature.system.rules,schema:feature.system.schema,_migration:{version:null,previous:null},slug:feature.system.slug,ancestry:ancestryReference,traits:{value:traits.value.filter(t2=>(t2 in creatureTraits||t2.startsWith("hb_"))&&!(t2 in this.#officialAncestries)),rarity:traits.rarity,otherTags:[]}}}}async updateActor(actorSource){const heritageFeatures=actorSource.items.filter(i=>this.#isHeritageFeature(i)),firstHeritageFeature=heritageFeatures[0];if(!actorSource.items.some(i=>i.type==="heritage")&&firstHeritageFeature&&actorSource.type==="character"){const heritageSource=this.#heritageFromFeat(firstHeritageFeature);actorSource.items.push(heritageSource);const details=actorSource.system.details;details.heritage&&(details["-=heritage"]=null,"game"in globalThis||delete details.heritage)}for(const feature of heritageFeatures)actorSource.items.splice(actorSource.items.indexOf(feature),1)}async updateItem(itemSource,actorSource){if(actorSource||!this.#isHeritageFeature(itemSource))return;const newSource=itemSource;newSource.type="heritage",itemSource.img==="systems/pf2e/icons/default-icons/feat.svg"&&(itemSource.img="systems/pf2e/icons/default-icons/heritage.svg");const newSystemData=this.#heritageFromFeat(itemSource).system,deletionProperties=toDelete.map(k=>`-=${k}`);for(const property of deletionProperties)newSystemData[property]=null;if(!("game"in globalThis))for(const property of toDelete)delete newSystemData[property];newSource.system=newSystemData}}class Migration712ActorShieldStructure extends MigrationBase{static{__name(this,"Migration712ActorShieldStructure")}static{__name2(this,"Migration712ActorShieldStructure")}static version=.712;async updateActor(source2){if(source2.type==="character"||source2.type==="npc"){const attributes=source2.system.attributes;attributes.shield&&(attributes["-=shield"]=null,"game"in globalThis?attributes.shield={}:delete attributes.shield)}}}class Migration713FistToStrikeRE extends MigrationBase{static{__name(this,"Migration713FistToStrikeRE")}static{__name2(this,"Migration713FistToStrikeRE")}static version=.713;async updateItem(itemSource){const fistFeatures=["powerful-fist","martial-artist-dedication"];if(!(itemSource.type==="feat"&&fistFeatures.includes(itemSource.system.slug))||itemSource.system.rules.some(rule=>rule.key==="Strike"))return;const strike={key:"Strike",img:"systems/pf2e/icons/features/classes/powerful-fist.webp",slug:"fist",category:"unarmed",damage:{base:{damageType:"bludgeoning",dice:1,die:"d6"}},group:"brawling",label:"PF2E.Strike.Fist.Label",range:null,traits:["agile","finesse","nonlethal","unarmed"]};itemSource.system.rules=[strike]}}class Migration714RangeIncrementREs extends MigrationBase{static{__name(this,"Migration714RangeIncrementREs")}static{__name2(this,"Migration714RangeIncrementREs")}static version=.714;farLobber={definition:{all:["weapon:base:alchemical-bomb"]},key:"AdjustStrike",mode:"upgrade",property:"range-increment",value:30};farShot={definition:{all:["weapon:ranged"]},key:"AdjustStrike",mode:"multiply",property:"range-increment",value:2};farThrow={key:"AdjustModifier",mode:"add",predicate:{all:["weapon:trait:thrown"]},selectors:["ranged-attack-roll"],slug:"range-penalty",value:1};huntPrey={key:"RollOption",domain:"ranged-attack-roll",option:"ignore-range-penalty:2",predicate:{all:["hunted-prey"]}};legendaryShot={key:"RollOption",domain:"ranged-attack-roll",option:"ignore-range-penalty:5"};masterfulHunter={key:"RollOption",domain:"ranged-attack-roll",option:"ignore-range-penalty:3",predicate:{all:["hunted-prey",{gte:["weapon:proficiency:rank",3]}]}};shootistsEdge=[{key:"ActiveEffectLike",mode:"upgrade",path:"system.attributes.classDC.rank",value:3},{key:"RollOption",domain:"ranged-attack-roll",option:"ignore-range-penalty:3",phase:"beforeRoll",predicate:{all:[{gte:["weapon:proficiency:rank",3]}]}}];triangulate=[{default:!0,key:"ToggleProperty",label:"PF2E.SpecificRule.ToggleProperty.Triangulate",property:"flags.pf2e.rollOptions.all.triangulate"},{domain:"ranged-attack-roll",key:"RollOption",option:"ignore-range-penalty:2",predicate:{all:["triangulate"]}},{key:"AdjustModifier",mode:"add",predicate:{all:["triangulate"]},selectors:["ranged-attack-roll"],slug:"range-penalty",value:1}];uncannyBombs={definition:{all:["weapon:base:alchemical-bomb"]},key:"AdjustStrike",mode:"upgrade",property:"range-increment",value:60};unerringShot={key:"RollOption",option:"ignore-range-penalty",phase:"beforeRoll",predicate:{all:[{gte:["weapon:proficiency:rank",3]}]}};async updateItem(source2){const{rules}=source2.system;if(source2.type==="feat")switch(source2.system.slug){case"far-lobber":{source2.system.rules=[this.farLobber];return}case"far-shot":{source2.system.rules=[this.farShot];return}case"far-throw":{source2.system.rules=[this.farThrow];return}case"hunt-prey":{!rules.some(r2=>r2.key==="RollOption"&&r2.option===this.huntPrey.option)&&rules.push(this.huntPrey);return}case"legendary-shot":{source2.system.rules=[this.legendaryShot];return}case"masterful-hunter":{!rules.some(r2=>r2.key==="RollOption"&&r2.option===this.masterfulHunter.option)&&rules.push(this.masterfulHunter);return}case"shootists-edge":{source2.system.rules=this.shootistsEdge;return}case"triangulate":{source2.system.rules=this.triangulate;return}case"uncanny-bombs":{source2.system.rules=[this.uncannyBombs];return}case"unerring-shot":{source2.system.rules=[this.unerringShot];return}}}}class Migration715DangerousSorcery extends MigrationBase{static{__name(this,"Migration715DangerousSorcery")}static{__name2(this,"Migration715DangerousSorcery")}static version=.715;dangerousSorcery={key:"FlatModifier",phase:"afterDerived",predicate:{all:["item:spell-slot","item:duration:0","damaging-effect"]},selector:"spell-damage",value:"@spell.level"};async updateItem(source2){if(source2.type!=="feat")return;(source2.system.slug??sluggify(source2.name))==="dangerous-sorcery"&&!source2.system.rules.length&&(source2.system.rules=[this.dangerousSorcery])}}class Migration716StrikeDamageSelector extends MigrationBase{static{__name(this,"Migration716StrikeDamageSelector")}static{__name2(this,"Migration716StrikeDamageSelector")}static version=.716;itemsToSkip=new Set(["effect-fanatical-frenzy","effect-heroic-recovery","effect-lantern-of-hope","effect-lantern-of-hope-gestalt","spell-effect-inspire-courage","spell-effect-inspire-heroics-courage-2","spell-effect-inspire-heroics-courage-3","spell-effect-stoke-the-heart"]);async updateItem(source2){if(this.itemsToSkip.has(source2.system.slug??""))return;const rules=source2.system.rules;for(const rule of rules)e$2(rule)&&["damage","mundane-damage"].includes(String(rule.selector??""))&&(rule.selector="strike-damage")}}class Migration717TakeFeatLimits extends MigrationBase{static{__name(this,"Migration717TakeFeatLimits")}static{__name2(this,"Migration717TakeFeatLimits")}static version=.717;levelOneOnly=new Set(["celestial-eyes","chance-death","deliberate-death","elemental-eyes","eyes-of-the-night","fiendish-eyes","gravesight","willing-death"]);maxTakeable={"additional-lore":1/0,"advanced-domain":1/0,"advanced-general-training":1/0,"animal-senses":1/0,"animal-senses-darkvision":1/0,"animal-senses-low-light-vision":1/0,"animal-senses-scent-imprecise":1/0,"armor-proficiency":3,assurance:1/0,"automatic-knowledge":1/0,"blessing-of-the-sun-gods":1/0,"consult-the-spirits":1/0,"domain-initiate":1/0,"general-training":1/0,"greater-animal-senses":1/0,"greater-sun-blessing":1/0,"hellknight-order-cross-training":1/0,"living-weapon":1/0,"magic-arrow":1/0,"modular-dynamo":1/0,multilingual:1/0,"settlement-scholastics":1/0,"skill-training":1/0,"terrain-stalker":1/0};async updateItem(source2){if(source2.type!=="feat")return;const slug=source2.system.slug??"";source2.system.traits.value.includes("lineage")||this.levelOneOnly.has(slug)?source2.system.onlyLevel1=!0:"game"in globalThis&&(source2.system.onlyLevel1=!1),!source2.system.onlyLevel1&&slug in this.maxTakeable?source2.system.maxTakable=this.maxTakeable[slug]:"game"in globalThis&&(source2.system.maxTakable=1)}}function isEquipped(usage,equipped){return equipped.carryType==="dropped"?!1:usage.type==="carried"?!0:usage.type!==equipped.carryType||usage.type==="worn"&&usage.where&&!equipped.inSlot?!1:usage.type==="held"?(equipped.handsHeld??0)>=(usage.hands??1):!0}__name(isEquipped,"isEquipped"),__name2(isEquipped,"isEquipped");function getUsageDetails(usage){if(usage.startsWith("attached-to")){const where=usage.replace(/^attached-to-/,"");return{value:usage,type:"attached",where}}if(usage.startsWith("installed-in")){const where=usage.replace(/^installed-in-/,"");return{value:usage,type:"installed",where}}switch(usage){case"carried":case"":return{value:"carried",type:"carried"};case"held-in-one-hand":case"held-in-one-plus-hands":case"held-in-one-or-two-hands":return{value:usage,type:"held",hands:1};case"held-in-two-hands":return{value:usage,type:"held",hands:2};case"worn":return{value:usage,type:"worn"};case"implanted":return{value:usage,type:"implanted"};default:return usage.startsWith("worn")&&usage.length>4?{value:usage,type:"worn",where:usage.substring(4)}:{value:usage,type:"worn"}}}__name(getUsageDetails,"getUsageDetails"),__name2(getUsageDetails,"getUsageDetails");class Migration718CarryType extends MigrationBase{static{__name(this,"Migration718CarryType")}static{__name2(this,"Migration718CarryType")}static version=.718;async updateItem(source2,actor){if(!itemIsOfType(source2,"physical"))return;const system2=source2.system;if(system2.usage instanceof Object||(system2.usage={value:"held-in-one-hand"}),system2.usage.value==="worn-gloves")system2.usage.value="worngloves";else if(source2.type==="armor"){const category=source2.system.category;system2.usage.value=category==="shield"?"held-in-one-hand":"wornarmor"}else source2.type==="equipment"&&system2.slug?.startsWith("clothing-")&&(system2.usage.value="worn");if("game"in globalThis||actor)system2.equipped??={carryType:"worn"},system2.equipped.carryType??="worn";else{delete system2.equipped;return}const equipped=system2.equipped;if(!("value"in equipped))return;if(!(actor&&["character","npc"].includes(actor.type??""))){equipped["-=value"]=null,delete equipped.value;return}const containerId=source2.system.containerId??{value:null};if(containerId instanceof Object&&containerId.value){const inStowingContainer=actor.items.some(i=>i.type==="backpack"&&i.system.stowing&&i._id===containerId.value);if(!inStowingContainer)containerId.value=null;else if(inStowingContainer){equipped.carryType="stowed";return}}equipped.carryType="worn";const usage=getUsageDetails(String(system2.usage?.value));usage.type==="worn"?equipped.inSlot=!!equipped.value:usage.type==="held"&&(equipped.value&&(equipped.carryType="held"),equipped.handsHeld=equipped.value?usage.hands??1:0),equipped["-=value"]=null,delete equipped.value}}class Migration719ShrugFlanking extends MigrationBase{static{__name(this,"Migration719ShrugFlanking")}static{__name2(this,"Migration719ShrugFlanking")}static version=.719;async updateItem(source2,actorSource){const slug=source2.system.slug??"";switch(source2.type){case"action":{if(slug==="all-around-vision")source2.system.rules=[this.#allAroundVision];else if(actorSource?.type==="npc"&&source2.name==="Deny Advantage"){const npcId=actorSource._stats.compendiumSource?.replace(/^Compendium\.[^.]+\./,"")??actorSource._id;if(this.#needsDenyAdvantage(source2.system.rules)){const rule=this.#npcDenyAvantage(npcId);source2.system.rules.push(rule)}}return}case"effect":{slug==="stance-wolf-stance"&&(source2.system.rules=this.#wolfStanceRules);return}case"feat":{source2.system.slug=source2.system.slug?.replace(/^deny-advantage-level-\d$/,"deny-advantage")??null;const featSlug=source2.system.slug??"";if(["constant-gaze","deny-advantage"].includes(featSlug)&&this.#needsDenyAdvantage(source2.system.rules))source2.system.rules.push(this.#denyAdvantage);else if(featSlug==="gang-up")source2.system.rules=[this.#gangUp];else if(featSlug.startsWith("side-by-side")){const sideBySide=this.#gangUp;sideBySide.value="animal-companion",source2.system.rules=[sideBySide]}else if(["pack-tactics","squad-tactics"].includes(featSlug)){const tactics=this.#gangUp;tactics.value=2,source2.system.rules=[tactics]}}}}get#allAroundVision(){return{key:"ActiveEffectLike",mode:"override",path:"system.attributes.flanking.flankable",value:!1}}get#denyAdvantage(){return{key:"ActiveEffectLike",mode:"override",path:"system.attributes.flanking.flatFootable",value:"@actor.level"}}get#gangUp(){return{key:"ActiveEffectLike",mode:"add",path:"system.attributes.flanking.canGangUp",value:1}}#npcVariants=new Map([["YsBSkW3aFwU1bl3w",13],["0Kb4z4h8KVqfrIju",8],["B09JfuBZHjcRXztU",4],["aaDiR0EIWRQx8wdy",3],["x4m5ks6Rd8fYzXPm",4],["qKHkamxIPbqxEiwp",6],["lCvJquCqvZJVnafy",8],["vkLhqX5oR1t89puZ",7],["aIT5S2fKgMZ6pVP2",11],["l6EuZR6zCdqyCywW",6],["QKkvnlqrhgLHuP1t",10],["ZY3q7AV1qbwWwNl2",8],["6pPolNZycfDiOl2I",8],["cQMM2Ld0IBM9GcDo",11],["VkG5yl9xcmziwpQD",4],["JrowrtDilEG8dN2s",11],["1lkay2gwgEquq0NF",6],["EMl8hARVJk8SNVyW",4],["j31HXlZiUqQrAHSB",12],["pjnTEh0NVd1DB6jI",4]]);get#wolfStanceRules(){return[{category:"unarmed",damage:{base:{damageType:"piercing",dice:1,die:"d8"}},group:"brawling",key:"Strike",label:"PF2E.SpecificRule.Stance.Attack.WolfJaws",range:null,slug:"wolf-jaws",traits:["agile","backstabber","finesse","unarmed","nonlethal"]},{definition:{all:["weapon:wolf-jaws"]},key:"AdjustStrike",mode:"add",predicate:{all:["self:flanking"]},property:"traits",value:"trip"}]}#npcDenyAvantage(npcId=""){const denyAdvantage=this.#denyAdvantage;return denyAdvantage.value=this.#npcVariants.get(npcId)??"@actor.level",denyAdvantage}#needsDenyAdvantage(rules){return!rules.some(r2=>r2.key==="ActiveEffectLike"&&r2.path==="system.attributes.flanking.flatFootable")}}class UUIDUtils{static{__name(this,"UUIDUtils")}static{__name2(this,"UUIDUtils")}static async fromUUIDs(uuids,options){const resolvedUUIDs=n(uuids).flatMap(u=>foundry.utils.parseUuid(u,options)?.uuid??[]),packEmbeddedLinks=resolvedUUIDs.filter(u=>{const parsed=foundry.utils.parseUuid(u,options);return parsed?.collection instanceof foundry.documents.collections.CompendiumCollection&&parsed.embedded.length>0}),packEmbeddedDocs=(await Promise.all(packEmbeddedLinks.map(u=>fromUuid(u)))).filter(e$1),documentsAndIndexData=resolvedUUIDs.filter(u=>!packEmbeddedLinks.includes(u)).map(u=>fromUuidSync(u)).filter(e$1),worldDocsAndCacheHits=documentsAndIndexData.filter(d=>d instanceof foundry.abstract.Document),indexEntries=documentsAndIndexData.filter(d=>!(d instanceof foundry.abstract.Document)),packs=n(indexEntries.flatMap(e2=>game.packs.get(e2.pack??"")??[])),packDocs=(await Promise.all(packs.map(async pack=>{const ids=indexEntries.filter(e2=>e2.pack===pack.metadata.id).map(e2=>e2._id);return pack.getDocuments({_id__in:ids})}))).flat();return t([...packEmbeddedDocs,...worldDocsAndCacheHits,...packDocs],d=>uuids.indexOf(d.uuid??""))}static isItemUUID(uuid,options={}){if(typeof uuid!="string")return!1;try{const parseResult=foundry.utils.parseUuid(uuid),isEmbedded=!!parseResult?.embedded.length;return parseResult?.type==="Item"&&(options.embedded===!0?isEmbedded:options.embedded===!1?!isEmbedded:!0)}catch{return!1}}static isCompendiumUUID(uuid,docType){if(typeof uuid!="string")return!1;try{return foundry.utils.parseUuid(uuid)?.collection instanceof foundry.documents.collections.CompendiumCollection&&(docType?uuid.includes(`.${docType}.`):!0)}catch{return!1}}static isTokenUUID(uuid){if(typeof uuid!="string")return!1;try{const parsed=foundry.utils.parseUuid(uuid);return parsed?.primaryType==="Scene"&&parsed.embedded[0]==="Token"}catch{return!1}}}class Migration720UpdateSpellDescriptions extends MigrationBase{static{__name(this,"Migration720UpdateSpellDescriptions")}static{__name2(this,"Migration720UpdateSpellDescriptions")}static version=.72;spellUUIDs=new Set(["Compendium.pf2e.spells-srd.Item.GoKkejPj5yWJPIPK","Compendium.pf2e.spells-srd.Item.1b55SgYTV65JvmQd","Compendium.pf2e.spells-srd.Item.b515AZlB0sridKSq","Compendium.pf2e.spells-srd.Item.NBSBFHxBm88qxQUy","Compendium.pf2e.spells-srd.Item.9TauMFkIsmvKJNzZ","Compendium.pf2e.spells-srd.Item.LoBjvguamA12iyW0","Compendium.pf2e.spells-srd.Item.IWUe32Y5k2QFd7YQ","Compendium.pf2e.spells-srd.Item.WBmvzNDfpwka3qT4"]);spells=UUIDUtils.fromUUIDs([...this.spellUUIDs]);async updateItem(source2){const compendiumSource=source2._stats.compendiumSource;if(!(source2.type==="spell"&&setHasElement(this.spellUUIDs,compendiumSource)))return;const spell=(await this.spells).find(s=>s instanceof SpellPF2e&&s.slug===source2.system.slug);spell&&(source2.system.description.value=spell.description)}}class Migration721SetReloadValues extends MigrationBase{static{__name(this,"Migration721SetReloadValues")}static{__name2(this,"Migration721SetReloadValues")}static version=.721;toUpdate=new Set(["air-repeater","composite-longbow","composite-shortbow","godsbreath-bow","hunters-bow","long-air-repeater","longbow","oathbow","repeating-crossbow","repeating-hand-crossbow","shortbow","singing-shortbow-greater","singing-shortbow","sky-piercing-bow"]);async updateItem(source2){source2.type==="weapon"&&setHasElement(this.toUpdate,source2.system.slug)&&(source2.system.reload.value="0")}}class Migration722CraftingSystemData extends MigrationBase{static{__name(this,"Migration722CraftingSystemData")}static{__name2(this,"Migration722CraftingSystemData")}static version=.722;async updateActor(source2){if(source2.type!=="character")return;if(!e$2(source2.system.crafting)){const filledCrafting={entries:{},formulas:[]};source2.system.crafting=filledCrafting}const crafting=source2.system.crafting??{};(!e$2(crafting.entries)||Array.isArray(crafting.entries))&&(crafting.entries={}),Array.isArray(crafting.formulas)||(crafting.formulas=[])}}class Migration723CumulativeItemBonuses extends MigrationBase{static{__name(this,"Migration723CumulativeItemBonuses")}static{__name2(this,"Migration723CumulativeItemBonuses")}static version=.723;stanceFeats=(async()=>(await UUIDUtils.fromUUIDs(["Compendium.pf2e.feats-srd.ZPclfDmiHzEqblry","Compendium.pf2e.feats-srd.ZL5UU9quCTvcWzfY","Compendium.pf2e.feats-srd.n2hawNmzW7DBn1Lm","Compendium.pf2e.feats-srd.hO4sKslTrSQMLbGx"])).filter(d=>d instanceof FeatPF2e&&!!d.slug).reduce((record,f)=>({...record,[f.slug]:f}),{}))();mountainPattern=/^mountain-(?:stance|stronghold|quake)$/;async updateActor(source2){if(source2.type!=="character")return;const effects=source2.items.filter(i=>i.type==="effect");for(const effect of effects)effect.system.slug?.startsWith("stance-mountain")&&source2.items.findSplice(i=>i===effect)}async updateItem(source2){if(source2.system.slug)switch(source2.type){case"feat":{if(source2.system.slug==="animal-skin"){const feat=(await this.stanceFeats)[source2.system.slug];feat&&(source2.system.rules=feat.toObject().system.rules)}else if(this.mountainPattern.test(source2.system.slug)){const feat=(await this.stanceFeats)[source2.system.slug];feat&&(source2.system.description.value=feat.description)}return}case"equipment":{if(!source2.system.slug.startsWith("bracers-of-armor-"))return;for(const rule of source2.system.rules)rule.key==="FlatModifier"&&(rule.slug="bracers-of-armor");return}case"effect":{if(source2.system.slug!=="spell-effect-mage-armor")return;for(const rule of source2.system.rules)rule.key==="FlatModifier"&&(rule.slug="mage-armor")}}}async updateMacro(source2){source2.type==="script"&&source2.command.includes("Stance: Mountain Stance")&&(source2.command=String.raw`const actors = game.user.getActiveTokens().flatMap((t) => t.actor ?? []);
if (actors.length === 0) {
    return ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected", { localize: true });
}

const ITEM_UUID = "Compendium.pf2e.feat-effects.gYpy9XBPScIlY93p"; // Stance: Mountain Stance
const source = (await fromUuid(ITEM_UUID)).toObject();
source.flags = mergeObject(source.flags ?? {}, { core: { sourceId: ITEM_UUID } });

for (const actor of actors) {
    const existing = actor.itemTypes.effect.find((e) => e._stats.compendiumSource === ITEM_UUID);
    if (existing) {
        await existing.delete();
    } else {
        await actor.createEmbeddedDocuments("Item", [source]);
    }
}`)}}class Migration724CraftingMaxItemLevel extends MigrationBase{static{__name(this,"Migration724CraftingMaxItemLevel")}static{__name2(this,"Migration724CraftingMaxItemLevel")}static version=.724;pathPattern=/^data\.crafting\.entries\.([-a-z]+)\.maxItemLevel$/i;async updateItem(source2){if(source2.type!=="feat")return;if(source2.system.slug==="advanced-alchemy"){const rules=source2.system.rules;for(const rule of rules)rule.predicate={all:["self:class:alchemist"]},rule.key==="CraftingEntry"&&(delete rule.name,rule.label="PF2E.TraitAlchemist")}else if(source2.system.slug?.endsWith("-dedication")&&source2.system.slug!=="alchemist-dedication"){const rules=source2.system.rules.filter(r2=>r2.key==="CraftingEntry");for(const rule of rules){delete rule.name;const i18nKey=sluggify(source2.system.slug.replace(/-dedication$/,""),{camel:"bactrian"});rule.label=`PF2E.SpecificRule.DedicationCraftingEntry.${i18nKey}`}}const aeLikes=source2.system.rules.filter(r2=>r2.key==="ActiveEffectLike");for(const rule of aeLikes){if(typeof rule.path!="string")continue;const selector=this.pathPattern.exec(rule.path)?.[1]??null;if(selector){const predicate=rule.predicate=foundry.utils.mergeObject({all:[]},e$2(rule.predicate)?rule.predicate:{}),slug=sluggify(selector);predicate.all=Array.from(new Set([...predicate.all,`crafting:entry:${slug}`]))}}}}class Migration725QuickClimbREs extends MigrationBase{static{__name(this,"Migration725QuickClimbREs")}static{__name2(this,"Migration725QuickClimbREs")}static version=.725;quickClimb=[{key:"BaseSpeed",predicate:{all:["self:skill:ath:rank:4"]},selector:"climb",value:"@actor.attributes.speed.value"},{key:"Note",predicate:{all:["action:climb"]},selector:"athletics",text:'<p class="compact-text"><strong>{item|name}</strong> You move 5 more feet on a success, and 10 more feet on a critical success.</p>'}];async updateItem(source2){source2.type==="feat"&&source2.system.slug==="quick-climb"&&(source2.system.rules=foundry.utils.deepClone(this.quickClimb))}}class Migration726JournalSetting extends MigrationBase{static{__name(this,"Migration726JournalSetting")}static{__name2(this,"Migration726JournalSetting")}static version=.726;async migrate(){const sheetClasses=game.settings.get("core","sheetClasses");if(e$2(sheetClasses)&&e$2(sheetClasses.JournalEntry)&&sheetClasses.JournalEntry?.base)return;const theme=game.settings.storage.get("world").getItem("pf2e.journalEntryTheme");if(!theme)return;const base=theme==="pf2eTheme"?"pf2e.JournalSheetStyledPF2e":"pf2e.JournalSheetPF2e";foundry.applications.apps.DocumentSheetConfig.updateDefaultSheets({JournalEntry:{base}})}}class Migration727TrimSelfRollOptions extends MigrationBase{static{__name(this,"Migration727TrimSelfRollOptions")}static{__name2(this,"Migration727TrimSelfRollOptions")}static version=.727;optionPattern=/^self:(ability|class|feat(?:ure)?|perception|skill):/;optionReplacement="$1:";#trimRollOption(option){return option.replace(this.optionPattern,this.optionReplacement)}trimPredicates(obj){for(const[key,value]of Object.entries(obj))typeof value=="string"?obj[key]=this.#trimRollOption(value):Array.isArray(value)?obj[key]=value.map(e2=>typeof e2=="string"?this.#trimRollOption(e2):e$2(e2)?this.trimPredicates(e2):e2):e$2(value)&&(obj[key]=this.trimPredicates(value));return obj}async updateItem(source2){source2.system.rules=source2.system.rules.map(r2=>this.trimPredicates(r2))}}class Migration728FlattenPhysicalProperties extends MigrationBase{static{__name(this,"Migration728FlattenPhysicalProperties")}static{__name2(this,"Migration728FlattenPhysicalProperties")}static version=.728;booleanKeys=["temporary","collapsed"];numericKeys=["quantity","hardness"];stringKeys=["stackGroup","containerId"];async updateItem(source2){if(!itemIsOfType(source2,"physical"))return;const system2=source2.system;if(system2.currency&&(delete system2.currency,system2["-=currency"]=null),system2.hands&&(delete system2.hands,system2["-=hands"]=null),system2.equipped&&e$2(system2.invested)){const value=system2.invested.value;if(typeof value=="boolean"||value===null){const shouldBeBoolean=source2.system.traits.value.includes("invested")||source2.type==="armor"&&(system2.potencyRune?.value??0)>0;system2.equipped.invested=shouldBeBoolean?!!value:null}}if(delete system2.invested,system2["-=invested"]=null,system2.capacity&&source2.type!=="book"&&(delete system2.capacity,system2["-=capacity"]=null),source2.type!=="backpack"&&(delete system2.bulkCapacity,system2["-=bulkCapacity"]=null,delete system2.collapsed,system2["-=collapsed"]=null),system2.size instanceof Object){const size=SIZES.includes(system2.size.value)?system2.size.value:"med";system2.size=size}"brokenThreshold"in system2&&(system2.brokenThreshold instanceof Object&&(system2.hp.brokenThreshold=Number(system2.brokenThreshold.value)),delete system2.brokenThreshold,system2["-=brokenThreshold"]=null),system2.hp.value=Number(system2.hp.value),system2.maxHp instanceof Object&&(system2.hp.max=Number(system2.maxHp.value)||0,delete system2.maxHp,system2["-=maxHp"]=null);for(const key of this.booleanKeys){const value=system2[key];value instanceof Object&&(system2[key]=value.value)}for(const key of this.numericKeys){const value=system2[key];value instanceof Object&&(system2[key]=Number(value.value)||0)}for(const key of this.stringKeys){const value=system2[key];value instanceof Object&&(system2[key]=String(value.value)||null)}}}class Migration729CumulativeItemBonusCleanup extends MigrationBase{static{__name(this,"Migration729CumulativeItemBonusCleanup")}static{__name2(this,"Migration729CumulativeItemBonusCleanup")}static version=.729;#explorersClothingVariants=new Set(["clothing-explorers","robe-of-the-arch-magi","robe-of-the-arch-magi-greater","sarkorian-god-caller-garb"]);isExplorersClothing(source2){return source2.type==="armor"&&this.#explorersClothingVariants.has(source2.system.slug??"")}isStanceEffectOrAnimalSkinFeat(source2){return source2.type==="effect"&&source2.system.slug==="stance-mountain-stance"||source2.type==="feat"&&source2.system.slug==="animal-skin"}async updateItem(source2){if(this.isExplorersClothing(source2))source2.system.category="unarmored",source2.system.group="cloth",source2.system.baseItem="explorers-clothing",source2.system.traits.value.includes("comfort")||source2.system.traits.value.push("comfort");else if(this.isStanceEffectOrAnimalSkinFeat(source2)){const rule=source2.system.rules.find(r2=>r2.key==="AdjustModifier"&&r2.slug==="clothing-explorers");rule&&(rule.slug="explorers-clothing")}else if(source2.type==="equipment"){const isBracers=!!source2.system.slug?.startsWith("bracers-of-armor-");for(const rule of source2.system.rules)rule.key==="FlatModifier"&&rule.slug==="bracers-of-armor"&&!isBracers&&(source2.system.slug==="metuaks-pendant"?rule.slug="metuaks-pendant":delete rule.slug)}}}class Migration730DeruneHandwraps extends MigrationBase{static{__name(this,"Migration730DeruneHandwraps")}static{__name2(this,"Migration730DeruneHandwraps")}static version=.73;async updateItem(source2){if(source2.type==="weapon"&&source2.system.slug==="handwraps-of-mighty-blows"){const{rules}=source2.system;for(const rule of[...rules])["Striking","WeaponPotency"].includes(String(rule.key))&&source2.system.rules.splice(rules.indexOf(rule),1)}}}class Migration731TogglePropertyToRollOption extends Migration727TrimSelfRollOptions{static{__name(this,"Migration731TogglePropertyToRollOption")}static{__name2(this,"Migration731TogglePropertyToRollOption")}static version=.731;optionPattern=/^target:flatFooted$/;optionReplacement="target:condition:flat-footed";pathPattern=/^flags\.pf2e\.rollOptions\.([^.]+)\.([^.]+)$/;async updateItem(source2){source2.system.rules=source2.system.rules.map(r2=>this.trimPredicates(r2));const rules=source2.system.rules;for(const rule of[...rules]){if(rule.key!=="ToggleProperty")continue;const match=this.pathPattern.exec(rule.property?.trim()??"");if(!(match?.length===3&&match[1].length>=2&&match[2].length>=1)){rules.splice(rules.indexOf(rule),1);continue}rule.key="RollOption",rule.domain=match[1],rule.option=match[2],rule.toggleable=!0,delete rule.property,typeof rule.default=="boolean"&&(rule.value=rule.default,delete rule.default),sluggify(String(rule.label??""))===source2.system.slug&&delete rule.label}}async updateActor(source2){const rollOptionsAll=source2.flags.pf2e?.rollOptions?.all;rollOptionsAll&&(rollOptionsAll["-=panache"]=null,rollOptionsAll["-=rage"]=null,rollOptionsAll["-=target:flatFooted"]=null)}}class Migration732FixDedicationFeatTypes extends MigrationBase{static{__name(this,"Migration732FixDedicationFeatTypes")}static{__name2(this,"Migration732FixDedicationFeatTypes")}static version=.732;#hasWellFormedFeatType(system2){return"featType"in system2&&e$2(system2.featType)&&"value"in system2.featType&&typeof system2.featType=="string"}async updateItem(source2){if(source2.type==="feat"){const system2=source2.system;if(!this.#hasWellFormedFeatType(system2))system2.featType={value:"bonus"};else{const{featType}=system2;(featType.value==="dedication"||featType.value==="class"&&source2.system.slug?.endsWith("-dedication"))&&(featType.value="archetype")}}}}class Migration733ItemBonusFromEquipment extends MigrationBase{static{__name(this,"Migration733ItemBonusFromEquipment")}static{__name2(this,"Migration733ItemBonusFromEquipment")}static version=.733;slugs=new Set(["animal-skin","stance-mountain-stance","spell-effect-mage-armor"]);async updateItem(source2){const compendiumItem=this.slugs.has(source2.system.slug??""),homebrewItem=!compendiumItem&&source2.type==="feat";if(!(compendiumItem||homebrewItem))return;const rules=source2.system.rules;for(const rule of rules)rule.key==="FlatModifier"&&rule.type==="item"&&(rule.fromEquipment=!1)}}class Migration734SpellLocationPropsAndSignature extends MigrationBase{static{__name(this,"Migration734SpellLocationPropsAndSignature")}static{__name2(this,"Migration734SpellLocationPropsAndSignature")}static version=.734;async updateActor(actor){const entries=actor.items.filter(item=>item.type==="spellcastingEntry"),spells=actor.items.filter(item=>item.type==="spell");for(const spellSource of spells){const spellData=spellSource.system,entrySource=entries.find(entry=>entry._id===spellData.location.value);if(!entrySource)continue;const entryData=entrySource.system;if(!entryData.signatureSpells)continue;entryData.signatureSpells.value.includes(spellSource._id??"")&&(spellData.location.signature=!0)}}async updateItem(source2,actor){if(source2.type==="spellcastingEntry"){const data=source2.system;data.signatureSpells&&(delete data.signatureSpells,"game"in globalThis&&(data["-=signatureSpells"]=null))}if(source2.type==="spell"){const data=source2.system;(data.heightenedLevel||data.autoHeightenLevel)&&(actor&&(data.location.heightenedLevel=data.heightenedLevel?.value??void 0,data.location.autoHeightenLevel=data.autoHeightenLevel?.value??void 0),delete data.autoHeightenLevel,delete data.heightenedLevel,"game"in globalThis&&(data["-=autoHeightenLevel"]=null,data["-=heightenedLevel"]=null))}}}class Migration735FirearmAmmoAlchemical extends MigrationBase{static{__name(this,"Migration735FirearmAmmoAlchemical")}static{__name2(this,"Migration735FirearmAmmoAlchemical")}static version=.735;#needsTrait(source2){return"consumableType"in source2.system&&e$2(source2.system.consumableType)&&source2.system.consumableType.value==="ammo"&&!!source2.system.stackGroup?.startsWith("rounds")&&source2.system.slug!=="cutlery"&&!source2.system.traits.value.includes("alchemical")}async updateItem(source2){source2.type==="consumable"&&this.#needsTrait(source2)&&source2.system.traits.value.unshift("alchemical")}}class Migration736RemoveBrokenThreshold extends MigrationBase{static{__name(this,"Migration736RemoveBrokenThreshold")}static{__name2(this,"Migration736RemoveBrokenThreshold")}static version=.736;#hasBrokenThreshold(source2){return itemIsOfType(source2,"physical")&&"brokenThreshold"in source2.system}async updateItem(source2){this.#hasBrokenThreshold(source2)&&(delete source2.system.brokenThreshold,source2.system["-=brokenThreshold"]=null)}}class Migration737NormalizeRuleElementKeys extends Migration731TogglePropertyToRollOption{static{__name(this,"Migration737NormalizeRuleElementKeys")}static{__name2(this,"Migration737NormalizeRuleElementKeys")}static version=.737;async updateItem(source2){const rules=source2.system.rules;for(const rule of[...rules]){if(!e$2(rule)||typeof rule.key!="string"){rules.splice(rules.indexOf(rule),1);continue}rule.key=rule.key.trim().replace(/^PF2E\.RuleElement\./,"")}return super.updateItem(source2)}}class Migration738UpdateLaughingShadow extends MigrationBase{static{__name(this,"Migration738UpdateLaughingShadow")}static{__name2(this,"Migration738UpdateLaughingShadow")}static version=.738;#shadowPromise=fromUuid("Compendium.pf2e.classfeatures.3gVDqDPSz4fB5T9G");#cascadePromise=fromUuid("Compendium.pf2e.feature-effects.fsjO5oTKttsbpaKl");async updateActor(source2){const rollOptionsAll=source2.flags.pf2e?.rollOptions?.all;rollOptionsAll instanceof Object&&"feature:laughing-shadow:damage"in rollOptionsAll&&(rollOptionsAll["-=feature:laughing-shadow:damage"]=!1)}async updateItem(source2){if(source2.type==="feat"&&source2.system.slug==="laughing-shadow"){const laughingShadow=await this.#shadowPromise;if(!laughingShadow)return;source2.system.rules=foundry.utils.deepClone(laughingShadow._source.system.rules)}else if(source2.type==="effect"&&source2.system.slug==="stance-arcane-cascade"){const arcaneCascade=await this.#cascadePromise;if(!arcaneCascade)return;const newRules=foundry.utils.deepClone(arcaneCascade._source.system.rules),withSelection=source2.system.rules.find(r2=>r2.key==="ChoiceSet"&&typeof r2.selection=="string");if(withSelection){const unselected=newRules.find(r2=>r2.key==="ChoiceSet");unselected&&(unselected.selection=withSelection.selection)}source2.system.rules=newRules}}}class Migration739RecoveryCheckDC extends MigrationBase{static{__name(this,"Migration739RecoveryCheckDC")}static{__name2(this,"Migration739RecoveryCheckDC")}static version=.739;toughness=[{key:"FlatModifier",selector:"hp",value:"@actor.level"},{key:"ActiveEffectLike",mode:"downgrade",path:"system.attributes.dying.recoveryDC",value:9}];defyDeath=[{key:"ActiveEffectLike",mode:"downgrade",predicate:{not:["feat:toughness"]},path:"system.attributes.dying.recoveryDC",value:9},{key:"ActiveEffectLike",mode:"downgrade",predicate:{all:["feat:toughness"]},path:"system.attributes.dying.recoveryDC",value:8}];mountainsStoutness=[{key:"FlatModifier",selector:"hp",type:"untyped",value:"@actor.level"},{key:"ActiveEffectLike",mode:"downgrade",predicate:{not:["feat:toughness"]},path:"system.attributes.dying.recoveryDC",value:9},{key:"ActiveEffectLike",mode:"downgrade",predicate:{all:["feat:toughness"]},path:"system.attributes.dying.recoveryDC",value:6}];async updateItem(source2){if(source2.type!=="feat")return;if(source2.system.slug==="toughness"){source2.system.rules=this.toughness;return}else if(source2.system.slug==="defy-death"){source2.system.rules=this.defyDeath;return}else if(source2.system.slug==="mountains-stoutness"){source2.system.rules=this.mountainsStoutness;return}const{rules}=source2.system;for(const rule of[...rules])rule.key==="RecoveryCheckDC"&&source2.system.rules.splice(rules.indexOf(rule),1)}}class Migration740MaxTakable extends MigrationBase{static{__name(this,"Migration740MaxTakable")}static{__name2(this,"Migration740MaxTakable")}static version=.74;async updateItem(source2){if(source2.type!=="feat")return;const systemData=source2.system;"maxTaken"in systemData&&(typeof systemData.maxTaken=="number"&&typeof systemData.maxTakable!="number"&&(systemData.maxTakable=systemData.maxTaken),delete systemData.maxTaken,systemData["-=maxTaken"]=null),"maxTakable"in systemData&&typeof systemData.maxTakable!="number"&&(systemData.maxTakable=null)}}class Migration741RollOptionToggleToItem extends MigrationBase{static{__name(this,"Migration741RollOptionToggleToItem")}static{__name2(this,"Migration741RollOptionToggleToItem")}static version=.741;async updateActor(source2){if(!e$2(source2.flags.pf2e?.rollOptions))return;const rules=source2.items.flatMap(i=>i.system.rules).filter(r2=>!!r2.toggleable&&r2.key==="RollOption"&&typeof r2.domain=="string"&&r2.domain.length>0&&typeof r2.option=="string"&&r2.option.length>0),rollOptions=source2.flags.pf2e.rollOptions;for(const rule of rules){const domain=rollOptions[rule.domain];domain instanceof Object&&rule.option in domain&&(domain[`-=${rule.option}`]=!1,rule.value=!!domain[rule.option])}}}class Migration742RMAbilityBoostLevels extends MigrationBase{static{__name(this,"Migration742RMAbilityBoostLevels")}static{__name2(this,"Migration742RMAbilityBoostLevels")}static version=.742;async updateItem(source2){if(source2.type!=="class")return;const systemData=source2.system;"abilityBoostLevels"in source2.system&&(delete systemData.abilityBoostLevels,systemData["-=abilityBoostLevels"]=null)}}class Migration743FixWeaknessStructure extends MigrationBase{static{__name(this,"Migration743FixWeaknessStructure")}static{__name2(this,"Migration743FixWeaknessStructure")}static version=.743;async updateActor(source2){if(source2.type!=="character"&&source2.type!=="npc")return;const traits=source2.system.traits??{dv:[]};Array.isArray(traits.dv)||(traits.dv=[]),Array.isArray(traits.dr)||(traits.dr=[])}}class Migration744MigrateSpellHeighten extends MigrationBase{static{__name(this,"Migration744MigrateSpellHeighten")}static{__name2(this,"Migration744MigrateSpellHeighten")}static version=.744;async updateItem(source2){if(source2.type!=="spell")return;const system2=source2.system;system2.scaling&&(system2.heightening={type:"interval",interval:system2.scaling.interval,damage:system2.scaling.damage,area:0},delete system2.scaling,system2["-=scaling"]=null)}}class Migration745EffectTargetToChoiceSet extends MigrationBase{static{__name(this,"Migration745EffectTargetToChoiceSet")}static{__name2(this,"Migration745EffectTargetToChoiceSet")}static version=.745;#isEffectTargetRE(rule){return rule.key==="EffectTarget"}#toChoiceSet(rule,itemSource,actorSource){const newRE={key:"ChoiceSet",choices:{ownedItems:!0,types:["weapon"]},prompt:"PF2E.SpecificRule.Prompt.Weapon"};if(typeof rule.targetId=="string"&&actorSource){const weapon=actorSource.items.find(i=>i.type==="weapon"&&i._id===rule.targetId);weapon&&(newRE.selection=weapon.system.slug??sluggify(weapon.name))}return itemSource.system.slug?.includes("blade-ally")?newRE.choices.includeHandwraps=!0:itemSource.system.slug?.includes("weapon-surge")?newRE.choices.predicate={all:["item:equipped"]}:itemSource.system.slug==="shillelagh"?(newRE.adjustName=!1,newRE.prompt="PF2E.SpecificRule.Prompt.Shillelagh",newRE.choices.predicate={all:["item:equipped"],any:["item:base:club","item:base:staff"]}):e$2(rule.predicate)&&(newRE.choices.predicate=foundry.utils.deepClone(rule.predicate)),newRE}async updateItem(source2,actorSource){const{rules}=source2.system;for(const rule of rules)if(this.#isEffectTargetRE(rule)){rules[rules.indexOf(rule)]=this.#toChoiceSet(rule,source2,actorSource??null);const otherRules=rules.filter(r2=>typeof r2.selector=="string"&&/item\|data\.target/.test(r2.selector));for(const other of otherRules){const flag=sluggify(source2.system.slug??source2.name,{camel:"dromedary"});other.selector=other.selector.replace(/\bdata\.target\b/,`flags.pf2e.rulesSelections.${flag}`)}}}}class Migration746StandardizePricing extends MigrationBase{static{__name(this,"Migration746StandardizePricing")}static{__name2(this,"Migration746StandardizePricing")}static version=.746;async updateItem(source2){if(!(!itemIsOfType(source2,"physical")&&source2.type!=="kit"))if(e$2(source2.system.price)||(source2.system.price={value:Coins.fromString(String(source2.system.price)).toObject()}),source2.type==="treasure"){const systemData=source2.system;if(systemData.denomination||systemData.value){const value=systemData.value?.value??0,denomination=systemData.denomination?.value??"gp";systemData.price={value:{[denomination]:value}},systemData["-=denomination"]=null,delete systemData.denomination,systemData["-=value"]=null,delete systemData.value}}else e$2(source2.system.price.value)||(source2.system.price.value=Coins.fromString(String(source2.system.price.value)).toObject())}}class Migration747FixedHeightening extends MigrationBase{static{__name(this,"Migration747FixedHeightening")}static{__name2(this,"Migration747FixedHeightening")}static version=.747;async updateItem(source2){if(source2.type!=="spell")return;const isAcidSplash=(source2.system.slug??sluggify(source2.name))==="acid-splash";if(source2.system.heightening?.type==="fixed"&&!isAcidSplash)return;const sourceId=source2._stats.compendiumSource;if(sourceId&&this.fixedHeightenSpells.has(sourceId)){const spell=(await this.loadSpells())[sourceId];spell&&spell.system.heightening?.type==="fixed"&&(source2.system.heightening=spell.system.heightening,this.overwriteDamage(source2,spell))}}overwriteDamage(spell,newSpell){const newDamage=newSpell.system.damage,newKeys=new Set(Object.keys(newDamage.value)),diff=Object.keys(spell.system.damage.value).filter(key=>!newKeys.has(key)),damage=spell.system.damage;damage.value=newDamage.value;for(const deleteKey of diff)e$2(damage.value)&&(damage.value[`-=${deleteKey}`]=null)}#loadedSpells;async loadSpells(){if(this.#loadedSpells)return this.#loadedSpells;const spells=await UUIDUtils.fromUUIDs([...this.fixedHeightenSpells]);return this.#loadedSpells=spells.reduce((record,spell)=>({...record,[spell.uuid]:spell}),{}),this.#loadedSpells}fixedHeightenSpells=new Set(["Compendium.pf2e.spells-srd.Item.0fKHBh5goe2eiFYL","Compendium.pf2e.spells-srd.Item.10VcmSYNBrvBphu1","Compendium.pf2e.spells-srd.Item.2gQYrCPwBmwau26O","Compendium.pf2e.spells-srd.Item.2iQKhCQBijhj5Rf3","Compendium.pf2e.spells-srd.Item.4koZzrnMXhhosn0D","Compendium.pf2e.spells-srd.Item.5WM3WjshXgrkVCg6","Compendium.pf2e.spells-srd.Item.7CUgqHunmHfW2lC5","Compendium.pf2e.spells-srd.Item.7OFKYR1VY6EXDuiR","Compendium.pf2e.spells-srd.Item.9s5tqqXNzcoKamWx","Compendium.pf2e.spells-srd.Item.BCuHKrDeJ4eq53M6","Compendium.pf2e.spells-srd.Item.CxpFy4HJHf4ACbxF","Compendium.pf2e.spells-srd.Item.D2nPKbIS67m9199U","Compendium.pf2e.spells-srd.Item.DCQHaLrYXMI37dvW","Compendium.pf2e.spells-srd.Item.DgcSiOCR1uDXGaEA","Compendium.pf2e.spells-srd.Item.EfFMLVbmkBWmzoLF","Compendium.pf2e.spells-srd.Item.Et8RSCLx8w7uOLvo","Compendium.pf2e.spells-srd.Item.F23T5tHPo3WsFiHW","Compendium.pf2e.spells-srd.Item.FhOaQDTSnsY7tiam","Compendium.pf2e.spells-srd.Item.Fr58LDSrbndgld9n","Compendium.pf2e.spells-srd.Item.GaRQlC9Yw1BGKHfN","Compendium.pf2e.spells-srd.Item.HGmBY8KjgLV97nUp","Compendium.pf2e.spells-srd.Item.HHGUBGle4OjoxvNR","Compendium.pf2e.spells-srd.Item.HTou8cG05yuSkesj","Compendium.pf2e.spells-srd.Item.HWrNMQENi9WSGbnF","Compendium.pf2e.spells-srd.Item.HcIAQZjNXHemoXSU","Compendium.pf2e.spells-srd.Item.Ifc2b6bNVdjKV7Si","Compendium.pf2e.spells-srd.Item.JHntYF0SbaWKq7wR","Compendium.pf2e.spells-srd.Item.LQzlKbYjZSMFQawP","Compendium.pf2e.spells-srd.Item.LiGbewa9pO0yjbsY","Compendium.pf2e.spells-srd.Item.Llx0xKvtu8S4z6TI","Compendium.pf2e.spells-srd.Item.Mkbq9xlAUxHUHyR2","Compendium.pf2e.spells-srd.Item.OAt2ZEns1gIOCgrn","Compendium.pf2e.spells-srd.Item.OhD2Z6rIGGD5ocZA","Compendium.pf2e.spells-srd.Item.PRrZ7anETWPm90YY","Compendium.pf2e.spells-srd.Item.PjhUmyKnq6K5uDby","Compendium.pf2e.spells-srd.Item.Popa5umI3H33levx","Compendium.pf2e.spells-srd.Item.Pwq6T7xpfAJXV5aj","Compendium.pf2e.spells-srd.Item.Q7QQ91vQtyi1Ux36","Compendium.pf2e.spells-srd.Item.Seaah9amXg70RKw2","Compendium.pf2e.spells-srd.Item.U58aQWJ47VrI36yP","Compendium.pf2e.spells-srd.Item.UmXhuKrYZR3W16mQ","Compendium.pf2e.spells-srd.Item.VTb0yI6P1bLkzuRr","Compendium.pf2e.spells-srd.Item.VlNcjmYyu95vOUe8","Compendium.pf2e.spells-srd.Item.W02bHXylIpoXbO4e","Compendium.pf2e.spells-srd.Item.WsUwpfmhKrKwoIe3","Compendium.pf2e.spells-srd.Item.Wt94cw03L77sbud7","Compendium.pf2e.spells-srd.Item.XhgMx9WC6NfXd9RP","Compendium.pf2e.spells-srd.Item.ZAX0OOcKtYMQlquR","Compendium.pf2e.spells-srd.Item.ZqmP9gijBmK7y8Xy","Compendium.pf2e.spells-srd.Item.aIHY2DArKFweIrpf","Compendium.pf2e.spells-srd.Item.atlgGNI1E1Ox3O3a","Compendium.pf2e.spells-srd.Item.bay4AfSu2iIozNNW","Compendium.pf2e.spells-srd.Item.czO0wbT1i320gcu9","Compendium.pf2e.spells-srd.Item.dINQzhqGmIsqGMUY","Compendium.pf2e.spells-srd.Item.drmvQJETA3WZzXyw","Compendium.pf2e.spells-srd.Item.e36Z2t6tLdW3RUzZ","Compendium.pf2e.spells-srd.Item.fprqWKUc0jnMIyGU","Compendium.pf2e.spells-srd.Item.gISYsBFby1TiXfBt","Compendium.pf2e.spells-srd.Item.ivKnEtI1z4UqEKIA","Compendium.pf2e.spells-srd.Item.kuoYff1csM5eAcAP","Compendium.pf2e.spells-srd.Item.lbrWMnS2pecKaSVB","Compendium.pf2e.spells-srd.Item.lsR3RLEdBG4rcSzd","Compendium.pf2e.spells-srd.Item.nXmC2Xx9WmS5NsAo","Compendium.pf2e.spells-srd.Item.o6YCGx4lycsYpww4","Compendium.pf2e.spells-srd.Item.pZTqGY1MLRjgKasV","Compendium.pf2e.spells-srd.Item.pt3gEnzA159uHcJC","Compendium.pf2e.spells-srd.Item.pwzdSlJgYqN7bs2w","Compendium.pf2e.spells-srd.Item.q5qmNn144ZJGxnvJ","Compendium.pf2e.spells-srd.Item.qTr2oCgIXl703Whb","Compendium.pf2e.spells-srd.Item.qwlh6aDgi86U3Q7H","Compendium.pf2e.spells-srd.Item.r4HLQcYwB62bTayl","Compendium.pf2e.spells-srd.Item.sFwoKj0TsacsmoWj","Compendium.pf2e.spells-srd.Item.vLA0q0WOK2YPuJs6","Compendium.pf2e.spells-srd.Item.vLzFcIaSXs7YTIqJ","Compendium.pf2e.spells-srd.Item.vTQvfYu2llKQedmY","Compendium.pf2e.spells-srd.Item.vctIUOOgSmxAF0KG","Compendium.pf2e.spells-srd.Item.wzctak6BxOW8xvFV","Compendium.pf2e.spells-srd.Item.x5rGOmhDRDVQPrnW","Compendium.pf2e.spells-srd.Item.x7SPrsRxGb2Vy2nu","Compendium.pf2e.spells-srd.Item.x9RIFhquazom4p02","Compendium.pf2e.spells-srd.Item.xRgU9rrhmGAgG4Rc","Compendium.pf2e.spells-srd.Item.yH13KXUK2x093NUv","Compendium.pf2e.spells-srd.Item.yM3KTTSAIHhyuP14","Compendium.pf2e.spells-srd.Item.zlnXpME1T2uvn8Lr","Compendium.pf2e.spells-srd.Item.zul5cBTfr7NXHBZf"])}class Migration748BatchConsumablePricing extends MigrationBase{static{__name(this,"Migration748BatchConsumablePricing")}static{__name2(this,"Migration748BatchConsumablePricing")}static version=.748;async updateItem(source2){if(!itemIsOfType(source2,"physical"))return;const slug=source2.system.slug??sluggify(source2.name);batched_5.has(slug)&&(source2.system.price.per=5),batched_10.has(slug)&&(source2.system.price.per=10)}}const batched_5=new Set(["rounds-harmona-gun","rounds-dwarven-scattergun","rounds-flingflenser","rounds-explosive-dogslicer"]),batched_10=new Set(["rounds-three-peaked-tree","rounds-dragon-mouth-pistol","rounds-pepperbox","rounds-fire-lance","rounds-flintlock-pistol","rounds-clan-pistol","bolts","rounds-hand-cannon","sun-shot","rounds-dagger-pistol","rounds-dueling-pistol","rounds-flintlock-musket","rounds-hammer-gun","rounds-black-powder-knuckle-dusters","rounds-slide-pistol","sling-bullets","rounds-double-barreled-musket","rounds-mace-multipistol","rounds-gnome-amalgam-musket","cutlery","rounds-axe-musket","rounds-mithral-tree","wooden-taws","rounds-gun-sword","rounds-blunderbuss","rounds-jezail","rounds-double-barreled-pistol","rounds-arquebus","rounds-cane-pistol","rounds-rapier-pistol","rounds-coat-pistol","rounds-piercing-wind","blowgun-darts","arrows","light-writer-plates","practice-target"]),damageCategoriesUnique={persistent:"PF2E.ConditionTypePersistentShort",precision:"PF2E.Damage.Precision",splash:"PF2E.TraitSplash"},materialDamageEffects=t$3(preciousMaterials,["abysium","adamantine","cold-iron","dawnsilver","djezet","duskwood","inubrix","keep-stone","noqual","orichalcum","peachwood","siccatite","silver","sisterstone-dusk","sisterstone-scarlet","sovereign-steel","warpglass"]),damageCategories={...damageCategoriesUnique,...materialDamageEffects,energy:"PF2E.TraitEnergy",physical:"PF2E.TraitPhysical"},physicalDamageTypes={bleed:"PF2E.TraitBleed",bludgeoning:"PF2E.TraitBludgeoning",piercing:"PF2E.TraitPiercing",slashing:"PF2E.TraitSlashing"},damageTypes={...energyDamageTypes,...physicalDamageTypes,mental:"PF2E.TraitMental",poison:"PF2E.TraitPoison",spirit:"PF2E.TraitSpirit",untyped:"PF2E.TraitUntyped"},damageRollFlavors=[...DAMAGE_TYPES].reduce((result,key)=>(result[key]=`PF2E.Damage.RollFlavor.${key}`,result),{}),traditionIWR=t$5(magicTraditions,(_,t2)=>`PF2E.Damage.IWR.Type.${t2}`),materialIWR=t$5(n$1(materialDamageEffects,["keep-stone","sisterstone-dusk","sisterstone-scarlet","sovereign-steel","warpglass"]),(_v,k)=>`PF2E.Damage.IWR.Type.${k}`),sanctifiedIWR={holy:"PF2E.Damage.IWR.Type.holy",unholy:"PF2E.Damage.IWR.Type.unholy"},immunityTypes={...materialIWR,...sanctifiedIWR,...traditionIWR,acid:"PF2E.Damage.RollFlavor.acid",aging:"PF2E.Damage.IWR.Type.aging",air:"PF2E.Damage.RollFlavor.air",alchemical:"PF2E.Damage.IWR.Type.alchemical","area-damage":"PF2E.Damage.IWR.Type.area-damage",auditory:"PF2E.Damage.IWR.Type.auditory",bleed:"PF2E.Damage.RollFlavor.bleed",blinded:"PF2E.Damage.IWR.Type.blinded",bludgeoning:"PF2E.Damage.RollFlavor.bludgeoning",clumsy:"PF2E.Damage.IWR.Type.clumsy",cold:"PF2E.Damage.RollFlavor.cold",confused:"PF2E.Damage.IWR.Type.confused",controlled:"PF2E.Damage.IWR.Type.controlled","critical-hits":"PF2E.Damage.IWR.Type.critical-hits",curse:"PF2E.Damage.IWR.Type.curse",custom:"",dazzled:"PF2E.Damage.IWR.Type.dazzled",deafened:"PF2E.Damage.IWR.Type.deafened","death-effects":"PF2E.Damage.IWR.Type.death-effects",detection:"PF2E.Damage.IWR.Type.detection",disease:"PF2E.Damage.IWR.Type.disease",doomed:"PF2E.Damage.IWR.Type.doomed",drained:"PF2E.Damage.IWR.Type.drained",earth:"PF2E.Damage.RollFlavor.earth",electricity:"PF2E.Damage.RollFlavor.electricity",emotion:"PF2E.Damage.IWR.Type.emotion",energy:"PF2E.Damage.IWR.Type.energy",enfeebled:"PF2E.Damage.IWR.Type.enfeebled",fascinated:"PF2E.Damage.IWR.Type.fascinated",fatigued:"PF2E.Damage.IWR.Type.fatigued","fear-effects":"PF2E.Damage.IWR.Type.fear-effects",fire:"PF2E.Damage.RollFlavor.fire",fleeing:"PF2E.Damage.IWR.Type.fleeing",force:"PF2E.Damage.RollFlavor.force","fortune-effects":"PF2E.Damage.IWR.Type.fortune-effects",frightened:"PF2E.Damage.IWR.Type.frightened",grabbed:"PF2E.Damage.IWR.Type.grabbed",healing:"PF2E.Damage.IWR.Type.healing",illusion:"PF2E.Damage.IWR.Type.illusion",immobilized:"PF2E.Damage.IWR.Type.immobilized",inhaled:"PF2E.Damage.IWR.Type.inhaled",light:"PF2E.Damage.IWR.Type.light",magic:"PF2E.Damage.IWR.Type.magic",mental:"PF2E.Damage.RollFlavor.mental",metal:"PF2E.Damage.IWR.Type.metal","misfortune-effects":"PF2E.Damage.IWR.Type.misfortune-effects","non-magical":"PF2E.Damage.IWR.Type.non-magical","nonlethal-attacks":"PF2E.Damage.IWR.Type.nonlethal-attacks","object-immunities":"PF2E.Damage.IWR.Type.object-immunities","off-guard":"PF2E.Damage.IWR.Type.off-guard",olfactory:"PF2E.Damage.IWR.Type.olfactory",paralyzed:"PF2E.Damage.IWR.Type.paralyzed","persistent-damage":"PF2E.Damage.IWR.Type.persistent-damage",petrified:"PF2E.Damage.IWR.Type.petrified",physical:"PF2E.Damage.IWR.Type.physical",piercing:"PF2E.Damage.RollFlavor.piercing",plant:"PF2E.Damage.IWR.Type.plant",poison:"PF2E.Damage.RollFlavor.poison",polymorph:"PF2E.Damage.IWR.Type.polymorph",possession:"PF2E.Damage.IWR.Type.possession",precision:"PF2E.Damage.RollFlavor.precision",prediction:"PF2E.Damage.IWR.Type.prediction",prone:"PF2E.Damage.IWR.Type.prone",radiation:"PF2E.Damage.IWR.Type.radiation",restrained:"PF2E.Damage.IWR.Type.restrained","salt-water":"PF2E.Damage.IWR.Type.salt-water",scrying:"PF2E.Damage.IWR.Type.scrying",sickened:"PF2E.Damage.IWR.Type.sickened",slashing:"PF2E.Damage.RollFlavor.slashing",sleep:"PF2E.Damage.IWR.Type.sleep",slowed:"PF2E.Damage.IWR.Type.slowed",sonic:"PF2E.Damage.RollFlavor.sonic","spell-deflection":"PF2E.Damage.IWR.Type.spell-deflection",spirit:"PF2E.Damage.RollFlavor.spirit",stunned:"PF2E.Damage.IWR.Type.stunned",stupefied:"PF2E.Damage.IWR.Type.stupefied","swarm-attacks":"PF2E.Damage.IWR.Type.swarm-attacks","swarm-mind":"PF2E.Damage.IWR.Type.swarm-mind",time:"PF2E.Damage.IWR.Type.time",trip:"PF2E.Damage.IWR.Type.trip","unarmed-attacks":"PF2E.Damage.IWR.Type.unarmed-attacks",unconscious:"PF2E.Damage.IWR.Type.unconscious",visual:"PF2E.Damage.IWR.Type.visual",vitality:"PF2E.Damage.RollFlavor.vitality",void:"PF2E.Damage.RollFlavor.void",water:"PF2E.Damage.IWR.Type.water",wood:"PF2E.Damage.IWR.Type.wood",wounded:"PF2E.Damage.IWR.Type.wounded"},weaknessTypes={...materialIWR,...sanctifiedIWR,...traditionIWR,acid:"PF2E.Damage.RollFlavor.acid",air:"PF2E.Damage.RollFlavor.air",alchemical:"PF2E.Damage.IWR.Type.alchemical","all-damage":"PF2E.Damage.IWR.Type.all-damage","area-damage":"PF2E.Damage.IWR.Type.area-damage","arrow-vulnerability":"PF2E.Damage.IWR.Type.arrow-vulnerability","axe-vulnerability":"PF2E.Damage.IWR.Type.axe-vulnerability",bleed:"PF2E.Damage.RollFlavor.bleed",bludgeoning:"PF2E.Damage.RollFlavor.bludgeoning",cold:"PF2E.Damage.RollFlavor.cold","critical-hits":"PF2E.Damage.IWR.Type.critical-hits",custom:"",earth:"PF2E.Damage.RollFlavor.earth",electricity:"PF2E.Damage.RollFlavor.electricity",emotion:"PF2E.Damage.IWR.Type.emotion",energy:"PF2E.Damage.IWR.Type.energy",fire:"PF2E.Damage.RollFlavor.fire",force:"PF2E.Damage.RollFlavor.force","ghost-touch":"PF2E.Damage.IWR.Type.ghost-touch",glass:"PF2E.Damage.IWR.Type.glass",light:"PF2E.Damage.IWR.Type.light",magical:"PF2E.Damage.IWR.Type.magical",mental:"PF2E.Damage.RollFlavor.mental",metal:"PF2E.Damage.RollFlavor.metal",mythic:"PF2E.Damage.IWR.Type.mythic","non-magical":"PF2E.Damage.IWR.Type.non-magical","nonlethal-attacks":"PF2E.Damage.IWR.Type.nonlethal-attacks","persistent-damage":"PF2E.Damage.IWR.Type.persistent-damage",physical:"PF2E.Damage.IWR.Type.physical",piercing:"PF2E.Damage.RollFlavor.piercing",plant:"PF2E.Damage.IWR.Type.plant",poison:"PF2E.Damage.RollFlavor.poison",precision:"PF2E.Damage.RollFlavor.precision",radiation:"PF2E.Damage.IWR.Type.radiation",salt:"PF2E.Damage.IWR.Type.salt","salt-water":"PF2E.Damage.IWR.Type.salt-water",slashing:"PF2E.Damage.RollFlavor.slashing",sonic:"PF2E.Damage.RollFlavor.sonic",spells:"PF2E.Damage.IWR.Type.spells",spirit:"PF2E.Damage.RollFlavor.spirit","splash-damage":"PF2E.Damage.IWR.Type.splash-damage",time:"PF2E.Damage.IWR.Type.time","unarmed-attacks":"PF2E.Damage.IWR.Type.unarmed-attacks","vampire-weaknesses":"PF2E.Damage.IWR.Type.vampire-weaknesses",vitality:"PF2E.Damage.RollFlavor.vitality",void:"PF2E.Damage.RollFlavor.void",vorpal:"PF2E.Damage.IWR.Type.vorpal","vorpal-fear":"PF2E.Damage.IWR.Type.vorpal-fear","vulnerable-to-sunlight":"PF2E.Damage.IWR.Type.vulnerable-to-sunlight",water:"PF2E.Damage.IWR.Type.water",weapons:"PF2E.Damage.IWR.Type.weapons","weapons-shedding-bright-light":"PF2E.Damage.IWR.Type.weapons-shedding-bright-light",wood:"PF2E.Damage.IWR.Type.wood"},resistanceTypes={...materialIWR,...sanctifiedIWR,...traditionIWR,acid:"PF2E.Damage.RollFlavor.acid",air:"PF2E.Damage.RollFlavor.air",alchemical:"PF2E.Damage.IWR.Type.alchemical","all-damage":"PF2E.Damage.IWR.Type.all-damage","area-damage":"PF2E.Damage.IWR.Type.area-damage",axes:"PF2E.Damage.IWR.Type.axes",bleed:"PF2E.Damage.RollFlavor.bleed",bludgeoning:"PF2E.Damage.RollFlavor.bludgeoning",cold:"PF2E.Damage.RollFlavor.cold","critical-hits":"PF2E.Damage.IWR.Type.critical-hits",custom:"","damage-from-spells":"PF2E.Damage.IWR.Type.damage-from-spells",earth:"PF2E.Damage.RollFlavor.earth",electricity:"PF2E.Damage.RollFlavor.electricity",energy:"PF2E.Damage.IWR.Type.energy",fire:"PF2E.Damage.RollFlavor.fire",force:"PF2E.Damage.RollFlavor.force","ghost-touch":"PF2E.Damage.IWR.Type.ghost-touch",light:"PF2E.Damage.IWR.Type.light",magical:"PF2E.Damage.IWR.Type.magical",mental:"PF2E.Damage.RollFlavor.mental",metal:"PF2E.Damage.RollFlavor.metal",mythic:"PF2E.Damage.IWR.Type.mythic","non-magical":"PF2E.Damage.IWR.Type.non-magical",nonlethal:"PF2E.Damage.IWR.Type.nonlethal","nonlethal-attacks":"PF2E.Damage.IWR.Type.nonlethal-attacks","persistent-damage":"PF2E.Damage.IWR.Type.persistent-damage",physical:"PF2E.Damage.IWR.Type.physical",piercing:"PF2E.Damage.RollFlavor.piercing",plant:"PF2E.Damage.IWR.Type.plant",poison:"PF2E.Damage.RollFlavor.poison",precision:"PF2E.Damage.RollFlavor.precision","protean-anatomy":"PF2E.Damage.IWR.Type.protean-anatomy",radiation:"PF2E.Damage.IWR.Type.radiation",salt:"PF2E.Damage.IWR.Type.salt","salt-water":"PF2E.Damage.IWR.Type.salt-water",slashing:"PF2E.Damage.RollFlavor.slashing",sonic:"PF2E.Damage.RollFlavor.sonic",spells:"PF2E.Damage.IWR.Type.spells",spirit:"PF2E.Damage.RollFlavor.spirit",time:"PF2E.Damage.IWR.Type.time","unarmed-attacks":"PF2E.Damage.IWR.Type.unarmed-attacks",vitality:"PF2E.Damage.RollFlavor.vitality",void:"PF2E.Damage.RollFlavor.void",vorpal:"PF2E.Damage.IWR.Type.vorpal","vorpal-adamantine":"PF2E.Damage.IWR.Type.vorpal-adamantine",water:"PF2E.Damage.IWR.Type.water",weapons:"PF2E.Damage.IWR.Type.weapons","weapons-shedding-bright-light":"PF2E.Damage.IWR.Type.weapons-shedding-bright-light",wood:"PF2E.Damage.IWR.Type.wood"},ATTRIBUTE_ABBREVIATIONS=new Set(["str","dex","con","int","wis","cha"]),CREATURE_ACTOR_TYPES=["character","npc","familiar"],ACTOR_TYPES=["army","character","familiar","hazard","loot","npc","party","vehicle"],SAVE_TYPES=["fortitude","reflex","will"],IMMUNITY_TYPES=new Set(t$4(immunityTypes)),WEAKNESS_TYPES=new Set(t$4(weaknessTypes)),RESISTANCE_TYPES=new Set(t$4(resistanceTypes)),UNAFFECTED_TYPES=new Set(["bleed","good","evil","lawful","chaotic","spirit","vitality","void"]),CORE_SKILL_SLUGS=new Set(["acrobatics","arcana","athletics","crafting","deception","diplomacy","intimidation","medicine","nature","occultism","performance","religion","society","stealth","survival","thievery"]),MOVEMENT_TYPES=["land","burrow","climb","fly","swim"],SIZE_LINKABLE_ACTOR_TYPES=new Set([...CREATURE_ACTOR_TYPES,"vehicle"]);class Migration749AssuranceREs extends MigrationBase{static{__name(this,"Migration749AssuranceREs")}static{__name2(this,"Migration749AssuranceREs")}static version=.749;#isChoiceSetWithSelection(rule){return rule.key==="ChoiceSet"}#newRules(skill){const selector=skill==="choice"?"{item|flags.pf2e.rulesSelections.assurance}":skill;return[{key:"SubstituteRoll",label:"PF2E.SpecificRule.SubstituteRoll.Assurance",selector,slug:"assurance",value:10},{key:"AdjustModifier",predicate:{all:["substitute:assurance"],not:["bonus:type:proficiency"]},selector,suppress:!0}]}async updateItem(source2){const{slug,rules}=source2.system;if(!(source2.type==="feat"&&slug?.startsWith("assurance")))return;const firstRule=rules.at(0);if(slug==="assurance"&&firstRule&&rules.length===1&&this.#isChoiceSetWithSelection(firstRule))firstRule.flag="assurance",rules.push(...this.#newRules("choice"));else if(rules.length===0){const skill=/^assurance-([a-z]+)$/.exec(slug)?.at(1);setHasElement(CORE_SKILL_SLUGS,skill)&&rules.push(...this.#newRules(skill))}}}class Migration750FixCorruptedPrice extends MigrationBase{static{__name(this,"Migration750FixCorruptedPrice")}static{__name2(this,"Migration750FixCorruptedPrice")}static version=.75;async updateItem(source2){!itemIsOfType(source2,"physical")&&source2.type!=="kit"||typeof source2.system.price=="string"&&(source2.system.price={value:Coins.fromString(source2.system.price).toObject()})}}class Migration751ResetRollOptions extends MigrationBase{static{__name(this,"Migration751ResetRollOptions")}static{__name2(this,"Migration751ResetRollOptions")}static version=.751;async updateActor(source2){e$2(source2.flags.pf2e)&&"rollOptions"in source2.flags.pf2e&&(source2.flags.pf2e["-=rollOptions"]=null)}}class Migration752StrikeVsWeaponTraits extends MigrationBase{static{__name(this,"Migration752StrikeVsWeaponTraits")}static{__name2(this,"Migration752StrikeVsWeaponTraits")}static version=.752;#toSkip=new Set(["ghost-hunter","stance-arcane-cascade","spirit-strikes"]);async updateItem(source2){if(this.#toSkip.has(source2.system.slug??""))return;const rules=source2.system.rules.filter(r2=>r2.key==="AdjustStrike"&&r2.property==="traits");for(const rule of rules)objectHasKey(weaponTraits,rule.value)&&(rule.property="weapon-traits")}}class Migration753WeaponReloadTimes extends MigrationBase{static{__name(this,"Migration753WeaponReloadTimes")}static{__name2(this,"Migration753WeaponReloadTimes")}static version=.753;#hasThrownTrait(source2){return source2.system.traits.value.some(t2=>t2.startsWith("thrown"))}async updateItem(source2){if(source2.type!=="weapon")return;const slug=source2.system.slug??"";["backpack-catapult","backpack-catapult"].includes(slug)?source2.system.reload.value="10":(source2.system.baseItem==="alchemical-bomb"||this.#hasThrownTrait(source2))&&(source2.system.reload.value="-")}}class Migration754MightyBulwarkAdjustModifiers extends MigrationBase{static{__name(this,"Migration754MightyBulwarkAdjustModifiers")}static{__name2(this,"Migration754MightyBulwarkAdjustModifiers")}static version=.754;async updateItem(source2){if(!(source2.type==="feat"&&source2.system.slug==="mighty-bulwark"))return;const newRules=[{key:"FlatModifier",predicate:{all:["self:armor:trait:bulwark"]},selector:"reflex",type:"untyped",value:4},{key:"AdjustModifier",predicate:{all:["self:armor:trait:bulwark"]},selector:"reflex",slug:"dex",suppress:!0},{key:"AdjustModifier",selector:"reflex",slug:"bulwark",suppress:!0}];source2.system.rules=newRules}}class Migration755GrantIdsToData extends MigrationBase{static{__name(this,"Migration755GrantIdsToData")}static{__name2(this,"Migration755GrantIdsToData")}static version=.755;async updateActor(source2){for(const item of source2.items){if(!item.flags.pf2e)continue;const systemFlags=item.flags.pf2e,{grantedBy,itemGrants}=systemFlags;typeof grantedBy=="string"&&(source2.items.find(i=>i._id===grantedBy)?systemFlags.grantedBy={id:grantedBy}:systemFlags["-=grantedBy"]=null),Array.isArray(itemGrants)&&(systemFlags.itemGrants=itemGrants.flatMap(grant=>typeof grant=="string"?source2.items.find(i=>i._id===grant)?{id:grant}:[]:grant))}}}class Migration756RMStoredResourceMaxes extends MigrationBase{static{__name(this,"Migration756RMStoredResourceMaxes")}static{__name2(this,"Migration756RMStoredResourceMaxes")}static version=.756;async updateActor(source2){source2.type==="character"&&(source2["system.resources.focus.-=max"]=null,source2["system.resources.crafting.infusedReagents.-=max"]=null,source2["system.resources.-=investiture"]=null)}}class Migration757HillockHalfling extends MigrationBase{static{__name(this,"Migration757HillockHalfling")}static{__name2(this,"Migration757HillockHalfling")}static version=.757;async updateItem(itemSource){if(itemSource.type!=="heritage"||(itemSource.system.slug??sluggify(itemSource.name))!=="hillock-halfling")return;const rules=itemSource.system.rules;if(!rules.some(rule=>"path"in rule&&rule.path==="system.attributes.hp.recoveryAddend")){const element={key:"ActiveEffectLike",mode:"add",path:"system.attributes.hp.recoveryAddend",value:"@actor.level"};rules.push(element)}}}class Migration758PrunePCAttributes extends MigrationBase{static{__name(this,"Migration758PrunePCAttributes")}static{__name2(this,"Migration758PrunePCAttributes")}static version=.758;toDelete=["-=ac","-=ancestryhp","-=battleForm","-=classDC","-=classOrSpellDC","-=classhp","-=dexCap","-=doomed","-=dying","-=familiarAbilities","-=flanking","-=flatbonushp","-=flatbonussp","-=handsFree","-=hardness","hp.-=breakdown","hp.-=details","hp.-=max","hp.-=name","hp.-=negativeHealing","hp.-=recoveryMultiplier","hp.-=totalModifier","hp.-=tempsource","hp.-=_modifiers","initiative.-=_modifiers","initiative.-=breakdown","initiative.-=label","initiative.-=name","initiative.-=roll","initiative.-=tiebreakPriority","initiative.-=totalModifier","-=levelbonushp","-=levelbonussp","-=perception","-=polymorphed","-=reach","-=shield","speed.-=_modifiers","speed.-=breakdown","speed.-=name","speed.-=total","speed.-=totalModifier","speed.-=type","-=spellDC","-=wounded"];async updateActor(source2){if(source2.type==="character")for(const key of this.toDelete)source2[`system.attributes.${key}`]=null}}class Migration759CritSpecRE extends MigrationBase{static{__name(this,"Migration759CritSpecRE")}static{__name2(this,"Migration759CritSpecRE")}static version=.759;async updateItem(source2){if(!["feat","weapon"].includes(source2.type))return;const critSpecKey="CriticalSpecialization";if(!source2.system.rules.some(r2=>r2.key===critSpecKey))switch(source2.system.slug){case"archer-dedication":{source2.system.rules.push({key:critSpecKey,predicate:{all:["weapon:group:bow",{gte:["weapon:proficiency:rank",2]}]}});return}case"azarketi-weapon-aptitude":{source2.system.rules=[{key:critSpecKey,predicate:{any:["weapon:trait:azarketi","weapon:base:crossbow","weapon:base:hand-crossbow","weapon:base:longspear","weapon:base:spear","weapon:base:trident"]}}];return}case"brawling-focus":{source2.system.rules=[{key:critSpecKey,predicate:{any:["weapon:group:brawling",{and:["feat:monastic-weaponry","weapon:trait:monk",{not:"weapon:category:unarmed"},{gte:["weapon:proficiency:rank",1]}]}]}}];return}case"brutality":{source2.system.rules=source2.system.rules.filter(r2=>r2.key!=="Note"),source2.system.rules.push({key:critSpecKey,predicate:{all:["self:effect:rage","weapon:melee"]}});return}case"catfolk-weapon-rake":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:catfolk","weapon:base:hatchet","weapon:base:kama","weapon:base:kukri","weapon:base:scimitar","weapon:base:sickle"]}}];return}case"conrasu-weapon-understanding":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:conrasu","weapon:base:glaive","weapon:base:longspear","weapon:base:longsword","weapon:base:shortbow","weapon:base:spear"]}}];return}case"dwarven-weapon-cunning":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:dwarf","weapon:base:battle-axe","weapon:base:pick","weapon:base:warhammer"]}}];return}case"elven-weapon-elegance":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:elf","weapon:base:longbow","weapon:base:longsword","weapon:base:rapier","weapon:base:shortbow"]}}];return}case"fighter-weapon-mastery":{source2.system.rules=source2.system.rules.filter(r2=>r2.key!=="Note"),source2.system.rules.push({key:critSpecKey,predicate:{all:[{gte:["weapon:proficiency:rank",3]}]}});return}case"genie-weapon-flourish":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:geniekin","weapon:base:falchion","weapon:base:ranseur","weapon:base:scimitar","weapon:base:trident"]}}];return}case"gnoll-weapon-practicality":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:gnoll","weapon:base:flail","weapon:base:khopesh","weapon:base:mambele","weapon:base:spear","weapon:base:war-flail"]}}];return}case"gnome-weapon-innovator":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:gnome","weapon:base:glaive","weapon:base:kukri"]}}];return}case"goblin-weapon-frenzy":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{all:["weapon:trait:goblin"]}}];return}case"grippli-weapon-innovator":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:grippli","weapon:base:blowgun","weapon:base:hatchet","weapon:base:scythe","weapon:base:shortbow"]}}];return}case"gunslinger-weapon-mastery":{source2.system.rules=source2.system.rules.filter(r2=>r2.key!=="Note"),source2.system.rules.push({key:critSpecKey,predicate:{any:["weapon:group:firearm","weapon:tag:crossbow"]}});return}case"halfling-weapon-trickster":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:halfling","weapon:base:shortsword","weapon:base:sling"]}}];return}case"hobgoblin-weapon-discipline":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:group:polearm","weapon:group:spear","weapon:group:sword"]}}];return}case"improvised-critical":{source2.system.rules=[{key:critSpecKey,predicate:{all:["weapon:tag:improvised"]}}];return}case"kobold-weapon-innovator":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:kobold","weapon:base:crossbow","weapon:base:greatpick","weapon:base:light-pick","weapon:base:pick","weapon:base:spear"]}}];return}case"mauler-dedication":{source2.system.rules.push({key:"CriticalSpecialization",predicate:{all:["weapon:melee",{or:["weapon:category:simple","weapon:category:martial"]},{or:["weapon:usage:hands:2","weapon:trait:two-hand-d6","weapon:trait:two-hand-d8","weapon:trait:two-hand-d10","weapon:trait:two-hand-d12"]}]}});return}case"orc-weapon-carnage":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:trait:orc","weapon:base:falchion","weapon:base:greataxe"]}}];return}case"ranger-weapon-expertise":{source2.system.rules=source2.system.rules.filter(r2=>r2.key!=="Note"),source2.system.rules.push({key:critSpecKey,predicate:{all:["hunted-prey"],any:["weapon:category:simple","weapon:category:martial"]}});return}case"spike-launcher":{const rule={key:critSpecKey,alternate:!0,predicate:{all:["weapon:id:{item|_id}"]},text:"PF2E.Item.Weapon.CriticalSpecialization.bow"};source2.system.rules.push(rule);return}case"student-of-the-staff":{source2.system.rules=source2.system.rules.filter(r2=>r2.key!=="Note"),source2.system.rules.unshift({key:critSpecKey,predicate:{all:["weapon:base:staff"]}});return}case"sun-sling":{source2.system.rules.push({key:critSpecKey,predicate:{all:["weapon:id:{item|_id}","feat:suns-fury"]}});return}case"suns-fury":{source2.system.rules=[];return}case"third-doctrine-warpriest":{source2.system.rules.push({key:critSpecKey,predicate:{all:["weapon:deity-favored"]}});return}case"vanths-weapon-execution":{source2.system.rules=[{key:"CriticalSpecialization",predicate:{any:["weapon:base:bo-staff","weapon:base:longbow","weapon:base:scythe","weapon:base:staff"]}}];return}case"weapon-expertise-swashbuckler":{source2.system.rules=source2.system.rules.filter(r2=>r2.key!=="Note"),source2.system.rules.push({key:critSpecKey,predicate:{all:[{gte:["weapon:proficiency:rank",2]}]}});return}case"weapon-tricks":{source2.system.rules=source2.system.rules.filter(r2=>r2.key!=="Note"),source2.system.rules.push({key:critSpecKey,predicate:{all:["target:condition:flat-footed"],any:[{and:[{or:["weapon:trait:agile","weapon:trait:finesse"]},{or:["weapon:category:simple","weapon:category:unarmed"]}]},"weapon:base:rapier","weapon:base:sap","weapon:base:shortbow","weapon:base:shortsword"]}});return}}}}class Migration760SeparateNoteTitle extends MigrationBase{static{__name(this,"Migration760SeparateNoteTitle")}static{__name2(this,"Migration760SeparateNoteTitle")}static version=.76;#cleanText(text2){return text2.replace(/^@Localize\[(.+)\]$/,"$1").replace(/^PF2E\.WeaponDescription([A-Z][a-z]+)$/,(substring,group)=>typeof group=="string"?`PF2E.Item.Weapon.CriticalSpecialization.${group.toLowerCase()}`:substring)}async updateItem(source2){const notes=source2.system.rules.filter(r2=>r2.key==="Note"&&typeof r2.text=="string"&&!("title"in r2));for(const note of notes){if(note.text=note.text.trim(),!note.text.startsWith("<p"))continue;const pElement=(()=>{const text2=note.text.includes("</p>")?note.text:`${note.text}</p>`;try{const fragment=document.createElement("template");fragment.innerHTML=text2;const children2=Array.from(fragment.content.childNodes);if(children2.length===1&&children2[0]instanceof HTMLElement)return children2[0];if(children2.length===2&&children2[0]instanceof HTMLParagraphElement&&children2[1]instanceof Text){const[first,second]=children2;return first.append(second),first}else return null}catch{return null}})();if(pElement?.nodeName!=="P")continue;const children=Array.from(pElement.childNodes);if(children.length===1&&children[0]instanceof Text){note.text=this.#cleanText(children[0].textContent??""),pElement.dataset.visibility&&["gm","owner"].includes(pElement.dataset.visibility)&&(note.visibility=pElement.dataset.visibility);continue}if(children.length!==2||!(children[0]instanceof HTMLElement)||children[0].nodeName!=="STRONG"||!(children[1]instanceof Text))continue;const strongElement=children[0];strongElement.remove();const newText=pElement.innerHTML.trim();if(newText===""||note.text.includes("<span"))continue;const newTitle=strongElement.innerHTML.trim();newTitle===source2.name?note.title="{item|name}":newTitle==="Critical Specialization"?note.title="PF2E.Actor.Creature.CriticalSpecialization":newTitle==="Effect"?note.title="TYPES.Item.effect":note.title=newTitle,note.text=this.#cleanText(newText),pElement.dataset.visibility&&(note.visibility=pElement.dataset.visibility)}}}class Migration761ShotRules extends MigrationBase{static{__name(this,"Migration761ShotRules")}static{__name2(this,"Migration761ShotRules")}static version=.761;async updateItem(source2){switch(source2.type){case"effect":this.#updateEffect(source2);break;case"feat":this.#updateFeat(source2);break}}#updateEffect(source2){if(source2.system.slug==="stance-multishot-stance"){const newRules=[{key:"AdjustModifier",mode:"add",predicate:{all:["double-shot"]},relabel:"{item|name}",selector:"ranged-attack-roll",slug:"double-shot",value:1},{key:"AdjustModifier",mode:"add",predicate:{all:["triple-shot"]},relabel:"{item|name}",selector:"ranged-attack-roll",slug:"double-shot",value:1}];source2.system.rules=newRules}}#updateFeat(source2){switch(source2.system.slug){case"double-shot":{const newRules=[{domain:"ranged-attack-roll",key:"RollOption",option:"double-shot",toggleable:!0},{key:"FlatModifier",predicate:{all:["double-shot","weapon:reload:0"]},selector:"ranged-attack-roll",slug:"double-shot",value:-2}];source2.system.rules=newRules;break}case"triple-shot":{const newRules=[{domain:"ranged-attack-roll",disabledIf:{not:["double-shot"]},key:"RollOption",option:"triple-shot",priority:51,toggleable:!0},{key:"AdjustModifier",mode:"override",predicate:{all:["double-shot","triple-shot"]},relabel:"{item|name}",selector:"ranged-attack-roll",slug:"double-shot",value:-4}];source2.system.rules=newRules;break}}}}class Migration762UpdateBackgroundItems extends MigrationBase{static{__name(this,"Migration762UpdateBackgroundItems")}static{__name2(this,"Migration762UpdateBackgroundItems")}static version=.762;async updateItem(source2){source2.type==="background"&&(source2.system.slug==="amnesiac"||source2.system.slug==="discarded-duplicate")&&Object.values(source2.system.boosts).length!==3&&(source2.system.boosts[2]={value:["cha","con","dex","int","str","wis"],selected:null})}}class Migration763RestoreAnimalStrikeOptions extends MigrationBase{static{__name(this,"Migration763RestoreAnimalStrikeOptions")}static{__name2(this,"Migration763RestoreAnimalStrikeOptions")}static version=.763;async updateItem(source2){if(source2.type!=="feat"||!/^[a-z]+-animal-instinct$/.test(source2.system.slug??""))return;const strikeRE=source2.system.rules.find(r2=>r2.key==="Strike"&&!Array.isArray(r2.options));strikeRE&&(strikeRE.options=["animal-instinct"])}}class Migration764PanacheVivaciousREs extends MigrationBase{static{__name(this,"Migration764PanacheVivaciousREs")}static{__name2(this,"Migration764PanacheVivaciousREs")}static version=.764;async updateItem(source2){source2.type==="feat"&&(source2.system.slug==="panache"?source2.system.rules=[]:source2.system.slug==="vivacious-speed"&&(source2.system.rules=this.#vivaciousRules))}get#vivaciousRules(){return[{key:"FlatModifier",predicate:{all:["self:effect:panache"]},selector:"speed",slug:"vivacious-full",type:"status",value:{brackets:[{end:2,value:5},{end:6,start:3,value:10},{end:10,start:7,value:15},{end:14,start:11,value:20},{end:18,start:15,value:25},{start:19,value:30}]}},{key:"FlatModifier",predicate:{not:["self:effect:panache"]},selector:"speed",slug:"vivacious-half",type:"status",value:{brackets:[{end:10,start:3,value:5},{end:18,start:11,value:10},{start:19,value:15}]}}]}}class Migration765ChoiceOwnedItemTypes extends MigrationBase{static{__name(this,"Migration765ChoiceOwnedItemTypes")}static{__name2(this,"Migration765ChoiceOwnedItemTypes")}static version=.765;async updateItem(source2){for(const rule of source2.system.rules)rule.key==="ChoiceSet"&&"choices"in rule&&e$2(rule.choices)&&rule.choices.ownedItems&&!rule.choices.types&&(rule.choices.types=["weapon"])}}class Migration766WipeURLSources extends MigrationBase{static{__name(this,"Migration766WipeURLSources")}static{__name2(this,"Migration766WipeURLSources")}static version=.766;async updateItem(source2){(!("game"in globalThis)||source2._stats.compendiumSource?.startsWith("Compendium.pf2e."))&&"source"in source2.system&&e$2(source2.system.source)&&typeof source2.system.source.value=="string"&&source2.system.source.value.startsWith("http")&&(source2.system.source.value="")}}class Migration767ConvertVoluntaryFlaws extends MigrationBase{static{__name(this,"Migration767ConvertVoluntaryFlaws")}static{__name2(this,"Migration767ConvertVoluntaryFlaws")}static version=.767;async updateItem(source2){if(source2.type!=="ancestry")return;const system2=source2.system,oldFlaws=Object.values(system2.voluntaryFlaws??{}).map(b=>b.selected).filter(a=>!!a),oldBoosts=Object.values(system2.voluntaryBoosts??{}).map(b=>b.selected).filter(a=>!!a);(oldBoosts.length||oldFlaws.length)&&(system2.voluntary={boost:oldBoosts.at(0)||null,flaws:oldFlaws}),system2.voluntaryBoosts&&(delete system2.voluntaryBoosts,delete system2["-=voluntaryBoosts"]),system2.voluntaryFlaws&&(delete system2.voluntaryFlaws,delete system2.voluntaryFlaws)}}class Migration768AddNewAuras extends MigrationBase{static{__name(this,"Migration768AddNewAuras")}static{__name2(this,"Migration768AddNewAuras")}static version=.768;#auraOfLife={effects:[{affects:"allies",events:["enter"],uuid:"Compendium.pf2e.feat-effects.FPuICuxBLiDaEbDX"}],key:"Aura",radius:15,slug:"aura-of-life"};#enlightenedPresence={effects:[{affects:"allies",events:["enter"],uuid:"Compendium.pf2e.feat-effects.XM1AA8z5cHm8sJXM"}],key:"Aura",radius:15,slug:"enlightened-presence",traits:["emotion","mental"]};#eternalBlessing=[{domain:"all",key:"RollOption",option:"eternal-blessing-active",toggleable:!0,value:!0},{effects:[{affects:"allies",events:["enter"],uuid:"Compendium.pf2e.spell-effects.Gqy7K6FnbLtwGpud"}],key:"Aura",predicate:{all:["eternal-blessing-active"]},radius:15,slug:"eternal-blessing",traits:["enchantment","mental"]}];#marshalsAura={effects:[{affects:"allies",events:["enter"],uuid:"Compendium.pf2e.feat-effects.Ru4BNABCZ0hUbX7S"}],key:"Aura",radius:10,slug:"marshals-aura",traits:["emotion","mental","visual"]};async updateItem(source2){if(!(source2.type!=="feat"||source2.system.rules.length>0))switch(source2.system.slug){case"aura-of-life":source2.system.rules=[foundry.utils.deepClone(this.#auraOfLife)];break;case"enlightened-presence":source2.system.rules=[foundry.utils.deepClone(this.#enlightenedPresence)];break;case"eternal-blessing":source2.system.rules=foundry.utils.deepClone(this.#eternalBlessing);break;case"marshal-dedication":source2.system.rules=[foundry.utils.deepClone(this.#marshalsAura)];break}}}class Migration769NoUniversalistFocusPool extends MigrationBase{static{__name(this,"Migration769NoUniversalistFocusPool")}static{__name2(this,"Migration769NoUniversalistFocusPool")}static version=.769;async updateItem(source2){if(source2.type==="feat"&&source2.system.slug==="arcane-school"){const rule=source2.system.rules.find(r2=>r2.key==="ActiveEffectLike"&&r2.path==="system.resources.focus.max");rule&&(rule.predicate={not:["feature:universalist"]})}}}class Migration770REDataToSystem extends MigrationBase{static{__name(this,"Migration770REDataToSystem")}static{__name2(this,"Migration770REDataToSystem")}static version=.77;async updateActor(source2){source2.system=recursiveReplaceString(source2.system,value=>value.replace(/@(actor|item)\.data\.data./g,"@$1.system.").replace(/@(actor|item)\.data./g,"@$1."))}async updateItem(source2){source2.system=recursiveReplaceString(source2.system,value=>value.replace(/^data\.data\./,"system.").replace(/^data\./,"system.").replace(/"data\.data\./g,'"system.').replace(/"data\./g,'"system.').replace(/@(actor|item)\.data\.data./g,"@$1.system.").replace(/@(actor|item)\.data./g,"@$1.").replace(/\b(actor|item|rule)\|data\.data\./g,"$1|system.").replace(/\b(actor|item|rule)\|data\./g,"$1|system."))}}class Migration771SpellVariantsToSystem extends MigrationBase{static{__name(this,"Migration771SpellVariantsToSystem")}static{__name2(this,"Migration771SpellVariantsToSystem")}static version=.771;async updateItem(source2){if(source2.type==="spell"){for(const overlayData of Object.values(source2.system.overlays??{}))if(overlayData.overlayType==="override"){const maybeWithData=overlayData;maybeWithData.data&&(delete Object.assign(maybeWithData,{system:maybeWithData.data}).data,maybeWithData["-=data"]=null)}}}}class Migration772V10EmbeddedSpellData extends MigrationBase{static{__name(this,"Migration772V10EmbeddedSpellData")}static{__name2(this,"Migration772V10EmbeddedSpellData")}static version=.772;async preUpdateItem(source2){if(source2.type==="consumable"&&source2.system.spell){const embeddedSpell=source2.system.spell;embeddedSpell.data?.data?(source2.system.spell=embeddedSpell.data,source2.system.spell.system=embeddedSpell.data.data,source2.system.spell.system.location.heightenedLevel=Number(embeddedSpell.data.heightenedLevel)||source2.system.spell.system.level.value,embeddedSpell.data["-=data"]=null,delete embeddedSpell.data.data):embeddedSpell.data?.system?(source2.system.spell=embeddedSpell.data,source2.system.spell.system.location.heightenedLevel=Number(embeddedSpell.data.heightenedLevel)||source2.system.spell.system.level.value):embeddedSpell.data===null&&(source2.system.spell=null)}}}class Migration773ReligiousSymbolUsage extends MigrationBase{static{__name(this,"Migration773ReligiousSymbolUsage")}static{__name2(this,"Migration773ReligiousSymbolUsage")}static version=.773;async updateItem(source2){source2.type==="equipment"&&source2.system.slug?.startsWith("religious-symbol")&&(source2.system.usage.value="held-in-one-hand")}}class Migration774UnpersistCraftingEntries extends MigrationBase{static{__name(this,"Migration774UnpersistCraftingEntries")}static{__name2(this,"Migration774UnpersistCraftingEntries")}static version=.774;munitionsCrafterPredicate={all:["item:trait:alchemical"],any:["item:trait:bomb","item:subtype:ammo"]};async updateActor(source2){if(source2.type==="character"){const craftingData=source2.system.crafting??{},craftingEntries=craftingData.entries??{},rules=source2.items.flatMap(i=>i.system.rules);for(const rule of rules)rule.key!=="CraftingEntry"||typeof rule.selector!="string"||rule.selector.length===0||!rule.requiredTraits||(rule.preparedFormulas=craftingEntries[rule.selector]?.actorPreparedFormulas??[]);delete craftingData.entries,craftingData["-=entries"]=null}}async updateItem(source2){const rules=source2.system.rules,craftingEntryRules=rules.filter(r2=>r2.key==="CraftingEntry"&&Array.isArray(r2.requiredTraits)),newCraftingEntryRules=craftingEntryRules.map(craftingEntryRule=>(craftingEntryRule.craftableItems=craftingEntryRule.selector==="munitionsCrafter"?this.munitionsCrafterPredicate:this.generatePredicateFromRequiredTraits(craftingEntryRule.requiredTraits||[]),delete craftingEntryRule.requiredTraits,craftingEntryRule));for(const craftingEntryRule of craftingEntryRules){const index2=rules.indexOf(craftingEntryRule);rules.splice(index2,1,newCraftingEntryRules.shift()),delete craftingEntryRule.requiredTraits}const craftingEntryAELikes=rules.filter(r2=>r2.key==="ActiveEffectLike"&&typeof r2.path=="string"&&r2.path.startsWith("system.crafting.entries.")),newCraftingEntryAELikes=craftingEntryAELikes.map(craftingEntryAELike=>(craftingEntryAELike.phase="beforeDerived",craftingEntryAELike));for(const craftingEntryAELike of craftingEntryAELikes){const index2=rules.indexOf(craftingEntryAELike);rules.splice(index2,1,newCraftingEntryAELikes.shift())}}generatePredicateFromRequiredTraits(requiredTraits){return requiredTraits.length===1?{all:requiredTraits[0].map(trait=>`item:trait:${trait}`)}:{any:requiredTraits.map(traits=>({and:traits.map(trait=>`item:trait:${trait}`)}))}}}class Migration775AgileFinesseRanged extends MigrationBase{static{__name(this,"Migration775AgileFinesseRanged")}static{__name2(this,"Migration775AgileFinesseRanged")}static version=.775;#findDamageDiceRE(source2){return source2.system.rules.find(r2=>r2.key==="DamageDice")??null}#isClassFeature(source2){return source2.type==="feat"&&"featType"in source2.system&&e$2(source2.system.featType)&&source2.system.featType.value==="classfeature"}async updateItem(source2){switch(source2.type){case"action":{if(source2.system.slug==="sneak-attack"){const damageDiceRE=this.#findDamageDiceRE(source2);e$2(damageDiceRE)&&e$2(damageDiceRE.predicate)&&Array.isArray(damageDiceRE.predicate.all)&&damageDiceRE.predicate.all.some(s=>s instanceof Object&&"or"in s)&&(damageDiceRE.predicate=this.#sneakAttackPredicate)}break}case"feat":switch(source2.system.slug){case"athletic-strategist":{const index2=source2.system.rules.findIndex(r2=>r2.key==="FlatModifier");index2!==-1&&(source2.system.rules[index2]=this.#athleticStrategist);break}case"devise-a-stratagem":{const index2=source2.system.rules.findIndex(r2=>r2.key==="FlatModifier");index2!==-1&&(source2.system.rules[index2]=this.#deviseAStratagem);break}case"ruffian":{const damageDiceRE=this.#findDamageDiceRE(source2);damageDiceRE&&(damageDiceRE.predicate=this.#ruffianPredicate);break}case"shadow-sneak-attack":case"sneak-attack":case"sneak-attacker":{const damageDiceRE=this.#findDamageDiceRE(source2);if(damageDiceRE){const predicate=this.#sneakAttackPredicate;this.#isClassFeature(source2)&&predicate.all?.unshift("class:rogue"),damageDiceRE.predicate=predicate}break}}}}get#athleticStrategist(){return{ability:"int",key:"FlatModifier",predicate:{all:["class:investigator","devise-a-stratagem",{or:["action:disarm","action:grapple","action:shove","action:trip"]}],any:["weapon:trait:agile","weapon:trait:finesse",{and:["weapon:ranged",{not:"weapon:thrown-melee"}]},"weapon:base:sap"]},selector:"athletics",type:"ability"}}get#deviseAStratagem(){return{ability:"int",key:"FlatModifier",predicate:{all:["class:investigator","devise-a-stratagem"],any:["weapon:trait:agile","weapon:trait:finesse",{and:["weapon:ranged",{not:"weapon:thrown-melee"}]},"weapon:base:sap"]},selector:"attack-roll",type:"ability"}}get#ruffianPredicate(){return{all:["target:condition:flat-footed","weapon:category:simple",{nor:[{and:["weapon:ranged",{not:"weapon:thrown-melee"}]},"weapon:trait:agile","weapon:trait:finesse"]}]}}get#sneakAttackPredicate(){return{all:["target:condition:flat-footed"],any:["weapon:trait:agile","weapon:trait:finesse",{and:["weapon:ranged",{not:"weapon:thrown-melee"}]}]}}}class Migration776SlugifyConditionOverrides extends MigrationBase{static{__name(this,"Migration776SlugifyConditionOverrides")}static{__name2(this,"Migration776SlugifyConditionOverrides")}static version=.776;async updateItem(source2){if(source2.type!=="condition")return;const{system:system2}=source2;Array.isArray(system2.overrides)&&system2.overrides.every(o=>typeof o=="string")&&(system2.overrides=system2.overrides.map(o=>sluggify(o)))}}class Migration777HandOfTheApprentice extends MigrationBase{static{__name(this,"Migration777HandOfTheApprentice")}static{__name2(this,"Migration777HandOfTheApprentice")}static version=.777;async updateItem(source2){if(source2.type==="feat"&&source2.system.slug==="hand-of-the-apprentice"){const rule={key:"ActiveEffectLike",mode:"add",path:"system.resources.focus.max",value:1};source2.system.rules=[rule]}}}class Migration778RenameRetiredPackRefs extends MigrationBase{static{__name(this,"Migration778RenameRetiredPackRefs")}static{__name2(this,"Migration778RenameRetiredPackRefs")}static version=.778;async updateItem(source2){const rename=__name2(text2=>text2.replace(/\bpf2e\.consumable-effects\b/g,"pf2e.equipment-effects").replace(/\bpf2e\.exploration-effects\b/g,"pf2e.other-effects").replace(/\bpf2e\.feature-effects\b/g,"pf2e.feat-effects").replace(/\bpf2e\.equipment-effects\.I9lfZUiCwMiGogVi\b/g,"pf2e.other-effects.I9lfZUiCwMiGogVi").replace(/\bpf2e\.equipment-effects\.Cover\b/g,"pf2e.other-effects.Effect: Cover"),"rename");source2.system.rules=recursiveReplaceString(source2.system.rules,rename),source2.system.description=recursiveReplaceString(source2.system.description,rename)}}class Migration779EliteWeak extends MigrationBase{static{__name(this,"Migration779EliteWeak")}static{__name2(this,"Migration779EliteWeak")}static version=.779;async updateActor(source2){if(!(source2.type==="npc"&&source2.system.traits.traits?.value))return;const traits=source2.system.traits.traits,adjustment=traits.value.includes("elite")?"elite":traits.value.includes("weak")?"weak":null;adjustment&&(source2.system.attributes.adjustment=adjustment,traits.value=traits.value.filter(trait=>trait!=="elite"&&trait!=="weak"))}}class Migration780NumifySpeeds extends MigrationBase{static{__name(this,"Migration780NumifySpeeds")}static{__name2(this,"Migration780NumifySpeeds")}static version=.78;async updateActor(source2){if(source2.type!=="npc")return;const speeds=source2.system.attributes.speed;speeds.value=this.#updateSpeed(speeds.value),Array.isArray(speeds.otherSpeeds)||(speeds.otherSpeeds=[]);for(const movementType of speeds.otherSpeeds)movementType.value=this.#updateSpeed(movementType.value)}#updateSpeed(speed){const numifiedValue=parseInt(String(speed),10);return Number.isNaN(numifiedValue)?25:numifiedValue}}class Migration781SuppressNoCrowbar extends MigrationBase{static{__name(this,"Migration781SuppressNoCrowbar")}static{__name2(this,"Migration781SuppressNoCrowbar")}static version=.781;get#suppressNoCrowbar(){return{key:"AdjustModifier",selector:"athletics",slug:"no-crowbar",suppress:!0}}async updateItem(source2){if(!source2.system.slug)return;const isCrowbar=source2.type==="equipment"&&/^crowbar(?:-levered)?$/.test(source2.system.slug),isForcedEntry=source2.type==="feat"&&source2.system.slug==="forced-entry";(isCrowbar||isForcedEntry)&&!source2.system.rules.some(r2=>r2.key==="AdjustModifier")&&source2.system.rules.push(this.#suppressNoCrowbar)}}class Migration782UnnestActorTraits extends MigrationBase{static{__name(this,"Migration782UnnestActorTraits")}static{__name2(this,"Migration782UnnestActorTraits")}static version=.782;async updateActor(source2){const traits=source2.system.traits;traits&&traits.traits&&Array.isArray(traits.traits.value)&&(traits.value=traits.traits.value,delete traits.traits,traits["-=traits"]=null)}}class Migration783RemoveClassSkillAELikes extends MigrationBase{static{__name(this,"Migration783RemoveClassSkillAELikes")}static{__name2(this,"Migration783RemoveClassSkillAELikes")}static version=.783;async updateItem(source2){source2.type==="class"&&(source2.system.rules=source2.system.rules.filter(r2=>!(r2.key==="ActiveEffectLike"&&typeof r2.path=="string"&&/^system.skills\.[a-z]{3}\.rank$/.test(r2.path)&&r2.value===1)))}}class Migration784CompBrowserPackSetting extends MigrationBase{static{__name(this,"Migration784CompBrowserPackSetting")}static{__name2(this,"Migration784CompBrowserPackSetting")}static version=.784;async migrate(){const savedSettings=game.settings.get("pf2e","compendiumBrowserPacks");if(savedSettings instanceof String){const settings=JSON.parse(savedSettings.toString());await game.settings.set("pf2e","compendiumBrowserPacks",settings);const browser=game?.pf2e?.compendiumBrowser;browser&&(browser.settings=settings,browser.initCompendiumList())}}}class Migration785ABCKitItemUUIDs extends MigrationBase{static{__name(this,"Migration785ABCKitItemUUIDs")}static{__name2(this,"Migration785ABCKitItemUUIDs")}static version=.785;async updateItem(source2){switch(source2.type){case"ancestry":case"background":case"class":case"kit":this.#convertToUUIDs(Object.values(source2.system.items))}}#convertToUUIDs(references){for(const reference of references)reference.id&&reference.pack?reference.uuid=`Compendium.${reference.pack}.${reference.id}`:reference.id&&(reference.uuid=`Item.${reference.id}`),delete reference.id,delete reference.pack,reference["-=id"]=null,reference["-=pack"]=null,reference.items&&this.#convertToUUIDs(Object.values(reference.items))}}class Migration786RemoveIdentifiedData extends MigrationBase{static{__name(this,"Migration786RemoveIdentifiedData")}static{__name2(this,"Migration786RemoveIdentifiedData")}static version=.786;async updateItem(source2){if(!itemIsOfType(source2,"physical"))return;const identification=source2.system.identification??{};identification.identified&&(identification["-=identified"]=null)}}class Migration787ResolvablesToSystem extends MigrationBase{static{__name(this,"Migration787ResolvablesToSystem")}static{__name2(this,"Migration787ResolvablesToSystem")}static version=.787;async updateItem(source2){source2.system=recursiveReplaceString(source2.system,value=>value.replace(/@(weapon|spell)\.data\.data./g,"@$1.system.").replace(/@(weapon|spell)\.data./g,"@$1."))}}class Migration788UpdateTanglefootBags extends MigrationBase{static{__name(this,"Migration788UpdateTanglefootBags")}static{__name2(this,"Migration788UpdateTanglefootBags")}static version=.788;async updateItem(source2){if(source2.type==="weapon"&&source2.system.slug?.startsWith("tanglefoot-bag-"))switch(source2.system.damage.dice=0,source2.system.slug){case"tanglefoot-bag-lesser":{source2.system.rules=this.#getRules("Lesser");return}case"tanglefoot-bag-moderate":{source2.system.rules=this.#getRules("Moderate");return}case"tanglefoot-bag-greater":{source2.system.rules=this.#getRules("Greater");return}case"tanglefoot-bag-major":{source2.system.rules=this.#getRules("Major");return}}}#getRules(type2){return[{key:"Note",outcome:["success"],selector:"{item|_id}-attack",text:`PF2E.BombNotes.TanglefootBag.${type2}.success`,title:"TYPES.Item.effect"},{key:"Note",outcome:["criticalSuccess"],selector:"{item|_id}-attack",text:`PF2E.BombNotes.TanglefootBag.${type2}.criticalSuccess`,title:"TYPES.Item.effect"}]}}class Migration789UpdatePreciseStrike extends MigrationBase{static{__name(this,"Migration789UpdatePreciseStrike")}static{__name2(this,"Migration789UpdatePreciseStrike")}static version=.789;async updateItem(source2){if(source2.type==="feat"){if(source2.system.slug==="precise-strike")source2.system.rules=this.#preciseStrikeRules;else if(source2.system.slug==="finishing-precision"){const rules=source2.system.rules.filter(r2=>r2.key==="GrantItem");source2.system.rules=[...rules,...this.#finishingPrecisionRules]}}}get#preciseStrikeRules(){return[{domain:"damage-roll",key:"RollOption",label:"PF2E.SpecificRule.PreciseStrike.Finisher",option:"finisher",toggleable:!0},{damageCategory:"precision",key:"FlatModifier",predicate:{all:["class:swashbuckler","self:effect:panache",{or:["weapon:melee",{and:["feat:flying-blade","weapon:thrown","target:range-increment:1"]}]}],any:["weapon:trait:agile","weapon:trait:finesse"],not:["finisher"]},selector:"strike-damage",slug:"precise-strike",value:{brackets:[{end:4,value:2},{end:8,start:5,value:3},{end:12,start:9,value:4},{end:16,start:13,value:5},{start:17,value:6}]}},{category:"precision",dieSize:"d6",key:"DamageDice",predicate:{all:["class:swashbuckler","self:effect:panache","finisher",{or:["weapon:melee",{and:["feat:flying-blade","weapon:thrown","target:range-increment:1"]}]}],any:["weapon:trait:agile","weapon:trait:finesse"]},selector:"strike-damage",slug:"finisher",value:{brackets:[{end:4,value:{diceNumber:2}},{end:8,start:5,value:{diceNumber:3}},{end:12,start:9,value:{diceNumber:4}},{end:16,start:13,value:{diceNumber:5}},{start:17,value:{diceNumber:6}}]}}]}get#finishingPrecisionRules(){return[{damageCategory:"precision",key:"FlatModifier",predicate:{all:["self:effect:panache",{or:["weapon:melee",{and:["feat:flying-blade","weapon:thrown","target:range-increment:1"]}]}],any:["weapon:trait:agile","weapon:trait:finesse"],not:["finisher"]},selector:"strike-damage",slug:"finishing-precision",value:1},{category:"precision",diceNumber:1,dieSize:"d6",key:"DamageDice",predicate:{all:["self:effect:panache","finisher",{or:["weapon:melee",{and:["feat:flying-blade","weapon:thrown","target:range-increment:1"]}]}],any:["weapon:trait:agile","weapon:trait:finesse"]},selector:"strike-damage",slug:"finishing-precision"}]}}class Migration790MultipleClassDCs extends MigrationBase{static{__name(this,"Migration790MultipleClassDCs")}static{__name2(this,"Migration790MultipleClassDCs")}static version=.79;#otherClassDCs=new Map([["call-implement","thaumaturge"],["eerie-proclamation","ranger"],["stunning-fist","monk"],["ring-bell","thaumaturge"]]);#isClassFeature(source2){return source2.type==="feat"&&"featType"in source2.system&&e$2(source2.system.featType)&&source2.system.featType.value==="classfeature"}async updateActor(source2){if(source2.type!=="character")return;const customModifiers=source2.system.customModifiers??{};customModifiers?.class&&(customModifiers["-=class"]=null)}async updateItem(source2){if(this.#isClassFeature(source2)){const classSlug=source2.system.traits.value.at(0);if(!classSlug)return;const aeLikes=source2.system.rules.filter(r2=>r2.key==="ActiveEffectLike");for(const aeLike of aeLikes)aeLike.path==="system.attributes.classDC.rank"&&(aeLike.path=`system.proficiencies.classDCs.${classSlug}.rank`)}const itemSlug=source2.system.slug??"";if(this.#otherClassDCs.has(itemSlug)){const oldClassDCPattern=/\bsystem\.attributes\.classDC\b/,classSlug=this.#otherClassDCs.get(itemSlug),{description}=source2.system;description.value=description.value.replace(oldClassDCPattern,`system.proficiencies.classDCs.${classSlug}`);const notes=source2.system.rules.filter(r2=>r2.key==="Note"&&typeof r2.text=="string");for(const note of notes)note.text=note.text.replace(oldClassDCPattern,`system.proficiencies.classDCs.${classSlug}`)}}}class Migration791RuffianHands extends MigrationBase{static{__name(this,"Migration791RuffianHands")}static{__name2(this,"Migration791RuffianHands")}static version=.791;async updateItem(source2){if(!(source2.type!=="feat"||!source2.system.slug))switch(source2.system.slug){case"ruffian":{source2.system.rules.some(r2=>r2.key==="CriticalSpecialization")||source2.system.rules.push(this.#critSpec);break}case"healing-hands":{const hands=this.#hands;hands.predicate={all:["item:slug:heal"]},source2.system.rules=[hands];break}case"harming-hands":{const hands=this.#hands;hands.predicate={all:["item:slug:harm"]},source2.system.rules=[hands];break}}}get#critSpec(){return{key:"CriticalSpecialization",predicate:{all:["target:condition:flat-footed","weapon:category:simple",{lte:["weapon:damage:die:faces",8]}]}}}get#hands(){return{key:"DamageDice",override:{dieSize:"d10"},selector:"spell-damage"}}}class Migration792RemoveTokenAELikes extends MigrationBase{static{__name(this,"Migration792RemoveTokenAELikes")}static{__name2(this,"Migration792RemoveTokenAELikes")}static version=.792;async updateItem(source2){const rules=source2.system.rules;for(const rule of[...rules])rule.key==="ActiveEffectLike"&&typeof rule.path=="string"&&/^token\./.test(rule.path)&&rules.splice(rules.indexOf(rule),1)}}class Migration793MakePredicatesArrays extends MigrationBase{static{__name(this,"Migration793MakePredicatesArrays")}static{__name2(this,"Migration793MakePredicatesArrays")}static version=.793;#convertLegacyData(predicate){const keys=Object.keys(predicate);return keys.length===0?[]:keys.length===1&&Array.isArray(predicate.all)?foundry.utils.deepClone(predicate.all):keys.length===1&&Array.isArray(predicate.any)&&predicate.any.length===1?foundry.utils.deepClone(predicate.any):foundry.utils.deepClone([predicate.all??[],Array.isArray(predicate.any)?{or:predicate.any}:[],Array.isArray(predicate.not)?predicate.not.length===1?{not:predicate.not[0]}:{nor:predicate.not}:[]].flat())}async updateActor(source2){if("customModifiers"in source2.system){e$2(source2.system.customModifiers)||(source2.system.customModifiers={});for(const modifier of Object.values(source2.system.customModifiers).flat())modifier.predicate&&=[]}}async updateItem(source2){const rules=source2.system.rules;for(const rule of rules){if(this.#isOldRawPredicate(rule.predicate)&&(rule.predicate=this.#convertLegacyData(rule.predicate)),this.#isOldRawPredicate(rule.definition)&&(rule.definition=this.#convertLegacyData(rule.definition)),this.#isOldRawPredicate(rule.allowedDrops)&&(rule.allowedDrops={label:rule.allowedDrops.label??void 0,predicate:this.#convertLegacyData(rule.allowedDrops)}),this.#isOldRawPredicate(rule.predicate)&&(rule.predicate=this.#convertLegacyData(rule.predicate)),this.#isArrayChoiceSet(rule))for(const choice of rule.choices)this.#isOldRawPredicate(choice.predicate)&&(choice.predicate=this.#convertLegacyData(choice.predicate));else this.#isObjectChoiceSet(rule)?(this.#isOldRawPredicate(rule.choices.predicate)&&(rule.choices.predicate=this.#convertLegacyData(rule.choices.predicate)),this.#isOldRawPredicate(rule.choices.postFilter)&&(rule.choices.postFilter=this.#convertLegacyData(rule.choices.postFilter))):this.#isOldRawPredicate(rule.craftableItems)&&(rule.craftableItems=this.#convertLegacyData(rule.craftableItems));this.#isOldRawPredicate(rule.disabledIf)&&(rule.disabledIf=this.#convertLegacyData(rule.disabledIf))}}#isOldRawPredicate(predicate){return!predicate||Array.isArray(predicate)||e$2(predicate)&&Array.isArray(predicate.predicate)?!1:predicate instanceof Object}#isArrayChoiceSet(rule){return rule.key==="ChoiceSet"&&Array.isArray(rule.choices)}#isObjectChoiceSet(rule){return rule.key==="ChoiceSet"&&e$2(rule.choices)&&!Array.isArray(rule.choices)}}class Migration794AddWildShapeChoices extends MigrationBase{static{__name(this,"Migration794AddWildShapeChoices")}static{__name2(this,"Migration794AddWildShapeChoices")}static version=.794;#shapeFeats=new Set(["VaIHQzOE5ibmbtqU","OWedlrKGsVZVkSnT","wNHUryoRzlfDCFAd","F0MYBfiyOD8YHq5t","I9rSWQyueWHQyNxe","p0jZhb8PSswUsZaz","Le30algCdKIsxmeK","54JzsYCx3uoj7Wlz"].map(id=>`Compendium.pf2e.feats-srd.${id}`));async updateItem(source2){const sourceId=source2._stats.compendiumSource;if(source2.type==="feat"&&sourceId&&this.#shapeFeats.has(sourceId)){const fromPack=await fromUuid(sourceId);fromPack instanceof FeatPF2e&&(source2.system.rules=fromPack.toObject().system.rules)}}}class Migration795CleanupFlatFootedToggle extends MigrationBase{static{__name(this,"Migration795CleanupFlatFootedToggle")}static{__name2(this,"Migration795CleanupFlatFootedToggle")}static version=.795;get#flatFootedToggle(){return{key:"RollOption",domain:"all",label:"PF2E.SpecificRule.TOTMToggle.FlatFooted",option:"target:condition:flat-footed",toggleable:"totm"}}async updateActor(source2){source2.flags.pf2e?.rollOptions&&(source2.flags.pf2e["-=rollOptions"]=null)}async updateItem(source2){if(source2.type==="feat"||source2.type==="action"&&source2.system.slug==="sneak-attack")switch(source2.system.slug){case"sneak-attack":case"laughing-shadow":case"shadow-sneak-attack":case"butterflys-sting":case"game-hunter-dedication":source2.system.rules.some(r2=>this.#isFlatFootedToggle(r2))||source2.system.rules.push(this.#flatFootedToggle)}}#isFlatFootedToggle(rule){return rule.key==="RollOption"&&rule.option==="target:condition:flat-footed"&&rule.toggleable==="totm"}}class Migration796ItemGrantsToObjects extends MigrationBase{static{__name(this,"Migration796ItemGrantsToObjects")}static{__name2(this,"Migration796ItemGrantsToObjects")}static version=.796;async updateActor(source2){for(const item of source2.items){const systemFlags=item.flags.pf2e;!systemFlags?.itemGrants||!Array.isArray(systemFlags.itemGrants)||(systemFlags.itemGrants=systemFlags.itemGrants.reduce((grantsObject,grant)=>{if(typeof grant=="string"||grant instanceof Object){const[flag,grantSource]=this.#convertToEntry(source2,item,grant);if(flag!==null){const modifiedFlag=this.#modifyFlag(grantsObject,flag);grantsObject[modifiedFlag]=grantSource}}return grantsObject},{}))}}#convertToEntry(actor,granter,grantedData){const grantedId=grantedData instanceof Object?grantedData.id:grantedData;return actor.items.some(i=>i._id===grantedId)?[sluggify(granter.name,{camel:"dromedary"}),{id:grantedId}]:[null,null]}#modifyFlag(grantedItems,flag){const pattern=new RegExp(`^${flag}\\d*$`),nthGrant=Object.keys(grantedItems).filter(g=>pattern.test(g)).length;return nthGrant===0?flag:`${flag}${nthGrant+1}`}}class Migration797MetagameSetting extends MigrationBase{static{__name(this,"Migration797MetagameSetting")}static{__name2(this,"Migration797MetagameSetting")}static version=.797;visibilitySettings=["showDC","showResults"];settings=[...this.visibilitySettings,"tokenSetsNameVisibility","secretDamage","secretCondition","partyVision"];async migrate(){for(const setting of this.settings){const storage=game.settings.storage.get("world"),newKey=`metagame_${setting}`,oldValue=storage.getItem(`pf2e.metagame.${setting}`)??null,existingValueRaw=storage.getItem(`pf2e.${newKey}`)??null;if(oldValue!==null&&existingValueRaw!==null){const newValue=this.visibilitySettings.includes(setting)?!["gm","owner"].includes(oldValue):oldValue;game.settings.set("pf2e",newKey,newValue)}}}}class Migration798WeaponToItemStatements extends MigrationBase{static{__name(this,"Migration798WeaponToItemStatements")}static{__name2(this,"Migration798WeaponToItemStatements")}static version=.798;async updateItem(source2){const rules=source2.system.rules;for(const rule of rules)for(const property of["predicate","definition"]){const predicate=rule[property];Array.isArray(predicate)&&(rule[property]=recursiveReplaceString(predicate,s=>s.replace(/^weapon:/,"item:")))}}}class Migration799RMRecallKnowledgeDuplicates extends MigrationBase{static{__name(this,"Migration799RMRecallKnowledgeDuplicates")}static{__name2(this,"Migration799RMRecallKnowledgeDuplicates")}static version=.799;#oldIdsPattern=new RegExp("pf2e\\.actionspf2e\\.(?:".concat(["KygTSeDvsFoSO6HW","B0Eu3EfwIa9kyDEA","SeUolRoPzorFUAaI","eT1jXYvz2YH70Ovp","B2BpIZFHoF9Kjzpx","LZgjpWd0pL3vK9Q1","KUfLlXDWTcAWhl8l"].join("|")).concat(")"),"g");async updateItem(source2){source2.system.description.value??="",source2.system.description.value=source2.system.description.value.replace(this.#oldIdsPattern,"pf2e.actionspf2e.1OagaWtBpVXExToo")}}class Migration800SelfEffectPanacheRage extends MigrationBase{static{__name(this,"Migration800SelfEffectPanacheRage")}static{__name2(this,"Migration800SelfEffectPanacheRage")}static version=.8;async updateItem(source2,actorSource){if(!(actorSource?._id==="bpTQfx4UixMV3Fja"||actorSource?._stats.compendiumSource==="Compendium.pf2e.extinction-curse-bestiary.Actor.bpTQfx4UixMV3Fja"))for(const rule of source2.system.rules)rule.predicate&&Array.isArray(rule.predicate)&&(rule.predicate=recursiveReplaceString(rule.predicate,s=>s.replace(/^(rage|panache)$/,"self:effect:$1")))}}class Migration801ColorDarkvision extends MigrationBase{static{__name(this,"Migration801ColorDarkvision")}static{__name2(this,"Migration801ColorDarkvision")}static version=.801;get#colorDarkvision(){return{key:"ActiveEffectLike",path:"flags.pf2e.colorDarkvision",mode:"override",value:!0}}async updateItem(source2){if(!source2.system.slug)return;const isFetchling=source2.type==="ancestry"&&source2.system.slug==="fetchling",isResonantLight=source2.type==="feat"&&source2.system.slug==="resonant-reflection-reflection-of-light",getsColorDarkvision=isFetchling||isResonantLight,rules=source2.system.rules;getsColorDarkvision&&!rules.some(r2=>r2.path==="flags.pf2e.colorDarkvision")&&source2.system.rules.push(this.#colorDarkvision)}}class Migration802StripFeatActionCategory extends MigrationBase{static{__name(this,"Migration802StripFeatActionCategory")}static{__name2(this,"Migration802StripFeatActionCategory")}static version=.802;async updateItem(source2){if(source2.type!=="feat")return;const feat=source2.system;feat.actionCategory&&(delete feat.actionCategory,feat["-=actionCategory"]=null)}}class Migration803NormalizeSpellArea extends MigrationBase{static{__name(this,"Migration803NormalizeSpellArea")}static{__name2(this,"Migration803NormalizeSpellArea")}static version=.803;#AREA_TYPES=new Set(["burst","cone","cube","emanation","line","square"]);async updateItem(source2){if(source2.type!=="spell")return;const area=source2.system.area;area&&(area.value=Number(area.value)||5,"areaType"in area&&this.#isAreaType(area.areaType)&&(area.type=area.areaType,area["-=areaType"]=null)),area?.value&&this.#isAreaType(area.type)||(source2.system.area=null),"areasize"in source2.system&&e$2(source2.system.areasize)&&(this.#hasDetails(source2.system.areasize.value)&&area&&(area.details=source2.system.areasize.value),delete source2.system.areasize,source2.system["-=areasize"]=null)}#isAreaType(areaType){return typeof areaType=="string"&&areaType.length>0&&this.#AREA_TYPES.has(areaType)}#hasDetails(details){return typeof details=="string"&&details.trim().length>0&&!/^\d+-foot (?:burst|cone|cube|emanation|line|square)$/.test(details)}}class Migration804RemoveConsumableProperties extends MigrationBase{static{__name(this,"Migration804RemoveConsumableProperties")}static{__name2(this,"Migration804RemoveConsumableProperties")}static version=.804;async updateItem(source2){if(source2.type!=="consumable")return;const system2=source2.system;system2.uses&&delete system2.uses,system2.autoUse&&(delete system2.autoUse,system2["-=autoUse"]=null),e$2(system2.charges)&&"_deprecated"in system2.charges&&(delete system2.charges._deprecated,system2.charges["-=deprecated"]=null),e$2(system2.consume)&&"_deprecated"in system2.consume&&(delete system2.consume._deprecated,system2.consume["-=deprecated"]=null)}}class Migration805InlineDamageRolls extends MigrationBase{static{__name(this,"Migration805InlineDamageRolls")}static{__name2(this,"Migration805InlineDamageRolls")}static version=.805;#pattern=/\[\[\/r .+?\]\]\]?(?:\{[^}]+\})?/g;#damageTypeLabelPattern=(()=>{const dicePattern="[0-9]{1,2}d[0-9]{1,2}(?:\\s*[-+]\\s*[0-9]{1,3})?",typesUnion=["acid","bleed","bludgeoning","chaotic","cold","electricity","evil","fire","force","good","lawful","mental","negative","piercing","poison","positive","slashing","sonic","untyped"].join("|");return new RegExp(`^${dicePattern} (?:${typesUnion})(?: damage)?$`,"i")})();#updateDamageFormula(text2){const skipStrings=["splash","precision","persistent","d20","#"];return text2.replace(this.#pattern,match=>{const labelEndsWithDamage=match.toLowerCase().endsWith("damage}");if(skipStrings.some(s=>match.includes(s)))return match;const customLabel=/\{([^}]+)\}$/.exec(match)?.at(1),expressions=match.replace(/\{[^}]+\}$/,"").match(/\{[^}]+\}\[\w+\]/g)??[];if(expressions.length===0)return match;const instances=expressions.map(i=>i.trim().replace(/^\{([^}]+)\}\[([a-z]+)\]$/i,["+","-","*","/"].some(o=>i.includes(o))?"($1)[$2]":"$1[$2]").toLowerCase()),reassembled=instances.length===1?`[[/r ${instances[0]}]]`:`[[/r {${instances.join(",")}}]]`;return customLabel&&!this.#damageTypeLabelPattern.test(customLabel)?`${reassembled}{${customLabel}}`:labelEndsWithDamage?`${reassembled} damage`:reassembled})}async updateActor(source2){source2.system=recursiveReplaceString(source2.system,s=>this.#updateDamageFormula(s))}async updateItem(source2){source2.system=recursiveReplaceString(source2.system,s=>this.#updateDamageFormula(s))}async updateJournalEntry(source2){source2.pages=recursiveReplaceString(source2.pages,s=>this.#updateDamageFormula(s))}}class Migration806TorchImprovisedOtherTags extends MigrationBase{static{__name(this,"Migration806TorchImprovisedOtherTags")}static{__name2(this,"Migration806TorchImprovisedOtherTags")}static version=.806;async updateItem(source2){if(source2.type==="equipment"&&source2.system.slug==="torch"){const torchStrikeRE=source2.system.rules.find(r2=>r2.key==="Strike"&&r2.otherTags===void 0);torchStrikeRE&&(delete torchStrikeRE.traits,torchStrikeRE.otherTags=["improvised"])}}}class Migration807RMActivatedEffectFields extends MigrationBase{static{__name(this,"Migration807RMActivatedEffectFields")}static{__name2(this,"Migration807RMActivatedEffectFields")}static version=.807;async updateItem(source2){if(source2.type==="consumable")for(const property of["activation","duration","range","target","uses"])property in source2.system&&(delete source2.system[property],source2.system[`-=${property}`]=null)}}class Migration808CountDamageDice extends MigrationBase{static{__name(this,"Migration808CountDamageDice")}static{__name2(this,"Migration808CountDamageDice")}static version=.808;async updateItem(source2){source2.system=recursiveReplaceString(source2.system,s=>s.replace(/\(?\b1\s*\+\s*@(item|weapon)(?:.system)?.runes.striking\)?/g,"@$1.system.damage.dice"))}}class Migration809AutomatonEnhancements extends MigrationBase{static{__name(this,"Migration809AutomatonEnhancements")}static{__name2(this,"Migration809AutomatonEnhancements")}static version=.809;get#automatonEnhancements(){return{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.automaton.enhancements",priority:10,value:{greater:[],lesser:[]}}}async updateItem(source2){const isAutomaton=source2.type==="ancestry"&&source2.system.slug==="automaton",rules=source2.system.rules;isAutomaton&&!rules.some(r2=>r2.path==="flags.pf2e.automaton.enhancements")&&source2.system.rules.push(this.#automatonEnhancements)}}class Migration810LootDescriptionValue extends MigrationBase{static{__name(this,"Migration810LootDescriptionValue")}static{__name2(this,"Migration810LootDescriptionValue")}static version=.81;async updateActor(source2){if(source2.type==="loot"){const details=source2.system.details;details.description instanceof Object&&(details.description=String(details.description.value??""))}}}class Migration811InlineDamageRollsPersistent extends MigrationBase{static{__name(this,"Migration811InlineDamageRollsPersistent")}static{__name2(this,"Migration811InlineDamageRollsPersistent")}static version=.811;#conditionPattern=/(?<=\]\]|})(\s*@(?:UUID|Compendium)\[(?:Compendium\.)?pf2e\.conditionitems\.(?:Persistent Damage|lDVqvLKA6eF3Df60)\]\{[^}]+})/g;#pattern=/\[\[\/r ([^[\]]+(\[.*?\])?)\]\](\{\dd\d[^{}]*\})?/g;#updateDamageFormula(text2){return text2.replace(this.#conditionPattern," damage").replace(this.#pattern,(match,formula)=>{if(!match.includes("persistent"))return match;const hashStyle=formula.match(/([^#]+)#\s*persistent ([^#]+)/);if(hashStyle){const expression=hashStyle[1].trim(),damageType=hashStyle[2].trim(),expressionCleaned=["+","-","*","/"].some(o=>expression.includes(o))?`(${expression})`:expression;return match.replace(formula,`${expressionCleaned}[persistent,${damageType}]`)}const expressions=formula.match(/\{[^}]+\}\[[\w,]+\]/g)??[];if(expressions.length){const withoutLabel=match.replace(/\{\dd\d[^{}]*\}$/,""),instances=expressions.map(i=>i.replace(/^\{([^}]+)\}\[([a-z,]+)\]$/,["+","-","*","/"].some(o=>i.includes(o))?"($1)[$2]":"$1[$2]")),reassembled=instances.length===1?instances[0]:`{${instances.join(",")}}`;return withoutLabel.replace(formula,reassembled)}return match})}async updateActor(source2){source2.system=recursiveReplaceString(source2.system,s=>this.#updateDamageFormula(s))}async updateItem(source2){source2.system=recursiveReplaceString(source2.system,s=>this.#updateDamageFormula(s))}async updateJournalEntry(source2){source2.pages=recursiveReplaceString(source2.pages,s=>this.#updateDamageFormula(s))}}class Migration812RestructureIWR extends MigrationBase{static{__name(this,"Migration812RestructureIWR")}static{__name2(this,"Migration812RestructureIWR")}static version=.812;async updateActor(source2){const traits=source2.system.traits;if(!traits||source2.type==="familiar")return;const attributes=source2.system.attributes;if("ci"in traits&&("game"in globalThis||delete traits.ci,traits["-=ci"]=null),"di"in traits){const oldData=traits.di;if("game"in globalThis||delete traits.di,traits["-=di"]=null,attributes&&e$2(oldData)&&"value"in oldData&&Array.isArray(oldData.value)&&oldData.value.length>0){const immunities=oldData.value.map(i=>this.#normalizeType(String(i))).filter(i=>setHasElement(IMMUNITY_TYPES,i)).map(i=>({type:i}));immunities.length>0&&(attributes.immunities=immunities)}}if("dv"in traits){const oldData=traits.dv;if("game"in globalThis||delete traits.dv,traits["-=dv"]=null,Array.isArray(oldData)&&oldData.length>0){const weaknesses=this.#getWR(oldData,WEAKNESS_TYPES).map(data=>{const weakness=t$3(data,["type","value"]),exceptions=this.#parseExceptions(String(data.exceptions??"")).exceptions.filter(e2=>setHasElement(WEAKNESS_TYPES,e2));return exceptions.length>0&&(weakness.exceptions=exceptions),weakness});attributes&&weaknesses.length>0&&(attributes.weaknesses=weaknesses)}}if("dr"in traits){const oldData=traits.dr;if("game"in globalThis||delete traits.dr,traits["-=dr"]=null,Array.isArray(oldData)&&oldData.length>0){const resistances=this.#getWR(oldData,RESISTANCE_TYPES).map(data=>{const resistance=t$3(data,["type","value"]),parsed=this.#parseExceptions(String(data.exceptions??"")),exceptions=parsed.exceptions.filter(e2=>setHasElement(RESISTANCE_TYPES,e2));exceptions.length>0&&(resistance.exceptions=exceptions);const doubleVs=parsed.doubleVs.filter(e2=>setHasElement(RESISTANCE_TYPES,e2));return doubleVs.length>0&&(resistance.doubleVs=doubleVs),resistance});attributes&&resistances.length>0&&(attributes.resistances=resistances)}}}async updateItem(source2){if(source2.type==="weapon"){const material=source2.system.preciousMaterial??{};material.value=typeof material.value=="string"?sluggify(material.value):null,source2.system.preciousMaterialGrade&&(source2.system.preciousMaterialGrade.value||=null)}const iwrREs=source2.system.rules.filter(r2=>typeof r2.key=="string"&&["Immunity","Weakness","Resistance"].includes(r2.key)&&"type"in r2&&typeof r2.type=="string");for(const rule of iwrREs)if(rule.type=rule.type.startsWith("{")?rule.type:this.#normalizeType(rule.type),typeof rule.except=="string"){const exceptions=this.#parseExceptions(rule.except).exceptions.filter(exception=>rule.key==="Immunity"?setHasElement(IMMUNITY_TYPES,exception):rule.key==="Weakness"?setHasElement(WEAKNESS_TYPES,exception):setHasElement(RESISTANCE_TYPES,exception));exceptions.length>0&&(rule.exceptions=exceptions),delete rule.except}const adjustStrikeREs=source2.system.rules.filter(r2=>r2.key==="AdjustStrike"&&"value"in r2&&typeof r2.value=="string");for(const rule of adjustStrikeREs)rule.value=rule.value.startsWith("{")||["property-runes","weapon-traits"].includes(rule.property)?rule.value:this.#normalizeType(rule.value)}#getWR(maybeWR,typeSet){return maybeWR.filter(r2=>e$2(r2)&&typeof r2.type=="string"&&typeof r2.value=="number").map(wr=>(wr.type=this.#normalizeType(wr.type),wr.value=Math.abs(wr.value),wr)).filter(r2=>setHasElement(typeSet,r2.type))}#oldENmappings={"PF2E.ResistanceException.Bludgeoning":"except bludgeoning","PF2E.ResistanceException.ForceGhostTouchDoubleNonMagical":"except force, or ghost touch; double resistance vs. non-magical","PF2E.ResistanceException.ForceGhostTouchNegativeDoubleNonMagical":"except force, ghost touch, or negative; double resistance vs. non-magical","PF2E.ResistanceException.ForceGhostTouchPositiveDoubleNonMagical":"except force, ghost touch, or positive; double resistance vs. non-magical"};#parseExceptions(text2){const normalized=(this.#oldENmappings[text2]??text2).toLowerCase().replace("PF2E.TraitForce","force").replace("PF2E.TraitPositive","positive").replace("cold iron","cold-iron").replace("critical hits","critical-hits").replace("ghost touch","ghost-touch").replace("nonmagical","non-magical").replace("weapons shedding bright light","weapons-shedding-bright-light").replace("unarmed","unarmed-attacks").replace(/\bexcept\b/,"").trim().replace(/\s+/," ");if(!normalized)return{exceptions:[],doubleVs:[]};const doubleIndex=normalized.indexOf("double"),exceptions=(doubleIndex===-1?normalized:normalized.slice(0,doubleIndex)).split(/[,\s]+/).map(d=>sluggify(d)),doubleVs=normalized.slice(doubleIndex).split(/[,\s]+/).map(d=>sluggify(d));return{exceptions,doubleVs}}#normalizeType(text2){switch(text2=text2.trim(),text2){case"all":case"All":return"all-damage";case"arrow":return"arrow-vulnerability";case"axe":return"axe-vulnerability";case"coldiron":return"cold-iron";case"nonlethal":return"nonlethal-attacks";case"nonmagical-attacks":return"non-magical";case"protean anatomy":return"protean-anatomy";case"unarmed":return"unarmed-attacks";default:return sluggify(text2)}}}class Migration813NormalizeColdIron extends MigrationBase{static{__name(this,"Migration813NormalizeColdIron")}static{__name2(this,"Migration813NormalizeColdIron")}static version=.813;async updateItem(source2){switch(source2.type){case"melee":{const traits=source2.system.traits;traits.value=traits.value.map(t2=>t2.replace(/^coldiron$/i,"cold-iron"));return}case"armor":case"weapon":{const preciousMaterial=source2.system.preciousMaterial;if(typeof preciousMaterial?.value!="string")return;preciousMaterial.value&&=preciousMaterial.value.replace(/^coldiron$/i,"cold-iron"),source2.type==="weapon"&&this.#updateWeaponMaterialData(source2);return}}const choiceSets=source2.system.rules.filter(r2=>r2.key==="ChoiceSet"&&"choices"in r2&&Array.isArray(r2.choices)&&r2.choices.every(c=>e$2(c)&&typeof c.value=="string"));for(const choiceSet of choiceSets)this.#updateChoiceSet(choiceSet)}#updateWeaponMaterialData(source2){if(source2.type!=="weapon"||!e$2(source2.system.specific))return;const specificData=source2.system.specific;specificData.value||(delete specificData.material,delete specificData.price,delete specificData.runes,specificData["-=material"]=null,specificData["-=price"]=null,specificData["-=runes"]=null);const material=specificData.material;material?.precious?(material.precious.type&&=material.precious.type.replace(/^coldiron$/i,"cold-iron"),delete material.base,material["-=base"]=null):typeof material?.type=="string"&&typeof material.grade=="string"&&(material.precious={type:material.type.replace(/^coldiron$/i,"cold-iron"),grade:material.grade},delete material.type,delete material.grade,material["-=type"]=null,material["-=grade"]=null)}#updateChoiceSet(choiceSet){for(const choice of choiceSet.choices)/coldiron/i.test(String(choice.value))&&(choice.value="cold-iron");/coldiron/i.test(String(choiceSet.selection))&&(choiceSet.selection="cold-iron")}}class Migration814CalculatedExpandedSplash extends MigrationBase{static{__name(this,"Migration814CalculatedExpandedSplash")}static{__name2(this,"Migration814CalculatedExpandedSplash")}static version=.814;async updateItem(source2){if(source2.type==="feat")switch(source2.system.slug){case"calculated-splash":{const rules=[{key:"AdjustModifier",mode:"upgrade",predicate:[{not:"feat:expanded-splash"}],relabel:"{item|name}",selector:"alchemical-bomb-damage",slug:"splash",value:"@actor.abilities.int.mod"}];source2.system.rules=rules;return}case"expanded-splash":{const rules=[{damageCategory:"splash",key:"FlatModifier",predicate:["item:trait:splash"],selector:"alchemical-bomb-damage",value:"@actor.abilities.int.mod"},{key:"Note",predicate:["item:trait:splash"],selector:"alchemical-bomb-damage",text:"The bomb deals splash damage to every creature within 10 feet of the target.",title:"{item|name}"}];source2.system.rules=rules}}}}class Migration815ConsumableDataCleanup extends MigrationBase{static{__name(this,"Migration815ConsumableDataCleanup")}static{__name2(this,"Migration815ConsumableDataCleanup")}static version=.815;consumableKeys=new Set(["autoDestroy","baseItem","bulk","charges","consumableType","consume","containerId","description","equipped","equippedBulk","hardness","hp","identification","level","negateBulk","preciousMaterial","preciousMaterialGrade","price","quantity","rules","schema","size","slug","source","spell","stackGroup","temporary","traits","usage","weight"]);async updateItem(source2){if(source2.type!=="consumable")return;const systemData=source2.system;for(const key of Object.keys(systemData)){const value=systemData[key];this.consumableKeys.has(key)?e$2(value)&&"_deprecated"in value&&(delete value._deprecated,value["-=_deprecated"]=null):(delete systemData[key],systemData[`-=${key}`]=null)}}}class Migration816AlchemistResearchFields extends MigrationBase{static{__name(this,"Migration816AlchemistResearchFields")}static{__name2(this,"Migration816AlchemistResearchFields")}static version=.816;get#bomberSetFlags(){return{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.alchemist",value:{fieldDiscovery:"Compendium.pf2e.classfeatures.8QAFgy9U8PxEa7Dw",greaterFieldDiscovery:"Compendium.pf2e.classfeatures.RGs4uR3CAvgbtBAA",perpetualInfusions:"Compendium.pf2e.classfeatures.DFQDtT1Van4fFEHi",perpetualPerfection:"Compendium.pf2e.classfeatures.xO90iBD8XNGyaCkz",perpetualPotency:"Compendium.pf2e.classfeatures.8rEVg03QJ71ic3PP"}}}get#chirurgeonSetFlags(){return{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.alchemist",value:{fieldDiscovery:"Compendium.pf2e.classfeatures.qC0Iz6SlG2i9gv6g",greaterFieldDiscovery:"Compendium.pf2e.classfeatures.JJcaVijwRt9dsnac",perpetualInfusions:"Compendium.pf2e.classfeatures.fzvIe6FwwCuIdnjX",perpetualPerfection:"Compendium.pf2e.classfeatures.YByJ9O7oe8wxfbqs",perpetualPotency:"Compendium.pf2e.classfeatures.VS5vkqUQu4n7E28Y"}}}get#mutagenistSetFlags(){return{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.alchemist",value:{fieldDiscovery:"Compendium.pf2e.classfeatures.V4Jt7eDnJBLv5bDj",greaterFieldDiscovery:"Compendium.pf2e.classfeatures.1BKdOJ0HNL6Eg3xw",perpetualInfusions:"Compendium.pf2e.classfeatures.Dug1oaVYejLmYEFt",perpetualPerfection:"Compendium.pf2e.classfeatures.CGetAmSbv06fW7GT",perpetualPotency:"Compendium.pf2e.classfeatures.mZFqRLYOQEqKA8ri"}}}get#toxicologistSetFlags(){return{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.alchemist",value:{fieldDiscovery:"Compendium.pf2e.classfeatures.6zo2PJGYoig7nFpR",greaterFieldDiscovery:"Compendium.pf2e.classfeatures.tnqyQrhrZeDtDvcO",perpetualInfusions:"Compendium.pf2e.classfeatures.LlZ5R50z9j8jysZL",perpetualPerfection:"Compendium.pf2e.classfeatures.3R19zS7gERhEX87F",perpetualPotency:"Compendium.pf2e.classfeatures.JOdbVu14phvdjhaY"}}}async updateItem(source2){if(!(source2.type!=="feat"||!source2.system.slug)&&!source2.system.rules.some(r2=>r2.key==="ActiveEffectLike"&&r2.path==="flags.pf2e.alchemist"))switch(source2.system.slug){case"bomber":{source2.system.rules.push(this.#bomberSetFlags);break}case"chirurgeon":{source2.system.rules.push(this.#chirurgeonSetFlags);break}case"mutagenist":{source2.system.rules.push(this.#mutagenistSetFlags);break}case"toxicologist":{source2.system.rules.push(this.#toxicologistSetFlags);break}}}}class Migration817FieldDiscoveryPredicates extends MigrationBase{static{__name(this,"Migration817FieldDiscoveryPredicates")}static{__name2(this,"Migration817FieldDiscoveryPredicates")}static version=.817;async updateItem(source2){const aeLikes=source2.system.rules.filter(r2=>r2.key==="ActiveEffectLike"&&"path"in r2&&typeof r2.path=="string"&&/^system.crafting.entries.\w+.fieldDiscovery$/.test(r2.path)&&"value"in r2&&typeof r2.value=="string");for(const rule of aeLikes)switch(rule.value){case"bomb":rule.value=["item:base:alchemical-bomb"];break;case"elixir":rule.value=["item:trait:elixir","item:trait:healing"];break;case"mutagen":rule.value=["item:trait:mutagen"];break;case"poison":rule.value=["item:trait:alchemical","item:trait:poison"];break;default:rule.value=[`item:trait:${rule.value}`]}}}class Migration818BasicUndeadNegativeHealing extends MigrationBase{static{__name(this,"Migration818BasicUndeadNegativeHealing")}static{__name2(this,"Migration818BasicUndeadNegativeHealing")}static version=.818;#needsRE(source2){return source2.system.slug==="basic-undead-benefits"&&!source2.system.rules.some(r2=>r2.key==="ActiveEffectLike"&&"path"in r2&&r2.path==="system.attributes.hp.negativeHealing")}async updateItem(source2){if(source2.type==="feat"&&this.#needsRE(source2)){const rule={key:"ActiveEffectLike",mode:"override",path:"system.attributes.hp.negativeHealing",value:!0};source2.system.rules.push(rule)}}}class Migration819SpinTaleAdventureSpecific extends MigrationBase{static{__name(this,"Migration819SpinTaleAdventureSpecific")}static{__name2(this,"Migration819SpinTaleAdventureSpecific")}static version=.819;async updateItem(source2){if(source2.type==="feat"){const oldSpinTale="Compendium.pf2e.adventure-specific-actions.Spin Tale",newSpinTale="Compendium.pf2e.actionspf2e.Spin Tale",oldSpinTaleId="Compendium.pf2e.adventure-specific-actions.5gahZQXf3UVwATSC",newSpinTaleId="Compendium.pf2e.actionspf2e.hPZQ5vA9QHEPtjFW";source2.system.description.value=source2.system.description.value.replace(oldSpinTale,newSpinTale),source2.system.description.value=source2.system.description.value.replace(oldSpinTaleId,newSpinTaleId)}}}class Migration820RemoveUnusedTraitsData extends MigrationBase{static{__name(this,"Migration820RemoveUnusedTraitsData")}static{__name2(this,"Migration820RemoveUnusedTraitsData")}static version=.82;async updateItem(source2){const systemSource=source2.system;systemSource.traits&&("custom"in systemSource.traits&&(systemSource.traits["-=custom"]=null),(source2.type==="spellcastingEntry"||source2.type==="condition")&&(systemSource["-=traits"]=null))}}class Migration821InlineDamageRolls extends MigrationBase{static{__name(this,"Migration821InlineDamageRolls")}static{__name2(this,"Migration821InlineDamageRolls")}static version=.821;#splashPattern1=/\[\[(\/b?r)\s*{([^}]*)}\[splash,\s*([^\]]*)\]\s*(#[^\]]*)?\]\]/g;#splashPattern2=/\[\[(\/b?r)\s*([^[]*)\[splash,\s*([^\]]*)\]\s*(#[^\]]*)?\]\]/g;#damagePatternSingle=/\[\[(\/b?r)\s*{([^}]*)}\[\s*([^\]]*)\]\s*(#[^\]]*)?\]\]/g;#damagePatternPair=/\[\[(\/b?r)\s*{([^}]*)}\[\s*([^\]]*)\]\s*[+,]\s*{([^}]*)}\[\s*([^\]]*)\]\s*(#[^\]]*)?\]\]/g;#cleanFormula(formula){return formula=formula.replace(/\s+/g,""),["+","-","*","/"].some(o=>formula.includes(o))?`(${formula})`:formula}#buildSplashFormula(roll,formula,damage,tag){return formula=this.#cleanFormula(formula),damage=damage.trim(),tag=tag?.trim()??"",tag.length>0?`[[${roll} (${formula}[splash])[${damage}] ${tag}]]`:`[[${roll} (${formula}[splash])[${damage}]]]`}#buildDamageFormula(roll,parts,tag){if(tag=tag?.trim()??"",parts.length===1){const formula=this.#cleanFormula(parts[0].formula),damage=parts[0].damage.trim();return tag.length>0?`[[${roll} ${formula}[${damage}] ${tag}]]`:`[[${roll} ${formula}[${damage}]]]`}else if(parts.length>1){const assembled=parts.map(p=>{const formula=this.#cleanFormula(p.formula),damage=p.damage.trim();return`${formula}[${damage}]`}).join(",");return tag.length>0?`[[${roll} {${assembled}} ${tag}]]`:`[[${roll} {${assembled}}]]`}else return""}#updateDamageFormula(text2){return text2=text2.replace(this.#splashPattern1,(_,roll,formula,damage,tag)=>this.#buildSplashFormula(roll,formula,damage,tag)),text2=text2.replace(this.#splashPattern2,(_,roll,formula,damage,tag)=>this.#buildSplashFormula(roll,formula,damage,tag)),text2=text2.replace(this.#damagePatternSingle,(_,roll,formula,damage,tag)=>this.#buildDamageFormula(roll,[{formula,damage}],tag)),text2=text2.replace(this.#damagePatternPair,(_,roll,formula1,damage1,formula2,damage2,tag)=>this.#buildDamageFormula(roll,[{formula:formula1,damage:damage1},{formula:formula2,damage:damage2}],tag)),text2}async updateActor(source2){source2.system=recursiveReplaceString(source2.system,s=>this.#updateDamageFormula(s))}async updateItem(source2){source2.system=recursiveReplaceString(source2.system,s=>this.#updateDamageFormula(s))}async updateJournalEntry(source2){source2.pages=recursiveReplaceString(source2.pages,s=>this.#updateDamageFormula(s))}}class Migration822BladeAllyConsolidation extends MigrationBase{static{__name(this,"Migration822BladeAllyConsolidation")}static{__name2(this,"Migration822BladeAllyConsolidation")}static version=.822;#rename(text2){return text2.replace(/\bfeat-effects\.Effect: Blade Ally Anarchic Rune\b/g,"equipment-srd.Anarchic").replace(/\bfeat-effects\.xLXFK4mtzgAF4zvx\b/g,"equipment-srd.65YL6nk1jIzCWutt").replace(/\bfeat-effects\.Effect: Blade Ally Axiomatic Rune\b/g,"equipment-srd.Axiomatic").replace(/\bfeat-effects\.ZzE6jPbCyUqEqhcb\b/g,"equipment-srd.6xu6dPIaUZ7edKEB").replace(/\bfeat-effects\.Effect: Blade Ally Disrupting Rune\b/g,"equipment-srd.Disrupting").replace(/\bfeat-effects\.eippbzuocVM6ftcj\b/g,"equipment-srd.LwQb7ryTC8FlOXgX").replace(/\bfeat-effects\.Effect: Blade Ally Fearsome Rune\b/g,"equipment-srd.Fearsome").replace(/\bfeat-effects\.6LgJB4ypaSTWSJLu\b/g,"equipment-srd.P6v2AtJw7AUwaDzf").replace(/\bfeat-effects\.Effect: Blade Ally Flaming Rune\b/g,"equipment-srd.Flaming").replace(/\bfeat-effects\.YxYr18vleIt2t3RS\b/g,"equipment-srd.XszNvxnymWYRaoTp").replace(/\bfeat-effects\.Effect: Blade Ally Holy Rune\b/g,"equipment-srd.Holy").replace(/\bfeat-effects\.l98IthkklgLDJXIo\b/g,"equipment-srd.DH0kB9Wbr5pDeunX").replace(/\bfeat-effects\.Effect: Blade Ally Keen Rune\b/g,"equipment-srd.Keen").replace(/\bfeat-effects\.Gf7h44DcTB43464h\b/g,"equipment-srd.hg3IogR8ue2IWwgS").replace(/\bfeat-effects\.Effect: Blade Ally Unholy Rune\b/g,"equipment-srd.Unholy").replace(/\bfeat-effects\.rGSc2PtvU3mgm18S\b/g,"equipment-srd.gmMrJREf4JSHd2dZ").replace(/\bfeat-effects\.Effect: Blade Ally Ghost Touch Rune\b/g,"equipment-srd.Ghost Touch").replace(/\bfeat-effects\.Rgio0hasm2epEMfh\b/g,"equipment-srd.JQdwHECogcTzdd8R").replace(/\bfeat-effects\.Effect: Blade Ally Disrupting Rune (Greater)\b/g,"equipment-srd.Disrupting (Greater)").replace(/\bfeat-effects\.HjfIXg5btodThCTW\b/g,"equipment-srd.oVrVzML63VFvVfKk")}async updateItem(source2){source2.system.description.value.includes("feat-effects")&&(source2.system.description.value=this.#rename(source2.system.description.value))}}class Migration823HeritageAncestrySlug extends MigrationBase{static{__name(this,"Migration823HeritageAncestrySlug")}static{__name2(this,"Migration823HeritageAncestrySlug")}static version=.823;async updateItem(source2){if(source2.type!=="heritage"||!source2.system.ancestry||source2.system.ancestry.slug)return;const ancestry=await fromUuid(source2.system.ancestry.uuid);source2.system.ancestry.slug=ancestry instanceof AncestryPF2e?ancestry.slug??sluggify(ancestry.name):sluggify(source2.system.ancestry.name)}}class Migration824SneakAttackDamageSource extends MigrationBase{static{__name(this,"Migration824SneakAttackDamageSource")}static{__name2(this,"Migration824SneakAttackDamageSource")}static version=.824;async updateItem(source2){if(source2.type==="feat")switch(source2.system.slug){case"sneak-attack":{const rules=[{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.sneakAttackDamage.number",predicate:["class:rogue"],value:"ternary(lt(@actor.level, 5), 1, ternary(lt(@actor.level, 11), 2, ternary(lt(@actor.level, 17), 3, 4)))"},{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.sneakAttackDamage.faces",predicate:["class:rogue"],value:6},{category:"precision",diceNumber:"@actor.flags.pf2e.sneakAttackDamage.number",dieSize:"d{actor|flags.pf2e.sneakAttackDamage.faces}",key:"DamageDice",predicate:["target:condition:flat-footed",{or:["item:trait:agile","item:trait:finesse",{and:["item:ranged",{not:"item:thrown-melee"}]}]}],selector:"strike-damage"},{domain:"all",key:"RollOption",label:"PF2E.SpecificRule.TOTMToggle.FlatFooted",option:"target:condition:flat-footed",toggleable:"totm"}];source2.system.rules=rules;return}case"ruffian":{const rules=[{category:"precision",diceNumber:"@actor.flags.pf2e.sneakAttackDamage.number",dieSize:"d{actor|flags.pf2e.sneakAttackDamage.faces}",key:"DamageDice",label:"PF2E.SpecificRule.SneakAttack",predicate:["target:condition:flat-footed","item:category:simple",{nor:[{and:["item:ranged",{not:"item:thrown-melee"}]},"item:trait:agile","item:trait:finesse"]}],selector:"strike-damage"},{key:"ActiveEffectLike",mode:"upgrade",path:"system.martial.medium.rank",value:1},{key:"ActiveEffectLike",mode:"upgrade",path:"system.skills.itm.rank",value:1},{key:"CriticalSpecialization",predicate:["target:condition:flat-footed","item:category:simple",{lte:["item:damage:die:faces",8]}]}];source2.system.rules=rules;return}case"sneak-attacker":{const rules=[{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.sneakAttackDamage.number",value:1},{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.sneakAttackDamage.faces",value:"ternary(lt(@actor.level, 6), 4, 6)"},{key:"GrantItem",uuid:"Compendium.pf2e.classfeatures.Sneak Attack"}];source2.system.rules=rules;return}case"butterflys-sting":{const rules=[{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.sneakAttackDamage.number",value:1},{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.sneakAttackDamage.faces",value:6},{key:"GrantItem",uuid:"Compendium.pf2e.classfeatures.Sneak Attack"},{domain:"all",key:"RollOption",label:"PF2E.SpecificRule.TOTMToggle.FlatFooted",option:"target:condition:flat-footed",toggleable:"totm"}];source2.system.rules=rules;return}case"magical-trickster":{const rules=[{category:"precision",diceNumber:"@actor.flags.pf2e.sneakAttackDamage.number",dieSize:"d{actor|flags.pf2e.sneakAttackDamage.faces}",key:"DamageDice",predicate:["item:trait:attack","target:condition:flat-footed"],selector:"spell-damage"}];source2.system.rules=rules;return}}}}class Migration825KhakkharaFengHuoLun extends MigrationBase{static{__name(this,"Migration825KhakkharaFengHuoLun")}static{__name2(this,"Migration825KhakkharaFengHuoLun")}static version=.825;async updateItem(source2){if(source2.img.endsWith("icons/equipment/weapons/khakkara.webp")&&(source2.img=source2.img.replace("khakkara.webp","khakkhara.webp")),source2.type==="weapon"){const fixBaseItemAndSlug=__name2((oldId,newId)=>{source2.system.baseItem===oldId&&(source2.system.baseItem=newId),source2.system.slug===oldId&&(source2.system.slug=newId)},"fixBaseItemAndSlug");fixBaseItemAndSlug("khakkara","khakkhara"),fixBaseItemAndSlug("wind-and-fire-wheel","feng-huo-lun")}else if(source2.type==="feat"){const oldLink="@UUID[Compendium.pf2e.equipment-srd.Khakkara]",newLink="@UUID[Compendium.pf2e.equipment-srd.Khakkhara]";source2.system.description.value=source2.system.description.value.replace(oldLink,newLink);for(const rule of source2.system.rules)rule.key==="ActiveEffectLike"&&"path"in rule&&rule.path==="system.martial.weapon-base-khakkara.rank"&&(rule.path="system.martial.weapon-base-khakkhara.rank")}}}class Migration826GutConditionData extends MigrationBase{static{__name(this,"Migration826GutConditionData")}static{__name2(this,"Migration826GutConditionData")}static version=.826;async updateItem(source2){if(source2.type!=="condition")return;const system2=source2.system,topLevel=["active","base","removable","hud","modifiers","sources","alsoApplies"];for(const key of topLevel)key in system2&&(delete system2[key],system2[`-=${key}`]=null);const valueData=system2.value;for(const key of["immutable","modifiers"])key in valueData&&(delete valueData[key],valueData[`-=${key}`]=null);const durationData=system2.duration;if(e$2(durationData))for(const key of["perpetual","text"])key in durationData&&(delete durationData[key],durationData[`-=${key}`]=null);system2.group||=null}}class Migration827FixTVShieldTraits extends MigrationBase{static{__name(this,"Migration827FixTVShieldTraits")}static{__name2(this,"Migration827FixTVShieldTraits")}static version=.827;async updateItem(source2){if(source2.type!=="armor")return;const traits=source2.system.traits;switch(source2.system.slug){case"dart-shield":{traits.value=["launching-dart"];return}case"klar":{traits.value=["integrated-1d6-s-versatile-p"];return}case"meteor-shield":{traits.value=["shield-throw-30"];return}case"razor-disc":{traits.value=["integrated-1d6-s","shield-throw-20"];return}}}}class Migration828PruneInvalidTraits extends MigrationBase{static{__name(this,"Migration828PruneInvalidTraits")}static{__name2(this,"Migration828PruneInvalidTraits")}static version=.828;async updateActor(source2){const traits=source2.system.traits;if(traits)switch(source2.type){case"character":case"npc":{traits.value=traits.value.filter(t2=>t2 in creatureTraits);return}case"hazard":{traits.value=traits.value.filter(t2=>t2 in hazardTraits);return}case"vehicle":{traits.value=traits.value.filter(t2=>t2 in vehicleTraits);return}}}async updateItem(source2){const traits=source2.system.traits;if(!(!traits?.value||!Array.isArray(traits.value)))switch(traits.value=traits.value.filter(t2=>typeof t2=="string"),source2.type){case"action":{traits.value=traits.value.map(t2=>t2.replace(/^audible$/,"auditory").replace(/^concentration$/,"concentrate").replace(/^(interact|manipulation)$/i,"manipulate").replace(/^vocal$/,"verbal")).filter(t2=>t2.startsWith("hb_")||t2 in actionTraits);return}case"affliction":case"effect":{traits.value=traits.value.filter(t2=>t2.startsWith("hb_")||t2 in actionTraits||t2 in spellTraits);return}case"ancestry":{traits.value=traits.value.filter(t2=>t2.startsWith("hb_")||t2 in creatureTraits||["animal"].includes(t2));return}case"armor":{traits.value=traits.value.map(t2=>source2.system.slug?.includes("helmsmans")?t2.replace(/^shield-throw$/,"shield-throw-30"):source2.system.slug?.includes("klar")?t2.replace(/^integrated$/,"integrated-1d6-s-versatile-p"):t2).filter(t2=>t2.startsWith("hb_")||t2 in armorTraits);return}case"backpack":case"equipment":{traits.value=traits.value.filter(t2=>t2.startsWith("hb_")||t2 in equipmentTraits);return}case"consumable":{traits.value=traits.value.filter(t2=>t2.startsWith("hb_")||t2 in consumableTraits);return}case"class":{traits.value=traits.value.filter(t2=>t2.startsWith("hb_")||t2 in classTraits);return}case"feat":{traits.value=traits.value.filter(t2=>t2.startsWith("hb_")||t2 in featTraits);return}case"melee":{traits.value=traits.value.filter(t2=>t2.startsWith("hb_")||t2 in npcAttackTraits);return}case"spell":{traits.value=traits.value.map(t2=>t2.replace(/^audible$/,"auditory")).filter(t2=>t2.startsWith("hb_")||t2 in spellTraits);return}case"weapon":{traits.value=traits.value.filter(t2=>t2.startsWith("hb_")||t2 in weaponTraits);return}}}}class Migration829RMRitualEntries extends MigrationBase{static{__name(this,"Migration829RMRitualEntries")}static{__name2(this,"Migration829RMRitualEntries")}static version=.829;async updateActor(source2){for(const item of source2.items.filter(i=>i.type==="spellcastingEntry"))item.system.prepared.value==="ritual"&&(source2.items.splice(source2.items.indexOf(item),1),source2.type==="npc"&&(source2.system.spellcasting??={},source2.system.spellcasting.rituals={dc:item.system.spelldc.dc}))}async updateItem(source2){!("category"in source2.system)||!e$2(source2.system.category)||typeof source2.system.category.value!="string"||source2.type==="spell"&&source2.system.category.value==="ritual"&&source2.system.location&&(source2.system.location.value=null)}}class Migration830BarbarianRework extends MigrationBase{static{__name(this,"Migration830BarbarianRework")}static{__name2(this,"Migration830BarbarianRework")}static version=.83;async updateItem(source2){source2.system.description.value=this.#removeLinks(source2.system.description.value);for(const rule of source2.system.rules)rule.key==="ActiveEffectLike"&&"path"in rule&&(rule.path==="system.custom.modifiers.barbarian-dedication-count"||rule.path==="flags.pf2e.rollOptions.all.barbarian-dedication")&&(rule.path="flags.pf2e.barbarian.archetypeFeatCount"),rule.key==="FlatModifier"&&"value"in rule&&rule.value==="3 * @actor.system.custom.modifiers.barbarian-dedication-count"&&(rule.value="3 * @actor.flags.pf2e.barbarian.archetypeFeatCount")}#removeLinks(text2){return text2.replace("@UUID[Compendium.pf2e.classfeatures.vlRvOQS1HZZqSyh7]{Ape}","Ape").replace("@UUID[Compendium.pf2e.classfeatures.uGY2yddm8mZx8Yo2]{Bear}","Bear").replace("@UUID[Compendium.pf2e.classfeatures.31sPXwmEbbcvgsM9]{Bull}","Bull").replace("@UUID[Compendium.pf2e.classfeatures.vCNtX2LwlemhA3tu]{Cat}","Cat").replace("@UUID[Compendium.pf2e.classfeatures.RQUJgDjJODO775qb]{Deer}","Deer").replace("@UUID[Compendium.pf2e.classfeatures.CXZwt1e6ManeBaFV]{Frog}","Frog").replace("@UUID[Compendium.pf2e.classfeatures.OJmI1L4dhQfz8vze]{Shark}","Shark").replace("@UUID[Compendium.pf2e.classfeatures.pIYWMCNnYDQfSRQh]{Snake}","Snake").replace("@UUID[Compendium.pf2e.classfeatures.xX6KnYYgHlPGoTG6]{Wolf}","Wolf").replace("@UUID[Compendium.pf2e.classfeatures.VNbDNiWjARtGQQAs]{Black}","Black").replace("@UUID[Compendium.pf2e.classfeatures.RiOww9KMu06D7wtW]{Blue}","Blue").replace("@UUID[Compendium.pf2e.classfeatures.IezPDYlweTtwCqkT]{Green}","Green").replace("@UUID[Compendium.pf2e.classfeatures.hyHgLQCDMSrR4RfE]{Red}","Red").replace("@UUID[Compendium.pf2e.classfeatures.2esqOHCn4GcZ4zYD]{White}","White").replace("@UUID[Compendium.pf2e.classfeatures.b5rvKZQCfpgBenKJ]{Brass}","Brass").replace("@UUID[Compendium.pf2e.classfeatures.kdzIxHpzeRbdRqQA]{Bronze}","Bronze").replace("@UUID[Compendium.pf2e.classfeatures.1ZugTzJHsa94AZRW]{Copper}","Copper").replace("@UUID[Compendium.pf2e.classfeatures.3lxIGMbsPZLNEXQ7]{Gold}","Gold").replace("@UUID[Compendium.pf2e.classfeatures.Z2eWkfXblU0QxFx1]{Silver}","Silver").replace("@UUID[Compendium.pf2e.classfeatures.Ape Animal Instinct]{Ape}","Ape").replace("@UUID[Compendium.pf2e.classfeatures.Bear Animal Instinct]{Bear}","Bear").replace("@UUID[Compendium.pf2e.classfeatures.Bull Animal Instinct]{Bull}","Bull").replace("@UUID[Compendium.pf2e.classfeatures.Cat Animal Instinct]{Cat}","Cat").replace("@UUID[Compendium.pf2e.classfeatures.Deer Animal Instinct]{Deer}","Deer").replace("@UUID[Compendium.pf2e.classfeatures.Frog Animal Instinct]{Frog}","Frog").replace("@UUID[Compendium.pf2e.classfeatures.Shark Animal Instinct]{Shark}","Shark").replace("@UUID[Compendium.pf2e.classfeatures.Snake Animal Instinct]{Snake}","Snake").replace("@UUID[Compendium.pf2e.classfeatures.Wolf Animal Instinct]{Wolf}","Wolf").replace("@UUID[Compendium.pf2e.classfeatures.Black Dragon Instinct]{Black}","Black").replace("@UUID[Compendium.pf2e.classfeatures.Blue Dragon Instinct]{Blue}","Blue").replace("@UUID[Compendium.pf2e.classfeatures.Green Dragon Instinct]{Green}","Green").replace("@UUID[Compendium.pf2e.classfeatures.Red Dragon Instinct]{Red}","Red").replace("@UUID[Compendium.pf2e.classfeatures.White Dragon Instinct]{White}","White").replace("@UUID[Compendium.pf2e.classfeatures.Brass Dragon Instinct]{Brass}","Brass").replace("@UUID[Compendium.pf2e.classfeatures.Bronze Dragon Instinct]{Bronze}","Bronze").replace("@UUID[Compendium.pf2e.classfeatures.Copper Dragon Instinct]{Copper}","Copper").replace("@UUID[Compendium.pf2e.classfeatures.Gold Dragon Instinct]{Gold}","Gold").replace("@UUID[Compendium.pf2e.classfeatures.Silver Dragon Instinct]{Silver}","Silver")}}class Migration831ClericDoctrines extends MigrationBase{static{__name(this,"Migration831ClericDoctrines")}static{__name2(this,"Migration831ClericDoctrines")}static version=.831;get#cloisteredClericSetFlags(){return{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.cleric",value:{firstDoctrine:"Compendium.pf2e.classfeatures.aiwxBj5MjnafCMyn",secondDoctrine:"Compendium.pf2e.classfeatures.sa7BWfnyCswAvBVa",thirdDoctrine:"Compendium.pf2e.classfeatures.s8WEmc4GGZSHSC7q",fourthDoctrine:"Compendium.pf2e.classfeatures.vxOf4LXZcqUG3P7a",fifthDoctrine:"Compendium.pf2e.classfeatures.n9W8MjjRgPpUTvWf",finalDoctrine:"Compendium.pf2e.classfeatures.DgGefatQ4v6xT6f9"}}}get#warpriestSetFlags(){return{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.cleric",value:{firstDoctrine:"Compendium.pf2e.classfeatures.xxkszluN9icAiTO4",secondDoctrine:"Compendium.pf2e.classfeatures.D34mPo29r1J3DPaX",thirdDoctrine:"Compendium.pf2e.classfeatures.Zp81uTBItG1xlH4O",fourthDoctrine:"Compendium.pf2e.classfeatures.px3gVYp7zlEQIpcl",fifthDoctrine:"Compendium.pf2e.classfeatures.kmimy4VOaoEOgOiQ",finalDoctrine:"Compendium.pf2e.classfeatures.N1ugDqZlslxbp3Uy"}}}async updateItem(source2){if(!(source2.type!=="feat"||!source2.system.slug)&&!source2.system.rules.some(r2=>r2.key==="ActiveEffectLike"&&r2.path==="flags.pf2e.cleric"))switch(source2.system.slug){case"cloistered-cleric":{source2.system.rules.push(this.#cloisteredClericSetFlags);break}case"warpriest":{source2.system.rules.push(this.#warpriestSetFlags);break}}}}class Migration832ChoiceSetFlags extends MigrationBase{static{__name(this,"Migration832ChoiceSetFlags")}static{__name2(this,"Migration832ChoiceSetFlags")}static version=.832;async updateItem(source2){const choiceSets=source2.system.rules.filter(r2=>r2.key==="ChoiceSet"&&"flag"in r2&&typeof r2.flag=="string");for(const choiceSet of choiceSets){const originalFlag=choiceSet.flag;if(choiceSet.flag=sluggify(choiceSet.flag,{camel:"dromedary"}),choiceSet.flag!==originalFlag){console.log(`${originalFlag} ->> ${choiceSet.flag}`);const pattern=new RegExp(String.raw`\brulesSelections\.${originalFlag}\b`,"g");source2.system.rules=source2.system.rules.map(r2=>r2.key==="ChoiceSet"?r2:recursiveReplaceString(r2,s=>s.replace(pattern,`rulesSelections.${choiceSet.flag}`)))}}}}class Migration833AddRogueToysFixPrecision extends MigrationBase{static{__name(this,"Migration833AddRogueToysFixPrecision")}static{__name2(this,"Migration833AddRogueToysFixPrecision")}static version=.833;async updateItem(source2){if(source2.type!=="feat")return;const flatFootedId="game"in globalThis?"AJh5ex99aV6VTggg":"Flat-Footed";switch(source2.system.slug){case"surprise-attack":{const rules=[{key:"EphemeralEffect",predicate:["encounter:round:1",{lt:["self:participant:initiative:rank","target:participant:initiative:rank"]},{or:["self:participant:initiative:stat:deception","self:participant:initiative:stat:stealth"]}],selectors:["strike-attack-roll","spell-attack-roll","strike-damage","attack-spell-damage"],uuid:`Compendium.pf2e.conditionitems.Item.${flatFootedId}`}];source2.system.rules=rules;break}case"dread-striker":{const rules=[{key:"EphemeralEffect",predicate:["target:condition:frightened"],selectors:["strike-attack-roll","spell-attack-roll","strike-damage","attack-spell-damage"],uuid:`Compendium.pf2e.conditionitems.Item.${flatFootedId}`}];source2.system.rules=rules;break}case"precision":{if(source2.system.rules.some(r2=>"damageType"in r2&&r2.damageType==="precision")){const rules=[{domain:"all",key:"RollOption",label:"PF2E.SpecificRule.Ranger.HuntersEdge.FirstAttack",option:"first-attack",toggleable:!0},{category:"precision",diceNumber:"ternary(lt(@actor.level, 11), 1, ternary(lt(@actor.level, 19), 2, 3))",dieSize:"d8",key:"DamageDice",predicate:["first-attack"],selector:"strike-damage"}];source2.system.rules=rules}break}}}}const FEAT_CATEGORIES=new Set(["ancestry","bonus","class","general","skill"]),FEATURE_CATEGORIES=new Set(["ancestryfeature","calling","classfeature","curse","deityboon","pfsboon"]),FEAT_OR_FEATURE_CATEGORIES=new Set(["ancestry","ancestryfeature","bonus","calling","class","classfeature","curse","deityboon","general","pfsboon","skill"]);class Migration834FeatCategories extends MigrationBase{static{__name(this,"Migration834FeatCategories")}static{__name2(this,"Migration834FeatCategories")}static version=.834;#updateCategoryData(system2){const{traits}=system2;if("featType"in system2&&e$2(system2.featType)){const category=system2.featType.value;delete system2.featType,"game"in globalThis&&(system2["-=featType"]=null),category==="archetype"?(system2.category=system2.traits.value.includes("skill")?"skill":"class",traits.value.includes("archetype")||(traits.value.push("archetype"),traits.value.sort())):setHasElement(FEAT_OR_FEATURE_CATEGORIES,category)&&(system2.category=category)}setHasElement(FEAT_OR_FEATURE_CATEGORIES,system2.category)||(system2.category="bonus"),system2.category==="skill"&&!traits.value.includes("archetype")&&!traits.value.includes("general")&&(system2.traits.value.push("general"),system2.traits.value.sort())}async updateItem(source2){source2.type==="feat"&&this.#updateCategoryData(source2.system);const choiceSets=source2.system.rules.filter(r2=>r2.key==="ChoiceSet");for(const rule of choiceSets)e$2(rule.allowedDrops)&&"predicate"in rule.allowedDrops&&Array.isArray(rule.allowedDrops.predicate)&&(rule.allowedDrops.predicate=recursiveReplaceString(rule.allowedDrops.predicate,s=>s.replace(/\bfeat(?:ure)?-type\b/,"category"))),e$2(rule.choices)&&"query"in rule.choices&&typeof rule.choices.query=="string"&&(rule.choices.query=rule.choices.query.replace('"featType.value":"archetype"','"category":"class"').replace("featType.value","category"))}}class Migration927ClassBackgroundBattleFormSkillLongform extends MigrationBase{static{__name(this,"Migration927ClassBackgroundBattleFormSkillLongform")}static{__name2(this,"Migration927ClassBackgroundBattleFormSkillLongform")}static version=.927;async updateItem(source2){for(const rule of source2.system.rules)rule.key==="BattleForm"&&this.#updateBattleForm(rule);source2.type==="class"?this.#updateClass(source2):source2.type==="background"&&this.#updateBackground(source2)}#updateBattleForm(rule){if(!rule.overrides?.skills)return;const skills=rule.overrides.skills;for(const[key,value]of Object.entries(skills))objectHasKey(SKILL_DICTIONARY,key)&&(skills[SKILL_DICTIONARY[key]]=value,delete skills[key])}#updateClass(source2){const system2=source2.system,mapping=SKILL_DICTIONARY;system2.trainedSkills.value=system2.trainedSkills.value.map(s=>mapping[s]??s)}#updateBackground(source2){const system2=source2.system,mapping=SKILL_DICTIONARY;if(system2.trainedSkills.value=system2.trainedSkills.value.map(s=>mapping[s]??s),"trainedLore"in system2){const lores=system2.trainedLore?system2.trainedLore.split(",").map(s=>s.trim()):[];system2.trainedSkills.lore=system2.trainedSkills.lore?.length?system2.trainedSkills.lore:lores,system2["-=trainedLore"]=null}}}const SKILL_DICTIONARY={acr:"acrobatics",arc:"arcana",ath:"athletics",cra:"crafting",dec:"deception",dip:"diplomacy",itm:"intimidation",med:"medicine",nat:"nature",occ:"occultism",prf:"performance",rel:"religion",soc:"society",ste:"stealth",sur:"survival",thi:"thievery"},SKILL_ABBREVIATIONS$1=t$4(SKILL_DICTIONARY);class Migration835InitiativeLongform extends MigrationBase{static{__name(this,"Migration835InitiativeLongform")}static{__name2(this,"Migration835InitiativeLongform")}static version=.835;async updateActor(actor){const initiative=(actor.system.attributes??{}).initiative;if(!initiative?.ability)return;const ability=initiative.ability;objectHasKey(SKILL_DICTIONARY,ability)?initiative.statistic=SKILL_DICTIONARY[ability]:initiative.statistic="perception",initiative["-=ability"]=null}}class Migration836EnergizingConsolidation extends MigrationBase{static{__name(this,"Migration836EnergizingConsolidation")}static{__name2(this,"Migration836EnergizingConsolidation")}static version=.836;#rename(text2){const newEffectEnergizingRune="equipment-effects.R5ywXEYZFV1WBe8t";return text2.replace("equipment-effects.ClsVhp5baFRjZQ23",newEffectEnergizingRune).replace("equipment-effects.68xcDyxsNgD3JddD",newEffectEnergizingRune).replace("equipment-effects.9BsFdrEc7hkPWgSd",newEffectEnergizingRune).replace("equipment-effects.ascxqSlMEN9R6OOy",newEffectEnergizingRune).replace("equipment-effects.4RnEUeYEzC919GZR",newEffectEnergizingRune)}async updateItem(source2){source2.system.description.value.includes("equipment-effects")&&(source2.system.description.value=this.#rename(source2.system.description.value))}}class Migration837MoveHazardBookSources extends MigrationBase{static{__name(this,"Migration837MoveHazardBookSources")}static{__name2(this,"Migration837MoveHazardBookSources")}static version=.837;async updateActor(source2){if(source2.type==="hazard"&&e$2(source2.system.source)){const value=typeof source2.system.source.value=="string"?source2.system.source.value:"",author=typeof source2.system.source.author=="string"?source2.system.source.author:"";source2.system.details.source={value,author},"game"in globalThis?source2.system["-=source"]=null:delete source2.system.source}}}class Migration838StrikeAttackRollSelector extends MigrationBase{static{__name(this,"Migration838StrikeAttackRollSelector")}static{__name2(this,"Migration838StrikeAttackRollSelector")}static version=.838;async updateItem(source2){Array.isArray(source2.system.rules)||(source2.system.rules=[]);for(const rule of source2.system.rules)"selector"in rule&&(rule.selector==="mundane-attack"?rule.selector="strike-attack-roll":Array.isArray(rule.selector)&&(rule.selector=rule.selector.map(s=>s==="mundane-attack"?"strike-attack-roll":s)))}}class Migration839ActionCategories extends MigrationBase{static{__name(this,"Migration839ActionCategories")}static{__name2(this,"Migration839ActionCategories")}static version=.839;async updateItem(source2,actorSource){if(source2.type!=="action")return;const system2=source2.system;if(system2.actionCategory){const npcCategories=["offensive","defensive","interaction"],oldValue=system2.actionCategory.value||null,mustBeNull=oldValue&&npcCategories.includes(oldValue)&&actorSource&&actorSource.type!=="npc";system2.category=mustBeNull?null:oldValue,delete system2.actionCategory,system2["-=actionCategory"]=null}}}class Migration840ArrayWrapPredicates extends MigrationBase{static{__name(this,"Migration840ArrayWrapPredicates")}static{__name2(this,"Migration840ArrayWrapPredicates")}static version=.84;#wrapPredicate(predicate){if(Array.isArray(predicate))return predicate;const arrayWrapped=[predicate];return predicate&&Predicate.isValid(arrayWrapped)?arrayWrapped:void 0}async updateItem(source2){for(const rule of source2.system.rules)"predicate"in rule&&(rule.predicate=this.#wrapPredicate(rule.predicate)),"definition"in rule&&(rule.definition=this.#wrapPredicate(rule.definition))}}class Migration841V11UUIDFormat extends MigrationBase{static{__name(this,"Migration841V11UUIDFormat")}static{__name2(this,"Migration841V11UUIDFormat")}static version=.841;#replaceUUID(uuid,explicitDocType){if(typeof uuid!="string"||!uuid.startsWith("Compendium."))return uuid;const documentType=(()=>{if(explicitDocType)return explicitDocType;if("game"in globalThis){const{collection}=foundry.utils.parseUuid(uuid)??{};return collection instanceof foundry.documents.collections.CompendiumCollection?collection.metadata.type??null:null}return null})();if(!documentType)return uuid;const parts=uuid.split(/\.(?! )/);if(parts.length!==4)return uuid;const[head,scope,pack,id]=parts;return`${head}.${scope}.${pack}.${documentType}.${id}`}#replaceUUIDsInLinks(text2){return typeof text2!="string"?text2:Array.from(text2.matchAll(/(?<=@UUID\[)[^\]]+(?=\])/g)).reduce((replaced,[link])=>replaced.replace(link,s=>this.#replaceUUID(s)),text2)}async updateActor(source2){if(source2._stats.compendiumSource&&(source2._stats.compendiumSource=this.#replaceUUID(source2._stats.compendiumSource,"Actor")),source2.type==="character"){if(e$2(source2.system.crafting)&&Array.isArray(source2.system.crafting.formulas))for(const formula of source2.system.crafting.formulas)formula.uuid=this.#replaceUUID(formula.uuid,"Item")}else if(source2.type==="npc"){const{details}=source2.system;details.publicNotes&&=this.#replaceUUIDsInLinks(details.publicNotes),details.privateNotes&&=this.#replaceUUIDsInLinks(details.privateNotes)}else if(source2.type==="hazard"){const{details}=source2.system;details.reset&&=this.#replaceUUIDsInLinks(details.reset),details.description&&=this.#replaceUUIDsInLinks(details.description),details.routine&&=this.#replaceUUIDsInLinks(details.routine),details.disable&&=this.#replaceUUIDsInLinks(details.disable)}}async updateItem(source2){if(source2._stats.compendiumSource&&(source2._stats.compendiumSource=this.#replaceUUID(source2._stats.compendiumSource,"Item")),source2.system.rules=source2.system.rules.map(rule=>("text"in rule&&typeof rule.text=="string"&&(rule.text=this.#replaceUUIDsInLinks(rule.text)),recursiveReplaceString(rule,s=>this.#replaceUUID(s,"Item")))),itemIsOfType(source2,"ancestry","background","class","kit")){const items=source2.system.items;for(const entry of Object.values(items))if(entry.uuid=this.#replaceUUID(entry.uuid,"Item"),e$2(entry.items))for(const subentry of Object.values(entry.items))subentry.uuid=this.#replaceUUID(subentry.uuid,"Item")}else if(source2.type==="heritage")source2.system.ancestry?.uuid&&(source2.system.ancestry.uuid=this.#replaceUUID(source2.system.ancestry.uuid,"Item"));else if(source2.type==="deity")for(const[key,spell]of Object.entries(source2.system.spells))source2.system.spells[Number(key)]=this.#replaceUUID(spell);const{description}=source2.system;description.value??="",description.value=this.#replaceUUIDsInLinks(description.value),description.value=description.value.replace(/Compendium\.pf2e\.journals\.(?!JournalEntry)/g,"Compendium.pf2e.journals.JournalEntry."),description.gm&&=this.#replaceUUIDsInLinks(description.gm)}async updateJournalEntry(source2){for(const page of source2.pages)page.text.content&&=this.#replaceUUIDsInLinks(page.text.content)}}class Migration842NumifyNumericSettings extends MigrationBase{static{__name(this,"Migration842NumifyNumericSettings")}static{__name2(this,"Migration842NumifyNumericSettings")}static version=.842;async migrate(){for(const setting of["staminaVariant","worldClock.timeConvention"]){const value=game.settings.storage.get("world").getItem(`pf2e.${setting}`);value!==null&&typeof value!="number"&&await game.settings.set("pf2e",setting,Number(value))}}}class Migration843RMArmorCustomModifiers extends MigrationBase{static{__name(this,"Migration843RMArmorCustomModifiers")}static{__name2(this,"Migration843RMArmorCustomModifiers")}static version=.843;async updateActor(source2){if(source2.type==="character"&&source2.system.customModifiers?.armor){const customModifiers=source2.system.customModifiers;customModifiers["-=armor"]=null}}}class Migration844DeityDomainUUIDs extends MigrationBase{static{__name(this,"Migration844DeityDomainUUIDs")}static{__name2(this,"Migration844DeityDomainUUIDs")}static version=.844;#updateUUIDs(text2){return this.#idMap.reduce((oldText,data)=>{const pattern=new RegExp(String.raw`\bCompendium\.pf2e\.domains\.(?:JournalEntry?\.)?(?:${data.oldId}|${data.name})\](?:\{[^}]+})?`,"g");return oldText.replace(pattern,`Compendium.pf2e.journals.JournalEntry.EEZvDB1Z7ezwaxIr.JournalEntryPage.${data.pageId}]{${data.name}}`)},text2)}async updateActor(source2){source2.type==="npc"&&(source2.system.details.publicNotes&&=this.#updateUUIDs(source2.system.details.publicNotes))}async updateItem(source2){source2.system.description.gm&&=this.#updateUUIDs(source2.system.description.gm),source2.system.description.value&&=this.#updateUUIDs(source2.system.description.value)}#idMap=[{oldId:"0cbxczrql4MwAHwV",name:"Glyph Domain",pageId:"9g1dNytABTpmmGkG"},{oldId:"1BU8deh48XZFclWl",name:"Healing Domain",pageId:"A7vErdGAweYsFcW8"},{oldId:"1NHV4ujqoR2JVWpY",name:"Travel Domain",pageId:"bTujFcUut9RX4GCy"},{oldId:"1aoUqGYDrdpnPWio",name:"Family Domain",pageId:"SAnmegCTIqGW9S7S"},{oldId:"41qaGiMit8nDP4xv",name:"Abomination Domain",pageId:"qMS6QepvY7UQQjcr"},{oldId:"6klWznsb0f2bNg3T",name:"Void Domain",pageId:"xLxrtbsj4acqgsyC"},{oldId:"8ITGLquhimrr9CNv",name:"Indulgence Domain",pageId:"GiuzDTtkQAgtGW6n"},{oldId:"8pPvbTMZLIsvCwQk",name:"Darkness Domain",pageId:"CM9ZqWwl7myKn2X1"},{oldId:"9blxcDLIRPWenK5f",name:"Plague Domain",pageId:"hGoWOjdsUz16oJUm"},{oldId:"9tsJg13xeJLGzzGV",name:"Undeath Domain",pageId:"RIlgBuWGfHC1rzYu"},{oldId:"AaY3BmDItGry4oac",name:"Decay Domain",pageId:"cAxBEZsej32riaY5"},{oldId:"B40VxP6oZ0mIR4PS",name:"Fate Domain",pageId:"EC2eB0JglDG5j1gT"},{oldId:"BlovCvjhk4Ag07w2",name:"Dreams Domain",pageId:"0wCEUwABKPdKPj8e"},{oldId:"FJ9D4qpeRhJvjHai",name:"Star Domain",pageId:"6bDpXy7pQdGrd2og"},{oldId:"HYe7Yv1fYUANVVI3",name:"Death Domain",pageId:"798PFdS8FmefcOl0"},{oldId:"HpZ4NQIqBRcFihyE",name:"Wealth Domain",pageId:"mJBp4KIszuqrmnp5"},{oldId:"J7K7kHoIE69558Su",name:"Freedom Domain",pageId:"5MjSsuKOLBoiL8FB"},{oldId:"KXFxeEyD6MmJ3a6V",name:"Naga Domain",pageId:"QzsUe3Rt3SifTQvb"},{oldId:"KzuJAIWdjwoPjHkc",name:"Secrecy Domain",pageId:"S1gyomjojgtCdxc3"},{oldId:"M7koZH0zimcMgRDb",name:"Destruction Domain",pageId:"AOQZjqgfafqqtHOB"},{oldId:"MRHDhBQvgJhDZ1zq",name:"Cities Domain",pageId:"QSk78hQR3zskMlq2"},{oldId:"MktBsoHR9HsKrbbr",name:"Zeal Domain",pageId:"DI3MYGIK8iEycanU"},{oldId:"NA4v0iwIPgkde8DP",name:"Ambition Domain",pageId:"yaMJsfYZmWJLqbFE"},{oldId:"NEI4MDBGNjEtOEIy",name:"Introspection Domain",pageId:"qjnUXickBOBDBu2N"},{oldId:"O1qeC0mIufSf3wv5",name:"Passion Domain",pageId:"ajCEExOaxuB4C1tY"},{oldId:"OsM8NfP408uB6yTi",name:"Wyrmkin Domain",pageId:"nuywscaiVGXLQpZ1"},{oldId:"PrFvU65ewfst69Mp",name:"Water Domain",pageId:"U8WVR6EDfmUaMCbu"},{oldId:"TpFgfwcWrfT8zVMP",name:"Pain Domain",pageId:"FtW1gtbHgO0KofPl"},{oldId:"WrmaTmOHojfhiENF",name:"Truth Domain",pageId:"lgsJz7mZ1OTe340e"},{oldId:"X7MkBRJGUIp91k6f",name:"Sorrow Domain",pageId:"5TqEbLR9QT3gJGe3"},{oldId:"Xs6XznYHOZyQ0hJl",name:"Tyranny Domain",pageId:"T0JHj79aGphlZ4Mt"},{oldId:"Y2kOBQydrsSqGCyn",name:"Magic Domain",pageId:"DS95vr2zmTsjsMhU"},{oldId:"YQ6IT8DgEpqvOREx",name:"Might Domain",pageId:"MOVMHZU1SfkhNN1K"},{oldId:"ZAx1RUB376BjNdlF",name:"Repose Domain",pageId:"CbsAiY68e8n5vVVN"},{oldId:"Ze2hoTyOQHbaQ6jD",name:"Air Domain",pageId:"T2y0vuYibZCL7CH0"},{oldId:"ZyFTUCbA0zYrzynD",name:"Creation Domain",pageId:"ydbCjJ9PPmRzZhDN"},{oldId:"a0fe0kFowMMwUFZa",name:"Nightmares Domain",pageId:"R20JXF43vU5RQyUj"},{oldId:"c9odhpRoKId5dXmn",name:"Perfection Domain",pageId:"Czi3XXuNOSE7ISpd"},{oldId:"dnljU1twPjH4KFgO",name:"Swarm Domain",pageId:"rd0jQwvTK4jpv95o"},{oldId:"fVfFKKvGocG2JM5q",name:"Toil Domain",pageId:"EQfZepZX6rxxBRqG"},{oldId:"fqr2OnTww3bAq0ae",name:"Sun Domain",pageId:"CkBvj5y1lAm1jnsc"},{oldId:"giUsAWI9NbpdeUzl",name:"Knowledge Domain",pageId:"0GwpYEjCHWyfQvgg"},{oldId:"i4UU3qCjIMwejIQF",name:"Delirium Domain",pageId:"tuThzOCvMLbRVba8"},{oldId:"jWmGQxJvKh5y5zfB",name:"Protection Domain",pageId:"Dx47K8wpx8KZUa9S"},{oldId:"l2EFJssJKu7rG77m",name:"Luck Domain",pageId:"L11XsA5G89xVKlDw"},{oldId:"mBvjWSvg7UYdS9TL",name:"Moon Domain",pageId:"Y3DFBCWiM9GBIlfl"},{oldId:"p5Q5RGl1lKgs5DZZ",name:"Soul Domain",pageId:"rtobUemb6vF2Yu3Y"},{oldId:"rIDXRIdb9m2E3qC6",name:"Earth Domain",pageId:"zkiLWWYzzqoxmN2J"},{oldId:"rIZ7OoG8c4Cct42M",name:"Vigil Domain",pageId:"StXN6IHR6evRaeXF"},{oldId:"udASTZy5jJWFCt5w",name:"Time Domain",pageId:"3P0NWwP3s7bIiidH"},{oldId:"unN0otycQZanf3va",name:"Duty Domain",pageId:"uGQKjk2w4whzomky"},{oldId:"uy8GUGIOmEUNqIhH",name:"Trickery Domain",pageId:"xJtbGqoz3BcCjUik"},{oldId:"v4SDXgCuPdZqhMeL",name:"Fire Domain",pageId:"egSErNozlL3HRK1y"},{oldId:"wCPGej4ZwdKCNtym",name:"Change Domain",pageId:"7xrNAgAnBqBgE3yM"},{oldId:"wPtGuF1bh4wvKE6Q",name:"Confidence Domain",pageId:"flmxRzGxN2rRNyxZ"},{oldId:"xYx8UD0JnFyBHGhJ",name:"Nature Domain",pageId:"wBhgIgt47v9uspp3"},{oldId:"y3TTKFLPbP09HZUW",name:"Cold Domain",pageId:"jq9O1tl76g2AzLOh"},{oldId:"ywn4ODaUt382Z3Nz",name:"Lightning Domain",pageId:"Kca7UPuMm44tOo9n"},{oldId:"zec5N7EnDJANGHmy",name:"Dust Domain",pageId:"6qTjtFWaBO5b60zJ"}]}class Migration845EmptySpellConsumables extends MigrationBase{static{__name(this,"Migration845EmptySpellConsumables")}static{__name2(this,"Migration845EmptySpellConsumables")}static version=.845;async preUpdateItem(source2){if(source2.type==="consumable"){const spell=source2.system.spell;e$2(spell)&&!["_id","name","type","system"].every(p=>p in spell)&&(source2.system.spell=null)}}}class Migration846SpellSchoolOptional extends MigrationBase{static{__name(this,"Migration846SpellSchoolOptional")}static{__name2(this,"Migration846SpellSchoolOptional")}static version=.846;async updateItem(source2){if(source2.type!=="spell")return;const system2=source2.system;if(system2.school){const traits=system2.traits;traits.value=n([...source2.system.traits.value,system2.school.value]).filter(e$1),system2["-=school"]=null,delete system2.school}}}class Migration847TempHPRuleEvents extends MigrationBase{static{__name(this,"Migration847TempHPRuleEvents")}static{__name2(this,"Migration847TempHPRuleEvents")}static version=.847;async updateItem(source2){const rules=source2.system.rules.filter(r2=>r2.key==="TempHP");for(const rule of rules)rule.onCreate!==void 0&&(rule.events??={},rule.events.onCreate=rule.onCreate,delete rule.onCreate),rule.onTurnStart!==void 0&&(rule.events??={},rule.events.onTurnStart=rule.onTurnStart,delete rule.onTurnStart)}}class Migration848NumericArmorProperties extends MigrationBase{static{__name(this,"Migration848NumericArmorProperties")}static{__name2(this,"Migration848NumericArmorProperties")}static version=.848;#oldToNew=[["armor","acBonus"],["dex","dexCap"],["check","checkPenalty"],["speed","speedPenalty"],["strength","strength"]];async updateItem(source2){if(source2.type==="armor")for(const[oldKey,newKey]of this.#oldToNew){const oldProperty=source2.system[oldKey],newProperty=e$2(source2.system[newKey])?0:source2.system[newKey]??0;if(e$2(oldProperty)&&newProperty===0)if(delete source2.system[oldKey],oldKey==="strength"){const value=Number(oldProperty.value)||null;source2.system[newKey]=value===null?null:Math.max(Math.floor((value-10)/2),0)}else tupleHasValue(["checkPenalty","speedPenalty"],newKey)?(source2.system[newKey]=Number(oldProperty.value)||0,source2.system[`-=${oldKey}`]=null):(source2.system[newKey]=Number(oldProperty.value)||0,source2.system[`-=${oldKey}`]=null)}}}class Migration849DeleteBrokenThreshold extends MigrationBase{static{__name(this,"Migration849DeleteBrokenThreshold")}static{__name2(this,"Migration849DeleteBrokenThreshold")}static version=.849;async updateItem(source2){const system2=source2.system,hitPoints="hp"in system2&&e$2(system2.hp)?system2.hp:{};"brokenThreshold"in hitPoints&&(delete hitPoints.brokenThreshold,hitPoints["-=brokenThreshold"]=null)}}class Migration850FlatFootedToOffGuard extends MigrationBase{static{__name(this,"Migration850FlatFootedToOffGuard")}static{__name2(this,"Migration850FlatFootedToOffGuard")}static version=.85;#oldNamePattern=new RegExp(/\bFlat-Footed\b/g);#newName="Off-Guard";#imgPattern=/(?<=systems\/pf2e\/icons\/conditions(?:-2)?\/)flat-?footed.webp$/i;#aToAnUUIDPatern=/\ba(?= @UUID\[Compendium\.pf2e\.conditionitems\.Item\.(?:Flat-Footed|AJh5ex99aV6VTggg)\])/g;#replace(text2){return text2.replace(this.#imgPattern,"off-guard.webp").replace(/^flat-footed$/,"off-guard").replace(/(?<=[:.])flat-footed\b/g,"off-guard").replace(/\.Flat-Footed\b/g,".Off-Guard").replace(/\bFlatFooted\b/g,"OffGuard").replace(/\.flatFootable\b/g,".offGuardable").replace(this.#oldNamePattern,"Off-Guard").replace(/\bflatfooted\b/g,"flat-footed").replace(/\ba flat-footed\b/g,"an off-guard").replace(this.#aToAnUUIDPatern,"an").replace(/\bFlat-footed\b/g,"Off-guard").replace(/\bflat-footed\b/g,"off-guard")}async updateActor(source2){source2.type==="hazard"&&(source2.system.details.routine&&=this.#replace(source2.system.details.routine)),"attributes"in source2.system&&e$2(source2.system.attributes)&&"immunities"in source2.system.attributes&&(source2.system.attributes.immunities=recursiveReplaceString(source2.system.attributes.immunities,s=>this.#replace(s)))}async updateItem(source2){source2.name=source2.name.replace(this.#oldNamePattern,this.#newName),source2.img=source2.img.replace(this.#imgPattern,"off-guard.webp"),source2.system=recursiveReplaceString(source2.system,s=>this.#replace(s))}async updateJournalEntry(source2){source2.name!=="Remaster Changes"&&(source2.name=source2.name.replace(this.#oldNamePattern,this.#newName),"img"in source2&&typeof source2.img=="string"&&(source2.img=source2.img.replace(this.#imgPattern,"off-guard.webp")),source2.pages=recursiveReplaceString(source2.pages,s=>this.#replace(s)),"content"in source2&&typeof source2.content=="string"&&(source2.content=this.#replace(source2.content)))}}class Migration851JustInnovationId extends MigrationBase{static{__name(this,"Migration851JustInnovationId")}static{__name2(this,"Migration851JustInnovationId")}static version=.851;async updateItem(source2){if(source2.type!=="feat")return;source2.system.rules=source2.system.rules.map(r2=>recursiveReplaceString(r2,s=>s.replace("flags.pf2e.armorInnovationId","flags.pf2e.innovationId")));const hasAELike=source2.system.rules.some(r2=>r2.key==="ActiveEffectLike"&&r2.path==="flags.pf2e.innovationId");if(source2.system.slug==="weapon-innovation"&&!hasAELike){const reSource={key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.innovationId",value:"{item|flags.pf2e.itemGrants.weaponInnovation.id}"};source2.system.rules.push(reSource)}else if(source2.system.slug==="construct-innovation"&&!hasAELike){const reSource={key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.innovationId",value:null};source2.system.rules.push(reSource)}else if(source2.system.slug==="inventor-weapon-expertise"&&!source2.system.rules.some(r2=>r2.key==="CriticalSpecialization")){const reSource={key:"CriticalSpecialization",predicate:["feature:weapon-innovation","item:id:{actor|flags.pf2e.innovationId}"]};source2.system.rules.push(reSource)}}}class Migration852AbilityScoresToModifiers extends MigrationBase{static{__name(this,"Migration852AbilityScoresToModifiers")}static{__name2(this,"Migration852AbilityScoresToModifiers")}static version=.852;async updateActor(source2){if(source2.type!=="character")return;if(source2.system.abilities&&Object.keys(source2.system.abilities).length>0){const abilityObjects=Object.values(source2.system.abilities);for(const data of abilityObjects)typeof data.value=="number"&&(data.mod=Math.min(Math.max(Math.trunc((data.value-10)/2),-5),10)||0,delete data.value,data["-=value"]=null)}else if(source2.system.abilities){const systemData=source2.system;delete systemData.abilities,systemData["-=abilities"]=null}const build=source2.system.build??{};build.abilities&&(build.attributes=build.abilities,delete build.abilities,build["-=abilities"]=null)}async updateItem(source2){const apexRules=source2.system.rules.filter(r2=>r2.key==="ActiveEffectLike"&&typeof r2.path=="string"&&/^system\.abilities\..+\.value$/.test(r2.path)&&"value"in r2&&typeof r2.value=="number");for(const rule of apexRules)switch(rule.path=rule.path.replace(/\.value$/,".mod"),rule.mode){case"add":case"remove":case"subtract":rule.value=Math.min(Math.max(Math.trunc(rule.value/2),-5),10)||0;break;case"downgrade":case"override":case"upgrade":rule.value=Math.min(Math.max(Math.trunc((rule.value-10)/2),-5),10)||0;break}const otherRules=source2.system.rules.filter(r2=>"value"in r2&&typeof r2.value=="string"&&/\.abilities\.[a-z]{3}\.value\b/.test(r2.value));for(const rule of otherRules)rule.value=rule.value.replace(/(?:floor\()?\(?@actor.abilities.([a-z]{3})\.value ?- ?10\) ?\/ ?2\)?/,"@actor.abilities.$1.mod").replace(/\s+/g," ").trim();if(source2.system.slug==="thaumaturges-investiture"){source2.system.rules=source2.system.rules.filter(r2=>r2.key!=="ActiveEffectLike");const bracketedAELike={key:"ActiveEffectLike",mode:"upgrade",path:"system.resources.investiture.max",value:{brackets:[{end:4,start:4,value:14},{end:5,start:5,value:16},{end:6,start:6,value:18},{start:7,value:20}],field:"system.abilities.cha.mod"}};source2.system.rules.push(bracketedAELike)}}}class Migration853RemasterLanguages extends MigrationBase{static{__name(this,"Migration853RemasterLanguages")}static{__name2(this,"Migration853RemasterLanguages")}static version=.853;#OLD_TO_NEW_LANGUAGES=new Map([["aquan","thalassic"],["auran","sussuran"],["ignan","pyric"],["sylvan","fey"],["terran","petran"]]);async updateActor(source2){const traits=source2.system.traits;e$2(traits)&&e$2(traits.languages)&&Array.isArray(traits.languages.value)&&(traits.languages.value=traits.languages.value.map(l=>this.#OLD_TO_NEW_LANGUAGES.get(l)??l).sort())}async updateItem(source2){source2.system=recursiveReplaceString(source2.system,s=>this.#OLD_TO_NEW_LANGUAGES.get(s)??s),source2.type==="ancestry"&&Array.isArray(source2.system.additionalLanguages?.value)&&source2.system.additionalLanguages.value.sort()}}class Migration854BracketedAbilityScoresToModifiers extends MigrationBase{static{__name(this,"Migration854BracketedAbilityScoresToModifiers")}static{__name2(this,"Migration854BracketedAbilityScoresToModifiers")}static version=.854;async updateItem(source2){const aeLikes=source2.system.rules.filter(r2=>r2.key==="ActiveEffectLike"&&typeof r2.path=="string"&&/^system\.abilities\..+\.value$/.test(r2.path)&&"value"in r2&&e$2(r2.value)&&typeof r2.value.field=="string"&&/^actor\|system\.abilities\.[a-z]{3}\.value$/.test(r2.value.field)&&Array.isArray(r2.value.brackets)&&r2.value.brackets.every(b=>e$2(b)&&typeof b.value=="number"));for(const aeLike of aeLikes){aeLike.path=aeLike.path.replace(/\.value$/,".mod"),aeLike.value.field&&=aeLike.value.field.replace(/\.value$/,".mod");for(const bracket of aeLike.value.brackets){const{start,end,value}=bracket;typeof start=="number"&&(bracket.start=Math.trunc((start-10)/2)),typeof end=="number"&&(bracket.end=Math.trunc((end-10)/2)),typeof value=="number"&&(bracket.value=value/2)}}}}class Migration855ApexEquipmentSystemData extends MigrationBase{static{__name(this,"Migration855ApexEquipmentSystemData")}static{__name2(this,"Migration855ApexEquipmentSystemData")}static version=.855;async updateItem(source2){if(source2.type!=="equipment"||!source2.system.traits.value.includes("apex"))return;const attributeModPattern=/^system\.abilities\.([a-z]{3})\.mod$/,isApexRE=__name2(r2=>r2.key==="ActiveEffectLike"&&attributeModPattern.test(String(r2.path)),"isApexRE"),apexAttribute=source2.system.rules.flatMap(r2=>isApexRE(r2)?attributeModPattern.exec(String(r2.path))?.at(1):[]).shift();setHasElement(ATTRIBUTE_ABBREVIATIONS,apexAttribute)&&(source2.system.apex??={attribute:apexAttribute},source2.system.rules=source2.system.rules.filter(r2=>!isApexRE(r2)))}}class Migration856NoSystemDotCustom extends MigrationBase{static{__name(this,"Migration856NoSystemDotCustom")}static{__name2(this,"Migration856NoSystemDotCustom")}static version=.856;async updateItem(source2){source2.system.rules=source2.system.rules.map(r2=>recursiveReplaceString(r2,s=>s.replace(/\bsystem\.custom\.(?:modifiers\.)?([-a-z]+)/,(_match,group1)=>`flags.pf2e.${sluggify(group1,{camel:"dromedary"})}`)))}}class Migration857WeaponSpecializationRE extends MigrationBase{static{__name(this,"Migration857WeaponSpecializationRE")}static{__name2(this,"Migration857WeaponSpecializationRE")}static version=.857;async updateItem(source2){const slug=source2.system.slug??sluggify(source2.name);source2.type!=="feat"||!slug.includes("weapon-specialization")||slug.includes("eidolon-weapon-specialization")||source2.system.rules.some(r2=>r2.slug==="weapon-specialization")||(slug.includes("greater-weapon-specialization")?source2.system.rules.unshift({key:"AdjustModifier",mode:"multiply",relabel:"PF2E.GreaterWeaponSpecialization",selector:"strike-damage",slug:"weapon-specialization",value:2}):source2.system.rules.unshift({hideIfDisabled:!0,key:"FlatModifier",label:"PF2E.WeaponSpecialization",predicate:[{gte:["item:proficiency:rank",2]}],selector:"strike-damage",slug:"weapon-specialization",value:2},{key:"AdjustModifier",mode:"upgrade",predicate:["item:proficiency:rank:3"],priority:0,selector:"strike-damage",slug:"weapon-specialization",value:3},{key:"AdjustModifier",mode:"upgrade",predicate:["item:proficiency:rank:4"],priority:0,selector:"strike-damage",slug:"weapon-specialization",value:4}))}}class Migration858FakeWeaponSpecialization extends MigrationBase{static{__name(this,"Migration858FakeWeaponSpecialization")}static{__name2(this,"Migration858FakeWeaponSpecialization")}static version=.858;#testHasOption(source2){return source2.system.rules.some(r2=>r2.key==="RollOption"&&"option"in r2&&["feature:greater-weapon-specialization","feature:weapon-specialization"].includes(String(r2.option)))}async updateItem(source2){if(source2.type!=="feat")return;const slug=source2.system.slug??sluggify(source2.name);slug==="greater-weapon-specialization-barbarian"&&!this.#testHasOption(source2)?source2.system.rules.push({domain:"all",key:"RollOption",option:"feature:greater-weapon-specialization"}):slug==="psychic-weapon-specialization"&&!this.#testHasOption(source2)&&source2.system.rules.push({domain:"all",key:"RollOption",option:"feature:weapon-specialization"})}}class Migration859MaterialTypeGrade extends MigrationBase{static{__name(this,"Migration859MaterialTypeGrade")}static{__name2(this,"Migration859MaterialTypeGrade")}static version=.859;#PRECIOUS_MATERIAL_TYPES=new Set([...PRECIOUS_MATERIAL_TYPES].filter(t2=>t2.replace("duskwood","darkwood").replace("dawnsilver","mithral")));#hasOldMaterialData(source2){return"preciousMaterial"in source2.system&&e$2(source2.system.preciousMaterial)&&"preciousMaterialGrade"in source2.system&&e$2(source2.system.preciousMaterialGrade)}async updateItem(source2){if(itemIsOfType(source2,"physical")&&this.#hasOldMaterialData(source2)){const{preciousMaterial,preciousMaterialGrade}=source2.system,type2=typeof preciousMaterial?.value=="string"&&this.#PRECIOUS_MATERIAL_TYPES.has(preciousMaterial.value)?preciousMaterial.value:null,grade=setHasElement(PRECIOUS_MATERIAL_GRADES,preciousMaterialGrade?.value)?preciousMaterialGrade.value:null;source2.system.material={type:type2,grade},"game"in globalThis?(source2.system["-=preciousMaterial"]=null,source2.system["-=preciousMaterialGrade"]=null):(delete source2.system.preciousMaterial,delete source2.system.preciousMaterialGrade)}}}class Migration860RMGroup extends MigrationBase{static{__name(this,"Migration860RMGroup")}static{__name2(this,"Migration860RMGroup")}static version=.86;async updateItem(source2){itemIsOfType(source2,"armor","condition","weapon")||!("group"in source2.system)||("game"in globalThis?source2.system["-=group"]=null:delete source2.system.group)}}class Migration861AuraColorsToAppearance extends MigrationBase{static{__name(this,"Migration861AuraColorsToAppearance")}static{__name2(this,"Migration861AuraColorsToAppearance")}static version=.861;async updateItem(source2){const auraREs=source2.system.rules.filter(r2=>r2.key==="Aura"&&"colors"in r2&&e$2(r2.colors));for(const rule of auraREs)rule.appearance={},typeof rule.colors?.border=="string"&&(rule.appearance.border={color:rule.colors.border}),typeof rule.colors?.fill=="string"&&(rule.appearance.highlight={color:rule.colors.fill}),delete rule.colors}}class Migration862SpecificMagicArmor extends MigrationBase{static{__name(this,"Migration862SpecificMagicArmor")}static{__name2(this,"Migration862SpecificMagicArmor")}static version=.862;#resilientRuneValues=new Map([["",0],["resilient",1],["greaterResilient",3],["majorResilient",3]]);async updateItem(source2){if(source2.type!=="armor"||source2.system.category==="shield")return;switch(source2.system.slug){case"power-suit":source2.system.baseItem="power-suit";break;case"subterfuge-suit":source2.system.baseItem="subterfuge-suit";break;case"clothing-explorers":source2.system.slug="explorers-clothing",source2.name.endsWith("Clothing (Explorer's)")&&(source2.name="Explorer's Clothing")}source2.system.slug==="power-suit"&&(source2.system.baseItem??="power-suit"),source2.system.slug==="subterfuge-suit"&&(source2.system.baseItem??="subterfuge-suit");const isMagical=!!("potencyRune"in source2.system&&e$2(source2.system.potencyRune)&&source2.system.potencyRune.value||"resiliencyRune"in source2.system&&e$2(source2.system.resiliencyRune)&&source2.system.resiliencyRune.value);if(!!(source2.system.baseItem&&source2.system.slug)&&isMagical&&source2.system.baseItem!==source2.system.slug){const system2=source2.system;system2.specific??={value:!0,material:source2.system.material??null,runes:{potency:"potencyRune"in source2.system&&e$2(source2.system.potencyRune)&&source2.system.potencyRune.value?Number(source2.system.potencyRune?.value)||1:0,resilient:"resiliencyRune"in source2.system&&e$2(source2.system.resiliencyRune)&&source2.system.resiliencyRune.value?this.#resilientRuneValues.get(String(source2.system.resiliencyRune?.value??""))||1:0,property:[]}}}}}class Migration863FixMisspelledOrganaizationsProperty extends MigrationBase{static{__name(this,"Migration863FixMisspelledOrganaizationsProperty")}static{__name2(this,"Migration863FixMisspelledOrganaizationsProperty")}static version=.863;async updateActor(source2){if(source2.type!=="character")return;const biography=source2.system.details.biography;biography.organaizations!==void 0&&(biography.organizations=biography.organaizations,delete biography.organaizations,biography["-=organaizations"]=null)}}class Migration864RemoveWeaponMAP extends MigrationBase{static{__name(this,"Migration864RemoveWeaponMAP")}static{__name2(this,"Migration864RemoveWeaponMAP")}static version=.864;async updateItem(source2){if(source2.type==="weapon"&&e$2(source2.system.MAP)){const mapValue=-1*Number(source2.system.MAP.value);if(mapValue<0&&mapValue!==-5){const rule={key:"MultipleAttackPenalty",selector:"{item|id}-attack",value:mapValue};source2.system.rules.push(rule)}"game"in globalThis?source2.system["-=MAP"]=null:delete source2.system.MAP}}}class Migration865VitalityVoid extends MigrationBase{static{__name(this,"Migration865VitalityVoid")}static{__name2(this,"Migration865VitalityVoid")}static version=.865;#replaceStrings(data){return recursiveReplaceString(data,s=>s.replace(/^positive$/,"vitality").replace(/^negative$/,"void").replace(/^versatile-positive$/,"versatile-vitality").replace(/^versatile-negative$/,"versatile-void").replace(/\bpositive\]/g,"vitality]").replace(/\bnegative\]/g,"void]").replace(/\[positive\b/g,"[vitality").replace(/\[negative\b/g,"[void").replace(/\bRollFlavor\.positive\b/g,"RollFlavor.vitality").replace(/\bRollFlavor\.negative\b/g,"RollFlavor.void").replace(/\bTraitPositive\b/g,"TraitVitality").replace(/\bTraitNegative\b/g,"TraitVoid").replace(/\bTraitVersatilePositive\b/g,"TraitVersatileVitality").replace(/\bTraitVersatileNegative\b/g,"TraitVersatileVoid").replace(/\bnegative negative damage\b/,"void damage"))}async updateActor(source2){source2.system=this.#replaceStrings(source2.system),source2.flags=this.#replaceStrings(source2.flags)}async updateItem(source2){source2.system=this.#replaceStrings(source2.system),source2.flags=this.#replaceStrings(source2.flags)}}class Migration866LinkToActorSizeAgain extends MigrationBase{static{__name(this,"Migration866LinkToActorSizeAgain")}static{__name2(this,"Migration866LinkToActorSizeAgain")}static version=.866;async updateActor(actorSource){SIZE_LINKABLE_ACTOR_TYPES.has(actorSource.type)||actorSource.prototypeToken.flags.pf2e&&(actorSource.prototypeToken.flags.pf2e.linkToActorSize=!1,actorSource.prototypeToken.flags.pf2e.autoscale=!1)}async updateToken(tokenSource,actor){!actor||SIZE_LINKABLE_ACTOR_TYPES.has(actor.type)||foundry.utils.mergeObject(tokenSource.flags,{pf2e:{linkToActorSize:!1,autoscale:!1}})}}class Migration867DamageRollDomainFix extends MigrationBase{static{__name(this,"Migration867DamageRollDomainFix")}static{__name2(this,"Migration867DamageRollDomainFix")}static version=.867;async updateItem(source2){for(const rule of source2.system.rules??[])"domain"in rule&&rule.domain==="damage-roll"&&(rule.domain="damage")}}class Migration868StrikeRERange extends MigrationBase{static{__name(this,"Migration868StrikeRERange")}static{__name2(this,"Migration868StrikeRERange")}static version=.868;async updateItem(source2){const strikeREs=source2.system.rules.filter(r2=>r2.key==="Strike");for(const rule of strikeREs)typeof rule.maxRange=="number"&&rule.range!==rule.maxRange/6?rule.range={max:rule.maxRange}:typeof rule.range=="number"&&(rule.range={increment:rule.range}),delete rule.maxRange}}class Migration869RefreshMightyBulwark extends MigrationBase{static{__name(this,"Migration869RefreshMightyBulwark")}static{__name2(this,"Migration869RefreshMightyBulwark")}static version=.869;get#mightyBulwarkRules(){return[{key:"FlatModifier",predicate:["armor:trait:bulwark"],selector:"reflex",value:4},{key:"AdjustModifier",predicate:["armor:trait:bulwark"],selector:"reflex",slug:"dex",suppress:!0},{key:"AdjustModifier",selector:"reflex",slug:"bulwark",suppress:!0}]}async updateItem(source2){if(source2.type==="feat"&&source2.system.slug==="mighty-bulwark")source2.system.rules=this.#mightyBulwarkRules;else for(const rule of source2.system.rules)"option"in rule&&rule.option==="self:armor:strength-requirement-met"&&(rule.option="armor:strength-requirement-met")}}const ARMOR_CATEGORIES=["unarmored","light","medium","heavy","light-barding","heavy-barding"],ARMOR_PROPERTY_RUNE_TYPES=new Set(["acidResistant","advancing","aimAiding","antimagic","assisting","bitter","coldResistant","deathless","electricityResistant","energyAdaptive","ethereal","fireResistant","fortification","glamered","gliding","greaterAcidResistant","greaterAdvancing","greaterColdResistant","greaterDread","greaterElectricityResistant","greaterFireResistant","greaterFortification","greaterInvisibility","greaterQuenching","greaterReady","greaterShadow","greaterSlick","greaterStanching","greaterSwallowSpike","greaterWinged","immovable","implacable","invisibility","lesserDread","magnetizing","majorQuenching","majorShadow","majorSlick","majorStanching","majorSwallowSpike","malleable","misleading","moderateDread","portable","quenching","raiment","ready","rockBraced","shadow","sinisterKnight","sizeChanging","slick","spellwatch","soaring","stanching","swallowSpike","trueQuenching","trueStanching","winged"]);class Migration870MartialToProficiencies extends MigrationBase{static{__name(this,"Migration870MartialToProficiencies")}static{__name2(this,"Migration870MartialToProficiencies")}static version=.87;#defensePathPattern=new RegExp(String.raw`system\.martial\.(?:${Array.from(ARMOR_CATEGORIES).join("|")})\.`);async updateActor(source2){if(source2.type!=="character")return;const systemSource=source2.system,oldData=e$2(systemSource.martial)&&!e$4(systemSource.martial)?systemSource.martial:{};for(const[key,data]of Object.entries(oldData)){if(!data.rank||["simple","unarmed","unarmored"].includes(key)&&data.rank===1)continue;systemSource.proficiencies??={};const proficiencies=systemSource.proficiencies;tupleHasValue(ARMOR_CATEGORIES,key)?(proficiencies.defenses??={},proficiencies.defenses[key]={rank:data.rank}):(systemSource.proficiencies.attacks??={},systemSource.proficiencies.attacks[key]={custom:data.custom,rank:data.rank})}"game"in globalThis&&"martial"in systemSource?systemSource["-=martial"]=null:delete systemSource.martial}async updateItem(source2){source2.system.rules=source2.system.rules.map(r2=>recursiveReplaceString(r2,text2=>{const key=this.#defensePathPattern.test(text2)?"defenses":"attacks";return text2.replace(/\bsystem\.martial\./g,`system.proficiencies.${key}.`)}))}}class Migration871MigrateRollActionMacroParams extends MigrationBase{static{__name(this,"Migration871MigrateRollActionMacroParams")}static{__name2(this,"Migration871MigrateRollActionMacroParams")}static version=.871;async updateMacro(source2){if(source2.type!=="script")return;const matches=source2.command.matchAll(/game\.pf2e\.rollActionMacro\("(.+)".*"(.+)"\)/gm);for(const match of matches){if(match.length<3)continue;const[current,itemId,slug]=match;source2.command=source2.command.replace(current,`game.pf2e.rollActionMacro({ itemId: "${itemId}", slug: "${slug}" })`)}}}class Migration872MoveSchemaProperty extends MigrationBase{static{__name(this,"Migration872MoveSchemaProperty")}static{__name2(this,"Migration872MoveSchemaProperty")}static version=.872;#mvSchema(system2){const migrations=system2._migration??={version:null,previous:null};"schema"in system2&&(system2["-=schema"]=null,e$2(system2.schema)&&typeof system2.schema.version=="number"&&(migrations.version=system2.schema.version))}async updateActor(source2){this.#mvSchema(source2.system)}async updateItem(source2){this.#mvSchema(source2.system)}}class Migration873RemoveBonusBulkLimit extends MigrationBase{static{__name(this,"Migration873RemoveBonusBulkLimit")}static{__name2(this,"Migration873RemoveBonusBulkLimit")}static version=.873;async updateActor(source2){if(source2.type!=="character"&&source2.type!=="npc")return;const data=source2.system;"bonusLimitBulk"in data.attributes&&(delete data.attributes.bonusLimitBulk,data.attributes["-=bonusLimitBulk"]=null),"bonusEncumbranceBulk"in data.attributes&&(delete data.attributes.bonusEncumbranceBulk,data.attributes["-=bonusEncumbranceBulk"]=null)}async updateItem(source2){source2.system.rules=recursiveReplaceString(source2.system.rules,text2=>text2.replace(/^system\.attributes\.bonusEncumbranceBulk$/,"inventory.bulk.encumberedAfterAddend").replace(/^system\.attributes\.bonusLimitBulk$/,"inventory.bulk.maxAddend"))}}class Migration874MoveStaminaStuff extends MigrationBase{static{__name(this,"Migration874MoveStaminaStuff")}static{__name2(this,"Migration874MoveStaminaStuff")}static version=.874;async updateActor(source2){if(source2.type!=="character")return;const variantEnabled="game"in globalThis&&game.settings.storage.get("world").find(s=>s.key==="pf2e.staminaVariant")?.value!=='"0"'&&game.settings.get("pf2e","staminaVariant"),systemSource=source2.system;if(e$2(systemSource.attributes.sp)){const value=Math.floor(Number(systemSource.attributes.sp.value))||0;value>0&&variantEnabled&&(systemSource.attributes.hp.sp={value}),delete systemSource.attributes.sp,systemSource.attributes["-=sp"]=null}if(e$2(systemSource.attributes.resolve)){const value=Math.floor(Number(systemSource.attributes.resolve.value))||0;value>0&&variantEnabled&&(systemSource.resources.resolve={value}),delete systemSource.attributes.resolve,systemSource.attributes["-=resolve"]=null}}async updateItem(source2){source2.system.rules=recursiveReplaceString(source2.system.rules,text2=>text2.replace(/^system\.attributes\.sp\.max$/,"system.attributes.hp.sp.max").replace(/^system\.attributes\.resolve.max$/,"system.resources.resolve.max"))}async migrate(){const staminaVariant=game.settings.storage.get("world").find(s=>s.key==="pf2e.staminaVariant");["1",'"1"'].includes(staminaVariant?._source.value??"")?await game.settings.set("pf2e","staminaVariant",!0):staminaVariant&&await game.settings.set("pf2e","staminaVariant",!1),game.settings.storage.get("world").find(s=>s.key==="pf2e.proficiencyVariant")?._source.value==='"ProficiencyWithoutLevel"'?await game.settings.set("pf2e","proficiencyVariant",!0):staminaVariant&&await game.settings.set("pf2e","proficiencyVariant",!1)}}class Migration875SetInnovationIdEarly extends MigrationBase{static{__name(this,"Migration875SetInnovationIdEarly")}static{__name2(this,"Migration875SetInnovationIdEarly")}static version=.875;async updateItem(source2){if(source2.type!=="feat"||!["armor-innovation","weapon-innovation"].includes(source2.system.slug??""))return;const aeLike=source2.system.rules.find(r2=>r2.key==="ActiveEffectLike"&&r2.path==="flags.pf2e.innovationId");aeLike&&(aeLike.priority=5)}}class Migration876FeatLevelTaken extends MigrationBase{static{__name(this,"Migration876FeatLevelTaken")}static{__name2(this,"Migration876FeatLevelTaken")}static version=.876;async updateItem(source2,actorSource){if(source2.type!=="feat"||!setHasElement(FEAT_CATEGORIES,source2.system.category))return;const location=source2.system.location??"",background=actorSource?.items.find(i=>i.type==="background");if(location===background?._id)source2.system.level.taken=1;else{const levelString=/^.+-(\d+)$/.exec(location)?.[1]??"NaN";levelString&&(source2.system.level.taken=Number(levelString)||void 0)}const{category,traits}=source2.system;category==="skill"&&!traits.value.includes("skill")?traits.value.push("skill"):category==="general"&&!traits.value.includes("general")&&traits.value.push("general"),traits.value.sort()}}class Migration877PublicationData extends MigrationBase{static{__name(this,"Migration877PublicationData")}static{__name2(this,"Migration877PublicationData")}static version=.877;#setPublicationData(systemSource,oldData){const title=typeof oldData.value=="string"?oldData.value.trim():"",authors=typeof oldData.author=="string"?oldData.author.trim():"",license=title==="Pathfinder Player Core"?"ORC":"OGL",remaster=["Pathfinder Player Core","Pathfinder Rage of Elements"].includes(title),publication={title,authors,license,remaster};e$2(systemSource.details)?systemSource.details.publication=publication:systemSource.publication=publication}async updateActor(source2){source2.type!=="hazard"&&source2.type!=="npc"&&source2.type!=="vehicle"||(source2.type==="vehicle"&&e$2(source2.system.source)?(this.#setPublicationData(source2.system,source2.system.source),"game"in globalThis?source2.system["-=source"]=null:delete source2.system.source):(source2.type==="hazard"||source2.type==="npc")&&e$2(source2.system.details.source)&&(this.#setPublicationData(source2.system,source2.system.details.source),"game"in globalThis?source2.system.details["-=source"]=null:delete source2.system.details.source))}async updateItem(source2){if("details"in source2.system&&e$2(source2.system.details)){const oldDataInWrongPlace=source2.system.details.source;e$2(oldDataInWrongPlace)&&typeof oldDataInWrongPlace.value=="string"&&(source2.system.source={value:oldDataInWrongPlace.value.trim()}),"game"in globalThis?source2.system["-=details"]=null:delete source2.system.details}e$2(source2.system.source)?(this.#setPublicationData(source2.system,source2.system.source),"game"in globalThis?source2.system["-=source"]=null:delete source2.system.source):!source2.system.publication&&!("game"in globalThis)&&this.#setPublicationData(source2.system,{})}}class Migration878TakeABreather extends MigrationBase{static{__name(this,"Migration878TakeABreather")}static{__name2(this,"Migration878TakeABreather")}static version=.878;async updateMacro(source2){source2.type==="script"&&source2.command.includes("console.log(resolve, sp)")&&(source2.command="game.pf2e.actions.takeABreather();")}}class Migration879DeviseAStratagemAndFriends extends MigrationBase{static{__name(this,"Migration879DeviseAStratagemAndFriends")}static{__name2(this,"Migration879DeviseAStratagemAndFriends")}static version=.879;async updateItem(source2){if(source2.type==="action"&&source2.system.slug==="devise-a-stratagem"){const rules=[{domain:"all",key:"RollOption",option:"target:mark:devise-a-stratagem",toggleable:"totm"},{ability:"int",key:"FlatModifier",predicate:["class:investigator","target:mark:devise-a-stratagem",{or:["item:trait:agile","item:trait:finesse",{and:["item:ranged",{not:"item:thrown-melee"}]},"item:base:sap"]}],selector:"strike-attack-roll",type:"ability"}];source2.system.rules=rules}else if(source2.type==="feat"&&source2.system.slug==="athletic-strategist"){const rule={ability:"int",key:"FlatModifier",predicate:["class:investigator","target:mark:devise-a-stratagem",{or:["action:disarm","action:grapple","action:shove","action:trip"]},{or:["item:trait:agile","item:trait:finesse",{and:["item:ranged",{not:"item:thrown-melee"}]},"item:base:sap",{and:["feat:takedown-expert","item:group:club","item:hands-held:1"]}]}],selector:"athletics",type:"ability"};source2.system.rules=[rule]}else if(source2.type==="feat"&&source2.system.slug==="ongoing-strategy"){const rule={damageCategory:"precision",key:"FlatModifier",predicate:["class:investigator",{not:"check:substitution:devise-a-stratagem"},{or:["item:trait:agile","item:trait:finesse",{and:["item:ranged",{not:"item:thrown-melee"}]},"item:base:sap",{and:["feat:takedown-expert","item:group:club","item:hands-held:1"]}]}],selector:"strike-damage",value:{brackets:[{end:4,value:1},{end:8,start:5,value:2},{end:12,start:9,value:3},{end:16,start:13,value:4},{start:17,value:5}]}};source2.system.rules=[rule]}else if(source2.type==="feat"&&source2.system.slug==="shared-stratagem"){const rule={key:"Note",predicate:["target:mark:devise-a-stratagem"],selector:"strike-attack-roll",text:"PF2E.SpecificRule.Investigator.SharedStratagem.Note",title:"{item|name}",outcome:["success","criticalSuccess"]};source2.system.rules=[rule]}else if(source2.type==="feat"&&source2.system.slug==="takedown-expert"){const rule={ability:"int",key:"FlatModifier",predicate:["class:investigator","target:mark:devise-a-stratagem","item:hands-held:1"],selector:"club-group-attack-roll",type:"ability"};source2.system.rules=[rule]}}}class UserPF2e extends User{static{__name(this,"UserPF2e")}static{__name2(this,"UserPF2e")}prepareData(){super.prepareData(),canvas.ready&&canvas.tokens.controlled.length>0&&game.pf2e.effectPanel.refresh()}prepareBaseData(){super.prepareBaseData(),this.flags=foundry.utils.mergeObject({pf2e:{settings:{showEffectPanel:!0,showCheckDialogs:!0,showDamageDialogs:!0,searchPackContents:!1,monochromeDarkvision:!0}}},this.flags)}get settings(){return this.flags.pf2e.settings}getActiveTokens(){return!canvas.ready||canvas.tokens.controlled.length===0?[game.user.character?.getActiveTokens(!0,!0).shift()].filter(e$1):canvas.tokens.controlled.filter(t2=>t2.isOwner).map(t2=>t2.document)}clearTargets(){this._onUpdateTokenTargets()}_onUpdate(changed,options,userId){if(super._onUpdate(changed,options,userId),game.user.id!==userId)return;const keys=Object.keys(foundry.utils.flattenObject(changed));keys.includes("flags.pf2e.settings.showEffectPanel")&&game.pf2e.effectPanel.refresh(),keys.includes("flags.pf2e.settings.monochromeDarkvision")&&canvas.ready&&(canvas.scene?.reset(),canvas.perception.update({initializeVision:!0,refreshLighting:!0}))}}class Migration880SplitShowDialogsSettings extends MigrationBase{static{__name(this,"Migration880SplitShowDialogsSettings")}static{__name2(this,"Migration880SplitShowDialogsSettings")}static version=.88;async migrate(){const userUpdates=game.users.contents.flatMap(user=>{const settings=user._source.flags.pf2e?.settings;return typeof settings?.showRollDialogs=="boolean"?(settings.showCheckDialogs=settings.showRollDialogs,settings.showDamageDialogs=settings.showRollDialogs,settings["-=showRollDialogs"]=null,{_id:user.id,"flags.pf2e.settings":settings}):[]});await UserPF2e.updateDocuments(userUpdates)}}class Migration881NoHBPrefix extends MigrationBase{static{__name(this,"Migration881NoHBPrefix")}static{__name2(this,"Migration881NoHBPrefix")}static version=.881;async updateActor(source2){const traits=source2.system.traits;if(traits?.value&&Array.isArray(traits.value)&&(traits.value=traits.value.filter(t2=>typeof t2=="string").map(t2=>t2.replace(/^hb_/,""))),source2.type==="character"&&source2.system.proficiencies?.attacks){const attacks=source2.system.proficiencies.attacks;for(const[key,value]of Object.entries(attacks))key.includes("hb_")&&(attacks[key.replace("hb_","")]=value,attacks[`-=${key}`]=null)}}async updateItem(source2){source2.system=recursiveReplaceString(source2.system,t2=>t2.replace(/^hb_/,""))}}class Migration882SpellDataReorganization extends MigrationBase{static{__name(this,"Migration882SpellDataReorganization")}static{__name2(this,"Migration882SpellDataReorganization")}static version=.882;#SCHOOL_TRAITS=new Set(["abjuration","conjuration","divination","enchantment","evocation","necromancy","transmutation"]);#DAMAGE_TYPES=new Set([...DAMAGE_TYPES,"good","evil","lawful","chaotic"]);#ensureTraitsPresence(system2){return foundry.utils.mergeObject({value:[]},system2.traits??{value:[]})}#migrateRule(rule){if("type"in rule){if(typeof rule.type=="string"&&this.#SCHOOL_TRAITS.has(rule.type))return[];Array.isArray(rule.type)&&(rule.type=rule.type.filter(t2=>!this.#SCHOOL_TRAITS.has(t2)))}return"traits"in rule&&Array.isArray(rule.traits)&&(rule.traits=rule.traits.filter(t2=>!this.#SCHOOL_TRAITS.has(t2))),Array.isArray(rule.predicate)&&(rule.predicate=rule.predicate.filter(s=>!this.#SCHOOL_TRAITS.has(s))),rule}async updateActor(source2){const traits=source2.system.traits??{value:[]};Array.isArray(traits.value)&&(traits.value=n(traits.value.filter(t2=>!this.#SCHOOL_TRAITS.has(t2))).filter(e$1).sort()),source2.system.attributes&&(source2.system.attributes.immunities=source2.system.attributes.immunities?.filter(i=>!this.#SCHOOL_TRAITS.has(i.type)),source2.system.attributes.weaknesses=source2.system.attributes.weaknesses?.filter(i=>!this.#SCHOOL_TRAITS.has(i.type)),source2.system.attributes.resistances=source2.system.attributes.resistances?.filter(i=>!this.#SCHOOL_TRAITS.has(i.type)))}async updateItem(source2,actorSource,{topLevel=!0}={}){topLevel&&source2.system?.rules&&(source2.system.rules=source2.system.rules.flatMap(r2=>r2&&this.#migrateRule(r2)));const traits=source2.system?.traits??{value:[]};if(Array.isArray(traits.value)&&(traits.value=n(traits.value.filter(t2=>!!t2&&!this.#SCHOOL_TRAITS.has(t2)).map(t2=>t2==="metamagic"?"spellshape":t2).sort())),source2.type!=="spell")return;const system2=source2.system??{};e$2(system2.traditions)&&Array.isArray(system2.traditions.value)&&(system2.traits=this.#ensureTraitsPresence(system2),system2.traits.traditions=[...system2.traditions.value].sort()),"traditions"in system2&&(system2["-=traditions"]=null),system2.category?.value==="focus"&&(system2.traits=this.#ensureTraitsPresence(system2)).value.push("focus"),e$2(system2.components)&&(system2.components.verbal&&(system2.traits=this.#ensureTraitsPresence(system2)).value.push("concentrate"),(system2.components.material||system2.components.somatic)&&(system2.traits=this.#ensureTraitsPresence(system2)).value.push("manipulate")),"components"in system2&&(system2["-=components"]=null),e$2(system2.materials)&&typeof system2.materials.value=="string"?system2.requirements=system2.materials.value:topLevel&&(system2.requirements||=""),"materials"in system2&&(system2["-=materials"]=null),topLevel&&(system2.duration={value:system2.duration?.value??"",sustained:e$2(system2.sustained)?!!system2.sustained.value||system2.duration?.value?.includes("sustained")||!1:system2.duration?.sustained??!1}),"sustained"in system2&&(system2["-=sustained"]=null),e$2(system2.hasCounteractCheck)?system2.counteraction=!!system2.hasCounteractCheck.value:topLevel&&(system2.counteraction??=!1),"hasCounteractCheck"in system2&&(system2["-=hasCounteractCheck"]=null),e$2(system2.save)&&typeof system2.save?.value=="string"&&tupleHasValue(SAVE_TYPES,system2.save.value)&&(system2.defense={passive:null,save:{statistic:system2.save.value,basic:!!system2.save.basic}}),topLevel&&(system2.defense??=null),"save"in system2&&(system2["-=save"]=null);const oldSpellDamage=foundry.utils.deepClone(system2.damage);if(e$2(oldSpellDamage)&&e$2(oldSpellDamage?.value)){system2.damage={};for(const[key,partial]of Object.entries(oldSpellDamage?.value)){if(topLevel&&["lay-on-hands","touch-of-corruption"].includes(source2.system?.slug??""))break;if(!e$2(partial))continue;const typeData=e$2(partial.type)?partial.type:{},damageType=this.#DAMAGE_TYPES.has(String(typeData.value))?typeData.value:topLevel?"untyped":void 0,damageCategory=tupleHasValue(DAMAGE_CATEGORIES_UNIQUE,typeData.subtype)?typeData.subtype:topLevel?null:void 0;system2.damage[key]={applyMod:typeof partial.applyMod=="boolean"?partial.applyMod:void 0,formula:typeof partial.value=="string"?partial.value:topLevel?"":void 0,type:damageType,category:damageCategory,materials:Array.isArray(typeData.categories)?typeData.categories:topLevel?[]:void 0}}const damageWithDeletions=system2.damage;for(const[key,oldValue]of Object.entries(oldSpellDamage))(key==="value"||!e$2(oldValue))&&(damageWithDeletions[`-=${key}`]=null)}if(e$2(system2.spellType)){if(system2.spellType.value==="attack"&&!system2.traits?.value?.includes("attack"))(system2.traits=this.#ensureTraitsPresence(system2)).value.push("attack");else if(system2.spellType.value==="heal")for(const[key,damagePartial]of Object.entries(system2.damage??{}))key!=="value"&&e$2(damagePartial)&&(damagePartial.kinds=["healing"]);for(const[key,damagePartial]of Object.entries(system2.damage??{}))key!=="value"&&e$2(damagePartial)&&(damagePartial.kinds??=["damage"])}if("spellType"in system2&&(system2["-=spellType"]=null),e$2(system2.category)&&"value"in system2.category&&system2.category.value==="ritual"){const primaryCheck=e$2(system2.primarycheck)&&typeof system2.primarycheck.value=="string"?system2.primarycheck.value.trim():"",secondaryChecks=e$2(system2.secondarycheck)&&typeof system2.secondarycheck.value=="string"?system2.secondarycheck.value.trim():"",secondaryCasters=e$2(system2.secondarycasters)&&Number(system2.secondarycasters.value)||0;system2.ritual={primary:{check:primaryCheck},secondary:{checks:secondaryChecks,casters:secondaryCasters}}}"category"in system2&&(system2["-=category"]=null),"primarycheck"in system2&&(system2["-=primarycheck"]=null),"secondarycheck"in system2&&(system2["-=secondarycheck"]=null),"secondarycasters"in system2&&(system2["-=secondarycasters"]=null);const oldKeys=["ability","areatype","damageType","prepared","rarity","spellCategorie","usage"];for(const key of oldKeys)key in system2&&(system2[`-=${key}`]=null);if(e$2(system2.heightening)&&system2.heightening.type==="fixed")for(const spellPartial of Object.values(system2.heightening.levels??{}))await this.updateItem({name:source2.name,type:"spell",system:spellPartial},actorSource,{topLevel:!1});for(const overlay of Object.values(system2?.overlays??{}))overlay?.overlayType==="override"&&await this.updateItem({name:overlay.name??source2.name,type:"spell",system:overlay.system??{}},actorSource,{topLevel:!1})}}class Migration883BanishAlignment extends MigrationBase{static{__name(this,"Migration883BanishAlignment")}static{__name2(this,"Migration883BanishAlignment")}static version=.883;#ALIGNMENTS=["good","evil","lawful","chaotic"];#migrateRule(rule){return"traits"in rule&&Array.isArray(rule.traits)&&(rule.traits=rule.traits.filter(t2=>!this.#ALIGNMENTS.includes(t2))),Array.isArray(rule.predicate)&&(rule.predicate=rule.predicate.filter(s=>!this.#ALIGNMENTS.includes(s))),rule}async updateActor(source2){const details=source2.system.details;if(e$2(details.alignment)&&typeof details.alignment.value=="string"){const traits=source2.system.traits??{value:[]};switch(details.alignment.value){case"LG":traits.value.push("lawful","good");break;case"NG":traits.value.push("good");break;case"CG":traits.value.push("chaotic","good");break;case"LE":traits.value.push("lawful","evil");break;case"NE":traits.value.push("evil");break;case"CE":traits.value.push("chaotic","evil");break;case"LN":traits.value.push("lawful");break;case"CN":traits.value.push("chaotic");break}if(source2.type==="npc"){if(traits.value.includes("celestial")&&traits.value.includes("good")){traits.value.push("holy");for(const item of source2.items.filter(i=>i.type==="melee"))item.system.traits.value.includes("holy")||(item.system.traits.value.push("holy"),item.system.traits.value.sort())}else if(["fiend","rakshasa","undead"].some(t2=>traits.value.includes(t2))&&traits.value.includes("evil")&&(traits.value.push("unholy"),traits.value.includes("fiend")||traits.value.includes("rakshasa")))for(const item of source2.items.filter(i=>i.type==="melee"))item.system.traits.value.includes("unholy")||(item.system.traits.value.push("unholy"),item.system.traits.value.sort())}traits.value=n(traits.value.sort())}"alignment"in details&&(details["-=alignment"]=null)}async updateItem(source2){if(source2.system.rules=source2.system.rules.flatMap(r2=>this.#migrateRule(r2)),source2.type==="deity"){const system2=source2.system;if("alignment"in system2){const{alignment}=system2;if(e$2(alignment)&&"follower"in alignment&&Array.isArray(alignment.follower)){const followers=alignment.follower.filter(a=>typeof a=="string"),modal=system2.category==="philosophy"?null:["asmodeus","iomedae","rovagug","urgathoa"].includes(system2.slug??"")?"must":"can",what=modal===null||system2.slug==="pharasma"?null:system2.slug==="gorum"?["holy","unholy"]:followers.some(f=>f.includes("G"))?followers.some(f=>f.includes("E"))?["holy","unholy"]:["holy"]:followers.some(f=>f.includes("E"))?["unholy"]:null;system2.sanctification=modal===null||what===null?null:{modal,what}}system2["-=alignment"]=null}"ability"in system2&&(system2.attribute=Array.isArray(system2.ability)?n(system2.ability.filter(a=>setHasElement(ATTRIBUTE_ABBREVIATIONS,a)).sort()):[],system2["-=ability"]=null)}else if(source2.type==="feat"&&["the-tenets-of-evil","the-tenets-of-good"].includes(source2.system.slug??"")){const rule={key:"ActorTraits",add:source2.system.slug==="the-tenets-of-good"?["holy"]:["unholy"]};source2.system.rules=[rule]}}}class Migration884UnifiedSpellcasting extends MigrationBase{static{__name(this,"Migration884UnifiedSpellcasting")}static{__name2(this,"Migration884UnifiedSpellcasting")}static version=.884;async updateActor(source2){if(source2.type!=="character")return;const profs=source2.system.proficiencies??null;profs?.traditions&&(profs["-=traditions"]=null)}async updateItem(source2){source2.system.rules=recursiveReplaceString(source2.system.rules,value=>value.replace(/^system\.proficiencies\.traditions\.(.*)\.(\w+)$/,"system.proficiencies.spellcasting.$2"))}}class Migration885ConvertAlignmentDamage extends MigrationBase{static{__name(this,"Migration885ConvertAlignmentDamage")}static{__name2(this,"Migration885ConvertAlignmentDamage")}static version=.885;#ALIGNMENTS=new Set(["good","evil","lawful","chaotic"]);#ALIGNMENT_VERSATILE_TRAITS=Array.from(this.#ALIGNMENTS).map(dt=>`versatile-${dt}`);#migrateRule(rule){if("type"in rule){if(rule.key==="Immunity"&&typeof rule.type=="string"&&this.#ALIGNMENTS.has(rule.type))return[];if(["Weakness","Resistance"].includes(String(rule.key))&&typeof rule.type=="string"){if(["lawful","chaotic"].includes(rule.type))return[];Array.isArray(rule.predicate)&&(rule.predicate=rule.predicate.filter(s=>typeof s!="string"||!/^self:trait:(?:good|evil|lawful|chaotic)$/.test(s))),rule.type==="good"&&(rule.type="holy"),rule.type==="evil"&&(rule.type="unholy")}else Array.isArray(rule.type)&&(rule.type=rule.type.flatMap(t2=>["lawful","chaotic"].includes(t2)?[]:t2==="good"?"holy":t2==="evil"?"unholy":t2))}return"deactivatedBy"in rule&&Array.isArray(rule.deactivatedBy)&&(rule.deactivatedBy=rule.deactivatedBy.flatMap(db=>["lawful","chaotic"].includes(db)?[]:db==="good"?"holy":db==="evil"?"unholy":db)),"damageType"in rule&&typeof rule.damageType=="string"&&(rule.damageType=this.#ALIGNMENTS.has(rule.damageType)?"spirit":rule.damageType),rule}async updateActor(source2){const traits=source2.type==="character"?{value:[]}:source2.system.traits??{value:[]},iwrKeys=["immunities","weaknesses","resistances"],iwr=t$3(source2.system.attributes??{immunities:void 0,weaknesses:void 0,resistances:void 0},iwrKeys);for(const key of iwrKeys){iwr[key]=iwr[key]?.filter(i=>!["chaotic","lawful"].includes(i.type));for(const obj of[...iwr[key]??[]])obj.type=obj.type.replace("good","holy").replace("evil","unholy"),obj.exceptions=obj.exceptions?.filter(e2=>e$2(e2)||typeof e2=="string"&&!["chaotic","lawful"].includes(e2)).map(e2=>e2==="evil"?"unholy":e2==="good"?"holy":e2),obj.type==="holy"?(traits.value.push(key==="immunities"?"holy":"unholy"),key==="immunities"&&iwr.immunities?.splice(iwr.immunities.indexOf(obj),1)):obj.type==="unholy"&&(traits.value.push(key==="immunities"?"unholy":"holy"),key==="immunities"&&iwr.immunities?.splice(iwr.immunities.indexOf(obj),1))}source2.system.attributes&&=foundry.utils.mergeObject(source2.system.attributes,iwr),traits.value=n(traits.value.sort()),traits.value.includes("holy")&&traits.value.includes("unholy")&&(traits.value=traits.value.filter(t2=>!["holy","unholy"].includes(t2)))}async updateItem(source2,actorSource){if(source2.system.rules=source2.system.rules.flatMap(r2=>this.#migrateRule(r2)),source2.type==="weapon"){const traits=source2.system.traits;traits.value=traits.value.map(t2=>this.#ALIGNMENT_VERSATILE_TRAITS.includes(t2)?"versatile-spirit":t2).filter(e$1),this.#ALIGNMENTS.has(source2.system.damage.damageType)&&(source2.system.damage.damageType="spirit"),traits.value=traits.value.map(t2=>t2==="sanctified"?traits.value.includes("good")?"holy":"unholy":t2),traits.value=n(traits.value.sort())}else if(source2.type==="melee"){const traits=source2.system.traits,actorTraits=actorSource?.system.traits??{value:[]};traits.value=traits.value.map(t2=>this.#ALIGNMENT_VERSATILE_TRAITS.includes(t2)?"versatile-spirit":t2).filter(e$1),traits.value.some(t2=>t2==="good")?(traits.value.push("holy"),actorTraits.value.push("holy")):traits.value.some(t2=>t2==="evil")&&(traits.value.push("unholy"),actorTraits.value.push("unholy"));const partials=source2.system.damageRolls;for(const[key,partial]of Object.entries(partials)){if(!e$2(partial))continue;const damageType=partial.damageType;["chaotic","lawful"].includes(damageType)?partial.damageType="spirit":damageType==="good"?(actorTraits.value.push("holy"),/^\d+$/.test(partial.damage)?partials[`-=${key}`]=null:partial.damageType="spirit"):damageType==="evil"&&(traits.value.push("unholy"),/^\d+$/.test(partial.damage)?partials[`-=${key}`]=null:partial.damageType="spirit")}traits.value=n(traits.value.sort()),actorTraits.value=n(actorTraits.value.sort())}else if(source2.type==="spell"){const damage=Object.values(source2.system.damage).filter(d=>e$2(d)&&typeof d.type=="string"),traits=source2.system.traits;for(const partial of damage){const damageType=partial.type;this.#ALIGNMENTS.has(damageType)&&(partial.type="spirit"),damageType==="good"?traits.value.push("holy"):damageType==="evil"&&traits.value.push("unholy")}if(traits.value=n(traits.value.sort()),source2.system.slug==="divine-decree"){const system2=source2.system,damage2=Object.values(system2.damage).shift();e$2(damage2)&&(damage2.type="spirit"),system2["-=overlays"]=null}else try{const overlayPartials=Object.values(source2.system.overlays??{}).filter(o=>e$2(o)&&o.overlayType==="override").map(o=>(o.system??={})?.damage).flatMap(p=>e$2(p)?Object.values(p):[]).flat().filter(e$1);for(const partial of overlayPartials)this.#ALIGNMENTS.has(partial.type??"")&&(partial.type="spirit")}catch(error){error instanceof Error&&console.error(error.message)}}const{description}=source2.system;if(actorSource?.type==="npc"&&source2.type==="action"&&source2.system.actionType.value!=="passive"){const hasGoodInlineRoll=/\[good\b/.test(description.value)||/\bgood\]/.test(description.value),hasEvilInlineRoll=/\[evil\b/.test(description.value)||/\bevil\]/.test(description.value);hasGoodInlineRoll&&actorSource.system.traits.value.includes("holy")?source2.system.traits.value.push("holy"):hasEvilInlineRoll&&actorSource.system.traits.value.includes("unholy")&&source2.system.traits.value.push("unholy"),source2.system.traits.value=n(source2.system.traits.value.sort())}description.value=description.value.replace(/\[(?:good|evil|lawful|chaotic)\b/g,"[spirit").replace(/\b(?:good|evil|lawful|chaotic)\]/g,"spirit]").replace(/\b(\dd\d) (?:good|evil|lawful|chaotic)\b/g,"$1 spirit")}}class Migration886CrossbowGroup extends MigrationBase{static{__name(this,"Migration886CrossbowGroup")}static{__name2(this,"Migration886CrossbowGroup")}static version=.886;async updateItem(source2){if(source2.type==="weapon"&&source2.system.group==="bow"){const otherTags=source2.system.traits.otherTags??[],slug=source2.system.slug??sluggify(source2.name);(otherTags.includes("crossbow")||slug.includes("crossbow"))&&(source2.system.group="crossbow",otherTags.includes("crossbow")&&otherTags.splice(otherTags.indexOf("crossbow"),1))}source2.system.rules=recursiveReplaceString(source2.system.rules,s=>s.replace(/\btag:crossbow\b/,"group:crossbow"))}}class Migration887RedirectSpellLinks extends MigrationBase{static{__name(this,"Migration887RedirectSpellLinks")}static{__name2(this,"Migration887RedirectSpellLinks")}static version=.887;#spells=[{from:{_id:"kl2q6JvBZwed4B6v",name:"Dancing Lights"},to:{_id:"WBmvzNDfpwka3qT4",name:"Light"}},{from:{_id:"hkfH9Z53hPzcOwNB",name:"Veil"},to:{_id:"i35dpZFI7jZcRoBo",name:"Illusory Disguise"}},{from:{_id:"l4LFwY7iuzX6sDXr",name:"Commune with Nature"},to:{_id:"7DN13ILADW2N9Z1t",name:"Commune"}},{from:{_id:"OyFCwQuw8XRazsNr",name:"Remove Curse"},to:{_id:"SUKaxVZW2TlM8lu0",name:"Cleanse Affliction"}},{from:{_id:"RneiyehRO6f7LP44",name:"Remove Disease"},to:{_id:"SUKaxVZW2TlM8lu0",name:"Cleanse Affliction"}},{from:{_id:"c2bTWBNO1BYX4Zfg",name:"Misdirection"},to:{_id:"PRrZ7anETWPm90YY",name:"Disguise Magic"}}];async updateItem(source2){for(const spell of this.#spells){const{from,to}=spell;if("game"in globalThis){const isolatedUUID=new RegExp(String.raw`^Compendium\.pf2e\.spells-srd\.(?:Item\.)?${from._id}$`);source2.system=recursiveReplaceString(source2.system,s=>s.replace(isolatedUUID,`Compendium.pf2e.spells-srd.Item.${to._id}`));const{description}=source2.system;description.value=description.value.replace(`@UUID[Compendium.pf2e.spells-srd.Item.${from._id}]{${from.name}}`,`@UUID[Compendium.pf2e.spells-srd.Item.${to._id}]{${to.name}}`),description.gm&&=description.gm.replace(`@UUID[Compendium.pf2e.spells-srd.Item.${from._id}]{${from.name}}`,`@UUID[Compendium.pf2e.spells-srd.Item.${to._id}]{${to.name}}`)}else{const isolatedUUID=new RegExp(String.raw`^Compendium\.pf2e\.spells-srd\.Item\.${from.name}$`);source2.system=recursiveReplaceString(source2.system,s=>s.replace(isolatedUUID,`Compendium.pf2e.spells-srd.Item.${to.name}`));const{description}=source2.system;description.value=description.value.replaceAll(`@UUID[Compendium.pf2e.spells-srd.Item.${from.name}]`,`@UUID[Compendium.pf2e.spells-srd.Item.${to.name}]`),description.gm&&=description.gm.replaceAll(`@UUID[Compendium.pf2e.spells-srd.Item.${from.name}]`,`@UUID[Compendium.pf2e.spells-srd.Item.${to.name}]`)}}}async updateJournalEntry(source2){for(const spell of this.#spells){const{from,to}=spell;for(const page of source2.pages)page.text.content&&=page.text.content.replace(`@UUID[Compendium.pf2e.spells-srd.Item.${from._id}]{${from.name}}`,`@UUID[Compendium.pf2e.spells-srd.Item.${to._id}]{${to.name}}`),page.text.content&&=page.text.content.replace(`@UUID[Compendium.pf2e.spells-srd.Item.${from.name}]`,`@UUID[Compendium.pf2e.spells-srd.Item.${to.name}]`)}}}class Migration888RemasterLanguagesHeritages extends MigrationBase{static{__name(this,"Migration888RemasterLanguagesHeritages")}static{__name2(this,"Migration888RemasterLanguagesHeritages")}static version=.888;#LANGUAGE_RENAMES={abyssal:"chthonian",celestial:"empyrean",gnoll:"kholo",infernal:"diabolic"};#TRAITS_RENAMES={aasimar:"nephilim","half-elf":"aiuvarin","half-orc":"dromaar",gnoll:"gnoll",ifrit:"naari",tiefling:"nephilim"};async updateActor(source2){if(source2.type==="character"||source2.type==="npc"){const traits=source2.system.traits;if(e$2(traits)){Array.isArray(traits.value)&&(traits.value=traits.value.map(t2=>this.#TRAITS_RENAMES[t2]??t2).sort());const languages=traits.languages;e$2(languages)&&Array.isArray(languages.value)&&(languages.value=languages.value.map(l=>this.#LANGUAGE_RENAMES[l]??l).sort())}}}async updateItem(source2){if(source2.system.slug==="bloodline-genie")return;source2.system=recursiveReplaceString(source2.system,s=>this.#TRAITS_RENAMES[s]??this.#LANGUAGE_RENAMES[s]??s);const traits=source2.system.traits??{value:[]};if(traits.value=traits.value?.map(t2=>t2==="kholo"?"gnoll":t2),source2.type==="ancestry"){const languages=source2.system.languages,additionalLanguages=source2.system.languages;languages.value=languages.value.map(l=>l==="gnoll"?"kholo":l),languages.value.sort(),additionalLanguages.value=additionalLanguages.value.map(l=>l==="gnoll"?"kholo":l),additionalLanguages.value.sort()}}}class Migration889RemoveFocusMaxIncreases extends MigrationBase{static{__name(this,"Migration889RemoveFocusMaxIncreases")}static{__name2(this,"Migration889RemoveFocusMaxIncreases")}static version=.889;async updateItem(source2){source2.type==="feat"&&["clarity-of-focus","psi-cantrips-and-amps","psychic-dedication","psi-development"].includes(source2.system.slug??"")||(source2.system.rules=source2.system.rules.filter(r2=>!("path"in r2&&r2.path==="system.resources.focus.max")))}}class Migration890RMClassItemClassDC extends MigrationBase{static{__name(this,"Migration890RMClassItemClassDC")}static{__name2(this,"Migration890RMClassItemClassDC")}static version=.89;async updateItem(source2){if(source2.type==="class"&&"classDC"in source2.system){const system2=source2.system;system2["-=classDC"]=null}}}class Migration891DruidicToWildsong extends MigrationBase{static{__name(this,"Migration891DruidicToWildsong")}static{__name2(this,"Migration891DruidicToWildsong")}static version=.891;async updateActor(source2){source2.system=recursiveReplaceString(source2.system,s=>s.replace(/^druidic$/,"wildsong").replace(/^Druidic$/,"Wildsong"))}async updateItem(source2){source2.system=recursiveReplaceString(source2.system,s=>s.replace(/^druidic$/,"wildsong").replace(/^Druidic$/,"Wildsong")),source2.system.traits?.value?.sort()}}class Migration892ChoiceSetREAdjustNameValue extends MigrationBase{static{__name(this,"Migration892ChoiceSetREAdjustNameValue")}static{__name2(this,"Migration892ChoiceSetREAdjustNameValue")}static version=.892;async updateItem(source2){for(const rule of source2.system.rules)rule.key==="ChoiceSet"&&"adjustName"in rule&&typeof rule.adjustName=="string"&&(rule.adjustName=rule.adjustName==="true")}}const ALLIANCES=new Set(["party","opposition",null]),SAVING_THROW_ATTRIBUTES={fortitude:"con",reflex:"dex",will:"wis"},SIZE_TO_REACH={tiny:0,sm:5,med:5,lg:5,huge:10,grg:15},SENSE_TYPES=new Set(["bloodsense","darkvision","echolocation","greater-darkvision","infrared-vision","lifesense","low-light-vision","magicsense","motion-sense","scent","see-invisibility","spiritsense","thoughtsense","tremorsense","truesight","wavesense"]),SENSES_WITH_MANDATORY_ACUITIES={darkvision:"precise",echolocation:"precise","greater-darkvision":"precise","infrared-vision":"precise","low-light-vision":"precise","see-invisibility":"precise",truesight:"precise"},SENSES_WITH_UNLIMITED_RANGE=["darkvision","greater-darkvision","low-light-vision","see-invisibility"],SENSE_ACUITIES=["precise","imprecise","vague"],COMMON_LANGUAGES=["draconic","dwarven","elven","fey","gnomish","goblin","halfling","jotun","orcish","sakvroth","taldane"],UNCOMMON_LANGUAGES=["adlet","aklo","alghollthu","amurrun","arboreal","boggard","calda","caligni","chthonian","cyclops","daemonic","diabolic","ekujae","empyrean","grippli","hallit","iruxi","kelish","kholo","kibwani","kitsune","lirgeni","muan","mwangi","mzunu","nagaji","necril","ocotan","osiriani","petran","protean","pyric","requian","shadowtongue","shoanti","skald","sphinx","sussuran","tang","tengu","thalassic","tien","utopian","vanara","varisian","vudrani","xanmba","wayang","ysoki"],RARE_LANGUAGES=["akitonian","anadi","ancient-osiriani","androffan","anugobu","arcadian","azlanti","destrachan","drooni","dziriak","elder-thing","erutaki","formian","garundi","girtablilu","goloma","grioth","hwan","iblydan","ikeshti","immolis","jistkan","jyoti","kaava","kashrishi","kovintal","lashunta","mahwek","migo","minaten","minkaian","munavri","okaiyan","orvian","rasu","ratajin","razatlani","russian","samsaran","sasquatch","senzar","shae","shisk","shobhad","shoony","shory","strix","surki","talican","tanuki","tekritanin","thassilonian","varki","vishkanyan","wyrwood","yaksha","yithian"],LANGUAGES_BY_RARITY={uncommon:UNCOMMON_LANGUAGES,rare:RARE_LANGUAGES,secret:["wildsong"]},LANGUAGES=["common",...COMMON_LANGUAGES,...UNCOMMON_LANGUAGES,...RARE_LANGUAGES,"wildsong"];LANGUAGES.sort();const LANGUAGE_RARITIES=["common","uncommon","rare","secret"],HOMEBREW_ELEMENT_KEYS=["languages","armorGroups","baseArmors","classTraits","weaponCategories","weaponGroups","baseWeapons","creatureTraits","featTraits","spellTraits","weaponTraits","shieldTraits","equipmentTraits"],TRAIT_PROPAGATIONS={actionTraits:["effectTraits"],classTraits:["featTraits","spellTraits"],creatureTraits:["ancestryTraits","hazardTraits"],equipmentTraits:["armorTraits","consumableTraits"],featTraits:["actionTraits"],weaponTraits:["npcAttackTraits"]};class LanguageSettings extends foundry.abstract.DataModel{static{__name(this,"LanguageSettings")}static{__name2(this,"LanguageSettings")}_initialize(options){super._initialize(options);const nonCommonLanguages=new Set([...this.uncommon,...this.rare,...this.secret,...this.unavailable]);this.common=new Set(t$4(CONFIG.PF2E.languages).filter(l=>l!=="common"&&!nonCommonLanguages.has(l))),this.homebrew=new Set(game.settings.get("pf2e","homebrew.languages").map(t2=>t2.id))}static defineSchema(){const fields2=foundry.data.fields,languageSetField=__name2(initial=>new fields2.SetField(new fields2.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),{required:!0,nullable:!1,initial}),"languageSetField");return{commonLanguage:new fields2.StringField({required:!0,nullable:!0,blank:!1,initial:"taldane"}),uncommon:languageSetField([...LANGUAGES_BY_RARITY.uncommon]),rare:languageSetField([...LANGUAGES_BY_RARITY.rare]),secret:languageSetField([...LANGUAGES_BY_RARITY.secret]),unavailable:languageSetField([])}}toObject(source2){const obj=super.toObject(source2);return source2?obj:{...obj,common:Array.from(this.common),homebrew:Array.from(this.homebrew)}}onReady(){const source2=this._source;for(const rarity of[...LANGUAGE_RARITIES,"unavailable"])rarity!=="common"&&(source2[rarity]=source2[rarity].filter(l=>l in CONFIG.PF2E.languages));this.reset()}}class Migration893NoHBPrefixSettings extends MigrationBase{static{__name(this,"Migration893NoHBPrefixSettings")}static{__name2(this,"Migration893NoHBPrefixSettings")}static version=.893;async migrate(){for(const key of HOMEBREW_ELEMENT_KEYS){const tags=game.settings.get("pf2e",`homebrew.${key}`);if(tags.length===0)continue;const updatedTags=tags.flatMap(tag=>e$2(tag)&&typeof tag.id=="string"?(tag.id=tag.id.replace(/^hb_/,""),tag):[]);await game.settings.set("pf2e",`homebrew.${key}`,updatedTags)}}}class Migration894NoLayOnHandsVsUndead extends MigrationBase{static{__name(this,"Migration894NoLayOnHandsVsUndead")}static{__name2(this,"Migration894NoLayOnHandsVsUndead")}static version=.894;async updateActor(source2){source2.items=source2.items.filter(i=>i.type!=="spell"||(i.system.slug??sluggify(i.name))!=="lay-on-hands-vs-undead")}async updateItem(source2){const{description}=source2.system;source2.type==="effect"?description.value=description.value.replace(/@UUID\[Compendium\.pf2e\.spells-srd\.Item\.(?:Lay on Hands \(Vs\. Undead\)|IxyD7YdRbSSucxZp)\]/g,"game"in globalThis?"@UUID[Compendium.pf2e.spells-srd.Item.zNN9212H2FGfM7VS]":"@UUID[Compendium.pf2e.spells-srd.Item.Lay on Hands]"):description.value=description.value.replace(/<p>(?:<em>)?@UUID\[Compendium.pf2e.spells-srd\.(?:Item\.)?(?:Lay on Hands \(Vs\. Undead\)|IxyD7YdRbSSucxZp)\](?:<\/em>)?<\/p>\n?/g,""),source2.type==="spell"&&source2.system.slug==="lay-on-hands"&&(source2.system.overlays??={a33QUFoKgoOprovO:{name:"Lay on Hands (Vs. Undead)",overlayType:"override",sort:2,system:{damage:{"37YW4ZGhxx7Y2mdI":{applyMod:!1,category:null,formula:"1d6",kinds:["damage"],materials:[],type:"vitality"}},defense:{passive:null,save:{basic:!0,statistic:"fortitude"}},heightening:{damage:{"37YW4ZGhxx7Y2mdI":"1d6"},interval:1,type:"interval",area:0}}},uLuOg62dVyxvbW66:{name:"Lay on Hands (Healing)",overlayType:"override",sort:1,system:{damage:{b39tbePoPlJSzLku:{applyMod:!1,category:null,formula:"6",kinds:["healing"],materials:[],type:"vitality"}},heightening:{damage:{b39tbePoPlJSzLku:"6"},interval:1,type:"interval",area:0}}}},source2.system.overlays?.uLuOg62dVyxvbW66?.overlayType==="override"&&source2.system.overlays.uLuOg62dVyxvbW66.system?.damage?.b39tbePoPlJSzLku&&(source2.system.overlays.uLuOg62dVyxvbW66.system.damage.b39tbePoPlJSzLku.kinds=["healing"]))}}class Migration895FixVariantSpellTraits extends MigrationBase{static{__name(this,"Migration895FixVariantSpellTraits")}static{__name2(this,"Migration895FixVariantSpellTraits")}static version=.895;async updateItem(source2){if(source2.type==="spell")switch(source2.system.slug){case"harm":case"heal":this.#fixHarmHeal(source2);break;case"elemental-annihilation-wave":case"horizon-thunder-sphere":this.#removeOverlayTraits(source2);break;default:this.#fixOtherVariants(source2)}}#fixHarmHeal(source2){const damage=source2.system.damage[0];e$2(damage)&&(damage.kinds=["damage","healing"]),source2.system.slug==="heal"?source2.system.traits.value=["healing","manipulate","vitality"]:source2.system.traits.value=["manipulate","void"];const variants=e$2(source2.system.overlays)?Object.values(source2.system.overlays).filter(o=>e$2(o)&&e$2(o.system?.traits)&&Array.isArray(o.system?.traits.value)):[];for(const variant of variants){if(!variant.system?.traits)continue;const system2=variant.system;system2.time?.value==="1"?system2["-=traits"]=null:(system2.traits=source2.system.slug==="heal"?{value:["concentrate","healing","manipulate","vitality"]}:{value:["concentrate","manipulate","void"]},system2.damage?.["0"]?.formula?.includes("+")?(system2.damage[0].kinds=["healing"],system2.defense=null):system2.time?.value==="2"&&!system2.damage?.["0"]&&(system2.damage={0:{kinds:["damage"]}}))}}#removeOverlayTraits(source2){source2.system.traits.value=n([...source2.system.traits.value,"concentrate","manipulate"]).sort();for(const overlay of Object.values(source2.system.overlays??{})){const overlaySystem=overlay.system??{};overlaySystem["-=traits"]=null}}#fixOtherVariants(source2){for(const partial of Object.values(source2.system.damage).filter(p=>e$2(p)))typeof partial.type=="string"&&(partial.type=partial.type==="healing"?"untyped":partial.type,partial.type||="untyped");for(const overlay of Object.values(source2.system.overlays??{})){const overlaySystem=overlay.system??{};if(overlaySystem.traits?.value&&Array.isArray(overlaySystem.traits.value)){if(!overlaySystem.traits.value.filter(e$1).every(t2=>["concentrate","manipulate"].includes(t2)))continue;overlaySystem.traits.value=n([...overlaySystem.traits.value,...source2.system.traits.value]).filter(e$1).sort(),t$6(overlaySystem.traits.value,n(source2.system.traits.value.sort()))&&(overlaySystem["-=traits"]=null)}}}}class Migration896HealingDomains extends MigrationBase{static{__name(this,"Migration896HealingDomains")}static{__name2(this,"Migration896HealingDomains")}static version=.896;async updateItem(source2){if(["effect","feat"].includes(source2.type))switch(source2.system.slug){case"harming-hands":case"healing-hands":{const rule={key:"DamageDice",override:{dieSize:"d10"},predicate:[source2.system.slug==="healing-hands"?"item:slug:heal":"item:slug:harm"],selector:["spell-damage","spell-healing"]};source2.system.rules=[rule];break}case"effect-curse-of-outpouring-life":{const rule=source2.system.rules.find(r2=>r2.key==="DamageDice");rule&&(rule.selector="spell-healing")}}}}class Migration897ClearLayOnHandsDamage extends MigrationBase{static{__name(this,"Migration897ClearLayOnHandsDamage")}static{__name2(this,"Migration897ClearLayOnHandsDamage")}static version=.897;async updateItem(source2){if(source2.type!=="spell"||!["lay-on-hands","touch-of-corruption"].includes(source2.system.slug??""))return;if(source2.system.defense=null,"heightening"in source2.system){const system2=source2.system;system2["-=heightening"]=null}const damage=source2.system.damage;if(Object.keys(damage).length>0)for(const[key,partial]of Object.entries(damage))partial&&(damage[`-=${key}`]=null);for(const overlay of Object.values(source2.system.overlays??{})){if(!e$2(overlay)||!e$2(overlay.system?.damage))continue;const damagePartials=Object.values(overlay.system?.damage??{});for(const partial of damagePartials.filter(p=>e$2(p)))partial?.formula==="6"?partial.kinds=["healing"]:partial.kinds=["damage"]}source2.system.slug==="lay-on-hands"?source2.system.overlays??={a33QUFoKgoOprovO:{name:"Lay on Hands (Vs. Undead)",overlayType:"override",sort:2,system:{damage:{"37YW4ZGhxx7Y2mdI":{applyMod:!1,category:null,formula:"1d6",kinds:["damage"],materials:[],type:"vitality"}},defense:{passive:null,save:{basic:!0,statistic:"fortitude"}},heightening:{damage:{"37YW4ZGhxx7Y2mdI":"1d6"},interval:1,type:"interval",area:0}}},uLuOg62dVyxvbW66:{name:"Lay on Hands (Healing)",overlayType:"override",sort:1,system:{damage:{b39tbePoPlJSzLku:{applyMod:!1,category:null,formula:"6",kinds:["healing"],materials:[],type:"vitality"}},heightening:{damage:{b39tbePoPlJSzLku:"6"},interval:1,type:"interval",area:0}}}}:source2.system.overlays??={"2a6Vm4mIjBgrzlO2":{name:"Touch of Corruption (Vs. Living)",overlayType:"override",sort:2,system:{damage:{Esn7klJ9WRsIFnrE:{applyMod:!1,category:null,formula:"1d6",kinds:["damage"],materials:[],type:"void"}},defense:{passive:null,save:{basic:!0,statistic:"fortitude"}},heightening:{damage:{Esn7klJ9WRsIFnrE:"1d6"},interval:1,type:"interval",area:0}}},gHIOzknAtexc6GUE:{name:"Touch of Corruption (Healing)",overlayType:"override",sort:1,system:{damage:{cM137DAlBX1LcWAX:{applyMod:!1,category:null,formula:"6",kinds:["healing"],materials:[],type:"untyped"}},heightening:{damage:{cM137DAlBX1LcWAX:"6"},interval:1,type:"interval",area:0}}}}}}class Migration898NoHBAgain extends MigrationBase{static{__name(this,"Migration898NoHBAgain")}static{__name2(this,"Migration898NoHBAgain")}static version=.898;async updateActor(source2){source2.system.attributes&&=recursiveReplaceString(source2.system.attributes,s=>s.replace(/\bhb_/g,""))}async updateItem(source2){source2.system.rules=source2.system.rules.filter(r2=>e$2(r2)).map(r2=>recursiveReplaceString(r2,s=>s.replace(/\bhb_/g,"")))}}class Migration899ArmorShieldToShieldShield extends MigrationBase{static{__name(this,"Migration899ArmorShieldToShieldShield")}static{__name2(this,"Migration899ArmorShieldToShieldShield")}static version=.899;#KEYS_TO_REMOVE=["category","checkPenalty","dexCap","group","potencyRune","propertyRune1","propertyRune2","propertyRune3","propertyRune4","resiliencyRune","strength","unequippedBulk","usage"];#BASE_SHIELD_TYPES=new Set(["buckler","casters-targe","dart-shield","fortress-shield","gauntlet-buckler","harnessed-shield","heavy-rondache","hide-shield","klar","meteor-shield","razor-disc","salvo-shield","steel-shield","swordstealer-shield","tower-shield","wooden-shield"]);#SPECIFIC_BASE_ITEMS={"amaranthine-pavise":"tower-shield","arrow-catching-shield":"wooden-shield","broadleaf-shield-greater":null,"broadleaf-shield-major":null,"broadleaf-shield-true":null,"broadleaf-shield":null,"burr-shield":"wooden-shield","clockwork-shield-greater":"steel-shield","clockwork-shield":"steel-shield","cursebreak-bulwark":"tower-shield","dragonslayers-shield":"steel-shield","duelists-beacon":"buckler","exploding-shield":"wooden-shield","floating-shield-greater":"buckler","floating-shield":"buckler","force-shield":"steel-shield","forge-warden":"steel-shield","glamorous-buckler":"buckler","guardian-shield":"steel-shield","helmsmans-recourse-greater":"meteor-shield","helmsmans-recourse-major":"meteor-shield","helmsmans-recourse":"meteor-shield","highhelm-war-shield-greater":"razor-disc","highhelm-war-shield-lesser":"razor-disc","highhelm-war-shield-moderate":"razor-disc","jawbreaker-shield":null,"krakens-guard":"steel-shield","limestone-shield":"tower-shield","lions-shield":"steel-shield","martyrs-shield":"steel-shield","medusas-scream-greater":"steel-shield","medusas-scream":"steel-shield","nethysian-bulwark":"steel-shield","pillow-shield":"steel-shield","rampart-shield":"tower-shield","reflecting-shield":"buckler","reforging-shield":"steel-shield","sanguine-klar-greater":"klar","sanguine-klar":"klar","sapling-shield-greater":"buckler","sapling-shield-lesser":"buckler","sapling-shield-major":"buckler","sapling-shield-minor":"buckler","sapling-shield-moderate":"buckler","sapling-shield-true":"buckler","scale-of-igroon":null,"shining-shield":"wooden-shield","silkspinners-shield":"buckler","spellguard-shield":"steel-shield","spined-shield":"steel-shield","staff-storing-shield-greater":"wooden-shield","staff-storing-shield-major":"wooden-shield","staff-storing-shield-true":"wooden-shield","staff-storing-shield":"wooden-shield","starfall-shield":"heavy-rondache","sturdy-shield-greater":"steel-shield","sturdy-shield-lesser":"steel-shield","sturdy-shield-major":"steel-shield","sturdy-shield-minor":"steel-shield","sturdy-shield-moderate":"steel-shield","sturdy-shield-supreme":"steel-shield","turnabout-shield":"salvo-shield","warding-escutcheon-greater":"tower-shield","warding-escutcheon":"tower-shield","wovenwood-shield-greater":"wooden-shield","wovenwood-shield-lesser":"wooden-shield","wovenwood-shield-major":"wooden-shield","wovenwood-shield-minor":"wooden-shield","wovenwood-shield-moderate":"wooden-shield","wovenwood-shield-true":"wooden-shield"};async updateItem(source2){if(itemIsOfType(source2,"physical")&&source2.type!=="backpack"){const system22=source2.system;"negateBulk"in system22&&(system22.category==="shield"?delete system22.negateBulk:system22["-=negateBulk"]=null)}if(this.#migrateRules(source2),source2.type!=="armor")return;const category=source2.system.category;category!=="shield"&&(source2.system.checkPenalty||=0,source2.system.dexCap||=0),source2.system.speedPenalty||=0;const system2=source2.system;if(category==="shield"){source2.img=source2.img.replace(/\barmor\.svg$/,"shield.svg"),system2.baseItem=this.#BASE_SHIELD_TYPES.has(source2.system.slug??"")?source2.system.slug:null,system2.traits.value=system2.traits.value.map(t2=>t2==="hefty-14"?"hefty-2":t2),system2.traits.integrated=system2.traits.value.some(t2=>t2.startsWith("integrated"))?{runes:{potency:0,striking:0,property:[]},versatile:null}:null,system2.usage={value:"held-in-one-hand"},system2.runes={reinforcing:0},this.#validateOrRemoveMaterial(system2),this.#setSpecificShieldData(system2),source2.type="shield";for(const key of this.#KEYS_TO_REMOVE)delete system2[key];source2["==system"]=system2}}#migrateRules(source2){const shieldAlterations=source2.system.rules.filter(r2=>r2.key==="ItemAlteration"&&r2.itemType==="armor"&&Array.isArray(r2.predicate)&&r2.predicate.includes("item:category:shield"));for(const rule of shieldAlterations)rule.itemType="shield",rule.predicate=rule.predicate.filter(s=>s!=="item:category:shield")}#validateOrRemoveMaterial(system2){if(!system2.material.type){system2.material.grade=null;return}if(!system2.material.grade){system2.material.type=null;return}const baseItem=system2.baseItem??"",{type:type2}=system2.material,BUCKLERS=["buckler","casters-targe","dart-shield","gauntlet-buckler","heavy-rondache","klar"],bucklerMaterials=["abysium","adamantine","cold-iron","darkwood","djezet","inubrix","mithral","noqual","orichalcum","siccatite","silver"],MATERIALS={buckler:bucklerMaterials,towerShield:["darkwood"],shield:[...bucklerMaterials,"keep-stone"]};["tower-shield","fortress-shield"].includes(baseItem)&&!MATERIALS.towerShield.includes(type2)||BUCKLERS.includes(baseItem)&&!MATERIALS.buckler.includes(type2)?(system2.material.type=null,system2.material.grade=null):MATERIALS.shield.includes(type2)||(system2.material.type=null,system2.material.grade=null)}#setSpecificShieldData(system2){if(system2.baseItem||!system2.slug)return;const setSpecific=__name2(()=>{system2.specific={material:foundry.utils.deepClone(system2.material),runes:{reinforcing:0},integrated:system2.traits.integrated?foundry.utils.deepClone({runes:system2.traits.integrated.runes}):null}},"setSpecific");switch(system2.slug){case"indestructible-shield":system2.baseItem="steel-shield",system2.material={type:"adamantine",grade:"high"},setSpecific();break;case"kizidhars-shield":system2.baseItem="wooden-shield",system2.material={type:"duskwood",grade:"standard"},setSpecific();break;case"lodestone-shield":system2.baseItem="steel-shield",system2.material={type:"cold-iron",grade:"standard"},setSpecific();break;default:system2.baseItem=this.#SPECIFIC_BASE_ITEMS[system2.slug??""]??null,system2.slug in this.#SPECIFIC_BASE_ITEMS&&setSpecific()}}}class Migration900ClassSpellcastingProficiency extends MigrationBase{static{__name(this,"Migration900ClassSpellcastingProficiency")}static{__name2(this,"Migration900ClassSpellcastingProficiency")}static version=.9;async updateActor(source2){if(source2.type==="character"&&source2.system.proficiencies){const proficiencies=source2.system.proficiencies;"spellcasting"in proficiencies&&(proficiencies["-=spellcasting"]=null)}}async updateItem(source2){if(source2.type==="class"){const aeLikeIncrease=source2.system.rules.find(r2=>r2.key==="ActiveEffectLike"&&r2.path==="system.proficiencies.spellcasting.rank");aeLikeIncrease?(source2.system.spellcasting=Math.max(1,source2.system.spellcasting??0),source2.system.rules.splice(source2.system.rules.indexOf(aeLikeIncrease),1)):["sorcerer","summoner","witch"].includes(source2.system.slug??"")?source2.system.spellcasting=1:source2.system.spellcasting=Math.max(0,source2.system.spellcasting??0)}if(source2.type==="feat"){const baseRule={key:"ActiveEffectLike",mode:"upgrade",path:"system.proficiencies.spellcasting.rank"};switch(source2.system.slug){case"bloodline":case"patron":source2.system.rules=source2.system.rules.filter(r2=>r2.path!=="system.proficiencies.spellcasting.rank");break;case"expert-spellcaster":{const rule={...baseRule,value:2};source2.system.rules=[rule],source2.system.publication={...source2.system.publication??{},license:"ORC",remaster:!0,title:"Pathfinder Player Core"};break}case"expert-spellcasting":{const rule={...baseRule,value:2};source2.system.rules=[rule];break}case"master-spellcaster":{const rule={...baseRule,value:3};source2.system.rules=[rule],source2.system.publication={...source2.system.publication??{},license:"ORC",remaster:!0,title:"Pathfinder Player Core"};break}case"master-spellcasting":{const rule={...baseRule,value:3};source2.system.rules=[rule];break}case"legendary-spellcaster":{const rule={...baseRule,value:4};source2.system.rules=[rule],source2.system.publication={...source2.system.publication??{},license:"ORC",remaster:!0,title:"Pathfinder Player Core"};break}}}}}class Migration901ReorganizeBulkData extends MigrationBase{static{__name(this,"Migration901ReorganizeBulkData")}static{__name2(this,"Migration901ReorganizeBulkData")}static version=.901;async updateItem(source2){if(this.#migrateRules(source2),!itemIsOfType(source2,"physical"))return;const system2=source2.system;if(system2.bulk??={value:0},"equippedBulk"in system2&&(["armor","backpack"].includes(source2.type)&&(system2.bulk.value=this.#bulkStringToNumber(system2.equippedBulk)),system2["-=equippedBulk"]=null,system2.slug==="sack"?(system2.usage={value:"held-in-one-hand"},system2.bulk.value=.1):/bag-of-(?:devouring|holding|weasels)|spacious-pouch/.test(system2.slug??"")?system2.bulk.value=1:system2.slug==="sleeves-of-storage"&&(system2.bulk.value=.1)),"weight"in system2){if(source2.type==="backpack"){const usage=system2.usage?.value??"";source2.system.bulk.heldOrStowed=["held-in-one-hand","held-in-two-hands"].includes(usage)?Math.max(system2.bulk.value,this.#bulkStringToNumber(system2.weight)):this.#bulkStringToNumber(system2.weight)}else source2.type!=="armor"&&(source2.system.bulk.value=this.#bulkStringToNumber(system2.weight));system2["-=weight"]=null}"bulkCapacity"in system2&&(source2.type==="backpack"&&(source2.system.bulk.capacity=e$2(system2.bulkCapacity)&&Math.floor(Math.abs(Number(system2.bulkCapacity.value)))||0),system2["-=bulkCapacity"]=null),"negateBulk"in system2&&(source2.type==="backpack"&&(source2.system.bulk.ignored=e$2(system2.negateBulk)&&Math.floor(Math.abs(Number(system2.negateBulk.value)))||0),system2["-=negateBulk"]=null)}#migrateRules(source2){const itemAlterations=source2.system.rules.filter(r2=>r2.key==="ItemAlteration"&&typeof r2.property=="string");for(const rule of itemAlterations)(rule.itemType==="armor"&&rule.property==="bulk-worn"||rule.itemType!=="armor"&&rule.property==="bulk-value")&&(rule.property="bulk");source2.system.rules=source2.system.rules.filter(r2=>r2.key==="ItemAlteration"&&typeof r2.property=="string"?!["bulk-worn","bulk-value"].includes(r2.property):!0)}#bulkStringToNumber(bulkObject){if(!e$2(bulkObject))return 0;const bulkString=String(bulkObject.value||"-").toLocaleUpperCase("en");switch(bulkString){case"-":return 0;case"L":return .1;default:{const numericValue=Number(bulkString);return Number.isInteger(numericValue)?Math.abs(numericValue):0}}}}class Migration902DuskwoodDawnsilver extends MigrationBase{static{__name(this,"Migration902DuskwoodDawnsilver")}static{__name2(this,"Migration902DuskwoodDawnsilver")}static version=.902;#replaceStrings(data){return recursiveReplaceString(data,s=>s.replace(/\bdarkwood\b/g,"duskwood").replace(/Darkwood\b/g,"Duskwood").replace(/\bmithral\b/g,"dawnsilver").replace(/Mithral\b/g,"Dawnsilver").replace(/\bdawnsilver(.)tree\b/g,"mithral$1tree").replace(/\bDawnsilver Tree\b/g,"Mithral Tree").replace(/\bdawnsilver(.)golem/g,"mithral$1golem").replace(/\bDawnsilver(.)golem/g,"Mithral$1golem"))}async updateActor(source2){source2.system=this.#replaceStrings(source2.system),source2.flags.pf2e&&=this.#replaceStrings(source2.flags.pf2e)}async updateItem(source2){source2.system=this.#replaceStrings(source2.system),source2.flags.pf2e&&=this.#replaceStrings(source2.flags.pf2e)}}class Migration903PhysicalNumericData extends MigrationBase{static{__name(this,"Migration903PhysicalNumericData")}static{__name2(this,"Migration903PhysicalNumericData")}static version=.903;async updateItem(source2){if(source2.type==="armor")source2.system.dexCap||=0,source2.system.strength||=source2.system.category==="unarmored"?null:0;else if(source2.type==="backpack"){const slug=source2.system.slug??"";/bag-of-(?:devouring|holding|weasels)|spacious-pouch/.test(slug)&&(source2.system.bulk.value||=1)}}}class Migration904UndercommonToSakvroth extends MigrationBase{static{__name(this,"Migration904UndercommonToSakvroth")}static{__name2(this,"Migration904UndercommonToSakvroth")}static version=.904;#replaceStrings(data){return recursiveReplaceString(data,s=>s.replace(/\bundercommon\b/g,"sakvroth").replace(/\bUndercommon\b/g,"Sakvroth"))}async updateActor(source2){source2.system=this.#replaceStrings(source2.system),source2.flags.pf2e&&=this.#replaceStrings(source2.flags.pf2e)}async updateItem(source2){source2.system=this.#replaceStrings(source2.system),source2.flags.pf2e&&=this.#replaceStrings(source2.flags.pf2e)}}class Migration905UnpersistUsage extends MigrationBase{static{__name(this,"Migration905UnpersistUsage")}static{__name2(this,"Migration905UnpersistUsage")}static version=.905;async updateItem(source2){if(!itemIsOfType(source2,"physical")){"usage"in source2.system&&(source2.system["-=usage"]=null);return}itemIsOfType(source2,"armor","shield","treasure")?"usage"in source2.system&&(source2.system["-=usage"]=null):source2.system.usage?.value===""&&(source2.system.usage.value="carried")}}const AMMO_STACK_GROUPS=new Set(["arrows","blowgunDarts","bolts","rounds5","rounds10","slingBullets","sprayPellets","woodenTaws"]);class Migration906LimitStackGroup extends MigrationBase{static{__name(this,"Migration906LimitStackGroup")}static{__name2(this,"Migration906LimitStackGroup")}static version=.906;async updateItem(source2){if((!itemIsOfType(source2,"physical")||!itemIsOfType(source2,"consumable","treasure"))&&"stackGroup"in source2.system)source2.system["-=stackGroup"]=null;else if(source2.type==="consumable"){const category="consumableType"in source2.system&&e$2(source2.system.consumableType)?String(source2.system.consumableType.value):source2.system.category;source2.system.stackGroup=category==="ammo"&&setHasElement(AMMO_STACK_GROUPS,source2.system.stackGroup)?source2.system.stackGroup:null}else source2.type==="treasure"&&(source2.system.stackGroup=["coins","gems"].includes(source2.system.stackGroup??"")?source2.system.stackGroup:null);!("game"in globalThis)&&"stackGroup"in source2.system&&!source2.system.stackGroup&&(source2.system["-=stackGroup"]=null)}}const WEAPON_CATEGORIES=["unarmed","simple","martial","advanced"],MELEE_OR_RANGED_GROUPS=new Set(["brawling","dart","knife"]);[...MELEE_OR_RANGED_GROUPS];const MANDATORY_RANGED_GROUPS=new Set(["bomb","bow","crossbow","firearm","sling"]),WEAPON_PROPERTY_RUNE_TYPES=new Set(["ancestralEchoing","anchoring","ashen","astral","authorized","bane","bloodbane","bloodthirsty","bolkasBlessing","brilliant","called","coating","conducting","corrosive","crushing","cunning","dancing","deathdrinking","decaying","demolishing","disrupting","earthbinding","energizing","extending","fanged","fearsome","flaming","flickering","flurrying","frost","ghostTouch","giantKilling","greaterGiantKilling","greaterAnchoring","greaterAshen","greaterAstral","greaterBloodbane","greaterBolkasBlessing","greaterBrilliant","greaterCorrosive","greaterCrushing","greaterDecaying","greaterDisrupting","greaterExtending","greaterFanged","greaterFearsome","greaterFlaming","greaterFrost","greaterHauling","greaterImpactful","greaterKolssOath","greaterRooting","greaterShock","greaterThundering","greaterTruddsStrength","grievous","hauling","holy","hopeful","hooked","impactful","impossible","keen","kinWarding","kolssOath","majorFanged","majorRooting","merciful","nightmare","pacifying","returning","rooting","serrating","shifting","shock","shockwave","speed","spellStoring","swarming","thundering","truddsStrength","trueRooting","underwater","unholy","vorpal","wounding"]),THROWN_RANGES=new Set([10,15,20,30,40,60,80,100]),WEAPON_RANGES=new Set([...THROWN_RANGES,50,70,90,110,120,140,150,180,200,240,300]),RANGED_ONLY_TRAITS=new Set(["brutal","cobbled","combination","double-barrel","fatal-aim-d10","fatal-aim-d12","kickback","propulsive","scatter-5","scatter-10","scatter-15","scatter-20","splash","ranged-trip","repeating","thrown"]),MELEE_ONLY_TRAITS=new Set(["brace","disarm","finesse","grapple","reach","shove","trip"]);class Migration907RestructureArmorWeaponRunes extends MigrationBase{static{__name(this,"Migration907RestructureArmorWeaponRunes")}static{__name2(this,"Migration907RestructureArmorWeaponRunes")}static version=.907;#RESILIENT_RUNE_CONVERSION=new Map([["resilient",1],["greaterResilient",2],["majorResilient",3]]);#STRIKING_RUNE_CONVERSION=new Map([["striking",1],["greaterStriking",2],["majorStriking",3]]);#RUNE_DELETIONS=["potencyRune","resiliencyRune","strikingRune","propertyRune1","propertyRune2","propertyRune3","propertyRune4"];#cleanupSpecificData(system2){const specificData=system2.specific;e$2(specificData)&&("price"in specificData&&(specificData["-=price"]=null),specificData.value===!0?(specificData["-=value"]=null,specificData.runes=foundry.utils.deepClone(system2.runes),e$2(specificData.material)&&"precious"in specificData.material?(specificData.material["-=precious"]=null,specificData.material=foundry.utils.mergeObject(specificData.material,foundry.utils.deepClone(system2.material))):specificData.material=foundry.utils.deepClone(system2.material)):"value"in specificData&&(system2.specific=null))}#getRuneValue(system2,key){if(!e$2(system2))throw ErrorPF2e("Unexpected system data");const runeObject=system2[key];return e$2(runeObject)?runeObject.value:null}async updateItem(source2){if(itemIsOfType(source2,"armor","weapon")&&(source2.type==="armor"?source2.system.runes??={potency:0,resilient:0,property:[]}:source2.type==="weapon"&&(source2.system.runes??={potency:0,striking:0,property:[]}),"potencyRune"in source2.system&&e$2(source2.system.potencyRune))){const potencyRune=Number(source2.system.potencyRune.value)||0;source2.system.runes.potency=tupleHasValue([1,2,3,4],potencyRune)?potencyRune:0}if(source2.type==="armor"){if("resiliencyRune"in source2.system&&e$2(source2.system.resiliencyRune)){const resilientRune=String(source2.system.resiliencyRune.value),numericValue=this.#RESILIENT_RUNE_CONVERSION.get(resilientRune)??0;source2.system.runes.resilient=numericValue}for(const runeKey of["propertyRune1","propertyRune2","propertyRune3","propertyRune4"]){if(!(runeKey in source2.system))continue;const runeValue=this.#getRuneValue(source2.system,runeKey);setHasElement(ARMOR_PROPERTY_RUNE_TYPES,runeValue)&&(source2.system.runes.property.push(runeValue),source2.system.runes.property=n(source2.system.runes.property).filter(e$1),source2.system.runes.property.length=Math.min(source2.system.runes.property.length,4))}this.#cleanupSpecificData(source2.system)}else if(source2.type==="weapon"){if("strikingRune"in source2.system&&e$2(source2.system.strikingRune)){const strikingRune=String(source2.system.strikingRune.value),numericValue=this.#STRIKING_RUNE_CONVERSION.get(strikingRune)??0;source2.system.runes.striking=numericValue}for(const runeKey of["propertyRune1","propertyRune2","propertyRune3","propertyRune4"]){if(!(runeKey in source2.system))continue;const runeValue=this.#getRuneValue(source2.system,runeKey);setHasElement(WEAPON_PROPERTY_RUNE_TYPES,runeValue)&&(source2.system.runes.property.push(runeValue),source2.system.runes.property=n(source2.system.runes.property).filter(e$1),source2.system.runes.property.length=Math.min(source2.system.runes.property.length,4))}this.#cleanupSpecificData(source2.system)}for(const deletion of this.#RUNE_DELETIONS)deletion in source2.system&&(source2.system[`-=${deletion}`]=null)}}class Migration908TrueGangUp extends MigrationBase{static{__name(this,"Migration908TrueGangUp")}static{__name2(this,"Migration908TrueGangUp")}static version=.908;async updateItem(source2){if((source2.system.slug??"")==="gang-up"&&source2.type==="feat"){const rule={key:"ActiveEffectLike",mode:"add",path:"system.attributes.flanking.canGangUp",value:!0};source2.system.rules=[rule]}}}const CONSUMABLE_CATEGORIES=new Set(["catalyst","drug","elixir","fulu","gadget","mutagen","oil","other","poison","potion","scroll","snare","talisman","toolkit","wand"]),DAMAGE_OR_HEALING_CONSUMABLE_CATEGORIES=new Set(["elixir","oil","other","poison","potion","snare"]),DAMAGE_ONLY_CONSUMABLE_CATEGORIES=new Set(["snare"]);class Migration909RefineConsumableData extends MigrationBase{static{__name(this,"Migration909RefineConsumableData")}static{__name2(this,"Migration909RefineConsumableData")}static version=.909;async updateItem(source2){if(source2.type!=="consumable")return;const system2=source2.system,autoDestroy=e$2(system2.autoDestroy)?!!system2.autoDestroy.value:system2.uses?.autoDestroy??!0;if("autoDestroy"in system2&&(system2["-=autoDestroy"]=null),"charges"in system2){if(e$2(system2.charges)){const value=Math.min(Math.max(Math.floor(Number(system2.charges.value)||0),0),9999),max=Math.min(Math.max(Math.floor(Number(system2.charges.max)||0),0),9999);system2.uses={value,max,autoDestroy},system2.uses.max===0&&(system2.uses.value=1,system2.uses.max=1)}system2["-=charges"]=null}if("consumableType"in system2){if(e$2(system2.consumableType)){const category=system2.consumableType.value==="tool"?"toolkit":system2.consumableType.value;system2.category=setHasElement(CONSUMABLE_CATEGORIES,category)?category:"other"}system2["-=consumableType"]=null}if(system2.slug==="fang-snare"&&(system2.category="snare"),"consume"in system2){if(e$2(system2.consume)){const traits=source2.system.traits.value,formula=typeof system2.consume.value=="string"&&system2.consume.value.trim()||null,type2=formula?this.#determineDamageType(system2.category,traits,system2.description.value):null,kind=DAMAGE_ONLY_CONSUMABLE_CATEGORIES.has(system2.category)||!["vitality","void","untyped"].includes(type2??"")?"damage":"healing";system2.damage=formula===null||type2===null?null:{formula,kind,type:type2}}system2["-=consume"]=null}DAMAGE_OR_HEALING_CONSUMABLE_CATEGORIES.has(system2.category)||(system2.damage=null)}#determineDamageType(category,traits,description){const damageTypes2=Array.from(DAMAGE_TYPES),fromTraits=damageTypes2.find(t2=>traits.includes(t2)),fromDescription=!fromTraits&&category==="snare"?damageTypes2.find(t2=>new RegExp(String.raw`\b${t2}\b`).test(description)):null;return fromTraits??fromDescription??"untyped"}}class Migration910EdictsAnathemaArrays extends MigrationBase{static{__name(this,"Migration910EdictsAnathemaArrays")}static{__name2(this,"Migration910EdictsAnathemaArrays")}static version=.91;async updateActor(source2){if(source2.type!=="character")return;const biography=source2.system.details.biography;biography.edicts=(typeof biography.edicts=="string"?[biography.edicts]:biography.edicts??[]).filter(e$1),biography.anathema=(typeof biography.anathema=="string"?[biography.anathema]:biography.anathema??[]).filter(e$1)}}class Migration911CoinBulk extends MigrationBase{static{__name(this,"Migration911CoinBulk")}static{__name2(this,"Migration911CoinBulk")}static version=.911;async updateItem(source2){source2.type==="treasure"&&source2.system.category==="coin"&&(source2.system.bulk.value=1)}}class Migration912RmFocusTraitFocusCantrips extends MigrationBase{static{__name(this,"Migration912RmFocusTraitFocusCantrips")}static{__name2(this,"Migration912RmFocusTraitFocusCantrips")}static version=.912;async updateItem(source2){if(source2.type!=="spell")return;const magicTraditions2=MAGIC_TRADITIONS,traits=source2.system.traits,misplacedMagicTraditions=traits.value.filter(t2=>magicTraditions2.has(t2));traits.traditions??=[],traits.traditions.push(...misplacedMagicTraditions),traits.value=traits.value.filter(t2=>!magicTraditions2.has(t2)),traits.value.includes("focus")&&(traits.traditions=[]),traits.value.includes("cantrip")&&(traits.value=traits.value.filter(t2=>t2!=="focus")),traits.traditions=n(traits.traditions.sort()),traits.value=n(traits.value.sort())}}class Migration913SpellSustainedText extends MigrationBase{static{__name(this,"Migration913SpellSustainedText")}static{__name2(this,"Migration913SpellSustainedText")}static version=.913;async updateItem(source2){if(source2.type!=="spell")return;const duration=source2.system.duration;duration.value&&=duration.value.trim(),/^sustained$/i.test(duration.value)?(duration.value="",duration.sustained=!0):/^sustained/i.test(duration.value)&&(duration.value=duration.value.replace(/^sustained.+?(?=\d)/i,""),duration.sustained=!0)}}class Migration914MovePerceptionSenses extends MigrationBase{static{__name(this,"Migration914MovePerceptionSenses")}static{__name2(this,"Migration914MovePerceptionSenses")}static version=.914;async updateActor(source2){if(source2.type==="character"||source2.type==="npc"){const attributes=source2.system.attributes;"initiative"in attributes&&(attributes["-=initiative"]=null,e$2(attributes.initiative)&&"statistic"in attributes.initiative&&setHasElement(CORE_SKILL_SLUGS,attributes.initiative.statistic)&&(source2.system.initiative.statistic=attributes.initiative.statistic))}if(source2.type==="character"){const attributes=source2.system.attributes;"perception"in attributes&&(attributes["-=perception"]=null);const traits=source2.system.traits;e$2(traits)&&"senses"in traits&&(traits["-=senses"]=null),this.#createCustomChangesFeat(source2)}else if(source2.type==="npc"){const attributes=source2.system.attributes;if("perception"in attributes){const mod=e$2(attributes.perception)&&Number(attributes.perception.value)||0;source2.system.perception.mod=mod,attributes["-=perception"]=null}const traits=source2.system.traits;"senses"in traits&&(this.#convertNPCSenses(source2.system),traits["-=senses"]=null)}if(e$2(source2.system.traits)&&"attitude"in source2.system.traits){const traits=source2.system.traits;traits["-=attitude"]=null}}async updateItem(source2){for(const rule of source2.system.rules)rule.key==="Sense"&&"selector"in rule&&typeof rule.selector=="string"&&(rule.selector=sluggify(rule.selector),rule.selector==="motionsense"&&(rule.selector="motion-sense"));for(const fieldName of["initiative","perception"]){const pattern=new RegExp(String.raw`\battributes\.${fieldName}\b`,"g");source2.system.description=recursiveReplaceString(source2.system.description,s=>s.replace(new RegExp(pattern),fieldName)),source2.system.rules=source2.system.rules.map(r2=>recursiveReplaceString(r2,s=>s.replace(pattern,fieldName))),source2.flags.pf2e&&=recursiveReplaceString(source2.flags.pf2e,s=>s.replace(pattern,fieldName))}if(source2.type==="ancestry")(source2.system.vision??="normal")==="lowLightVision"&&(source2.system.vision="low-light-vision");else if(source2.type==="feat"&&source2.system.slug==="multilingual"){const ternary="ternary(eq(@actor.system.skills.soc.rank, 4), 2, ternary(eq(@actor.system.skills.soc.rank, 3), 1, 0))",flagPath="flags.pf2e.multilingualTaken",rules=[{key:"ActiveEffectLike",mode:"add",path:"system.build.languages.max",value:ternary},{key:"ActiveEffectLike",mode:"override",path:flagPath,priority:19,value:0},{key:"ActiveEffectLike",mode:"add",path:flagPath,value:1}];source2.system.rules=rules,source2.system.subfeatures.languages={granted:[],slots:2}}}#createCustomChangesFeat(source2){if(!("game"in globalThis))return;const customChangesFeat={_id:foundry.utils.randomID(),effects:[],flags:{},folder:null,img:"icons/sundries/books/book-red-exclamation.webp",name:"Custom Changes",sort:0,type:"feat",system:{_migration:{version:null,previous:null},actions:{value:null},actionType:{value:"passive"},category:"bonus",description:{value:"",gm:""},level:{value:1,taken:void 0},location:null,maxTakable:null,onlyLevel1:!1,prerequisites:{value:[]},publication:{title:"",authors:"",license:"OGL",remaster:!1},rules:[],slug:"custom-changes",traits:{otherTags:[],rarity:"unique",value:[],toggles:void 0}}},saves=source2.system.saves;if(e$2(saves))for(const saveType of SAVE_TYPES){const save=saves[saveType];e$2(save)&&typeof save.rank=="number"&&save.rank>1&&(customChangesFeat.system=foundry.utils.mergeObject({subfeatures:{proficiencies:{[saveType]:{rank:Math.clamp(save.rank,2,4)}}}},customChangesFeat.system))}const proficiencies=source2.system.proficiencies??{};for(const key of["attacks","defenses"]){const categories=key==="attacks"?WEAPON_CATEGORIES:ARMOR_CATEGORIES,section=proficiencies[key]??{};for(const category of categories){const proficiency=section[category];if(e$2(proficiency)&&typeof proficiency.rank=="number"&&proficiency.rank>0){const rank=Math.clamp(proficiency.rank,1,4);customChangesFeat.system=foundry.utils.mergeObject({subfeatures:{proficiencies:{[category]:{rank}}}},customChangesFeat.system),section[`-=${category}`]=null}}key in proficiencies&&Object.keys(proficiencies).length===0&&(proficiencies[`-=${key}`]=null)}const attributes=source2.system.attributes;e$2(attributes.perception)&&"rank"in attributes.perception&&typeof attributes.perception.rank=="number"&&attributes.perception.rank>1&&(customChangesFeat.system=foundry.utils.mergeObject({subfeatures:{proficiencies:{perception:{rank:attributes.perception.rank}}}},customChangesFeat.system));const traits=source2.system.traits;if(e$2(traits)){if(Array.isArray(traits.value)&&traits.value.length>0){const rule={key:"ActorTraits",add:traits.value.filter(t2=>t2&&typeof t2=="string").map(t2=>sluggify(t2))};customChangesFeat.system?.rules?.push(rule)}if(Array.isArray(traits.senses)){for(const sense of traits.senses)if(e$2(sense)&&typeof sense.type=="string"){const type2=sluggify(sense.type);if(["lowLightVision","darkvision"].includes(sense.type)){const ancestry=source2.items.find(i=>i.type==="ancestry"),heritage=source2.items.find(i=>i.type==="heritage");if(ancestry?.system.vision===sense.type||heritage?.system.rules.some(r2=>r2.key==="Sense"&&"selector"in r2&&r2.selector==="lowLightVision"))continue}const acuity=String(sense.acuity),range=Number(sense.number)||null,subfeature=tupleHasValue(SENSES_WITH_UNLIMITED_RANGE,type2)?{}:tupleHasValue(["precise","imprecise","vague"],acuity)&&Number.isInteger(range)?{acuity,range}:null;subfeature&&(customChangesFeat.system=foundry.utils.mergeObject({subfeatures:{senses:{[type2]:subfeature}}},customChangesFeat.system))}}}customChangesFeat.system?.subfeatures&&source2.items.push(customChangesFeat)}#convertNPCSenses(system2){if(e$2(system2.traits.senses)&&typeof system2.traits.senses.value=="string"){const senseStrings=system2.traits.senses.value.split(",").map(s=>s.toLocaleLowerCase("en").trim()).filter(e$1),senseTypes=t(Array.from(SENSE_TYPES),t2=>t2!=="greater-darkvision"),acuities=["imprecise","precise","vague"];for(const text2 of senseStrings){if(text2==="no vision"){system2.perception.vision=!1;continue}else text2.includes("blood scent")&&(system2.perception.details=[system2.perception.details,"blood scent"].filter(e$1).join(", "));const sluggified=sluggify(text2.replace("heatsight","infrared vision").replace("motionsense","motion sense").replace(/true(?: seeing|sight)/,"truesight")),type2=senseTypes.find(t2=>sluggified.includes(t2)),acuity=(()=>{if(type2){const match=SENSES_WITH_MANDATORY_ACUITIES[type2]??acuities.find(a=>sluggified.includes(a));return!match&&type2==="lifesense"?"precise":match??"imprecise"}return"imprecise"})(),range=type2==="truesight"?60:Number(/(\d+)/.exec(text2)?.at(1)||NaN),sense=tupleHasValue(SENSES_WITH_UNLIMITED_RANGE,type2)?{type:type2}:type2&&range>0&&Number.isInteger(range)?{type:type2,acuity,range}:null;sense?system2.perception.senses.push(sense):system2.perception.details=[system2.perception.details,text2].filter(e$1).join(", ")}}}}class Migration915MoveLanguages extends Migration914MovePerceptionSenses{static{__name(this,"Migration915MoveLanguages")}static{__name2(this,"Migration915MoveLanguages")}static version=.915;#allLanguages=new Set("game"in globalThis?Object.keys(CONFIG.PF2E.languages):LANGUAGES);async updateActor(source2){if(source2.type==="character"||source2.type==="npc"){const system2=source2.system;system2.details.languages??={value:[],details:""},e$2(system2.traits)&&e$2(system2.traits.languages)&&Array.isArray(system2.traits.languages.value)&&(system2.details.languages={value:system2.traits.languages.value.filter(l=>this.#allLanguages.has(l))},typeof system2.traits.languages.custom=="string"&&(system2.details.languages.details||=system2.traits.languages.custom.toLowerCase().replace("speak any languages","speak any language"))),source2.type==="character"&&"traits"in system2?(this.#deduplicateWildsong(source2),system2["-=traits"]=null):e$2(system2.traits)&&"languages"in system2.traits&&(system2.traits["-=languages"]=null)}}async updateItem(source2){const languageAELikes=source2.system.rules.filter(r2=>r2.key==="ActiveEffectLike"&&r2.path==="system.traits.languages.value"&&typeof r2.value=="string");for(const rule of languageAELikes){const language=String(rule.value);if(source2.type==="feat"&&!rule.predicate&&this.#allLanguages.has(language)){const subfeatures=source2.system.subfeatures=foundry.utils.mergeObject({languages:{granted:[],slots:0}},source2.system.subfeatures);subfeatures.languages.granted=n([...subfeatures.languages.granted,language]),source2.system.rules.splice(source2.system.rules.indexOf(rule),1)}else rule.path="system.build.languages.granted",rule.value={slug:rule.value,source:"{item|name}"}}}#deduplicateWildsong(source2){const wildsongSlugs=["druid-dedication","druidic-language","wildsong"],wildsongFeature=source2.items.find(i=>i.type==="feat"&&wildsongSlugs.includes(i.system.slug??""));if(wildsongFeature){wildsongFeature.system.subfeatures.languages={granted:["wildsong"],slots:0};const languages=source2.system.details.languages.value;languages.includes("wildsong")&&languages.splice(languages.indexOf("wildsong"),1)}}}class Migration916NewPCToys extends MigrationBase{static{__name(this,"Migration916NewPCToys")}static{__name2(this,"Migration916NewPCToys")}static version=.916;async updateItem(source2){const slug=source2.system.slug;slug&&(source2.type==="action"?this.#updateAbility(source2,slug):source2.type==="class"?this.#updateClass(source2,slug):source2.type==="feat"&&this.#updateFeat(source2,slug))}get#explodeAELike(){return{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.inventor.explode",priority:49,value:"fire"}}get#unstableCheckNotes(){return[{key:"Note",predicate:["self:action:trait:unstable"],selector:["inline-damage","inline-healing","strike-attack-roll"],text:"PF2E.SpecificRule.Inventor.Unstable.Note",title:"PF2E.TraitUnstable"},{key:"Note",outcome:["failure"],predicate:["unstable-check"],selector:["flat-check"],text:"PF2E.SpecificRule.Inventor.Unstable.FlatCheck.Failure",title:"PF2E.Check.Result.Degree.Check.failure"},{key:"Note",outcome:["criticalFailure"],predicate:["unstable-check"],selector:["flat-check"],text:"PF2E.SpecificRule.Inventor.Unstable.FlatCheck.CriticalFailure",title:"PF2E.Check.Result.Degree.Check.criticalFailure"}]}#updateAbility(source2,slug){if(slug==="overdrive"){const rules=[{key:"Note",title:"PF2E.Check.Result.Degree.Check.criticalSuccess",selector:"crafting",predicate:["self:action:slug:overdrive"],text:"PF2E.SpecificRule.Inventor.Overdrive.CriticalSuccess",outcome:["criticalSuccess"]},{key:"Note",title:"PF2E.Check.Result.Degree.Check.success",selector:"crafting",predicate:["self:action:slug:overdrive"],text:"PF2E.SpecificRule.Inventor.Overdrive.Success",outcome:["success"]},{key:"Note",outcome:["criticalFailure"],predicate:["self:action:slug:overdrive"],selector:"crafting",text:"PF2E.SpecificRule.Inventor.Overdrive.CriticalFailure",title:"PF2E.Check.Result.Degree.Check.criticalFailure"}];source2.system.rules=rules}}#updateClass(source2,slug){slug==="inventor"&&(source2.system.rules=[this.#explodeAELike,...this.#unstableCheckNotes])}#updateFeat(source2,slug){if(slug==="finishing-precision"&&!source2.system.rules.some(r2=>r2.key==="ActiveEffectLike")){const rule={key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.swashbuckler.preciseStrike",value:1};source2.system.rules.push(rule)}else if(slug==="inventor-dedication"&&!source2.system.rules.some(r2=>r2.key==="Note"))source2.system.rules.push(this.#explodeAELike,...this.#unstableCheckNotes);else if(slug==="megaton-strike"){const rules=[{key:"RollOption",option:"megaton",predicate:[{not:"feature:construct-innovation"}],suboptions:[{label:"PF2E.SpecificRule.Inventor.Unstable.Stable",value:"stable"},{label:"PF2E.TraitUnstable",value:"unstable"}],toggleable:!0},{key:"AdjustStrike",mode:"add",predicate:["megaton:unstable"],property:"traits",value:"unstable"},{key:"DamageDice",predicate:["megaton:stable",{or:[{and:["feature:weapon-innovation","item:id:{actor|flags.pf2e.innovationId}"]},{and:["feature:armor-innovation","item:melee"]}]}],selector:"strike-damage",diceNumber:"ternary(gte(@actor.level, 18), 3, ternary(gte(@actor.level, 10), 2, 1))"},{key:"DamageDice",predicate:["megaton:unstable",{or:[{and:["feature:weapon-innovation","item:id:{actor|flags.pf2e.innovationId}"]},{and:["feature:armor-innovation","item:melee"]}]}],selector:"strike-damage",diceNumber:"ternary(gte(@actor.level, 18), 4, ternary(gte(@actor.level, 10), 3, 2))"}];source2.system.rules=rules}else if(slug==="munitions-crafter"){const craftingRule=source2.system.rules.find(r2=>r2.key==="CraftingEntry");craftingRule&&(craftingRule.batchSizes={other:[{definition:["item:category:ammo","item:trait:alchemical","item:level:0"],quantity:10}]},craftingRule.craftableItems=["item:trait:alchemical",{or:["item:trait:bomb","item:category:ammo"]}])}else if(slug==="precise-strike"&&!source2.system.rules.some(r2=>r2.key==="ActiveEffectLike")){const rule={key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.swashbuckler.preciseStrike",predicate:["class:swashbuckler"],value:"ceil(@actor.level/4) + 1"};source2.system.rules.push(rule)}}}class Migration917ScrollWandSpellIds extends MigrationBase{static{__name(this,"Migration917ScrollWandSpellIds")}static{__name2(this,"Migration917ScrollWandSpellIds")}static version=.917;async updateItem(source2){if(source2.type!=="consumable"||["scroll","wand"].includes(source2.system.slug??""))return;const sourceId=source2.system.spell?.flags?.core?.sourceId??source2.system.spell?._stats?.compendiumSource;!source2.system.spell||!sourceId?source2.system.spell=null:source2.system.spell._id??=foundry.utils.randomID()}}class Migration918DeitySkills extends MigrationBase{static{__name(this,"Migration918DeitySkills")}static{__name2(this,"Migration918DeitySkills")}static version=.918;async updateItem(source2){source2.type==="deity"&&(source2.system.skill=(typeof source2.system.skill=="string"?[SKILL_DICTIONARY[source2.system.skill]]:source2.system.skill??[]).filter(e$1))}}class Migration919WeaponToggleStructure extends MigrationBase{static{__name(this,"Migration919WeaponToggleStructure")}static{__name2(this,"Migration919WeaponToggleStructure")}static version=.919;#updateToggle(toggle){e$2(toggle)&&"selection"in toggle&&(toggle.selected=toggle.selection??null,toggle["-=selection"]=null)}async updateItem(source2){if(source2.type==="weapon"&&source2.system.traits.toggles)for(const trait of["modular","versatile"])this.#updateToggle(source2.system.traits.toggles[trait]);else source2.type==="shield"&&source2.system.traits.integrated&&this.#updateToggle(source2.system.traits.integrated?.versatile)}}class Migration920SuboptionSelection extends MigrationBase{static{__name(this,"Migration920SuboptionSelection")}static{__name2(this,"Migration920SuboptionSelection")}static version=.92;async updateItem(source2,actorSource){const suboptionREs=source2.system.rules.filter(r2=>"suboptions"in r2&&Array.isArray(r2.suboptions)&&r2.suboptions.some(s=>e$2(s)&&typeof s.selected=="boolean"));for(const rule of suboptionREs)for(const suboption of rule.suboptions)suboption.selected&&actorSource&&(rule.selection=suboption.value),delete suboption.selected}}class Migration921SpellSlotArrays extends MigrationBase{static{__name(this,"Migration921SpellSlotArrays")}static{__name2(this,"Migration921SpellSlotArrays")}static version=.921;async updateItem(source2){if(source2.type==="spellcastingEntry")for(const slotGroup of Object.values(source2.system.slots))slotGroup.prepared&&=Object.values(slotGroup.prepared).filter(e$1)}}class Migration922SwashbucklerFinishers extends MigrationBase{static{__name(this,"Migration922SwashbucklerFinishers")}static{__name2(this,"Migration922SwashbucklerFinishers")}static version=.922;async updateItem(source2){const slug=source2.system.slug;if(slug){if(source2.type==="action")(slug==="basic-finisher"||slug==="confident-finisher")&&(source2.system.rules.some(r2=>"mergeable"in r2)||source2.system.rules.push(this.#buildRule(slug)));else if(source2.type==="feat"){const featSlugs=["bleeding-finisher","dual-finisher","impaling-finisher","lethal-finisher","mobile-finisher","perfect-finisher","stunning-finisher","targeting-finisher","unbalancing-finisher"];source2.system.rules.some(r2=>"mergeable"in r2)||featSlugs.includes(slug)&&source2.system.rules.push(this.#buildRule(slug)),slug==="precise-strike"&&(source2.system.rules=source2.system.rules.filter(r2=>!("option"in r2&&r2.option==="finisher")))}}}#buildRule(slug){const name2=sluggify(slug,{camel:"bactrian"}).replace("Finisher","");return{disabledIf:[{not:"self:effect:panache"}],disabledValue:!1,domain:"all",key:"RollOption",label:"PF2E.SpecificRule.Swashbuckler.Finisher.Label",mergeable:!0,option:"finisher",suboptions:[{label:`PF2E.SpecificRule.Swashbuckler.Finisher.${name2}`,value:`${slug.replace("-finisher","")}`}],toggleable:!0}}}class Migration923KineticistRestructure extends MigrationBase{static{__name(this,"Migration923KineticistRestructure")}static{__name2(this,"Migration923KineticistRestructure")}static version=.923;async updateActor(actorSource){if(actorSource.type!=="character"||actorSource.items.some(i=>tupleHasValue(i.system.traits?.otherTags??[],"kineticist-kinetic-gate")))return;const actorFeats=actorSource.items.filter(i=>itemIsOfType(i,"feat")),kineticGate=actorFeats.find(i=>(i.system.slug??sluggify(i.name))==="kinetic-gate"),impulses=actorFeats.find(i=>(i.system.slug??sluggify(i.name))==="impulses");if(!kineticGate||!impulses)return;const decisions=this.#extractKineticistDecisions(actorSource,kineticGate);impulses.system.rules=[{extends:"kineticist",key:"SpecialStatistic",label:"PF2E.TraitImpulse",slug:"impulse",type:"attack-roll"},{key:"GrantItem",uuid:"Compendium.pf2e.actionspf2e.Item.6lbr0Jnv0zMB5uGb",flag:"elementalBlast"},{key:"GrantItem",predicate:["class:kineticist"],uuid:"Compendium.pf2e.actionspf2e.Item.nTBrvt2b9wngyr0i",flag:"baseKinesis"}];const gateJunction=actorSource.items.find(i=>(i.system.slug??sluggify(i.name))==="gate-junction"),gateJunctionIdx=gateJunction?actorSource.items.indexOf(gateJunction):-1;gateJunctionIdx>=0&&actorSource.items.splice(gateJunctionIdx,1);const junctionFeats=actorFeats.filter(f=>f.flags.pf2e?.grantedBy?.id===gateJunction?._id),connectSkillFeats=__name2((element,elementFeat)=>{const skillFeat=junctionFeats.find(s=>s.system.slug===this.#elementSkillFeats[element]);skillFeat&&this.#addGrantedItem(actorSource,{parent:elementFeat,child:skillFeat})},"connectSkillFeats");kineticGate.name=kineticGate.name.replace(/\s*\(\w+\)$/,"").replace(/\s*\(\w+\)$/,""),kineticGate.system.rules=t$7(KINETIC_GATE_RULES),this.#setChoice(kineticGate,"kinetic-gate:initial",decisions.initial.choice),this.#wipeGrants(kineticGate);for(const[idx,data]of decisions.initial.elements.entries()){const{element,feats}=data,elementNumberString=idx===0?"One":"Two",uuid=this.#elementMap.get(element);uuid&&this.#setChoice(kineticGate,`element${elementNumberString}`,uuid);const elementFeat=uuid?await this.#loadFeatSource(uuid):null;if(!elementFeat)continue;const grantUUID=`{item|flags.pf2e.rulesSelections.element${elementNumberString}}`;this.#addGrantedItem(actorSource,{parent:kineticGate,child:elementFeat,grantUUID});for(const[idx2,feat]of feats.entries()){const impulseNumberString=idx2===0?"One":"Two";this.#setChoice(elementFeat,`impulse${impulseNumberString}`,feat._stats.compendiumSource),this.#addGrantedItem(actorSource,{parent:elementFeat,child:feat,grantUUID:`{item|flags.pf2e.rulesSelections.impulse${impulseNumberString}}`})}connectSkillFeats(element,elementFeat),this.#wipeEmptyChoices(elementFeat)}for(const threshold of decisions.thresholds){const{thresholdItem,element}=threshold;if(thresholdItem.system.rules=GATES_THRESHOLD_RULES(thresholdItem.system.level.value),this.#wipeGrants(thresholdItem),this.#setChoice(thresholdItem,"threshold",threshold.choice),threshold.slug!=="gates-threshold"){const thisThreshold=threshold.slug.replace("gates-","");recursiveReplaceString(thresholdItem.system.rules,str=>str.replace("first-threshold",thisThreshold))}const elementLabel=game.i18n.localize(CONFIG.PF2E.elementTraits[element]);if(threshold.choice==="fork"){thresholdItem.name=game.i18n.format("PF2E.SpecificRule.Kineticist.KineticGate.ForkThePath.Rename",{elementFork:elementLabel});const uuid=this.#elementMap.get(element),elementFeat=uuid?await this.#loadFeatSource(uuid):null;if(!elementFeat)continue;this.#setChoice(thresholdItem,"elementFork",uuid),this.#addGrantedItem(actorSource,{parent:thresholdItem,child:elementFeat,grantUUID:"{item|flags.pf2e.rulesSelections.elementFork}"}),threshold.featItem&&(this.#setChoice(elementFeat,"impulseOne",threshold.featItem._stats.compendiumSource),this.#addGrantedItem(actorSource,{parent:elementFeat,child:threshold.featItem,grantUUID:"{item|flags.pf2e.rulesSelections.impulseOne}"})),connectSkillFeats(element,elementFeat),this.#wipeEmptyChoices(elementFeat)}if(threshold.choice==="expand"){thresholdItem.name=game.i18n.format("PF2E.SpecificRule.Kineticist.KineticGate.ExpandThePortal.Rename",{elementOne:elementLabel}),this.#setChoice(thresholdItem,"elementOne",element);const gateJunctionFeat=await this.#loadFeatSource(this.#gateJunctionFeat);if(gateJunctionFeat&&threshold.junction&&(gateJunctionFeat.system.rules=GATE_JUNCTION_RULES(element),this.#addGrantedItem(actorSource,{parent:thresholdItem,child:gateJunctionFeat}),this.#setChoice(gateJunctionFeat,"junction",threshold.junction),objectHasKey(JUNCTION_LABELS,threshold.junction))){const label=game.i18n.localize(JUNCTION_LABELS[threshold.junction]);gateJunctionFeat.name+=` (${label})`}threshold.featItem&&(this.#setChoice(thresholdItem,"impulseExpand",threshold.featItem._stats.compendiumSource),this.#addGrantedItem(actorSource,{parent:thresholdItem,child:threshold.featItem,grantUUID:"{item|flags.pf2e.rulesSelections.impulseExpand}"})),gateJunctionFeat&&this.#wipeEmptyChoices(gateJunctionFeat)}}}#elementMap=new Map([["air","Compendium.pf2e.classfeatures.Item.X11Y3T1IzmtNqGMV"],["earth","Compendium.pf2e.classfeatures.Item.dEm00L1XFXFCH2wS"],["fire","Compendium.pf2e.classfeatures.Item.PfeDtJBJdUun0THS"],["metal","Compendium.pf2e.classfeatures.Item.21JjdNW0RQ2LfaH3"],["water","Compendium.pf2e.classfeatures.Item.MvunDFH8Karxee0t"],["wood","Compendium.pf2e.classfeatures.Item.8X8db58vKx21L0Dr"]]);#elementSkillFeats={air:"experienced-smuggler",earth:"hefty-hauler",fire:"intimidating-glare",metal:"quick-repair",water:"underwater-marauder",wood:"terrain-expertise"};#gateJunctionFeat="Compendium.pf2e.classfeatures.Item.jx70hPakuTgB3lM5";async#loadFeatSource(uuid){const source2=(await fromUuid(uuid))?.toObject(!0)??null;return!source2||!itemIsOfType(source2,"feat")?null:(source2._id=foundry.utils.randomID(),source2)}#addGrantedItem(actorSource,options){const{child:child2,parent}=options;if(!parent._id||!child2._id)return;const childSlug=sluggify(child2.system.slug??child2.name,{camel:"dromedary"});parent.flags.pf2e??={},parent.flags.pf2e.itemGrants??={},parent.flags.pf2e.itemGrants[childSlug]={id:child2._id,onDelete:"detach"},`-=${childSlug}`in parent.flags.pf2e.itemGrants&&delete parent.flags.pf2e.itemGrants[`-=${childSlug}`],child2.flags.pf2e??={},child2.flags.pf2e.grantedBy={id:parent._id,onDelete:"cascade"};const grantUUID=options.grantUUID??child2._stats.compendiumSource,grant=parent.system.rules.find(r2=>r2.key==="GrantItem"&&"uuid"in r2&&r2.uuid===grantUUID);grant&&(grant.flag=childSlug),actorSource.items.includes(child2)||actorSource.items.push(child2)}#wipeGrants(item){if(!item?.flags.pf2e?.itemGrants)return;const grants=item.flags.pf2e.itemGrants;for(const key of Object.keys(grants))key.startsWith("-=")||(grants[`-=${key}`]=null)}#wipeEmptyChoices(item){item.system.rules=item.system.rules.filter(r2=>r2.key!=="ChoiceSet"||"selection"in r2&&r2.selection)}#setChoice(item,flagOrOption,selection){const rule=item?.system.rules.find(r2=>r2.key==="ChoiceSet"&&("flag"in r2&&r2.flag===flagOrOption||"rollOption"in r2&&r2.rollOption===flagOrOption));rule&&selection&&(rule.selection=selection)}#extractKineticistDecisions(actorSource,kineticGate){function getChoice(item,flag){const selection=item?.system.rules.find(r2=>r2.key==="ChoiceSet"&&"flag"in r2&&r2.flag===flag)?.selection;return selection?String(selection):null}__name(getChoice,"getChoice"),__name2(getChoice,"getChoice");const thresholdSlugs=["gates-threshold","second-gates-threshold","third-gates-threshold","fourth-gates-threshold"],actorFeats=actorSource.items.filter(i=>itemIsOfType(i,"feat")),initialChoice=getChoice(kineticGate,"kineticGate")==="dual-gate"?"dual-gate":"single-gate",elements=[getChoice(kineticGate,"elementOne"),getChoice(kineticGate,"elementTwo")].filter(e$1),initialFeats=actorFeats.filter(i=>i.flags.pf2e?.grantedBy?.id===kineticGate._id&&tupleHasValue(i.system.traits.value??[],"impulse"));return{initial:{choice:initialChoice,elements:elements.map((element,idx)=>({element,feats:elements.length===1?initialFeats:[initialFeats[idx]]}))},thresholds:thresholdSlugs.map(slug=>{const thresholdItem=actorFeats.find(i=>(i.system.slug??sluggify(i.name))===slug);if(!thresholdItem)return null;const choice=getChoice(thresholdItem,sluggify(slug,{camel:"dromedary"}));if(!tupleHasValue(["fork","expand"],choice))return null;const element=getChoice(thresholdItem,choice==="expand"?"elementExpand":"elementFork")??getChoice(thresholdItem,"element")??getChoice(thresholdItem,"elementExpand")??getChoice(thresholdItem,"elementFork");return element?{slug,thresholdItem,choice,element,junction:choice==="expand"?getChoice(thresholdItem,"junction"):null,featItem:actorFeats.find(i=>i.flags.pf2e?.grantedBy?.id===thresholdItem._id&&tupleHasValue(i.system.traits.value??[],"impulse"))}:null}).filter(e$1)}}}const JUNCTION_LABELS={aura:"PF2E.SpecificRule.Kineticist.KineticGate.Junction.Aura",critical:"PF2E.SpecificRule.Kineticist.KineticGate.Junction.CriticalBlast",resistance:"PF2E.SpecificRule.Kineticist.KineticGate.Junction.ElementalResistance",impulse:"PF2E.SpecificRule.Kineticist.KineticGate.Junction.Impulse",skill:"PF2E.SpecificRule.Kineticist.KineticGate.Junction.Skill"},KINETIC_GATE_RULES=[{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.kineticist.elements",priority:19,value:[]},{key:"ActiveEffectLike",mode:"override",path:"flags.pf2e.kineticist.gate",priority:49,value:{five:null,four:null,one:null,six:null,three:null,two:null}},{adjustName:!1,choices:[{label:"PF2E.SpecificRule.Kineticist.KineticGate.DualGate.Label",value:"dual-gate"},{label:"PF2E.SpecificRule.Kineticist.KineticGate.SingleGate",value:"single-gate"}],key:"ChoiceSet",prompt:"PF2E.SpecificRule.Kineticist.KineticGate.Prompt.Gate",flag:"kineticGate",rollOption:"kinetic-gate:initial"},{adjustName:!1,choices:{filter:["item:tag:kineticist-kinetic-gate"]},flag:"elementOne",key:"ChoiceSet",prompt:"PF2E.SpecificRule.Kineticist.KineticGate.Prompt.Element",rollOption:"kinetic-gate:first-element"},{key:"GrantItem",uuid:"{item|flags.pf2e.rulesSelections.elementOne}"},{adjustName:!1,choices:{filter:["item:tag:kineticist-kinetic-gate"]},flag:"elementTwo",key:"ChoiceSet",predicate:["kinetic-gate:initial:dual-gate"],prompt:"PF2E.SpecificRule.Kineticist.KineticGate.Prompt.Element",rollOption:"kinetic-gate:second-element"},{key:"GrantItem",uuid:"{item|flags.pf2e.rulesSelections.elementTwo}"},{domain:"all",key:"RollOption",option:"junction:{item|flags.pf2e.rulesSelections.elementOne}:impulse",predicate:["kinetic-gate:initial:single-gate"]}],GATES_THRESHOLD_RULES=__name2(level=>[{choices:[{label:"PF2E.SpecificRule.Kineticist.KineticGate.ExpandThePortal.Label",value:"expand"},{label:"PF2E.SpecificRule.Kineticist.KineticGate.ForkThePath.Label",value:"fork"}],key:"ChoiceSet",prompt:"PF2E.SpecificRule.Kineticist.KineticGate.Prompt.Threshold",rollOption:"kinetic-gate:first-threshold",flag:"threshold"},{actorFlag:!0,adjustName:"PF2E.SpecificRule.Kineticist.KineticGate.ExpandThePortal.Rename",choices:"flags.pf2e.kineticist.elements",flag:"elementOne",key:"ChoiceSet",predicate:["kinetic-gate:first-threshold:expand"],prompt:"PF2E.SpecificRule.Kineticist.KineticGate.Prompt.ExpandElement"},{key:"GrantItem",predicate:["kinetic-gate:first-threshold:expand"],uuid:"Compendium.pf2e.classfeatures.Item.jx70hPakuTgB3lM5"},{adjustName:"PF2E.SpecificRule.Kineticist.KineticGate.ForkThePath.Rename",choices:{filter:["item:tag:kineticist-kinetic-gate"]},flag:"elementFork",key:"ChoiceSet",predicate:["kinetic-gate:first-threshold:fork"],prompt:"PF2E.SpecificRule.Kineticist.KineticGate.Prompt.Element"},{allowDuplicate:!1,key:"GrantItem",uuid:"{item|flags.pf2e.rulesSelections.elementFork}"},{adjustName:!1,choices:{filter:["item:rarity:common","item:trait:impulse",{lte:["item:level",level]},{or:[{and:[{or:["item:trait:{actor|flags.pf2e.kineticist.gate.one}","item:trait:{actor|flags.pf2e.kineticist.gate.two}","item:trait:{actor|flags.pf2e.kineticist.gate.three}","item:trait:{actor|flags.pf2e.kineticist.gate.four}","item:trait:{actor|flags.pf2e.kineticist.gate.five}","item:trait:{actor|flags.pf2e.kineticist.gate.six}"]},{not:"item:trait:composite"}]},{and:[{not:{xor:["item:trait:{actor|flags.pf2e.kineticist.gate.one}","item:trait:{actor|flags.pf2e.kineticist.gate.two}","item:trait:{actor|flags.pf2e.kineticist.gate.three}","item:trait:{actor|flags.pf2e.kineticist.gate.four}","item:trait:{actor|flags.pf2e.kineticist.gate.five}","item:trait:{actor|flags.pf2e.kineticist.gate.six}"]}},{or:["item:trait:{actor|flags.pf2e.kineticist.gate.one}","item:trait:{actor|flags.pf2e.kineticist.gate.two}","item:trait:{actor|flags.pf2e.kineticist.gate.three}","item:trait:{actor|flags.pf2e.kineticist.gate.four}","item:trait:{actor|flags.pf2e.kineticist.gate.five}","item:trait:{actor|flags.pf2e.kineticist.gate.six}"]}]}]}],itemType:"feat"},flag:"impulseExpand",key:"ChoiceSet",predicate:["kinetic-gate:first-threshold:expand"],prompt:"PF2E.SpecificRule.Kineticist.KineticGate.Prompt.Impulse"},{allowDuplicate:!1,key:"GrantItem",uuid:"{item|flags.pf2e.rulesSelections.impulseExpand}"}],"GATES_THRESHOLD_RULES"),GATE_JUNCTION_RULES=__name2(element=>[{choices:[{label:"PF2E.SpecificRule.Kineticist.KineticGate.Junction.Aura",predicate:[{not:`junction:${element}:aura`}],value:"aura"},{label:"PF2E.SpecificRule.Kineticist.KineticGate.Junction.CriticalBlast",predicate:[{not:`junction:${element}:critical`}],value:"critical"},{label:"PF2E.SpecificRule.Kineticist.KineticGate.Junction.ElementalResistance",predicate:[{not:`junction:${element}:resistance`}],value:"resistance"},{label:"PF2E.SpecificRule.Kineticist.KineticGate.Junction.Impulse",predicate:[{not:`junction:${element}:impulse`}],value:"impulse"},{label:"PF2E.SpecificRule.Kineticist.KineticGate.Junction.Skill",predicate:[{not:`junction:${element}:skill`}],value:"skill"}],flag:"junction",key:"ChoiceSet",prompt:"PF2E.SpecificRule.Kineticist.KineticGate.Prompt.Junction"},{domain:"all",key:"RollOption",option:`junction:${element}:{item|flags.pf2e.rulesSelections.junction}`}],"GATE_JUNCTION_RULES");class Migration924JiuHuanDoa extends MigrationBase{static{__name(this,"Migration924JiuHuanDoa")}static{__name2(this,"Migration924JiuHuanDoa")}static version=.924;#nineRingSword={slug:"nine-ring-sword",name:"Nine-Ring Sword"};#jiuHuanDao={slug:"jiu-huan-dao",name:"game"in globalThis?game.i18n.localize(CONFIG.PF2E.baseWeaponTypes["jiu-huan-dao"]):"Jiu Huan Dao"};async updateItem(source2){if(source2.system.rules=source2.system.rules.map(r2=>recursiveReplaceString(r2,s=>s.replace(/^nine-ring-sword$/,this.#jiuHuanDao.slug))),source2.type==="deity"){const system2=source2.system;system2.weapons=system2.weapons.map(w=>w===this.#nineRingSword.slug?this.#jiuHuanDao.slug:w)}else if(source2.type==="weapon"){source2.system.slug===this.#jiuHuanDao.slug&&source2.system.bulk.value===0&&(source2.system.bulk.value=1);const system2=source2.system;if(system2.baseItem!=="nine-ring-sword")return;system2.slug=system2.slug===this.#nineRingSword.slug?this.#jiuHuanDao.slug:system2.slug,system2.baseItem=this.#jiuHuanDao.slug,source2.name==="Nine-Ring Sword"&&(source2.name=this.#jiuHuanDao.name)}}}class Migration925TouchOfCorruption extends MigrationBase{static{__name(this,"Migration925TouchOfCorruption")}static{__name2(this,"Migration925TouchOfCorruption")}static version=.925;async updateItem(source2){itemIsOfType(source2,"effect","spell")&&(source2.system.description=recursiveReplaceString(source2.system.description,s=>s.replace(/\bekGHLJSHGgWMUwkY\b/g,"jFmWSIpJGGebim6y")))}}class Migration926RemoveVisionFeatureLinks extends MigrationBase{static{__name(this,"Migration926RemoveVisionFeatureLinks")}static{__name2(this,"Migration926RemoveVisionFeatureLinks")}static version=.926;async updateItem(source2){source2.system.description=recursiveReplaceString(source2.system.description,s=>s.replaceAll("@UUID[Compendium.pf2e.ancestryfeatures.Item.HHVQDp61ehcpdiU8]{Darkvison}","Darkvision").replaceAll("@UUID[Compendium.pf2e.ancestryfeatures.Item.DRtaqOHXTRtGRIUT]{Low-Light Vision}","Low-Light Vision").replaceAll("@UUID[Compendium.pf2e.ancestryfeatures.HHVQDp61ehcpdiU8]{Darkvison}","Darkvision").replaceAll("@UUID[Compendium.pf2e.ancestryfeatures.DRtaqOHXTRtGRIUT]{Low-Light Vision}","Low-Light Vision").replaceAll("@Compendium[pf2e.ancestryfeatures.HHVQDp61ehcpdiU8]{Darkvison}","Darkvision").replaceAll("@Compendium[pf2e.ancestryfeatures.DRtaqOHXTRtGRIUT]{Low-Light Vision}","Low-Light Vision"))}}class Migration928CharacterSkillsLongform extends MigrationBase{static{__name(this,"Migration928CharacterSkillsLongform")}static{__name2(this,"Migration928CharacterSkillsLongform")}static version=.928;#SKILL_SHORT_FORM_PATH=(()=>{const skillShortForms=SKILL_ABBREVIATIONS$1.join("|");return new RegExp(String.raw`system\.skills\.(${skillShortForms})\b`,"g")})();#SKILL_SHORT_FORM_OPTION=(()=>{const skillShortForms=SKILL_ABBREVIATIONS$1.join("|");return new RegExp(String.raw`skill:(${skillShortForms})\b`,"g")})();async updateActor(source2){if(this.#replacePathsAndOptions(source2),source2.type!=="character")return;const system2=source2.system;for(const[key,value]of Object.entries(system2.skills))objectHasKey(SKILL_DICTIONARY,key)&&value!==null&&(system2.skills[SKILL_DICTIONARY[key]]=value,system2.skills[`-=${key}`]=null)}async updateItem(source2){for(const rule of source2.system.rules)rule.key==="ActiveEffectLike"&&"path"in rule&&typeof rule.path=="string"&&(rule.path=rule.path.replace(/^data\./,"system."));this.#replacePathsAndOptions(source2)}#replacePathsAndOptions(source2){source2.system=recursiveReplaceString(source2.system,s=>s.replace(this.#SKILL_SHORT_FORM_PATH,(match,group)=>objectHasKey(SKILL_DICTIONARY,group)?`system.skills.${SKILL_DICTIONARY[group]}`:match)),source2.system=recursiveReplaceString(source2.system,s=>s.replace(this.#SKILL_SHORT_FORM_OPTION,(match,group)=>objectHasKey(SKILL_DICTIONARY,group)?`skill:${SKILL_DICTIONARY[group]}`:match))}}const capitalize=__name2(s=>s[0].toUpperCase()+s.slice(1),"capitalize");class Migration929RemoveSkillAbbreviations extends MigrationBase{static{__name(this,"Migration929RemoveSkillAbbreviations")}static{__name2(this,"Migration929RemoveSkillAbbreviations")}static version=.929;#SKILL_LOCALIZATION=(()=>{const skillSlugs=[...CORE_SKILL_SLUGS,...SKILL_ABBREVIATIONS$1].map(capitalize).join("|");return new RegExp(String.raw`PF2E.Skill(${skillSlugs})\b`,"g")})();#SKILL_SHORT_FORM_OPTION_PATH=(()=>{const skillShortForms=SKILL_ABBREVIATIONS$1.join("|");return new RegExp(String.raw`\b([\w-]+):(${skillShortForms})(?=:|$)`,"g")})();async updateItem(source2){source2.system.rules=recursiveReplaceString(source2.system.rules,s=>s.replace(this.#SKILL_LOCALIZATION,(_match,group)=>`PF2E.Skill.${capitalize(resolveLongForm(group.toLowerCase()))}`));for(const rule of source2.system.rules)rule.key==="ActiveEffectLike"?this.#transformAELike(rule):rule.key==="BattleForm"?this.#transformBattleFormPart2(rule):rule.key==="ChoiceSet"?this.#transformChoiceSet(rule):rule.key==="RollOption"&&this.#transformRollOption(rule);const invalidOptions=source2.system.rules.filter(s=>s?.key==="ChoiceSet").filter(r2=>!!r2.rollOption&&isSizeChoice(r2)).map(r2=>r2.rollOption);source2.system.rules=recursiveReplaceString(source2.system.rules,s=>s.replace(this.#SKILL_SHORT_FORM_OPTION_PATH,(match,option,value)=>invalidOptions.includes(option)||value==="med"&&String(option).includes("size")?match:objectHasKey(SKILL_DICTIONARY,value)?`${option}:${SKILL_DICTIONARY[value]}`:match))}#transformAELike(rule){rule.value&&(rule.value=recursiveReplaceString(rule.value,s=>resolveLongForm(s)))}#transformBattleFormPart2(rule){if("value"in rule&&rule.value&&typeof rule.value=="object"&&"brackets"in rule.value&&Array.isArray(rule.value.brackets))for(const bracket of rule.value.brackets){const overrides="value"in bracket?bracket.value:null;if(!overrides?.skills)continue;const skills=overrides.skills;for(const[key,value]of Object.entries(skills))objectHasKey(SKILL_DICTIONARY,key)&&(skills[SKILL_DICTIONARY[key]]=value,delete skills[key])}}#transformChoiceSet(rule){if(isSizeChoice(rule))return;objectHasKey(SKILL_DICTIONARY,rule.selection)&&(rule.selection=SKILL_DICTIONARY[rule.selection]);const choices=rule.choices?rule.choices:null;if(Array.isArray(choices))for(const choice of choices)typeof choice=="object"&&choice.value&&(choice.value=recursiveReplaceString(choice.value,s=>resolveLongForm(s)))}#transformRollOption(rule){if(rule.value&&(rule.value=resolveLongForm(rule.value)),Array.isArray(rule.suboptions))for(const sub of rule.suboptions)sub&&typeof sub=="object"&&"value"in sub&&(sub.value=resolveLongForm(sub.value))}}function isSizeChoice(rule){const choices=rule.choices?rule.choices:null;return Array.isArray(choices)?choices.some(choice=>!choice||typeof choice!="object"?!1:!!(choice.value!=="med"&&tupleHasValue(SIZES,choice.value)||choice.label?.startsWith("PF2E.ActorSize"))):!1}__name(isSizeChoice,"isSizeChoice"),__name2(isSizeChoice,"isSizeChoice");function resolveLongForm(value){return objectHasKey(SKILL_DICTIONARY,value)?SKILL_DICTIONARY[value]:value}__name(resolveLongForm,"resolveLongForm"),__name2(resolveLongForm,"resolveLongForm");class Migration930ChoiceSetMedium extends MigrationBase{static{__name(this,"Migration930ChoiceSetMedium")}static{__name2(this,"Migration930ChoiceSetMedium")}static version=.93;async updateItem(source2){for(const rule of source2.system.rules){if(!isChoiceSource(rule))continue;const isSize=isSizeChoice(rule);isSize&&rule.selection==="medicine"&&(rule.selection="med"),!isSize&&rule.selection&&typeof rule.selection=="object"&&(rule.selection=recursiveReplaceString(rule.selection,s=>resolveLongForm(s)))}}}function isChoiceSource(source2){return source2.key==="ChoiceSet"}__name(isChoiceSource,"isChoiceSource"),__name2(isChoiceSource,"isChoiceSource");class Migration931ExpandREPermissions extends MigrationBase{static{__name(this,"Migration931ExpandREPermissions")}static{__name2(this,"Migration931ExpandREPermissions")}static version=.931;async migrate(){const playerAccess=game.settings.storage.get("world").getItem("pf2e.enabledRulesUI");game.settings.set("pf2e","minimumRulesUI",playerAccess?1:3)}}class Migration932NPCSystemSkills extends MigrationBase{static{__name(this,"Migration932NPCSystemSkills")}static{__name2(this,"Migration932NPCSystemSkills")}static version=.932;#MOD_STRING_RE=/^\+(\d+)\s(.*)/;async updateActor(source2){if(source2.type!=="npc")return;const skillLores=source2.items.filter(i=>i.type==="lore"&&setHasElement(CORE_SKILL_SLUGS,sluggify(i.name)));if(skillLores.length===0)return;source2.system.skills??={};for(const lore of skillLores){const skillSlug=sluggify(lore.name);if(typeof source2.system.skills[skillSlug]?.base=="number")continue;const base=lore.system.mod.value,skill={base};source2.system.skills[skillSlug]=skill;const rollOptions=lore.system.rules.filter(r2=>r2.key==="RollOption").filter(r2=>r2.toggleable===!0);for(const option of rollOptions)for(const item of source2.items.filter(i=>i.type==="action"))option.option===(item.system.slug??sluggify(item.name))&&item.system.rules.push(option);const flatModifiers=lore.system.rules.filter(r2=>r2.key==="FlatModifier").filter(r2=>{if(typeof r2.value=="string"&&r2.value.trim()==="")return!1;const value=Number(r2.value);return Number.isNaN(value)?!1:(r2.value=value,!0)}),specialModifiers=[];for(const v of Object.values(lore.system.variants??{})){if(!/\d/.exec(v.label)){skill.note=v.label;continue}const match=this.#MOD_STRING_RE.exec(v.label),[modFromString,label]=match?[Number(match[1]),match[2]]:[null,v.label],possibleModifiers=flatModifiers.filter(m=>Array.isArray(m.selector)?m.selector.includes(skillSlug):m.selector===skillSlug),modifier=modFromString?possibleModifiers.find(m=>m.value===modFromString-base):possibleModifiers.at(0),variant={label,base:modFromString??(modifier?base+modifier.value:0)};Array.isArray(modifier?.predicate)&&modifier.predicate.length>0&&(variant.predicate=modifier.predicate),specialModifiers.push(variant)}specialModifiers.length&&(skill.special=specialModifiers)}const itemsToRemove=new Set(skillLores.map(s=>s._id));source2.items=source2.items.filter(i=>!itemsToRemove.has(i._id))}}class Migration933CraftingAbility extends MigrationBase{static{__name(this,"Migration933CraftingAbility")}static{__name2(this,"Migration933CraftingAbility")}static version=.933;async updateActor(source2){if(source2.type!=="character")return;const system2=source2.system;system2.crafting?.formulas?.some(f=>"sort"in f)&&(system2.crafting.formulas=system2.crafting.formulas.sort(f=>f.sort??0).map(f=>f))}async updateItem(source2){source2.system.rules.some(r2=>r2.key==="CraftingEntry")&&(source2.system.rules=source2.system.rules.map(r2=>{if(r2.key!=="CraftingEntry")return r2;const clone=foundry.utils.deepClone(r2);return this.#updateCraftingEntry(clone),clone}))}#updateCraftingEntry(source2){source2.key="CraftingAbility",source2.selector&&(source2.slug??=sluggify(source2.selector),delete source2.selector),"name"in source2&&(source2.label??=source2.name,delete source2.name);const prepared=source2.prepared??source2.preparedFormulas;prepared&&(source2.prepared=prepared.sort(f=>f.sort??0).map(f=>(f.itemUUID&&(f.uuid??=f.itemUUID),delete f.itemUUID,delete f.sort,f)),delete source2.preparedFormulas)}}class Migration934MythicCallingCategory extends MigrationBase{static{__name(this,"Migration934MythicCallingCategory")}static{__name2(this,"Migration934MythicCallingCategory")}static version=.934;async updateItem(source2){if(source2.type==="feat"&&source2.system.traits.value.includes("calling")){source2.system.category="calling";const tagIndex=source2.system.traits.otherTags?.indexOf("mythic-calling");tagIndex>=0&&source2.system.traits.otherTags.splice(tagIndex,1)}}}class Migration935DeityIconPaths extends MigrationBase{static{__name(this,"Migration935DeityIconPaths")}static{__name2(this,"Migration935DeityIconPaths")}static version=.935;#getUpdatedPath(path,{type:type2=null,slug=null}={}){return typeof path!="string"||!path.startsWith("systems/pf2e/icons/deity/")?path:["effect","feat"].includes(type2??"")&&slug?.match(/-(?:minor|moderate|major)-(?:boon|curse)$/)?`systems/pf2e/icons/deities/${slug.replace(/-(?:minor|moderate|major)-(?:boon|curse)$/,"")}.webp`:type2==="deity"&&slug?`systems/pf2e/icons/deities/${slug}.webp`:"systems/pf2e/icons/default-icons/deity.svg"}async updateActor(source2){source2.img=this.#getUpdatedPath(source2.img),source2.prototypeToken?.texture?.src&&(source2.prototypeToken.texture.src=this.#getUpdatedPath(source2.prototypeToken.texture.src))}async updateItem(source2){source2.img=this.#getUpdatedPath(source2.img,{type:source2.type,slug:source2.system.slug})}async updateToken(source2){source2.texture.src&&=this.#getUpdatedPath(source2.texture.src)}}class Migration936MoveWorldClockSettings extends MigrationBase{static{__name(this,"Migration936MoveWorldClockSettings")}static{__name2(this,"Migration936MoveWorldClockSettings")}static version=.936;async migrate(){const worldSettings=game.settings.storage.get("world"),worldCreatedOn=worldSettings.find(s=>s.key==="pf2e.worldClock.worldCreatedOn")?.value,dateTheme=worldSettings.find(s=>s.key==="pf2e.worldClock.dateTheme")?.value,playersCanView=worldSettings.find(s=>s.key==="pf2e.worldClock.playersCanView")?.value,showClockButton=worldSettings.find(s=>s.key==="pf2e.worldClock.showClockButton")?.value,syncDarkness=worldSettings.find(s=>s.key==="pf2e.worldClock.syncDarkness")?.value,timeConvention=worldSettings.find(s=>s.key==="pf2e.worldClock.timeConvention")?.value,setting=game.settings.get("pf2e","worldClock");worldCreatedOn&&e$2(setting)&&await game.settings.set("pf2e","worldClock",{...setting,worldCreatedOn,dateTheme:dateTheme??setting.dateTheme,playersCanView:playersCanView??setting.playersCanView,showClockButton:showClockButton??setting.showClockButton,syncDarkness:syncDarkness??setting.syncDarkness,timeConvention:timeConvention??setting.timeConvention})}}class Migration937RemoveInvalidAuraTraits extends MigrationBase{static{__name(this,"Migration937RemoveInvalidAuraTraits")}static{__name2(this,"Migration937RemoveInvalidAuraTraits")}static version=.937;static#_invalidTraits=null;static get#invalidTraits(){return this.#_invalidTraits?this.#_invalidTraits:(this.#_invalidTraits=new Set(Object.keys(actionTraits).filter(t2=>!(t2 in effectTraits))),this.#invalidTraits)}async updateItem(source2){for(const rule of source2.system.rules){if(!rule||rule.key!=="Aura"||!("traits"in rule)||!Array.isArray(rule.traits)||rule.traits.length===0)continue;const invalidTraits=Migration937RemoveInvalidAuraTraits.#invalidTraits,newTraits=rule.traits.filter(t2=>!invalidTraits.has(t2));newTraits.length===0?delete rule.traits:newTraits.length!==rule.traits.length&&(rule.traits=newTraits)}}}const regex=/icons\/commodities\/treasure\/broach-/;class Migration938RenameBroochesAndThroned extends MigrationBase{static{__name(this,"Migration938RenameBroochesAndThroned")}static{__name2(this,"Migration938RenameBroochesAndThroned")}static version=.938;async updateActor(source2){source2.img=this.#maybeReplace(source2.img)}async updateItem(source2){if(source2.img=this.#maybeReplace(source2.img),source2.system.rules=source2.system.rules.map(r2=>recursiveReplaceString(r2,s=>this.#maybeReplace(s))),source2.type==="kit")for(const value of Object.values(source2.system.items))value.img=this.#maybeReplace(value.img)}async updateTable(source2){source2.img&&(source2.img=this.#maybeReplace(source2.img));for(const result of source2.results??[])result.img&&(result.img=this.#maybeReplace(result.img))}async updateMacro(source2){source2.img&&(source2.img=this.#maybeReplace(source2.img))}async updateToken(tokenData){tokenData.texture?.src&&(tokenData.texture.src=this.#maybeReplace(tokenData.texture.src))}#maybeReplace(img2){return img2.replace(regex,match=>match.replace("broach","brooch")).replace("icons/magic/nature/vines-throned-entwined-glow-green.webp","icons/magic/nature/vines-thorned-entwined-glow-green.webp")}}class Migration939SetTokenDimensions extends MigrationBase{static{__name(this,"Migration939SetTokenDimensions")}static{__name2(this,"Migration939SetTokenDimensions")}static version=.939;async updateToken(source2,actor){const actorSize=actor?.system.traits?.size;if(!(actorSize instanceof ActorSizePF2e))return;const{width,height}=actorSize.tokenDimensions;source2.width=width,source2.height=height}}class Migration940WeaponExpend extends MigrationBase{static{__name(this,"Migration940WeaponExpend")}static{__name2(this,"Migration940WeaponExpend")}static version=.94;async updateItem(source2){if(source2.type!=="weapon"||(source2.system.reload.value===""&&(source2.system.reload.value=null),source2.system.expend??!1))return;const isThrown=source2.system.traits.value.includes("thrown"),isRanged=!!source2.system.range;if(source2.system.reload.value===null||isThrown||!isRanged){source2.system.expend=null,this.#removeExpendTraits(source2);return}const expendTrait=source2.system.traits.value.find(t2=>t2.match(/^expend-\d$/)),expendFromTrait=expendTrait?Number(expendTrait.replace("expend-","")):null;source2.system.expend=Math.max(1,expendFromTrait??1),this.#removeExpendTraits(source2)}#removeExpendTraits(source2){const filtered=source2.system.traits.value.filter(t2=>!t2.match(/^expend-\d$/));source2.system.traits.value.length!==filtered.length&&(source2.system.traits.value=filtered)}}class Migration941InvestedGrafts extends MigrationBase{static{__name(this,"Migration941InvestedGrafts")}static{__name2(this,"Migration941InvestedGrafts")}static version=.941;async updateItem(source2){if(!itemIsOfType(source2,"physical"))return;const isInvested=source2.system.equipped?.invested,isImplant=source2.system.usage?.value==="implanted";isInvested&&isImplant&&source2.system.equipped.carryType!=="implanted"&&(source2.system.equipped.carryType="implanted")}}class Migration942EquipmentGrade extends MigrationBase{static{__name(this,"Migration942EquipmentGrade")}static{__name2(this,"Migration942EquipmentGrade")}static version=.942;async updateItem(source2){if(source2.type!=="weapon"&&source2.type!=="armor")return;const isSF2eItem=source2.system.traits.value.some(t2=>["tech","analog"].includes(t2));if(source2.system.grade||!isSF2eItem)return;const grade=source2.type==="weapon"?weaponImprovements.findLast(f=>source2.system.runes.potency>=f.potency&&source2.system.runes.striking>=f.striking)?.slug:armorImprovements.findLast(f=>source2.system.runes.potency>=f.potency&&source2.system.runes.resilient>=f.resilient)?.slug;if(grade){const previousProperty=source2.system.runes.property;if(source2.system.grade=grade,source2.system.runes.potency=0,source2.system.runes.property=[],source2.type==="weapon"?source2.system.runes.striking=0:source2.system.runes.resilient=0,previousProperty.length&&"game"in globalThis){const runes=previousProperty.map(p=>{const weaponKey=`PF2E.WeaponPropertyRune.${p}.Name`,armorKey=`PF2E.ArmorPropertyRune${sluggify(p,{camel:"bactrian"})}`;return game.i18n.has(weaponKey)?game.i18n.localize(weaponKey):game.i18n.has(armorKey)?game.i18n.localize(armorKey):null});source2.system.description.value+=`<hr/>The following property runes were removed when migrating to a tech/analog weapon: ${runes.join(", ")}`}}}}const weaponImprovements=[{slug:"commercial",potency:0,striking:0},{slug:"tactical",potency:1,striking:0},{slug:"advanced",potency:1,striking:1},{slug:"superior",potency:2,striking:1},{slug:"elite",potency:2,striking:2},{slug:"ultimate",potency:3,striking:2},{slug:"paragon",potency:3,striking:3}],armorImprovements=[{slug:"commercial",potency:0,resilient:0},{slug:"tactical",potency:1,resilient:0},{slug:"advanced",potency:1,resilient:1},{slug:"superior",potency:2,resilient:1},{slug:"elite",potency:2,resilient:2},{slug:"ultimate",potency:3,resilient:2},{slug:"paragon",potency:3,resilient:3}];class Migration943UpdateSpeedPath extends MigrationBase{static{__name(this,"Migration943UpdateSpeedPath")}static{__name2(this,"Migration943UpdateSpeedPath")}static version=.943;async updateActor(source2){if(source2.type==="npc")return;const attributes=source2.system.attributes;e$2(attributes)&&"speed"in attributes&&e$2(attributes.speed)&&(attributes["-=speed"]=null)}async updateItem(source2){const landSpeedPath="system.movement.speeds.land";source2.system.rules=recursiveReplaceString(source2.system.rules,s=>s.replace(/\bsystem.attributes\.speed\.total\b/g,`${landSpeedPath}.value`).replace(/\bsystem.attributes\.speed\.value\b/g,`${landSpeedPath}.base`).replace(/\battributes\.speed\.total\b/g,`${landSpeedPath}.value`).replace(/\battributes\.speed\.value\b/g,`${landSpeedPath}.base`))}}class Migration944RmDamageDiceValue extends MigrationBase{static{__name(this,"Migration944RmDamageDiceValue")}static{__name2(this,"Migration944RmDamageDiceValue")}static version=.944;async updateItem(source2){const rules=source2.system.rules;for(const rule of rules)rule.key==="DamageDice"&&("brackets"in rule&&(rule.value??=rule.brackets,delete rule.brackets),typeof rule.value=="string"&&(rule.diceNumber=rule.value,delete rule.value))}}class Migration945REBracketsToStrings extends MigrationBase{static{__name(this,"Migration945REBracketsToStrings")}static{__name2(this,"Migration945REBracketsToStrings")}static version=.945;#moveDamageDiceValue(rule){if(rule.key!=="DamageDice"||!e$2(rule.value)||!Array.isArray(rule.value.brackets))return;const brackets=rule.value.brackets;for(let i=0;i<brackets.length;i++){const bracket=brackets[i];if(e$2(bracket)&&e$2(bracket.value)){const key=Object.keys(bracket.value)[0];key&&(bracket.value=bracket.value[key],rule[key]=rule.value)}}delete rule.value}#convertBracket(value){const normalized={field:String(value.field??"actor|level"),brackets:value.brackets.map(mysteryBracket=>{const value2=e$2(mysteryBracket.value)?Object.keys(mysteryBracket.value)[0]:mysteryBracket.value;if(typeof value2!="number"&&typeof value2!="string")return{value:JSON.stringify(value2),start:Number(mysteryBracket.start)||void 0,end:Number(mysteryBracket.end)||void 0};const bracket={value:typeof value2=="string"?value2.replace(/^\s*(@.+)(-)(\d)\s*$/,"$1$2 $3"):value2};return"start"in mysteryBracket&&(bracket.start=Number(mysteryBracket.start)||0),"end"in mysteryBracket&&(bracket.end=Number(mysteryBracket.end)||0),bracket})},field=normalized.field==="item|system.level.value"?"@item.level":`@${normalized.field.replace("|",".")}`;return`match(${normalized.brackets.map(bracket=>{const{start,end}=bracket,value2=typeof bracket.value=="number"||typeof bracket.value=="string"&&bracket.value.includes("@")?bracket.value:JSON.stringify(bracket.value);return typeof start=="number"&&typeof end=="number"?`when(btwn(${field}, ${start}, ${end}), ${value2})`:typeof start=="number"?`when(gte(${field}, ${start}), ${value2})`:typeof end=="number"?`when(lte(${field}, ${end}), ${value2})`:value2}).join(", ")})`}#convertBrackets(outer){for(const[key,inner]of Object.entries(outer))e$2(inner)?"brackets"in inner&&Array.isArray(inner.brackets)?outer[key]=this.#convertBracket(inner):outer[key]=this.#convertBrackets(inner):Array.isArray(inner)&&(outer[key]=inner.map(i=>e$2(i)?this.#convertBrackets(i):i));return outer}#convertBattleFormBrackets(rule){if(e$2(rule.overrides)){for(const override of t$8(rule.overrides))if(Array.isArray(override))for(const element of override)override.splice(override.indexOf(element),1,this.#convertBrackets(element))}if(e$2(rule.value)){if(delete rule.value.field,Array.isArray(rule.value.brackets)){for(const bracket of rule.value.brackets)e$2(bracket)&&delete bracket.end;rule.brackets=rule.value.brackets}delete rule.value}}async updateItem(source2){for(const rule of source2.system.rules){if(rule.key==="BattleForm"){this.#convertBattleFormBrackets(rule);continue}"value"in rule&&e$2(rule.value)&&this.#moveDamageDiceValue(rule),this.#convertBrackets(rule)}}}class Migration946RetirePotencyStrikingREs extends MigrationBase{static{__name(this,"Migration946RetirePotencyStrikingREs")}static{__name2(this,"Migration946RetirePotencyStrikingREs")}static version=.946;#migrateProperty(rule){switch(rule.property){case"potency":rule.property="runes-potency";break;case"resilient":rule.property="runes-resilient";break;case"striking":rule.property="runes-striking";break}}#migratePredicate(rule,itemId){const predicate=Array.isArray(rule.predicate)?rule.predicate:rule.predicate=[];itemId===void 0&&typeof rule.selector=="string"&&!predicate.some(p=>typeof p=="string"&&p.startsWith("item:"))&&predicate.push(`item:slug:${rule.selector.replace(/-(?:attack|damage|attack-roll)$/,"")}`);const unarmedIndex=predicate.findIndex(p=>p==="unarmed");unarmedIndex!==void 0&&unarmedIndex>=0?predicate.splice(unarmedIndex,1,"item:category:unarmed"):/^unarmed-/.test(String(rule.selector))&&!predicate?.some(p=>p==="item:category:unarmed")&&predicate?.unshift("item:category:unarmed"),predicate.length===0&&delete rule.predicate}async updateItem(source2){const rules=source2.system.rules;for(const rule of rules)if(rule.key==="ItemAlteration")this.#migrateProperty(rule);else if(["Striking","WeaponPotency"].includes(rule.key)){const itemId="selector"in rule&&typeof rule.selector=="string"?/\{.+\}/.test(rule.selector)?rule.selector.replace(/(?<=\}).+$/,""):void 0:"{item|id}",itemType=itemId?void 0:"weapon",property=rule.key==="Striking"?"runes-striking":"runes-potency";Object.assign(rule,{key:"ItemAlteration",itemId,itemType,mode:"upgrade",property}),this.#migratePredicate(rule,itemId),delete rule.label,delete rule.selector}}}class Migration947FixPostPotencyStrikingPredicates extends MigrationBase{static{__name(this,"Migration947FixPostPotencyStrikingPredicates")}static{__name2(this,"Migration947FixPostPotencyStrikingPredicates")}static version=.947;async updateItem(source2){const rules=source2.system.rules;for(const rule of rules){if(rule.key!=="ItemAlteration"||!tupleHasValue(["runes-potency","runes-resilient","runes-striking"],rule.property))continue;const invalid=["ranged","melee","strike","unarmed"].flatMap(b=>[`item:slug:${b}`,`item:slug:${b}-attack-roll`]);Array.isArray(rule.predicate)&&(rule.predicate=rule.predicate.filter(p=>!tupleHasValue(invalid,p)))}}}class Migration948MoreBadPredicatesAndSolarianCrystals extends MigrationBase{static{__name(this,"Migration948MoreBadPredicatesAndSolarianCrystals")}static{__name2(this,"Migration948MoreBadPredicatesAndSolarianCrystals")}static version=.948;async updateItem(source2){const rules=source2.system.rules,propertiesToCheck=["runes-potency","runes-resilient","runes-striking"],invalid=["item:slug:weapon","item:slug:attack-roll","item:slug:weapon-attack-roll"];for(const rule of rules)rule.key==="ItemAlteration"&&typeof rule.property=="string"&&propertiesToCheck.includes(rule.property)&&Array.isArray(rule.predicate)&&(rule.predicate=rule.predicate.filter(p=>!invalid.includes(p)));if(source2.type!=="equipment")return;const slug=source2.system.slug||sluggify(source2.name),isPotencyCrystal=/^\d-weapon-potency-crystal$/.test(slug),isStrikingCrystal=/^striking-crystal-(?:advanced|commercial|tactical)$/.test(slug);!isPotencyCrystal&&!isStrikingCrystal||(source2.system.rules=rules.map(rule=>rule.key!=="ItemAlteration"?rule:rule.property==="runes-potency"?{key:"FlatModifier",slug:"weapon-potency",label:"PF2E.Item.Weapon.Rune.Potency",selector:"attack-roll",type:"item",value:rule.value,predicate:rule.predicate}:(rule.property==="runes-striking"&&(rule.property="damage-dice-number",typeof rule.value=="number"&&(rule.value=rule.value+1)),rule)))}}class Migration949NPCRangeData extends MigrationBase{static{__name(this,"Migration949NPCRangeData")}static{__name2(this,"Migration949NPCRangeData")}static version=.949;async updateItem(source2){if(!("game"in globalThis)&&source2.type==="melee"){const system2=source2.system,rangeData=getLegacyRangeData(system2.traits.value);rangeData&&(system2.range??={increment:rangeData.increment,max:rangeData.max},system2.traits.value=system2.traits.value.filter(t2=>!/^(?:range-increment|range)-\d+$/.test(t2)))}for(const rule of source2.system.rules){if(!this.#isStrikeRE(rule)||!Array.isArray(rule.traits))continue;const data=getLegacyRangeData(rule.traits);data&&(rule.range=data,rule.traits=rule.traits.filter(t2=>!/^(?:range-increment|range)-\d+$/.test(t2)))}}#isStrikeRE(rule){return rule.key==="Strike"}}function getLegacyRangeData(traits){const rangeRegex=/^(range(?:-increment)?)-(\d+)$/;for(const trait of traits){const match=trait.match(rangeRegex);if(!match)continue;return{max:null,increment:null,[match[1]==="range"?"max":"increment"]:Number(match[2])}}return null}__name(getLegacyRangeData,"getLegacyRangeData"),__name2(getLegacyRangeData,"getLegacyRangeData");class Migration950AmmoConsumableToAmmoAmmo extends MigrationBase{static{__name(this,"Migration950AmmoConsumableToAmmoAmmo")}static{__name2(this,"Migration950AmmoConsumableToAmmoAmmo")}static version=.95;#KEYS_TO_KEEP=["level","description","traits","rules","slug","publication","_migration","quantity","baseItem","bulk","price","identification","containerId","size","temporary","uses"];async updateItem(source2){source2.type==="weapon"?this.#updateWeapon(source2):source2.type==="consumable"&&this.#updateConsumable(source2)}#updateWeapon(source2){const system2=source2.system;if(system2.ammo||!system2.expend||system2.reload.value==="-")return;const traits=system2.traits.value,capacity=traits.includes("repeating")||system2.reload.value&&system2.reload.value!=="0"?1:null,slug=source2.system.slug??sluggify(source2.name),baseWeapon=source2.system.baseItem||source2.name,baseBeastGun=beastGuns$1.find(g=>slug===g||slug.startsWith(`${g}-`));slug==="erraticannon"?system2.ammo={capacity,baseType:null,builtIn:!1}:slug==="backpack-ballista"?(system2.baseItem="backpack-ballista",system2.ammo={capacity,baseType:"backpack-ballista-bolts",builtIn:!1}):slug==="backpack-catapult"?(system2.baseItem="backpack-catapult",system2.ammo={capacity,baseType:"backpack-catapult-stones",builtIn:!1}):slug==="dart-umbrella"?system2.ammo={capacity,baseType:"blowgun-darts",builtIn:!1}:BUILT_IN_WEAPONS.includes(slug)||BUILT_IN_WEAPONS.includes(baseWeapon)?system2.ammo={capacity,baseType:null,builtIn:!0}:objectHasKey(BASE_WEAPON_TO_AMMO,baseWeapon)?system2.ammo={capacity,baseType:BASE_WEAPON_TO_AMMO[baseWeapon],builtIn:!1}:objectHasKey(SF2E_WEAPON_TO_AMMO,baseWeapon)?(system2.ammo={capacity,baseType:SF2E_WEAPON_TO_AMMO[baseWeapon],builtIn:!1},objectHasKey(SF2E_AMMO_CAPACITY,baseWeapon)&&(system2.ammo.capacity=SF2E_AMMO_CAPACITY[baseWeapon])):objectHasKey(BASE_WEAPON_TO_AMMO,baseBeastGun)?system2.ammo={capacity,baseType:BASE_WEAPON_TO_AMMO[baseBeastGun],builtIn:!1}:traits.includes("repeating")?system2.ammo={capacity:1,baseType:"magazine",builtIn:!1}:source2.system.group==="bow"?system2.ammo={capacity,baseType:"arrows",builtIn:!1}:source2.system.group==="crossbow"?system2.ammo={capacity,baseType:"bolts",builtIn:!1}:source2.system.group==="sling"?system2.ammo={capacity,baseType:"sling-bullets",builtIn:!1}:system2.ammo={capacity,baseType:null,builtIn:!1}}#updateConsumable(source2){const category=source2.system.category,stackGroup=source2.system.stackGroup;if(category!=="ammo"){"stackGroup"in source2.system&&(source2.system["-=stackGroup"]=null);return}const originalKeys=Object.keys(source2.system),system2=t$3(source2.system,this.#KEYS_TO_KEEP),slug=system2.slug??sluggify(source2.name);system2.craftableAs??=null;const traits=source2.system.traits.value,isSpecialAmmo=specificAmmoCategories[slug]||!!source2.system.level.value&&(traits.includes("magical")||traits.includes("alchemical")),slugMatch=/^rounds-(.*)$/.exec(slug),weaponSlug=slugMatch?remapSlug[slugMatch[1]]??slugMatch[1]:null;if(isSpecialAmmo)system2.craftableAs=specificAmmoCategories[slug]??(slug.includes("-round")?["rounds"]:slug.includes("-arrow")?["arrows"]:slug.includes("-bolt")?["bolts"]:[]);else if(slug==="shield-pistol-rounds")system2.baseItem="rounds-shield-pistol",system2.slug&&(system2.slug="rounds-shield-pistol"),source2.name==="Shield Pistol Rounds"&&(source2.name="Rounds (Shield Pistol)");else if(slug==="spikes")system2.baseItem="rounds-spike-launcher",system2.slug&&(system2.slug="rounds-spike-launcher"),source2.name==="Spikes"&&(source2.name="Rounds (Spike Launcher)");else if(slug==="magazine-with-5-bolts")system2.baseItem="repeating-hand-crossbow-magazine";else if(tupleHasValue(AMMO_TYPES,slug))system2.baseItem=slug;else if(tupleHasValue(allBaseRoundWeapons,weaponSlug))system2.baseItem=`rounds-${weaponSlug}`;else if(slug==="cutlery")system2.baseItem="cutlery";else if(slug==="backpack-ballista-bolt"||slug==="backpack-catapult-stone")system2.baseItem=`${slug}s`,system2.slug=system2.baseItem,system2.price&&(system2.price.per=10);else if(slug.startsWith("chem-tank-"))system2.baseItem="chem-tank";else if(slug.startsWith("battery-"))system2.baseItem="battery";else if(slug==="projectile-ammo")system2.baseItem="projectile-ammo";else if(stackGroup&&stackGroup in AMMO_STACK_TO_CATEGORY)system2.baseItem=AMMO_STACK_TO_CATEGORY[stackGroup];else{const fromSlug=slug.includes("round")?"rounds":slug.includes("bolt")?"bolts":"arrows";system2.baseItem=fromSlug}if(source2.img=source2.img.replace(/\bconsumable\.svg$/,"ammo.svg"),source2.type="ammo","game"in globalThis)source2.system=system2,source2["==system"]=system2;else{const systemUpdate=system2;for(const key of originalKeys)key in system2||(systemUpdate[`-=${key}`]=null);source2.system=systemUpdate}}}const BUILT_IN_WEAPONS=["hydrocannon","wrecker","growth-gun"],specificAmmoCategories={"awakened-adamantine-shot":["rounds"],"awakened-cold-iron-shot":["rounds"],"awakened-silver-shot":["rounds"],"beacon-shot":["arrows","bolts"],"big-rock-bullet-greater":["sling-bullets"],"big-rock-bullet-major":["sling-bullets"],"big-rock-bullet":["sling-bullets"],"blindpepper-bolt":["bolts"],"burrowing-bolt-greater":["arrows","bolts"],"burrowing-bolt":["arrows","bolts"],"climbing-bolt":["bolts"],"corpsecaller-round":["rounds"],"disintegration-bolt":["bolts"],"dispersing-bullet":["sling-bullets"],"dreaming-round":["rounds"],"enfilading-arrow":["arrows"],"extinguishing-ball":["sling-bullets"],"fairy-bullet":["rounds"],"garrote-bolt":["bolts"],"golden-cased-bullet-greater":["rounds"],"golden-cased-bullet-major":["rounds"],"golden-cased-bullet-standard":["rounds"],"golden-chrysalis":["sling-bullets"],"harpoon-bolt":["rounds"],"life-shot-greater":["rounds"],"life-shot-lesser":["rounds"],"life-shot-major":["rounds"],"life-shot-minor":["rounds"],"life-shot-moderate":["rounds"],"life-shot-true":["rounds"],"meteor-shot-greater":["rounds"],"meteor-shot-major":["rounds"],"meteor-shot":["rounds"],"penetrating-ammunition":["arrows","bolts"],"rattling-bolt-greater":["bolts"],"rattling-bolt":["bolts"],"reducer-round":["rounds"],"resonating-ammunition":["arrows","bolts"],"roc-shaft-arrow-lesser":["arrows"],"roc-shaft-arrow-moderate":["arrows"],"sampling-ammunition":["arrows","bolts"],"scouting-arrow":["arrows","bolts"],"silencing-ammunition":["arrows","bolts"],"sky-serpent-bolt":["bolts"],"slumber-arrow":["arrows"],"starshot-arrow-greater":["arrows"],"starshot-arrow-lesser":["arrows"],"stepping-stone-shot-greater":["rounds"],"stepping-stone-shot":["rounds"],"stone-bullet":["sling-bullets"],"stonethroat-ammunition":["arrows","bolts"],"storm-arrow":["arrows"],"tripline-arrow":["arrows"],"vine-arrow":["arrows"],"viper-arrow":["arrows"]},remapSlug={"mithral-tree":"dawnsilver-tree"},repeatingCrossbows$1=["repeating-crossbow","repeating-hand-crossbow","repeating-heavy-crossbow"],round5Firearms$1=["dwarven-scattergun","explosive-dogslicer","flingflenser","harmona-gun"],round10Firearms$1=["arquebus","axe-musket","black-powder-knuckle-dusters","blunderbuss","cane-pistol","clan-pistol","coat-pistol","dagger-pistol","double-barreled-musket","double-barreled-pistol","dragon-mouth-pistol","dueling-pistol","fire-lance","flintlock-musket","flintlock-pistol","gnome-amalgam-musket","gun-sword","hammer-gun","hand-cannon","jezail","mace-multipistol","mithral-tree","pepperbox","piercing-wind","rapier-pistol","shield-pistol","shobhad-longrifle","slide-pistol","three-peaked-tree","triggerbrand"],allBaseRoundWeapons=[...round5Firearms$1,...round10Firearms$1],beastGuns$1=["alicorn-trigger","breath-blaster","drake-rifle","fulmination-fang","howler-pistol","leydroth-spellbreaker","nightmares-lament","petrification-cannon","screech-shooter","spider-gun","spike-launcher","tentacle-cannon"],SF2E_WEAPON_TO_AMMO={"acid-dart-rifle":"projectile-ammo","aeon-rifle":"battery","arc-emitter":"battery","arc-pistol":"battery","arc-rifle":"battery","artillery-laser":"battery","assassin-rifle":"projectile-ammo","autotarget-rifle":"projectile-ammo","boom-pistol":"battery","breaching-gun":"projectile-ammo","card-slinger":"projectile-ammo","coil-rifle":"projectile-ammo",crossbolter:"projectile-ammo",flamethrower:"chem-tank","gyrojet-pistol":"projectile-ammo","laser-pistol":"battery","laser-rifle":"battery","machine-gun":"projectile-ammo","magnetar-rifle":"projectile-ammo","plasma-cannon":"battery","plasma-caster":"battery","pulsecaster-pistol":"battery","reaction-breacher":"projectile-ammo","rotating-pistol":"projectile-ammo",rotolaser:"battery",scattergun:"projectile-ammo",screamer:"battery","seeker-rifle":"projectile-ammo","semi-auto-pistol":"projectile-ammo","shirren-eye-rifle":"projectile-ammo","singing-coil":"battery","sonic-rifle":"battery","starfall-pistol":"battery","stellar-cannon":"projectile-ammo",streetsweeper:"battery","zero-cannon":"chem-tank","zero-pistol":"chem-tank"},SF2E_AMMO_CAPACITY={"acid-dart-rifle":5,"assassin-rifle":1,"autotarget-rifle":20,"breaching-gun":3,"card-slinger":7,"coil-rifle":1,crossbolter:1,"gyrojet-pistol":4,"machine-gun":20,"magnetar-rifle":30,"reaction-breacher":3,"rotating-pistol":6,scattergun:4,"seeker-rifle":1,"semi-auto-pistol":10,"shirren-eye-rifle":1,"stellar-cannon":8},BASE_WEAPON_TO_AMMO={...t$9(allBaseRoundWeapons,slug=>[slug,`rounds-${slug}`]),...t$9(repeatingCrossbows$1,slug=>[slug,`${slug}-magazine`]),...t$9(beastGuns$1,slug=>[slug,`rounds-${slug}`]),"air-repeater":"magazine-with-6-pellets",atlatl:"dart","barricade-buster":"8-round-magazine","big-boom-gun":"rounds-hand-cannon","long-air-repeater":"magazine-with-8-pellets","spoon-gun":"rounds-hand-cannon",blowgun:"blowgun-darts","wrist-launcher":"dart"},AMMO_TYPES=[...allBaseRoundWeapons.map(slug=>`rounds-${slug}`),...repeatingCrossbows$1.map(slug=>`${slug}-magazine`),...beastGuns$1.map(slug=>`rounds-${slug}`),"8-round-magazine","magazine-with-6-pellets","magazine-with-8-pellets"],AMMO_STACK_TO_CATEGORY={arrows:"arrows",rounds10:"rounds",rounds5:"rounds",bolts:"bolts",blowgunDarts:"blowgun-darts",slingBullets:"sling-bullets",sprayPellets:"spray-pellets",woodenTaws:"wooden-taws"};class Migration951TreasureCategories extends MigrationBase{static{__name(this,"Migration951TreasureCategories")}static{__name2(this,"Migration951TreasureCategories")}static version=.951;async updateItem(source2){if(source2.type!=="treasure")return;const system2=source2.system;system2.category==="coin"||system2.stackGroup==="coins"?(system2.category??="coin",(system2.publication.title="Pathfinder Core Rulebook")&&this.#setPublication(system2.publication,"Pathfinder Player Core")):system2.stackGroup==="gems"||system2.category==="gem"?source2.system.category??="gem":system2.publication.title==="Pathfinder Gamemastery Guide"&&(source2.system.category??="art-object"),system2.category&&system2.publication.title==="Pathfinder Gamemastery Guide"&&this.#setPublication(system2.publication,"Pathfinder GM Core"),delete system2.stackGroup,source2["==system"]=system2}#setPublication(data,title){data.license="ORC",data.remaster=!0,data.title=title}}class Migration952AmmoTraitsAndOptions extends MigrationBase{static{__name(this,"Migration952AmmoTraitsAndOptions")}static{__name2(this,"Migration952AmmoTraitsAndOptions")}static version=.952;async updateItem(source2){const isBasicAmmo=source2.type==="ammo"&&source2.system.baseItem===(source2.system.slug??sluggify(source2.name));source2.type==="ammo"&&(isBasicAmmo||source2.system.baseItem==="chem-tank")&&source2.system.baseItem!=="battery"&&!source2.system.traits.value.includes("consumable")&&source2.system.traits.value.push("consumable"),source2.type==="ammo"&&source2.system.baseItem==="battery"&&(source2.system.traits.value=source2.system.traits.value.filter(v=>v!=="consumable")),source2.system.rules=recursiveReplaceString(source2.system.rules,s=>s.endsWith(":category:ammo")?s.replace(":category:ammo",":type:ammo"):s),this.#recursiveConsumableCheck(source2.system.rules)}#recursiveConsumableCheck(source2){if(Array.isArray(source2))for(const item of source2)this.#recursiveConsumableCheck(item);else if(e$2(source2))for(const[key,value]of Object.entries(source2))key==="or"&&Array.isArray(value)&&value.includes("item:type:consumable")&&!value.includes("item:type:ammo")?value.push("item:type:ammo"):this.#recursiveConsumableCheck(value)}}class Migration953NotStrikeDamage extends MigrationBase{static{__name(this,"Migration953NotStrikeDamage")}static{__name2(this,"Migration953NotStrikeDamage")}static version=.953;async updateItem(source2){const slug=source2.system.slug??sluggify(source2.name);if(slug==="bloodrager"&&itemIsOfType(source2,"feat")){this.#updateBloodrager(source2);return}for(const rule of source2.system.rules)if(this.#isAdjustModifier(rule)&&["weapon-specialization","spirit-striking"].includes(rule.slug??""))rule.selector==="strike-damage"&&(delete rule.selector,rule.selectors=["unarmed-damage","weapon-damage"]);else if((this.#isFlatModifier(rule)||this.#isDamageDice(rule))&&(["weapon-specialization","spirit-striking"].includes(rule.slug??"")||["gorum-moderate-curse","striking-retribution","mountain-strategy","demonbane-warrior","kin-hunter"].includes(slug))){const selectors=this.#coerceArray(rule.selector);selectors.includes("strike-damage")&&(rule.selector=this.#simplifyModifierSelector([...selectors.filter(s=>s!=="strike-damage"),"unarmed-damage","weapon-damage"]))}else if(this.#isFlatModifier(rule)&&slug==="dragon-roar"){const selectors=this.#coerceArray(rule.selector);selectors.includes("strike-damage")&&(rule.selector=this.#simplifyModifierSelector([...selectors.filter(s=>s!=="strike-damage"),"attack-damage"]))}}#updateBloodrager(source2){const idx=source2.system.rules.findIndex(r2=>r2.key==="FlatModifier");source2.system.rules=source2.system.rules.filter(r2=>r2.key!=="FlatModifier"),source2.system.rules.splice(idx>=0?idx:source2.system.rules.length,0,{damageType:"bleed",key:"FlatModifier",predicate:["self:effect:rage","item:damage:category:physical"],selector:["attack-damage"],value:"ternary(gte(@actor.level,15),4,ternary(gte(@actor.level,7),2,1))"},{key:"FlatModifier",predicate:["self:effect:rage"],selector:["attack-spell-damage"],slug:"blood-rage-spell",value:"ternary(gte(@actor.level,15),8,ternary(gte(@actor.level,7),4,2))"})}#isAdjustModifier(rule){return rule.key==="AdjustModifier"}#isFlatModifier(rule){return rule.key==="FlatModifier"}#isDamageDice(rule){return rule.key==="DamageDice"}#coerceArray(value){return Array.isArray(value)?value:[value]}#simplifyModifierSelector(value){const reduced=n(value).sort();return reduced.length===1?reduced[0]:reduced}}const Migrations=Object.freeze(Object.defineProperty({__proto__:null,Migration700SingleClassFeatures,Migration701ModifierNameToSlug,Migration702REFormulasAtInstanceLevel,Migration703SpellDamageStructure,Migration704MartialProficiencyRE,Migration705GunslingerCatchUp,Migration706FormulasAtInstanceLevelEverythingElse,Migration707BracketedFormulasAtInstanceLevel,Migration708SpecificRuleLabel,Migration709REFormulasAtInstanceLevelRedux,Migration710RarityToString,Migration711HeritageItems,Migration712ActorShieldStructure,Migration713FistToStrikeRE,Migration714RangeIncrementREs,Migration715DangerousSorcery,Migration716StrikeDamageSelector,Migration717TakeFeatLimits,Migration718CarryType,Migration719ShrugFlanking,Migration720UpdateSpellDescriptions,Migration721SetReloadValues,Migration722CraftingSystemData,Migration723CumulativeItemBonuses,Migration724CraftingMaxItemLevel,Migration725QuickClimbREs,Migration726JournalSetting,Migration727TrimSelfRollOptions,Migration728FlattenPhysicalProperties,Migration729CumulativeItemBonusCleanup,Migration730DeruneHandwraps,Migration731TogglePropertyToRollOption,Migration732FixDedicationFeatTypes,Migration733ItemBonusFromEquipment,Migration734SpellLocationPropsAndSignature,Migration735FirearmAmmoAlchemical,Migration736RemoveBrokenThreshold,Migration737NormalizeRuleElementKeys,Migration738UpdateLaughingShadow,Migration739RecoveryCheckDC,Migration740MaxTakable,Migration741RollOptionToggleToItem,Migration742RMAbilityBoostLevels,Migration743FixWeaknessStructure,Migration744MigrateSpellHeighten,Migration745EffectTargetToChoiceSet,Migration746StandardizePricing,Migration747FixedHeightening,Migration748BatchConsumablePricing,Migration749AssuranceREs,Migration750FixCorruptedPrice,Migration751ResetRollOptions,Migration752StrikeVsWeaponTraits,Migration753WeaponReloadTimes,Migration754MightyBulwarkAdjustModifiers,Migration755GrantIdsToData,Migration756RMStoredResourceMaxes,Migration757HillockHalfling,Migration758PrunePCAttributes,Migration759CritSpecRE,Migration760SeparateNoteTitle,Migration761ShotRules,Migration762UpdateBackgroundItems,Migration763RestoreAnimalStrikeOptions,Migration764PanacheVivaciousREs,Migration765ChoiceOwnedItemTypes,Migration766WipeURLSources,Migration767ConvertVoluntaryFlaws,Migration768AddNewAuras,Migration769NoUniversalistFocusPool,Migration770REDataToSystem,Migration771SpellVariantsToSystem,Migration772V10EmbeddedSpellData,Migration773ReligiousSymbolUsage,Migration774UnpersistCraftingEntries,Migration775AgileFinesseRanged,Migration776SlugifyConditionOverrides,Migration777HandOfTheApprentice,Migration778RenameRetiredPackRefs,Migration779EliteWeak,Migration780NumifySpeeds,Migration781SuppressNoCrowbar,Migration782UnnestActorTraits,Migration783RemoveClassSkillAELikes,Migration784CompBrowserPackSetting,Migration785ABCKitItemUUIDs,Migration786RemoveIdentifiedData,Migration787ResolvablesToSystem,Migration788UpdateTanglefootBags,Migration789UpdatePreciseStrike,Migration790MultipleClassDCs,Migration791RuffianHands,Migration792RemoveTokenAELikes,Migration793MakePredicatesArrays,Migration794AddWildShapeChoices,Migration795CleanupFlatFootedToggle,Migration796ItemGrantsToObjects,Migration797MetagameSetting,Migration798WeaponToItemStatements,Migration799RMRecallKnowledgeDuplicates,Migration800SelfEffectPanacheRage,Migration801ColorDarkvision,Migration802StripFeatActionCategory,Migration803NormalizeSpellArea,Migration804RemoveConsumableProperties,Migration805InlineDamageRolls,Migration806TorchImprovisedOtherTags,Migration807RMActivatedEffectFields,Migration808CountDamageDice,Migration809AutomatonEnhancements,Migration810LootDescriptionValue,Migration811InlineDamageRollsPersistent,Migration812RestructureIWR,Migration813NormalizeColdIron,Migration814CalculatedExpandedSplash,Migration815ConsumableDataCleanup,Migration816AlchemistResearchFields,Migration817FieldDiscoveryPredicates,Migration818BasicUndeadNegativeHealing,Migration819SpinTaleAdventureSpecific,Migration820RemoveUnusedTraitsData,Migration821InlineDamageRolls,Migration822BladeAllyConsolidation,Migration823HeritageAncestrySlug,Migration824SneakAttackDamageSource,Migration825KhakkharaFengHuoLun,Migration826GutConditionData,Migration827FixTVShieldTraits,Migration828PruneInvalidTraits,Migration829RMRitualEntries,Migration830BarbarianRework,Migration831ClericDoctrines,Migration832ChoiceSetFlags,Migration833AddRogueToysFixPrecision,Migration834FeatCategories,Migration835InitiativeLongform,Migration836EnergizingConsolidation,Migration837MoveHazardBookSources,Migration838StrikeAttackRollSelector,Migration839ActionCategories,Migration840ArrayWrapPredicates,Migration841V11UUIDFormat,Migration842NumifyNumericSettings,Migration843RMArmorCustomModifiers,Migration844DeityDomainUUIDs,Migration845EmptySpellConsumables,Migration846SpellSchoolOptional,Migration847TempHPRuleEvents,Migration848NumericArmorProperties,Migration849DeleteBrokenThreshold,Migration850FlatFootedToOffGuard,Migration851JustInnovationId,Migration852AbilityScoresToModifiers,Migration853RemasterLanguages,Migration854BracketedAbilityScoresToModifiers,Migration855ApexEquipmentSystemData,Migration856NoSystemDotCustom,Migration857WeaponSpecializationRE,Migration858FakeWeaponSpecialization,Migration859MaterialTypeGrade,Migration860RMGroup,Migration861AuraColorsToAppearance,Migration862SpecificMagicArmor,Migration863FixMisspelledOrganaizationsProperty,Migration864RemoveWeaponMAP,Migration865VitalityVoid,Migration866LinkToActorSizeAgain,Migration867DamageRollDomainFix,Migration868StrikeRERange,Migration869RefreshMightyBulwark,Migration870MartialToProficiencies,Migration871MigrateRollActionMacroParams,Migration872MoveSchemaProperty,Migration873RemoveBonusBulkLimit,Migration874MoveStaminaStuff,Migration875SetInnovationIdEarly,Migration876FeatLevelTaken,Migration877PublicationData,Migration878TakeABreather,Migration879DeviseAStratagemAndFriends,Migration880SplitShowDialogsSettings,Migration881NoHBPrefix,Migration882SpellDataReorganization,Migration883BanishAlignment,Migration884UnifiedSpellcasting,Migration885ConvertAlignmentDamage,Migration886CrossbowGroup,Migration887RedirectSpellLinks,Migration888RemasterLanguagesHeritages,Migration889RemoveFocusMaxIncreases,Migration890RMClassItemClassDC,Migration891DruidicToWildsong,Migration892ChoiceSetREAdjustNameValue,Migration893NoHBPrefixSettings,Migration894NoLayOnHandsVsUndead,Migration895FixVariantSpellTraits,Migration896HealingDomains,Migration897ClearLayOnHandsDamage,Migration898NoHBAgain,Migration899ArmorShieldToShieldShield,Migration900ClassSpellcastingProficiency,Migration901ReorganizeBulkData,Migration902DuskwoodDawnsilver,Migration903PhysicalNumericData,Migration904UndercommonToSakvroth,Migration905UnpersistUsage,Migration906LimitStackGroup,Migration907RestructureArmorWeaponRunes,Migration908TrueGangUp,Migration909RefineConsumableData,Migration910EdictsAnathemaArrays,Migration911CoinBulk,Migration912RmFocusTraitFocusCantrips,Migration913SpellSustainedText,Migration914MovePerceptionSenses,Migration915MoveLanguages,Migration916NewPCToys,Migration917ScrollWandSpellIds,Migration918DeitySkills,Migration919WeaponToggleStructure,Migration920SuboptionSelection,Migration921SpellSlotArrays,Migration922SwashbucklerFinishers,Migration923KineticistRestructure,Migration924JiuHuanDoa,Migration925TouchOfCorruption,Migration926RemoveVisionFeatureLinks,Migration927ClassBackgroundBattleFormSkillLongform,Migration928CharacterSkillsLongform,Migration929RemoveSkillAbbreviations,Migration930ChoiceSetMedium,Migration931ExpandREPermissions,Migration932NPCSystemSkills,Migration933CraftingAbility,Migration934MythicCallingCategory,Migration935DeityIconPaths,Migration936MoveWorldClockSettings,Migration937RemoveInvalidAuraTraits,Migration938RenameBroochesAndThroned,Migration939SetTokenDimensions,Migration940WeaponExpend,Migration941InvestedGrafts,Migration942EquipmentGrade,Migration943UpdateSpeedPath,Migration944RmDamageDiceValue,Migration945REBracketsToStrings,Migration946RetirePotencyStrikingREs,Migration947FixPostPotencyStrikingPredicates,Migration948MoreBadPredicatesAndSolarianCrystals,Migration949NPCRangeData,Migration950AmmoConsumableToAmmoAmmo,Migration951TreasureCategories,Migration952AmmoTraitsAndOptions,Migration953NotStrikeDamage},Symbol.toStringTag,{value:"Module"}));class MigrationList{static{__name(this,"MigrationList")}static{__name2(this,"MigrationList")}static#list=Object.values(Migrations);static get latestVersion(){return Math.max(...this.#list.map(M=>M.version))}static constructAll(){return this.#list.map(M=>new M)}static constructFromVersion(version){const minVersion=Number(version)||MigrationRunner.RECOMMENDED_SAFE_VERSION;return this.#list.filter(M=>M.version>minVersion).map(M=>new M)}static constructRange(min,max=1/0){return this.#list.filter(M=>M.version>=min&&M.version<=max).map(M=>new M)}}class HTMLTagifyTagsElement extends foundry.applications.elements.AbstractFormInputElement{static{__name(this,"HTMLTagifyTagsElement")}static{__name2(this,"HTMLTagifyTagsElement")}static tagName="tagify-tags";constructor(){super(),this._setValue(this.getAttribute("value")||"[]")}_primaryInput=document.createElement("input");get input(){return this._primaryInput}_buildElements(){return this._primaryInput.type="text",this._applyInputAttributes(this._primaryInput),[this._primaryInput]}_getValue(){const value=super._getValue();return value.every(s=>typeof s=="string")?value:value.filter(s=>!s.readonly).map(s=>s.id??s.value).filter(e$1)}_setValue(value){try{this._value=JSON.parse(value)||[]}catch(error){error instanceof Error&&console.error(new Error(`PF2e System | Invalid value for HTMLTagifyTagsElement: ${value}`,{cause:error}))}}_applyInputAttributes(input){super._applyInputAttributes(input);for(const attribute of this.attributes)attribute.name==="name"||attribute.name==="value"||(this._primaryInput.setAttribute(attribute.name,attribute.value),attribute.name!=="class"&&attribute.name!=="disabled"&&this.removeAttribute(attribute.name));this._primaryInput.setAttribute("data-tagify-tags-name",this.name),this._primaryInput.value=JSON.stringify(this._value)}_toggleDisabled(disabled){this._primaryInput.disabled=disabled}_activateListeners(){this._primaryInput.addEventListener("change",event2=>{const target=event2.target;target instanceof HTMLInputElement&&(this.value=target.value||"[]")})}}var tagify_minExports=requireTagify_min();const Tagify=getDefaultExportFromCjs(tagify_minExports);class DestroyableManager{static{__name(this,"DestroyableManager")}static{__name2(this,"DestroyableManager")}#bodyObserver;#appObservers=new Map;static#OBSERVE_OPTIONS={attributes:!1,characterData:!1,childList:!0,subtree:!1};static initialize(){DestroyableManager.instance??=new DestroyableManager}constructor(){this.#bodyObserver=new MutationObserver(this.#onMutateBody.bind(this)),this.#bodyObserver.observe(document.body,DestroyableManager.#OBSERVE_OPTIONS)}observe(destroyable){const destroyableEl=destroyable instanceof Sortable?destroyable.el:"elementOrigin"in destroyable?destroyable.elementOrigin():destroyable.DOM.input,contentEl=destroyableEl?.closest(".app, .application")?.querySelector(".window-content");if(!contentEl)return console.warn(ErrorPF2e("No application element found").message);let context=this.#appObservers.get(contentEl);if(context){context.elements.add({node:destroyableEl,destroyable});return}context={observer:null,contextKey:contentEl,elements:new Set([{node:destroyableEl,destroyable}])};const observer=new MutationObserver(this.#onMutateContent(context));context.observer=observer,this.#appObservers.set(contentEl,context),observer.observe(contentEl,DestroyableManager.#OBSERVE_OPTIONS)}#onMutateContent(context){return mutations=>{for(const mutation of mutations)for(const removedNode of mutation.removedNodes){for(const element of context.elements)removedNode.contains(element.node)&&(element.destroyable.destroy(),context.elements.delete(element));if(!(context.elements.size>0)){context.observer?.disconnect(),this.#appObservers.delete(context.contextKey),context.observer=null;return}}}}#onMutateBody(mutations){for(const mutation of mutations)for(const removedNode of mutation.removedNodes)for(const[node,context]of this.#appObservers.entries())if(removedNode.contains(node)){for(const element of context.elements)try{element.destroyable.destroy()}catch{continue}context.observer?.disconnect(),this.#appObservers.delete(node),context.observer=null}}}function createSortable(list,options){const sortable=new Sortable(list,Object.assign(options,{noJQuery:!0}));return DestroyableManager.instance.observe(sortable),sortable}__name(createSortable,"createSortable"),__name2(createSortable,"createSortable");class NoJQueryPlugin{static{__name(this,"NoJQueryPlugin")}static{__name2(this,"NoJQueryPlugin")}static pluginName="noJQuery";setupClone(){"jQuery"in window&&(window.jQuery=null)}clone(){"jQuery"in window&&"$"in window&&(window.jQuery=window.$)}}function createTooltipster(target,options){const $element=$(target).tooltipster(options);return DestroyableManager.instance.observe($element.tooltipster("instance")),$element}__name(createTooltipster,"createTooltipster"),__name2(createTooltipster,"createTooltipster");function traitSlugToObject(trait,dictionary,options={}){const descriptions=options.descriptions??CONFIG.PF2E.traitsDescriptions,traitObject={name:trait,label:game.i18n.localize(dictionary[trait]??trait),description:null};return objectHasKey(descriptions,trait)&&(traitObject.description=descriptions[trait]??null),traitObject}__name(traitSlugToObject,"traitSlugToObject"),__name2(traitSlugToObject,"traitSlugToObject");function transformWhitelist(whitelist){return Array.isArray(whitelist)?whitelist:Object.entries(whitelist).map(([key,locPath])=>({id:key,value:game.i18n.localize(typeof locPath=="string"?locPath:locPath.label)})).sort((a,b)=>a.value.localeCompare(b.value,game.i18n.lang))}__name(transformWhitelist,"transformWhitelist"),__name2(transformWhitelist,"transformWhitelist");function tagify(element,{whitelist,maxTags,enforceWhitelist=!0,editTags={clicks:2,keepInvalid:!0},delimiters=","}={}){const input=element instanceof HTMLTagifyTagsElement?element.input:element;if(!input)return null;const whitelistTransformed=whitelist?transformWhitelist(whitelist):[],maxItems=whitelist?Object.keys(whitelistTransformed).length:void 0,tagify2=new Tagify(input,{enforceWhitelist:!!whitelist&&enforceWhitelist,keepInvalidTags:!1,skipInvalid:!!whitelist,maxTags:maxTags??maxItems,dropdown:{enabled:0,maxItems,searchKeys:["id","value"]},editTags,delimiters,whitelist:whitelistTransformed,templates:{tag(tagData){const removeButton=document.createElement("x");removeButton.className=this.settings.classNames.tagX,removeButton.role="button",removeButton.ariaLabel="remove tag";const tag=document.createElement("tag");tag.className=this.settings.classNames.tag,tag.appendChild(removeButton),tag.appendChild(createHTMLElement("div",{children:[createHTMLElement("span",{innerHTML:tagData[this.settings.tagTextProp]||tagData.value,classes:[this.settings.classNames.tagText]})]})),tag.contentEditable="false",tag.spellcheck=!1,tag.tabIndex=this.settings.a11y.focusableTags?0:-1;for(const[key,value]of Object.entries(tagData))tag.setAttribute(key,value);return tag.outerHTML}}});return DestroyableManager.instance.observe(tagify2),input.name&&(tagify2.DOM.scope.dataset.name=input.name),tagify2.DOM.input.blur(),tagify2}__name(tagify,"tagify"),__name2(tagify,"tagify");function createSheetOptions(options,selections=[],{selected=!1}={}){const sheetOptions=Object.entries(options).reduce((compiledOptions,[stringKey,value])=>{const selectionList=Array.isArray(selections)?selections:selections.value,key=typeof selectionList[0]=="number"?Number(stringKey):stringKey,isSelected=selectionList.includes(key);return(isSelected||!selected)&&(compiledOptions[key]={label:game.i18n.localize(e$3(value)?value.label:value),value:stringKey,selected:isSelected}),compiledOptions},{});return sortLabeledRecord(sheetOptions)}__name(createSheetOptions,"createSheetOptions"),__name2(createSheetOptions,"createSheetOptions");function createSheetTags(options,selections){return createSheetOptions(options,selections,{selected:!0})}__name(createSheetTags,"createSheetTags"),__name2(createSheetTags,"createSheetTags");function createTagifyTraits(traits,{sourceTraits,record}){const sourceSet=new Set(sourceTraits??traits),traitSlugs=new Set(traits),readonlyTraits=traitSlugs.filter(t2=>!sourceSet.has(t2)),hiddenTraits=sourceSet.filter(t2=>!traitSlugs.has(t2));return[...traitSlugs,...hiddenTraits].map(slug=>{const label=game.i18n.localize(record?.[slug]??slug),tooltip=CONFIG.PF2E.traitsDescriptions[slug];return{id:slug,value:label,readonly:readonlyTraits.has(slug),hidden:!traitSlugs.has(slug)||void 0,"data-tooltip":tooltip}}).sort((t1,t2)=>t1.value.localeCompare(t2.value))}__name(createTagifyTraits,"createTagifyTraits"),__name2(createTagifyTraits,"createTagifyTraits");function getAdjustment(value,base,{better="higher"}={}){return value===base?null:(better==="higher"?value>base:value<base)?"adjusted-higher":"adjusted-lower"}__name(getAdjustment,"getAdjustment"),__name2(getAdjustment,"getAdjustment");function getAdjustedValue(value,reference,options){const adjustmentClass=getAdjustment(value,reference,options);return{value,adjustmentClass,adjustedHigher:adjustmentClass==="adjusted-higher",adjustedLower:adjustmentClass==="adjusted-lower"}}__name(getAdjustedValue,"getAdjustedValue"),__name2(getAdjustedValue,"getAdjustedValue");async function maintainFocusInRender(sheet,renderLogic){const element=sheet.element.get(0),{activeElement}=document,activeWasHere=element?.contains(activeElement);if(await renderLogic(),!(!activeElement||!activeWasHere)){if(activeElement instanceof HTMLInputElement&&activeElement.dataset.property)htmlQuery(element,`input[data-property="${activeElement.dataset.property}"]`)?.focus();else if(activeElement.classList.contains("tagify__input")){const name2=htmlClosest(activeElement,"tags")?.dataset.name;name2&&htmlQuery(element,`tags[data-name="${name2}"] span[contenteditable]`)?.focus()}}}__name(maintainFocusInRender,"maintainFocusInRender"),__name2(maintainFocusInRender,"maintainFocusInRender");async function getItemFromDragEvent(event2){try{const dataString=event2.dataTransfer?.getData("text/plain"),dropData=JSON.parse(dataString??"");return await ItemPF2e.fromDropData(dropData)??null}catch{return null}}__name(getItemFromDragEvent,"getItemFromDragEvent"),__name2(getItemFromDragEvent,"getItemFromDragEvent");function isRelevantEvent(event2){return!!event2&&"ctrlKey"in event2&&"metaKey"in event2&&"shiftKey"in event2}__name(isRelevantEvent,"isRelevantEvent"),__name2(isRelevantEvent,"isRelevantEvent");function eventToRollParams(event2,rollType){const key=rollType.type==="check"?"showCheckDialogs":"showDamageDialogs",skipDefault=!game.user.settings[key];if(!isRelevantEvent(event2))return{skipDialog:skipDefault};const params={skipDialog:event2.shiftKey?!skipDefault:skipDefault};return(event2.ctrlKey||event2.metaKey)&&(params.rollMode=game.user.isGM?"gmroll":"blindroll"),params}__name(eventToRollParams,"eventToRollParams"),__name2(eventToRollParams,"eventToRollParams");function eventToRollMode(event2){return isRelevantEvent(event2)&&isControlDown(event2)?game.user.isGM?"gmroll":"blindroll":"roll"}__name(eventToRollMode,"eventToRollMode"),__name2(eventToRollMode,"eventToRollMode");function isControlDown(event2){return foundry.helpers.interaction.KeyboardManager.CONTROL_KEY_STRING==="\u2318"?event2.metaKey:event2.ctrlKey}__name(isControlDown,"isControlDown"),__name2(isControlDown,"isControlDown");async function sendItemToChat(itemUuid,options){const itemLoaded=await fromUuid(itemUuid);if(!itemLoaded)return;(options.actor&&itemLoaded.actor?.uuid!==options.actor.uuid?new ItemProxyPF2e(itemLoaded.toObject(),{parent:options.actor}):itemLoaded).toMessage(options.event)}__name(sendItemToChat,"sendItemToChat"),__name2(sendItemToChat,"sendItemToChat");function getBasePhysicalItemViewData(item){return{...t$3(item,["id","uuid","img","name"]),type:item.type,level:item.level,rarity:item.rarity,traits:item.traitChatData(),isTemporary:item.isTemporary}}__name(getBasePhysicalItemViewData,"getBasePhysicalItemViewData"),__name2(getBasePhysicalItemViewData,"getBasePhysicalItemViewData");function createTooltipListener(element,options){const tooltipOptions=t$3(options,["cssClass","direction","locked"]);element.addEventListener("pointerenter",async event2=>{const target=options.selector?htmlClosest(event2.target,options.selector):element;if(!target)return;const html2=await options.render(target);if(html2&&(options.locked&&game.tooltip.dismissLockedTooltips(),game.tooltip.activate(target,{html:html2,...tooltipOptions}),options.align==="top")){const pad=foundry.helpers.interaction.TooltipManager.TOOLTIP_MARGIN_PX,actualTooltip=options.locked?html2.closest("aside"):game.tooltip.tooltip;if(actualTooltip){const bounds=target.getBoundingClientRect(),maxH=window.innerHeight-actualTooltip.offsetHeight;actualTooltip.style.top=`${Math.clamp(bounds.top,pad,maxH-pad)}px`}}},!0)}__name(createTooltipListener,"createTooltipListener"),__name2(createTooltipListener,"createTooltipListener");function createNPCAttackTraitsAndTags(item){const tags=item.system.traits.value.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.npcAttackTraits));item.system.action!=="strike"&&item.system.area&&tags.push({label:createEffectAreaLabel(item.system.area)});const range=item.range;if(range&&!item.system.traits.config?.thrown){const description=game.i18n.localize("PF2E.TraitDescriptionRange");if(range.increment)tags.push({label:game.i18n.format("PF2E.Item.NPCAttack.Tags.RangeIncrementN",{n:range.increment}),description});else if(range.max){const label=game.i18n.format("PF2E.Item.NPCAttack.Tags.RangeN",{n:range.max});tags.push({label,description})}}return tags.sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang))}__name(createNPCAttackTraitsAndTags,"createNPCAttackTraitsAndTags"),__name2(createNPCAttackTraitsAndTags,"createNPCAttackTraitsAndTags");const actionImgMap={0:"systems/pf2e/icons/actions/FreeAction.webp",free:"systems/pf2e/icons/actions/FreeAction.webp",1:"systems/pf2e/icons/actions/OneAction.webp",2:"systems/pf2e/icons/actions/TwoActions.webp",3:"systems/pf2e/icons/actions/ThreeActions.webp","1 or 2":"systems/pf2e/icons/actions/OneTwoActions.webp","1 to 3":"systems/pf2e/icons/actions/OneThreeActions.webp","2 or 3":"systems/pf2e/icons/actions/TwoThreeActions.webp",reaction:"systems/pf2e/icons/actions/Reaction.webp",passive:"systems/pf2e/icons/actions/Passive.webp"};function getActionIcon(action2,fallback="systems/pf2e/icons/actions/Empty.webp"){if(action2===null)return actionImgMap.passive;const value=typeof action2!="object"?action2:action2.type==="action"?action2.value:action2.type,sanitized=String(value??"").toLowerCase().trim();return actionImgMap[sanitized]??fallback}__name(getActionIcon,"getActionIcon"),__name2(getActionIcon,"getActionIcon");class RollNotePF2e{static{__name(this,"RollNotePF2e")}static{__name2(this,"RollNotePF2e")}selector;title;text;predicate;outcome;visibility;rule;constructor(params){this.selector=params.selector,this.title=params.title??null,this.text=params.text,this.predicate=new Predicate(params.predicate??[]),this.outcome=[...params.outcome??[]],this.visibility=params.visibility??null,this.rule=params.rule??null}static notesToHTML(notes){return notes.length===0?null:createHTMLElement("ul",{classes:["notes"],children:[...notes.flatMap(n2=>[`
`,n2.toHTML()]),`
`]})}toHTML(){const element=createHTMLElement("li",{classes:["roll-note"],dataset:{itemId:this.rule?.item.id,visibility:this.visibility},innerHTML:game.i18n.localize(this.text)});if(element.childNodes.length===1&&element.firstChild instanceof HTMLElement&&(element.innerHTML=element.firstChild.innerHTML),this.title){const strong=createHTMLElement("strong",{innerHTML:game.i18n.localize(this.title)});element.prepend(strong," ")}return element}clone(){return new RollNotePF2e({...this.toObject(),rule:this.rule})}toObject(){return{selector:this.selector,title:this.title,text:this.text,predicate:this.predicate.toObject(),outcome:this.outcome,visibility:this.visibility}}}function CheckFeat(actor,slug){return!!actor.items.find(i=>i.slug===slug&&i.type==="feat")}__name(CheckFeat,"CheckFeat"),__name2(CheckFeat,"CheckFeat");function toggleRiskySurgery(actor,value){if(value===null)return null;const rollOption=actor.rules.find(r2=>r2.key==="RollOption"&&"option"in r2&&r2.option==="risky-surgery");if(!rollOption)return null;const currentValue=rollOption.value;return rollOption.value!==value&&(rollOption.value=value),currentValue}__name(toggleRiskySurgery,"toggleRiskySurgery"),__name2(toggleRiskySurgery,"toggleRiskySurgery");async function treatWounds(options){const actor=(Array.isArray(options.actors)?options.actors:[options.actors])[0];if(!actor||!actor.isOfType("creature")){ui.notifications.error("PF2E.ErrorMessage.NoPCTokenSelected",{localize:!0});return}const medicineName=game.i18n.localize("PF2E.Skill.Medicine"),chirurgeon=CheckFeat(actor,"chirurgeon"),naturalMedicine=CheckFeat(actor,"natural-medicine"),domIdAppend=foundry.utils.randomID(),riskySurgeryChecked=actor.getRollOptions(["medicine"]).includes("risky-surgery")?" checked":"";new foundry.appv1.api.Dialog({title:game.i18n.localize("PF2E.Actions.TreatWounds.Label"),content:`
<div>${game.i18n.localize("PF2E.Actions.TreatWounds.Label")}</div>
<hr/>
<form>
<div class="form-group">
<label for="skill-${domIdAppend}">${game.i18n.localize("PF2E.Actions.TreatWounds.SkillSelect")}</label>
<select id="skill-${domIdAppend}"${!chirurgeon&&!naturalMedicine?" disabled":""}>
  ${chirurgeon?`<option value="crafting">${game.i18n.localize("PF2E.Skill.Crafting")}</option>`:""}
  ${naturalMedicine?`<option value="nature">${game.i18n.localize("PF2E.Skill.Nature")}</option>`:""}
  <option value="medicine">${medicineName}</option>
</select>
</div>
<div class="form-group">
<label for="dc-type-${domIdAppend}">${game.i18n.format("PF2E.InlineCheck.DCWithName",{name:medicineName})}</label>
<select id="dc-type-${domIdAppend}" name="dc-type">
  <option value="1">${game.i18n.localize("PF2E.Actions.TreatWounds.DC.Trained")}</option>
  <option value="2">${game.i18n.localize("PF2E.Actions.TreatWounds.DC.Expert")}</option>
  <option value="3">${game.i18n.localize("PF2E.Actions.TreatWounds.DC.Master")}</option>
  <option value="4">${game.i18n.localize("PF2E.Actions.TreatWounds.DC.Legendary")}</option>
</select>
</div>
<div class="form-group">
<label for="modifier-${domIdAppend}">${game.i18n.localize("PF2E.Actions.TreatWounds.DC.Mod")}</label>
<input id="modifier-${domIdAppend}" type="number" />
</div>
${CheckFeat(actor,"risky-surgery")?`<div class="form-group">
<label for="risky-surgery-${domIdAppend}">${game.i18n.localize("PF2E.Actions.TreatWounds.Feats.RiskySurgery")}</label>
<input type="checkbox" id="risky-surgery-${domIdAppend}"${riskySurgeryChecked} />
</div>`:""}
${CheckFeat(actor,"mortal-healing")?`<div class="form-group">
<label for="mortal-healing-${domIdAppend}">${game.i18n.localize("PF2E.Actions.TreatWounds.Feats.MortalHealing")}</label>
<input type="checkbox" id="mortal-healing-${domIdAppend}" checked />
</div>`:""}
</form>
`,buttons:{yes:{icon:fontAwesomeIcon("hand-holding-medical").outerHTML,label:game.i18n.localize("PF2E.Actions.TreatWounds.Label"),callback:__name2($html=>treat(actor,$html,options.event,domIdAppend),"callback")},no:{icon:fontAwesomeIcon("times").outerHTML,label:game.i18n.localize("Cancel")}},default:"yes"}).render(!0)}__name(treatWounds,"treatWounds"),__name2(treatWounds,"treatWounds");async function treat(actor,$html,event2=null,domIdAppend){const html2=$html[0],mod=Number(html2.querySelector(`#modifier-${domIdAppend}`)?.value)||0,requestedProf=Number(html2.querySelector(`#dc-type-${domIdAppend}`)?.value)||1,riskySurgery=!!html2.querySelector(`#risky-surgery-${domIdAppend}`)?.checked,mortalHealing=!!html2.querySelector(`#mortal-healing-${domIdAppend}`)?.checked,skillSlug=html2.querySelector(`#skill-${domIdAppend}`)?.value??"medicine",skill=actor.skills[skillSlug];if(!skill?.proficient){const skillName=objectHasKey(CONFIG.PF2E.skills,skillSlug)?game.i18n.localize(CONFIG.PF2E.skills[skillSlug].label):skillSlug,message=game.i18n.format("PF2E.Actions.TreatWounds.Error",{name:actor.name,skill:skillName});ui.notifications.warn(message);return}const rank=skill.rank??1,usedProf=requestedProf<=rank?requestedProf:rank,medicBonus=CheckFeat(actor,"medic-dedication")?(usedProf-1)*5:0,magicHandsBonus=CheckFeat(actor,"magic-hands")?actor.system.details.level.value:0,dcValue=[15,20,30,40][usedProf-1]+mod,bonus=[0,10,30,50][usedProf-1]+medicBonus+magicHandsBonus,rollOptions=actor.getRollOptions(["all","skill-check","medicine"]);rollOptions.push("action:treat-wounds"),riskySurgery&&rollOptions.push("risky-surgery");const dc={value:dcValue,visible:!0},increaseDoS=__name2(locKey=>({adjustments:{success:{label:`PF2E.Actions.TreatWounds.Rolls.${locKey}`,amount:DEGREE_ADJUSTMENT_AMOUNTS.INCREASE}}}),"increaseDoS");(actor.synthetics.degreeOfSuccessAdjustments.medicine??=[]).push(...riskySurgery?[increaseDoS("RiskySurgery")]:mortalHealing?[increaseDoS("MortalHealing")]:[]);const previoustRSValue=toggleRiskySurgery(actor,riskySurgery);await skill.check.roll({dc,...eventToRollParams(event2,{type:"check"}),extraRollOptions:rollOptions,callback:__name2(async(_roll,outcome,message)=>{Hooks.once("renderChatMessageHTML",m=>{if(m.id!==message.id)return;const flags=foundry.utils.mergeObject(m._source.flags,{pf2e:{treatWoundsMacroFlag:{bonus}}},{inplace:!1});m.update({flags},{render:!1})}),treatWoundsMacroCallback({actor,bonus,message,outcome})},"callback")}),toggleRiskySurgery(actor,previoustRSValue)}__name(treat,"treat"),__name2(treat,"treat");async function treatWoundsMacroCallback({actor,bonus,message,originalMessageId,outcome}){const successLabel=outcome?game.i18n.localize(`PF2E.Check.Result.Degree.Check.${outcome}`):"",magicHands=CheckFeat(actor,"magic-hands"),riskySurgery=!!message.flags.pf2e.modifiers?.some(m=>m.slug==="risky-surgery"&&m.enabled),bonusString=bonus>0?`+ ${bonus}`:"",healFormula=(()=>{switch(outcome){case"criticalSuccess":return magicHands?`4d10${bonusString}`:`4d8${bonusString}`;case"success":return magicHands?`2d10${bonusString}`:`2d8${bonusString}`;case"criticalFailure":return"1d8";default:return null}})();if(originalMessageId){const messages=game.messages.contents.slice(game.messages.size-25).filter(m=>m.flags.pf2e.origin?.messageId===originalMessageId),toDelete2=[];for(const m of messages)toDelete2.push(m.delete());await Promise.all(toDelete2)}const speaker=ChatMessagePF2e.getSpeaker({actor}),flags=foundry.utils.mergeObject(message.toObject().flags,{pf2e:{origin:{messageId:message.id}}});if(riskySurgery&&ChatMessagePF2e.create({flags,flavor:`<strong>${game.i18n.localize("PF2E.Actions.TreatWounds.Rolls.RiskySurgery")}</strong>`,rolls:[(await new DamageRoll("{1d8[slashing]}").roll()).toJSON()],speaker}),healFormula){const formulaModifier=outcome==="criticalFailure"?"":"[healing]",healRoll=await new DamageRoll(`{(${healFormula})${formulaModifier}}`).roll(),rollType=outcome!=="criticalFailure"?game.i18n.localize("PF2E.Actions.TreatWounds.Rolls.TreatWounds"):game.i18n.localize("PF2E.Actions.TreatWounds.Rolls.TreatWoundsCriticalFailure");ChatMessagePF2e.create({flags,flavor:`<strong>${rollType}</strong> (${successLabel})`,rolls:[healRoll.toJSON()],speaker})}}__name(treatWoundsMacroCallback,"treatWoundsMacroCallback"),__name2(treatWoundsMacroCallback,"treatWoundsMacroCallback");class BaseStatistic{static{__name(this,"BaseStatistic")}static{__name2(this,"BaseStatistic")}actor;slug;label;data;domains;modifiers;constructor(actor,data){this.actor=actor,this.slug=data.slug,this.label=game.i18n.localize(data.label).trim(),this.data={...data},this.domains=n(data.domains??=[]);const test=this.domains.length>0?this.createRollOptions():null,modifiers=[data.modifiers??[],extractModifiers(this.actor.synthetics,this.domains)].flat().map(m=>m.clone({domains:this.domains},{test}));this.modifiers=new StatisticModifier("",modifiers).modifiers}createRollOptions(domains=this.domains){return new Set(this.actor.getRollOptions(domains))}}class IWR{static{__name(this,"IWR")}static{__name2(this,"IWR")}type;exceptions;definition;source;#customLabel;static get disjuncter(){return this.#disjunctor??=new Intl.ListFormat(game.i18n.lang,{style:"long",type:"disjunction"})}static#disjunctor=null;constructor(data){this.type=data.type,this.exceptions=foundry.utils.deepClone(data.exceptions??[]),this.definition=data.definition??null,this.source=data.source??null,this.#customLabel=this.type==="custom"?data.customLabel??null:null}get label(){return this.#createLabel({withValue:this.value!==void 0})}get applicationLabel(){return this.#createLabel({withValue:!1})}#createLabel({withValue}){const type2=this.typeLabel,exceptions=IWR.disjuncter.format(this.exceptions.map(e2=>game.i18n.localize(typeof e2=="string"?this.typeLabels[e2]:e2.label))),doubleVs=IWR.disjuncter.format(this.doubleVs?.map(e2=>game.i18n.localize(typeof e2=="string"?this.typeLabels[e2]:e2.label))??[]),key=this.exceptions.length>0?this.doubleVs?.length?"ExceptionsDoubleVs":"Exceptions":this.doubleVs?.length?"DoubleVs":"Simple",value=withValue?this.value??"":"";return game.i18n.format(`PF2E.Damage.IWR.CompositeLabel.${key}`,{type:type2,value,exceptions,doubleVs}).replace(/\s+/g," ").trim()}get typeLabel(){return game.i18n.localize(this.#customLabel??this.typeLabels[this.type])}describe(iwrType){if(e$2(iwrType))return iwrType.definition;switch(iwrType){case"air":case"alchemical":case"earth":case"light":case"metal":case"olfactory":case"prediction":case"radiation":case"time":case"visual":case"water":case"wood":return[`item:trait:${iwrType}`];case"all-damage":return["damage"];case"arcane":case"divine":case"occult":case"primal":return[{or:[`item:trait:${iwrType}`,`origin:action:trait:${iwrType}`]}];case"area-damage":return["area-damage"];case"arrow-vulnerability":return["item:group:bow"];case"auditory":return["item:trait:auditory"];case"axes":case"axe-vulnerability":return["item:group:axe"];case"critical-hits":return["check:outcome:critical-success"];case"custom":return this.definition??[];case"disease":return["item:trait:disease"];case"emotion":return["item:type:effect","item:trait:emotion"];case"energy":case"physical":return[`damage:category:${iwrType}`];case"fear-effects":return["item:type:effect","item:trait:fear"];case"ghost-touch":return[{or:["item:rune:property:astral","item:rune:property:ghost-touch","item:rune:property:greater-astral"]}];case"holy":return[{or:["origin:action:trait:holy","item:trait:holy"]}];case"magic":return[{or:["origin:action:trait:impulse","item:from-spell","item:type:spell"]}];case"magical":return[{or:["item:magical","origin:action:trait:magical",...MAGIC_TRADITIONS.map(t2=>`origin:action:trait:${t2}`)]}];case"mental":return[{or:["damage:type:mental",{and:["item:type:effect","item:trait:mental"]}]}];case"non-magical":return[{not:"item:magical"}];case"object-immunities":return[{or:["damage:type:bleed","damage:type:mental","damage:type:poison","damage:type:spirit",{and:["item:type:condition",{or:["item:slug:doomed","item:slug:drained","item:slug:fatigued","item:slug:paralyzed","item:slug:sickened","item:slug:unconscious"]}]}]}];case"persistent-damage":return[{or:["damage:category:persistent",{and:["item:type:condition","item:slug:persistent-damage"]}]}];case"precision":case"splash-damage":return[`damage:component:${iwrType==="splash-damage"?"splash":"precision"}`];case"spells":case"damage-from-spells":return["damage",{or:["item:type:spell","item:from-spell","item:trait:impulse"]}];case"unarmed-attacks":return["item:category:unarmed"];case"unholy":return[{or:["origin:action:trait:unholy","item:trait:unholy"]}];case"weapons":return["item:type:weapon",{not:"item:category:unarmed"}];default:{if(iwrType in CONFIG.PF2E.damageTypes)return[`damage:type:${iwrType}`];if(setHasElement(CONDITION_SLUGS,iwrType))return["item:type:condition",`item:slug:${iwrType}`];if(objectHasKey(CONFIG.PF2E.materialDamageEffects,iwrType))switch(iwrType){case"adamantine":return this instanceof Resistance?[{or:["damage:material:adamantine","damage:material:keep-stone"]}]:["damage:material:adamantine"];case"cold-iron":return this instanceof Weakness?[{or:["damage:material:cold-iron","damage:material:sovereign-steel"]}]:["damage:material:cold-iron"];case"duskwood":return[{or:["damage:material:duskwood",{and:["self:mode:undead","damage:material:peachwood"]}]}];case"silver":return this instanceof Weakness?[{or:["damage:material:silver","damage:material:dawnsilver"]}]:["damage:material:silver"];default:return[`damage:material:${iwrType}`]}return[`unhandled:${iwrType}`]}}}get predicate(){const typeStatements=this.describe(this.type),exceptions=this.exceptions.flatMap(exception=>{const described=this.describe(exception).filter(s=>s!=="damage");return described.length===1?described:{and:described}}),statements=[typeStatements,exceptions.length===0?[]:exceptions.length===1?{not:exceptions[0]}:{nor:exceptions}].flat();return new Predicate(statements)}toObject(){return{type:this.type,exceptions:foundry.utils.deepClone(this.exceptions),source:this.source,label:this.label}}test(statements){return this.predicate.test(statements)}}class Immunity extends IWR{static{__name(this,"Immunity")}static{__name2(this,"Immunity")}typeLabels=CONFIG.PF2E.immunityTypes}class Weakness extends IWR{static{__name(this,"Weakness")}static{__name2(this,"Weakness")}typeLabels=CONFIG.PF2E.weaknessTypes;value;applyOnce;constructor(data){super(data),this.value=data.value,this.applyOnce=data.applyOnce??APPLY_ONCE_WEAKNESSES.has(this.type)}toObject(){return{...super.toObject(),value:this.value}}}class Resistance extends IWR{static{__name(this,"Resistance")}static{__name2(this,"Resistance")}typeLabels=CONFIG.PF2E.resistanceTypes;value;doubleVs;constructor(data){super(data),this.value=data.value,this.doubleVs=foundry.utils.deepClone(data.doubleVs??[])}toObject(){return{...super.toObject(),value:this.value,doubleVs:foundry.utils.deepClone(this.doubleVs)}}getDoubledValue(damageDescription){return this.doubleVs.length===0?this.value:(this.doubleVs.length===1?new Predicate(this.describe(this.doubleVs[0])):new Predicate({or:this.doubleVs.map(doubleVs=>{const description=this.describe(doubleVs);return description.length===1?description[0]:{and:description}})})).test(damageDescription)?this.value*2:this.value}}const APPLY_ONCE_WEAKNESSES=new Set([...MAGIC_TRADITIONS,"air","arrow-vulnerability","axe-vulnerability","earth","ghost-touch","holy","metal","plant","radiation","salt-water","salt","spells","unholy","water","wood"]);class AttackTraitHelpers{static{__name(this,"AttackTraitHelpers")}static{__name2(this,"AttackTraitHelpers")}static getLabel(traitOrTag){const traits=CONFIG.PF2E.weaponTraits,tags=CONFIG.PF2E.otherWeaponTags;return traits[traitOrTag]??tags[traitOrTag]??traitOrTag}static getUnannotatedTrait(trait){return trait.replace(/-d?\d{1,3}$/,"")}static createAttackModifiers({item,domains}){const actor=item.actor;if(!actor)throw ErrorPF2e("The weapon must be embedded");return item.system.traits.value.flatMap(trait=>{const unannotatedTrait=this.getUnannotatedTrait(trait);switch(unannotatedTrait){case"volley":{if(!item.range?.increment)return[];const penaltyRange=Number(/-(\d+)$/.exec(trait)[1]);return new Modifier({slug:unannotatedTrait,label:this.getLabel(trait),modifier:-2,type:"untyped",ignored:!0,predicate:new Predicate({lte:["target:distance",penaltyRange]},{not:"self:ignore-volley-penalty"}),adjustments:extractModifierAdjustments(actor.synthetics.modifierAdjustments,domains,unannotatedTrait)})}case"sweep":return new Modifier({slug:unannotatedTrait,label:this.getLabel(trait),modifier:1,type:"circumstance",predicate:new Predicate("sweep-bonus")});case"backswing":return new Modifier({slug:unannotatedTrait,label:this.getLabel(trait),modifier:1,type:"circumstance",predicate:new Predicate("backswing-bonus")});default:return[]}})}}function setImmunitiesFromTraits(actor){if(actor.isOfType("character"))return;const traits=actor.system.traits.value,immunities=actor.attributes.immunities,existing=immunities.map(i=>i.type);if(traits.includes("construct")&&!traits.includes("eidolon")){const constructImmunities=["bleed","death-effects","disease","doomed","drained","fatigued","healing","nonlethal-attacks","paralyzed","poison","sickened","spirit","unconscious","vitality","void"];for(const immunityType of constructImmunities)existing.includes(immunityType)||immunities.push(new Immunity({type:immunityType,source:game.i18n.localize("PF2E.TraitConstruct")}))}if(traits.includes("mindless")&&!existing.includes("mental")&&immunities.push(new Immunity({type:"mental",source:game.i18n.localize("PF2E.TraitMindless")})),traits.includes("swarm"))for(const immunity of["grabbed","prone","restrained"])existing.includes(immunity)||immunities.push(new Immunity({type:immunity,source:game.i18n.localize("PF2E.TraitSwarm")}))}__name(setImmunitiesFromTraits,"setImmunitiesFromTraits"),__name2(setImmunitiesFromTraits,"setImmunitiesFromTraits");function imposeEncumberedCondition(actor){if(!game.pf2e.settings.encumbrance||!actor.inventory.bulk.isEncumbered||actor.conditions.bySlug("encumbered").length>0)return;const source2=game.pf2e.ConditionManager.getCondition("encumbered").toObject(),encumbered=new ConditionPF2e(Object.assign(source2,{_id:"xxxENCUMBEREDxxx"}),{parent:actor});actor.conditions.set(encumbered.id,encumbered),encumbered.prepareSiblingData(),encumbered.prepareActorData();for(const rule of encumbered.prepareRuleElements())rule.onApplyActiveEffects?.(),rule.beforePrepareData?.();const clumsy=actor.conditions.bySlug("clumsy").find(c=>c.active&&c.grantedBy===encumbered);for(const rule of clumsy?.rules??[])rule.beforePrepareData?.()}__name(imposeEncumberedCondition,"imposeEncumberedCondition"),__name2(imposeEncumberedCondition,"imposeEncumberedCondition");function upgradeWeaponTrait(trait){const match=/-d(4|6|8|10|12)$/.exec(trait),value=Number(match?.at(1));if(tupleHasValue(DAMAGE_DICE_FACES,value)){const upgraded=nextDamageDieSize({upgrade:`d${value}`});return trait.replace(new RegExp(String.raw`d${value}$`),upgraded)}return trait}__name(upgradeWeaponTrait,"upgradeWeaponTrait"),__name2(upgradeWeaponTrait,"upgradeWeaponTrait");function processTwoHandTrait(weapon){const traits=weapon.system.traits,twoHandFaces=Number(traits.value.find(t2=>t2.startsWith("two-hand-d"))?.replace("two-hand-d","")),diceFaces=Number(weapon.system.damage.die?.replace("d",""));weapon.handsHeld===2&&tupleHasValue(DAMAGE_DICE_FACES,twoHandFaces)&&twoHandFaces>diceFaces&&(weapon.system.damage.die=`d${twoHandFaces}`)}__name(processTwoHandTrait,"processTwoHandTrait"),__name2(processTwoHandTrait,"processTwoHandTrait");function getLoadedAmmo(weapon){if(!weapon.system.ammo?.capacity)return[];const ammo=weapon.subitems.filter(i=>i.isOfType("ammo")||i.isOfType("weapon")&&i.isAmmoFor(weapon));return t(ammo,i=>i.sort)}__name(getLoadedAmmo,"getLoadedAmmo"),__name2(getLoadedAmmo,"getLoadedAmmo");class WeaponAuxiliaryAction{static{__name(this,"WeaponAuxiliaryAction")}static{__name2(this,"WeaponAuxiliaryAction")}weapon;action;actions;carryType;hands;annotation;fullAnnotation;constructor({weapon,action:action2,annotation,hands}){this.weapon=weapon,this.action=action2,this.annotation=annotation??null,this.hands=hands??null;const[actions,carryType,fullPurpose]=(()=>{switch(annotation){case"draw":return[1,"held",`${annotation}${hands}H`];case"pick-up":return[1,"held",`${annotation}${hands}H`];case"retrieve":{const{container}=weapon;if(container?.isHeld)return[1,"held",`${annotation}${hands}H`];const usage=container?.system.usage;return[usage?.type==="held"||usage?.where==="backpack"?2:1,"held",`${annotation}${hands}H`]}case"grip":return[action2==="interact"?1:0,"held",annotation];case"sheathe":return[1,"worn",annotation];case"modular":return[1,null,annotation];case"drop":return[0,"dropped",annotation];case"tower-shield":return[this.action==="take-cover"?1:0,null,null];default:return[1,null,null]}})();this.actions=actions,this.carryType=carryType,this.fullAnnotation=fullPurpose}get actor(){return this.weapon.parent}get label(){const actionKey=sluggify(this.action,{camel:"bactrian"}),purposeKey=this.fullAnnotation?sluggify(this.fullAnnotation,{camel:"bactrian"}):null;return purposeKey?game.i18n.localize(`PF2E.Actions.${actionKey}.${purposeKey}.Title`):game.i18n.localize(`PF2E.Actions.${actionKey}.ShortTitle`)}get glyph(){return getActionGlyph(this.actions)}get options(){if(this.annotation==="modular"){const toggles=this.weapon.system.traits.toggles;return createSheetOptions(t$3(CONFIG.PF2E.damageTypes,toggles.modular.options),[toggles.modular.selected??[]].flat())}return null}async execute({selection=null}={}){const{actor,weapon}=this,COVER_UUID="Compendium.pf2e.other-effects.Item.I9lfZUiCwMiGogVi";if(this.carryType)await actor.changeCarryType(this.weapon,{carryType:this.carryType,handsHeld:this.hands??0});else if(selection&&tupleHasValue(weapon.system.traits.toggles.modular.options,selection)){if(!await weapon.system.traits.toggles.update({trait:"modular",selected:selection}))return}else if(this.action==="raise-a-shield"){if(actor.itemTypes.effect.some(e2=>e2.slug==="raise-a-shield"))return;const effect=await fromUuid("Compendium.pf2e.equipment-effects.Item.2YgXoHvJfrDHucMr");effect instanceof EffectPF2e&&await actor.createEmbeddedDocuments("Item",[{...effect.toObject(),_id:null}])}else if(this.action==="take-cover"){const effect=await fromUuid(COVER_UUID);if(effect instanceof EffectPF2e){const data={...effect.toObject(),_id:null};data.system.traits.otherTags.push("tower-shield");const rule=data.system.rules.find(r2=>r2.key==="ChoiceSet");rule&&(rule.selection={bonus:4,level:"greater"}),await actor.createEmbeddedDocuments("Item",[data])}}else if(this.action==="end-cover")await actor.itemTypes.effect.find(e2=>e2.sourceId===COVER_UUID)?.delete();else if(this.action==="parry"){if(actor.itemTypes.effect.some(e2=>e2.slug==="parry"))return;const effect=await fromUuid("Compendium.pf2e.equipment-effects.Item.fRlvmul3LbLo2xvR");effect instanceof EffectPF2e&&await actor.createEmbeddedDocuments("Item",[{...effect.toObject(),_id:null}])}if(!game.combat)return;const templates={flavor:"./systems/pf2e/templates/chat/action/flavor.hbs",content:"./systems/pf2e/templates/chat/action/content.hbs"},actionKey=sluggify(this.action,{camel:"bactrian"}),annotationKey=this.annotation?sluggify(this.annotation,{camel:"bactrian"}):null,fullAnnotationKey=this.fullAnnotation?sluggify(this.fullAnnotation,{camel:"bactrian"}):null,flavorAction={title:`PF2E.Actions.${actionKey}.Title`,subtitle:fullAnnotationKey?`PF2E.Actions.${actionKey}.${fullAnnotationKey}.Title`:null,glyph:this.glyph},[traits,message]=["raise-a-shield","parry"].includes(this.action)?[[],`PF2E.Actions.${actionKey}.Content`]:["take-cover","end-cover"].includes(this.action)?[[],`PF2E.Actions.${actionKey}.${annotationKey}.Description`]:[[traitSlugToObject("manipulate",CONFIG.PF2E.actionTraits)],`PF2E.Actions.${actionKey}.${fullAnnotationKey}.Description`],flavor=await foundry.applications.handlebars.renderTemplate(templates.flavor,{action:flavorAction,traits}),content=await foundry.applications.handlebars.renderTemplate(templates.content,{imgPath:weapon.img,message:game.i18n.format(message,{actor:actor.name,weapon:weapon.name,shield:weapon.shield?.name??weapon.name,damageType:game.i18n.localize(`PF2E.Damage.RollFlavor.${selection}`)})}),token=actor.getActiveTokens(!1,!0).shift();await ChatMessagePF2e.create({content,speaker:ChatMessagePF2e.getSpeaker({actor,token}),flavor,style:CONST.CHAT_MESSAGE_STYLES.EMOTE})}}class PCAttackTraitHelpers extends AttackTraitHelpers{static{__name(this,"PCAttackTraitHelpers")}static{__name2(this,"PCAttackTraitHelpers")}static adjustWeapon(weapon){const traits=weapon.system.traits.value;for(const trait of[...traits])switch(trait.replace(/-d?\d{1,3}$/,"")){case"fatal-aim":{if(weapon.range?.increment&&weapon.handsHeld===2){const fatal=trait.replace("-aim","");objectHasKey(CONFIG.PF2E.weaponTraits,fatal)&&!traits.includes(fatal)&&traits.push(fatal)}break}case"jousting":{if(weapon.handsHeld===1){const die=/(d\d{1,2})$/.exec(trait)?.[1];tupleHasValue(DAMAGE_DIE_SIZES,die)&&(weapon.system.damage.die=die)}break}}}static createAttackModifiers({item,domains}){const actor=item.actor;if(!actor)throw ErrorPF2e("The weapon must be embedded");const traitsAndTags=[item.system.traits.value,item.system.traits.otherTags].flat().filter(e$1),synthetics=actor.synthetics.modifierAdjustments,pcSpecificModifiers=traitsAndTags.flatMap(trait=>{const unannotatedTrait=this.getUnannotatedTrait(trait);switch(unannotatedTrait){case"kickback":return new Modifier({slug:unannotatedTrait,label:CONFIG.PF2E.weaponTraits.kickback,modifier:-2,type:"circumstance",predicate:new Predicate({lt:["attribute:str:mod",2]}),adjustments:extractModifierAdjustments(synthetics,domains,unannotatedTrait)});case"improvised":return new Modifier({slug:unannotatedTrait,label:this.getLabel(trait),modifier:-2,type:"item",predicate:new Predicate({not:"self:ignore-improvised-penalty"}),adjustments:extractModifierAdjustments(synthetics,domains,unannotatedTrait)});default:return[]}});return[...super.createAttackModifiers({item,domains}),...pcSpecificModifiers]}}function imposeOversizedWeaponCondition(actor){if(actor.conditions.clumsy)return;const wieldedOversizedWeapon=actor.itemTypes.weapon.find(w=>w.isEquipped&&w.isOversized&&w.category!=="unarmed"),compendiumCondition=game.pf2e.ConditionManager.getCondition("clumsy"),conditionSource=wieldedOversizedWeapon&&actor.conditions.bySlug("clumsy").length===0?foundry.utils.mergeObject(compendiumCondition.toObject(),{_id:"xxxxOVERSIZExxxx",system:{slug:"clumsy",references:{parent:{id:wieldedOversizedWeapon.id}}}}):null;if(!conditionSource)return;const clumsyOne=new ItemProxyPF2e(conditionSource,{parent:actor});clumsyOne.prepareSiblingData(),clumsyOne.prepareActorData();for(const rule of clumsyOne.prepareRuleElements())rule.beforePrepareData?.();actor.conditions.set(clumsyOne.id,clumsyOne)}__name(imposeOversizedWeaponCondition,"imposeOversizedWeaponCondition"),__name2(imposeOversizedWeaponCondition,"imposeOversizedWeaponCondition");function getItemProficiencyRank(actor,item,itemOptions=new Set(item.getRollOptions("item"))){return item.isOfType("armor")?getArmorProficiencyRank(actor,item,itemOptions):getWeaponProficiencyRank(actor,item,itemOptions)}__name(getItemProficiencyRank,"getItemProficiencyRank"),__name2(getItemProficiencyRank,"getItemProficiencyRank");function getArmorProficiencyRank(actor,armor,itemOptions){return Object.entries(actor.system.proficiencies.defenses).filter(([key,proficiency])=>armor?armor.category===key?!0:proficiency.definition?.test(itemOptions)??!1:key==="unarmored").map(([_k,v])=>v).reduce((best,p)=>p.rank>best.rank?p:best,{rank:0}).rank}__name(getArmorProficiencyRank,"getArmorProficiencyRank"),__name2(getArmorProficiencyRank,"getArmorProficiencyRank");function getWeaponProficiencyRank(actor,weapon,itemOptions){const proficiencies=actor.system.proficiencies,categoryRank=proficiencies.attacks[weapon.category]?.rank??0,groupRank=proficiencies.attacks[`weapon-group-${weapon.group}`]?.rank??0,baseWeapon=CONFIG.PF2E.equivalentWeapons[weapon.baseType??""]??weapon.baseType,baseWeaponRank=proficiencies.attacks[`weapon-base-${baseWeapon}`]?.rank??0,syntheticRanks=Object.values(proficiencies.attacks).filter(p=>!!p?.definition?.test(itemOptions)).map(p=>p.rank);return Math.max(categoryRank,groupRank,baseWeaponRank,...syntheticRanks)}__name(getWeaponProficiencyRank,"getWeaponProficiencyRank"),__name2(getWeaponProficiencyRank,"getWeaponProficiencyRank");function createForceOpenPenalty(actor,domains){const slug="no-crowbar",{modifierAdjustments}=actor.synthetics;return new Modifier({slug,label:"PF2E.Actions.ForceOpen.NoCrowbarPenalty",type:"item",modifier:-2,predicate:["action:force-open","action:force-open:prying"],hideIfDisabled:!0,adjustments:extractModifierAdjustments(modifierAdjustments,domains,slug)})}__name(createForceOpenPenalty,"createForceOpenPenalty"),__name2(createForceOpenPenalty,"createForceOpenPenalty");function createShoddyPenalty(actor,item,domains){if(!actor.isOfType("character")||!item?.isShoddy)return null;const slug="shoddy";return new Modifier({label:"PF2E.Item.Physical.OtherTag.Shoddy",type:"item",slug,modifier:-2,adjustments:extractModifierAdjustments(actor.synthetics.modifierAdjustments,domains,slug)})}__name(createShoddyPenalty,"createShoddyPenalty"),__name2(createShoddyPenalty,"createShoddyPenalty");function createPonderousPenalty(actor){const armor=actor.wornArmor,slug="ponderous";if(!armor?.traits.has(slug))return null;const penaltyValue=actor.abilities.str.mod>=(armor.strength??-1/0)?-1:armor.checkPenalty||-1;return new Modifier({label:"PF2E.TraitPonderous",type:"untyped",slug,modifier:penaltyValue,adjustments:extractModifierAdjustments(actor.synthetics.modifierAdjustments,["all","initiative"],slug)})}__name(createPonderousPenalty,"createPonderousPenalty"),__name2(createPonderousPenalty,"createPonderousPenalty");function getWeaponAuxiliaryActions(weapon){const actor=weapon.actor,auxiliaryActions=[],isRealItem=actor.items.has(weapon.id),traitsArray=weapon.system.traits.value;if(weapon.system.traits.toggles.modular.options.length>0&&auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"interact",annotation:"modular"})),weapon.isEquipped&&traitsArray.includes("parry")&&!actor.rollOptions.all["self:effect:parry"]&&auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"parry"})),isRealItem&&weapon.category!=="unarmed"&&!weapon.parentItem){const usage=weapon.system.usage,weaponAsShield=weapon.shield,canWield2H=usage.hands===2||usage.hands===1&&actor.handsFree>0&&!!weaponAsShield||traitsArray.some(t2=>t2.startsWith("fatal-aim"))||traitsArray.some(t2=>t2.startsWith("two-hand"));switch(weapon.carryType){case"held":{if(weaponAsShield){const hasShieldRaised=!!actor.rollOptions.all["self:effect:raise-a-shield"],hasGreaterCover=!!actor.rollOptions.all["self:cover-level:greater"];if(!hasShieldRaised)auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"raise-a-shield"}));else if(weaponAsShield.isTowerShield&&weaponAsShield.isRaised){const action2=hasGreaterCover?"end-cover":"take-cover",annotation="tower-shield";auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:action2,annotation}))}}weapon.handsHeld===2?auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"release",annotation:"grip",hands:1})):weapon.handsHeld===1&&canWield2H&&auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"interact",annotation:"grip",hands:2})),auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"interact",annotation:"sheathe",hands:0})),auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"release",annotation:"drop",hands:0}));break}case"worn":{auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"interact",annotation:"draw",hands:1})),canWield2H&&auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"interact",annotation:"draw",hands:2}));break}case"stowed":{auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"interact",annotation:"retrieve",hands:1}));break}case"dropped":{auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"interact",annotation:"pick-up",hands:1})),canWield2H&&auxiliaryActions.push(new WeaponAuxiliaryAction({weapon,action:"interact",annotation:"pick-up",hands:2}));break}}}return auxiliaryActions}__name(getWeaponAuxiliaryActions,"getWeaponAuxiliaryActions"),__name2(getWeaponAuxiliaryActions,"getWeaponAuxiliaryActions");function getAttackAmmo(weapon,{ammos}){if(!weapon.system.expend)return null;const ammo=weapon.ammo,compatible=ammos.filter(a=>a.isAmmoFor(weapon)),selected=ammo?{id:ammo.id,compatible:ammo.isAmmoFor(weapon)}:null,loaded=getLoadedAmmo(weapon),capacity=weapon.system.ammo?.capacity??0,remaining=loaded.every(a=>a.isOfType("ammo")&&a.isMagazine&&a.system.uses.value===0)?1:Math.max(0,capacity-t$1(loaded,l=>l.quantity)),numActions=weapon.system.traits.value.includes("repeating")?3:Number(weapon.reload),reloadGlyph=numActions>0&&Number.isInteger(numActions)?getActionGlyph(numActions):null;return{compatible:compatible.map(a=>({id:a.id,label:`${a.name} (${a.quantity})`})),selected,loaded:loaded.map(ammo2=>{const isMagazine=ammo2.isOfType("ammo")&&ammo2.system.uses.max>1;return{...t$3(ammo2,["id","name","img"]),quantity:isMagazine?ammo2.system.uses.value:ammo2.quantity,max:isMagazine?ammo2.system.uses.max:remaining+ammo2.quantity,isTemporary:ammo2.isTemporary}}),requiresReload:weapon.reload!=="0"||weapon.system.traits.value.includes("repeating"),reloadGlyph,capacity,remaining}}__name(getAttackAmmo,"getAttackAmmo"),__name2(getAttackAmmo,"getAttackAmmo");class RollContext{static{__name(this,"RollContext")}static{__name2(this,"RollContext")}unresolved;domains;rollOptions;traits;viewOnly;isAttack;isMeleeAttack;constructor(params){this.viewOnly=!!params.viewOnly,this.domains=params.domains,this.rollOptions=params.options,this.isAttack=["attack","attack-roll","attack-damage"].some(d=>this.domains.includes(d));const origin={actor:params.origin?.actor??params.origin?.token?.actor??null,statistic:params.origin?.statistic??null,token:(()=>{if(params.origin?.token)return params.origin.token;const activeTokens=params.origin?.actor?.getActiveTokens(!0,!0)??[];return activeTokens.find(t2=>t2.object?.controlled)??activeTokens.shift()??null})(),item:params.origin?.item?.actor===params.origin?.actor?params.origin?.item??null:null},targetActor=params.target?.actor??params.target?.token?.actor,target=!params.viewOnly&&targetActor?{actor:targetActor,statistic:params.target?.statistic??null,token:params.target?.token??targetActor?.getActiveTokens(!0,!0).shift()??null,item:params.origin?.item?null:params.target?.item??null}:null;this.unresolved={origin,target};const item=this.item;this.traits=params.traits??[],this.traits.length===0&&item?.isOfType("action","spell")&&(this.traits=[...item.system.traits.value]),this.isMeleeAttack=this.isAttack&&!!(item?.isOfType("action","melee","spell","weapon")&&item.isMelee)}get item(){return this.unresolved.origin?.item??this.unresolved.target?.item??null}get rollerRole(){return this.unresolved.origin?.statistic?"origin":"target"}get isFlankingAttack(){if(this.viewOnly)return!1;const unresolved=this.unresolved,originToken=unresolved.origin?.token?.object,targetToken=unresolved.target?.token?.object;if(!originToken||!targetToken||!this.isMeleeAttack)return!1;const reach=unresolved.origin?.item?.isOfType("action","weapon","melee")?unresolved.origin.actor?.getReach({action:"attack",weapon:unresolved.origin.item}):unresolved.origin?.actor?.getReach({action:"attack"});return typeof reach=="number"&&originToken.isFlanking(targetToken,{reach})}async resolve(){const unresolved=this.unresolved,[originToken,targetToken]=[unresolved.origin?.token??null,unresolved.target?.token??null],selfRole=this.rollerRole,opposingRole=selfRole==="origin"?"target":"origin",distance=originToken?.object&&targetToken?.object?originToken.object.distanceTo(targetToken.object):null,rollingActor=await this.#cloneActor(selfRole,{distance}),rollerStatistic=this.#getClonedStatistic(rollingActor),resolvedDomains=this.domains.includes("damage")?this.domains:(rollerStatistic instanceof StatisticModifier?rollerStatistic.domains:rollerStatistic?.check.domains)??this.domains,itemClone=rollerStatistic&&"item"in rollerStatistic?rollerStatistic.item:this.#cloneItem(rollingActor),itemOptions=itemClone?.getRollOptions("item")??[];rollerStatistic instanceof StatisticModifier&&itemClone?.isOfType("weapon")&&PCAttackTraitHelpers.adjustWeapon(itemClone);const distanceOption=Number.isInteger(distance)?`${opposingRole}:distance:${distance}`:null,rangeIncrement=itemClone?getRangeIncrement(itemClone,distance):null,rangeIncrementOption=rangeIncrement&&Number.isInteger(distance)?`${opposingRole}:range-increment:${rangeIncrement}`:null,rollOptions=new Set([...this.rollOptions,rollingActor?.getRollOptions(resolvedDomains),distanceOption,rangeIncrementOption,selfRole==="origin"?this.traits.map(t2=>`self:action:trait:${t2}`):[],itemOptions,this.isAttack?"attack":null].flat().filter(e$5)),actionTraits2=(()=>{const traits=this.traits;if(itemClone?.isOfType("weapon","melee")){const strikeAdjustments=[rollingActor?.synthetics.strikeAdjustments,getPropertyRuneStrikeAdjustments(itemClone.system.runes.property)].flat().filter(e$1);for(const adjustment of strikeAdjustments)adjustment.adjustTraits?.(itemClone,traits)}return n(traits)})(),opposingActor=await this.#cloneActor(opposingRole,{other:rollingActor,distance}),originIsSelf=selfRole==="origin";if(opposingActor){rollOptions.add(opposingRole);for(const option of opposingActor.getSelfRollOptions(opposingRole))rollOptions.add(option)}const originActor=originIsSelf?rollingActor:opposingActor,originIsRoller=originActor===rollingActor,origin=originActor?{actor:originActor,token:originToken,statistic:originIsRoller?rollerStatistic:null,item:originIsRoller?itemClone:null,self:originIsSelf,modifiers:[]}:null,targetActor=originIsSelf?opposingActor:rollingActor,target=targetActor?{actor:targetActor,token:targetToken,statistic:!originIsRoller&&rollerStatistic&&"check"in rollerStatistic?rollerStatistic:null,item:originIsRoller?null:itemClone,distance,self:!originIsSelf,rangeIncrement}:null;return{domains:resolvedDomains,options:rollOptions,origin,target,traits:actionTraits2}}async#cloneActor(which,{other=null,distance=null}={}){const unresolved=this.unresolved,uncloned=unresolved[which],opposingRole=which==="origin"?"target":"origin",opposingActor=other??unresolved[opposingRole]?.actor;if(!uncloned?.actor||!opposingActor)return uncloned?.actor??null;const item=this.item,itemOptions=item?.getRollOptions("item")??[],distanceOption=Number.isInteger(distance)?`${opposingRole}:distance:${distance}`:null,markOptions=(()=>{const originActor=unresolved.origin?.actor,originUuid=unresolved.origin?.token?.uuid,targetActor=unresolved.target?.actor,targetUuid=unresolved.target?.token?.uuid,originMark=originUuid?targetActor?.synthetics.tokenMarks.get(originUuid)??[]:[],targetMark=targetUuid?originActor?.synthetics.tokenMarks.get(targetUuid)??[]:[],[originPrefix,targetPrefix]=which==="target"?["origin","self"]:["self","target"];return[...originMark.map(mark=>`${originPrefix}:mark:${mark}`),...targetMark.map(mark=>`${targetPrefix}:mark:${mark}`)]})(),ephemeralEffects=await extractEphemeralEffects({affects:which,origin:unresolved.origin?.actor??null,target:unresolved.target?.actor??null,item,domains:this.domains,options:[...this.rollOptions,itemOptions,markOptions,distanceOption??[]].flat()}),isFlankingAttack=this.isFlankingAttack;if(which==="target"&&isFlankingAttack&&isOffGuardFromFlanking(uncloned.actor,opposingActor)){const name2=game.i18n.localize("PF2E.Item.Condition.Flanked"),condition=game.pf2e.ConditionManager.getCondition("off-guard",{name:name2});ephemeralEffects.push(condition.toObject())}const perspectivePrefix=which==="origin"?this.rollerRole==="origin"?"self":"target":"origin",actionOptions=item?.isOfType("action","feat")&&!item.actionCost?[]:this.traits.map(t2=>`${perspectivePrefix}:action:trait:${t2}`),allyOrEnemyOption=uncloned.actor.alliance?uncloned.actor.alliance===opposingActor.alliance?`${opposingRole}:ally`:`${opposingRole}:enemy`:null;return uncloned.actor.getContextualClone([this.rollOptions.values().toArray(),opposingRole,allyOrEnemyOption,opposingActor.getSelfRollOptions(opposingRole),distanceOption,markOptions,isFlankingAttack?`${perspectivePrefix}:flanking`:null,actionOptions,which==="target"?itemOptions:null].flat().filter(e$6),ephemeralEffects)}#cloneItem(originActor){const unresolved=this.unresolved,unclonedItem=this.item;if([unresolved.origin?.actor,unresolved.target?.actor].some(a=>a===unclonedItem?.actor))return unclonedItem;const originStatistic=unresolved.origin?.statistic;if(originStatistic&&"item"in originStatistic&&originStatistic.item?.isOfType("action","melee","spell","weapon"))return originStatistic.item;const maybeItemClone=unresolved.origin?.statistic?originActor?.items.get(unclonedItem?.id??""):null;return maybeItemClone?.isOfType("melee","weapon")?maybeItemClone:unclonedItem}#getClonedStatistic(clonedActor){const unresolvedRoller=this.unresolved[this.rollerRole],unresolvedStatistic=unresolvedRoller?.statistic??null;if(this.viewOnly)return unresolvedStatistic;const strikeActions=clonedActor?.system.actions??[],unclonedItem=this.item;if(unresolvedStatistic instanceof StatisticModifier)return strikeActions.find(action2=>!(unclonedItem?.name===action2.item.name||unclonedItem?._source.name===action2.item._source.name)||unclonedItem?.id!==action2.item.id?!1:unclonedItem.isOfType("melee")&&action2.item.isOfType("melee")?!0:action2.type==="strike"&&unclonedItem.isOfType("weapon")&&action2.item.isOfType("weapon")&&unclonedItem.isMelee===action2.item.isMelee&&unclonedItem.isThrown===action2.item.isThrown)??unresolvedStatistic;if(!unresolvedStatistic||!clonedActor||unresolvedRoller?.actor===clonedActor)return unresolvedStatistic;const clonedStatistic=clonedActor.getStatistic(unresolvedStatistic.slug),initialHeirarchy=this.#getStatisticHierarchy(unresolvedStatistic),clonedHeirarchy=this.#getStatisticHierarchy(clonedStatistic);return t$6(initialHeirarchy,clonedHeirarchy)?clonedStatistic??unresolvedStatistic:unresolvedStatistic}#getStatisticHierarchy(statistic){const results=[];let current=statistic;for(;current;)results.push(current.slug),current=current.base;return results.reverse()}}class CheckContext extends RollContext{static{__name(this,"CheckContext")}static{__name2(this,"CheckContext")}against;constructor(params){super(params),this.against=params.against??null}async resolve(){const baseContext=await super.resolve(),originIsSelf=!!baseContext.origin?.self,selfActor=originIsSelf?baseContext.origin?.actor:baseContext.target?.actor,opposingActor=originIsSelf?baseContext.target?.actor:baseContext.origin?.actor,mayHaveRangePenalty=!!selfActor&&originIsSelf&&this.domains.includes("attack-roll"),rangeIncrement=baseContext.target?.rangeIncrement??null,rangePenalty=mayHaveRangePenalty?calculateRangePenalty(selfActor,rangeIncrement,this.domains,baseContext.options):null;rangePenalty&&baseContext.origin?.modifiers.push(rangePenalty);const dcData=(()=>{const{domains,against}=this;if(!against)return null;const scope=domains.includes("attack")?"attack":"check",statistic=opposingActor?.getStatistic(against.replace(/-dc$/,""))?.dc;return statistic?{scope,statistic,slug:against,value:statistic.value}:null})();return{...baseContext,dc:dcData}}}class Statistic extends BaseStatistic{static{__name(this,"Statistic")}static{__name2(this,"Statistic")}attribute=null;rank=null;proficient=!0;base=null;lore;config;#check;#dc;constructor(actor,data,config={}){data.modifiers??=[];const domains=data.domains??=[],attributeModifier=actor.isOfType("character")&&data.attribute?data.modifiers.find(m=>m.type==="ability"&&m.ability===data.attribute)??createAttributeModifier({actor,attribute:data.attribute,domains}):null;data.attribute&&domains.push(`${data.attribute}-based`);const proficiencyModifier=actor.isOfType("character")&&typeof data.rank=="number"?data.modifiers.find(m=>m.type==="proficiency")??createProficiencyModifier({actor,rank:data.rank,domains}):null,baseModifiers=[attributeModifier,proficiencyModifier].filter(e$1),activeSlugs=new Set(baseModifiers.map(m=>m.slug));data.modifiers=data.modifiers.filter(m=>!activeSlugs.has(m.slug)),data.modifiers.unshift(...baseModifiers),super(actor,data),this.attribute=data.attribute??null,typeof data.lore=="boolean"&&(this.lore=data.lore),this.rank=data.rank??null,this.config=config,this.proficient=data.proficient===void 0?this.rank===null||this.rank>0:!!data.proficient,data.filter&&(this.modifiers=this.modifiers.filter(data.filter)),this.data.dc??={domains:[`${this.slug}-dc`]}}get attributeModifier(){return this.actor.isOfType("npc")?this.attribute?createAttributeModifier({actor:this.actor,attribute:this.attribute,domains:this.domains}):null:this.modifiers.find(m=>m.type==="ability"&&m.enabled&&m.ability===this.attribute)??null}get check(){return this.#check??=new StatisticCheck(this,this.data,this.config)}get dc(){return this.#dc??=new StatisticDifficultyClass(this,this.data,this.config)}get mod(){return this.check.mod}createRollOptions(domains=this.domains,args={}){const{item,extraRollOptions,target}=args,origin=args.origin??(item?.actor&&item.actor.uuid!==this.actor.uuid?item.actor:null),rollOptions=[];return domains.length>0&&rollOptions.push(...super.createRollOptions(domains)),typeof this.rank=="number"&&rollOptions.push(PROFICIENCY_RANK_OPTION[this.rank]),this.data.rollOptions&&rollOptions.push(...this.data.rollOptions),item&&(rollOptions.push(...item.getRollOptions("item")),(item.system.traits?.value??[]).includes("attack")&&rollOptions.push("trait:attack")),origin?rollOptions.push(...origin.getSelfRollOptions("origin")):target&&rollOptions.push(...target.getSelfRollOptions("target")),extraRollOptions&&rollOptions.push(...extraRollOptions),new Set(rollOptions)}withRollOptions(options){const newOptions=foundry.utils.mergeObject(this.config??{},options??{},{inplace:!1});return new Statistic(this.actor,foundry.utils.deepClone(this.data),newOptions)}clone(data){function maybeMergeArrays(arr1,arr2){if(!(!arr1&&!arr2))return[...new Set([arr1??[],arr2??[]].flat())]}__name(maybeMergeArrays,"maybeMergeArrays"),__name2(maybeMergeArrays,"maybeMergeArrays");const result=foundry.utils.mergeObject(foundry.utils.deepClone(this.data),data);result.domains=maybeMergeArrays(this.domains,data.domains),result.modifiers=maybeMergeArrays(this.data.modifiers,data.modifiers),result.rollOptions=maybeMergeArrays(this.data.rollOptions,data.rollOptions),result.check&&this.data.check&&(result.check.domains=maybeMergeArrays(this.data.check.domains,data.check?.domains),result.check.modifiers=maybeMergeArrays(this.data.check.modifiers,data.check?.modifiers)),result.dc&&this.data.dc&&(result.dc.domains=maybeMergeArrays(this.data.dc.domains,data.dc?.domains),result.dc.modifiers=maybeMergeArrays(this.data.dc.modifiers,data.dc?.modifiers));const Cls=this.constructor,extended=new Cls(this.actor,result,this.config);return extended.base=this,extended}extend(data){const extended=this.clone(data);return extended.base=this,extended}roll(args={}){return this.check.roll(args)}getChatData(options={}){const{check,dc}=this.withRollOptions(options),{map1,map2}=options.item?calculateMAPs(options.item,{domains:check?.domains??[],options:check?.createRollOptions(options)??[]}):{map1:-5,map2:-10};return{slug:this.slug,label:this.label,rank:this.rank,check:{mod:check.mod,breakdown:check.breakdown,label:check.label,map1,map2},dc:{value:dc.value,breakdown:dc.breakdown}}}getTraceData(options={}){const{check,dc}=this,valueProp=options.value??"mod",[label,value,totalModifier,breakdown,modifiers]=valueProp==="mod"?[this.label,check.mod,check.mod,check.breakdown,check.modifiers]:[dc.label||this.label,dc.value,dc.value-10,dc.breakdown,dc.modifiers];return{slug:this.slug,label,value,totalModifier,dc:dc.value,attribute:this.attribute,breakdown,modifiers:modifiers.map(m=>m.toObject())}}}class StatisticCheck{static{__name(this,"StatisticCheck")}static{__name2(this,"StatisticCheck")}parent;type;label;domains;mod;modifiers;constructor(parent,data,config={}){this.parent=parent,this.type=data.check?.type??"check",data.check=foundry.utils.mergeObject(data.check??{},{type:this.type});const checkDomains=new Set(["check",data.check.domains].flat().filter(e$1));this.type==="attack-roll"?(checkDomains.add("attack"),checkDomains.add("attack-roll"),checkDomains.add(`${this.parent.slug}-attack-roll`)):(checkDomains.add(`${this.parent.slug}-check`),this.type==="flat-check"&&(checkDomains.delete("check"),checkDomains.add("flat-check"))),data.check.domains=Array.from(checkDomains),this.domains=n([data.domains,data.check.domains].flat()).filter(e$1),this.label=this.#determineLabel(data);const modifierAdjustments=parent.actor.synthetics.modifierAdjustments,parentModifiers=parent.modifiers.map(modifier=>{const clone=modifier.clone();return clone.adjustments.push(...extractModifierAdjustments(modifierAdjustments,data.check?.domains??[],clone.slug)),clone}),checkOnlyModifiers=[data.check?.modifiers??[],extractModifiers(parent.actor.synthetics,data.check?.domains??[])].flat().map(modifier=>(modifier.adjustments.push(...extractModifierAdjustments(parent.actor.synthetics.modifierAdjustments,parent.domains,this.parent.slug)),modifier)),rollOptions=parent.createRollOptions(this.domains,config);this.modifiers=[...parentModifiers,...checkOnlyModifiers.map(m=>m.clone({domains:this.domains},{test:rollOptions}))],this.type==="flat-check"&&this.modifiers.length>0&&(console.error(ErrorPF2e("Flat checks cannot have modifiers.").message),this.modifiers=[]),this.mod=new StatisticModifier(this.label,this.modifiers,rollOptions).totalModifier}get actor(){return this.parent.actor}#determineLabel(data){const parentLabel=this.parent.label;if(data.check?.label)return game.i18n.localize(data.check?.label);const checkKey=`PF2E.ActionsCheck.${this.parent.slug}`,checkLabel=game.i18n.localize(checkKey);if(!["x","x-attack-roll"].includes(this.parent.slug)&&checkLabel!==checkKey)return checkLabel;if(this.domains.includes("spell-attack-roll"))return game.i18n.format("PF2E.SpellAttackWithTradition",{tradition:parentLabel});switch(this.type){case"skill-check":return game.i18n.format("PF2E.SkillCheckWithName",{skillName:parentLabel});case"saving-throw":return game.i18n.format("PF2E.SavingThrowWithName",{saveName:parentLabel});case"perception-check":return game.i18n.format("PF2E.PerceptionCheck");default:return parentLabel}}createRollOptions(args={}){return this.parent.createRollOptions(this.domains,args)}async roll(args={}){args.dc=typeof args.dc=="number"?{value:Math.trunc(args.dc)||0}:args.dc??null;const{rollMode,skipDialog}=(()=>{if(e$2(args)&&e$3(args.event)){const event2="originalEvent"in args.event?args.event.originalEvent:args.event;if(event2 instanceof PointerEvent){const{rollMode:rollMode2,skipDialog:skipDialog2}=args;return foundry.utils.mergeObject({rollMode:rollMode2,skipDialog:skipDialog2},eventToRollParams(event2,{type:"check"}))}}return args})(),self=this.actor,domains=this.domains,selfToken=args.token??self.getActiveTokens(!0,!0).shift()??null,selfIsTarget=self===args.target||!args.target&&this.type==="saving-throw",item=args.item??null,targetToken=selfIsTarget?selfToken:args.target?.getActiveTokens(!0,!0)?.find(t2=>t2.actor?.isOfType("army","creature","hazard"))??game.user.targets.find(t2=>!!t2.actor?.isOfType("army","creature","hazard"))?.document??null,selfIsTargeting=!selfIsTarget&&!!targetToken&&(this.domains.includes("spell-attack-roll")&&item?.isOfType("spell")||!["flat-check","saving-throw"].includes(this.type)&&!!(args.dc?.slug||"statistic"in(args.dc??{}))&&(!item||item.isOfType("action","campaignFeature","feat","weapon")));if(!(targetToken?.actor?.isOfType("army")?self.isOfType("army"):self.isOfType("army","creature","hazard","party","vehicle")))return null;const rollContext=await(()=>{const contextItem=item?.isOfType("action","melee","spell","weapon")?item:null,optionSet=new Set(args.extraRollOptions??[]),originalOrigin=selfIsTarget?args.origin:self,originToken=selfIsTarget?originalOrigin?.getActiveTokens(!0,!0).shift():selfToken;return selfIsTargeting?new CheckContext({origin:{actor:self,token:originToken,statistic:this.parent,item:contextItem},target:{actor:targetToken?.actor??null,token:targetToken},domains,against:args.dc?.slug??"ac",options:optionSet}).resolve():selfIsTarget?new CheckContext({target:{actor:this.actor,token:targetToken,statistic:this.parent},origin:{actor:originToken?.actor??originalOrigin??null,token:originToken,item:contextItem},domains,against:args.dc?.slug??null,options:optionSet}).resolve():new CheckContext({origin:{actor:self,token:selfToken,statistic:this.parent,item:contextItem},domains,options:optionSet}).resolve()})(),originActor=rollContext.origin?.actor??self,targetActor=rollContext.target?.actor??null,selfActor=(selfIsTarget?targetActor:originActor)??self,dc=typeof args.dc?.value=="number"?args.dc:rollContext?.dc??null,extraModifiers=this.type==="flat-check"?[]:[args.modifiers,rollContext?.origin?.modifiers].flat().filter(e$1),extraRollOptions=[...args.extraRollOptions??[],...rollContext?.options??[],`check:statistic:${this.parent.slug}`,`check:type:${this.type.replace(/-check$/,"")}`,args.slug?`check:slug:${args.slug}`:null].filter(e$1);this.parent.base&&extraRollOptions.push(`check:statistic:base:${this.parent.base.slug}`);const options=this.createRollOptions({...args,origin:originActor,target:targetActor,extraRollOptions}),notes=[...extractNotes(selfActor.synthetics.rollNotes,domains),...args.extraRollNotes??[]];for(const rule of selfActor.rules.filter(r2=>!r2.ignored))rule.beforeRoll?.(domains,options);const dosAdjustments=dc?extractDegreeOfSuccessAdjustments(selfActor.synthetics,domains):[];if((options.has("incapacitation")||options.has("item:trait:incapacitation"))&&dc){const effectLevel=item?.isOfType("spell")?2*item.rank:item?.isOfType("physical")?item.level:originActor?.level??selfActor.level,amount=this.type==="saving-throw"&&selfActor.level>effectLevel?DEGREE_ADJUSTMENT_AMOUNTS.INCREASE:targetActor&&targetActor.level>effectLevel&&["attack-roll","spell-attack-roll","skill-check"].includes(this.type)?DEGREE_ADJUSTMENT_AMOUNTS.LOWER:null;amount&&dosAdjustments.push({adjustments:{all:{label:"PF2E.TraitIncapacitation",amount}}})}const mapIncreases=Math.clamp((args.attackNumber??1)-1,0,2);if(mapIncreases!==0)if(!item)console.warn("Missing item argument while calculating MAP during check");else{const maps=calculateMAPs(item,{domains,options}),penalty=maps[`map${mapIncreases}`];extraModifiers.push(new Modifier(maps.label,penalty,"untyped"))}const traits=args.traits?.map(t2=>typeof t2=="string"?t2:t2.name).filter(t2=>t2 in CONFIG.PF2E.actionTraits)??[];for(const trait of traits)options.add(trait);if(args.action){options.add(`self:action:slug:${sluggify(args.action)}`);for(const trait of traits)options.add(`self:action:trait:${trait}`)}const context={actor:selfActor,token:selfToken,origin:rollContext.origin,target:rollContext.target,item,type:this.type,identifier:args.identifier,domains,dc,notes,options,action:args.action,damaging:args.damaging,rollMode,skipDialog,rollTwice:args.rollTwice||extractRollTwice(selfActor.synthetics.rollTwice,domains,options),substitutions:extractRollSubstitutions(selfActor.synthetics.rollSubstitutions,domains,options),dosAdjustments,traits,title:args.title?.trim()||args.label?.trim()||this.label,createMessage:args.createMessage??!0};typeof args.attackNumber=="number"&&(context.mapIncreases=mapIncreases,context.options?.add(`map:increases:${mapIncreases}`));const modifiers=(selfIsTarget?rollContext.target?.statistic:rollContext.origin?.statistic)?.check.modifiers??this.modifiers,check=new CheckModifier(this.parent.slug,{modifiers},extraModifiers),roll=await Check.roll(check,context,null,args.callback);if(roll)for(const rule of selfActor.rules.filter(r2=>!r2.ignored))await rule.afterRoll?.({roll,check,context,domains,rollOptions:options});return roll}get breakdown(){return this.modifiers.filter(m=>m.enabled).map(m=>`${m.label} ${m.modifier<0?"":"+"}${m.modifier}`).join(", ")}}class StatisticDifficultyClass{static{__name(this,"StatisticDifficultyClass")}static{__name2(this,"StatisticDifficultyClass")}parent;domains;label;modifiers;options;constructor(parent,data,options={}){this.parent=parent,this.domains=n([data.domains,data.dc?.domains].flat()).filter(e$1),this.label=data.dc?.label,this.options=parent.createRollOptions(this.domains,options);const{modifierAdjustments}=parent.actor.synthetics,parentModifiers=parent.modifiers.map(modifier=>{const clone=modifier.clone();return clone.adjustments.push(...extractModifierAdjustments(modifierAdjustments,data.dc?.domains??[],clone.slug)),clone}),dcOnlyModifiers=[data.dc?.modifiers??[],extractModifiers(parent.actor.synthetics,data.dc?.domains??[])].flat().map(modifier=>(modifier.adjustments.push(...extractModifierAdjustments(parent.actor.synthetics.modifierAdjustments,parent.domains,this.parent.slug)),modifier));this.modifiers=[...new StatisticModifier("",[...parentModifiers,...dcOnlyModifiers.map(m=>m.clone())],this.options).modifiers]}get value(){return 10+new StatisticModifier("",this.modifiers.map(m=>m.clone()),this.options).totalModifier}get breakdown(){const enabledMods=this.modifiers.filter(m=>m.enabled);return[game.i18n.localize("PF2E.DCBase")].concat(enabledMods.map(m=>`${m.label} ${signedInteger(m.modifier)}`)).join(", ")}toString(){return String(this.value)}}class ArmorStatistic extends Statistic{static{__name(this,"ArmorStatistic")}static{__name2(this,"ArmorStatistic")}details;get item(){return this.actor.isOfType("character")?this.actor.wornArmor:null}constructor(actor,data={}){data.rank??=1;const attribute=actor.isOfType("creature")?data.attribute??"dex":null,domains=attribute?["all",`${attribute}-based`]:["all"],fullData={...data,label:"TYPES.Item.armor",slug:"armor",attribute,domains,proficient:data.rank>0,dc:{label:"PF2E.ArmorClassLabel",domains:["ac"],modifiers:[]}};super(actor,fullData),this.details=data.details??"";const dcModifiers=[...this.dc.modifiers,...this.#createBonusesAndPenalties()].map(m=>m.clone());this.dc.modifiers=[...new StatisticModifier("",dcModifiers,this.dc.options).modifiers]}#createBonusesAndPenalties(){const actor=this.actor,armor=actor.isOfType("character")?actor.wornArmor:null,armorSlug=armor?.baseType??armor?.slug??sluggify(armor?.name??"");return[armor?new Modifier({label:armor.name,type:"item",slug:armorSlug,modifier:armor.acBonus,adjustments:extractModifierAdjustments(actor.synthetics.modifierAdjustments,["all","ac"],armorSlug)}):null,createShoddyPenalty(actor,armor,this.dc.domains),this.#createShieldBonus()].filter(e$1)}#createShieldBonus(){const{actor}=this;if(!actor.isOfType("character","npc"))return null;const shieldData=actor.system.attributes.shield,slug="raised-shield";return shieldData.raised&&!shieldData.broken?new Modifier({label:shieldData.name,slug,adjustments:extractModifierAdjustments(actor.synthetics.modifierAdjustments,["all","dex-based","ac"],slug),type:"circumstance",modifier:shieldData.ac}):null}getTraceData(){return{...super.getTraceData({value:"dc"}),breakdown:this.dc.breakdown,details:this.details,slug:"ac"}}}class HitPointsStatistic extends BaseStatistic{static{__name(this,"HitPointsStatistic")}static{__name2(this,"HitPointsStatistic")}value;max;#baseMax;temp;negativeHealing;unrecoverable;details;constructor(actor,{baseMax=0}={}){const modifiers=actor.isOfType("character")?[createAttributeModifier({actor,attribute:"con",domains:["hp","con-based"]})]:[];super(actor,{slug:"hp",label:"PF2E.HitPointsHeader",domains:actor.isOfType("character","npc")?["con-based","hp"]:["hp"],modifiers}),this.#baseMax=baseMax,this.max=baseMax+new StatisticModifier("",this.modifiers.map(m=>m.clone())).totalModifier,this.value=Math.clamp(actor.system.attributes.hp.value,0,this.max),this.temp=actor.system.attributes.hp.temp,this.negativeHealing=actor.system.attributes.hp.negativeHealing,this.unrecoverable=actor.system.attributes.hp.unrecoverable,this.details=actor.system.attributes.hp.details||""}get breakdown(){return[this.#baseMax>0?game.i18n.format("PF2E.MaxHitPointsBaseLabel",{base:this.#baseMax}):null,...this.modifiers.filter(m=>m.enabled).map(m=>`${m.label} ${signedInteger(m.modifier)}`)].filter(e$1).join(", ")}getTraceData(){return{slug:this.slug,label:this.label,value:this.value,max:this.max,temp:this.temp,breakdown:this.breakdown,negativeHealing:this.negativeHealing,unrecoverable:this.unrecoverable,details:this.details,modifiers:this.modifiers.map(m=>m.toObject())}}}const fields$1b=foundry.data.fields;class Sense extends foundry.abstract.DataModel{static{__name(this,"Sense")}static{__name2(this,"Sense")}constructor(data,options){data.range===1/0&&(data.range=null),super(data,{...options,strict:!1}),this.range??=1/0,this.acuity=SENSES_WITH_MANDATORY_ACUITIES[this.type]??this.acuity}static defineSchema(){return{type:new fields$1b.StringField({required:!0,nullable:!1,choices:Array.from(SENSE_TYPES),initial:void 0}),acuity:new fields$1b.StringField({required:!0,nullable:!1,choices:SENSE_ACUITIES,initial:"precise"}),range:new fields$1b.NumberField({required:!0,nullable:!0,integer:!0,positive:!0,initial:null}),source:new fields$1b.StringField({required:!1,blank:!1,nullable:!0,initial:null})}}get label(){const buildLabel=__name2((type2,acuity,range2)=>{const senses2=CONFIG.PF2E.senses,sense=game.i18n.localize(senses2[type2]??"")||type2,acuityLabel=acuity?game.i18n.localize(CONFIG.PF2E.senseAcuities[acuity]):null;return acuity&&range2?game.i18n.format("PF2E.Actor.Creature.Sense.WithAcuityAndRange",{sense,acuity:acuityLabel,range:range2}):acuity?game.i18n.format("PF2E.Actor.Creature.Sense.WithAcuity",{sense,acuity:acuityLabel}):range2?game.i18n.format("PF2E.Actor.Creature.Sense.WithRange",{sense,range:range2}):sense},"buildLabel"),range=this.range<1/0?this.range:null;switch(this.type){case"darkvision":case"greater-darkvision":case"low-light-vision":case"see-invisibility":return buildLabel(this.type);case"echolocation":case"infrared-vision":return buildLabel(this.type,null,this.range);case"lifesense":return buildLabel(this.type,this.acuity==="precise"?null:this.acuity,range);case"truesight":return buildLabel(this.type);case"scent":return this.acuity==="vague"?null:buildLabel(this.type,this.acuity,range);default:return buildLabel(this.type,this.acuity,range)}}get emphasizeLabel(){return["see-invisibility","truesight"].includes(this.type)}isMoreAcuteThan(sense){return this.acuity==="precise"&&["imprecise","vague"].includes(sense.acuity??"precise")||this.acuity==="imprecise"&&sense.acuity==="vague"}toObject(source2=!0){const data=super.toObject(source2);return source2?data:{...data,label:this.label,emphasizeLabel:this.emphasizeLabel}}}class PerceptionStatistic extends Statistic{static{__name(this,"PerceptionStatistic")}static{__name2(this,"PerceptionStatistic")}senses;hasVision;constructor(actor,data,config={}){super(actor,data,config),this.senses=new Collection(this.#prepareSenses(data.senses).map(s=>[s.type,s])),this.hasVision=data.vision??!0,typeof data.details=="string"&&(this.details=data.details)}#prepareSenses(data){const actor=this.actor,preparedSenses=data.map(d=>new Sense(d,{parent:actor})),acuityValues={precise:2,imprecise:1,vague:0};for(const{sense,predicate,force}of actor.synthetics.senses){if(predicate&&!predicate.test(actor.getRollOptions(["sense"])))continue;const existing=preparedSenses.find(s=>s.type===sense.type);existing?(force||acuityValues[sense.acuity]>acuityValues[existing.acuity]||sense.range>existing.range)&&preparedSenses.splice(preparedSenses.indexOf(existing),1,new Sense(sense,{parent:actor})):preparedSenses.push(new Sense(sense,{parent:actor}))}return n$2(preparedSenses,s=>s.type)}getTraceData(){return{...super.getTraceData({value:"mod"}),senses:this.senses.map(s=>s.toObject(!1)),vision:this.hasVision,details:this.details??""}}}var root_1$c=from_html("<option> </option>"),on_click$7=__name2((_,viewItem,resolvedItem)=>viewItem(get(resolvedItem)),"on_click$7"),root_5$6=from_html("<option> </option>"),root_4$5=from_html('<select name="rank" data-dtype="Number"></select>'),root_2$b=from_html('<div class="form-group"><label></label> <div class="form-fields"><!></div></div>'),root$i=from_html('<header> </header> <div class="form-group"><label> </label> <div class="form-fields"><select name="type" data-dtype="String"></select> <button type="button" class="item-info icon fa-solid fa-info-circle svelte-1e4rzh1" data-tooltip=""></button></div></div> <!> <div class="form-group"><label></label> <input type="checkbox" name="mystified"/></div> <button type="submit"><i class="fa-regular fa-floppy-disk"></i> </button>',1);function App$6($$anchor,$$props){push($$props,!0);const localize=localizer("PF2E.SpellcastingItemCreator"),name2=user_derived(()=>$$props.state.name),isCantrip=user_derived(()=>$$props.state.isCantrip),minimumRank=user_derived(()=>$$props.state.minimumRank),initialMystified=user_derived(()=>$$props.state.initialMystified);let type2=state(void 0),rank=state(void 0);const itemTypeData=user_derived(()=>objectHasKey(CONFIG.PF2E.spellcastingItems,get(type2))?CONFIG.PF2E.spellcastingItems[get(type2)]:null),itemTypeOptions=user_derived(()=>get(isCantrip)?{cantripDeck5:localize("CantripDeck5")}:t$5(CONFIG.PF2E.spellcastingItems,c=>game.i18n.localize(c.name))),compendiumUuids=user_derived(()=>get(itemTypeData)?.compendiumUuids??null),ranks=user_derived(()=>Object.keys(get(compendiumUuids)??{}).map(k=>Number(k)).filter(r2=>r2>=get(minimumRank)&&!!get(compendiumUuids)?.[r2])),noValidRanks=user_derived(()=>!get(isCantrip)&&get(ranks).length===0),resolvedItem=user_derived(()=>get(type2)==="cantripDeck5"?CANTRIP_DECK_UUID:get(compendiumUuids)?.[Number(get(rank))]);async function viewItem(selection){if(!UUIDUtils.isItemUUID(selection))return;(await fromUuid(selection))?.sheet.render(!0)}__name(viewItem,"viewItem"),__name2(viewItem,"viewItem");var fragment=root$i(),header=first_child(fragment),text$1=child(header),div=sibling(header,2),label=child(div),text_1=child(label),div_1=sibling(label,2),select=child(div_1);each(select,21,()=>Object.entries(get(itemTypeOptions)),index,($$anchor2,$$item)=>{var $$array=user_derived(()=>to_array(get($$item),2));let value=__name2(()=>get($$array)[0],"value"),option=__name2(()=>get($$array)[1],"option");var option_1=root_1$c(),text_2=child(option_1),option_1_value={};template_effect(()=>{set_text(text_2,option()),option_1_value!==(option_1_value=value())&&(option_1.value=(option_1.__value=value())??"")}),append($$anchor2,option_1)});var button=sibling(select,2);button.__click=[on_click$7,viewItem,resolvedItem];var node=sibling(div,2);{var consequent_1=__name2($$anchor2=>{var div_2=root_2$b(),label_1=child(div_2);label_1.textContent=game.i18n.localize("PF2E.Item.Spell.Rank.Label");var div_3=sibling(label_1,2),node_1=child(div_3);{var consequent=__name2($$anchor3=>{var text_3=text();template_effect($0=>set_text(text_3,$0),[()=>localize("NoValidRanks")]),append($$anchor3,text_3)},"consequent"),alternate=__name2($$anchor3=>{var select_1=root_4$5();each(select_1,21,()=>get(ranks),index,($$anchor4,rank2,$$index_1,$$array_1)=>{var option_2=root_5$6(),text_4=child(option_2),option_2_value={};template_effect($0=>{set_text(text_4,$0),option_2_value!==(option_2_value=get(rank2))&&(option_2.value=(option_2.__value=get(rank2))??"")},[()=>ordinalString(get(rank2))]),append($$anchor4,option_2)}),template_effect(()=>set_attribute(select_1,"id",`${$$props.foundryApp.id}.rank`)),bind_select_value(select_1,()=>get(rank),$$value=>set(rank,$$value)),append($$anchor3,select_1)},"alternate");if_block(node_1,$$render=>{get(noValidRanks)?$$render(consequent):$$render(alternate,!1)})}template_effect(()=>set_attribute(label_1,"for",`${$$props.foundryApp.id}.rank`)),append($$anchor2,div_2)},"consequent_1");if_block(node,$$render=>{get(type2)!=="cantripDeck5"&&$$render(consequent_1)})}var div_4=sibling(node,2),label_2=child(div_4);label_2.textContent=game.i18n.localize("PF2E.identification.Mystify");var input=sibling(label_2,2),button_1=sibling(div_4,2),text_5=sibling(child(button_1));text_5.nodeValue=` ${game.i18n.localize("PF2E.CreateItemTitle")??""}`,template_effect(($0,$1,$2)=>{set_text(text$1,$0),set_attribute(label,"for",`${$$props.foundryApp.id}.itemType`),set_text(text_1,$1),set_attribute(select,"id",`${$$props.foundryApp.id}.itemType`),button.disabled=!get(resolvedItem),set_attribute(button,"aria-label",$2),set_attribute(label_2,"for",`${$$props.foundryApp.id}.mystified`),set_attribute(input,"id",`${$$props.foundryApp.id}.mystified`),set_checked(input,get(initialMystified)),button_1.disabled=get(noValidRanks)},[()=>localize("Label",{name:get(name2)}),()=>localize("ItemType"),()=>game.i18n.localize(localize(get(resolvedItem)?"ViewItem":"NoValidRanks"))]),bind_select_value(select,()=>get(type2),$$value=>set(type2,$$value)),append($$anchor,fragment),pop()}__name(App$6,"App$6"),__name2(App$6,"App$6"),delegate(["click"]);const fapi=foundry.applications.api;class SpellcastingItemCreator extends SvelteApplicationMixin(fapi.ApplicationV2){static{__name(this,"SpellcastingItemCreator")}static{__name2(this,"SpellcastingItemCreator")}static DEFAULT_OPTIONS={id:"spellcasting-item-creator",window:{icon:"fa-solid fa-scroll",title:"PF2E.SpellcastingItemCreator.Title",contentClasses:["standard-form"]},position:{width:340},tag:"form",form:{closeOnSubmit:!0,handler:SpellcastingItemCreator.#onSubmit}};root=App$6;#actor;#spell;#initialMystified;constructor(options){super(options),this.#actor=options.actor,this.#spell=options.spell,this.#initialMystified=!!options.mystified}async _prepareContext(options){const context=await super._prepareContext(options),spell=this.#spell;return Object.assign(context,{foundryApp:this,state:{name:spell.name,isCantrip:spell.isCantrip,minimumRank:spell.baseRank,initialMystified:this.#initialMystified}})}static async#onSubmit(_event,_form,formData){const item=await createConsumableFromSpell(this.#spell,{type:String(formData.object.type),rank:Number(formData.object.rank),mystified:!!formData.object.mystified});this.#actor.inventory.add(item,{stack:!0})}}const appv1$k=foundry.appv1;class BaseTagSelector extends appv1$k.api.DocumentSheet{static{__name(this,"BaseTagSelector")}static{__name2(this,"BaseTagSelector")}static get defaultOptions(){return{...super.defaultOptions,id:"tag-selector",classes:["pf2e","tag-selector"],sheetConfig:!1,width:"auto"}}choices;flat;constructor(document2,options={}){super(document2,options),this.flat=options.flat??!1,this.choices=this.#getChoices()}get id(){return`${this.options.id}-${this.document.uuid}`}get title(){return game.i18n.localize(this.options.title||"PF2E.TraitsLabel")}async getData(options){return{...await super.getData(options),documentType:this.document.constructor.metadata.label}}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const input of htmlQueryAll(html2,"input:not([type=checkbox])"))input.addEventListener("focusin",()=>{input.select()})}#getChoices(){const choices=this.configTypes.reduce((types,key)=>{const config=CONFIG.PF2E[key],configLabels=t$5(config,c=>e$3(c)?c.label:c);return foundry.utils.mergeObject(types,configLabels)},{});return sortStringRecord(choices)}}function isValuesList(obj){return e$3(obj)&&"value"in obj&&Array.isArray(obj.value)&&obj.value.every(v=>typeof v=="string")}__name(isValuesList,"isValuesList"),__name2(isValuesList,"isValuesList");class TagSelectorBasic extends BaseTagSelector{static{__name(this,"TagSelectorBasic")}static{__name2(this,"TagSelectorBasic")}static get defaultOptions(){return{...super.defaultOptions,template:"systems/pf2e/templates/system/tag-selector/basic.hbs",filters:[{inputSelector:"input[type=search]",contentSelector:"ul",delay:150}],scrollY:["ul"]}}objectProperty;constructor(document2,options){super(document2,options),this.objectProperty=options.objectProperty,options.customChoices&&(foundry.utils.mergeObject(this.choices,options.customChoices),this.choices=sortStringRecord(this.choices))}get configTypes(){return this.options.configTypes??[]}async getData(options){const{chosen,flat,disabled}=(()=>{const document2=this.document,sourceProperty=foundry.utils.getProperty(document2.toObject(),this.objectProperty),preparedProperty=foundry.utils.getProperty(document2,this.objectProperty);if(Array.isArray(preparedProperty)){const manuallyChosen=Array.isArray(sourceProperty)?sourceProperty.map(v=>String(v)):[],automaticallyChosen=preparedProperty.filter(v=>!manuallyChosen.includes(v));return{chosen:Array.from(new Set([...manuallyChosen,...automaticallyChosen])),flat:!0,disabled:automaticallyChosen}}else if(isValuesList(preparedProperty)&&isValuesList(sourceProperty)){const manuallyChosen=sourceProperty.value.map(v=>v.toString()),automaticallyChosen=preparedProperty.value.filter(v=>!manuallyChosen.includes(v));return{chosen:Array.from(new Set([...manuallyChosen,...automaticallyChosen])),flat:!1,disabled:automaticallyChosen}}else return{chosen:[],flat:this.flat,disabled:[]}})(),choices=Object.keys(this.choices).reduce((accumulated,type2)=>(accumulated[type2]={label:this.choices[type2],selected:chosen.includes(type2),disabled:disabled.includes(type2)},accumulated),{});return{...await super.getData(options),choices,details:null,flat,hasCustomChoices:!!options?.customChoices}}_onSearchFilter(_event,_query,rgx){for(const row of this.form.querySelectorAll("li"))row.style.display=rgx.test(row.querySelector("label")?.innerText??"")?"":"none"}async _updateObject(event2,formData){const flat=event2.target instanceof HTMLElement?event2.target.dataset.flat:!1,value=this.#getUpdateData(formData);if(flat)return super._updateObject(event2,{[this.objectProperty]:value});{const data=(()=>{const detailsEl=htmlQuery(event2.target,"input[data-details]");return detailsEl?.dataset.path?{[`${this.objectProperty}.value`]:value,[detailsEl.dataset.path]:detailsEl.value.trim()}:{[`${this.objectProperty}.value`]:value}})();return super._updateObject(event2,data)}}#getUpdateData(formData){const optionsAreNumeric=Object.keys(formData).every(tag=>Number.isInteger(Number(tag))),selections=Object.entries(formData).flatMap(([tag,selected])=>selected?tag:[]).filter(s=>s!=="custom");return optionsAreNumeric?selections.map(s=>Number(s)):selections}}class LanguageSelector extends TagSelectorBasic{static{__name(this,"LanguageSelector")}static{__name2(this,"LanguageSelector")}static get defaultOptions(){return{...super.defaultOptions,id:"language-selector",title:"PF2E.Actor.Creature.Language.Plural",width:325}}constructor(document2,options={}){super(document2,{...options,objectProperty:options?.objectProperty??"system.details.languages"})}get configTypes(){return["languages"]}async getData(options){const document2=this.document;if(document2 instanceof ActorPF2e&&!document2.isOfType("creature"))throw ErrorPF2e("The languages selector is usable only with creatures");const sheetData=await super.getData(options),actor=document2 instanceof ActorPF2e?document2:null,details=actor?{path:"system.details.languages.details",placeholder:"PF2E.Actor.Creature.Language.DetailsPlaceholder",value:actor.system.details.languages.details.trim()}:null,grantedLanguageSources=t$9(actor?.isOfType("character")?actor.system.build.languages.granted:[],g=>[g.slug,g.source]),languagesByRarity=game.pf2e.settings.campaign.languages;for(const language of languagesByRarity.unavailable)delete sheetData.choices[language];const selectedAtTop=Object.fromEntries(t(Object.entries(sheetData.choices),([,v])=>!v.selected)),choices=t$5(selectedAtTop,(data,key)=>{const slug=key,rarityLocKeys={...CONFIG.PF2E.rarityTraits,secret:"PF2E.TraitSecret"},tags=t$9(LANGUAGE_RARITIES,r2=>[r2,{slug:r2,label:game.i18n.localize(rarityLocKeys[r2])}]);data.selected&&!data.disabled&&actor?.isOfType("character")&&actor.system.build.languages.granted.some(g=>g.slug===key)&&(data.disabled=!0);const rarity=(()=>{if(slug==="common"){if(languagesByRarity.commonLanguage){const commonLanguage=game.i18n.localize(CONFIG.PF2E.languages[languagesByRarity.commonLanguage]),locKey="PF2E.Actor.Creature.Language.CommonLanguage";data.label=game.i18n.format(locKey,{language:commonLanguage})}return tags.common}return languagesByRarity.uncommon.has(slug)?tags.uncommon:languagesByRarity.rare.has(slug)?tags.rare:languagesByRarity.secret.has(slug)?tags.secret:tags.common})(),source2=grantedLanguageSources[slug]??null;return{...data,rarity,source:source2}});return{...sheetData,hasRarity:!0,details,choices}}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const input of htmlQueryAll(html2,"input[type=number]"))input.addEventListener("input",()=>{const checkbox=input.closest("li")?.querySelector("input[type=checkbox]");checkbox&&(checkbox.checked=!!Number(input.value))})}async _updateObject(event2,formData){await super._updateObject(event2,formData);const languages="system.details.languages.value"in formData?formData["system.details.languages.value"]:formData["system.languages.value"];Array.isArray(languages)&&languages.sort()}}class SenseSelector extends BaseTagSelector{static{__name(this,"SenseSelector")}static{__name2(this,"SenseSelector")}objectProperty="system.perception.senses";static get defaultOptions(){return{...super.defaultOptions,height:"auto",template:"systems/pf2e/templates/system/tag-selector/senses.hbs",id:"sense-selector",title:"PF2E.Actor.Creature.Sense.Plural"}}get configTypes(){return["senses"]}async getData(options){const actor=this.document;if(!actor.isOfType("npc"))throw ErrorPF2e("The Sense selector is usable only with NPCs");const senses2=actor.system.perception.senses,choices=t$5(this.choices,(label,type2)=>{const sense=senses2.find(s=>s.type===type2),canSetAcuity=!(sense?.source||SENSES_WITH_MANDATORY_ACUITIES[type2]),canSetRange=!(sense?.source||tupleHasValue(SENSES_WITH_UNLIMITED_RANGE,type2));return{acuity:SENSES_WITH_MANDATORY_ACUITIES[type2]??sense?.acuity??"imprecise",canSetAcuity,canSetRange,label,selected:!!sense,source:sense?.source??null,range:sense?.range??null}});return{...await super.getData(options),hasExceptions:!1,choices,senseAcuities:CONFIG.PF2E.senseAcuities,vision:{value:actor.system.perception.vision,editable:actor._source.system.perception.vision===actor.system.perception.vision,source:actor.system.autoChanges["system.perception.vision"]?.at(-1)?.source??null}}}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const input of htmlQueryAll(html2,"input[type=number]")){const checkbox=htmlQuery(htmlClosest(input,"tr"),"input[type=checkbox]");checkbox&&input.addEventListener("input",()=>{checkbox.checked=!!Number(input.value)})}}_onSubmit(event2,options){for(const input of htmlQueryAll(this.element[0],"input[type=number]:not(:disabled)")){const checkbox=htmlQuery(htmlClosest(input,"tr"),"input[type=checkbox]");checkbox&&!Number(input.value)&&(checkbox.checked=!1)}return super._onSubmit(event2,options)}async _updateObject(event2,formData){const hasVision=formData["system.perception.vision"],update=Object.entries(formData).filter(e2=>setHasElement(SENSE_TYPES,e2[0])&&Array.isArray(e2[1])&&e2[1][0]===!0&&tupleHasValue(SENSE_ACUITIES,e2[1][1])).flatMap(([type2,values])=>{const acuity=values[1],range=Math.ceil(Math.max(0,Math.floor(Number(values[2]??NaN)))/5)*5;return tupleHasValue(SENSES_WITH_UNLIMITED_RANGE,type2)?{type:type2}:tupleHasValue(SENSE_ACUITIES,acuity)&&range>=5?{type:type2,acuity,range}:[]});return super._updateObject(event2,{[this.objectProperty]:update,"system.perception.vision":hasVision})}}class SpeedSelector extends BaseTagSelector{static{__name(this,"SpeedSelector")}static{__name2(this,"SpeedSelector")}static get defaultOptions(){return{...super.defaultOptions,id:"speed-selector",template:"systems/pf2e/templates/system/tag-selector/speeds.hbs",title:"PF2E.Actor.Speed.Plural"}}objectProperty="system.attributes.speed.otherSpeeds";choices=t$9(MOVEMENT_TYPES.filter(t2=>t2!=="land"),t2=>[t2,`PF2E.Actor.Speed.Type.${t2.capitalize()}`]);get configTypes(){return[]}async getData(options){const actor=this.document;if(!actor.isOfType("creature"))throw ErrorPF2e("The Speed selector is usable only with creature-type actors");const speeds=actor.system.movement.speeds,choices=t$5(this.choices,(label,type2)=>{const speed=speeds[type2];return{selected:!!speed,disabled:!!speed?.source,label,value:Number(speed?.value)||""}});return{...await super.getData(options),hasExceptions:this.document.isOfType("npc"),choices}}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const input of htmlQueryAll(html2,"input[type=number]"))input.addEventListener("input",()=>{const checkbox=input.closest("li")?.querySelector("input[type=checkbox]");checkbox&&(checkbox.checked=!!Number(input.value))})}async _updateObject(event2,formData){const update=Object.entries(formData).flatMap(([key,value])=>{if(!(Array.isArray(value)&&value.length===2))return[];const selected=!!value[0],distance=Math.trunc(Math.abs(value[1]));return selected&&distance?{type:key,value:Math.max(distance,5)}:[]});return super._updateObject(event2,{[this.objectProperty]:update})}}const TAG_SELECTOR_TYPES=["basic","languages","senses","speed-types"],SELECTABLE_TAG_FIELDS=["abilities","actionTraits","attackEffects","creatureTraits","damageCategories","levels","materialDamageEffects","otherArmorTags","otherConsumableTags","otherWeaponTags","senses","skills","vehicleTraits","weaponTraits"],STACK_DEFINITIONS={bolts:{size:10,lightBulk:1},arrows:{size:10,lightBulk:1},slingBullets:{size:10,lightBulk:1},blowgunDarts:{size:10,lightBulk:1},woodenTaws:{size:10,lightBulk:1},rounds5:{size:5,lightBulk:1},rounds10:{size:10,lightBulk:1},coins:{size:1e3,lightBulk:10},gems:{size:2e3,lightBulk:10},upb:{size:1e3,lightBulk:10}};class Bulk{static{__name(this,"Bulk")}static{__name2(this,"Bulk")}value;constructor(value=0){this.value=Math.round(Math.max(value,0)*10)/10}get normal(){return Math.floor(this.value)}get light(){return Math.round((this.value-this.normal)*10)}get isNegligible(){return this.value===0}get isLight(){return this.value>0&&this.value<1}toLightUnits(){return this.normal*10+this.light}increment(){return this.isNegligible?new Bulk(.1):this.isLight?new Bulk(1):new Bulk(this.value+1)}plus(other){const otherValue=typeof other=="number"?other:other.value;return new Bulk(this.value+otherValue)}minus(other){const otherValue=typeof other=="number"?other:other.value;return new Bulk(this.value-otherValue)}times(factor){return new Bulk(Math.round(this.value*factor*10)/10)}toString(){const{light,normal}=this;return this.isNegligible?game.i18n.localize("PF2E.Item.Physical.Bulk.Negligible.ShortLabel"):this.value===normal?normal.toString():normal===0&&light===1?game.i18n.localize("PF2E.Item.Physical.Bulk.Light.ShortLabel"):light>0&&normal===0?game.i18n.format("PF2E.Item.Physical.Bulk.NLight",{light}):game.i18n.format("PF2E.Item.Physical.Bulk.WithLight",{bulk:normal,light})}double(){return this.isNegligible?new Bulk(.1):this.isLight?new Bulk(1):this.times(2)}halve(){return this.isNegligible||this.isLight?new Bulk:this.normal===1?new Bulk(.1):this.times(.5)}convertToSize(itemSize,actorSize){const sizes=Array.from(SIZES).filter(size=>size!=="sm"),itemSizeIndex=sizes.indexOf(itemSize==="sm"?"med":itemSize),actorSizeIndex=sizes.indexOf(actorSize==="sm"?"med":actorSize);return itemSizeIndex>actorSizeIndex?applyNTimes(b=>b.double(),itemSizeIndex-actorSizeIndex,this):itemSizeIndex<actorSizeIndex?applyNTimes(b=>b.value<=.1?new Bulk:b.value<=1?new Bulk(.1):new Bulk(Math.max(.1,Math.floor(.1*this.value))),actorSizeIndex-itemSizeIndex,this):new Bulk(this.value)}}function createCounteractStatistic(ability){const actor=ability.actor,baseModifier=actor.isOfType("npc")?ability.statistic.check.modifiers.find(m=>m.type==="untyped"&&m.slug==="base")?.clone():null;return new Statistic(actor,{slug:"counteract",label:"PF2E.Item.Spell.Counteract.Label",attribute:ability.statistic.attribute,rank:ability.statistic.rank||1,check:{type:"check",modifiers:[baseModifier].filter(e$1)}})}__name(createCounteractStatistic,"createCounteractStatistic"),__name2(createCounteractStatistic,"createCounteractStatistic");function spellSlotGroupIdToNumber(groupId){if(groupId==="cantrips")return 0;const numericValue=Number(groupId??NaN);return numericValue.between(0,10)?numericValue:null}__name(spellSlotGroupIdToNumber,"spellSlotGroupIdToNumber"),__name2(spellSlotGroupIdToNumber,"spellSlotGroupIdToNumber");function coerceToSpellGroupId(value){if(value==="cantrips")return value;const numericValue=Number(value)||NaN;return numericValue.between(1,10)?numericValue:null}__name(coerceToSpellGroupId,"coerceToSpellGroupId"),__name2(coerceToSpellGroupId,"coerceToSpellGroupId");function getSpellRankLabel(group){return group===0||group==="cantrips"?game.i18n.localize("PF2E.Actor.Creature.Spellcasting.Cantrips"):game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ordinalString(group)})}__name(getSpellRankLabel,"getSpellRankLabel"),__name2(getSpellRankLabel,"getSpellRankLabel");function onClickCreateSpell(actor,data){if(!data.location)throw ErrorPF2e("Unexpected missing spellcasting-entry location");const groupId=coerceToSpellGroupId(data.groupId),rank=typeof groupId=="number"?groupId:1,newLabel=game.i18n.localize("PF2E.NewLabel"),[rankLabel,spellLabel]=groupId==="cantrips"?[null,game.i18n.localize("PF2E.TraitCantrip")]:[game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ordinalString(rank)}),game.i18n.localize(data.location==="rituals"?"PF2E.Item.Spell.Ritual.Label":"TYPES.Item.spell")],source2={type:"spell",name:[newLabel,rankLabel,spellLabel].filter(e$1).join(" "),system:{level:{value:rank},location:{value:String(data.location)},traits:{value:groupId==="cantrips"?["cantrip"]:[]}}};data.location==="rituals"&&(source2.system=foundry.utils.mergeObject(source2.system,{category:{value:"ritual"}})),actor.createEmbeddedDocuments("Item",[source2])}__name(onClickCreateSpell,"onClickCreateSpell"),__name2(onClickCreateSpell,"onClickCreateSpell");function createBulkPerLabel(item){return item.system.bulk.per===1||item.system.bulk.value===0?item.system.quantity===1?item.bulk.toString():new Bulk(item.system.bulk.value).toString():`${new Bulk(item.system.bulk.value)} / ${item.system.bulk.per}`}__name(createBulkPerLabel,"createBulkPerLabel"),__name2(createBulkPerLabel,"createBulkPerLabel");function condenseSenses(senses2){const senseTypes=senses2.map(s=>s.type);return senseTypes.includes("greater-darkvision")&&(senseTypes.findSplice(t2=>t2==="low-light-vision"),senseTypes.findSplice(t2=>t2==="darkvision")),senseTypes.includes("darkvision")&&senseTypes.findSplice(t2=>t2==="low-light-vision"),senses2.filter(r2=>senseTypes.includes(r2.type))}__name(condenseSenses,"condenseSenses"),__name2(condenseSenses,"condenseSenses");function createAbilityViewData(item){return{...t$3(item,["id","uuid","img","name","actionCost","frequency"]),glyph:getActionGlyph(item.actionCost),usable:!!item.system.selfEffect||!!item.system?.frequency||!!item.crafting,traits:item.system.traits.value.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.actionTraits)),has:{aura:item.traits.has("aura")||item.system.rules.some(r2=>r2.key==="Aura"),deathNote:item.isOfType("action")&&item.system.deathNote,selfEffect:!!item.system.selfEffect}}}__name(createAbilityViewData,"createAbilityViewData"),__name2(createAbilityViewData,"createAbilityViewData");class ItemSummaryRenderer{static{__name(this,"ItemSummaryRenderer")}static{__name2(this,"ItemSummaryRenderer")}sheet;constructor(sheet){this.sheet=sheet}async toggleSummary(element,options={}){if(element.dataset.itemType==="spellSlot")return;const duration=.4,item=await this.getItemFromElement(element),summaryElem=await(async()=>{const container=htmlQuery(element,".item-summary");if(container?.hasChildNodes())return container;if(!container||!(item instanceof ItemPF2e))return null;const chatData=await item.getChatData({secrets:item.isOwner},{...element.dataset});return await this.renderItemSummary(container,item,chatData),container})();if(!summaryElem)return;const showSummary=options.visible??summaryElem.hidden;options.instant?summaryElem.hidden=!showSummary:showSummary?summaryElem.hidden&&await gsap.fromTo(summaryElem,{height:0,opacity:0,hidden:!1},{height:"auto",opacity:1,duration}):await gsap.to(summaryElem,{height:0,duration,opacity:0,paddingTop:0,paddingBottom:0,margin:0,clearProps:"all",onComplete:__name2(()=>{summaryElem.hidden=!0},"onComplete")})}async getItemFromElement(element){const actor=this.sheet.actor,{subitemId,itemId,itemUuid,itemType,actionIndex}=element.dataset,isFormula=!!itemUuid&&"isFormula"in element.dataset,realItemId=subitemId?htmlClosest(element,"[data-item-id]")?.dataset.itemId:itemId,subitem=subitemId?actor.inventory.get(realItemId,{strict:!0}).subitems.get(subitemId,{strict:!0}):null;if(subitem)return subitem;if(isFormula)return fromUuid(itemUuid);if(itemType==="spell"){const collectionId=htmlClosest(element,"[data-entry-id]")?.dataset.entryId;return actor.spellcasting?.collections?.get(collectionId,{strict:!0}).get(itemId,{strict:!0})??null}return itemType==="condition"?actor.conditions.get(itemId,{strict:!0}):actionIndex?actor.system.actions?.[Number(actionIndex)].item??null:actor.items.get(realItemId??"")??null}async renderItemSummary(container,item,chatData){const isEffect=item instanceof AbstractEffectPF2e,selfEffectLink=(()=>{if(!item.isOfType("action","feat")||!item.system.selfEffect)return null;const uuid=item.system.selfEffect.uuid,name2=fromUuidSync(uuid)?.name??item.system.selfEffect.name;return`@UUID[${uuid}]{${name2}}`})(),price=item.isOfType("physical","kit")?item.system.price:null,summary=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/partials/item-summary.hbs",{item,description:chatData.description,identified:game.user.isGM||!(item.isOfType("physical")||isEffect)||item.isIdentified,isCreature:item.actor?.isOfType("creature"),chatData,selfEffect:selfEffectLink&&await TextEditorPF2e.enrichHTML(selfEffectLink),price:price?price.per>1?`${price.value.toString()} / ${price.per}`:price.value.toString():null});if(container.innerHTML=summary,item.isOfType("spell")&&item.actor.isOfType("creature"))for(const button of htmlQueryAll(container,"button"))button.addEventListener("click",event2=>{switch(event2.stopPropagation(),button.dataset.action){case"spellAttack":return item.rollAttack(event2);case"spellDamage":return item.rollDamage(event2);case"spellTemplate":return item.placeTemplate()}})}async saveAndRestoreState(callback){const html2=this.sheet.element[0]??null,summaries=htmlQueryAll(html2,".item-summary:not([hidden])"),selectors=["subitem-id","item-id","action-index"].map(s=>`[data-${s}]`).join(","),elements=summaries.flatMap(s=>htmlClosest(s,selectors)??htmlClosest(s,"li")??[]),$result=await callback.apply(null),result=$result[0];if(elements.length>0){const selector=elements.map(s=>htmlSelectorFor(s)).join(","),promises=htmlQueryAll(result,selector).map(container=>this.toggleSummary(container,{instant:!0,visible:!0}));await Promise.all(promises)}return $result}}const adjustmentScale=["incredibly-easy","very-easy","easy","normal","hard","very-hard","incredibly-hard"],dcAdjustments=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),dcByLevel=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]),simpleDCs=new Map([["untrained",10],["trained",15],["expert",20],["master",30],["legendary",40]]),simpleDCsWithoutLevel=new Map([["untrained",10],["trained",15],["expert",20],["master",25],["legendary",30]]);function rarityToDCAdjustment(rarity="common"){switch(rarity){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}__name(rarityToDCAdjustment,"rarityToDCAdjustment"),__name2(rarityToDCAdjustment,"rarityToDCAdjustment");function adjustDC(dc,adjustment="normal"){return dc+(dcAdjustments.get(adjustment)??0)}__name(adjustDC,"adjustDC"),__name2(adjustDC,"adjustDC");function adjustDCByRarity(dc,rarity="common"){return adjustDC(dc,rarityToDCAdjustment(rarity))}__name(adjustDCByRarity,"adjustDCByRarity"),__name2(adjustDCByRarity,"adjustDCByRarity");function calculateDC(level,{pwol,rarity="common"}={}){pwol??=game.pf2e.settings.variants.pwol.enabled;const dc=dcByLevel.get(level)??14;return adjustDCByRarity(pwol?dc-Math.max(level,0):dc,rarity)}__name(calculateDC,"calculateDC"),__name2(calculateDC,"calculateDC");function calculateSimpleDC(rank,{pwol=!1}={}){return pwol?simpleDCsWithoutLevel.get(rank)??10:simpleDCs.get(rank)??10}__name(calculateSimpleDC,"calculateSimpleDC"),__name2(calculateSimpleDC,"calculateSimpleDC");function combineDCAdjustments(first,second){const startingIndex=adjustmentScale.indexOf(first),lowerByIndex=adjustmentScale.indexOf(second),resultIndex=Math.min(Math.max(startingIndex+lowerByIndex-3,0),6);return adjustmentScale[resultIndex]}__name(combineDCAdjustments,"combineDCAdjustments"),__name2(combineDCAdjustments,"combineDCAdjustments");function createDifficultyScale(dc,startAt){const beginAtIndex=adjustmentScale.indexOf(startAt);return adjustmentScale.filter((_value,index2)=>index2>=beginAtIndex).map(value=>adjustDC(dc,value))}__name(createDifficultyScale,"createDifficultyScale"),__name2(createDifficultyScale,"createDifficultyScale");function getMagicTraditions(item){const traits=item.system.traits.value;return new Set(traits.filter(t2=>setHasElement(MAGIC_TRADITIONS,t2)))}__name(getMagicTraditions,"getMagicTraditions"),__name2(getMagicTraditions,"getMagicTraditions");function getDcRarity(item){return item.traits.has("cursed")?"unique":item.rarity}__name(getDcRarity,"getDcRarity"),__name2(getDcRarity,"getDcRarity");function getIdentifyMagicDCs(item,baseDC,notMatchingTraditionModifier){const result={occult:baseDC,primal:baseDC,divine:baseDC,arcane:baseDC},traditions=getMagicTraditions(item);for(const key of MAGIC_TRADITIONS)traditions.size>0&&!traditions.has(key)&&(result[key]=baseDC+notMatchingTraditionModifier);return{arcana:result.arcane,nature:result.primal,religion:result.divine,occultism:result.occult}}__name(getIdentifyMagicDCs,"getIdentifyMagicDCs"),__name2(getIdentifyMagicDCs,"getIdentifyMagicDCs");function getItemIdentificationDCs(item,{pwol=!1,notMatchingTraditionModifier}){const baseDC=calculateDC(item.level,{pwol}),rarity=getDcRarity(item),dc=adjustDCByRarity(baseDC,rarity);return item.isMagical?getIdentifyMagicDCs(item,dc,notMatchingTraditionModifier):{crafting:dc}}__name(getItemIdentificationDCs,"getItemIdentificationDCs"),__name2(getItemIdentificationDCs,"getItemIdentificationDCs");function getUnidentifiedPlaceholderImage(item){return`systems/pf2e/icons/unidentified_item_icons/${(()=>{if(item.isOfType("weapon")){const{traits}=item;return traits.has("bomb")?"alchemical_bomb":traits.has("staff")?"staves":traits.has("artifact")?"artifact":"weapon"}else{if(item.isOfType("armor"))return"armor";if(item.isOfType("shield"))return"shields";if(item.isOfType("consumable"))switch(item.category){case"oil":return"oils";case"scroll":return"infernal-contracts";case"talisman":return"talisman";case"elixir":case"mutagen":return"alchemical_elixir";case"poison":return"alchemical_poison";case"toolkit":return"alchemical_tool";case"wand":return"wands";case"potion":return"potions";case"snare":case"other":default:return item.traits.has("drug")?"drugs":"other-consumables"}else{if(item.isOfType("ammo"))return"ammunition";if(item.isOfType("equipment")&&item.traits.has("precious"))return"material-chunk"}}return"adventuring_gear"})()}.webp`}__name(getUnidentifiedPlaceholderImage,"getUnidentifiedPlaceholderImage"),__name2(getUnidentifiedPlaceholderImage,"getUnidentifiedPlaceholderImage");const appv1$j=foundry.appv1;class IdentifyItemPopup extends appv1$j.api.FormApplication{static{__name(this,"IdentifyItemPopup")}static{__name2(this,"IdentifyItemPopup")}static get defaultOptions(){return{...super.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}dcs=getItemIdentificationDCs(this.object,{pwol:game.pf2e.settings.variants.pwol.enabled,notMatchingTraditionModifier:game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier")});async getData(){const item=this.object;return{...await super.getData(),isMagic:item.isMagical,isAlchemical:item.isAlchemical,dcs:this.dcs}}activateListeners($html){const html2=$html[0],updateButton=html2.querySelector("button.update-identification");updateButton?.addEventListener("click",()=>{this.submit({updateData:{status:updateButton.value}})}),html2.querySelector("button.post-skill-checks")?.addEventListener("click",async()=>{const item=this.object,identifiedName=item.system.identification.identified.name,dcs=this.dcs,action2=item.isMagical?"identify-magic":item.isAlchemical?"identify-alchemy":"recall-knowledge",content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{identifiedName,action:action2,skills:n$1(dcs,["dc"]),unidentified:item.system.identification.unidentified,uuid:item.uuid});await ChatMessagePF2e.create({author:game.user.id,content})})}async _updateObject(_event,formData){const status=formData.status;if(status==="identified")return this.object.setIdentificationStatus(status)}}class ItemTransferDialog extends foundry.applications.api.DialogV2{static{__name(this,"ItemTransferDialog")}static{__name2(this,"ItemTransferDialog")}static DEFAULT_OPTIONS={id:"item-transfer-dialog",window:{icon:"fa-solid fa-hand-holding-box",contentClasses:["standard-form"]},position:{width:450},newStack:!1,lockStack:!1,mode:"move"};static#MODE_ICONS={purchase:"fa-solid fa-coins",move:"fa-solid fa-hand-holding-box",gift:"fa-solid fa-gift",credits:"fa-solid fa-credit-card"};static#callback=__name2((_event,button)=>{const form=button.closest("form");if(!form)throw ErrorPF2e("Unexpected missing form");const submitData=new foundry.applications.ux.FormDataExtended(form).object,quantity=Number(submitData.quantity)||1,mode=objectHasKey(ItemTransferDialog.#MODE_ICONS,button.dataset.action)?button.dataset.action:"move";return{quantity,mode,newStack:!!submitData.newStack}},"#callback");_initializeApplicationOptions(options){const initialized=super._initializeApplicationOptions(options);initialized.window.icon=ItemTransferDialog.#MODE_ICONS[initialized.mode??"move"];const mode=initialized.mode,itemName=initialized.item.name;return initialized.window.title=game.i18n.format(`PF2E.ItemTransferDialog.Title.${mode}`,{item:itemName}),initialized}static async wait(options){const{item,newStack=!1,lockStack=!1}=options,isCredits=item.isOfType("treasure")&&item.system.category==="credstick",mode=options.mode=isCredits?"credits":options.mode??"move",checkedValue=mode==="credits"?item.price.value.credits:item.quantity;if(checkedValue<2&&(mode!=="purchase"||!item.isOwner))return{quantity:checkedValue,newStack,mode};const actorName=options.recipient.name,isAmmo=item.isOfType("ammo"),quantity=mode==="purchase"?isAmmo?Math.min(10,item.quantity):1:checkedValue,context={prompt:game.i18n.format(`PF2E.ItemTransferDialog.Prompt.${mode}`,{actor:actorName}),item,quantity,maxQuantity:checkedValue,mode,newStack,lockStack,rootId:"item-transfer-dialog"},content=document.createElement("div"),templatePath="systems/pf2e/templates/popups/item-transfer-dialog.hbs";content.innerHTML=await foundry.applications.handlebars.renderTemplate(templatePath,context);const buttons=[],callback=ItemTransferDialog.#callback;if(mode==="purchase"){if(item.isOwner){const icon2=ItemTransferDialog.#MODE_ICONS.gift;buttons.push({type:"button",icon:icon2,label:"PF2E.ItemTransferDialog.Button.gift",action:"move",callback})}const icon=ItemTransferDialog.#MODE_ICONS.purchase;buttons.push({type:"submit",icon,label:"PF2E.ItemTransferDialog.Button.purchase",action:mode,callback})}else{const icon=ItemTransferDialog.#MODE_ICONS.gift,label=`PF2E.ItemTransferDialog.Button.${mode}`;buttons.push({type:"submit",icon,label,action:mode,callback})}return super.wait(Object.assign(options,{item,mode,newStack,lockStack,content,buttons}))}static async confirm(){throw ErrorPF2e("The item transfer dialog must be utilized via the static wait method.")}static async prompt(){throw ErrorPF2e("The item transfer dialog must be utilized via the static wait method.")}static async query(){throw ErrorPF2e("The item transfer dialog must be utilized via the static wait method.")}async _onRender(context,options){await super._onRender(context,options),this.#renderPurchasePrice()}_onChangeForm(formConfig,event2){super._onChangeForm(formConfig,event2),event2.target instanceof foundry.applications.elements.HTMLRangePickerElement&&event2.target.name==="quantity"&&this.#renderPurchasePrice()}#renderPurchasePrice(){const{mode,item}=this.options;if(mode!=="purchase")return;const quantityInput=this.element.querySelector("input[name=quantity]"),purchaseButton=this.element.querySelector("button[data-action=purchase]");if(!quantityInput||!purchaseButton)return;const quantity=Math.clamp(Number(quantityInput.value)||1,1,item.quantity),cost=Coins.fromPrice(item.price,quantity),span=purchaseButton.querySelector("span[data-price]")??purchaseButton.insertAdjacentElement("beforeend",document.createElement("span"));span instanceof HTMLSpanElement&&(span.dataset.price="",span.textContent=`(${cost.toString()})`)}}const appv1$i=foundry.appv1;class IWREditor extends appv1$i.api.DocumentSheet{static{__name(this,"IWREditor")}static{__name2(this,"IWREditor")}category;types;constructor(actor,options){if(super(actor,options),this.actor.isOfType("familiar","loot"))throw ErrorPF2e(`Actor ${this.actor.name} (${this.actor.uuid}) may not have stored IWR data`);this.category=options.category,this.types={immunities:n$1(CONFIG.PF2E.immunityTypes,["custom"]),weaknesses:n$1(CONFIG.PF2E.weaknessTypes,["custom"]),resistances:n$1(CONFIG.PF2E.resistanceTypes,["custom"])}[this.category]}static get defaultOptions(){return{...super.defaultOptions,closeOnSubmit:!1,classes:["iwr-editor"],template:"systems/pf2e/templates/actors/iwr-editor.hbs",sheetConfig:!1,width:500,height:"auto"}}get id(){return`${this.category}-editor-${this.actor.uuid}`}get title(){return game.i18n.format("PF2E.Actor.IWREditor.Title",{actor:this.actor.name,category:game.i18n.localize(this.categoryLabel)})}get actor(){return this.document}get categoryLabel(){return{immunities:"PF2E.ImmunitiesLabel",weaknesses:"PF2E.WeaknessesLabel",resistances:"PF2E.ResistancesLabel"}[this.category]}async getData(options={}){return this.options.id=this.id,{...await super.getData(options),category:this.category,header:this.categoryLabel,list:this.actor.attributes[this.category],sourceData:this.actor._source.system.attributes?.[this.category]??[],types:this.types}}getUpdatedData({includeNew=!1}={}){const entryElems=htmlQueryAll(this.element[0],".entry:not(.new,[data-synthetic])");return includeNew&&entryElems.push(...htmlQueryAll(this.element[0],".entry.new")),entryElems.flatMap(entryElem=>{const iwrType=htmlQuery(entryElem,"select")?.value;if(!iwrType)return[];const value=Math.trunc(Math.abs(Number(htmlQuery(entryElem,"input[data-property=value]")?.value??"NaN")))||5,exceptionsData=JSON.parse(htmlQuery(entryElem,"input[data-property=exceptions]")?.value||"[]");if(!(Array.isArray(exceptionsData)&&exceptionsData.every(o=>e$2(o))))throw ErrorPF2e("Unexpected data encountered while submitting form");const exceptions=exceptionsData.map(e2=>e2.id),doubleVsData=JSON.parse(htmlQuery(entryElem,"input[data-property=doubleVs]")?.value||"[]"),doubleVs=Array.isArray(doubleVsData)&&doubleVsData.every(o=>e$2(o)&&typeof o.id=="string"&&o.id in this.types)&&this.category==="resistances"?doubleVsData.map(d=>d.id):void 0;return exceptions.every(e2=>typeof e2=="string")?{type:iwrType,value:this.category==="immunities"?void 0:value,exceptions,doubleVs}:[]})}async#updateIWR({includeNew=!1}={}){const data=this.getUpdatedData({includeNew}),formInput=htmlQuery(this.element[0],"input[name]");if(!formInput)throw ErrorPF2e("Unexpected error getting for input element");formInput.value=JSON.stringify(data),await this.submit({preventRender:!1})}_getHeaderButtons(){return super._getHeaderButtons().filter(b=>b.class==="close")}activateListeners($html){const html2=$html[0];for(const input of htmlQueryAll(html2,"input[type=text]"))tagify(input,{whitelist:this.types,maxTags:6});htmlQuery(html2,"a[data-action=add]")?.addEventListener("click",event2=>{const entryElem=htmlClosest(event2.target,".entry.new");htmlQuery(entryElem,"select[data-property=type]")?.value&&this.#updateIWR({includeNew:!0})});for(const inputOrSelect of htmlQueryAll(html2,"select, input")){const entryElem=htmlClosest(inputOrSelect,".entry");entryElem&&!entryElem.classList.contains("new")&&inputOrSelect.addEventListener("change",()=>{this.#updateIWR()})}for(const removeButton of htmlQueryAll(html2,"a[data-action=remove]"))removeButton.addEventListener("click",async event2=>{htmlClosest(event2.target,".entry")?.remove(),this.#updateIWR()})}}class UpdateCurrencyDialog extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"UpdateCurrencyDialog")}static{__name2(this,"UpdateCurrencyDialog")}constructor(options){super(options),this.actor=options.actor,this.mode=options.mode}static DEFAULT_OPTIONS={id:"update-currency",tag:"form",window:{icon:"fa-solid fa-currency",contentClasses:["standard-form"]},position:{width:300},form:{closeOnSubmit:!1,handler:UpdateCurrencyDialog.#onSubmit}};static PARTS={base:{template:"systems/pf2e/templates/actors/update-currency-dialog.hbs",root:!0}};actor;mode;get title(){return game.i18n.localize(this.mode==="add"?"PF2E.AddCoinsTitle":"PF2E.RemoveCoinsTitle")}async _prepareContext(options){const actor=this.actor,currency=this.actor.inventory.currency,showSF2e=currency.credits||currency.upb,denominations=[...COIN_DENOMINATIONS,...showSF2e?["credits","upb"]:[]].flat();return{...await super._prepareContext(options),id:this.id,actor,mode:this.mode,denominations:denominations.map(d=>({key:d,label:game.i18n.localize(CONFIG.PF2E.currencies[d])})),actionLabel:game.i18n.localize(this.mode==="add"?"PF2E.AddCoinsTitle":"PF2E.RemoveCoinsTitle")}}static async#onSubmit(_event,_form,formData){const data=formData.object,currency={pp:Number(data.pp)||0,gp:Number(data.gp)||0,sp:Number(data.sp)||0,cp:Number(data.cp)||0,credits:Number(data.credits)||0,upb:Number(data.upb)||0};if(this.mode==="add"){const combineStacks=!!data.combineStacks;await this.actor.inventory.addCurrency(currency,{combineStacks})}else if(!await this.actor.inventory.removeCurrency(currency,{byValue:!!data.removeByValue})){ui.notifications.warn("PF2E.ErrorMessage.NotEnoughCoins",{localize:!0});return}this.close()}}class ActorSheetPF2e extends foundry.appv1.sheets.ActorSheet{static{__name(this,"ActorSheetPF2e")}static{__name2(this,"ActorSheetPF2e")}static _warnedAppV1=!0;#inventorySearchEngine=new MiniSearch({fields:["name"],idField:"uuid",processTerm:__name2(t2=>t2.length>1?t2.toLocaleLowerCase(game.i18n.lang):null,"processTerm"),searchOptions:{combineWith:"AND",prefix:!0}});static get defaultOptions(){const options=super.defaultOptions;return options.dragDrop=[{dragSelector:"[data-foundry-list] [data-drag-handle]"},{dragSelector:"ul[data-loot] li[data-item-id]"},{dragSelector:".item-list .item:not(.inventory-list *)"}],options.filters=[{inputSelector:".inventory-header input[type=search]",contentSelector:"section.inventory-list"}],foundry.utils.mergeObject(options,{classes:["default","sheet","actor"],scrollY:[".sheet-sidebar",".tab.active",".inventory-list"]})}itemRenderer=new ItemSummaryRenderer(this);get isLootSheet(){return!this.actor.isOwner&&this.actor.isLootableBy(game.user)}async getData(options=this.options){options.id||=this.id,options.editable=this.isEditable,options.sheetConfig&&=Object.values(CONFIG.Actor.sheetClasses[this.actor.type]).filter(c=>c.canConfigure).length>1;const actor=this.actor;for(const item of[...actor.itemTypes.action,...this.actor.itemTypes.feat])item.system.selfEffect&&(item.system.selfEffect.img??=fromUuidSync(item.system.selfEffect.uuid)?.img??null);const actorData={...actor,_id:this.actor.id,system:foundry.utils.deepClone({...actor.system})},iwrKeys=["immunities","weaknesses","resistances"],attributes=actorData.system.attributes;for(const key of iwrKeys)attributes[key]=[...attributes[key]].sort((a,b)=>a.label.localeCompare(b.label));const traitsMap=(()=>{switch(actor.type){case"hazard":return CONFIG.PF2E.hazardTraits;case"vehicle":return CONFIG.PF2E.vehicleTraits;default:return CONFIG.PF2E.creatureTraits}})(),toggles=t$2(Object.values(actor.synthetics.toggles).flatMap(domain=>Object.values(domain)),t2=>t2.placement),sheetData={actor:actorData,cssClass:this.actor.isOwner?"editable":"locked",data:actorData.system,document:this.actor,editable:this.isEditable,effects:[],enrichedContent:{},inventory:this.prepareInventory(),isLootSheet:this.isLootSheet,isTargetFlatFooted:!!this.actor.rollOptions.all["target:condition:off-guard"],items:[],limited:this.actor.limited,options,owner:this.actor.isOwner,title:this.title,toggles,currency:this.#prepareCurrency(),traits:createSheetTags(traitsMap,{value:this.actor.system.traits?.value??[]}),user:{isGM:game.user.isGM},publicationLicenses:[{label:"PF2E.Publication.License.OGL",value:"OGL"},{label:"PF2E.Publication.License.ORC",value:"ORC"}]};return await this.prepareItems?.(sheetData),sheetData}prepareInventory(){const actor=this.actor,items=[...iterateAllItems(actor)].filter(i=>i.isOfType("physical"));this.#inventorySearchEngine.removeAll(),this.#inventorySearchEngine.addAll(items.map(i=>t$3(i,["uuid","name"])));const sections=[{label:game.i18n.localize("PF2E.Actor.Inventory.Section.WeaponsAndShields"),types:["weapon","shield"],items:[]},{label:game.i18n.localize("TYPES.Item.armor"),types:["armor"],items:[]},{label:game.i18n.localize("TYPES.Item.equipment"),types:["equipment"],items:[]},{label:game.i18n.localize("PF2E.Item.Consumable.Plural"),types:["consumable"],items:[]},{label:game.i18n.localize("TYPES.Item.ammo"),types:["ammo"],items:[]},{label:game.i18n.localize("TYPES.Item.treasure"),types:["treasure"],items:[]},{label:game.i18n.localize("PF2E.Item.Container.Plural"),types:["backpack"],items:[]}];for(const item of actor.inventory.contents.sort((a,b)=>(a.sort||0)-(b.sort||0))){if(item.isInContainer)continue;sections.find(s=>s.types.includes(item.type))?.items.push(this.prepareInventoryItem(item))}return{sections,bulk:actor.inventory.bulk,showValueAlways:actor.isOfType("npc","loot","party"),showUnitBulkPrice:!1,hasStowedWeapons:actor.itemTypes.weapon.some(i=>i.isStowed)||actor.itemTypes.shield.some(i=>i.isStowed),hasStowingContainers:actor.itemTypes.backpack.some(c=>c.system.stowing&&!c.isInContainer),invested:actor.inventory.invested}}prepareInventoryItem(item){const editable=game.user.isGM||item.isIdentified,heldItems=item.isOfType("backpack")?item.contents.map(i=>this.prepareInventoryItem(i)):null;heldItems?.sort((a,b)=>(a.item.sort||0)-(b.item.sort||0));const actor=this.actor,actorSize=new ActorSizePF2e({value:actor.size}),itemSize=new ActorSizePF2e({value:item.size}),sizeDifference=itemSize.difference(actorSize,{smallIsMedium:!0}),priceUnit=(item.isOfType("treasure")&&item.isCurrency?item.unit:null)??"primary";return{item,subitems:t(item.subitems.contents,i=>{const isAmmo=i.isOfType("ammo")||i.isOfType("weapon")&&item.isOfType("weapon")&&i.isAmmoFor(item),isEquipment=i.system.usage.type==="installed";return isAmmo?3:i.isOfType("weapon")?0:isEquipment?1:2}),canBeEquipped:!item.isStowed,canEditQuantity:!(item.isOfType("backpack")&&item.contents.size>0)&&!(item.isOfType("treasure")&&item.system.category==="credstick"),hasCharges:item.isOfType("consumable")&&item.system.uses.max>0||item.isOfType("ammo")&&item.system.uses.max>1,heldItems,isContainer:item.isOfType("backpack"),isInvestable:!1,isSellable:editable&&item.isOfType("treasure")&&!item.isCurrency,itemSize:sizeDifference!==0?itemSize:null,unitBulk:actor.isOfType("loot")?createBulkPerLabel(item):null,unitPrice:item.price.value.toString({short:!0,unit:priceUnit}),assetValue:item.assetValue.toString({short:!0,unit:priceUnit}),hidden:!1}}_onSearchFilter(event2,query,rgx,html2){super._onSearchFilter(event2,query,rgx,html2);const getAllParents=__name2(item=>{const parents=[item.container,item.parentItem].filter(i=>!!i);return[...parents,...parents.flatMap(p=>getAllParents(p))]},"getAllParents"),getAllChildren=__name2(item=>{const contents=[...item.isOfType("backpack")?item.contents:[],...item.subitems];return[...contents,...contents.flatMap(c=>getAllChildren(c))]},"getAllChildren"),matches=(()=>{if(html2?.classList.contains("inventory-list")&&query.length>1){const baseMatches=this.#inventorySearchEngine.search(query).map(s=>String(s.id)),allItems=[...iterateAllItems(this.actor)],itemsByUuid=t$9(allItems.filter(i=>i.isOfType("physical")),i=>[i.uuid,i]),baseItems=baseMatches.map(uuid=>itemsByUuid[uuid]).filter(i=>!!i),parentMatches=baseItems.flatMap(i=>getAllParents(i)).map(i=>i.uuid),childMatches=baseItems.flatMap(i=>getAllChildren(i)).map(i=>i.uuid);return new Set([baseMatches,parentMatches,childMatches].flat())}return null})();for(const row of htmlQueryAll(html2,"li[data-uuid]"))row.hidden=matches!==null&&!matches.has(row.dataset.uuid??"")}#prepareCurrency(){const actor=this.actor,totalWealth=actor.inventory.totalWealth,currency=actor.inventory.currency,coins=new Coins(t$3(currency,COIN_DENOMINATIONS)),showSF2e=currency.credits||currency.upb,denominations=showSF2e?["gp","credits","upb"]:COIN_DENOMINATIONS;return showSF2e&&(currency.gp=coins.goldValue,coins.sp=coins.pp=coins.cp=0),{units:denominations.reduce((accumulated,d)=>({...accumulated,[d]:{value:currency[d],label:CONFIG.PF2E.currencies[d]}}),{}),totalCurrency:coins.plus({sp:currency.credits+currency.upb}).toString({decimal:!0}),totalWealth:totalWealth.toString({decimal:!0})}}getAttackActionFromDOM(button,readyOnly=!1){const actionIndex=Number(htmlClosest(button,"[data-action-index]")?.dataset.actionIndex??"NaN"),rootAction=this.actor.system.actions?.at(actionIndex)??null,altUsage="altUsage"in button?.dataset?Number(button?.dataset.altUsage):null,strike=typeof altUsage=="number"?rootAction?.altUsages?.at(altUsage)??null:rootAction;return strike?.ready||!readyOnly?strike:null}activateListeners($html){super.activateListeners($html);const html2=$html[0];this.activateClickListener(html2);const inventoryPanel=(()=>{const selector=this.actor.isOfType("loot")?".sheet-body":".tab[data-tab=inventory]";return htmlQuery(html2,selector)})();if(this.#activateInventoryDragDrop(inventoryPanel),!this.isEditable&&this.actor.testUserPermission(game.user,"OBSERVER"))for(const input of html2.querySelectorAll("input[type=search]"))input.disabled=!1;if(!this.isEditable)return;const manualPropertyInputs=htmlQueryAll(html2,"select[data-property],input[data-property]");for(const input of manualPropertyInputs){const isModifier=input.classList.contains("modifier")||input.dataset.modifier!==void 0,isNullable="nullable"in input.dataset;input.addEventListener("focus",()=>{const propertyPath=input.dataset.property??"";if(input.name=propertyPath,input instanceof HTMLInputElement){const savedValue=foundry.utils.getProperty(this.actor._source,propertyPath),baseValue=isNullable&&savedValue===null?null:Math.trunc(Number(savedValue)||0);input.value=(baseValue??"").toString(),input.type==="text"&&input.dataset.dtype==="Number"&&(input.type="number")}}),input.addEventListener("blur",()=>{input.removeAttribute("name");const propertyPath=input.dataset.property??"",preparedValue=foundry.utils.getProperty(this.actor,propertyPath),currentValue=preparedValue===null&&isNullable?preparedValue:Number(preparedValue)||0,baseValue=Math.trunc(Number(foundry.utils.getProperty(this.actor._source,propertyPath))||0),newValue=isNullable&&input.value===""?null:Math.trunc(Number(input.value));input instanceof HTMLInputElement&&(input.type==="number"&&input.dataset.dtype==="Number"&&(input.type="text"),baseValue===newValue&&(input.value=newValue===null?"":isModifier?signedInteger(currentValue||0):String(currentValue||0)))})}const itemPropertyInputs=htmlQueryAll(html2,"input[data-item-id][data-item-property], select[data-item-id][data-item-property]");for(const element of itemPropertyInputs)element.addEventListener("change",async event2=>{event2.stopPropagation();const{itemId,itemProperty}=element.dataset;if(!itemId||!itemProperty)return;const value=(()=>{const value2=element instanceof HTMLInputElement&&element.type==="checkbox"?element.checked:element.value;return typeof value2=="boolean"?value2:(element.dataset.dtype??(["number","range"].includes(element.type)?"Number":"String"))==="Number"?Number(value2)||0:value2.trim()})();(await this.actor.updateEmbeddedDocuments("Item",[{_id:itemId,[itemProperty]:value}])).length===0&&this.render(!0)});for(const togglesSection of htmlQueryAll(html2,"ul[data-option-toggles]"))togglesSection.addEventListener("change",event2=>{const toggleRow=htmlClosest(event2.target,"[data-item-id][data-domain][data-option]"),checkbox=htmlQuery(toggleRow,"input[data-action=toggle-roll-option]"),suboptionsSelect=htmlQuery(toggleRow,"select[data-action=set-suboption"),{domain,option,itemId}=toggleRow?.dataset??{},suboption=suboptionsSelect?.value??null;checkbox&&domain&&option&&this.actor.toggleRollOption(domain,option,itemId??null,checkbox.checked,suboption)});for(const strikeElem of htmlQueryAll(html2,"ol.strikes-list > li[data-strike]")){const attackSelectors=".item-image[data-action=strike-attack], button[data-action=strike-attack]";for(const button of htmlQueryAll(strikeElem,attackSelectors))button.addEventListener("click",async event2=>{if(!Array.isArray(this.actor.system.actions))throw ErrorPF2e("Strikes are not supported on this actor");const altUsage=tupleHasValue(["thrown","melee"],button.dataset.altUsage)?button.dataset.altUsage:null,strike=this.getAttackActionFromDOM(button,!0),variantIndex=Number(button.dataset.variantIndex);await strike?.variants[variantIndex]?.roll({event:event2,altUsage})});const damageSelectors="button[data-action=strike-damage], button[data-action=strike-critical]";for(const button of htmlQueryAll(strikeElem,damageSelectors)){const strike=this.getAttackActionFromDOM(button),method=button.dataset.action==="strike-damage"?"damage":"critical";button.addEventListener("click",async event2=>{await strike?.[method]?.({event:event2})});const altUsage=tupleHasValue(["thrown","melee"],button.dataset.altUsage)?button.dataset.altUsage:null;strike?.[method]?.({getFormula:!0,altUsage}).then(formula=>{formula&&(button.dataset.tooltip=formula.toString())})}}for(const link of htmlQueryAll(html2,".tag-selector"))link.addEventListener("click",()=>this.openTagSelector(link));for(const effectDecrement of htmlQueryAll(html2,".effects-list .decrement"))effectDecrement.addEventListener("click",event2=>{const parent=htmlClosest(event2.currentTarget,".item"),effect=this.actor.items.get(parent?.dataset.itemId??"");effect instanceof AbstractEffectPF2e&&effect.decrease()});for(const effectIncrement of htmlQueryAll(html2,".effects-list .increment"))effectIncrement.addEventListener("click",event2=>{const parent=htmlClosest(event2.currentTarget,".item"),effect=this.actor?.items.get(parent?.dataset.itemId??"");effect instanceof AbstractEffectPF2e&&effect.increase()});for(const inputElem of htmlQueryAll(html2,"input[type=text], input[type=number]"))inputElem.addEventListener("focus",()=>{inputElem.select()});for(const deltaInput of htmlQueryAll(html2,"input[data-allow-delta]")){deltaInput.dataset.numValue=deltaInput.value;const sendChangeEvent=foundry.utils.debounce(value=>{deltaInput.value=value,deltaInput.dispatchEvent(new Event("change",{bubbles:!0}))},1e3),updateInput=__name2(delta=>{const min=Number(deltaInput.dataset.min)||0,max=deltaInput.dataset.max?Number(deltaInput.dataset.max):1/0,rawValue=deltaInput.value,value=Number(rawValue),oldValue=Number(deltaInput.dataset.numValue||"0"),appliedValue=Number.isNaN(value)?oldValue:deltaInput.value.startsWith("+")||deltaInput.value.startsWith("-")?Math.clamp(oldValue+value,min,max):Math.clamp(value,min,max),newValue=Math.clamp(appliedValue+(delta??0),min,max);deltaInput.value=deltaInput.dataset.numValue=String(newValue)},"updateInput");deltaInput.addEventListener("input",()=>{const match=/[+-]?\d*/.exec(deltaInput.value)?.at(0);deltaInput.value=match??deltaInput.value}),deltaInput.addEventListener("keydown",event2=>{const step2=event2.key==="ArrowUp"?1:event2.key==="ArrowDown"?-1:0;step2!==0&&(updateInput(step2),sendChangeEvent(deltaInput.value))}),deltaInput.addEventListener("wheel",event2=>{if(deltaInput===document.activeElement){event2.preventDefault();const step2=Math.sign(-1*event2.deltaY);updateInput(step2),sendChangeEvent(deltaInput.value)}},{passive:!1}),deltaInput.addEventListener("change",()=>{updateInput()})}for(const filter of this._searchFilters){const rgx=new RegExp(RegExp.escape(filter.query),"i");this._onSearchFilter(new KeyboardEvent("input"),filter.query,rgx,filter._content)}}activateClickListener(html2){const itemFromDOM=__name2(async event2=>{const actor=this.actor,itemUuid=htmlClosest(event2.target,"[data-uuid]")?.dataset.uuid,itemEl=htmlClosest(event2.target,"[data-item-id]"),itemId=itemEl?.dataset.itemId,collectionId=itemEl?.dataset.entryId,collection=collectionId?actor.spellcasting?.collections.get(collectionId,{strict:!0})??null:null;if(collection)return collection.get(itemId,{strict:!0});const item=await fromUuid(itemUuid??"")??this.actor.items.get(itemId,{strict:!0});if(item.actor!==actor){const subphrase=itemUuid||!itemId?`uuid ${itemUuid}`:`id ${itemId}`;throw ErrorPF2e(`Failed to retrieve owned item with ${subphrase}`)}return item},"itemFromDOM"),inventoryItemFromDOM=__name2(async event2=>{const item=await itemFromDOM(event2);if(!item?.isOfType("physical"))throw ErrorPF2e("Attempted to retrieve item, but it is not a physical item");return item},"inventoryItemFromDOM"),handlers={"browse-abilities":__name2((_,anchor)=>{this.#onClickBrowseAbilities(anchor)},"browse-abilities"),"browse-equipment":__name2((_,anchor)=>this.#onClickBrowseEquipment(anchor),"browse-equipment"),"create-item":__name2((_,anchor)=>{this.#onClickCreateItem(anchor)},"create-item"),"edit-item":__name2(async event2=>(await itemFromDOM(event2)).sheet.render(!0),"edit-item"),"effect-toggle-unidentified":__name2(event2=>{const effectId=htmlClosest(event2.target,"[data-item-id]")?.dataset.itemId,effect=this.actor.items.get(effectId,{strict:!0});if(effect.isOfType("effect")){const isUnidentified=effect.system.unidentified;return effect.update({"system.unidentified":!isUnidentified})}},"effect-toggle-unidentified"),"delete-item":__name2(async event2=>this.deleteItem(await itemFromDOM(event2),event2),"delete-item"),"item-to-chat":__name2(async event2=>{const item=await itemFromDOM(event2);if(item.isOfType("spell")){const castRank=Number(htmlClosest(event2.target,"[data-cast-rank]")?.dataset.castRank??NaN);return item.toMessage(event2,{data:{castRank}})}return item.toMessage(event2)},"item-to-chat"),"roll-check":__name2((event2,anchor)=>{const statisticSlug=htmlClosest(anchor,"[data-statistic]")?.dataset.statistic??"",statistic=this.actor.getStatistic(statisticSlug),args=eventToRollParams(event2,{type:"check"});return anchor.dataset.secret!==void 0&&(args.rollMode=game.user.isGM?"gmroll":"blindroll"),statistic?.roll(args)},"roll-check"),"roll-initiative":__name2((_,element)=>{if(!element.classList.contains("disabled")&&this.actor.initiative)return this.actor.initiative.roll(eventToRollParams(event,{type:"check"}))},"roll-initiative"),"show-image":__name2(()=>{const actor=this.actor,window2={title:actor.token?.name??actor.prototypeToken?.name??actor.name};return new foundry.applications.apps.ImagePopout({src:actor.img,window:window2,uuid:actor.uuid}).render({force:!0})},"show-image"),"toggle-summary":__name2((_,anchor)=>{const selectors=["subitem-id","item-id","action-index"].map(s=>`[data-${s}]`).join(","),element=htmlClosest(anchor,selectors)??htmlClosest(anchor,"li");if(element)return this.itemRenderer.toggleSummary(element)},"toggle-summary"),"use-action":__name2((event2,anchor)=>{const actionSlug=htmlClosest(anchor,"[data-action-slug]")?.dataset.actionSlug;if(actionSlug){const action2=game.pf2e.actions[actionSlug??""];if(!action2)throw ErrorPF2e(`Unexpecteed error retrieving action ${actionSlug}`);return action2({event:event2,actors:[this.actor]})}const itemId=htmlClosest(anchor,"[data-item-id]")?.dataset.itemId,item=this.actor.items.get(itemId,{strict:!0});if(item.isOfType("action","feat"))return createUseActionMessage(item,eventToRollMode(event2))},"use-action"),"add-coins":__name2(()=>new UpdateCurrencyDialog({actor:this.actor,mode:"add"}).render({force:!0}),"add-coins"),"decrease-credits":__name2(async event2=>{const item=await inventoryItemFromDOM(event2),subtrahend=event2.ctrlKey?10:event2.shiftKey?5:1,newCredits=Math.max(0,item.system.price.value.credits-subtrahend);if(newCredits!==item.system.price.value.credits)return item.update({"system.price.==value":{sp:newCredits}})},"decrease-credits"),"decrease-quantity":__name2(async event2=>{const item=await inventoryItemFromDOM(event2);if(item.quantity>0){const subtrahend=Math.min(item.quantity,event2.ctrlKey?10:event2.shiftKey?5:1);return item.update({"system.quantity":item.quantity-subtrahend})}},"decrease-quantity"),"detach-subitem":__name2(async event2=>(await inventoryItemFromDOM(event2)).detach({skipConfirm:isControlDown(event2)}),"detach-subitem"),"increase-credits":__name2(async event2=>{const item=await inventoryItemFromDOM(event2),addend=event2.ctrlKey?10:event2.shiftKey?5:1,newCredits=Math.max(0,item.system.price.value.credits+addend);return item.update({"system.price.==value":{sp:newCredits}})},"increase-credits"),"increase-quantity":__name2(async event2=>{const item=await inventoryItemFromDOM(event2),addend=event2.ctrlKey?10:event2.shiftKey?5:1;return item.update({"system.quantity":item.quantity+addend})},"increase-quantity"),"remove-coins":__name2(()=>new UpdateCurrencyDialog({actor:this.actor,mode:"remove"}).render({force:!0}),"remove-coins"),"repair-item":__name2(async event2=>{const item=await inventoryItemFromDOM(event2);return game.pf2e.actions.repair({event:event2,item})},"repair-item"),"sell-all-treasure":__name2(()=>this.#onClickSellAllTreasure(),"sell-all-treasure"),"sell-treasure":__name2(async event2=>{const item=await inventoryItemFromDOM(event2),sellItem=__name2(async()=>{item?.isOfType("treasure")&&!item.isCoinage&&(await item.delete(),await this.actor.inventory.addCoins(item.assetValue))},"sellItem");if(event2.ctrlKey)return sellItem();const content=document.createElement("p");return content.innerText=game.i18n.format("PF2E.SellItemQuestion",{item:item.name}),new foundry.appv1.api.Dialog({title:game.i18n.localize("PF2E.SellItemConfirmHeader"),content:content.outerHTML,buttons:{Yes:{icon:fontAwesomeIcon("check").outerHTML,label:game.i18n.localize("Yes"),callback:sellItem},cancel:{icon:fontAwesomeIcon("times").outerHTML,label:game.i18n.localize("Cancel")}},default:"Yes"}).render(!0)},"sell-treasure"),"toggle-container":__name2(async event2=>{const item=await inventoryItemFromDOM(event2);if(!item.isOfType("backpack"))return;const isCollapsed=item.system.collapsed??!1;return item.update({"system.collapsed":!isCollapsed})},"toggle-container"),"toggle-identified":__name2(async event2=>{const item=await inventoryItemFromDOM(event2);item.isIdentified?item.setIdentificationStatus("unidentified"):new IdentifyItemPopup(item).render(!0)},"toggle-identified")};for(const listName of["immunities","weaknesses","resistances"])handlers[`edit-${listName}`]=()=>new IWREditor(this.actor,{category:listName}).render(!0);const sheetHandler=__name2(async event2=>{const actionTarget=htmlClosest(event2.target,"a[data-action], button[data-action]"),handler=handlers[actionTarget?.dataset.action??""];if(handler&&actionTarget){event2.stopImmediatePropagation(),html2.removeEventListener("click",sheetHandler),setTimeout(()=>{html2.addEventListener("click",sheetHandler)},50);try{await handler(event2,actionTarget)}catch(error){console.error(error)}}},"sheetHandler");return html2.addEventListener("click",sheetHandler),handlers}#activateInventoryDragDrop(panel){const section=htmlQuery(panel,"section[data-inventory]");if(!(!section||!this.isEditable))for(const list of htmlQueryAll(section,"ul[data-item-list]")){const options={...SORTABLE_BASE_OPTIONS,revertOnSpill:!0,scroll:section,setData:__name2((dataTransfer,dragEl)=>{const item=this.actor.inventory.get(dragEl.dataset.itemId,{strict:!0});dataTransfer.setData("text/plain",JSON.stringify({...item.toDragData(),fromInventory:!0}))},"setData"),onMove:__name2(event2=>this.#onMoveInventoryItem(event2),"onMove"),onEnd:__name2(event2=>this.#onDropInventoryItem(event2),"onEnd")};createSortable(list,options)}}#onMoveInventoryItem(event2){const isSeparateSheet=htmlClosest(event2.target,"form")!==htmlClosest(event2.related,"form");if(!this.isEditable||isSeparateSheet)return!1;const sourceItem=this.actor.inventory.get(event2.dragged?.dataset.itemId,{strict:!0}),containerRowData=htmlQueryAll(this.form,"li[data-is-container] > .data");for(const row of containerRowData)row.classList.remove("drop-highlight");const targetSection=htmlClosest(event2.related,"ul[data-item-types]")?.dataset.itemTypes?.split(",")??[];if(targetSection.length===0)return!1;if(targetSection.includes(sourceItem.type))return!0;if(targetSection.includes("backpack")){const openContainerId=htmlClosest(event2.related,"ul[data-container-id]")?.dataset.containerId??"",openContainer=this.actor.inventory.get(openContainerId),targetItemRow=htmlClosest(event2.related,"li[data-item-id]"),targetItem=this.actor.inventory.get(targetItemRow?.dataset.itemId??"");if(targetItem?.isOfType("backpack")){if(isContainerCycle(sourceItem,targetItem))return!1;if(targetItemRow&&!openContainer)return htmlQuery(targetItemRow,":scope > .data")?.classList.add("drop-highlight"),!1}return!!targetItem}return!1}async#onDropInventoryItem(event2){if(!this.isEditable)return;const dropTarget=event2.originalEvent?.target,droppedOnCanvas=!!dropTarget&&dropTarget instanceof HTMLCanvasElement;if(!droppedOnCanvas&&htmlClosest(event2.originalEvent?.target,"form")!==this.form)return;const containerRowData=htmlQueryAll(this.form,"li[data-is-container] > .data");for(const row of containerRowData)row.classList.remove("drop-highlight");if(droppedOnCanvas||!htmlClosest(dropTarget,"ul[data-item-list]"))return;const inventory=this.actor.inventory,sourceItem=inventory.get(event2.item.dataset.itemId,{strict:!0}),itemListMovedTo=event2.item.closest("ul[data-item-list]"),itemsInList=htmlQueryAll(itemListMovedTo,":scope > li").map(li=>li.dataset.itemId===sourceItem.id?sourceItem:inventory.get(li.dataset.itemId,{strict:!0})),targetItemId=htmlClosest(dropTarget,"li[data-item-id]")?.dataset.itemId??"",targetItem=inventory.get(targetItemId),stackTarget=targetItem?.isStackableWith(sourceItem)?targetItem:null;if(stackTarget)return sourceItem.move({toStack:stackTarget});const containerId=htmlClosest(event2.item,"ul[data-container-id]")?.dataset.containerId??"",container=targetItem?.isOfType("backpack")?targetItem:inventory.get(containerId);if(container&&!container.isOfType("backpack"))throw ErrorPF2e("Unexpected non-container retrieved while sorting items");if(container&&isContainerCycle(sourceItem,container)){this.render();return}const sourceIndex=itemsInList.indexOf(sourceItem),targetBefore=itemsInList[sourceIndex-1],targetAfter=itemsInList[sourceIndex+1],siblings=[...itemsInList];siblings.splice(siblings.indexOf(sourceItem),1);const sortingUpdates=foundry.utils.performIntegerSort(sourceItem,{siblings,target:targetBefore??targetAfter,sortBefore:!targetBefore}).map(u=>({_id:u.target.id,"system.containerId":container?.id??null,sort:u.update.sort}));sortingUpdates.some(u=>u._id===sourceItem.id)||sortingUpdates.push({_id:sourceItem.id,"system.containerId":container?.id??null}),await this.actor.updateEmbeddedDocuments("Item",sortingUpdates)}deleteItem(item,event2){return event2?.ctrlKey||event2?.shiftKey?item.delete():item.deleteDialog()}#onClickBrowseAbilities(anchor){const types=(anchor.dataset.actionType||"").split(","),traits=(anchor.dataset.actionTrait||"").split(","),categories=(anchor.dataset.actionCategory||"").split(",");game.pf2e.compendiumBrowser.openActionTab({types,traits,categories})}async#onClickBrowseEquipment(element){const checkboxesFilterCodes=(element.dataset.filter??"").split(",").map(s=>s.trim()).filter(s=>!!s),levelString=element.dataset.level,tab=game.pf2e.compendiumBrowser.tabs.equipment,filter=await tab.getFilterData(),checkboxes=filter.checkboxes;for(const itemType of checkboxesFilterCodes){const checkbox=checkboxes.itemTypes;objectHasKey(checkbox.options,itemType)&&(checkbox.options[itemType].selected=!0,checkbox.selected.push(itemType),checkbox.isExpanded=!0)}if(levelString){const level=filter.level,newValue=Math.clamp(Number(levelString),level.min,level.max);Number.isNaN(newValue)||(level.from=newValue,level.to=newValue),level.isExpanded=!0}tab.open({filter})}_canDragStart(selector){return this.isLootSheet||super._canDragStart(selector)}_canDragDrop(selector){return this.isLootSheet||super._canDragDrop(selector)}_onDragStart(event2){if(!(event2.target instanceof HTMLElement)||!event2.dataTransfer)return;const isContentLink=event2.target.dataset.link!==void 0&&!!event2.target.dataset.uuid,isPersistent="persistent"in event2.target.dataset;if(event2.target!==event2.currentTarget&&(isContentLink||isPersistent))return;const targetElement=event2.currentTarget,previewElement=htmlClosest(targetElement,"[data-item-id], [data-item-uuid], [data-strike]");if(previewElement&&targetElement&&targetElement!==previewElement){const{x,y}=previewElement.getBoundingClientRect();event2.dataTransfer.setDragImage(previewElement,event2.pageX-x,event2.pageY-y)}const itemId=previewElement?.dataset.itemId,item=this.actor.items.get(itemId??""),baseDragData={actorId:this.actor.id,actorUUID:this.actor.uuid,sceneId:canvas.scene?.id??null,tokenId:this.actor.token?.id??null,...item?.toDragData()};previewElement&&"isFormula"in previewElement.dataset&&(baseDragData.isFormula=!0,baseDragData.ability=previewElement.dataset.ability,baseDragData.uuid=previewElement.dataset.itemUuid);const supplementalData=(()=>{const actionIndex=previewElement?.dataset.actionIndex;if(actionIndex)return"itemType"in baseDragData&&baseDragData.itemType==="melee"?{index:Number(actionIndex)}:{type:"Action",index:Number(actionIndex)};const elementTrait=previewElement?.dataset.element;if(elementTrait)return{type:"Action",elementTrait};const label=previewElement?.innerText.trim(),rollOptionData=previewElement?.dataset??{};if(item&&label&&rollOptionData.domain&&rollOptionData.option)return{type:"RollOption",label,...rollOptionData};if("isFormula"in baseDragData)return{pf2e:{type:"CraftingFormula",itemUuid:itemId}};const collectionId=htmlClosest(previewElement,"[data-container-id]")?.dataset.containerId,groupId=previewElement?.dataset.groupId,slotIndex=Number(previewElement?.dataset.slotId);return collectionId&&groupId&&Number.isInteger(slotIndex)?{spellFrom:{collectionId,groupId,slotIndex}}:null})();event2.dataTransfer.setData("text/plain",JSON.stringify({...baseDragData,...supplementalData}))}async _onDrop(event2){const dropData=TextEditorPF2e.getDragEventData(event2);if(this.actor&&dropData.type==="PersistentDamage"&&"formula"in dropData){const roll=new DamageRoll(String(dropData.formula));if(roll.instances.length===0||roll.instances.some(i=>!i.persistent))throw ErrorPF2e("Unexpected error adding persistent damage: all instances must be persistent");const baseConditionSource=game.pf2e.ConditionManager.getCondition("persistent-damage").toObject(),conditions=roll.instances.map(i=>foundry.utils.mergeObject(baseConditionSource,{system:{persistent:{formula:i.head.expression,damageType:i.type,dc:15}}}));await this.actor.createEmbeddedDocuments("Item",conditions)}else return super._onDrop(event2)}async _onDropItem(event2,data){const item=await ItemPF2e.fromDropData(data);return item?item.actor?.uuid===this.actor.uuid?data.fromInventory?[]:this._onSortItem(event2,item.toObject()):item.actor&&item.isOfType("physical")?(await this.moveItemBetweenActors(event2,item,this.actor),[item]):this._handleDroppedItem(event2,item,data):[]}async _onSortItem(event2,itemData){return this.actor.isOwner?super._onSortItem(event2,itemData):[]}async _handleDroppedItem(event2,item,data){const actor=this.actor,itemSource=(()=>{const fromCompendium=data?.uuid?.startsWith("Compendium.")||event2.dataTransfer?.types.includes("from-browser");return(item.isOfType("physical")&&fromCompendium?sizeItemForActor(item,actor):item).toObject()})(),mystified=game.user.isGM&&event2.altKey;mystified&&itemSource.type==="effect"&&(itemSource.system.unidentified=!0),mystified&&item.isOfType("physical")&&itemIsOfType(itemSource,"physical")&&(itemSource.system.identification.unidentified=item.getMystifiedData("unidentified"),itemSource.system.identification.status="unidentified");const containerAttribute=htmlClosest(event2.target,".item-container")?.dataset.containerType,dropContainerType=this._tabs[0]?.active==="inventory"&&!containerAttribute?"actorInventory":containerAttribute,craftingTab=this._tabs[0]?.active==="crafting";if(item.isOfType("spell")&&itemSource.type==="spell")return item.isRitual?this._onDropItemCreate(item.clone().toObject()):dropContainerType==="actorInventory"&&itemSource.system.level.value>0?(new SpellcastingItemCreator({actor,spell:item,mystified}).render({force:!0}),[item]):[];if(itemSource.type==="spellcastingEntry")return[];if(itemSource.type==="condition"){const value=data.value;return typeof value=="number"&&itemSource.system.value.isValued&&(itemSource.system.value.value=value),actor.canUserModify(game.user,"update")?[await actor.increaseCondition(itemSource.system.slug,{value})??[]].flat():(ui.notifications.error("PF2E.ErrorMessage.NoUpdatePermission",{localize:!0}),[])}else if(itemIsOfType(itemSource,"affliction","effect")){const{level,value,context}=data;typeof level=="number"&&level>=0&&(itemSource.system.level.value=Math.floor(level)),itemSource.type==="effect"&&itemSource.system.badge?.type==="counter"&&typeof value=="number"&&(itemSource.system.badge.value=value),itemSource.system.context=context??null;const originItem=fromUuidSync(context?.origin.item??"");if(itemSource.system.traits?.value.length===0&&originItem instanceof SpellPF2e){const effectTraits2=originItem.system.traits.value.filter(t2=>t2 in CONFIG.PF2E.effectTraits);itemSource.system.traits.value.push(...effectTraits2)}}else if(item.isOfType("physical")&&actor.isOfType("character")&&craftingTab){const actorFormulas=foundry.utils.deepClone(actor.system.crafting.formulas);return actorFormulas.some(f=>f.uuid===item.uuid)||(actorFormulas.push({uuid:item.uuid}),await actor.update({"system.crafting.formulas":actorFormulas})),[item]}if(item.isOfType("physical")&&itemIsOfType(itemSource,"physical")){const containerId=htmlClosest(event2.target,"li[data-is-container]")?.dataset.itemId?.trim()||null;this.actor.itemTypes.backpack.find(container2=>container2.id===containerId)?(itemSource.system.containerId=containerId,itemSource.system.equipped.carryType="stowed"):itemSource.system.equipped.carryType="worn"}return this._onDropItemCreate(new Item.implementation(itemSource).clone().toObject())}async _onDropFolder(_event,data){if(!(this.actor.isOwner&&data.documentName==="Item"))return[];const folder=await Folder.fromDropData(data);if(!folder)return[];const itemSources=[folder,...folder.getSubfolders()].flatMap(f=>f.contents).map(i=>i.toObject());return this._onDropItemCreate(itemSources)}_onChangeTab(event2,tabs2,active){super._onChangeTab(event2,tabs2,active);for(const tab of htmlQueryAll(tabs2._nav,"[data-tab][role=tab]:not([aria-selected=undefined])"))tab.setAttribute("aria-selected",String(tab.dataset.tab===active))}async moveItemBetweenActors(event2,item,recipient){const sourceActor=item.actor;if(!sourceActor||!recipient)throw ErrorPF2e("Unexpected missing actor(s)");const containerId=htmlClosest(event2.target,"[data-is-container]")?.dataset.itemId?.trim(),stackable=!!recipient.inventory.findStackableItem(item._source,{containerId}),mode=sourceActor.isOfType("loot")&&sourceActor.isMerchant?"purchase":"move";if(mode==="purchase"&&item.isOfType("backpack")&&item.contents.size){ui.notifications.error("PF2E.ErrorMessage.CantPurchaseContainerWithItems",{localize:!0});return}const result=await ItemTransferDialog.wait({item,recipient,lockStack:!stackable,mode});if(!result)return;const[resultMode,quantity]=result.mode==="credits"&&result.quantity>=item.system.price.value.credits?["move",1]:[result.mode,result.quantity];resultMode==="credits"?transferCredits({targetActor:recipient,item,quantity}):result&&sourceActor.transferItemToActor(recipient,item,quantity,containerId,result.newStack,result.mode==="purchase")}#onClickCreateItem(anchor){const dataset={...anchor.dataset},itemType=[dataset.type??dataset.types?.split(",")].flat().filter(e$1).find(t2=>t2!=="shield");if(!objectHasKey(CONFIG.PF2E.Item.documentClasses,itemType))throw ErrorPF2e("Unrecognized item type: types");if(itemType==="spell")return onClickCreateSpell(this.actor,dataset);const itemSource=(()=>{switch(itemType){case"action":{const{actionType}=dataset;if(!objectHasKey(CONFIG.PF2E.actionTypes,actionType))throw ErrorPF2e(`Action type not recognized: ${actionType}`);const name2=game.i18n.localize(`PF2E.ActionType${actionType.capitalize()}`);return{type:itemType,name:name2,system:{actionType:{value:actionType}}}}case"melee":{const name2=game.i18n.localize(`PF2E.NewPlaceholders.${itemType.capitalize()}`);return{type:itemType,name:name2}}case"lore":{const name2=this.actor.type==="npc"?game.i18n.localize("PF2E.SkillLabel"):game.i18n.localize("PF2E.NewPlaceholders.Lore");return{type:itemType,name:name2}}default:{if(!setHasElement(PHYSICAL_ITEM_TYPES,itemType))throw ErrorPF2e(`Unsupported item type: ${itemType}`);return{name:game.i18n.localize(`PF2E.NewPlaceholders.${itemType.capitalize()}`),type:itemType}}}})();if(itemSource){if(dataset.traits){const traits=dataset.traits?.split(",")??[];itemSource.system=foundry.utils.mergeObject(itemSource.system??{},{traits:{value:traits}})}this.actor.createEmbeddedDocuments("Item",[itemSource])}}async#onClickSellAllTreasure(){const content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/sell-all-treasure-dialog.hbs");new foundry.appv1.api.Dialog({title:game.i18n.localize("PF2E.SellAllTreasureTitle"),content,buttons:{yes:{icon:fontAwesomeIcon("check").outerHTML,label:"Yes",callback:__name2(async()=>this.actor.inventory.sellAllTreasure(),"callback")},cancel:{icon:fontAwesomeIcon("times").outerHTML,label:"Cancel"}},default:"cancel"}).render(!0)}openTagSelector(anchor,options={}){const selectorType=anchor.dataset.tagSelector;if(!tupleHasValue(TAG_SELECTOR_TYPES,selectorType))throw ErrorPF2e(`Unrecognized tag selector type "${selectorType}"`);if(selectorType==="basic"){const objectProperty=anchor.dataset.property??"",title=anchor.dataset.title??"",configTypes=(anchor.dataset.configTypes??"").split(",").map(type2=>type2.trim()).filter(tag=>tupleHasValue(SELECTABLE_TAG_FIELDS,tag));this.tagSelector("basic",{...options,objectProperty,configTypes,title})}else this.tagSelector(selectorType,options)}tagSelector(selectorType,options){if(selectorType==="basic"&&options?.objectProperty)new TagSelectorBasic(this.object,options).render(!0);else{if(selectorType==="basic")throw ErrorPF2e("Insufficient options provided to render basic tag selector");{const TagSelector={languages:LanguageSelector,senses:SenseSelector,"speed-types":SpeedSelector}[selectorType];new TagSelector(this.object,options).render(!0)}}}openTab(name2){this._tabs[0].activate(name2)}async _renderInner(data,options){return this.itemRenderer.saveAndRestoreState(()=>super._renderInner(data,options))}async _render(force,options){const focused=htmlQuery(this.element.get(0),":focus");if(await maintainFocusInRender(this,()=>super._render(force,options)),focused&&(!("name"in focused)||!focused.name)){const element=this.element.get(0),tagName=focused.tagName;if(focused.dataset.property){const property=focused.dataset.property;htmlQuery(element,`${tagName}[data-property="${property}"]`)?.focus()}else if(focused.dataset.resource){const resource=focused.dataset.resource;htmlQuery(element,`${tagName}[data-resource="${resource}"]`)?.focus()}else if(focused.dataset.itemProperty&&focused.dataset.itemId){const{itemProperty,itemId}=focused.dataset;htmlQuery(element,`${tagName}[data-item-id="${itemId}"][data-item-property="${itemProperty}"]`)?.focus()}else focused.dataset.refocus&&htmlQuery(element,`${tagName}[data-refocus="${focused.dataset.refocus}"]`)?.focus()}options?.tab&&this.openTab(options.tab)}_configureProseMirrorPlugins(name2,options){const plugins=super._configureProseMirrorPlugins(name2,options);return plugins.menu=foundry.prosemirror.ProseMirrorMenu.build(foundry.prosemirror.defaultSchema,{destroyOnSave:options.remove,onSave:__name2(()=>this.saveEditor(name2,options),"onSave"),compact:!0}),plugins}}const actorTypes$1=[...ACTOR_TYPES];function getSelectedActors(options={}){const{include=actorTypes$1,exclude=[],assignedFallback=!1}=options,actors=n(game.user.getActiveTokens().flatMap(t2=>t2.actor&&(include.length===0||t2.actor.isOfType(...include))&&(exclude.length===0||!t2.actor.isOfType(...exclude))?t2.actor:[])),assigned=game.user.character;return actors.length>0||!assignedFallback||!assigned?actors:(include.length===0||assigned.isOfType(...include))&&(exclude.length===0||!assigned.isOfType(...exclude))?[assigned]:[]}__name(getSelectedActors,"getSelectedActors"),__name2(getSelectedActors,"getSelectedActors");class ActionMacroHelpers{static{__name(this,"ActionMacroHelpers")}static{__name2(this,"ActionMacroHelpers")}static resolveStat(stat,actor){switch(stat){case"perception":return{checkType:"perception-check",property:"perception",stat,subtitle:"PF2E.ActionsCheck.perception"};case"unarmed":return{checkType:"attack-roll",property:"unarmed",stat,subtitle:"PF2E.ActionsCheck.unarmed"};default:{const property=`skills.${sluggify(stat)}`,subtitle=`PF2E.ActionsCheck.${stat}`;return{checkType:"skill-check",property,stat,subtitle:game.i18n.has(subtitle)?subtitle:game.i18n.format("PF2E.ActionsCheck.x",{type:actor.skills?.[stat]?.label??null})}}}}static defaultCheckContext(options,data){const{checkType:type2,property,stat:slug,subtitle}=this.resolveStat(data.slug,options.actor),statistic=options.actor.getStatistic(data.slug)??foundry.utils.getProperty(options.actor,property);if(!statistic){const{actor}=options,message=`Actor ${actor.name} (${actor.id}) does not have a statistic for ${slug}.`;throw new CheckContextError(message,actor,slug)}const{item,rollOptions:contextualRollOptions}=options.buildContext({actor:options.actor,item:data.item,rollOptions:[...data.rollOptions],target:options.target}),modifiers=(data.modifiers??[]).map(modifier=>modifier.clone()).map(modifier=>{const adjustments=extractModifierAdjustments(options.actor.synthetics.modifierAdjustments,[type2,slug],modifier.slug);return modifier.adjustments=(modifier.adjustments??[]).concat(adjustments),modifier});return{item,modifiers,rollOptions:contextualRollOptions,slug,statistic,subtitle,type:type2}}static note(selector,translationPrefix,outcome,translationKey){const outcomes=game.pf2e.settings.metagame.results?[outcome]:[];return new RollNotePF2e({selector,text:game.i18n.localize(translationKey??`${translationPrefix}.Notes.${outcome}`),outcome:outcomes})}static outcomesNote(selector,translationKey,outcomes){const visibleOutcomes=game.pf2e.settings.metagame.results?outcomes:[];return new RollNotePF2e({selector,text:game.i18n.localize(translationKey),outcome:visibleOutcomes})}static async simpleRollActionCheck(options){const rollers=[];if(Array.isArray(options.actors)?rollers.push(...options.actors):options.actors?rollers.push(options.actors):rollers.push(...getSelectedActors({exclude:["loot","party"],assignedFallback:!0})),rollers.length===0)throw new Error(game.i18n.localize("PF2E.ActionsWarning.NoActor"));const targetData=options.target?.()??this.target();for(const actor of rollers)try{const selfToken=actor.getActiveTokens(!1,!0).shift()??null,{item:weapon,modifiers=[],rollOptions:combinedOptions,statistic,subtitle,type:type2}=await options.checkContext({actor,buildContext:__name2(args=>{const combinedOptions2=[args.rollOptions,options.traits].flat().filter(e$1);return combinedOptions2.push(...args.item?.getRollOptions("item")??[]),{item:args.item,rollOptions:combinedOptions2.sort(),target:args.target}},"buildContext"),target:targetData.actor}),header=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:options.actionGlyph,subtitle,title:options.title}),actionTraits2=(options.traits??[]).filter(t2=>t2 in CONFIG.PF2E.actionTraits),notes=options.extraNotes?.(statistic.slug)??[],label=await options.content?.(header)??header;if(statistic instanceof Statistic){const dc=this.#resolveCheckDC({unresolvedDC:options.difficultyClass});await statistic.roll({...eventToRollParams(options.event,{type:"check"}),token:selfToken,label,title:label,dc,extraRollNotes:notes,extraRollOptions:combinedOptions,modifiers,target:targetData.actor,traits:actionTraits2,createMessage:options.createMessage,callback:__name2((roll,outcome,message)=>{options.callback?.({actor,message,outcome,roll})},"callback")})}else{const check=new CheckModifier(label,statistic,modifiers),dc=this.#resolveCheckDC({target:targetData.actor,unresolvedDC:options.difficultyClass,fully:!0}),finalOptions=new Set(combinedOptions);ensureProficiencyOption(finalOptions,statistic.rank??-1),check.calculateTotal(finalOptions);const selfActor=actor.getContextualClone(combinedOptions.filter(o=>o.startsWith("self:"))),distance=(()=>{const reach=selfActor.isOfType("creature")&&weapon?.isOfType("weapon")?selfActor.getReach({action:"attack",weapon})??null:null;return selfToken?.object&&targetData?.token?.object?selfToken.object.distanceTo(targetData.token.object,{reach}):null})(),rangeIncrement=weapon?.isOfType("weapon")&&typeof distance=="number"?getRangeIncrement(weapon,distance):null,domains=["all",type2,statistic.slug],rollOrigin={actor:selfActor,token:selfToken,item:weapon??null,self:!0,statistic,modifiers:[]},rollTarget=targetData.token&&targetData.actor&&typeof distance=="number"?{actor:targetData.actor,token:targetData.token,statistic:null,self:!1,item:null,distance,rangeIncrement}:null,substitutions=extractRollSubstitutions(actor.synthetics.rollSubstitutions,domains,finalOptions),dosAdjustments=extractDegreeOfSuccessAdjustments(actor.synthetics,domains);await Check.roll(check,{actor:selfActor,token:selfToken,item:weapon,createMessage:options.createMessage,origin:rollOrigin,target:rollTarget,dc,type:type2,options:finalOptions,notes:[...notes,...statistic.notes??[]],dosAdjustments,substitutions,traits:actionTraits2,title:label},options.event,(roll,outcome,message)=>{options.callback?.({actor,message,outcome,roll})})}}catch(cce){if(cce instanceof CheckContextError){const message=game.i18n.format("PF2E.ActionsWarning.NoStatistic",{id:cce.actor.id,name:cce.actor.name,statistic:cce.slug});ui.notifications.error(message);continue}throw cce}}static target(){const target=Array.from(game.user.targets).filter(t2=>t2.actor?.isOfType("creature")).shift()?.document??null,targetActor=target?.actor??null;return{token:target,actor:targetActor}}static getWeaponPotencyModifier(item,selector){const slug="potency";return AutomaticBonusProgression$1.isEnabled(item.actor)?new Modifier({slug,type:"potency",label:"PF2E.AutomaticBonusProgression.attackPotency",modifier:item.actor.synthetics.weaponPotency["strike-attack-roll"]?.[0]?.bonus??0,adjustments:extractModifierAdjustments(item.actor.synthetics.modifierAdjustments,[selector],slug)}):item.system.runes.potency>0?new Modifier({slug,type:"item",label:"PF2E.Item.Weapon.Rune.Potency",modifier:item.system.runes.potency,adjustments:extractModifierAdjustments(item.actor.synthetics.modifierAdjustments,[selector],slug)}):null}static#getApplicableEquippedWeapons(actor,trait){return actor.isOfType("character")?actor.system.actions.flatMap(s=>s.ready&&s.item.traits.has(trait)?s.item:[]):actor.itemTypes.weapon.filter(w=>w.isEquipped&&w.traits.has(trait))}static getBestEquippedItemForAction(actor,traits,selector){const items=traits.flatMap(t2=>ActionMacroHelpers.#getApplicableEquippedWeapons(actor,t2));return items.length===0?null:items.reduce((max,item)=>(ActionMacroHelpers.getWeaponPotencyModifier(item,selector)?.value??0)>(ActionMacroHelpers.getWeaponPotencyModifier(max,selector)?.value??0)?item:max,items[0])??null}static getSimpleCheckLabel(slug){switch(slug){case"flat":return game.i18n.localize("PF2E.FlatCheck");case"perception":return game.i18n.localize("PF2E.PerceptionLabel");case"unarmed":return game.i18n.localize("PF2E.TraitUnarmed");case"lore":return game.i18n.localize("PF2E.SkillLore");default:{const saves=CONFIG.PF2E.saves,skills=CONFIG.PF2E.skills,label=saves[slug]??skills[slug]?.label;return label?game.i18n.localize(label):null}}}static#resolveCheckDC({unresolvedDC=null,target=null,fully=!1}){return typeof unresolvedDC=="string"?fully?target?.getStatistic(unresolvedDC)?.dc??null:{slug:unresolvedDC}:typeof unresolvedDC=="function"?unresolvedDC(target):unresolvedDC}}class CheckContextError extends Error{static{__name(this,"CheckContextError")}static{__name2(this,"CheckContextError")}constructor(message,actor,slug){super(message),this.actor=actor,this.slug=slug}}class DamagePF2e{static{__name(this,"DamagePF2e")}static{__name2(this,"DamagePF2e")}static async roll(data,context,callback){const outcome=context.outcome??null;context.createMessage??=!0,context.options.has("secret")&&(context.secret=!0),context.secret&&(context.rollMode??=game.user.isGM?"gmroll":"blindroll"),context.rollMode=objectHasKey(CONFIG.Dice.rollModes,context.rollMode)?context.rollMode:game.settings.get("core","rollMode");const subtitle=outcome?context.sourceType==="attack"?game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${outcome}`):game.i18n.localize(`PF2E.Check.Result.Degree.Check.${outcome}`):null;let flavor=data.name.startsWith("<h4")?data.name:data.name||subtitle?await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{title:data.name,outcome,subtitle}):"";if(context.traits){const item2=context.self?.item,toTags=__name2((slugs,{labels={},descriptions={},cssClass,dataAttr})=>slugs.map(s=>traitSlugToObject(s,labels,{descriptions})).sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang)).map(tag=>createHTMLElement("span",{classes:["tag",cssClass].filter(e$1),children:[tag.label],dataset:{tooltip:tag.description,[dataAttr]:tag.name}}).outerHTML).join(""),"toTags"),traits=toTags(context.traits,{labels:CONFIG.PF2E.actionTraits,descriptions:CONFIG.PF2E.traitsDescriptions,cssClass:null,dataAttr:"trait"}),itemTraits=item2?.isOfType("weapon","melee")?toTags(Array.from(item2.traits).filter(t2=>!(t2 in CONFIG.PF2E.materialDamageEffects)),{labels:item2.isOfType("spell")?CONFIG.PF2E.spellTraits:CONFIG.PF2E.npcAttackTraits,descriptions:CONFIG.PF2E.traitsDescriptions,cssClass:"tag_alt",dataAttr:"trait"}):"",runeTags=(()=>{const hasGhostTouch=context.options.has("item:rune:property:ghost-touch"),hasAstral=context.options.has("item:rune:property:astral")||context.options.has("item:rune:property:greater-astral");return(hasGhostTouch||hasAstral)&&context.options.has("target:trait:incorporeal")?toTags(["ghost-touch"],{labels:{"ghost-touch":"PF2E.WeaponPropertyRune.ghostTouch.Name"},descriptions:{"ghost-touch":"PF2E.WeaponPropertyRune.ghostTouch.Note"},cssClass:"ghost-touch",dataAttr:"slug"}):""})(),properties=(()=>{const range=item2?.isOfType("action","melee","weapon")?item2.range:null,label=createActionRangeLabel(range);if(label&&(range?.increment||range?.max)){const slug=range.increment?`range-increment-${range.increment}`:`range-${range.max}`;return toTags([slug],{labels:{[slug]:label},descriptions:{[slug]:"PF2E.Item.Weapon.RangeIncrementN.Hint"},cssClass:"tag_secondary",dataAttr:"slug"})}else return""})(),materialEffects=toTags(data.materials,{labels:CONFIG.PF2E.preciousMaterials,descriptions:CONFIG.PF2E.traitsDescriptions,cssClass:"tag_material",dataAttr:"material"}),otherTags=[itemTraits,properties,materialEffects,runeTags].join(""),tagsElem=createHTMLElement("div",{classes:["tags"],dataset:{tooltipClass:"pf2e"}});tagsElem.innerHTML=otherTags.length>0?`${traits}<hr class="vr" />${otherTags}`:traits,flavor+=tagsElem.outerHTML,flavor+=`
<hr />`}const showBreakdown=data.damage.roll?.options.showBreakdown??(game.pf2e.settings.metagame.breakdowns||!!context.self?.actor?.hasPlayerOwner),breakdownTags=(Array.isArray(data.damage.breakdown)?data.damage.breakdown:data.damage.breakdown[outcome??"success"]).map(b=>createHTMLElement("span",{classes:["tag","tag_transparent"],dataset:{visibility:showBreakdown?null:"gm"},children:[b]}));flavor+=breakdownTags.length>0?createHTMLElement("div",{classes:["tags","modifiers"],children:breakdownTags}).outerHTML:"";const roll=await(()=>{const damage=data.damage,allowInteractive=context.rollMode!=="blindroll";if(damage.roll)return damage.roll.evaluate({allowInteractive});const formula=foundry.utils.deepClone(damage.formula[outcome??"success"]);if(!formula)return ui.notifications.error(game.i18n.format("PF2E.UI.noDamageInfoForOutcome",{outcome})),null;const rollerId=game.userId,degreeOfSuccess=outcome?DEGREE_OF_SUCCESS_STRINGS.indexOf(outcome):null,critRule=degreeOfSuccess!==DEGREE_OF_SUCCESS.CRITICAL_SUCCESS?null:game.settings.get("pf2e","critRule")==="doubledamage"?"double-damage":"double-dice",options={rollerId,damage:data,degreeOfSuccess,critRule,bypass:foundry.utils.deepClone(damage.bypass)??{immunity:{ignore:[],downgrade:[],redirect:[]},resistance:{ignore:[],redirect:[]}},showBreakdown};return new DamageRoll(formula,{},options).evaluate({allowInteractive})})();if(roll===null)return null;const syntheticNotes=context.self?.actor?extractNotes(context.self?.actor.synthetics.rollNotes,context.domains??[]):[],contextNotes=context.notes?.map(n2=>n2 instanceof RollNotePF2e?n2:new RollNotePF2e(n2))??[],notes=[...syntheticNotes,...contextNotes].filter(n2=>(n2.outcome.length===0||outcome&&n2.outcome.includes(outcome))&&n2.predicate.test(context.options));flavor+=RollNotePF2e.notesToHTML(notes)?.outerHTML??"";const{self,target}=context,item=self?.item??null,targetFlag=target?.actor&&target.token?{actor:target.actor.uuid,token:target.token.uuid}:null,strike=(()=>{if(item?.isOfType("melee","weapon")&&item&&self?.actor?.isOfType("character","npc")){const attacks=self.actor.system.actions,attack=attacks.find(a=>a.item?.id===item.id&&a.item.slug===item.slug);if(attack)return{actor:self.actor.uuid,index:attacks.indexOf(attack),damaging:!0,name:attack.item.name,altUsage:item.isOfType("weapon")?item.altUsageType:null}}return null})(),contextFlag={type:context.type,sourceType:context.sourceType,actor:context.self?.actor?.id??null,token:context.self?.token?.id??null,target:targetFlag,domains:context.domains??[],options:Array.from(context.options).sort(),contextualOptions:{},mapIncreases:context.mapIncreases,notes:notes.map(n2=>n2.toObject()),secret:context.secret??!1,rollMode:context.rollMode,traits:context.traits??[],skipDialog:context.skipDialog??!game.user.settings.showDamageDialogs,outcome,unadjustedOutcome:context.unadjustedOutcome??null},messageData=await roll.toMessage({speaker:ChatMessagePF2e.getSpeaker({actor:self?.actor,token:self?.token}),flavor,flags:{pf2e:{context:contextFlag,target:targetFlag,modifiers:data.modifiers?.flatMap(m=>"kind"in m?m.toObject():[])??[],dice:data.modifiers?.flatMap(m=>"diceNumber"in m?m.toObject():[])??[],origin:item?.getOriginData(),strike}}},{create:!1}),splashRolls=await(async()=>{const splashInstances=roll.instances.map(i=>({damageType:i.type,total:i.componentTotal("splash")})).filter(s=>s.total>0),rolls=[];for(const splash of splashInstances){const formula=`(${splash.total}[splash])[${splash.damageType}]`,roll2=await new DamageRoll(formula).evaluate();roll2.options.splashOnly=!0,rolls.push(roll2.toJSON())}return rolls})();return context.createMessage&&(messageData.rolls.push(...splashRolls),await ChatMessagePF2e.create(messageData,{rollMode:context.rollMode})),Hooks.callAll("pf2e.damageRoll",roll),callback&&callback(roll),roll}}class DamageModifierDialog extends foundry.appv1.api.Application{static{__name(this,"DamageModifierDialog")}static{__name2(this,"DamageModifierDialog")}formulaData;context;baseDamageType;degree;#resolve;isRolled=!1;#originallyEnabled;constructor(params){super(),this.formulaData=params.formulaData,this.context=params.context,this.baseDamageType=params.formulaData.base.at(0)?.damageType??"untyped",this.degree=DEGREE_OF_SUCCESS_STRINGS.indexOf(this.context.outcome??"success"),this.#originallyEnabled={modifiers:new Set(this.formulaData.modifiers.filter(m=>m.enabled)),dice:new Set(this.formulaData.dice.filter(d=>d.enabled))}}static get defaultOptions(){return{...super.defaultOptions,template:"systems/pf2e/templates/chat/damage/damage-modifier-dialog.hbs",classes:["roll-modifiers-dialog","damage-dialog","dialog"],popOut:!0,width:440,height:"auto"}}get title(){return this.isCritical?game.i18n.localize("PF2E.Roll.Dialog.Damage.TitleCritical"):game.i18n.localize("PF2E.Roll.Dialog.Damage.Title")}get isCritical(){return this.degree===DEGREE_OF_SUCCESS.CRITICAL_SUCCESS}#getModifierIcon(object){const damageTypeIconClass=object.damageType?DAMAGE_TYPE_ICONS[object.damageType]:null,damageTypeIcon=damageTypeIconClass?fontAwesomeIcon(damageTypeIconClass):null;return(()=>{switch(object.category){case"splash":return[fontAwesomeIcon("fa-burst"),damageTypeIcon].filter(e$1);case"persistent":return object.damageType!=="bleed"?[damageTypeIcon,fontAwesomeIcon("fa-hourglass",{style:"duotone"})]:[damageTypeIcon];case"precision":return[damageTypeIcon,fontAwesomeIcon("fa-crosshairs")];default:return[damageTypeIcon]}})().map(i=>i?.outerHTML??"").join("")}#getTypeLabel(damageType,category){if(category==="precision")return game.i18n.localize("PF2E.Damage.Precision");if(!damageType)return null;const typeLabel=game.i18n.localize(CONFIG.PF2E.damageTypes[damageType]);switch(category){case"persistent":return game.i18n.format("PF2E.Damage.PersistentTooltip",{damageType:typeLabel});case"splash":return game.i18n.format("PF2E.Roll.Dialog.Damage.Splash",{damageType:typeLabel});default:return typeLabel}}async getData(){const visibleModifiers=[...this.formulaData.modifiers.entries()].filter(([_,m])=>this.isCritical||!m.critical),visibleDiceAll=[...this.formulaData.dice.entries()].filter(([_,d])=>this.isCritical||!d.critical),visibleDice=visibleDiceAll.filter(([_,d])=>!d.override||d.dieSize||d.diceNumber),baseResult=createDamageFormula({base:this.formulaData.base,modifiers:[],dice:[]}),baseRoll=new DamageRoll(baseResult.formula),baseFormulaTemplate=(await Promise.all(baseRoll.instances.map(i=>i.render()))).join(" + "),result=createDamageFormula(this.formulaData,this.degree),roll=new DamageRoll(result?.formula??"0"),formulaTemplate=(await Promise.all(roll.instances.map(i=>i.render({tooltips:!1})))).join(" + ");return{appId:this.id,baseFormula:baseFormulaTemplate,modifiers:visibleModifiers.map(([idx,m])=>({idx,label:m.label,category:m.category,type:m.type,modifier:m.modifier,hideIfDisabled:!this.#originallyEnabled.modifiers.has(m)&&m.hideIfDisabled,damageType:m.damageType,typeLabel:this.#getTypeLabel(m.damageType,m.damageCategory),enabled:m.enabled,ignored:m.ignored,critical:m.critical,icon:this.#getModifierIcon(m)})),dice:visibleDice.map(([idx,d])=>({idx,label:d.label,category:d.category,damageType:d.damageType,typeLabel:this.#getTypeLabel(d.damageType,d.category),hideIfDisabled:!this.#originallyEnabled.dice.has(d)&&d.hideIfDisabled,diceLabel:getDamageDiceValueLabel(d),enabled:d.enabled,ignored:d.ignored,critical:d.critical,icon:this.#getModifierIcon(d)})),overrides:t$a(visibleDiceAll,n$3(args=>!!args[1].override),t(([_,d])=>d.override.diceNumber&&!d.override.dieSize?1:d.override.upgrade?2:3),t$b(([idx,d])=>({idx,label:d.label,category:d.category,damageType:d.override.damageType??d.damageType,hideIfDisabled:!this.#originallyEnabled.dice.has(d)&&d.hideIfDisabled,typeLabel:this.#getTypeLabel(d.override.damageType??d.damageType,d.category),diceLabel:getDamageDiceOverrideLabel(d),enabled:d.enabled,ignored:d.ignored,critical:d.critical,icon:this.#getModifierIcon({damageType:d.override.damageType??d.damageType,category:d.category})}))),isCritical:this.isCritical,damageTypes:sortStringRecord(CONFIG.PF2E.damageTypes),damageSubtypes:sortStringRecord(t$3(CONFIG.PF2E.damageCategories,DAMAGE_CATEGORIES_UNIQUE)),rollModes:CONFIG.Dice.rollModes,rollMode:this.context?.rollMode??game.settings.get("core","rollMode"),showDamageDialogs:game.user.settings.showDamageDialogs,formula:formulaTemplate}}activateListeners($html){const html2=$html[0];htmlQuery(html2,"button.roll")?.addEventListener("click",()=>{this.isRolled=!0,this.close()});for(const checkbox of htmlQueryAll(html2,".modifier-container input[type=checkbox]"))checkbox.addEventListener("click",()=>{const{dice,modifiers}=this.formulaData,modIndex=Number(checkbox.dataset.modifierIndex),dieIndex=Number(checkbox.dataset.diceIndex);Number.isNaN(modIndex)?Number.isNaN(dieIndex)||(dice[dieIndex].ignored=!checkbox.checked,dice[dieIndex].enabled=checkbox.checked):(modifiers[modIndex].ignored=!checkbox.checked,this.#applyStackingRules()),this.render()});const categorySelect=htmlQuery(html2,"select.add-dice-category"),damageTypeSelect=htmlQuery(html2,"select.add-dice-type");categorySelect?.addEventListener("change",()=>{damageTypeSelect&&(categorySelect.value==="precision"?(damageTypeSelect.value="",damageTypeSelect.disabled=!0):(damageTypeSelect.disabled=!1,damageTypeSelect.value=damageTypeSelect.firstElementChild?.value??"acid"))});const addModifierButton=htmlQuery(html2,"button.add-modifier");addModifierButton?.addEventListener("click",()=>{const parent=addModifierButton.parentElement,value=Number(parent.querySelector(".add-modifier-value")?.value||1),type2=String(parent.querySelector(".add-modifier-type")?.value),damageType=parent.querySelector(".add-modifier-damage-type")?.value??null,category=parent.querySelector(".add-modifier-category")?.value||null,errors=[];if(Number.isNaN(value)?errors.push("Modifier value must be a number."):value===0&&errors.push("Modifier value must not be zero."),!setHasElement(MODIFIER_TYPES,type2))throw ErrorPF2e("Unexpected invalid modifier type");const label=String(parent.querySelector(".add-modifier-name")?.value).trim()||game.i18n.localize(value<0?`PF2E.PenaltyLabel.${type2}`:`PF2E.BonusLabel.${type2}`);errors.length>0?ui.notifications.error(errors.join(" ")):(this.formulaData.modifiers.push(new Modifier({label,modifier:value,type:type2,damageType,damageCategory:category})),this.#applyStackingRules(),this.render())});const addDiceButton=htmlQuery(html2,"button.add-dice");addDiceButton?.addEventListener("click",()=>{const parent=addDiceButton.parentElement,count=Number(parent.querySelector(".add-dice-count")?.value||1),faces=parent.querySelector(".add-dice-faces")?.value??"d4",category=parent.querySelector(".add-dice-category")?.value||null,type2=parent.querySelector(".add-dice-type")?.value||null;if(Number.isNaN(count)){ui.notifications.error("Damage dice count must be a number.");return}else if(count<1){ui.notifications.error("Damage dice count must be greater than zero.");return}if(!tupleHasValue(["persistent","precision","splash",null],category)){ui.notifications.error(`Unkown damage category: ${category}.`);return}const label=String(parent.querySelector(".add-dice-name")?.value).trim()||game.i18n.format("PF2E.Roll.Dialog.Damage.ExtraDice"),slug=sluggify(`${label}-${type2}`);this.formulaData.dice.push(new DamageDicePF2e({label,category,diceNumber:count,dieSize:faces,damageType:type2,slug,selector:"damage"})),this.render()});const rollModeInput=htmlQuery(html2,"select[name=rollmode]");rollModeInput?.addEventListener("change",()=>{const rollMode=rollModeInput.value;if(!tupleHasValue(Object.values(CONST.DICE_ROLL_MODES),rollMode))throw ErrorPF2e("Unexpected roll mode");this.context.rollMode=rollMode});const toggle=htmlQuery(html2,"input[data-action=change-show-default]");toggle?.addEventListener("click",async()=>{await game.user.update({"flags.pf2e.settings.showDamageDialogs":toggle.checked})})}#applyStackingRules(){applyStackingRules(this.formulaData.modifiers.filter(m=>m.category!=="persistent")),applyStackingRules(this.formulaData.modifiers.filter(m=>m.category==="persistent"))}async resolve(){return this.render(!0),new Promise(resolve=>{this.#resolve=resolve})}async close(options){this.#resolve?.(this.isRolled),super.close(options)}_injectHTML($html){super._injectHTML($html),$html[0]?.querySelector("button.roll")?.focus()}}class TextEditorPF2e extends foundry.applications.ux.TextEditor{static{__name(this,"TextEditorPF2e")}static{__name2(this,"TextEditorPF2e")}static async enrichHTML(content,options={}){options.secrets??=game.user.isGM,options.processVisibility??=!0,content=content?.replace(/^\s*<p>@Localize\[([\w.]+)\]<\/p>\s*$/,"@Localize[$1]")??"";const enriched=await super.enrichHTML(content,options);return options.processVisibility?TextEditorPF2e.processUserVisibility(enriched,options):enriched}static async _createInlineRoll(match,rollData,options={}){const anchor=await super._createInlineRoll(match,rollData,options),formula=anchor?.dataset.formula,rollModes=["roll",...Object.values(CONST.DICE_ROLL_MODES)];if(!formula||!rollModes.includes(anchor.dataset.mode??""))return anchor;const roll=(()=>{try{return new DamageRoll(formula)}catch{return null}})();if(!roll||!looksLikeDamageRoll(roll))return anchor;const icon=damageDiceIcon(roll),label=match[4]&&match[4].length>0?match[4]:roll.formula;return anchor.innerHTML=`${icon.outerHTML}${label}`,anchor.dataset.tooltip=roll.formula,anchor.dataset.damageRoll="",roll.instances.length>0&&roll.instances.every(i=>i.persistent)&&(anchor.draggable=!0,anchor.dataset.persistent=""),anchor}static async _onClickInlineRoll(event2){const anchor=htmlClosest(event2.target,"a");if(!anchor?.dataset.formula||!("damageRoll"in anchor.dataset))return super._onClickInlineRoll(event2);const sheetElem=htmlClosest(anchor,".sheet"),messageElem=htmlClosest(anchor,"li.chat-message"),app=ui.windows[Number(sheetElem?.dataset.appid)],message=game.messages.get(messageElem?.dataset.messageId??""),[actor,rollData]=(()=>{if(message?.speakerActor)return[message.speakerActor,message.getRollData()];if(app instanceof ActorSheetPF2e){const itemId=anchor.dataset.itemId;return[app.actor,app.actor.items.get(itemId)?.getRollData()??app.actor.getRollData()]}if(app instanceof ItemSheetPF2e)return[app.actor,app.item.getRollData()];const itemUuid=htmlClosest(anchor,"[data-item-uuid]")?.dataset.itemUuid,itemByUUID=itemUuid&&!itemUuid.startsWith("Compendium.")?fromUuidSync(itemUuid):null;return itemByUUID instanceof ItemPF2e?[itemByUUID.actor,itemByUUID.getRollData()]:[null,{}]})(),options=anchor.dataset.flavor?{flavor:anchor.dataset.flavor}:{},speaker=ChatMessagePF2e.getSpeaker({actor}),rollMode=objectHasKey(CONFIG.Dice.rollModes,anchor.dataset.mode)?anchor.dataset.mode:"roll",baseFormula=anchor.dataset.baseFormula;if(baseFormula){const item=rollData.item instanceof ItemPF2e?rollData.item:null,traits=splitListString(anchor.dataset.traits??""),overrideTraits="overrideTraits"in anchor.dataset,immutable="immutable"in anchor.dataset,rollOptions=splitListString(anchor.dataset.rollOptions??""),domains=splitListString(anchor.dataset.domains??""),extraRollOptions=n([...traits,...rollOptions]).filter(e$1),args=await augmentInlineDamageRoll(baseFormula,{...eventToRollParams(event2,{type:"damage"}),actor,item,domains,traits,overrideTraits,name:anchor.dataset.name,immutable,extraRollOptions});if(args){const subtitle=(()=>{if(anchor.dataset.name||overrideTraits)return null;const damageKinds=args.template.damage.roll.kinds,locKey=damageKinds.has("damage")&&!damageKinds.has("healing")?"Damage":damageKinds.has("healing")&&!damageKinds.has("damage")?"Healing":"Both";return game.i18n.localize(`PF2E.Damage.Kind.${locKey}.Roll.Noun`)})(),name2=subtitle&&item?.isOfType("action","feat")&&item.actionCost?await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:getActionGlyph(item.actionCost),subtitle,title:item.name}):anchor.dataset.name??item?.name??"";args.template.name=game.i18n.localize(name2),await DamagePF2e.roll(args.template,args.context)}return}const roll=new DamageRoll(anchor.dataset.formula,rollData,options),flavor=roll.options.flavor?roll.options.flavor:void 0;return roll.toMessage({speaker,flavor},{rollMode})}static processUserVisibility(content,options){const html2=createHTMLElement("div",{innerHTML:content}),document2=resolveRollData(options.rollData).actor??options.relativeTo;return UserVisibilityPF2e.process(html2,{document:document2}),html2.innerHTML}static async enrichString(data,options={}){if(data.length<4)return null;const rollData=resolveRollData(options.rollData),item=rollData.item??null,[_match,inlineType,paramString,inlineLabel]=data;switch(inlineType){case"act":return this.#createAction(data.groups?.slug??"",data.groups?.options??"",data.groups?.label);case"Check":{const actor=rollData.actor??item?.actor??null;return this.#createCheck({paramString,inlineLabel,item,actor})}case"Damage":return this.#createDamageRoll({paramString,rollData,inlineLabel});case"Localize":return this.#localize(paramString,options);case"Template":return this.#createTemplate(paramString,inlineLabel,item);default:return null}}static convertXMLNode(html2,name2,{visible,visibility,whose,tooltip,classes}){const node=html2.querySelector(name2);if(!node)return null;const span=document.createElement("span"),{dataset,classList}=span;if(typeof visible=="boolean"&&(visibility=visible?"all":"gm"),visibility&&visibility!=="all"&&(dataset.visibility=visibility),whose&&(dataset.whose=whose),tooltip&&(dataset.tooltip=tooltip.trim()),classes)for(const cssClass of classes)classList.add(cssClass);return span.append(...Array.from(node.childNodes)),node.replaceWith(span),span}static async#localize(paramString,options){const content=game.i18n.localize(paramString);if(content===paramString)return ui.notifications.error(`Failed to localize ${paramString}!`),null;const result=document.createElement("span");return result.innerHTML=await TextEditorPF2e.enrichHTML(content,options),result}static#createTemplate(paramString,label,item){const params=this.#parseInlineParams(paramString,{first:"type"});if(!params)return null;if(!params.type)ui.notifications.error(game.i18n.localize("PF2E.InlineTemplateErrors.TypeMissing"));else if(params.distance)if(tupleHasValue(EFFECT_AREA_SHAPES,params.type)){if(isNaN(+params.distance))return ui.notifications.error(game.i18n.format("PF2E.InlineTemplateErrors.DistanceNoNumber",{distance:params.distance})),null;if(params.width&&isNaN(+params.width))return ui.notifications.error(game.i18n.format("PF2E.InlineTemplateErrors.WidthNoNumber",{width:params.width})),null;{params.traits||=item?.system.traits.value?.toString()??"",params.itemUuid||=item?.uuid??"",label||(label=game.i18n.format("PF2E.TemplateLabel",{size:params.distance,unit:game.i18n.localize("PF2E.Foot.Label"),shape:game.i18n.localize(`PF2E.Area.Shape.${params.type}`)}));const html2=document.createElement("span");return html2.innerHTML=label,html2.setAttribute("data-pf2-effect-area",params.type),html2.setAttribute("data-pf2-distance",params.distance),params.traits!==""&&html2.setAttribute("data-pf2-traits",params.traits),params.type==="line"&&html2.setAttribute("data-pf2-width",params.width??"5"),["cone","line"].includes(params.type)&&(html2.setAttribute("data-tooltip","PF2E.Item.Spell.MeasuredTemplate.PlacementTooltip"),html2.setAttribute("data-tooltip-class","pf2e")),params.itemUuid!==""&&html2.setAttribute("data-item-uuid",params.itemUuid),html2}}else return ui.notifications.error(game.i18n.format("PF2E.InlineTemplateErrors.TypeUnsupported",{type:params.type})),null;else return ui.notifications.error(game.i18n.localize("PF2E.InlineTemplateErrors.DistanceMissing")),null;return null}static#parseInlineParams(paramString,options={}){return splitListString(paramString,{delimiter:"|"}).reduce((result2,part,idx)=>{if(idx===0&&options.first&&!part.includes(":"))return result2[options.first]=part.trim(),result2;const colonIdx=part.indexOf(":"),portions=colonIdx>=0?[part.slice(0,colonIdx),part.slice(colonIdx+1)]:[part,""];return result2[portions[0]]=portions[1],result2},{})}static#invalidInlineAction(classes,icons,reason){const element=document.createElement("a");if(element.classList.add("content-link","broken",...classes),Array.isArray(icons)){const stack=Object.assign(document.createElement("span"),{className:"fa-stack"});for(const icon of icons)stack.appendChild(Object.assign(document.createElement("i"),{className:`${icon} fa-stack-1x`}));element.appendChild(stack)}else element.appendChild(Object.assign(document.createElement("i"),{className:`${icons}`}));return element.appendChild(document.createTextNode(reason)),element}static#createAction(slug,options,label){const action2=game.pf2e.actions.get(slug);if(!action2)return console.warn("Unable to resolve action",slug),this.#invalidInlineAction(["unresolvable-action"],"fa-solid fa-link-slash",game.i18n.format("PF2E.InlineAction.Warning.UnresolvableAction",{slug}));const params=splitListString(options,{delimiter:/\s+/}).reduce((result,option)=>{const[key,value]=option.split("=").map(s=>s.trim());return result[key]=value,result},{}),dc=params["difficulty-class"]||params.dc;if(dc&&Number.isNumeric(dc)&&!Number.isInteger(Number(dc)))return console.warn("Numeric DC",dc,"is not an integer for action",slug),this.#invalidInlineAction([],["fa-solid fa-slash","fa-solid fa-person-running"],game.i18n.format("PF2E.InlineAction.Warning.InvalidAction",{slug}));const element=document.createElement("span");element.dataset.pf2Action=slug;const glyph=getActionGlyph(action2.cost??null);glyph&&(element.dataset.pf2Glyph=glyph);const aliases={"difficulty-class":"dc","roll-options":"options",stat:"skill",statistic:"skill"};for(const[alias,value]of Object.entries(params)){const key=aliases[alias]??alias,attribute=sluggify(`pf2-${key}`,{camel:"dromedary"});element.dataset[attribute]=value}const variant=action2.variants.get(params.variant?.trim()??""),text2=document.createElement("span"),trimmedLabel=label?.trim();text2.innerText=trimmedLabel||(variant?.name?`${game.i18n.localize(action2.name)} - ${game.i18n.localize(variant.name)}`:game.i18n.localize(action2.name)),element.appendChild(text2);const visibility=(params["show-dc"]||(game.pf2e.settings.metagame.dcs?"all":"gm")).trim().toLowerCase(),showDC=visibility==="all"&&game.pf2e.settings.metagame.dcs||["all","gm"].includes(visibility)&&game.user.isGM,statistic=(params.statistic||params.stat||params.skill)?.trim();if(dc&&showDC||statistic){element.appendChild(document.createTextNode(" "));const details=document.createElement("span");if(dc&&showDC)if(Number.isNumeric(dc))if(statistic){const span=createHTMLElement("span",{dataset:{visibility},children:[game.i18n.format("PF2E.InlineAction.Check.DC",{dc})]}),end=statistic?` ${ActionMacroHelpers.getSimpleCheckLabel(statistic)||statistic})`:")";details.append("(",span,end)}else details.dataset.visibility=visibility,details.innerText=`(${game.i18n.format("PF2E.InlineAction.Check.DC",{dc})})`;else{const defense=game.i18n.localize(`PF2E.Check.DC.Specific.${dc}`),text22=statistic?game.i18n.format("PF2E.InlineAction.Check.StatisticVsDefense",{defense,statistic:ActionMacroHelpers.getSimpleCheckLabel(statistic)||statistic}):game.i18n.format("PF2E.InlineAction.Check.VsDefense",{defense});details.innerText=`(${text22})`}else{const text22=ActionMacroHelpers.getSimpleCheckLabel(statistic)||statistic;details.innerText=`(${text22})`}element.appendChild(details)}const additionalTraits=splitListString(params.traits??"").filter(t2=>t2 in CONFIG.PF2E.actionTraits),traits=n([variant?.traits??action2.traits,additionalTraits].flat());return element.dataset.tooltip=traits.map(t2=>game.i18n.localize(CONFIG.PF2E.actionTraits[t2]||t2)).sort().join(", "),traits.includes("secret")&&(element.dataset.secret=""),element}static#createCheck({paramString,inlineLabel,item=null,actor=item?.actor??null}){const rawParams=this.#parseInlineParams(paramString,{first:"type"});if(!rawParams)return null;const type2=rawParams.type?.trim();if(!type2)return ui.notifications.warn(game.i18n.localize("PF2E.InlineCheck.Errors.TypeMissing")),null;const showDC=setHasElement(USER_VISIBILITIES,rawParams.showDC)?rawParams.showDC:actor?.hasPlayerOwner||actor?.isOfType("party")||game.pf2e.settings.metagame.dcs?"all":"gm",basic="basic"in rawParams,overrideTraits="overrideTraits"in rawParams,rawTraits=splitListString(rawParams.traits??"");rawParams.overrideTraits&&rawParams.overrideTraits?.trim()?.toLowerCase()!=="true"&&rawTraits.push(...splitListString(rawParams.overrideTraits));const traits=n(overrideTraits?rawTraits:[rawTraits,item?.system.traits.value??[]].flat()),rollerRole=tupleHasValue(["origin","target"],rawParams.rollerRole)?rawParams.rollerRole:tupleHasValue(SAVE_TYPES,type2)?"target":"origin",params={...rawParams,type:type2,basic,dc:rawParams.dc?.trim()||null,against:rawParams.against?.trim()||rawParams.defense?.trim()||null,rollerRole,showDC,overrideTraits,traits,immutable:"immutable"in rawParams,extraRollOptions:[...basic?["damaging-effect"]:[],...splitListString(rawParams.options??"")].filter(e$1).sort(),targetOwner:"targetOwner"in rawParams},types=splitListString(params.type,{unique:!1}),adjustments=splitListString(params.adjustment??"0",{unique:!1});for(let i=0;i<types.length;i++)adjustments[i]??="0";if(adjustments.length>types.length)return ui.notifications.warn(game.i18n.localize("PF2E.InlineCheck.Errors.AdjustmentLengthMismatch")),null;if(adjustments.some(adj=>!Number.isInteger(Math.trunc(Number(adj)))))return ui.notifications.warn(game.i18n.localize("PF2E.InlineCheck.Errors.NonIntegerAdjustment")),null;const buttons=types.map((type22,i)=>this.#createSingleCheck({actor,item,inlineLabel,params:{...params,type:type22,adjustment:adjustments[i]}}));if(buttons.length===1)return buttons[0];{const checkGroup=document.createElement("div");checkGroup.setAttribute("data-pf2-checkgroup","");for(const button of buttons){if(button===null)return null;checkGroup.hasChildNodes()&&checkGroup.appendChild(document.createElement("br")),checkGroup.appendChild(button)}return checkGroup}}static#createSingleCheck({params,item,actor,inlineLabel}){const icon=(()=>{switch(params.type){case"fortitude":return fontAwesomeIcon("heart-pulse");case"reflex":return fontAwesomeIcon("person-running");case"will":return fontAwesomeIcon("brain");case"perception":return fontAwesomeIcon("eye");default:return fontAwesomeIcon("dice-d20")}})();icon.classList.add("icon");const name2=game.i18n.localize(params.name??item?.name??params.type),localize=localizer("PF2E.InlineCheck"),label=(()=>{if(inlineLabel)return game.i18n.localize(inlineLabel);if(tupleHasValue(SAVE_TYPES,params.type)){const saveName=game.i18n.localize(CONFIG.PF2E.saves[params.type]);return params.basic?localize("BasicWithSave",{save:saveName}):saveName}return ActionMacroHelpers.getSimpleCheckLabel(params.type)??params.type.split("-").map(word=>word.slice(0,1).toUpperCase()+word.slice(1)).join(" ")})(),createLabel=__name2(content=>createHTMLElement("span",{classes:["label"],innerHTML:content}),"createLabel"),anchor=createHTMLElement("a",{classes:["inline-check"],children:[icon,createLabel(label)],dataset:{pf2Traits:params.traits.toString()||null,pf2RollOptions:params.extraRollOptions.toString()||null,pf2RepostFlavor:name2,pf2ShowDc:params.showDC==="all"?null:params.showDC,pf2Label:localize("DCWithName",{name:name2}),pf2Adjustment:Number(params.adjustment)||null,pf2Roller:params.roller||null,targetOwner:params.targetOwner,pf2Check:sluggify(params.type),against:params.against,rollerRole:params.rollerRole}});if(params.against&&params.dc&&(anchor.dataset.tooltip=localize("Invalid",{message:localize("Errors.DCAndDefense")}),anchor.dataset.invalid=""),item?.uuid&&(anchor.dataset.itemUuid=item.uuid),params.type&&params.dc||params.rollerRole==="target"&&params.against){const checkDC=params.dc==="@self.level"?params.dc:getCheckDC({name:name2,params,item,actor});if(params.against||(anchor.dataset.pf2Dc=checkDC),checkDC!=="@self.level"){const dc=params.dc===""?NaN:Number(checkDC),displayedDC=Number.isNaN(dc)?checkDC:`${dc+Number(params.adjustment)}`,text2=anchor.innerText;anchor.querySelector("span.label")?.replaceWith(createLabel(game.i18n.format("PF2E.DCWithValueAndVisibility",{role:params.showDC,dc:displayedDC,text:text2})))}}return params.roller==="self"&&actor&&!actor.canUserModify(game.user,"update")?createHTMLElement("span",{children:[anchor.innerText]}):anchor}static async#createDamageRoll(args){const rawParams=this.#parseInlineParams(args.paramString,{first:"formula"});if(!rawParams||!rawParams.formula)return ui.notifications.warn(game.i18n.localize("PF2E.InlineCheck.Errors.TypeMissing")),null;const item=args.rollData?.item??null,actor=args.rollData?.actor??item?.actor??null,domains=splitListString(rawParams.domains??"");if(domains.some(d=>!/^[a-z][-a-z0-9]+-damage$/.test(d)))return ui.notifications.warn(game.i18n.format("PF2E.InlineCheck.Errors.InvalidDomains",{type:"@Damage"})),null;const immutable="immutable"in rawParams,overrideTraits="overrideTraits"in rawParams,traits=(()=>{const fromParams=splitListString(rawParams.traits??""),fromItem=item?.system.traits?.value??[];return overrideTraits?fromParams:n([...fromParams,...fromItem])})(),extraRollOptions=splitListString(rawParams.options??""),result=await augmentInlineDamageRoll(rawParams.formula,{skipDialog:!0,immutable,actor,item,domains,traits,overrideTraits,name:rawParams.name?.trim(),extraRollOptions}),baseFormula=actor?new DamageRoll(rawParams.formula,{...item?.getRollData()??{},actor:{level:(item&&"level"in item?item.level:null)??1}}).formula:null,roll=result?.template.damage.roll??new DamageRoll(rawParams.formula,args.rollData),formula=roll.formula,label="shortLabel"in rawParams?roll.instances.map(i=>i.head.expression).join(" + "):args.inlineLabel??formula,labelEl=createHTMLElement("span",{children:[label]}),element=createHTMLElement("a",{classes:["inline-roll","roll",baseFormula&&baseFormula!==formula?"altered":null].filter(e$1),children:[damageDiceIcon(roll),labelEl],dataset:{formula:roll._formula,baseFormula:result?rawParams.formula:null,tooltip:args.inlineLabel?formula:baseFormula&&baseFormula!==formula?game.i18n.format("PF2E.InlineDamage.Base",{formula:baseFormula}):null,damageRoll:rawParams.formula,name:rawParams.name,immutable:immutable?"":null,overrideTraits:overrideTraits?"":null,domains:domains?.join(",")||null,traits:traits.toString()||null,rollOptions:extraRollOptions.toString()||null,itemId:item?.id}});return roll.instances.length>0&&roll.instances.every(i=>i.persistent)&&(element.draggable=!0,element.dataset.persistent=""),element}static createActionOptions(item,extra=[]){if(!item?.isOfType("action","feat")||!item.actionCost)return[];const slug=item.slug??sluggify(item.name),traits=n([item.system.traits.value,extra.filter(t2=>t2 in CONFIG.PF2E.actionTraits)].flat()),actionCost=item.actionCost.value;return[`action:${slug}`,`action:cost:${actionCost}`,`self:action:slug:${slug}`,`self:action:cost:${actionCost}`,...traits.map(t2=>`self:action:trait:${t2}`)].filter(e$1)}}function getCheckDC({name:name2,params,item=null,actor=item?.actor??null}){if(!params.dc&&params.against&&actor){const rollOptions=item?.isOfType("action","feat")?[`origin:action:slug:${item.slug}`,...item.getRollOptions("item")]:[],statistic=actor.getStatistic(params.against)?.clone({rollOptions});return String(statistic?.dc.value??0)}const dc=params.dc,resolvable=!!dc&&dc.startsWith("resolve")&&!!(item||actor),immutable=params.immutable||resolvable,base=(()=>{if(resolvable){const resolve=dc.match(/resolve\((.+?)\)$/),value=resolve&&resolve?.length>0?resolve[1]:"";return Number(__name2(resolveString=>{try{const rollData=item?.getRollData()??actor?.getRollData()??{};return Roll.safeEval(Roll.replaceFormulaData(resolveString,rollData))}catch{return 0}},"saferEval")(value))}return Number(dc)||null})();if(base&&actor&&!immutable){const idDomain=item?`${item.id}-inline-dc`:null,slugDomain=`${sluggify(name2)}-inline-dc`,domains=params.type==="flat"?["inline-flat-check-dc"]:["all","inline-dc",idDomain,slugDomain].filter(e$1),modifier=new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:base-10,adjustments:extractModifierAdjustments(actor.synthetics.modifierAdjustments,domains,"base")}),stat=new Statistic(actor,{slug:params.type,label:name2,domains,modifiers:[modifier]},{extraRollOptions:[`inline-dc:value:${base}`],item});return String(stat.dc.value)}return base?.toString()??"0"}__name(getCheckDC,"getCheckDC"),__name2(getCheckDC,"getCheckDC");async function augmentInlineDamageRoll(baseFormula,options){const{name:name2,actor,item,traits,immutable,extraRollOptions}=options;try{const rollData=item?.getRollData()??actor?.getRollData()??{};rollData.actor??={level:(item&&"level"in item?item.level:null)??1};const baseDamageRoll=new DamageRoll(baseFormula,rollData),base=extractBaseDamage(baseDamageRoll),kinds=Array.from(baseDamageRoll.kinds),actionOptions=options.overrideTraits?[]:TextEditorPF2e.createActionOptions(item,traits),domains=immutable?[]:[kinds,kinds.map(k=>`inline-${k}`),item?kinds.map(k=>`${item.id}-inline-${k}`):null,item?kinds.map(k=>`${sluggify(item.slug??item.name)}-inline-${k}`):null,options.domains].flat().filter(e$1),rollOptions=new Set([...actor?.getRollOptions(domains)??[],...item?.getRollOptions("item")??[],...traits,...traits.filter(t2=>t2 in CONFIG.PF2E.actionTraits).map(t2=>`item:trait:${t2}`),...extraRollOptions??[],...actionOptions]),firstBase=base.at(0);if(!firstBase)return null;if(actor?.isOfType("npc")&&(actor.isElite||actor.isWeak)){const value=rollOptions.has("item:frequency:limited")?4:2;firstBase.terms?.push({dice:null,modifier:actor.isElite?value:-value})}item?.isOfType("physical")&&(firstBase.materials=n([item.material.effects,firstBase.materials].flat()).filter(e$1).sort());const{modifiers,dice}=(()=>{if(!actor)return{modifiers:[],dice:[]};const extractOptions={selectors:domains,test:rollOptions};return processDamageCategoryStacking(base,{modifiers:extractModifiers(actor.synthetics,domains,extractOptions),dice:extractDamageDice(actor.synthetics.damageDice,extractOptions),test:rollOptions})})();actor&&item?.actor&&applyBaseDamageAlterations({actor,item,base,domains,rollOptions});const formulaData={base,modifiers,dice,kinds:new Set(kinds)},isAttack=!!traits?.includes("attack"),context={type:"damage-roll",sourceType:isAttack?"attack":"save",outcome:isAttack?"success":null,domains,options:rollOptions,self:actor?{actor,token:actor.token,item:item||null,statistic:null,self:!0,modifiers}:null,traits:traits?.filter(t2=>t2 in CONFIG.PF2E.actionTraits)??[]};if(!options.skipDialog&&!await new DamageModifierDialog({formulaData,context}).resolve())return null;const{formula,breakdown}=createDamageFormula(formulaData);if(!formula||formula==="{}")return null;const showBreakdown=game.pf2e.settings.metagame.breakdowns||(actor?.hasPlayerOwner??!0),roll=new DamageRoll(formula,{},{showBreakdown});return{template:{name:name2??item?.name??actor?.name??"",damage:{roll,breakdown},modifiers:[...modifiers,...dice],materials:item?.isOfType("physical")?item.system.material.effects:[]},context}}catch(ex){return console.error(`Failed to parse inline @Damage ${baseFormula}:`,ex),null}}__name(augmentInlineDamageRoll,"augmentInlineDamageRoll"),__name2(augmentInlineDamageRoll,"augmentInlineDamageRoll");function resolveRollData(rollData={}){return rollData instanceof Function?rollData():rollData}__name(resolveRollData,"resolveRollData"),__name2(resolveRollData,"resolveRollData");class CheckModifiersDialog extends foundry.appv1.api.Application{static{__name(this,"CheckModifiersDialog")}static{__name2(this,"CheckModifiersDialog")}check;context;resolve;isResolved=!1;#originallyEnabled;constructor(check,resolve,context={options:new Set}){const title=(()=>{const maybeWithHTML=context.title?.trim()||check.slug;if(!maybeWithHTML.includes("<"))return maybeWithHTML.trim();const div=document.createElement("div");return div.innerHTML=maybeWithHTML,div.querySelector(".action-glyph, .pf2-icon")?.remove(),div.innerText.trim()})();super({title}),this.check=check,this.resolve=resolve,this.context=context,this.#originallyEnabled=new Set(check.modifiers.filter(m=>m.enabled))}static get defaultOptions(){return{...super.defaultOptions,template:"systems/pf2e/templates/chat/check-modifiers-dialog.hbs",classes:["roll-modifiers-dialog","dice-checks","dialog"],popOut:!0,width:380,height:"auto"}}async getData(){const fortune=this.context.rollTwice==="keep-higher",misfortune=this.context.rollTwice==="keep-lower",none=fortune===misfortune,rollMode=this.context.rollMode==="roll"?game.settings.get("core","rollMode"):this.context.rollMode;return{appId:this.id,modifiers:this.check.modifiers.map(m=>({...m,hideIfDisabled:!this.#originallyEnabled.has(m)&&m.hideIfDisabled})),totalModifier:this.check.totalModifier,rollModes:CONFIG.Dice.rollModes,rollMode,showCheckDialogs:game.user.settings.showCheckDialogs,substitutions:this.#resolveSubstitutions(),fortune,none,misfortune}}#resolveSubstitutions(){this.context.substitutions??=[];const hasRequired={fortune:this.context.substitutions.some(s=>s.required&&s.effectType==="fortune"),misfortune:this.context.substitutions.some(s=>s.required&&s.effectType==="misfortune")};return this.context.substitutions.map(substitution=>{const toggleable=!hasRequired[substitution.effectType],selected=substitution.required?!0:substitution.selected&&toggleable;return{...substitution,selected,toggleable}})}activateListeners($html){const html2=$html[0];htmlQuery(html2,"button.roll")?.addEventListener("click",()=>{this.resolve(!0),this.isResolved=!0,this.close()});for(const checkbox of htmlQueryAll(html2,".substitutions input[type=checkbox]"))checkbox.addEventListener("click",()=>{const substitutions=this.context.substitutions??[],index2=Number(checkbox.dataset.subIndex),toggledSub=substitutions.at(index2);if(!toggledSub)return;toggledSub.selected=toggledSub.required||checkbox.checked;const options=this.context.options??=new Set;for(const substitution of substitutions){const option=`substitute:${substitution.slug}`;substitution.selected?options.add(option):options.delete(option)}this.context.substitutions=this.#resolveSubstitutions().map(s=>n$1(s,["toggleable"])),this.check.calculateTotal(this.context.options),this.render()});for(const checkbox of htmlQueryAll(html2,".modifier-container input[type=checkbox]"))checkbox.addEventListener("click",()=>{const index2=Number(checkbox.dataset.modifierIndex);this.check.modifiers[index2].ignored=!checkbox.checked,this.check.calculateTotal(),this.render()});const addModifierButton=htmlQuery(html2,"button.add-modifier");addModifierButton?.addEventListener("click",()=>{const parent=addModifierButton.parentElement,value=Number(parent.querySelector(".add-modifier-value")?.value||1),type2=String(parent.querySelector(".add-modifier-type")?.value);let name2=String(parent.querySelector(".add-modifier-name")?.value);const errors=[];if(Number.isNaN(value)?errors.push("Modifier value must be a number."):value===0&&errors.push("Modifier value must not be zero."),!setHasElement(MODIFIER_TYPES,type2))throw ErrorPF2e("Unexpected invalid modifier type");(!name2||!name2.trim())&&(name2=game.i18n.localize(value<0?`PF2E.PenaltyLabel.${type2}`:`PF2E.BonusLabel.${type2}`)),errors.length>0?ui.notifications.error(errors.join(" ")):(this.check.push(new Modifier(name2,value,type2)),this.render())});for(const rollTwice of htmlQueryAll(html2,".fate input[type=radio]"))rollTwice.addEventListener("click",()=>{this.context.rollTwice=rollTwice.value||!1});const rollModeInput=htmlQuery(html2,"select[name=rollmode]");rollModeInput?.addEventListener("change",()=>{const rollMode=rollModeInput.value;if(!tupleHasValue(Object.values(CONST.DICE_ROLL_MODES),rollMode))throw ErrorPF2e("Unexpected roll mode");this.context.rollMode=rollMode});const toggle=htmlQuery(html2,"input[data-action=change-show-default]");toggle?.addEventListener("click",async()=>{await game.user.update({"flags.pf2e.settings.showCheckDialogs":toggle.checked})})}async close(options){this.isResolved||this.resolve(!1),super.close(options)}_injectHTML($html){super._injectHTML($html),$html[0]?.querySelector("button.roll")?.focus()}}class CheckRoll extends Roll{static{__name(this,"CheckRoll")}static{__name2(this,"CheckRoll")}static CHAT_TEMPLATE="systems/pf2e/templates/chat/check/roll.hbs";constructor(formula,data,options){super(formula,data,options),this.options.showBreakdown??=!0}get roller(){return game.users.get(this.options.rollerId??"")??null}get type(){return this.options.type??"check"}get degreeOfSuccess(){return this.options.degreeOfSuccess??null}get isReroll(){return this.options.isReroll??!1}get isRerollable(){return!this.isReroll&&!this.dice.some(d=>d.modifiers.includes("kh")||d.modifiers.includes("kl"))}async render(options={}){const{isPrivate,flavor,template}=options;this._evaluated||await this.evaluate({allowInteractive:!isPrivate});const{type:type2,identifier,action:action2,damaging}=this.options,canRollDamage=!!(damaging&&identifier&&(this.roller===game.user||game.user.isGM)),showBreakdown=this.options.showBreakdown,showDamageCue=canRollDamage&&game.pf2e.settings.metagame.results,tooltip=isPrivate||!(showBreakdown||game.user.isGM)?"":await this.getTooltip(),chatData={formula:isPrivate?"???":this._formula,flavor:isPrivate?null:flavor,user:game.user,tooltip,total:isPrivate?"?":Math.round(this.total*100)/100,type:type2,identifier,action:action2,degree:this.degreeOfSuccess,canRollDamage,showBreakdown,showDamageCue};return foundry.applications.handlebars.renderTemplate(template??CheckRoll.CHAT_TEMPLATE,chatData)}async getTooltip(){const tooltip=await super.getTooltip();return this.options.showBreakdown?tooltip:tooltip.replace('"dice-tooltip"','"dice-tooltip" data-visibility="gm"')}}class StrikeAttackRoll extends CheckRoll{static{__name(this,"StrikeAttackRoll")}static{__name2(this,"StrikeAttackRoll")}}class Check{static{__name(this,"Check")}static{__name2(this,"Check")}static async roll(check,context={},event2=null,callback){if(context.origin===void 0&&context.actor&&(context.origin={actor:context.actor,token:context.token??null,self:!0,statistic:null,item:context.item??null,modifiers:check.modifiers}),!context.origin?.actor&&!context.target?.actor)return null;event2&&foundry.utils.mergeObject(context,eventToRollParams(event2,{type:"check"})),context.skipDialog??=!game.user.settings.showCheckDialogs,context.createMessage??=!0,Array.isArray(context.options)&&(context.options=new Set(context.options));const rollOptions=context.options??new Set;typeof context.mapIncreases=="number"&&rollOptions.add(`map:increases:${context.mapIncreases}`),rollOptions.has("secret")&&!game.pf2e.settings.metagame.secretChecks&&(context.rollMode??=game.user.isGM?"gmroll":"blindroll"),context.rollMode=objectHasKey(CONFIG.Dice.rollModes,context.rollMode)?context.rollMode:game.settings.get("core","rollMode"),rollOptions.size>0&&!context.isReroll&&check.calculateTotal(rollOptions),context.substitutions??=[];const requiredSubstitution=context.substitutions.find(s=>s.required&&s.selected);if(requiredSubstitution)for(const substitution of context.substitutions)substitution.required=substitution===requiredSubstitution,substitution.selected=substitution===requiredSubstitution;if(!context.skipDialog&&context.type!=="flat-check"&&!await new Promise(resolve=>{new CheckModifiersDialog(check,resolve,context).render(!0)}))return null;const extraTags=[],isReroll=context.isReroll??!1;isReroll&&(context.rollTwice=!1);const substitutions=context.substitutions??[],[dice,tagsFromDice]=(()=>{const substitution=substitutions.find(s=>s.selected),rollTwice=context.rollTwice??!1,fortuneMisfortune=new Set([substitution?.effectType,rollTwice==="keep-higher"?"fortune":rollTwice==="keep-lower"?"misfortune":null].filter(e$1));for(const trait of fortuneMisfortune)rollOptions.add(trait);if(rollOptions.has("fortune")&&rollOptions.has("misfortune")){for(const sub of substitutions)rollOptions.delete(`substitute:${sub.slug}`),check.calculateTotal(rollOptions);return["1d20",["PF2E.TraitFortune","PF2E.TraitMisfortune"]]}else if(substitution){const effectType={fortune:"PF2E.TraitFortune",misfortune:"PF2E.TraitMisfortune"}[substitution.effectType],extraTag=game.i18n.format("PF2E.SpecificRule.SubstituteRoll.EffectType",{type:game.i18n.localize(effectType),substitution:reduceItemName(game.i18n.localize(substitution.label))});return[substitution.value.toString(),[extraTag]]}else return context.rollTwice==="keep-lower"?["2d20kl",["PF2E.TraitMisfortune"]]:context.rollTwice==="keep-higher"?["2d20kh",["PF2E.TraitFortune"]]:["1d20",[]]})();extraTags.push(...tagsFromDice);const options={type:context.type,identifier:context.identifier,action:context.action&&sluggify(context.action)||null,dice,domains:context.domains,isReroll,totalModifier:check.totalModifier,damaging:!!context.damaging,rollerId:game.userId,showBreakdown:context.type==="flat-check"||game.pf2e.settings.metagame.breakdowns||!!context.actor?.hasPlayerOwner},totalModifierPart=signedInteger(check.totalModifier,{emptyStringZero:!0}),allowInteractive=context.rollMode!=="blindroll",roll=await new CheckRoll(`${dice}${totalModifierPart}`,{},options).evaluate({allowInteractive}),naturalTotal=roll.dice.map(d=>d.results.find(r2=>r2.active&&!r2.discarded)?.result??null).find(e$1),postRollOptions=[`check:total:${roll.total}`,`check:total:natural:${naturalTotal}`,`check:roll:total:natural:${naturalTotal}`];context.dc&&postRollOptions.push(`check:total:delta:${roll.total-context.dc.value}`);const dosAdjustments=(()=>{if(!context.dc)return{};const temporaryRollOptions=new Set([...postRollOptions,...rollOptions]);return context.dosAdjustments?.filter(a=>a.predicate?.test(temporaryRollOptions)??!0).reduce((record,data)=>{for(const outcome of["all",...DEGREE_OF_SUCCESS_STRINGS])data.adjustments[outcome]&&(record[outcome]=foundry.utils.deepClone(data.adjustments[outcome]));return record},{})??{}})(),degree=context.dc?new DegreeOfSuccess(roll,context.dc,dosAdjustments):null;degree&&(context.outcome=DEGREE_OF_SUCCESS_STRINGS[degree.value],context.unadjustedOutcome=DEGREE_OF_SUCCESS_STRINGS[degree.unadjusted],roll.options.degreeOfSuccess=degree.value);const notes=context.notes?.map(n2=>n2 instanceof RollNotePF2e?n2:new RollNotePF2e(n2)).filter(note=>{if(!note.predicate.test([...rollOptions,...postRollOptions,...note.rule?.item.getRollOptions("parent")??[]]))return!1;if(!context.dc||note.outcome.length===0)return!0;const outcome=context.outcome??context.unadjustedOutcome;return!!(outcome&&note.outcome.includes(outcome))})??[],notesList=RollNotePF2e.notesToHTML(notes),item=context.item??null,targeting=!!context.origin?.self,self=targeting?context.origin??null:context.target??null,opposer=targeting?context.target??null:context.origin??null,flavor=await(async()=>{const result=await this.#createResultFlavor({degree,self,opposer,targeting}),tags=this.#createTagFlavor({check,context,extraTags}),title=(context.title??check.slug).trim();return[title.startsWith("<h4")?title:(()=>{const strong=document.createElement("strong");return strong.innerHTML=title,createHTMLElement("h4",{classes:["action"],children:[strong]})})(),result,tags,notesList].flat().filter(e$1).map(e2=>typeof e2=="string"?e2:e2.outerHTML).join("")})(),contextFlag={...context,type:context.type??"check",identifier:context.identifier??null,item:void 0,dosAdjustments,actor:context.actor?.id??null,token:context.token?.id??null,domains:context.domains??[],origin:context.origin?.actor?{actor:context.origin.actor.uuid,token:context.origin.token?.uuid}:null,target:context.target?.actor?{actor:context.target.actor.uuid,token:context.target.token?.uuid}:null,options:Array.from(rollOptions).sort(),contextualOptions:{postRoll:postRollOptions},notes:notes.map(n2=>n2.toObject()),rollMode:context.rollMode,rollTwice:context.rollTwice??!1,title:context.title??"PF2E.Check.Label",traits:context.traits??[],substitutions,dc:context.dc?n$1(context.dc,["statistic"]):null,skipDialog:context.skipDialog,isReroll:context.isReroll??!1,outcome:context.outcome??null,unadjustedOutcome:context.unadjustedOutcome??null};delete contextFlag.item;const message=await(()=>{const flags={core:context.type==="initiative"?{initiativeRoll:!0}:{},pf2e:{context:contextFlag,modifierName:check.slug,modifiers:check.modifiers.map(m=>m.toObject()),origin:item?.getOriginData()}},speaker=ChatMessagePF2e.getSpeaker({actor:context.actor,token:context.token}),rollMode=contextFlag.rollMode,create=context.createMessage;return roll.toMessage({speaker,flavor,flags},{rollMode,create})})();if(callback){const msg=message instanceof ChatMessagePF2e?message:new ChatMessagePF2e(message);await callback(roll,context.outcome,msg,event2)}return item?.isOfType("weapon")&&item.traits.has("consumable")&&item.actor.items.has(item.id)&&item.quantity>0&&await item.update({system:{quantity:item.quantity-1}}),roll}static#createTagFlavor({check,context,extraTags}){const toTagElement=__name2((tag,cssClass=null)=>{const span=document.createElement("span");return span.classList.add("tag"),cssClass&&span.classList.add(`tag_${cssClass}`),span.innerText=tag.label,tag.name&&(span.dataset.slug=tag.name),tag.description&&(span.dataset.tooltip=tag.description),span},"toTagElement"),traits=n$2(context.traits?.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.actionTraits)).map(trait=>(trait.label=game.i18n.localize(trait.label),trait))??[],t2=>t2.name).sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang)).map(t2=>toTagElement(t2))??[],item=context.item,itemTraits=item?.isOfType("weapon","melee")&&context.type!=="saving-throw"?Array.from(item.traits).map(t2=>{const dictionary=item.isOfType("spell")?CONFIG.PF2E.spellTraits:CONFIG.PF2E.npcAttackTraits,obj=traitSlugToObject(t2,dictionary);return obj.label=game.i18n.localize(obj.label),obj}).sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang)).map(t2=>toTagElement(t2,"alt")):[],properties=(()=>{const range=item?.isOfType("action","weapon")?item.range:null,label=createActionRangeLabel(range);if(label&&(range?.increment||range?.max)){const slug=range.increment?`range-increment-${range.increment}`:`range-${range.max}`;return[toTagElement({name:slug,label,description:"PF2E.Item.Weapon.RangeIncrementN.Hint"},"secondary")]}else return[]})(),traitsAndProperties=createHTMLElement("div",{classes:["tags","traits"],dataset:{tooltipClass:"pf2e"}});if(itemTraits.length===0&&properties.length===0)traitsAndProperties.append(...traits);else{const verticalBar=document.createElement("hr");verticalBar.className="vr",traitsAndProperties.append(...[traits,verticalBar,itemTraits,properties].flat())}const showBreakdown=game.pf2e.settings.metagame.breakdowns||!!context.actor?.hasPlayerOwner,modifiers=check.modifiers.filter(m=>m.enabled).map(modifier=>{const sign=modifier.modifier<0?"":"+",label=`${modifier.label} ${sign}${modifier.modifier}`,tag=toTagElement({name:modifier.slug,label,description:null},"transparent");return showBreakdown||(tag.dataset.visibility="gm"),tag}),tagsFromOptions=extraTags.map(t2=>{const label=game.i18n.localize(t2),slug=sluggify(label);return toTagElement({name:slug,label,description:null},"transparent")}),rollTags=[...modifiers,...tagsFromOptions],modifiersAndExtras=rollTags.length>0?createHTMLElement("div",{classes:["tags","modifiers"],children:rollTags}):null;return[traitsAndProperties.childElementCount>0?traitsAndProperties:null,document.createElement("hr"),modifiersAndExtras].filter(e$1)}static async rerollFromMessage(message,options={}){if(!(message.isAuthor||game.user.isGM)){ui.notifications.error(game.i18n.localize("PF2E.RerollMenu.ErrorCantDelete"));return}const actor=message.actor;if(!actor){ui.notifications.error("PF2E.RerollMenu.ErrorNoActor",{localize:!0});return}const rerollingActor=actor.isOfType("familiar")?actor.master:actor,resourceKey=options.resource,resource=rerollingActor?.getResource(resourceKey??"");resource&&resource.slug!=="hero-points"&&resource.slug!=="mythic-points"&&console.warn(`${resource.label} is not a supported resource. Using it might lead to unexpected results.`);let rerollFlavor=game.i18n.localize(`PF2E.RerollMenu.MessageKeep.${options.keep}`);if(resource&&rerollingActor?.isOfType("character"))if(resource&&resource.value>0)await rerollingActor.updateResource(resource.slug,resource.value-1),rerollFlavor=game.i18n.localize(`PF2E.RerollMenu.Message${sluggify(resource.slug,{camel:"bactrian"})}`);else{ui.notifications.warn("PF2E.RerollMenu.WarnNoResource",{localize:!0,format:{name:rerollingActor.name,resource:resource.label}});return}const systemFlags=foundry.utils.deepClone(message.flags.pf2e),context=systemFlags.context;if(!isCheckContextFlag(context))return;context.skipDialog=!0,context.isReroll=!0,context.options.push("check:reroll"),resource&&context.options.push(`check:reroll:${resource.slug}`);const oldRoll=message.rolls.at(0);if(!(oldRoll instanceof CheckRoll))throw ErrorPF2e("Unexpected error retrieving prior roll");const oldRollJSON=JSON.stringify(oldRoll.toJSON()),pwolVariant=game.pf2e.settings.variants.pwol.enabled,unevaluatedNewRoll=(()=>{if(resource?.slug!=="mythic-points"||!actor.isOfType("character"))return oldRoll.clone();const proficiencyModifier=(systemFlags.modifiers??[]).find(m=>m.slug==="proficiency");if(!proficiencyModifier)throw ErrorPF2e("Failed to reroll check with a mythic point. Check is missing a proficiency modifier!");const mythicModifierValue=10+(pwolVariant?0:actor.level),proficiencyModifierValue=proficiencyModifier.modifier;proficiencyModifier.modifier=mythicModifierValue,proficiencyModifier.label=game.i18n.localize("PF2E.TraitMythic");const options2=foundry.utils.deepClone(oldRoll.options);return options2.totalModifier=(options2.totalModifier??0)-proficiencyModifierValue+mythicModifierValue,new CheckRoll(`${options2.dice}${signedInteger(options2.totalModifier,{emptyStringZero:!0})}`,oldRoll.data,options2)})();unevaluatedNewRoll.options.isReroll=!0,Hooks.callAll("pf2e.preReroll",Roll.fromJSON(oldRollJSON),unevaluatedNewRoll,resource,options.keep);const allowInteractive=context.rollMode!=="blindroll",newRoll=await unevaluatedNewRoll.evaluate({allowInteractive});Hooks.callAll("pf2e.reroll",Roll.fromJSON(oldRollJSON),newRoll,resource,options.keep);let keptRoll=newRoll,[oldRollClass,newRollClass]=["reroll-discard",""];(options.keep==="higher"&&oldRoll.total>newRoll.total||options.keep==="lower"&&oldRoll.total<newRoll.total)&&([oldRollClass,newRollClass]=[newRollClass,oldRollClass],keptRoll=oldRoll);const degree=(()=>{const dc=context.dc;if(!dc)return null;if(["ac","armor"].includes(dc.slug??"")){const targetActor=(()=>{const target=context.target;if(!target?.actor)return null;const maybeActor=fromUuidSync(target.actor);return maybeActor instanceof ActorPF2e?maybeActor:maybeActor instanceof TokenDocumentPF2e?maybeActor.actor:null})();dc.statistic=targetActor?.armorClass}return new DegreeOfSuccess(newRoll,dc,context.dosAdjustments)})(),useNewRoll=keptRoll===newRoll;useNewRoll&&degree&&(newRoll.options.degreeOfSuccess=degree.value,context.outcome=DEGREE_OF_SUCCESS_STRINGS[degree.value]);const renders={old:await Check.renderReroll(oldRoll,{isOld:!0,resource}),new:await Check.renderReroll(newRoll,{isOld:!1,resource})},rerollIcon=fontAwesomeIcon(resource?.slug==="hero-points"?"hospital-symbol":resource?.slug==="mythic-points"?"circle-m":"dice");rerollIcon.classList.add("reroll-indicator"),rerollIcon.dataset.tooltip=rerollFlavor;const oldFlavor=message.flavor??"",newFlavor=useNewRoll?await(async()=>{const parsedFlavor=document.createElement("div");parsedFlavor.innerHTML=oldFlavor;const targeting=actor.uuid===context.origin?.actor,self=targeting?context.origin:context.target,opposer=context.target?.actor===actor.uuid?context.origin:context.target,targetFlavor=await this.#createResultFlavor({degree,self,opposer,targeting});if(targetFlavor&&htmlQuery(parsedFlavor,".target-dc-result")?.replaceWith(targetFlavor),resource?.slug==="mythic-points"){const proficiencyTag=htmlQuery(parsedFlavor,"span[data-slug=proficiency]");if(proficiencyTag){const mythicTag=proficiencyTag.cloneNode();proficiencyTag.style.textDecorationLine="line-through";const mythicValue=signedInteger(10+(pwolVariant?0:actor.level),{emptyStringZero:!0});mythicTag.innerHTML=`${game.i18n.localize("PF2E.TraitMythic")} ${mythicValue}`,proficiencyTag.after(mythicTag)}}htmlQuery(parsedFlavor,"ul.notes")?.remove();const newNotes=context.notes?.map(n2=>new RollNotePF2e(n2))??[],notesEl=RollNotePF2e.notesToHTML(newNotes.filter(note=>{if(!context.dc||note.outcome.length===0)return!0;const outcome=context.outcome??context.unadjustedOutcome;return!!(outcome&&note.outcome.includes(outcome))}));return notesEl&&parsedFlavor.append(notesEl),parsedFlavor.innerHTML})():oldFlavor,initiativeRoll=message.flags.core.initiativeRoll;if(initiativeRoll){const combatant=message.token?.combatant;await combatant?.parent.setInitiative(combatant.id,newRoll.total)}await message.delete({render:!1});const keptMessage=await keptRoll.toMessage({content:`<div class="${oldRollClass}">${renders.old}</div><div class="reroll-second ${newRollClass}">${renders.new}</div>`,flavor:`${rerollIcon.outerHTML}${newFlavor}`,speaker:message.speaker,flags:{core:{initiativeRoll},pf2e:systemFlags}},{rollMode:context.rollMode});systemFlags.treatWoundsMacroFlag&&treatWoundsMacroCallback({actor,bonus:systemFlags.treatWoundsMacroFlag.bonus,message:keptMessage,originalMessageId:message.id,outcome:context.outcome})}static async renderReroll(roll,{isOld,resource}){const die=roll.dice.find(d=>d instanceof foundry.dice.terms.Die&&d.faces===20);if(typeof die?.total!="number")throw ErrorPF2e("Unexpected error inspecting d20 term");const html2=await roll.render(),element=parseHTML(`<div>${html2}</div>`),formulaElement=htmlQuery(element,".dice-formula");return formulaElement&&!isOld&&resource?.slug!=="mythic-points"?formulaElement.classList.add("hidden"):formulaElement&&isOld&&resource?.slug==="mythic-points"&&(formulaElement.style.opacity="0.3"),isOld&&element.querySelector(".message-buttons")?.remove(),[1,20].includes(die.total)&&element.querySelector(".dice-total")?.classList.add(die.total===20?"success":"failure"),element.innerHTML}static async#createResultFlavor({degree,self,opposer,targeting}){if(!degree||!self?.actor)return null;const dc=degree.dc,customLabel=!!dc.label&&Number.isInteger(dc.value)&&!dc.label.includes("{dc}")&&dc.label?`<dc>${game.i18n.localize(dc.label)}: {dc}</dc>`:dc.label??null,opposingActor=await(async()=>{if(!opposer?.actor)return null;if(opposer.actor instanceof ActorPF2e)return opposer.actor;const maybeActor=await fromUuid(opposer.actor);return maybeActor instanceof ActorPF2e?maybeActor:maybeActor instanceof TokenDocumentPF2e?maybeActor.actor:null})(),opposerData=await(async()=>{if(!opposer)return null;const token=await(async()=>opposer.token?opposer.token instanceof TokenDocumentPF2e?opposer.token:opposingActor?.token?opposingActor.token:fromUuid(opposer.token):null)(),canSeeName=(token??new TokenDocumentPF2e(opposingActor?.prototypeToken.toObject()??{})).playersCanSeeName||!game.pf2e.settings.tokens.nameVisibility;return{name:token?.name??opposingActor?.name??"",visible:!!canSeeName}})(),checkDCs=CONFIG.PF2E.checkDCs,dcData=(()=>{const dcSlug=(()=>{const fromParams=dc.slug??(dc.statistic instanceof StatisticDifficultyClass?dc.statistic.parent.slug:null);return fromParams==="ac"?"armor":fromParams?.replace(/-dc$/,"")??null})(),dcType=game.i18n.localize(dc.label?.trim()||game.i18n.localize(objectHasKey(checkDCs.Specific,dcSlug)?checkDCs.Specific[dcSlug]:checkDCs.Unspecific)),circumstances=dc.statistic instanceof StatisticDifficultyClass?dc.statistic.modifiers.filter(m=>m.enabled&&m.type==="circumstance"):[],preadjustedDC=circumstances.length>0&&dc.statistic?dc.value-circumstances.reduce((total,c)=>total+c.modifier,0):dc.value??null,visible=opposingActor?.hasPlayerOwner||dc.visible||game.pf2e.settings.metagame.dcs;if(typeof preadjustedDC!="number"||circumstances.length===0){const labelKey=game.i18n.localize(opposerData?targeting?checkDCs.Label.WithTarget:checkDCs.Label.WithOrigin:customLabel??checkDCs.Label.NoTarget);return{markup:game.i18n.format(labelKey,{dcType,dc:dc.value,opposer:opposerData?.name??null}),visible}}const adjustment2={preadjusted:preadjustedDC,direction:preadjustedDC<dc.value?"increased":preadjustedDC>dc.value?"decreased":"no-change",circumstances:circumstances.map(c=>({label:c.label,value:c.modifier}))},translation=adjustment2.direction==="no-change"?checkDCs.Label.NoChangeTarget:checkDCs.Label.AdjustedTarget;return{markup:game.i18n.format(translation,{opposer:opposerData?.name??game.user.name,dcType,preadjusted:preadjustedDC,adjusted:dc.value}),visible,adjustment:adjustment2}})(),resultData=(()=>{const offset={value:new Intl.NumberFormat(game.i18n.lang,{maximumFractionDigits:0,signDisplay:"always",useGrouping:!1}).format(degree.rollTotal-dc.value),visible:dc.visible},checkOrAttack=sluggify(dc.scope??"Check",{camel:"bactrian"}),locPath=__name2((checkOrAttack2,dosKey)=>`PF2E.Check.Result.Degree.${checkOrAttack2}.${dosKey}`,"locPath"),unadjusted=game.i18n.localize(locPath(checkOrAttack,DEGREE_OF_SUCCESS_STRINGS[degree.unadjusted])),[adjusted,locKey]=degree.adjustment?[game.i18n.localize(locPath(checkOrAttack,DEGREE_OF_SUCCESS_STRINGS[degree.value])),"AdjustedLabel"]:[unadjusted,"Label"],markup=game.i18n.format(`PF2E.Check.Result.${locKey}`,{adjusted,unadjusted,offset:offset.value}),visible=game.pf2e.settings.metagame.results;return{markup,visible}})(),rendered=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/check/target-dc-result.hbs",{dc:dcData,result:resultData}),html2=parseHTML(rendered),convertXMLNode=TextEditorPF2e.convertXMLNode;opposerData&&convertXMLNode(html2,"opposer",{visible:opposerData.visible,whose:"opposer"}),convertXMLNode(html2,"dc",{visible:dcData.visible,whose:"opposer"});const adjustment=dcData.adjustment;if(adjustment){convertXMLNode(html2,"preadjusted",{classes:["unadjusted"]});const adjustedNode=convertXMLNode(html2,"adjusted",{classes:["adjusted",adjustment.direction]});if(!adjustedNode)throw ErrorPF2e("Unexpected error processing roll template");adjustment.circumstances.length>0&&(adjustedNode.dataset.tooltip=adjustment.circumstances.map(a=>createHTMLElement("div",{children:[`${a.label}: ${signedInteger(a.value)}`]}).outerHTML).join(`
`))}if(convertXMLNode(html2,"unadjusted",{visible:resultData.visible,classes:degree.adjustment?["unadjusted"]:[DEGREE_OF_SUCCESS_STRINGS[degree.value]]}),degree.adjustment){const adjustedNode=convertXMLNode(html2,"adjusted",{visible:resultData.visible,classes:[DEGREE_OF_SUCCESS_STRINGS[degree.value],"adjusted"]});if(!adjustedNode)throw ErrorPF2e("Unexpected error processing roll template");adjustedNode.dataset.tooltip=degree.adjustment.label}if(convertXMLNode(html2,"offset",{visible:dcData.visible,whose:"opposer"}),!opposerData?.visible&&!dcData.visible){const targetDC=html2.querySelector(".target-dc");targetDC&&(targetDC.dataset.visibility="gm"),resultData.visible||(html2.dataset.visibility="gm")}return html2}}class WeaponDamagePF2e{static{__name(this,"WeaponDamagePF2e")}static{__name2(this,"WeaponDamagePF2e")}static async fromNPCAttack({attack,actor,context}){const baseDamage=attack.baseDamage,secondaryInstances=Object.values(attack.system.damageRolls).map(this.npcDamageToWeaponDamage).filter(d=>!t$6(d,baseDamage)),damageDice=[],modifiers=[],labelFromCategory={null:"",persistent:"",precision:"PF2E.Damage.Precision",splash:attack.system.traits.value.some(t2=>t2.startsWith("scatter-"))?"PF2E.TraitScatter":"PF2E.TraitSplash"};for(const instance of secondaryInstances){const{damageType}=instance;instance.dice>0&&instance.die&&damageDice.push(new DamageDicePF2e({slug:"base",label:labelFromCategory[instance.category??"null"],selector:`${attack.id}-damage`,diceNumber:instance.dice,dieSize:instance.die,damageType:instance.damageType,category:instance.category})),instance.modifier&&modifiers.push(new Modifier({slug:"base",label:labelFromCategory[instance.category??"null"],modifier:instance.modifier,damageType,damageCategory:instance.category}))}return WeaponDamagePF2e.calculate({weapon:attack,actor,damageDice,modifiers,context})}static async calculate({weapon,actor,damageDice=[],modifiers=[],weaponPotency=0,context}){const unprocessedBaseDamage=weapon.baseDamage,{domains,options}=context;if(unprocessedBaseDamage.die===null&&unprocessedBaseDamage.modifier!==0)unprocessedBaseDamage.dice=0;else if(!weapon.dealsDamage)return null;const weaponTraits2=weapon.system.traits.value,materialTraits=weapon.isOfType("melee")?weapon.system.traits.value.filter(t2=>t2 in CONFIG.PF2E.materialDamageEffects):[];for(const trait of weaponTraits2)options.add(trait);const isMelee=!!weapon.isMelee;if(options.add(isMelee?"melee":"ranged"),actor.isOfType("character")&&weapon.isOfType("weapon")){const attributeDomains=ATTRIBUTE_ABBREVIATIONS.map(a=>`${a}-damage`),domain=domains.find(d=>attributeDomains.has(d)),strengthModValue=actor.abilities.str.mod,modifierValue=domain==="str-damage"?strengthModValue<0||!weaponTraits2.some(t2=>t2==="propulsive")?strengthModValue:Math.floor(strengthModValue/2):null;if(typeof modifierValue=="number"){const strModifier=createAttributeModifier({actor,attribute:"str",domains,max:modifierValue});modifiers.push(strModifier)}}for(const rule of actor.rules.filter(r2=>!r2.ignored))rule.beforeRoll?.(domains,options);const baseDamage=processBaseDamage("strike-damage",unprocessedBaseDamage,{actor,item:weapon,domains,options}),hasScatterTrait=weaponTraits2.some(t2=>t2.startsWith("scatter-")),splashDamage=weapon.isOfType("weapon")&&(Number(weapon.system.splashDamage?.value)||hasScatterTrait&&weapon.system.damage.dice)||0;if(splashDamage>0){const slug=hasScatterTrait?"scatter":"splash",label=`PF2E.Trait${sluggify(slug,{camel:"bactrian"})}`,modifier=new Modifier({slug,label,modifier:splashDamage,damageType:baseDamage.damageType,damageCategory:"splash"});modifiers.push(modifier)}weapon.isOfType("weapon")&&weaponTraits2.includes("kickback")&&modifiers.push(new Modifier({slug:"kickback",label:CONFIG.PF2E.weaponTraits.kickback,modifier:1}));const critSpecEffect=(()=>{const critSpecs=actor.synthetics.criticalSpecializations,standard=critSpecs.standard.reduceRight((result,cs)=>result??cs?.(weapon,options),null),alternate=critSpecs.alternate.reduceRight((result,cs)=>result??cs?.(weapon,options),null);return standard?alternate??standard:[]})();critSpecEffect.length>0&&options.add("critical-specialization"),modifiers.push(...critSpecEffect.filter(e2=>e2 instanceof Modifier)),damageDice.push(...critSpecEffect.filter(e2=>e2 instanceof DamageDicePF2e));const propertyRunes=weapon.system.runes.property,runeDamage=getPropertyRuneDamage(weapon,propertyRunes,options);damageDice.push(...runeDamage.filter(d=>"diceNumber"in d)),modifiers.push(...runeDamage.filter(d=>"modifier"in d));const propertyRuneAdjustments=getPropertyRuneModifierAdjustments(propertyRunes),irBypassData={immunity:{ignore:[],downgrade:[],redirect:[]},resistance:{ignore:propertyRunes.flatMap(r2=>RUNE_DATA.weapon.property[r2].damage?.ignoredResistances??[]),redirect:[]}};if(weaponTraits2.some(t2=>t2==="backstabber")&&options.has("target:condition:off-guard")){const modifier=new Modifier({label:CONFIG.PF2E.weaponTraits.backstabber,slug:"backstabber",modifier:weaponPotency>2?2:1,damageCategory:"precision"});modifiers.push(modifier)}weaponTraits2.includes("concussive")&&(irBypassData.immunity.redirect.push({from:"piercing",to:"bludgeoning"},{from:"bludgeoning",to:"piercing"}),irBypassData.resistance.redirect.push({from:"piercing",to:"bludgeoning"},{from:"bludgeoning",to:"piercing"}));const strikingSynthetic=domains.flatMap(key=>actor.synthetics.striking[key]??[]).filter(wp=>wp.predicate.test(options)).reduce((highest,current)=>highest&&highest.bonus>current.bonus?highest:current,null);strikingSynthetic&&baseDamage.die&&weapon.isOfType("weapon")&&(weapon.system.damage.dice=baseDamage.dice=Math.max(weapon.system.damage.dice,strikingSynthetic.bonus+1),weapon.system.runes.striking=Math.max(weapon.system.runes.striking,strikingSynthetic.bonus));const strikingDice=weapon.isOfType("weapon")?weapon.system.damage.dice-weapon._source.system.damage.dice:strikingSynthetic?.bonus??0,traitLabels=CONFIG.PF2E.weaponTraits,deadlyTraits=weaponTraits2.filter(t2=>t2.startsWith("deadly-"));for(const slug of deadlyTraits){const diceNumber=(()=>{const baseNumber=Number(/-(\d)d\d{1,2}$/.exec(slug)?.at(1))||1;return strikingDice>1?strikingDice*baseNumber:baseNumber})();damageDice.push(new DamageDicePF2e({selector:`${weapon.id}-damage`,slug,label:traitLabels[slug],diceNumber,dieSize:/-\d?(d\d{1,2})$/.exec(slug)?.at(1)??baseDamage.die,critical:!0}))}for(const trait of weaponTraits2.filter(t2=>t2.startsWith("fatal-d"))){const dieSize=trait.substring(trait.indexOf("-")+1);damageDice.push(new DamageDicePF2e({selector:`${weapon.id}-damage`,slug:trait,label:traitLabels[trait],diceNumber:1,dieSize,critical:!0,enabled:!0,override:{dieSize}}))}if(weaponTraits2.some(t2=>t2==="forceful")&&weapon.isOfType("weapon")&&modifiers.push(new Modifier({slug:"forceful-second",label:"PF2E.Item.Weapon.Forceful.Second",modifier:weapon._source.system.damage.dice+strikingDice,type:"circumstance",ignored:!0}),new Modifier({slug:"forceful-third",label:"PF2E.Item.Weapon.Forceful.Third",modifier:2*(weapon._source.system.damage.dice+strikingDice),type:"circumstance",ignored:!0})),weaponTraits2.some(t2=>t2==="tearing")){const modifier=new Modifier({label:CONFIG.PF2E.weaponTraits.tearing,slug:"tearing",modifier:strikingDice>1?2:1,damageType:"bleed",damageCategory:"persistent"});modifiers.push(modifier)}if(weaponTraits2.some(t2=>t2==="twin")&&weapon.isOfType("weapon")&&modifiers.push(new Modifier({slug:"twin-second",label:"PF2E.Item.Weapon.Twin.SecondPlus",modifier:weapon._source.system.damage.dice+strikingDice,type:"circumstance",ignored:!0})),weaponTraits2.some(t2=>t2==="venomous")){const modifier=new Modifier({label:CONFIG.PF2E.weaponTraits.venomous,slug:"venomous",modifier:strikingDice>1?2:1,damageType:"poison",damageCategory:"persistent"});modifiers.push(modifier)}const runeNotes=propertyRunes.flatMap(r2=>(RUNE_DATA.weapon.property[r2].damage?.notes??[]).map(d=>new RollNotePF2e({selector:"strike-damage",...d})));context.notes=[runeNotes,critSpecEffect.filter(e2=>e2 instanceof RollNotePF2e)].flat();const material=objectHasKey(CONFIG.PF2E.materialDamageEffects,weapon.system.material.type)?weapon.system.material.type:null,materials=new Set([materialTraits,material??[]].flat());for(const adjustment of actor.synthetics.strikeAdjustments)adjustment.adjustDamageRoll?.(weapon,{materials});for(const option of Array.from(materials).map(m=>`item:material:${m}`))options.add(option);const baseUncategorized=(()=>{const diceNumber=baseDamage.die?baseDamage.dice:0;return diceNumber>0||baseDamage.modifier!==0?{diceNumber,dieSize:baseDamage.die,modifier:baseDamage.modifier,damageType:baseDamage.damageType,category:"category"in baseDamage&&baseDamage.category==="persistent"?"persistent":null,materials:Array.from(materials)}:null})(),basePersistent=baseDamage.persistent?.faces?{diceNumber:baseDamage.persistent.number,dieSize:`d${baseDamage.persistent.faces}`,damageType:baseDamage.persistent.type,category:"persistent"}:baseDamage.persistent?.number?{modifier:baseDamage.persistent.number,damageType:baseDamage.persistent.type,category:"persistent"}:null;if(!(baseUncategorized||basePersistent||splashDamage))return null;const base=[baseUncategorized,basePersistent].filter(e$1),adjustmentsRecord=actor.synthetics.modifierAdjustments,alterationsRecord=actor.synthetics.damageAlterations;for(const modifier of modifiers)modifier.domains=[...domains],modifier.adjustments=extractModifierAdjustments(adjustmentsRecord,domains,modifier.slug),modifier.alterations=extractDamageAlterations(alterationsRecord,domains,modifier.slug);for(const modifier of modifiers){const propRuneAdjustments=propertyRuneAdjustments.filter(a=>a.slug===modifier.slug);modifier.adjustments.push(...propRuneAdjustments)}for(const dice of damageDice)dice.alterations=extractDamageAlterations(alterationsRecord,domains,dice.slug);const extractOptions={selectors:domains,test:options,resolvables:{weapon,target:context.target?.actor??null},injectables:{weapon}},extracted=processDamageCategoryStacking(base,{modifiers:[modifiers,extractModifiers(actor.synthetics,domains,extractOptions)].flat(),dice:extractDamageDice(actor.synthetics.damageDice,extractOptions),test:options}),testedModifiers=extracted.modifiers;damageDice.push(...extracted.dice);for(const dice of damageDice)dice.applyAlterations({item:weapon,test:options});for(const modifier of testedModifiers)modifier.applyDamageAlterations({item:weapon,test:options});const maxIncreases=weapon.isOfType("weapon")&&weapon.flags.pf2e.damageFacesUpgraded?0:1,formulaData={base,dice:damageDice,maxIncreases,modifiers:testedModifiers,bypass:irBypassData};formulaData.base[0].diceNumber||formulaData.base[0].modifier||(formulaData.dice=formulaData.dice.filter(d=>![null,"precision"].includes(d.category)),formulaData.modifiers=formulaData.modifiers.filter(m=>![null,"precision"].includes(m.category)));const excludeFrom=weapon.isOfType("weapon")?weapon:null;if(this.#excludeDamage({actor,weapon:excludeFrom,modifiers:[...testedModifiers,...damageDice],options}),!context.skipDialog&&!await new DamageModifierDialog({formulaData,context}).resolve())return null;const computedFormulas={criticalFailure:null,failure:createDamageFormula(formulaData,DEGREE_OF_SUCCESS.FAILURE),success:createDamageFormula(formulaData,DEGREE_OF_SUCCESS.SUCCESS),criticalSuccess:createDamageFormula(formulaData,DEGREE_OF_SUCCESS.CRITICAL_SUCCESS)};return{name:`${game.i18n.localize("PF2E.DamageRoll")}: ${weapon.name}`,materials:Array.from(materials),modifiers:[...damageDice,...testedModifiers],damage:{...formulaData,formula:t$5(computedFormulas,v=>v?.formula??null),breakdown:t$5(computedFormulas,v=>v?.breakdown??[])}}}static#excludeDamage({actor,modifiers,weapon,options}){if(!weapon)return;const notIgnored=modifiers.filter(modifier=>!modifier.ignored);for(const rule of actor.rules)rule.applyDamageExclusion?.(weapon,notIgnored);for(const modifier of notIgnored)modifier.ignored=!modifier.predicate.test(options)}static npcDamageToWeaponDamage(instance){const terms2=parseTermsFromSimpleFormula(instance.damage),die=terms2.find(t2=>t2.dice)?.dice,modifier=terms2.find(t2=>t2.modifier)?.modifier??0;return{dice:die?.number??0,die:die?.faces?`d${die.faces}`:null,modifier,damageType:instance.damageType,persistent:null,category:instance.category}}}class DamageContext extends RollContext{static{__name(this,"DamageContext")}static{__name2(this,"DamageContext")}constructor(params){super(params),params.checkContext??=this.#findMatchingCheckContext(),params.outcome&&params.options.add(`check:outcome:${sluggify(params.outcome)}`);const substitution=params.checkContext?.substitutions.find(s=>s.selected);substitution&&params.options.add(`check:substitution:${substitution.slug}`)}#findMatchingCheckContext(){const{origin,target}=this.unresolved,item=origin?.item;if(this.viewOnly||!origin?.actor||!item?.isOfType("melee","weapon")||!target?.token)return null;const actor=origin.actor;return game.messages.contents.slice(-3).reverse().find(message=>{if(!message.rolls.some(r2=>r2 instanceof CheckRoll)||message.actor?.uuid!==actor.uuid||target.token!==message.target?.token)return!1;const messageItem=message.item;if(!messageItem?.isOfType("melee","weapon"))return!1;const paramsItemSlug=item.slug??sluggify(item.name),messageItemSlug=messageItem.slug??sluggify(messageItem.name);return paramsItemSlug===messageItemSlug&&item.uuid===messageItem.uuid&&item.isMelee===messageItem.isMelee})?.flags.pf2e.context??null}}async function resetActors(actors,options={}){actors??=[game.actors.contents,game.scenes.contents.flatMap(s=>s.tokens.contents).flatMap(t2=>t2.actor??[])].flat(),actors=n(Array.from(actors)),options.sheets??=!0;for(const actor of actors)actor.reset(),options.sheets&&actor.render();if(game.pf2e.effectPanel.refresh(),options.tokens)for(const token of n(Array.from(actors).flatMap(a=>a.getActiveTokens(!0,!0))))token.simulateUpdate()}__name(resetActors,"resetActors"),__name2(resetActors,"resetActors");function userColorForActor(actor){return(game.users.find(u=>u.character===actor)??game.users.players.find(u=>actor.testUserPermission(u,"OWNER"))??actor.primaryUpdater)?.color.toString()??"#43dfdf"}__name(userColorForActor,"userColorForActor"),__name2(userColorForActor,"userColorForActor");async function migrateActorSource(source2){source2.effects=[],["flags","items","system"].some(k=>k in source2)||(source2.system={_migration:{version:MigrationRunnerBase.LATEST_SCHEMA_VERSION}});const lowestSchemaVersion=Math.min(source2.system?._migration?.version??MigrationRunnerBase.LATEST_SCHEMA_VERSION,...(source2.items??[]).map(i=>i?.system?._migration?.version??MigrationRunnerBase.LATEST_SCHEMA_VERSION)),actor=new ActorProxyPF2e(foundry.utils.deepClone(source2));return await MigrationRunner.ensureSchemaVersion(actor,MigrationList.constructFromVersion(lowestSchemaVersion)),foundry.utils.deepClone(actor._source)}__name(migrateActorSource,"migrateActorSource"),__name2(migrateActorSource,"migrateActorSource");async function checkAreaEffects(){if(!canvas.ready||game.user!==this.primaryUpdater||this.isOfType("party"))return;const thisTokens=this.getActiveTokens(!0,!0),toDelete2=[],toKeep=[];for(const effect of this.itemTypes.effect){const auraData=effect.flags.pf2e.aura;if(!auraData?.removeOnExit)continue;const auraActor=await fromUuid(auraData.origin),aura=(auraActor?.getActiveTokens(!0,!0).shift()??null)?.auras.get(auraData.slug),auraEffectData=auraActor?.auras.get(auraData.slug)?.effects.find(e2=>e2.uuid===effect.sourceId&&auraAffectsActor(e2,auraActor,this));for(const token of thisTokens)auraEffectData&&aura?.containsToken(token)?toKeep.push(effect.id):toDelete2.push(effect.id);thisTokens.length===0&&toDelete2.push(effect.id)}const finalToDelete=toDelete2.filter(id=>!toKeep.includes(id));finalToDelete.length>0&&await this.deleteEmbeddedDocuments("Item",finalToDelete)}__name(checkAreaEffects,"checkAreaEffects"),__name2(checkAreaEffects,"checkAreaEffects");function auraAffectsActor(data,origin,actor){return data.includesSelf&&origin===actor||data.affects==="allies"&&actor.isAllyOf(origin)||data.affects==="enemies"&&actor.isEnemyOf(origin)||data.affects==="all"&&actor!==origin}__name(auraAffectsActor,"auraAffectsActor"),__name2(auraAffectsActor,"auraAffectsActor");function setHitPointsRollOptions(actor){const hp=actor.hitPoints;if(!hp)return;actor.flags.pf2e.rollOptions.all[`hp-remaining:${hp.value}`]=!0;const percentRemaining=Math.floor(hp.value/hp.max*100);actor.flags.pf2e.rollOptions.all[`hp-percent:${percentRemaining}`]=!0}__name(setHitPointsRollOptions,"setHitPointsRollOptions"),__name2(setHitPointsRollOptions,"setHitPointsRollOptions");function calculateMAPs(item,{domains,options}){const slugAndLabel={slug:"multiple-attack-penalty",label:"PF2E.MultipleAttackPenalty"},baseMap=item.isOfType("action","melee","weapon")&&item.traits.has("agile")?{...slugAndLabel,map1:-4,map2:-8}:{...slugAndLabel,map1:-5,map2:-10},optionSet=options instanceof Set?options:new Set(options),maps=item.actor?.synthetics.multipleAttackPenalties??{},fromSynthetics=domains.flatMap(d=>maps[d]??[]).filter(p=>p.predicate.test(optionSet)).map(p=>({slug:baseMap.slug,label:p.label,map1:p.penalty,map2:p.penalty*2}));return[baseMap,...fromSynthetics].reduce((lowest,p)=>p.map1>lowest.map1?p:lowest)}__name(calculateMAPs,"calculateMAPs"),__name2(calculateMAPs,"calculateMAPs");function createEncounterRollOptions(actor){const encounter=game.ready?game.combat:null;if(!encounter?.started)return{};const participants=encounter.combatants.contents.filter(c=>typeof c.initiative=="number").sort((a,b)=>b.initiative-a.initiative),participant=actor.combatant;if(typeof participant?.initiative!="number"||!participants.includes(participant))return{};const initiativeRoll=Math.trunc(participant.initiative),initiativeRank=participants.indexOf(participant)+1,{initiativeStatistic}=participant.flags.pf2e,threat=encounter.metrics?.threat,numericThreat={trivial:0,low:1,moderate:2,severe:3,extreme:4}[threat??"trivial"],entries=[["encounter",!0],[`encounter:threat:${numericThreat}`,!!threat],[`encounter:threat:${threat}`,!!threat],[`encounter:round:${encounter.round}`,!0],[`encounter:turn:${Number(encounter.turn)+1}`,!0],["self:participant:own-turn",encounter.combatant===participant],[`self:participant:initiative:roll:${initiativeRoll}`,!0],[`self:participant:initiative:rank:${initiativeRank}`,!0],[`self:participant:initiative:stat:${initiativeStatistic}`,!!initiativeStatistic]].filter(([,value])=>!!value);return Object.fromEntries(entries)}__name(createEncounterRollOptions,"createEncounterRollOptions"),__name2(createEncounterRollOptions,"createEncounterRollOptions");function createEnvironmentRollOptions(actor){const toAdd=new Set;for(const terrain of canvas.scene?.flags.pf2e.environmentTypes??[])toAdd.add(terrain);const token=actor.getActiveTokens(!1,!0).at(0),terrains=(()=>{if(!token)return new Set;const toRemove=new Set;for(const region of token.regions??[]){const bottom=region.elevation.bottom??-1/0,top=region.elevation.top??1/0;if(token.elevation<bottom||token.elevation>top)continue;const environmentBehaviors=region.behaviors.filter(b=>!b.disabled&&b.type==="environment");for(const behavior of environmentBehaviors){const system2=behavior.system;switch(system2.mode){case"add":{for(const terrain of system2.environmentTypes)toAdd.add(terrain);break}case"remove":{for(const terrain of system2.environmentTypes)toRemove.add(terrain);break}case"override":{toAdd.clear(),toRemove.clear();for(const terrain of system2.environmentTypes)toAdd.add(terrain);break}}}}for(const terrain of toRemove)toAdd.delete(terrain);return toAdd})();return Object.fromEntries(terrains.map(t2=>[`terrain:${t2}`,!0]))}__name(createEnvironmentRollOptions,"createEnvironmentRollOptions"),__name2(createEnvironmentRollOptions,"createEnvironmentRollOptions");function isOffGuardFromFlanking(target,origin){if(!target.isOfType("creature")||!target.attributes.flanking.flankable)return!1;const flanking=target.attributes.flanking,rollOptions=["item:type:condition","item:slug:off-guard",...origin.getSelfRollOptions("origin")];return(typeof flanking.offGuardable=="number"?origin.level>flanking.offGuardable:flanking.offGuardable)&&!target.attributes.immunities.some(i=>i.test(rollOptions))}__name(isOffGuardFromFlanking,"isOffGuardFromFlanking"),__name2(isOffGuardFromFlanking,"isOffGuardFromFlanking");function getStrikeAttackDomains(weapon,proficiencyRank,baseRollOptions){const unarmedOrWeapon=weapon.category==="unarmed"?"unarmed":"weapon",meleeOrRanged=weapon.isMelee?"melee":"ranged",weaponSlug=weapon.slug??sluggify(weapon.name),domains=[weapon.baseType?`${weapon.baseType}-base-attack-roll`:[],weapon.group?`${weapon.group}-group-attack-roll`:[],weapon.system.traits.otherTags.map(t2=>`${t2}-tag-attack-roll`),`${weapon.id}-attack`,`${weaponSlug}-attack`,`${weaponSlug}-attack-roll`,`${unarmedOrWeapon}-attack-roll`,`${meleeOrRanged}-attack-roll`,`${meleeOrRanged}-strike-attack-roll`,"strike-attack-roll","attack-roll","attack","check","all"].flat();if(typeof proficiencyRank=="number"){const proficiencies=["untrained","trained","expert","master","legendary"];domains.push(`${proficiencies[proficiencyRank]}-attack`)}const actor=weapon.actor;if(actor.isOfType("character","npc")){const defaultAttributeModifier=createAttributeModifier({actor,attribute:weapon.defaultAttribute,domains}),rollOptions=[...baseRollOptions,actor.getRollOptions(domains),weapon.getRollOptions("item")].flat(),weaponTraits2=weapon.traits,alternativeAttributeModifier=actor.isOfType("character")?weaponTraits2.has("finesse")?createAttributeModifier({actor,attribute:"dex",domains}):weaponTraits2.has("brutal")?createAttributeModifier({actor,attribute:"str",domains}):null:null,attributeModifier=[defaultAttributeModifier,alternativeAttributeModifier,...extractModifiers(weapon.actor.synthetics,domains,{resolvables:{weapon},test:rollOptions})].filter(m=>m?.type==="ability"&&m.enabled).reduce((best,candidate)=>candidate.modifier>best.modifier?candidate:best);domains.push(`${attributeModifier.ability}-attack`,`${attributeModifier.ability}-based`)}return n(domains)}__name(getStrikeAttackDomains,"getStrikeAttackDomains"),__name2(getStrikeAttackDomains,"getStrikeAttackDomains");function getAttackDamageDomains(weapon,proficiencyRank,action2){action2??=weapon.isOfType("melee")?weapon.system.action:"strike";const meleeOrRanged=weapon.isMelee?"melee":"ranged",slug=weapon.slug??sluggify(weapon.name),{actor,group}=weapon,traits=weapon.system.traits.value,baseType=CONFIG.PF2E.equivalentWeapons[weapon.baseType??""]??weapon.baseType,unarmedOrWeapon=traits.includes("unarmed")?"unarmed":"weapon",domains=[`${weapon.id}-damage`,`${slug}-damage`,`${meleeOrRanged}-${action2}-damage`,`${meleeOrRanged}-damage`,`${unarmedOrWeapon}-damage`,group?`${group}-weapon-group-damage`:null,baseType?`${baseType}-base-damage`:null,"attack-damage",`${action2}-damage`,"damage"].filter(e$1);if(weapon.baseType&&domains.push(`${weapon.baseType}-base-type-damage`),typeof proficiencyRank=="number"){const proficiencies=["untrained","trained","expert","master","legendary"];domains.push(`${proficiencies[proficiencyRank]}-damage`)}if(baseType&&!domains.includes(`${baseType}-damage`)&&domains.push(`${baseType}-damage`),actor.isOfType("character","npc")){const attributeModifier=[weapon.isMelee||traits.includes("propulsive")||weapon.isThrown&&!traits.includes("splash")&&!["alchemical-bomb","grenade"].includes(baseType??"")?createAttributeModifier({actor,attribute:"str",domains}):null,...extractModifiers(actor.synthetics,domains,{resolvables:{weapon},test:[...actor.getRollOptions(domains),...weapon.getRollOptions("item")]}).filter(m=>!m.ignored&&m.type==="ability")].reduce((best,candidate)=>candidate&&best?candidate.value>best.value?candidate:best:candidate??best);attributeModifier&&domains.push(`${attributeModifier.ability}-damage`)}return n(domains)}__name(getAttackDamageDomains,"getAttackDamageDomains"),__name2(getAttackDamageDomains,"getAttackDamageDomains");function attackFromMeleeItem(item){if(!["hazard","npc"].includes(item.actor.type))throw ErrorPF2e("Attempted to create melee-item strike statistic for non-NPC/hazard");return item.system.action==="strike"?strikeFromMeleeItem(item):areaFireFromMeleeItem(item)}__name(attackFromMeleeItem,"attackFromMeleeItem"),__name2(attackFromMeleeItem,"attackFromMeleeItem");function strikeFromMeleeItem(item){const actor=item.actor,meleeOrRanged=item.isMelee?"melee":"ranged",baseOptions=["self:action:slug:strike",meleeOrRanged,...item.system.traits.value],domains=getStrikeAttackDomains(item,actor.isOfType("npc")?1:null,baseOptions),synthetics=actor.synthetics,modifiers=[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:item.attackModifier,adjustments:extractModifierAdjustments(synthetics.modifierAdjustments,domains,"base")})];modifiers.push(...extractModifiers(synthetics,domains)),modifiers.push(...AttackTraitHelpers.createAttackModifiers({item,domains}));const attackEffects=CONFIG.PF2E.attackEffects,additionalEffects=item.attackEffects.map(tag=>{const items=actor.items.contents,label=attackEffects[tag]??items.find(i=>(i.slug??sluggify(i.name))===tag)?.name??tag;return{tag,label}});for(const adjustment of synthetics.strikeAdjustments)adjustment.adjustWeapon?.(item);const initialRollOptions=new Set([...baseOptions,...actor.getRollOptions(domains),...item.getRollOptions("item")]),attackSlug=item.slug??sluggify(item.name),statistic=new StatisticModifier(attackSlug,modifiers,initialRollOptions),actionTraits2=["attack",item.baseType==="alchemical-bomb"?"manipulate":null].filter(e$1),strikeAdjustments=[actor.synthetics.strikeAdjustments,getPropertyRuneStrikeAdjustments(item.system.runes.property)].flat();for(const adjustment of strikeAdjustments)adjustment.adjustTraits?.(item,actionTraits2);const strike=foundry.utils.mergeObject(statistic,{label:item.name,type:"strike",glyph:getActionGlyph({type:"action",value:1}),description:item.description,sourceId:item.id,attackRollType:item.isRanged?"PF2E.NPCAttackRanged":"PF2E.NPCAttackMelee",additionalEffects,item,weapon:item,canAttack:!0,options:Array.from(baseOptions),traits:[actionTraits2.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.actionTraits)),item.system.traits.value.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.npcAttackTraits))].flat(),variants:[],ready:!0,success:"",criticalSuccess:""});strike.breakdown=strike.modifiers.filter(m=>m.enabled).map(m=>`${m.label} ${m.signedValue}`).join(", ");const maps=calculateMAPs(item,{domains,options:initialRollOptions}),createMapModifier=__name2(prop2=>new Modifier({slug:maps.slug,label:maps.label,modifier:maps[prop2],adjustments:extractModifierAdjustments(synthetics.modifierAdjustments,domains,maps.slug)}),"createMapModifier"),labels=[`${game.i18n.localize("PF2E.WeaponStrikeLabel")} ${signedInteger(strike.totalModifier)}`,...["map1","map2"].map(prop2=>{const modifier=createMapModifier(prop2);modifier.applyAdjustments({rollOptions:baseOptions});const penalty=modifier.ignored?0:modifier.value;return game.i18n.format("PF2E.MAPAbbreviationValueLabel",{value:signedInteger(strike.totalModifier+penalty),penalty})})];strike.variants=[null,...["map1","map2"].map(createMapModifier)].map((map,mapIncreases)=>({label:labels[mapIncreases],roll:__name2(async(params={})=>{params.options??=[];const context=await new CheckContext({viewOnly:params.getFormula??!1,origin:{actor,statistic:strike,item},target:{token:(params.target??game.user.targets.first())?.document??null},against:"armor",domains,options:new Set([...baseOptions,...params.options]),traits:actionTraits2}).resolve();if(!context.origin)return null;if(context.origin.item?.isRanged&&typeof context.target?.distance=="number"){const maxRange=item.range?.max??10;if(context.target.distance>maxRange)return ui.notifications.warn("PF2E.Action.Strike.OutOfRange",{localize:!0}),null}const title=game.i18n.format(item.isMelee?"PF2E.Action.Strike.MeleeLabel":"PF2E.Action.Strike.RangedLabel",{weapon:item.name}),notes=[actor.isOfType("npc")?await actor.getAttackEffects(item):[],extractNotes(context.origin.actor.synthetics.rollNotes,domains)].flat(),rollTwice=params.rollTwice||extractRollTwice(context.origin.actor.synthetics.rollTwice,domains,context.options),substitutions=extractRollSubstitutions(context.origin.actor.synthetics.rollSubstitutions,domains,context.options),dosAdjustments=extractDegreeOfSuccessAdjustments(context.origin.actor.synthetics,domains),allModifiers=[map,params.modifiers,context.origin.modifiers].flat().filter(e$1),check=new CheckModifier("strike",context.origin.statistic??strike,allModifiers),checkContext={type:"attack-roll",identifier:`${item.id}.${attackSlug}.${meleeOrRanged}`,action:"strike",title,actor:context.origin.actor,token:context.origin.token,item:context.origin.item,origin:context.origin,target:context.target,damaging:context.origin.item.dealsDamage,domains,options:context.options,traits:context.traits,notes,dc:params.dc??context.dc,mapIncreases,rollTwice,substitutions,dosAdjustments,createMessage:params.createMessage??!0},roll=await Check.roll(check,checkContext,params.event);if(roll)for(const rule of context.origin.actor.rules.filter(r2=>!r2.ignored))await rule.afterRoll?.({roll,check,context:checkContext,domains,rollOptions:context.options});return roll},"roll")})),strike.roll=strike.attack=strike.variants[0].roll;const damageRoll=createDamageRollFunctions(item,{action:"strike",statistic:strike,baseOptions,actionTraits:actionTraits2,proficiencyRank:1});return strike.damage=damageRoll.damage,strike.critical=damageRoll.critical,strike}__name(strikeFromMeleeItem,"strikeFromMeleeItem"),__name2(strikeFromMeleeItem,"strikeFromMeleeItem");function areaFireFromMeleeItem(item){if(item.system.action==="strike")throw ErrorPF2e("Unexpected action type");const action2=item.system.action,actor=item.actor,attackSlug=item.slug??sluggify(item.name),meleeOrRanged=item.isMelee?"melee":"ranged",domains=["all",`${action2}-dc`],baseOptions=[`self:action:slug:${action2}`,meleeOrRanged,...item.system.traits.value,"area-damage","area-effect"],synthetics=actor.synthetics,modifiers=[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:item.attackModifier,adjustments:extractModifierAdjustments(synthetics.modifierAdjustments,domains,"base")}),...extractModifiers(synthetics,domains)],attackEffects=CONFIG.PF2E.attackEffects,additionalEffects=item.attackEffects.map(tag=>{const items=actor.items.contents,label=attackEffects[tag]??items.find(i=>(i.slug??sluggify(i.name))===tag)?.name??tag;return{tag,label}}),actionCost={type:"action",value:item.system.traits.value.includes("consumable")?1:2},identifier=`${item.id}.${attackSlug}.${action2}`,statistic=new Statistic(actor,{domains,slug:attackSlug,label:item.name,modifiers});return{slug:attackSlug,type:action2,attackRollType:NPC_ATTACK_ACTIONS[action2],label:item.name,glyph:getActionGlyph(actionCost),description:item.description,ready:!0,canAttack:!0,modifiers:[],item,statistic,additionalEffects,traits:[["attack"].map(t2=>traitSlugToObject(t2,CONFIG.PF2E.actionTraits)),item.system.traits.value.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.npcAttackTraits))].flat(),variants:[{label:game.i18n.format("PF2E.ActionWithDC",{label:game.i18n.localize(NPC_ATTACK_ACTIONS[action2]),dc:statistic.dc.value}),roll:__name2(()=>{if(!item.system.area)throw ErrorPF2e("Unexpected missing area data");createAreaAttackMessage({actor,item,statistic,action:action2,identifier,actionCost,options:baseOptions,area:item.system.area})},"roll")}],...createDamageRollFunctions(item,{action:action2,statistic,baseOptions,actionTraits:["attack"],proficiencyRank:1})}}__name(areaFireFromMeleeItem,"areaFireFromMeleeItem"),__name2(areaFireFromMeleeItem,"areaFireFromMeleeItem");function createDamageRollFunctions(item,{action:action2,statistic,actionTraits:actionTraits2,baseOptions,proficiencyRank}){const actor=item.actor,createDamageRoll=__name2(outcome=>async(params={})=>{const domains=getAttackDamageDomains(item,proficiencyRank,action2),targetToken=(params.target??game.user.targets.first())?.document??null,context=await new DamageContext({viewOnly:params.getFormula??!1,origin:{actor,statistic,item},target:{token:targetToken},domains,checkContext:params.checkContext,outcome,traits:actionTraits2,options:new Set([...baseOptions,...params.options??[]])}).resolve();if(!context.origin)return null;if(!context.origin.item.dealsDamage&&!params.getFormula)return ui.notifications.warn("PF2E.ErrorMessage.WeaponNoDamage",{localize:!0}),null;const damageContext={type:"damage-roll",sourceType:action2==="strike"?"attack":"save",self:context.origin,target:context.target,outcome,options:context.options,domains,traits:context.traits,createMessage:params.createMessage??!0,...eventToRollParams(params.event,{type:"damage"})};typeof params.mapIncreases=="number"&&(damageContext.mapIncreases=params.mapIncreases,damageContext.options.add(`map:increases:${params.mapIncreases}`)),params.getFormula&&(damageContext.skipDialog=!0);const damage=item.isOfType("melee")?await WeaponDamagePF2e.fromNPCAttack({attack:item,actor:context.origin.actor,context:damageContext}):await WeaponDamagePF2e.calculate({weapon:item,actor:context.origin.actor,weaponPotency:item.flags.pf2e.attackItemBonus,context:damageContext});if(!damage)return null;if(params.getFormula){const formula=damage.damage.formula[outcome];return formula?new DamageRoll(formula).formula:""}else return DamagePF2e.roll(damage,damageContext,params.callback)},"createDamageRoll");return{damage:createDamageRoll("success"),critical:createDamageRoll("criticalSuccess")}}__name(createDamageRollFunctions,"createDamageRollFunctions"),__name2(createDamageRollFunctions,"createDamageRollFunctions");async function createAreaAttackMessage({action:action2,actor,item,statistic,identifier,actionCost,options,area}){const dc=statistic.dc,key=sluggify(action2,{camel:"bactrian"}),title=game.i18n.localize(`PF2E.Actions.${key}.Title`),description=game.i18n.localize(`PF2E.Actions.${key}.Description`),token=actor.getActiveTokens(!1,!0).shift(),speaker=ChatMessagePF2e.getSpeaker({actor,token}),glyph=getActionGlyph(actionCost),flavor=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{title,glyph},item,traits:[traitSlugToObject("attack",CONFIG.PF2E.actionTraits)]}),content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/area-fire.hbs",{actor,description,saveLabel:game.i18n.format("PF2E.SaveDCLabelBasic",{dc:dc.value,type:game.i18n.localize(CONFIG.PF2E.saves.reflex)}),areaLabel:createEffectAreaLabel(area),saveBreakdown:dc.breakdown}),context={type:action2,area,identifier,domains:dc.domains,options};await ChatMessagePF2e.create({flavor,content,speaker,flags:{pf2e:{context,origin:item.getOriginData()}}})}__name(createAreaAttackMessage,"createAreaAttackMessage"),__name2(createAreaAttackMessage,"createAreaAttackMessage");function getRangeIncrement(attackItem,distance){if(!attackItem.isOfType("action","melee","weapon"))return null;const{increment:increment2}=attackItem.range??{};return increment2&&typeof distance=="number"?Math.max(Math.ceil(distance/increment2),1):null}__name(getRangeIncrement,"getRangeIncrement"),__name2(getRangeIncrement,"getRangeIncrement");function calculateRangePenalty(actor,increment2,selectors,rollOptions){if(!increment2||increment2===1)return null;const slug="range-penalty",modifier=new Modifier({label:"PF2E.RangePenalty",slug,type:"untyped",modifier:Math.max((increment2-1)*-2,-12),predicate:[{nor:["ignore-range-penalty",{gte:["ignore-range-penalty",increment2]}]}],adjustments:extractModifierAdjustments(actor.synthetics.modifierAdjustments,selectors,slug)});return modifier.test(rollOptions),modifier}__name(calculateRangePenalty,"calculateRangePenalty"),__name2(calculateRangePenalty,"calculateRangePenalty");function isReallyPC(actor){const traits=actor.system.traits?.value??[];return actor.isOfType("character")&&!["eidolon","minion"].some(t2=>traits.includes(t2))}__name(isReallyPC,"isReallyPC"),__name2(isReallyPC,"isReallyPC");function*iterateAllItems(document2){const collection=document2 instanceof Actor?document2.items:document2.subitems;for(const item of collection??[])if(yield item,item.isOfType("physical"))for(const subitem of iterateAllItems(item))yield subitem}__name(iterateAllItems,"iterateAllItems"),__name2(iterateAllItems,"iterateAllItems");async function transferItemsBetweenActors(source2,dest,itemFilterFn){const newItems=[],itemUpdates=new Map,itemsToDelete=[];for(const item of source2.inventory){const stackableItem=dest.inventory.findStackableItem(item);if(stackableItem){const currentQuantity=itemUpdates.get(stackableItem.id)??stackableItem.quantity;itemUpdates.set(stackableItem.id,currentQuantity+item.quantity),itemsToDelete.push(item.id);continue}newItems.push(item),itemsToDelete.push(item.id)}if(newItems.length>0){const sources=newItems.reduce((result,item)=>{const stackableItem=result.find(i=>i.isStackableWith(item));return stackableItem?stackableItem.updateSource({system:{quantity:stackableItem.quantity+item.quantity}}):result.push(item),result},[]).map(i=>i.toObject());await dest.createEmbeddedDocuments("Item",sources,{render:itemUpdates.size===0})}if(itemUpdates.size>0){const updates=[...itemUpdates.entries()].map(([id,quantity])=>({_id:id,system:{quantity}}));await dest.updateEmbeddedDocuments("Item",updates)}itemsToDelete.length>0&&await source2.deleteEmbeddedDocuments("Item",itemsToDelete)}__name(transferItemsBetweenActors,"transferItemsBetweenActors"),__name2(transferItemsBetweenActors,"transferItemsBetweenActors");function createActorGroupUpdate(data={}){return{actorUpdates:{},itemCreates:[],itemUpdates:[],itemDeletes:[],...data}}__name(createActorGroupUpdate,"createActorGroupUpdate"),__name2(createActorGroupUpdate,"createActorGroupUpdate");async function applyActorGroupUpdate(actor,data,{render=!0,keepId}={}){const actorUpdates=data.actorUpdates&&!e$4(data.actorUpdates)?data.actorUpdates:null,itemCreates=data.itemCreates??[],itemUpdates=data.itemUpdates??[],itemDeletes=data.itemDeletes??[],lastRender=render?itemDeletes.length?"delete":itemUpdates.length?"update":itemCreates.length?"create":"actorUpdate":null;actorUpdates&&await actor.update(actorUpdates,{render:lastRender==="actorUpdate"}),itemCreates.length>0&&await actor.createEmbeddedDocuments("Item",itemCreates,{render:lastRender==="create",keepId}),itemUpdates.length>0&&await actor.updateEmbeddedDocuments("Item",itemUpdates,{render:lastRender==="update"}),itemDeletes.length>0&&await actor.deleteEmbeddedDocuments("Item",itemDeletes,{render:lastRender==="delete"})}__name(applyActorGroupUpdate,"applyActorGroupUpdate"),__name2(applyActorGroupUpdate,"applyActorGroupUpdate");class RegionBehaviorPF2e extends RegionBehavior{static{__name(this,"RegionBehaviorPF2e")}static{__name2(this,"RegionBehaviorPF2e")}_onUpdate(data,options,userId){if(this.viewed&&this.type==="environment"){const system2=data.system??{};if(system2.environmentTypes||system2.mode){const tokens=[...this.region?.tokens??[]];resetActors(tokens.flatMap(t2=>t2.actor??[]),{tokens:!0})}}return super._onUpdate(data,options,userId)}}class EnvironmentFeatureBehaviorType extends foundry.data.regionBehaviors.RegionBehaviorType{static{__name(this,"EnvironmentFeatureBehaviorType")}static{__name2(this,"EnvironmentFeatureBehaviorType")}static defineSchema(){const fields2=foundry.data.fields,locPathPrefix="PF2E.Region.EnvironmentFeature";return{terrain:new fields2.SchemaField({difficult:new fields2.NumberField({required:!0,nullable:!1,choices:{0:`${locPathPrefix}.Terrain.Difficult.None`,1:`${locPathPrefix}.Terrain.Difficult.Difficult`,2:`${locPathPrefix}.Terrain.Difficult.Greater`},initial:0,label:`${locPathPrefix}.Terrain.Difficult.Label`})},{label:`${locPathPrefix}.Terrain.Label`})}}}class EnvironmentBehaviorType extends foundry.data.regionBehaviors.RegionBehaviorType{static{__name(this,"EnvironmentBehaviorType")}static{__name2(this,"EnvironmentBehaviorType")}events=new Set(["tokenEnter","tokenExit"]);static defineSchema(){const fields2=foundry.data.fields;return{environmentTypes:new fields2.SetField(new fields2.StringField({required:!0,blank:!0,choices:__name2(()=>CONFIG.PF2E.environmentTypes,"choices")}),{label:"PF2E.Region.Environment.Type.Label",hint:"PF2E.Region.Environment.Type.Hint"}),mode:new fields2.StringField({required:!0,blank:!1,choices:__name2(()=>({add:"PF2E.Region.Environment.Mode.Add.Label",override:"PF2E.Region.Environment.Mode.Override.Label",remove:"PF2E.Region.Environment.Mode.Remove.Label"}),"choices"),initial:"add",label:"PF2E.Region.Environment.Mode.Label",hint:"PF2E.Region.Environment.Mode.Hint"})}}async _handleRegionEvent(event2){(event2.name==="tokenEnter"||event2.name==="tokenExit")&&event2.data.token.actor&&resetActors([event2.data.token.actor],{tokens:!0})}}class RegionDocumentPF2e extends RegionDocument{static{__name(this,"RegionDocumentPF2e")}static{__name2(this,"RegionDocumentPF2e")}get x(){return this.shapes.reduce((leftMost,shape)=>"x"in shape&&typeof shape.x=="number"?shape.x<leftMost?shape.x:leftMost:"points"in shape&&Array.isArray(shape.points)?shape.points.find((p,index2)=>p<leftMost&&index2%2===0)??leftMost:0,canvas.dimensions.maxR)}get y(){return this.shapes.reduce((topMost,shape)=>"y"in shape&&typeof shape.y=="number"?shape.y<topMost?shape.y:topMost:"points"in shape&&Array.isArray(shape.points)?shape.points.find((coord,index2)=>coord<topMost&&index2%2===1)??topMost:0,canvas.dimensions.maxR)}set x(value){const difference=value-this.x;for(const shape of this.shapes)"x"in shape&&typeof shape.x=="number"?shape.x+=difference:"points"in shape&&Array.isArray(shape.points)&&shape.points.forEach((coordinate,index2)=>{index2%2===0&&(shape.points[index2]=coordinate+difference)})}set y(value){const difference=value-this.y;for(const shape of this.shapes)"y"in shape&&typeof shape.y=="number"?shape.y+=difference:"points"in shape&&Array.isArray(shape.points)&&shape.points.forEach((coordinate,index2)=>{index2%2===1&&(shape.points[index2]=coordinate+difference)})}}class TileDocumentPF2e extends TileDocument{static{__name(this,"TileDocumentPF2e")}static{__name2(this,"TileDocumentPF2e")}}class AmbientLightPF2e extends foundry.canvas.placeables.AmbientLight{static{__name(this,"AmbientLightPF2e")}static{__name2(this,"AmbientLightPF2e")}}class EffectsCanvasGroupPF2e extends foundry.canvas.groups.EffectsCanvasGroup{static{__name(this,"EffectsCanvasGroupPF2e")}static{__name2(this,"EffectsCanvasGroupPF2e")}get rulesBasedVision(){return game.pf2e.settings.rbv&&canvas.ready&&!!canvas.scene?.tokenVision}}const dayInSeconds=Duration.fromObject({hours:24}).as("seconds");function darknessLevelAtTime(time){const secondsElapsed=time.diff(time.startOf("day")).as("seconds"),radians=2*Math.PI*(secondsElapsed/dayInSeconds),lightnessLevel=-1*Math.cos(radians),rad18degrees=Math.toRadians(18);return 1-(lightnessLevel>0?1:lightnessLevel<-rad18degrees?0:Math.sin((lightnessLevel+rad18degrees)/rad18degrees*Math.PI/2))}__name(darknessLevelAtTime,"darknessLevelAtTime"),__name2(darknessLevelAtTime,"darknessLevelAtTime");function intervalToTransition(interval,compactInterval){const currentDarkness=canvas.darknessLevel,targetDarkness=interval.end?darknessLevelAtTime(interval.end):NaN,darknessDiff=Math.abs((currentDarkness??targetDarkness)-targetDarkness),proportionOfDay=compactInterval.length("seconds")/dayInSeconds,darkTimeMean=(darknessDiff*.5+proportionOfDay)/2;return{target:targetDarkness,duration:darkTimeMean*6e3,interval}}__name(intervalToTransition,"intervalToTransition"),__name2(intervalToTransition,"intervalToTransition");async function runAnimation(transition2){if(!canvas.lighting||canvas.darknessLevel===transition2.target)return;const duration=Math.min(Math.trunc(100*transition2.duration)/100,6e3);await canvas.effects.animateDarkness(transition2.target,{duration}),game.user.isGM&&await canvas.scene.update({darkness:transition2.target})}__name(runAnimation,"runAnimation"),__name2(runAnimation,"runAnimation");async function animateDarkness(timeDiff){if(!this.syncDarkness)return;const newTime=this.worldTime,oldTime=newTime.minus({seconds:timeDiff}),fullInterval=Interval.fromDateTimes(oldTime,newTime);if(!fullInterval.isValid){await runAnimation({target:darknessLevelAtTime(newTime),duration:100});return}const compactInterval=(()=>{if(fullInterval.length("hours")>24){const adjustedOldTime=newTime.minus({hours:24});return Interval.fromDateTimes(adjustedOldTime,newTime)}return fullInterval})(),transitionTimes=[4.75,18].map(hour=>compactInterval.start.set({hour,minute:0,second:0})).concat([4.75,18].map(hour=>compactInterval.end.set({hour,minute:0,second:0}))).filter(dateTime=>compactInterval.contains(dateTime)).concat([compactInterval.start,compactInterval.end]).sort((dtA,dtB)=>dtA<dtB?-1:dtA>dtB?1:0),transitions=transitionTimes.reduce((pairs,dateTime)=>{const index2=transitionTimes.indexOf(dateTime);if(index2===0)return[];const before=transitionTimes[index2-1];return[...pairs,[before,dateTime]]},[]).map(pair=>Interval.fromDateTimes(pair[0],pair[1])).filter(interval=>interval.length()>0).map(interval=>intervalToTransition(interval,compactInterval));for(const transition2 of transitions)await runAnimation(transition2)}__name(animateDarkness,"animateDarkness"),__name2(animateDarkness,"animateDarkness");var TimeChangeMode=(TimeChangeMode2=>(TimeChangeMode2[TimeChangeMode2.ADVANCE=0]="ADVANCE",TimeChangeMode2[TimeChangeMode2.RETRACT=1]="RETRACT",TimeChangeMode2))(TimeChangeMode||{});class TimeOfDay{static{__name(this,"TimeOfDay")}static{__name2(this,"TimeOfDay")}constructor(hour,minute,second){this.hour=hour,this.minute=minute,this.second=second}static DAWN=new TimeOfDay(4,58,54);static NOON=new TimeOfDay(12,0,0);static DUSK=new TimeOfDay(18,34,6);static MIDNIGHT=new TimeOfDay(0,0,0);diffSeconds(worldTime,mode){const targetTime=worldTime.set(this),targetDayDifference=TimeOfDay.diffDays(worldTime,targetTime,mode);return worldTime.plus({day:targetDayDifference}).set(this).diff(worldTime,"seconds").seconds}static diffDays(currentTime,targetTime,mode){return currentTime>=targetTime&&mode===0?1:currentTime<=targetTime&&mode===1?-1:0}}class WorldClock extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"WorldClock")}static{__name2(this,"WorldClock")}constructor(){super(),this.#initialize()}static DEFAULT_OPTIONS={id:"world-clock",position:{width:400},window:{contentClasses:["standard-form"],title:"PF2E.WorldClock.Title"},actions:{advanceTime:WorldClock.#onClickAdvanceTime,advanceOrRetract:WorldClock.#onClickAdvanceOrRetract,openSettings:__name2(()=>{const menu=game.settings.menus.get("pf2e.worldClock");if(!menu)throw ErrorPF2e("PF2e System | World Clock Settings application not found");new menu.type().render(!0)},"openSettings")}};static PARTS={base:{template:"systems/pf2e/templates/system/world-clock.hbs",root:!0}};#ctrlKeyDown=!1;animateDarkness=animateDarkness;#controlKeyHandler=__name2(event2=>{const html2=this.element,CONTROL_KEY_STRING=foundry.helpers.interaction.KeyboardManager.CONTROL_KEY_STRING,ctrlKey=CONTROL_KEY_STRING==="\u2318"?"Meta":"Control";if(event2.repeat||ctrlKey!==event2.key||!((CONTROL_KEY_STRING==="\u2318"?event2.metaKey:event2.ctrlKey)||this.#ctrlKeyDown))return;const retractTime=this.#ctrlKeyDown=event2.type==="keydown",{Advance,Retract,TimeOfDay:TimeOfDay2}=CONFIG.PF2E.worldClock.Button,advanceButtons=Array.from(html2.querySelectorAll("button[data-advance-time]")??[]);for(const button of advanceButtons){const{advanceMode,advanceTime}=button.dataset,nextMode=advanceMode==="+"?"-":"+";button.dataset.advanceMode=nextMode;const sign=button.querySelector(".sign");if(sign&&(sign.innerHTML=nextMode),tupleHasValue(["dawn","noon","dusk","midnight"],advanceTime)){const timeOfDayKeys=nextMode==="+"?TimeOfDay2.Advance:TimeOfDay2.Retract;button.title=timeOfDayKeys[advanceTime.titleCase()]}}const advanceOrRetract=html2.querySelector("button[name=advance], button[name=retract]");advanceOrRetract&&(advanceOrRetract.name=retractTime?"retract":"advance",advanceOrRetract.innerText=game.i18n.localize(retractTime?Retract:Advance))},"#controlKeyHandler");get dateTheme(){return game.pf2e.settings.worldClock.dateTheme}get timeConvention(){const setting=game.pf2e.settings.worldClock.timeConvention;if(setting!==24&&setting!==12)throw Error("PF2e System | Unrecognized time convention");return setting}get syncDarkness(){const sceneSetting=canvas.scene?.flags.pf2e.syncDarkness??"default";return{enabled:!0,disabled:!1,default:game.pf2e.settings.worldClock.syncDarkness}[sceneSetting]}get worldCreatedOn(){const value=game.pf2e.settings.worldClock.worldCreatedOn;return DateTime.fromISO(value??"").toUTC()}get worldTime(){return this.worldCreatedOn.plus({seconds:game.time.worldTime})}get era(){switch(this.dateTheme){case"AR":case"IC":return game.i18n.localize(CONFIG.PF2E.worldClock[this.dateTheme].Era);case"AD":return this.worldTime.toFormat("G");default:return""}}get year(){return this.worldTime.year+CONFIG.PF2E.worldClock[this.dateTheme].yearOffset}get month(){switch(this.dateTheme){case"AR":case"IC":{const months=CONFIG.PF2E.worldClock.AR.Months,month=this.worldTime.setLocale("en-US").monthLong;return game.i18n.localize(months[month])}default:return this.worldTime.monthLong}}get weekday(){switch(this.dateTheme){case"AR":case"IC":{const weekdays=CONFIG.PF2E.worldClock.AR.Weekdays,weekday=this.worldTime.setLocale("en-US").weekdayLong;return game.i18n.localize(weekdays[weekday])}default:return this.worldTime.weekdayLong}}static#onClickAdvanceTime(_event,button){const advanceTime=button.dataset.advanceTime??"0",advanceMode=button.dataset.advanceMode??"+",increment2=WorldClock.#calculateIncrement(this.worldTime,advanceTime,advanceMode);increment2!==0&&game.time.advance(increment2)}static#onClickAdvanceOrRetract(_event,button){const html2=this.element,value=htmlQuery(html2,"input[type=number][name=diff-value]")?.value,unit=htmlQuery(html2,"select[name=diff-unit]")?.value,increment2=(button.name==="advance"?1:-1)*Number(value)*Number(unit);game.time.advance(increment2)}#initialize(){const setting=game.pf2e.settings.worldClock,defaults=game.settings.settings.get("pf2e.worldClock")?.default;if(!e$2(defaults))throw ErrorPF2e("Unexpected failure to find setting");setting.worldCreatedOn===null&&game.settings.set("pf2e","worldClock",{...setting,worldCreatedOn:DateTime.utc().toISO()})}async _prepareContext(options){const date=this.dateTheme==="CE"?this.worldTime.toLocaleString(DateTime.DATE_HUGE):game.i18n.format(CONFIG.PF2E.worldClock.Date,{era:this.era,year:this.year,month:this.month,day:ordinalString(this.worldTime.day),weekday:this.weekday}),time=this.timeConvention===24?this.worldTime.toFormat("HH:mm:ss"):this.worldTime.toLocaleString(DateTime.TIME_WITH_SECONDS),sign=this.#ctrlKeyDown?"-":"+";return{date,time,options,user:game.user,sign}}_getHeaderControls(){const controls=super._getHeaderControls();return controls.push({action:"openSettings",icon:"fa-solid fa-gear",label:"PF2E.SETTINGS.Settings",visible:game.user.isGM}),controls}static#calculateIncrement(wordTime,interval,intervalMode){const mode=intervalMode==="+"?TimeChangeMode.ADVANCE:TimeChangeMode.RETRACT;switch(interval){case"dawn":return TimeOfDay.DAWN.diffSeconds(wordTime,mode);case"noon":return TimeOfDay.NOON.diffSeconds(wordTime,mode);case"dusk":return TimeOfDay.DUSK.diffSeconds(wordTime,mode);case"midnight":return TimeOfDay.MIDNIGHT.diffSeconds(wordTime,mode);default:{const sign=mode===TimeChangeMode.ADVANCE?1:-1;return Number(interval)*sign}}}async _onRender(context,options){await super._onRender(context,options),document.removeEventListener("keydown",this.#controlKeyHandler),document.addEventListener("keydown",this.#controlKeyHandler),document.removeEventListener("keyup",this.#controlKeyHandler),document.addEventListener("keyup",this.#controlKeyHandler)}async _onClose(options){return document.removeEventListener("keydown",this.#controlKeyHandler),document.removeEventListener("keyup",this.#controlKeyHandler),super._onClose(options)}static createSyncedMessage(){const managedBy=document.createElement("span");managedBy.classList.add("managed"),managedBy.innerHTML=" ".concat(game.i18n.localize("PF2E.Scene.SyncDarkness.ManagedBy"));const anchor=document.createElement("a"),wtLink=managedBy.querySelector("wt");return anchor.innerText=wtLink?.innerHTML??"",anchor.setAttribute("href",""),anchor.addEventListener("click",event2=>{event2.preventDefault(),event2.stopPropagation();const menu=game.settings.menus.get("pf2e.worldClock");if(!menu)throw ErrorPF2e("World Clock Settings application not found");new menu.type().render(!0)}),wtLink?.replaceWith(anchor),managedBy}}class SceneDarknessAdjuster extends foundry.applications.api.ApplicationV2{static{__name(this,"SceneDarknessAdjuster")}static{__name2(this,"SceneDarknessAdjuster")}static get instance(){return this.#instance??=new this}static#instance=null;static DEFAULT_OPTIONS={tag:"article",id:"darkness-adjuster",classes:["application"],window:{title:"CONTROLS.AdjustSceneDarkness",frame:!1,positioned:!1}};#slider;#noRefreshHook=!1;async render(options){return game.scenes.viewed?super.render(options):this}async _renderHTML(_context){if(!game.scenes.viewed)throw ErrorPF2e("Unexpected render call without viewed scene");const result=document.createElement("div");return result.className="slider",game.scenes.viewed.darknessSyncedToTime&&result.setAttribute("disabled",""),result}_replaceHTML(result,element,options){element.replaceChildren(result);const bounds=ui.controls.element?.querySelector("button[data-tool=darknessAdjuster]")?.getBoundingClientRect();if(bounds&&(element.style.left=`${bounds.right+6}px`,element.style.top=`${options.position.top=bounds.top-3}px`),this.#slider=noUiSlider.create(result,{range:{min:0,max:1},start:[.25,game.scenes.viewed?.environment.darknessLevel??0,.75],connect:[!0,!1,!1,!0],behaviour:"snap-unconstrained-snap",pips:{mode:PipsMode.Range,density:5},step:.05}),game.scenes.viewed?.darknessSyncedToTime){const synchronized=document.createElement("div");synchronized.className="message";const message=WorldClock.createSyncedMessage();synchronized.append(message),result.classList.add("synchronized"),result.append(synchronized)}}async _onRender(context,options){await super._onRender(context,options),this.#slider&&(this.#slider.target.querySelectorAll(".noUi-origin").forEach((thumb,index2)=>{(index2!==1||game.scenes.viewed?.darknessSyncedToTime)&&thumb.toggleAttribute("disabled",!0)}),this.#slider.on("slide",(values,thumbNumber)=>{thumbNumber===1&&canvas.scene&&(this.#noRefreshHook=!0,canvas.environment.initialize({environment:{darknessLevel:Number(values[1])}}),canvas.app.ticker.add(()=>{this.#noRefreshHook=!1}))}),this.#slider.on("change",async(values,thumbNumber)=>{if(canvas.scene&&thumbNumber===1){const newValue=Number(values[1]);await canvas.scene.update({darkness:newValue},{animateDarkness:Math.round(5e3*Math.abs(canvas.scene.environment.darknessLevel-newValue))})}}),this.#slider.target.querySelectorAll(".noUi-handle").forEach((handle,index2)=>{const decoration={0:["threshold_bright-light",fontAwesomeIcon("sun")],1:["darkness-level",null],2:["threshold_darkness",fontAwesomeIcon("moon",{fixedWidth:!0})]},[cssClass,icon]=decoration[index2];icon&&handle.append(icon),handle.classList.add(cssClass)}),this.#slider.target.querySelectorAll(".noUi-connect").forEach((connect,index2)=>{const classes={0:"range_bright-light",1:"range_darkness"};connect.classList.add(classes[index2])}))}onLightingRefresh(darkness){if(!this.rendered||this.#noRefreshHook)return;const sliderValues=this.#slider?.get();if(this.#slider&&Array.isArray(sliderValues)){const currentValue=sliderValues[1],stepValue=Math.round(darkness*20)/20;stepValue!==currentValue&&(sliderValues[1]=stepValue,this.#slider.set(sliderValues))}}}class LightingLayerPF2e extends foundry.canvas.layers.LightingLayer{static{__name(this,"LightingLayerPF2e")}static{__name2(this,"LightingLayerPF2e")}get lightingLevel(){return 1-canvas.darknessLevel}_deactivate(){super._deactivate(),SceneDarknessAdjuster.instance.close({})}}class TemplateLayerPF2e extends foundry.canvas.layers.TemplateLayer{static{__name(this,"TemplateLayerPF2e")}static{__name2(this,"TemplateLayerPF2e")}#previewListeners=null;async createPreview(createData){const initialLayer=canvas.activeLayer,preview=await this._createPreview({...createData,...canvas.mousePosition},{renderSheet:!1});return this.#activatePreviewListeners(preview,initialLayer),preview}getSnappedPoint(point){const template=this.preview?.children.at(0);return!template||!canvas.grid.isSquare?super.getSnappedPoint(point):canvas.grid.getSnappedPoint(point,{mode:template.snappingMode,resolution:1})}_onDragLeftMove(event2){if(!canvas.ready||!canvas.scene||!canvas.grid.isSquare)return super._onDragLeftMove(event2);const{destination,preview:template,origin}=event2.interactionData;if(!template||template.destroyed)return;if(template.document.t==="rect")return super._onDragLeftMove(event2);const dimensions=canvas.dimensions,{x,y}=canvas.grid.getSnappedPoint(destination,{mode:template.snappingMode});destination.x=x,destination.y=y;const ray=new foundry.canvas.geometry.Ray(origin,destination),ratio=dimensions.size/dimensions.distance,document2=template.document;if(["cone","circle"].includes(document2.t)){const snapAngle=Math.PI/4;document2.direction=Math.toDegrees(Math.floor((ray.angle+Math.PI*.125)/snapAngle)*snapAngle)}else document2.direction=Math.toDegrees(ray.angle);const increment2=Math.max(ray.distance/ratio,dimensions.distance);document2.distance=Math.ceil(increment2/dimensions.distance)*dimensions.distance,template.refresh()}_onMouseWheel(event2){const template=this.hover;if(!template||!canvas.scene||!canvas.grid.isSquare)return super._onMouseWheel(event2);const shapeType=template.document.t,distance=template.document.distance??5,snap=(event2.shiftKey||distance<=30?15:5)*(shapeType==="cone"?3:1),delta=snap*Math.sign(event2.deltaY);return template.rotate(template.document.direction+delta,snap)}_onDragLeftStart(event2){if(!this.#previewListeners)return super._onDragLeftStart(event2)}_onDragLeftCancel(event2){if(!this.#previewListeners)return super._onDragLeftCancel(event2)}#activatePreviewListeners(preview,initialLayer){let lastMove=Date.now();const listeners=this.#previewListeners={lockedInPlace:!1,wheelAbortController:new AbortController,mousemove:__name2(event2=>{event2.stopPropagation();const now=Date.now();if(now-lastMove<=50)return;canvas._onDragCanvasPan(event2);const destination=event2.getLocalPosition(this);if(this.#previewListeners?.lockedInPlace){const origin=preview.position,ray=new foundry.canvas.geometry.Ray(origin,destination);if(ray.distance<canvas.grid.size/4)return;if(preview.document.t==="cone"&&!(event2.ctrlKey||event2.metaKey)){const snapAngle=Math.PI/(canvas.grid.isHexagonal?6:4);preview.document.updateSource({direction:Math.toDegrees(Math.floor(ray.angle/snapAngle+.5)*snapAngle)})}else if(preview.document.t==="ray"&&!(event2.ctrlKey||event2.metaKey)){const snapAngle=.08726646259971647;preview.document.updateSource({direction:Math.toDegrees(Math.floor(ray.angle/snapAngle)*snapAngle)})}else preview.document.updateSource({direction:Math.toDegrees(ray.angle)})}else{const dx=destination.x-preview.document.x,dy=destination.y-preview.document.y;preview.document.updateSource({x:preview.document.x+dx,y:preview.document.y+dy})}preview.renderFlags.set({refresh:!0}),lastMove=now},"mousemove"),mousedown:__name2(event2=>{event2.stopPropagation();const point=this.getSnappedPoint(preview.position);preview.document.updateSource({x:point.x,y:point.y}),this.#previewListeners?.lockedInPlace||event2.shiftKey||!["ray","cone"].includes(preview.document.t)?(this.#deactivatePreviewListeners(initialLayer,event2),canvas.scene?.createEmbeddedDocuments("MeasuredTemplate",[preview.document.toObject()])):this.#previewListeners&&(this.#previewListeners.lockedInPlace=!0,preview.renderFlags.set({refresh:!0}))},"mousedown"),rightdown:__name2(event2=>{event2.stopPropagation(),this.#previewListeners?.lockedInPlace?(this.#previewListeners.lockedInPlace=!1,preview.document.updateSource({direction:0}),this.#previewListeners.mousemove(event2)):this.#deactivatePreviewListeners(initialLayer,event2)},"rightdown"),wheel:__name2(event2=>{if(!(event2 instanceof WheelEvent)||this.#previewListeners?.lockedInPlace)return;event2.preventDefault(),event2.stopPropagation();const now=Date.now();if(now-lastMove<=25)return;const{direction}=preview.document,distance=preview.document.distance??5;if(event2.ctrlKey){const snap=event2.shiftKey||distance<=30?15:5;preview.document.updateSource({direction:direction+snap*Math.sign(event2.deltaY)}),preview.renderFlags.set({refresh:!0})}else if(event2.shiftKey){const snap=canvas.grid.isHexagonal?60:45;preview.document.updateSource({direction:direction+snap*Math.sign(event2.deltaY)}),preview.renderFlags.set({refresh:!0})}lastMove=now},"wheel")};canvas.stage.on("mousemove",listeners.mousemove),canvas.stage.on("mousedown",listeners.mousedown),canvas.stage.on("rightdown",listeners.rightdown),canvas.app.view.addEventListener?.("wheel",listeners.wheel,{passive:!1,signal:listeners.wheelAbortController.signal})}#deactivatePreviewListeners(initialLayer,event2){this.#previewListeners&&(canvas.stage.off("mousemove",this.#previewListeners.mousemove),canvas.stage.off("mousedown",this.#previewListeners.mousedown),canvas.stage.off("rightdown",this.#previewListeners.rightdown),this.#previewListeners.wheelAbortController.abort(),this.#previewListeners=null),"interactionData"in event2&&this._onDragLeftCancel(event2),initialLayer!==this&&initialLayer?.activate()}}class TokenLayerPF2e extends foundry.canvas.layers.TokenLayer{static{__name(this,"TokenLayerPF2e")}static{__name2(this,"TokenLayerPF2e")}constructor(){super(),this.#hoverDistanceLine=this._rulerPaths.addChild(new PIXI.Graphics)}#hoverDistanceLine;_onClickLeft(event2){const localPosition=event2.getLocalPosition(this);if(!canvas.controls.ruler?.active&&this.hover?.canControl(game.user,event2)&&this.hover.bounds.contains(localPosition.x,localPosition.y)){this.hover.control();return}return super._onClickLeft(event2)}cycleStack(){const hovered=this.hover;if(!hovered)return!1;const bounds=hovered.mechanicalBounds,rectangle=new PIXI.Rectangle(bounds.x+1,bounds.y+1,bounds.width-2,bounds.height-2),stack=[...this.quadtree.getObjects(rectangle)].filter(t2=>t2.visible&&!t2.document.isSecret&&t2.document.elevation===hovered.document.elevation).sort((a,b)=>b.document.sort-a.document.sort);if(stack.length<2)return!1;const first=stack.shift();if(first&&stack.push(first),game.user.isGM||stack.every(t2=>t2.document.canUserModify(game.user,"update"))){const updates=stack.map((t2,i)=>({_id:t2.document.id,sort:stack.length-(1+i)}));hovered.scene?.updateEmbeddedDocuments("Token",updates)}else for(let sort=stack.length-1;sort>=0;sort--){const token=stack[sort];token.document.sort=sort,token._onUpdate({_id:token.document.id,sort},{broadcast:!1},game.user.id)}const newTop=stack.at(-1);this.hover=newTop??null;for(const token of stack)token.hover=token===newTop;return!0}refreshDistanceLine(from,to){if(this.#hoverDistanceLine.clear(),!(from&&to))return;this._rulerPaths.addChild(this._rulerPaths.removeChild(this.#hoverDistanceLine));const centers={from:from.center,to:to.center},footprints={from:from.footprint.map(o=>canvas.grid.getCenterPoint(o)).sort((a,b)=>Math.sqrt(Math.pow(a.x-centers.to.x,2)+Math.pow(a.y-centers.to.y,2))-Math.sqrt(Math.pow(b.x-centers.to.x,2)+Math.pow(b.y-centers.to.y,2))),to:to.footprint.map(o=>canvas.grid.getCenterPoint(o)).sort((a,b)=>Math.sqrt(Math.pow(a.x-centers.from.x,2)+Math.pow(a.y-centers.from.y,2))-Math.sqrt(Math.pow(b.x-centers.from.x,2)+Math.pow(b.y-centers.from.y,2)))},closest={from:footprints.from[0],to:footprints.to[0]},line=this.#hoverDistanceLine,colors={outline:0,fill:10066329};return line.moveTo(closest.from.x,closest.from.y).lineStyle({width:6*canvas.dimensions.uiScale,color:colors.outline,join:PIXI.LINE_JOIN.ROUND,cap:PIXI.LINE_CAP.ROUND}).lineTo(closest.to.x,closest.to.y).moveTo(closest.from.x,closest.from.y).lineStyle({width:4*canvas.dimensions.uiScale,color:colors.fill,join:PIXI.LINE_JOIN.ROUND,cap:PIXI.LINE_CAP.ROUND}).lineTo(closest.to.x,closest.to.y),this.#drawCap(line,closest.from,colors),this.#drawCap(line,closest.to,colors),closest.to}#drawCap(line,p,colors){return line.lineStyle(0).beginFill(colors.outline).drawCircle(p.x,p.y,7).endFill().beginFill(colors.fill).drawCircle(p.x,p.y,6).endFill()}}function measureDistanceCuboid(r0,r1,{reach=null,token=null,target=null}={}){if(canvas.grid.type!==CONST.GRID_TYPES.SQUARE)return canvas.grid.measurePath([r0,r1]).distance;const gridWidth=canvas.grid.sizeX,distance={dx:0,dy:0,dz:0};if([[r0,r1],[r1,r0]].some(([rA,rB])=>rB.right>rA.left&&rB.left<rA.right&&rB.bottom>rA.top&&rB.top<rA.bottom))distance.dx=0,distance.dy=0;else{const snapBounds=__name2((rectangle,{toward})=>{const roundLeft=rectangle.left<toward.left?Math.ceil:Math.floor,roundTop=rectangle.top<toward.top?Math.ceil:Math.floor,left=roundLeft(rectangle.left/gridWidth)*gridWidth,top=roundTop(rectangle.top/gridWidth)*gridWidth,width=Math.ceil(rectangle.width/gridWidth)*gridWidth,height=Math.ceil(rectangle.height/gridWidth)*gridWidth;return new PIXI.Rectangle(left,top,width,height)},"snapBounds"),r0Snapped=snapBounds(r0,{toward:r1}),r1Snapped=snapBounds(r1,{toward:r0});distance.dx=Math.max(r0Snapped.left-r1Snapped.right,r1Snapped.left-r0Snapped.right,0)+gridWidth,distance.dy=Math.max(r0Snapped.top-r1Snapped.bottom,r1Snapped.top-r0Snapped.bottom,0)+gridWidth}if(token&&target&&token.document.elevation!==target.document.elevation&&token.actor&&target.actor){const selfElevation=token.document.elevation,targetElevation=target.document.elevation,[selfDimensions,targetDimensions]=[token.actor.dimensions,target.actor.dimensions],gridSize=canvas.dimensions.size,gridDistance=canvas.dimensions.distance,elevation0=Math.floor(selfElevation/gridDistance*gridSize),height0=Math.floor(selfDimensions.height/gridDistance*gridSize),elevation1=Math.floor(targetElevation/gridDistance*gridSize),height1=Math.floor(targetDimensions.height/gridDistance*gridSize),xzPlane={self:new PIXI.Rectangle(r0.x,elevation0,r0.width,height0),target:new PIXI.Rectangle(r1.x,elevation1,r1.width,height1)};if([[xzPlane.self,xzPlane.target],[xzPlane.target,xzPlane.self]].some(([rA,rB])=>rB.bottom>rA.top&&rB.top<rA.bottom))distance.dz=0;else{const snapBounds=__name2((rectangle,{toward})=>{const roundLeft=rectangle.left<toward.left?Math.ceil:Math.floor,roundTop=rectangle.top<toward.top?Math.ceil:Math.floor,left=roundLeft(rectangle.left/gridWidth)*gridWidth,top=roundTop(rectangle.top/gridWidth)*gridWidth,width=Math.ceil(rectangle.width/gridWidth)*gridWidth,height=Math.ceil(rectangle.height/gridWidth)*gridWidth;return new PIXI.Rectangle(left,top,width,height)},"snapBounds"),r0Snapped=snapBounds(xzPlane.self,{toward:xzPlane.target}),r1Snapped=snapBounds(xzPlane.target,{toward:xzPlane.self});distance.dz=Math.max(r0Snapped.top-r1Snapped.bottom,r1Snapped.top-r0Snapped.bottom,0)+gridWidth}}else distance.dz=0;return measureDistanceOnGrid(distance,{reach})}__name(measureDistanceCuboid,"measureDistanceCuboid"),__name2(measureDistanceCuboid,"measureDistanceCuboid");function measureDistance(p0,p1){return canvas.grid.type!==CONST.GRID_TYPES.SQUARE?canvas.grid.measurePath([p0,p1]).distance:measureDistanceOnGrid(new foundry.canvas.geometry.Ray(p0,p1))}__name(measureDistance,"measureDistance"),__name2(measureDistance,"measureDistance");function measureDistanceOnGrid(segment,{reach=null}={}){if(!canvas.dimensions)return NaN;const gridSize=canvas.dimensions.size,gridDistance=canvas.dimensions.distance,nx=Math.ceil(Math.abs(segment.dx/gridSize)),ny=Math.ceil(Math.abs(segment.dy/gridSize)),nz=Math.ceil(Math.abs((segment.dz||0)/gridSize)),sortedDistance=[nx,ny,nz].sort((a,b)=>a-b),squares={doubleDiagonal:sortedDistance[0],diagonal:sortedDistance[1]-sortedDistance[0],straight:sortedDistance[2]-sortedDistance[1]},reduction=squares.diagonal+squares.doubleDiagonal>1&&reach===10?1:0;return(Math.floor(squares.doubleDiagonal*1.75+squares.diagonal*1.5+squares.straight)-reduction)*gridDistance}__name(measureDistanceOnGrid,"measureDistanceOnGrid"),__name2(measureDistanceOnGrid,"measureDistanceOnGrid");function squareAtPoint(point){const snapped=canvas.grid.type===CONST.GRID_TYPES.SQUARE?canvas.grid.getTopLeftPoint(point):canvas.grid.getSnappedPoint(point,{mode:CONST.GRID_SNAPPING_MODES.CENTER});return new PIXI.Rectangle(snapped.x,snapped.y,canvas.grid.sizeX,canvas.grid.sizeY)}__name(squareAtPoint,"squareAtPoint"),__name2(squareAtPoint,"squareAtPoint");class MeasuredTemplatePF2e extends foundry.canvas.placeables.MeasuredTemplate{static{__name(this,"MeasuredTemplatePF2e")}static{__name2(this,"MeasuredTemplatePF2e")}get actor(){return this.document.actor}get item(){return this.document.item}get message(){return this.document.message}get areaShape(){return this.document.areaShape}get snappingMode(){const MODES=CONST.GRID_SNAPPING_MODES;switch(this.areaShape){case"burst":return MODES.VERTEX;case"cone":return MODES.CENTER|MODES.VERTEX|MODES.EDGE_MIDPOINT;case"line":return MODES.EDGE_MIDPOINT|MODES.VERTEX;default:return MODES.CENTER|MODES.VERTEX}}highlightGrid(){if(!canvas.grid.isSquare)return super.highlightGrid();const grid=canvas.interface.grid,highlightLayer=grid.getHighlightLayer(this.highlightId);if(highlightLayer?.clear(),!this.isVisible||!highlightLayer)return;const dimensions=canvas.dimensions,positions=this._getGridHighlightPositions();for(const point of positions)point.collision?(grid.highlightPosition(this.highlightId,{x:point.x,y:point.y,border:1,color:0}),highlightLayer.beginFill(0,.5).moveTo(point.x,point.y).lineTo(point.x+dimensions.size,point.y+dimensions.size).endFill()):grid.highlightPosition(this.highlightId,{x:point.x,y:point.y,border:this.document.borderColor,color:this.document.fillColor})}_getGridHighlightPositions(){if(!["circle","cone"].includes(this.document.t)||!canvas.grid.isSquare)return super._getGridHighlightPositions();const areaShape=this.areaShape,document2=this.document;if(!this.id&&!this.isPreview)return[];const dimensions=canvas.dimensions;if(!(canvas.interface.grid&&dimensions))return[];const angle=document2.angle??0,direction=document2.direction??45,center=canvas.grid.getCenterPoint({x:document2.x,y:document2.y}),{i:col0,j:row0}=canvas.grid.getOffset({x:center.x,y:center.y}),minAngle=(360+(direction-angle*.5)%360)%360,maxAngle=(360+(direction+angle*.5)%360)%360,snappedOrigin=canvas.grid.getSnappedPoint({x:document2.x,y:document2.y},{mode:this.snappingMode}),withinAngle=__name2((min,max,value)=>(min=(360+min%360)%360,max=(360+max%360)%360,value=(360+value%360)%360,min<max?value>=min&&value<=max:value>=min||value<=max),"withinAngle"),coneOriginOffset=(()=>{if(areaShape!=="cone")return{x:0,y:0};const dir=(direction>=0?360-direction:-direction)%360,xOffset=snappedOrigin.x%dimensions.size!==0?Math.sign(1*Math.round(Math.cos(Math.toRadians(dir))*100)/100)/2:0,yOffset=snappedOrigin.y%dimensions.size!==0?-Math.sign(1*Math.round(Math.sin(Math.toRadians(dir))*100)/100)/2:0;return{x:xOffset*dimensions.size,y:yOffset*dimensions.size}})(),padding=Math.clamp(document2.width??0,1.5,2),docDistance=document2.distance??0,padded=docDistance*padding/dimensions.distance,rowCount=Math.ceil(padded/(dimensions.size/canvas.grid.sizeX)),columnCount=Math.ceil(padded/(dimensions.size/canvas.grid.sizeY)),pointSource=new foundry.canvas.sources.PointMovementSource({object:this}),points=[];for(let a=-columnCount;a<columnCount;a++)for(let b=-rowCount;b<rowCount;b++){const{x:gx,y:gy}=canvas.grid.getTopLeftPoint({i:col0+a,j:row0+b}),destination={x:gx+dimensions.size*.5,y:gy+dimensions.size*.5};if(destination.x<0||destination.y<0)continue;const origin={x:snappedOrigin.x+coneOriginOffset.x,y:snappedOrigin.y+coneOriginOffset.y};if(areaShape==="cone"){const ray=new foundry.canvas.geometry.Ray(origin,destination),rayAngle=(360+ray.angle/(Math.PI/180)%360)%360;if(ray.distance>0&&!withinAngle(minAngle,maxAngle,rayAngle))continue}if(measureDistance(destination,origin)>docDistance)continue;const collision=canvas.ready&&CONFIG.Canvas.polygonBackends.move.testCollision(origin,destination,{type:"move",source:pointSource,mode:"any"});points.push({x:gx,y:gy,collision})}return points}}class RegionPF2e extends foundry.canvas.placeables.Region{static{__name(this,"RegionPF2e")}static{__name2(this,"RegionPF2e")}static RENDER_FLAGS={...super.RENDER_FLAGS,refreshPosition:{}};getSnappedPosition(position){return this.layer.getSnappedPoint(position??this.center)}_canDrag(user,event2){return this._canControl(user,event2)&&!this.document.locked}_onDragLeftMove(event2){const{destination,clones=[]}=event2.interactionData;canvas._onDragCanvasPan(event2);const origin=this.center,dx=destination.x-origin.x,dy=destination.y-origin.y;for(const clone of clones){const original=clone._original;if(!original)continue;const position={x:original.document.x+dx,y:original.document.y+dy};clone.document.x=position.x,clone.document.y=position.y,clone._onUpdate({shapes:clone.document.shapes.map(s=>s.toObject(!1))},{broadcast:!1},game.user.id),Promise.resolve().then(()=>{clone.visible=!0})}}async _onDragLeftDrop(event2){const updates=(event2.interactionData.clones??[]).map(clone=>{const shapes=clone.document.shapes.map(s=>s.toObject(!1));return{_id:clone.document.id,shapes}});return this.document.parent?.updateEmbeddedDocuments("Region",updates)??[]}}class EffectAreaSquare extends PIXI.Rectangle{static{__name(this,"EffectAreaSquare")}static{__name2(this,"EffectAreaSquare")}active;constructor(x,y,width=canvas.grid.sizeX,height=canvas.grid.sizeY,active=!0){super(x,y,width,height),this.active=active}get center(){return{x:this.x+this.width/2,y:this.y+this.height/2}}highlight(layer,{border,highlight}){this.x<0||this.y<0||(this.active?canvas.interface.grid.highlightPosition(layer.name,{x:this.x,y:this.y,border:border?.color,color:highlight.color,alpha:highlight.alpha}):(canvas.interface.grid.highlightPosition(layer.name,{x:this.x,y:this.y,border:0,color:0}),layer.beginFill(0,.5).moveTo(this.x,this.y).lineTo(this.x+this.width,this.y+this.height).endFill()))}}function getAreaSquares(data){if(!canvas.ready)return[];const squareWidth=canvas.dimensions.size,rowCount=Math.ceil(data.bounds.width/squareWidth),emptyVector=Array(rowCount-1).fill(null),genColumn=__name2(square=>emptyVector.reduce(colSquares=>{const squareAbove=colSquares.at(-1),squareBelow=new EffectAreaSquare(square.x,squareAbove.y+squareWidth,squareWidth,squareWidth);return colSquares.push(squareBelow),colSquares},[square]),"genColumn"),topLeftSquare=new EffectAreaSquare(data.bounds.x,data.bounds.y,squareWidth,squareWidth),collisionType=data.traits?.includes("visual")&&!data.traits.includes("auditory")?"sight":data.traits?.includes("auditory")&&!data.traits.includes("visual")?"sound":"move",tokenBounds=data.token.mechanicalBounds,tokenCenter=data.token.center,tokenCenters=[tokenCenter,...[{x:0,y:1},{x:1,y:0},{x:0,y:-1},{x:-1,y:0}].map(c=>({x:tokenCenter.x+c.x*Math.round(tokenBounds.width/8),y:tokenCenter.y+c.y*Math.round(tokenBounds.height/8)}))],pointSource=(()=>{const sources=foundry.canvas.sources,PointSource={sight:sources.PointVisionSource,sound:sources.PointSoundSource,move:sources.PointMovementSource}[collisionType],tokenObject=data.token instanceof TokenDocumentPF2e?data.token.object:data.token;return new PointSource({object:tokenObject})})(),tokenCenterPolygons=tokenCenters.map(c=>CONFIG.Canvas.polygonBackends[collisionType].create(c,{type:collisionType,source:pointSource,boundaryShapes:[data.bounds]}));return emptyVector.reduce(squares=>{const lastSquare=squares.at(-1)?.at(-1)??{x:NaN},column=genColumn(new EffectAreaSquare(lastSquare.x+squareWidth,topLeftSquare.y,squareWidth,squareWidth));return squares.push(column),squares},[genColumn(topLeftSquare)]).flat().filter(s=>measureDistanceCuboid(tokenBounds,s)<=data.radius).map(square=>(square.active=tokenCenterPolygons.some(c=>c.contains(square.center.x,square.center.y)),square))}__name(getAreaSquares,"getAreaSquares"),__name2(getAreaSquares,"getAreaSquares");class AuraRenderer extends PIXI.Graphics{static{__name(this,"AuraRenderer")}static{__name2(this,"AuraRenderer")}slug;token;radius;radiusPixels;traits;appearance;static LINE_THICKNESS=3;border=new PIXI.Graphics;textureContainer=null;constructor(params){super(),this.slug=params.slug,this.token=params.token,this.appearance=params.appearance,this.radius=params.radius,this.radiusPixels=.5*this.token.mechanicalBounds.width+this.radius/canvas.dimensions.distance*canvas.grid.size,this.traits=params.traits,this.addChild(this.border)}get bounds(){const{token,radiusPixels}=this,bounds=token.mechanicalBounds;return new PIXI.Rectangle(bounds.x-(radiusPixels-bounds.width/2),bounds.y-(radiusPixels-bounds.width/2),radiusPixels*2,radiusPixels*2)}get highlightLayer(){return canvas.interface.grid?.getHighlightLayer(this.token.highlightId)??null}get squares(){return getAreaSquares(this)}async draw(showBorder){if(this.token.document.hidden&&!this.token.visible)return;const{mechanicalBounds}=this.token;return this.x=mechanicalBounds.width/2,this.y=mechanicalBounds.height/2,this.token.document.width<1&&(this.x+=mechanicalBounds.x-this.token.x,this.y+=mechanicalBounds.y-this.token.y),this.#drawBorder(),this.border.visible=showBorder,this.#drawTexture()}repositionTexture(){if(this.textureContainer){const{bounds,radiusPixels}=this;this.textureContainer.position.set(bounds.x+radiusPixels,bounds.y+radiusPixels)}}#drawBorder(){const data=this.appearance.border;!data||this.border.geometry.graphicsData.length>0||this.border.lineStyle(AuraRenderer.LINE_THICKNESS,data.color,data.alpha).drawCircle(0,0,this.radiusPixels)}async#drawTexture(){const data=this.appearance.texture;if(!data||this.token.isPreview||this.textureContainer)return;this.textureContainer=new PIXI.Graphics;const texture=await(async()=>{const maybeTexture=await foundry.canvas.loadTexture(data.src,{fallback:"icons/svg/hazard.svg"});if(!(maybeTexture instanceof PIXI.Texture))return null;const globalVideo=isVideoFilePath(data.src)?game.video.getVideoSource(maybeTexture):null;if(globalVideo){maybeTexture.destroy();const videoTexture=await game.video.cloneTexture(globalVideo),video=game.video.getVideoSource(videoTexture)??globalVideo;video.playbackRate=data.playbackRate;const offset=data.loop?Math.random()*video.duration:0;return game.video.play(video,{volume:0,offset,loop:data.loop}),videoTexture}else return maybeTexture})();if(!texture)return;const{bounds,radiusPixels}=this,radius=data.scale*radiusPixels,diameter=radius*2,scale={x:diameter/texture.width,y:diameter/texture.height},matrix=new PIXI.Matrix(scale.x,void 0,void 0,scale.y,radius,radius);this.textureContainer.beginTextureFill({texture,alpha:data.alpha,matrix}).drawCircle(0,0,radius).endFill(),this.textureContainer.position.set(bounds.x+radiusPixels,bounds.y+radiusPixels),canvas.interface.grid.addChild(this.textureContainer)}highlight(){const{dimensions}=canvas;if(!dimensions)return;if(this.#drawLabel(),!!(this.token.actor?.isOfType("familiar")?this.token.actor.master?.combatant?.encounter.active:this.token.combatant?.encounter.active)){const{highlightLayer}=this;if(!highlightLayer)return;for(const square of this.squares)square.highlight(highlightLayer,this.appearance)}}#drawLabel(){const style=CONFIG.canvasTextStyle.clone(),gridSize=canvas.dimensions.size??100;style.fontSize=Math.max(Math.round(gridSize*.36*12)/12,36),style.align="center";const bounds=this.token.mechanicalBounds,gridUnits=canvas.scene?.grid.units.trim()||game.system.grid.units,label=[this.radius,gridUnits].join(""),text2=new foundry.canvas.containers.PreciseText(label,style),center={x:bounds.x+bounds.width/2,y:bounds.y+bounds.height/2},textOffset=Math.sqrt(style.fontSize);text2.position.set(center.x+textOffset,center.y-this.radiusPixels-style.fontSize-textOffset),this.highlightLayer?.beginFill(0,.5).lineStyle(AuraRenderer.LINE_THICKNESS,0).drawCircle(center.x,center.y-this.radiusPixels,6).endFill().addChild(text2)}destroy(options){super.destroy(options),this.textureContainer&&(canvas.interface.grid.removeChild(this.textureContainer),this.textureContainer.destroyed||this.textureContainer.destroy())}}class AuraRenderers extends Map{static{__name(this,"AuraRenderers")}static{__name2(this,"AuraRenderers")}token;constructor(token){super(),this.token=token}get highlightId(){return this.token.highlightId}async reset(slugs){if(!slugs)this.clear();else for(const slug of slugs)this.delete(slug);if(!this.token.actor)return;const data=Array.from(this.token.document.auras.values()).filter(a=>slugs?.includes(a.slug)??!0);for(const datum of data){const renderer=new AuraRenderer({...datum,token:this.token});this.set(datum.slug,this.token.addChild(renderer))}return this.draw()}refreshPositions(){for(const aura of this.values())aura.repositionTexture()}get#showBordersHighlights(){const inEncounter=__name2(()=>!!(this.token.actor?.isOfType("familiar")?this.token.actor.master?.combatant?.encounter.active:this.token.combatant?.encounter.active),"inEncounter");return canvas.scene!==null&&canvas.scene.canHaveAuras&&canvas.scene.tokenVision&&canvas.scene.isInFocus&&(game.user.isGM||this.token.actor?.alliance==="party")&&(this.token.controlled||this.token.hover||this.token.layer.highlightObjects||inEncounter())}async draw(){if(this.size===0||(this.clearHighlights(),this.token.isAnimating))return;const showBordersHighlights=this.#showBordersHighlights;for(const aura of this.values())await aura.draw(showBordersHighlights);if(showBordersHighlights&&(this.token.hover||this.token.layer.highlightObjects)){const{highlightId}=this;(canvas.interface.grid.highlightLayers[highlightId]??canvas.interface.grid.addHighlightLayer(highlightId)).clear();for(const aura of this.values())aura.highlight()}}delete(key){const aura=this.get(key);return aura?(aura.destroyed||aura.destroy(!0),this.token.removeChild(aura),super.delete(key)):!1}clear(){this.clearHighlights();for(const aura of this.values())aura.destroyed||aura.destroy(!0),this.token.removeChild(aura);return super.clear()}destroy(){this.clear()}clearHighlights(){canvas.interface.grid.destroyHighlightLayer(this.highlightId)}}class FlankingHighlightRenderer{static{__name(this,"FlankingHighlightRenderer")}static{__name2(this,"FlankingHighlightRenderer")}#layer=null;token;labelText;lineColor;constructor(token){this.token=token,this.labelText=game.i18n.localize("PF2E.Token.Flanking"),this.lineColor=CONFIG.Canvas.dispositionColors.CONTROLLED}get layer(){return this.#layer??this.#addLayer()}get#shouldRender(){return canvas.ready&&!!canvas.scene&&this.#tokenIsEligible}get#tokenIsEligible(){return!!((this.token.controlled&&this.token.isOwner||this.token.actor&&this.token.actor?.id===game.user.character?.id)&&!(this.token.isPreview||this.token.isAnimating))}draw(){if(this.clear(),canvas.tokens.highlightObjects&&game.user.targets.size&&this.#shouldRender)for(const target of game.user.targets)this.drawForTarget(target)}drawForTarget(target){const buddies=this.token.buddiesFlanking(target,{ignoreFlankable:!0});this.drawBuddyLines(buddies)}drawBuddyLines(buddies){for(const token of buddies)this.drawBuddyLine(token)}drawBuddyLine(buddy){const t2=CONFIG.Canvas.objectBorderThickness,o=Math.round(t2*1.5),c=Math.round(t2*2);this.layer.lineStyle(o,0,.5).moveTo(this.token.center.x,this.token.center.y).lineTo(buddy.center.x,buddy.center.y),this.layer.lineStyle(t2,this.lineColor,.5).moveTo(this.token.center.x,this.token.center.y).lineTo(buddy.center.x,buddy.center.y),this.layer.beginFill(this.lineColor).lineStyle(1,0).drawCircle(this.token.center.x,this.token.center.y,c),this.layer.beginFill(this.lineColor).lineStyle(1,0).drawCircle(buddy.center.x,buddy.center.y,c),this.drawLabel(buddy)}drawLabel(buddy){const mid_x=Math.round((this.token.center.x+buddy.center.x)/2),mid_y=Math.round((this.token.center.y+buddy.center.y)/2),vect_x=buddy.center.x-this.token.center.x,vect_y=buddy.center.y-this.token.center.y,perp_vect_x=vect_x<=-vect_x?-vect_y:vect_y,perp_vect_y=vect_x<=-vect_x?vect_x:-vect_x,offsetScale=20/Math.sqrt(perp_vect_x**2+perp_vect_y**2),perp_x=mid_x+Math.round(perp_vect_x*offsetScale),perp_y=mid_y+Math.round(perp_vect_y*offsetScale),style=CONFIG.canvasTextStyle.clone(),dimensions=canvas.dimensions;style.fontSize=dimensions.size>=200?28:dimensions.size<50?20:24,style.fill=this.lineColor,style.stroke=0;const text2=new foundry.canvas.containers.PreciseText(this.labelText,style);text2.anchor.set(.5,.5);let rotation=Math.atan2(vect_y,vect_x);rotation>Math.PI/2?rotation=rotation-Math.PI:rotation<-Math.PI/2&&(rotation=rotation+Math.PI),text2.rotation=rotation,text2.position.set(perp_x,perp_y),this.layer.addChild(text2)}clear(){this.#layer?.destroy({children:!0}),this.#layer=null}destroy(){this.clear()}#addLayer(){return this.#layer=new PIXI.Graphics,this.token.layer.addChild(this.#layer)}}class TokenPF2e extends foundry.canvas.placeables.Token{static{__name(this,"TokenPF2e")}static{__name2(this,"TokenPF2e")}constructor(document2){super(document2),this.auras=new AuraRenderers(this),Object.defineProperty(this,"auras",{configurable:!1,writable:!1})}static RENDER_FLAGS=(()=>{const flags=Object.assign(super.RENDER_FLAGS,{refreshDistanceLabel:{}});return flags.refreshState.propagate.push("refreshDistanceLabel"),flags})();auras;flankingHighlight=new FlankingHighlightRenderer(this);get localShape(){switch(this.shape.type){case PIXI.SHAPES.RECT:return this.bounds;case PIXI.SHAPES.POLY:{const shape=this.shape.clone(),bounds=this.bounds;return shape.points=shape.points.map((c,i)=>i%2===0?c+bounds.x:c+bounds.y),shape}case PIXI.SHAPES.CIRC:{const shape=this.shape.clone(),center=this.center;return shape.x=center.x,shape.y=center.y,shape}}}get footprint(){const shape=this.document.isTiny?this.mechanicalBounds:this.localShape,seen=new Set,offsets=[],[i0,j0,i1,j1]=canvas.grid.getOffsetRange(this.mechanicalBounds);for(let i=i0;i<i1;i++)for(let j=j0;j<j1;j++){const offset={i,j},packed=(offset.i<<16)+offset.j;if(seen.has(packed))continue;seen.add(packed);const point=canvas.grid.getCenterPoint(offset);shape.contains(point.x,point.y)&&offsets.push(offset)}return offsets.sort((a,b)=>a.j-b.j).sort((a,b)=>a.i-b.i)}get isVisible(){if(this.detectionFilter=null,this.document.hidden&&!game.user.isGM)return!1;if(!canvas.visibility.tokenVision||this.controlled||canvas.effects.visionSources.get(this.sourceId)?.active)return!0;const tolerance=Math.floor(.35*Math.min(this.w,this.h));return canvas.visibility.testVisibility(this.center,{tolerance,object:this})}get animation(){return this.animationContexts.get(this.animationName)?.promise??this.animationContexts.get(this.movementAnimationName)?.promise??null}get isAnimating(){return!!this.animation}get hasLowLightVision(){return this.document.hasLowLightVision}get hasDarkvision(){return this.document.hasDarkvision}get linkToActorSize(){return this.document.linkToActorSize}get highlightId(){return`Token.${this.id}`}get mechanicalBounds(){const bounds=this.bounds;if(this.document.isTiny){const position=canvas.grid.getTopLeftPoint(bounds);return new PIXI.Rectangle(position.x,position.y,Math.max(canvas.grid.size,bounds.width),Math.max(canvas.grid.size,bounds.height))}return bounds}get#canSeeDistance(){return!this.visible||this.isPreview||this.document.isSecret||this.controlled||this.animation?!1:this.hover&&(this.layer.controlled.length===1||!!game.user.character?.getActiveTokens().length)}isAdjacentTo(token){return this.distanceTo(token)===canvas.grid.distance}canControl(user,event2){return this._canControl(user,event2)}canFlank(flankee,context={}){const settingDisabled=!game.pf2e.settings.automation.flanking,oneIsGMHidden=this.document.hidden||flankee.document.hidden;if(settingDisabled||oneIsGMHidden||this===flankee)return!1;const actor=this.actor,flankable=context.ignoreFlankable||flankee.actor?.attributes.flanking.flankable;if(!(actor?.attributes.flanking.canFlank&&flankable)||!(actor.isOfType("creature")&&flankee.actor?.isOfType("creature"))||actor.isAllyOf(flankee.actor))return!1;const reach=context.reach??actor.getReach({action:"attack"});return actor.canAttack&&reach>=this.distanceTo(flankee,{reach})}onOppositeSides(flankerA,flankerB,flankee){const boundsA=flankerA.mechanicalBounds,centerA={x:flankerA.document.x+boundsA.width/2,y:flankerA.document.y+boundsA.height/2},boundsB=flankerB.mechanicalBounds,centerB={x:flankerB.document.x+boundsB.width/2,y:flankerB.document.y+boundsB.height/2},bounds=flankee.mechanicalBounds,left=new foundry.canvas.geometry.Ray({x:bounds.left,y:bounds.top},{x:bounds.left,y:bounds.bottom}),right=new foundry.canvas.geometry.Ray({x:bounds.right,y:bounds.top},{x:bounds.right,y:bounds.bottom}),top=new foundry.canvas.geometry.Ray({x:bounds.left,y:bounds.top},{x:bounds.right,y:bounds.top}),bottom=new foundry.canvas.geometry.Ray({x:bounds.left,y:bounds.bottom},{x:bounds.right,y:bounds.bottom}),intersectsSide=__name2(side=>foundry.utils.lineSegmentIntersects(centerA,centerB,side.A,side.B),"intersectsSide");return intersectsSide(left)&&intersectsSide(right)||intersectsSide(top)&&intersectsSide(bottom)}isFlanking(flankee,context={}){const thisActor=this.actor;if(!(thisActor&&this.canFlank(flankee,context)))return!1;const flanking=thisActor.attributes.flanking,flankingBuddies=this.layer.placeables.filter(t2=>(t2.actor?.isAllyOf(thisActor)||this.document.isLinked&&t2.actor===thisActor&&t2.id!==this.id)&&t2.canFlank(flankee,t$3(context,["ignoreFlankable"])));return flankingBuddies.length===0?!1:flanking.canGangUp.some(g=>typeof g=="number"&&g<=flankingBuddies.length||g===!0&&flankingBuddies.length>=1)||flankingBuddies.some(b=>b.actor?.attributes.flanking.canGangUp.some(g=>g===!0))||this.isAdjacentTo(flankee)&&flanking.canGangUp.includes("animal-companion")&&flankingBuddies.some(b=>{if(!b.actor?.isOfType("character"))return!1;const traits=b.actor.system.traits.value;return traits.includes("minion")&&!traits.includes("construct")&&b.isAdjacentTo(flankee)})||this.isAdjacentTo(flankee)&&flanking.canGangUp.includes("eidolon")&&flankingBuddies.some(b=>b.actor?.isOfType("character")?b.actor.system.traits.value.includes("eidolon")&&b.isAdjacentTo(flankee):!1)?!0:flankingBuddies.some(b=>this.onOppositeSides(this,b,flankee))}buddiesFlanking(flankee,context={}){if(!this.canFlank(flankee,context))return[];const ignoreFlankable=!!context.ignoreFlankable;return this.layer.placeables.filter(t2=>t2!==this&&t2.canFlank(flankee,{ignoreFlankable})&&this.onOppositeSides(this,t2,flankee))}_applyRenderFlags(flags){super._applyRenderFlags(flags),flags.refreshPosition&&this.auras.refreshPositions(),flags.refreshDistanceLabel&&this.#refreshDistanceLabel()}_refreshVisibility(){super._refreshVisibility(),this.auras.draw(),this.flankingHighlight.draw()}_refreshState(){super._refreshState();const distanceLabelEl=document.getElementById("token-hover-distance");distanceLabelEl&&(distanceLabelEl.hidden=!this.#canSeeDistance)}#refreshDistanceLabel(){this.layer.refreshDistanceLine();const setting=game.pf2e.settings.distanceDisplay;if(setting==="never"||setting==="encounters"&&!game.combat?.started)return;const labelEl=document.getElementById("token-hover-distance");if(!this.#canSeeDistance||!labelEl){labelEl&&(labelEl.hidden=!0);return}const controlledToken=this.layer.controlled[0]??game.user.character?.getActiveTokens()[0];if(!controlledToken||controlledToken.isPreview||controlledToken.animation)return;const totalEl=labelEl.querySelector(".total-measurement");if(!totalEl)throw ErrorPF2e("Unexpected failure to retrieve measurement HTML element");const distance=controlledToken.distanceTo(this);if(distance<canvas.grid.distance){labelEl.hidden=!0;return}const label=[distance,canvas.scene?.grid.units??""].join(" ").trim();totalEl.textContent=label,labelEl.dataset.tokenId=this.document.id,labelEl.style.setProperty("--position-y",`${this.y}px`),labelEl.style.setProperty("--ui-scale",canvas.dimensions.uiScale.toString()),labelEl.hidden=!1;const square=this.layer.refreshDistanceLine(controlledToken,this);labelEl.style.setProperty("--position-x",`${square.x}px`)}_drawBar(number,bar,data){if(!canvas.initialized)return;const actor=this.document.actor;if(!(data.attribute==="attributes.hp"&&actor?.attributes.hp))return super._drawBar(number,bar,data);const{value,max,temp}=actor.attributes.hp??{},healthPercent=Math.clamp(value,0,max)/max,black=0,color=Number(number?Color.fromRGB([.5*healthPercent,.7*healthPercent,.5+healthPercent/2]):Color.fromRGB([1-healthPercent/2,healthPercent,0]));let h=Math.max(canvas.dimensions.size/12,8);const bs=Math.clamp(h/8,1,2);this.document.height>=2&&(h*=1.6);const numBars=temp>0?2:1,barHeight=h/numBars;if(bar.clear(),bar.lineStyle(0).beginFill(black,.5).drawRoundedRect(0,0,this.w,h,3),bar.lineStyle(bs/2,black,1),temp>0){const tempWidth=Math.clamp(temp,0,max)/max*this.w-2*(bs-1);bar.beginFill(6737151,1).drawRoundedRect(0,0,tempWidth,barHeight,2)}const healthBarY=(numBars-1)*barHeight;bar.beginFill(color,1).drawRoundedRect(0,healthBarY,healthPercent*this.w,barHeight,2),bar.beginFill(black,0).lineStyle(bs,black,1).drawRoundedRect(0,0,this.w,h,3),bar.position.set(0,number===0?this.h-h:0)}async _drawEffects(){if(await super._drawEffects(),await this.animation,this.auras.size===0)return this.auras.reset();const changedAndDeletedAuraSlugs=Array.from(this.auras.entries()).filter(([slug,aura])=>{const properties=["radius","appearance"],sceneData=t$3(this.document.auras.get(slug)??{radius:null,appearance:null},properties);if(sceneData.radius===null)return!0;const canvasData=t$3(aura,properties);return!t$6(sceneData,canvasData)}).map(([slug])=>slug),newAuraSlugs=Array.from(this.document.auras.keys()).filter(s=>!this.auras.has(s));return this.auras.reset([changedAndDeletedAuraSlugs,newAuraSlugs].flat())}emitHoverIn(nativeEvent){const event2=new PIXI.FederatedPointerEvent(new PIXI.EventBoundary(this));event2.type="pointerover",event2.nativeEvent=nativeEvent,this._onHoverIn(event2,{hoverOutOthers:!0})}emitHoverOut(nativeEvent){const event2=new PIXI.FederatedPointerEvent(new PIXI.EventBoundary(this));event2.type="pointerout",event2.nativeEvent=nativeEvent,this._onHoverOut(event2)}_isVisionSource(){if(!this.hasSight||!this.document.parent?.tokenVision||game.pf2e.settings.gmVision&&game.user.isGM)return!1;const partyVisionEnabled=game.pf2e.settings.metagame.partyVision&&!!this.actor?.hasPlayerOwner&&!game.user.isGM,controllingAsObserver=this.controlled&&this.observer;return partyVisionEnabled||controllingAsObserver||!this.controlled&&super._isVisionSource()}clone(){const clone=super.clone();return clone.isPreview&&(clone.document.height=this.document.height,clone.document.width=this.document.width,clone.document.texture.scaleX=this.document.texture.scaleX,clone.document.texture.scaleY=this.document.texture.scaleY,clone.document.texture.src=this.document.texture.src),clone}async showFloatyText(params){if(!this.isVisible)return;if(!game.user.isGM&&typeof params!="number"){const[_,document2]=Object.entries(params)[0];if(document2 instanceof EffectPF2e&&document2.system.unidentified)return}const scrollingTextArgs=(()=>{if(typeof params=="number"){const quantity=params,maxHP=this.actor?.hitPoints?.max;if(!(quantity&&typeof maxHP=="number"))return null;const percent=Math.clamp(Math.abs(quantity)/maxHP,0,1),textColors={damage:16711680,healing:65280};return[this.center,params.signedString(),{anchor:CONST.TEXT_ANCHOR_POINTS.TOP,jitter:.25,fill:textColors[quantity<0?"damage":"healing"],fontSize:16+32*percent,stroke:0,strokeThickness:4}]}else{const[change,details]=Object.entries(params)[0],isAdded=change==="create",sign=isAdded?"+ ":"- ",appendedNumber=!/ \d+$/.test(details.name)&&details.value?` ${details.value}`:"",content=`${sign}${details.name}${appendedNumber}`,anchorDirection=isAdded?CONST.TEXT_ANCHOR_POINTS.TOP:CONST.TEXT_ANCHOR_POINTS.BOTTOM,textStyle=t$3(this._getTextStyle(),["fill","fontSize","stroke","strokeThickness"]);return[this.center,content,{...textStyle,anchor:anchorDirection,direction:anchorDirection,jitter:.25}]}})();scrollingTextArgs&&(await this.animation,await canvas.interface?.createScrollingText(...scrollingTextArgs))}distanceTo(target,{reach=null}={}){if(!canvas.ready)return NaN;if(this===target)return 0;const selfElevation=this.document.elevation,targetElevation=target.document?.elevation??selfElevation;if(canvas.grid.type!==CONST.GRID_TYPES.SQUARE){const waypoints=[{x:this.x,y:this.y,elevation:selfElevation},{x:target.x,y:target.y,elevation:targetElevation}];return Math.round(canvas.grid.measurePath(waypoints).distance)}const targetBounds=target.mechanicalBounds??squareAtPoint(target);return selfElevation===targetElevation||!this.actor||!target.mechanicalBounds||!target.actor?measureDistanceCuboid(this.mechanicalBounds,targetBounds,{reach}):measureDistanceCuboid(this.mechanicalBounds,targetBounds,{reach,token:this,target})}render(renderer){if(super.render(renderer),!this.mesh)return;const configuredTint=this.document.texture.tint??Color.fromString("#FFFFFF");this.mesh.tint!==0&&this.detectionFilter instanceof foundry.canvas.rendering.filters.OutlineOverlayFilter?this.mesh.tint=0:this.mesh.tint===0&&configuredTint.toString()!=="#000000"&&!(this.detectionFilter instanceof foundry.canvas.rendering.filters.OutlineOverlayFilter)&&(this.mesh.tint=Number(configuredTint))}_destroy(){super._destroy(),this.auras.destroy(),this.flankingHighlight.destroy()}_canView(user,event2){return super._canView(user,event2)||!!this.actor?.isLootableBy(user)}_canControl(user,event2){return!this.observer&&this.actor?.isOfType("npc")&&this.actor.isLootableBy(user)?!1:super._canControl(user,event2)}_onControl(options={}){return game.ready&&game.pf2e.effectPanel.refresh(),super._onControl(options)}_onRelease(options){return game.pf2e.effectPanel.refresh(),super._onRelease(options)}_onApplyStatusEffect(statusId,active){super._onApplyStatusEffect(statusId,active),["undetected","unnoticed"].includes(statusId)&&canvas.perception.update({refreshVision:!0,refreshLighting:!0})}_onHoverIn(event2,options){return this.renderFlags.set({refreshDistanceLabel:!0}),super._onHoverIn(event2,options)}_onHoverOut(event2){return this.renderFlags.set({refreshDistanceLabel:!0}),super._onHoverOut(event2)}_onClickLeft2(event2){if(this.document.isSecret)return;const actor=this.actor;if(!game.pf2e.settings.automation.reachEnforcement.has(actor?.isOfType("loot")?actor.isLoot?"loot":"merchants":"corpses")||this.document.isOwner||!actor?.isLootableBy(game.user)||!canvas.grid.isSquare)return super._onClickLeft2(event2);if(n([this.layer.controlled,game.user.character?.getActiveTokens(!0,!1)??[]].flat()).some(t2=>t2.actor?.isOwner&&t2.actor.isOfType("creature","party")&&t2.distanceTo(this)<=t2.actor.system.attributes.reach.manipulate))return super._onClickLeft2(event2);{const thisIsCreature=actor.isOfType("creature"),name2=this.document.playersCanSeeName?this.document.name:game.i18n.localize(`PF2E.Token.Mystified.The${thisIsCreature?"Creature":"Object"}`);ui.notifications.warn("PF2E.Token.OutOfReach",{format:{token:name2}})}}_onUpdate(changed,options,userId){super._onUpdate(changed,options,userId),(changed.width||"hidden"in changed)&&(this.animation?this.animation.then(()=>{this.auras.reset()}):this.auras.reset())}}class RulerPF2e extends foundry.canvas.interaction.Ruler{static{__name(this,"RulerPF2e")}static{__name2(this,"RulerPF2e")}get path(){return super.path}set path(value){const origin=value[0];if(!origin||!canvas.grid.isSquare||game.keyboard.isModifierActive("Shift")){super.path=value;return}if(t$6(super.path,value))return;const gridSize=canvas.grid.size,snappedOrigin={...RulerPF2e.getSnappedPoint(origin),elevation:origin.elevation},nearest={x:snappedOrigin.x%gridSize,y:snappedOrigin.y%gridSize};super.path=value.map(p=>t$6(p,origin)?snappedOrigin:{x:Math.floor(p.x/gridSize)*gridSize+nearest.x,y:Math.floor(p.y/gridSize)*gridSize+nearest.y,elevation:p.elevation})}}class TokenAura{static{__name(this,"TokenAura")}static{__name2(this,"TokenAura")}slug;token;level;radius;traits;effects;appearance;#squares;constructor(params){this.slug=params.slug,this.token=params.token,this.level=params.level,this.radius=params.radius,this.traits=params.traits,this.effects=params.effects,this.appearance=params.appearance}get radiusPixels(){const gridSize=this.scene.grid.distance,gridSizePixels=this.scene.grid.size;return .5*this.token.mechanicalBounds.width+this.radius/gridSize*gridSizePixels}get scene(){return this.token.scene}get bounds(){const{token,radiusPixels}=this,bounds=token.mechanicalBounds;return new PIXI.Rectangle(bounds.x-(radiusPixels-bounds.width/2),bounds.y-(radiusPixels-bounds.width/2),radiusPixels*2,radiusPixels*2)}get center(){return this.token.center}get squares(){return this.#squares??=getAreaSquares(this)}containsToken(token){return this.token.hidden||token.hidden||!this.token.object||!token.object?!1:token===this.token?!0:this.token.object.distanceTo(token.object)>this.radius?!1:this.squares.some(s=>s.active&&measureDistanceCuboid(s,token.mechanicalBounds)===0)}async notifyActors(){if(!this.scene.isInFocus)return;const auraActor=this.token.actor,auraData=auraActor?.auras.get(this.slug);if(!(auraActor&&auraData?.effects.length))return;const auradTokens=this.scene.tokens.filter(t2=>t2.actor?.primaryUpdater===game.user&&this.containsToken(t2)),affectedActors=new Set(auradTokens.flatMap(t2=>t2.actor??[])),origin={actor:auraActor,token:this.token};for(const actor of affectedActors)await actor.applyAreaEffects(auraData,origin)}}class TokenDocumentPF2e extends TokenDocument{static{__name(this,"TokenDocumentPF2e")}static{__name2(this,"TokenDocumentPF2e")}#lastAnimation=null;get inCombat(){return this.actor?.isOfType("party")?this.actor.members.every(a=>game.combat?.getCombatantByActor(a.id)):super.inCombat}get scene(){return this.parent}get emitsDarkness(){return this.light.bright<0}get rulesBasedVision(){return!!(this.sight.enabled&&this.actor?.isOfType("creature")&&this.scene?.rulesBasedVision)}get hasLowLightVision(){return!!(this.rulesBasedVision&&this.actor?.isOfType("creature")&&this.actor.hasLowLightVision)}get hasDarkvision(){return!!(this.rulesBasedVision&&this.actor?.isOfType("creature")&&this.actor.hasDarkvision)}get linkToActorSize(){return this.flags.pf2e.linkToActorSize}get autoscale(){return this.linkToActorSize&&game.pf2e.settings.tokens.autoscale&&this.flags.pf2e.autoscale}get playersCanSeeName(){const anyoneCanSee=[CONST.TOKEN_DISPLAY_MODES.ALWAYS,CONST.TOKEN_DISPLAY_MODES.HOVER],nameDisplayMode=this.displayName;return anyoneCanSee.includes(nameDisplayMode)||this.actor?.alliance==="party"}get bounds(){const gridSize=this.scene?.grid.size??100;return new PIXI.Rectangle(this._source.x,this._source.y,this.width*gridSize,this.height*gridSize)}get mechanicalBounds(){const bounds=this.bounds;if(this.width<1){const position=canvas.grid.getTopLeftPoint({x:bounds.x+bounds.width/2,y:bounds.y+bounds.height/2});return new PIXI.Rectangle(position.x,position.y,Math.max(canvas.grid.size,bounds.width),Math.max(canvas.grid.size,bounds.height))}return bounds}get isTiny(){return this.height<1||this.width<1}get center(){const bounds=this.bounds;return{x:bounds.x+bounds.width/2,y:bounds.y+bounds.height/2}}get difficultTerrain(){return Array.from(this.regions??[]).map(r2=>r2.behaviors.filter(b=>!b.disabled&&b.type==="environmentFeature"&&b.system.terrain.difficult>0)).flat().reduce((highest,b)=>b.system.terrain.difficult>highest?b.system.terrain.difficult:highest,0)}hasStatusEffect(statusId){if(statusId==="dead")return!!this.actor?.statuses.has("dead");const actor=this.actor;return!actor||!game.pf2e.settings.rbv?!1:objectHasKey(CONFIG.PF2E.conditionTypes,statusId)&&actor.hasCondition(statusId)||__name2(()=>actor.itemTypes.effect.some(e2=>(e2.slug??sluggify(e2.name))===statusId),"hasEffect")()}static getTrackedAttributes(data={},_path=[]){if(_path.length===0&&Object.keys(data).length===0)for(const[type2,model]of Object.entries(game.model.Actor))["character","npc"].includes(type2)&&foundry.utils.mergeObject(data,model);if(_path.length>0)return super.getTrackedAttributes(data,_path);const patterns={positive:/^(?:attributes|resources)\./,negative:/\b(?:rank|_?modifiers|item|classdc|dexcap|familiar|\w+hp\b)|bonus/i},prunedData=foundry.utils.expandObject(Object.fromEntries(Object.entries(foundry.utils.flattenObject(data)).filter(([k,v])=>patterns.positive.test(k)&&!patterns.negative.test(k)&&!["boolean","string"].includes(typeof v))));return super.getTrackedAttributes(prunedData,_path)}static getTrackedAttributeChoices(attributes){return attributes??=this.getTrackedAttributes(),game.pf2e.settings.variants.stamina&&attributes.bar.push(["attributes","hp","sp"]),super.getTrackedAttributeChoices(attributes)}static assignDefaultImage(token){const actor=token.actor;actor&&(game.pf2e.settings.tokens.nathMode&&isDefaultTokenImage(token)?token.texture.src=(()=>{switch(actor.alliance){case"party":return"systems/pf2e/icons/default-icons/alternatives/nath/ally.webp";case"opposition":return"systems/pf2e/icons/default-icons/alternatives/nath/enemy.webp";default:return token.texture.src??CONST.DEFAULT_TOKEN}})():isDefaultTokenImage(token)&&(token.texture.src=actor._source.img))}static prepareScale(token){if(!token.flags.pf2e.autoscale)return;const absoluteScale=token.actor?.size==="sm"?.8:1,mirrorX=token.texture.scaleX<0?-1:1;token.texture.scaleX=mirrorX*absoluteScale;const mirrorY=token.texture.scaleY<0?-1:1;token.texture.scaleY=mirrorY*absoluteScale}getBarAttribute(barName,options){const attribute=super.getBarAttribute(barName,options);if(!attribute)return null;const isStaminaOrResolve=["attributes.hp.sp","resources.resolve"].includes(attribute.attribute)&&game.pf2e.settings.variants.stamina,isSpecialResource=/^resources\.([\w-]+)/.test(attribute.attribute),isShieldHP=attribute.attribute==="attributes.shield.hp"&&!!this.actor?.attributes.shield?.itemId;return(isStaminaOrResolve||isSpecialResource||isShieldHP)&&(attribute.editable=!0),attribute}measureMovementPath(waypoints,options){if(!canvas.grid.isSquare)return super.measureMovementPath(waypoints,options);const normalized=this.isTiny?waypoints.map(p=>({...p,...canvas.grid.getTopLeftPoint({x:p.x??0,y:p.y??0}),width:1,height:1})):waypoints;return super.measureMovementPath(normalized,options)}_initialize(options){this.auras=new Map,super._initialize(options)}prepareBaseData(){super.prepareBaseData();const flags=foundry.utils.mergeObject(this.flags,{pf2e:{}}),actor=this.actor;if(!actor)return;TokenDocumentPF2e.assignDefaultImage(this),flags.pf2e.linkToActorSize??=SIZE_LINKABLE_ACTOR_TYPES.has(actor.type);const settingEnabled=game.pf2e.settings.tokens.autoscale;flags.pf2e.autoscale=settingEnabled&&flags.pf2e.linkToActorSize?flags.pf2e.autoscale??!0:!1,TokenDocumentPF2e.prepareScale(this);const tokenOverrides=actor.synthetics.tokenOverrides;this.name=tokenOverrides.name??this.name,this.alpha=tokenOverrides.alpha??this.alpha,tokenOverrides.texture&&(this.texture.src=tokenOverrides.texture.src,"scaleX"in tokenOverrides.texture&&(this.texture.scaleX=tokenOverrides.texture.scaleX,this.texture.scaleY=tokenOverrides.texture.scaleY,this.flags.pf2e.autoscale=!1),this.texture.tint=tokenOverrides.texture.tint??this.texture.tint),tokenOverrides.ring&&(this.ring.enabled=!0,this.ring.subject={...tokenOverrides.ring.subject},this.ring.colors={...tokenOverrides.ring.colors},this.ring.effects=tokenOverrides.ring.effects,this._source.ring.subject.texture??=this.ring.subject.texture),tokenOverrides.light&&(this.light=new foundry.data.LightData(tokenOverrides.light,{parent:this}));const alliance=actor.system.details.alliance;this.disposition=this.disposition===CONST.TOKEN_DISPOSITIONS.SECRET?CONST.TOKEN_DISPOSITIONS.SECRET:alliance?{party:CONST.TOKEN_DISPOSITIONS.FRIENDLY,opposition:CONST.TOKEN_DISPOSITIONS.HOSTILE}[alliance]:CONST.TOKEN_DISPOSITIONS.NEUTRAL;for(const[key,data]of actor.auras.entries())this.auras.set(key,new TokenAura({token:this,...foundry.utils.deepClone(data)}))}_prepareDetectionModes(){const{actor,scene}=this;if(!scene?.rulesBasedVision||!actor?.isOfType("creature"))return super._prepareDetectionModes();const hasVision=actor.perception.hasVision,lightPerception={id:"lightPerception",enabled:hasVision,range:1/0},basicSight={id:"basicSight",enabled:hasVision,range:0};this.detectionModes=[lightPerception,basicSight];const visionMode=actor.hasDarkvision?"darkvision":"basic";this.sight.attenuation=.1,this.sight.brightness=0,this.sight.contrast=0,this.sight.range=0,this.sight.saturation=0,this.sight.visionMode=visionMode;const visionModeDefaults=CONFIG.Canvas.visionModes[visionMode].vision.defaults;this.sight.brightness=visionModeDefaults.brightness??0,this.sight.saturation=visionModeDefaults.saturation??0,visionMode==="darkvision"&&(this.sight.range=basicSight.range=1/0,actor.isOfType("character")&&actor.flags.pf2e.colorDarkvision?this.sight.saturation=1:game.user.settings.monochromeDarkvision||(this.sight.saturation=0)),actor.perception.senses.has("see-invisibility")&&this.detectionModes.push({id:"seeInvisibility",enabled:!0,range:1/0});const tremorsense=actor.perception.senses.get("tremorsense");if(tremorsense&&this.detectionModes.push({id:"feelTremor",enabled:!0,range:tremorsense.range}),!actor.hasCondition("deafened")){const range=scene?.flags.pf2e.hearingRange??1/0;this.detectionModes.push({id:"hearing",enabled:!0,range})}}_inferMovementAction(){const actor=this.actor;switch(actor?.type){case"character":case"npc":case"familiar":return actor.inCombat?actor.hasCondition("prone")?"crawl":"walk":"travel";case"army":return"deploy";case"vehicle":return"drive";case"party":return"travel";default:return"displace"}}async setInitiative({initiative,sendMessage=!0}){if(!game.combat){ui.notifications.error("PF2E.Encounter.NoActiveEncounter");return}const currentId=game.combat.combatant?.id;this.combatant&&game.combat.combatants.has(this.combatant.id)?await game.combat.setInitiative(this.combatant.id,initiative):await game.combat.createEmbeddedDocuments("Combatant",[{tokenId:this.id,initiative}]),await this.update({turn:game.combat.turns.findIndex(c=>c.id===currentId)}),sendMessage&&await ChatMessagePF2e.createDocuments([{speaker:{scene:this.scene?.id,token:this.id},whisper:this.actor?.hasPlayerOwner?[]:game.users.contents.flatMap(user=>user.isGM?user.id:[]),content:game.i18n.format("PF2E.InitiativeIsNow",{name:this.name,value:initiative})}])}simulateUpdate(updates={}){if(!this.scene?.isInFocus&&!this.scene?.isView)return;const initializeVision=!!this.scene?.isView&&this.sight.enabled&&Object.keys(foundry.utils.flattenObject(updates)).some(k=>k.startsWith("system.perception.senses"));initializeVision&&canvas.perception.update({initializeVision});const preUpdate=this.toObject(!1),preUpdateAuras=Array.from(this.auras.values()).map(a=>n$1(a,["appearance","token"]));this.reset();const postUpdate=this.toObject(!1),postUpdateAuras=Array.from(this.auras.values()).map(a=>n$1(a,["appearance","token"])),tokenChanges=foundry.utils.diffObject(preUpdate,postUpdate);if(!this.actorLink&&this.autoscale&&foundry.utils.hasProperty(updates,"system.traits.size")&&(tokenChanges.texture=foundry.utils.mergeObject(tokenChanges,t$3(this.texture,["scaleX","scaleY"]))),this.scene?.isView&&Object.keys(tokenChanges).length>0){const tokenOverrides=this.actor?.synthetics.tokenOverrides??{},animation=tokenChanges.texture?.src?tokenOverrides.animation??this.#lastAnimation??{}:{};this.#lastAnimation=t$6(animation,this.#lastAnimation??{})?null:tokenOverrides.animation??null,this.object?._onUpdate(tokenChanges,{broadcast:!1,animation},game.user.id)}const aurasChanged=__name2(()=>!!this.scene?.isInFocus&&!t$6(preUpdateAuras,postUpdateAuras),"aurasChanged");("disposition"in tokenChanges||aurasChanged())&&this.scene?.checkAuras?.()}_preCreate(data,options,user){return this.actor?.allowSynthetics===!1&&data.actorLink===!1&&(this._source.actorLink=!0),super._preCreate(data,options,user)}_preUpdate(data,options,user){return this.actor?.allowSynthetics===!1&&(data.actorLink??this.actorLink)===!1&&(data.actorLink=!0),super._preUpdate(data,options,user)}_onCreate(data,options,userId){super._onCreate(data,options,userId),game.user.id===userId&&this.actor?.isOfType("loot")&&this.actor.toggleTokenHiding()}_onUpdate(changed,options,userId){const tokenSetsNameVisibility=game.pf2e.settings.tokens.nameVisibility;return"displayName"in changed&&tokenSetsNameVisibility&&this.combatant&&ui.combat.render(),changed.actorLink===!1&&this.rendered&&this.object?.controlled&&this.object.release(),super._onUpdate(changed,options,userId)}_onRelatedUpdate(update,operation){if(super._onRelatedUpdate(update,operation),!(this.scene instanceof ScenePF2e))return;const updates=Array.isArray(update)?update:[update];this.simulateUpdate(updates[0]);const actor=this.actor;if(!actor?.isOwner)return;const activeGM=game.users.activeGM;if((!activeGM||game.user===activeGM)&&this.linkToActorSize&&actor.system.traits?.size){const dimensions=actor.system.traits.size.tokenDimensions;(dimensions.width!==this.width||dimensions.height!==this.height)&&this.scene.syncTokenDimensions(this,dimensions)}}_onDelete(options,userId){if(super._onDelete(options,userId),!!this.actor)if(this.isLinked)this.scene?.tokens.some(t2=>t2.actor===this.actor)||this.actor.checkAreaEffects();else for(const effect of this.actor.itemTypes.effect)game.pf2e.effectTracker.unregister(effect)}}function TokenConfigMixinPF2e(Base){class TokenConfigMixin extends Base{static{__name(this,"TokenConfigMixin")}static{__name2(this,"TokenConfigMixin")}static#SIGHT_INPUT_NAMES=["angle","brightness","range","saturation","visionMode"].map(n2=>`sight.${n2}`);static DEFAULT_OPTIONS={sheetConfig:!1,actions:{openAutomationSettings:TokenConfigMixin.#onClickOpenAutomationSettings,toggleAutoscale:TokenConfigMixin.#onClickToggleAutoscale,toggleSizeLink:TokenConfigMixin.#onClickToggleSizeLink}};static PARTS=foundry.utils.mergeObject(super.PARTS,{appearance:{template:"systems/pf2e/templates/scene/token/appearance.hbs"}});get dimensionsFromActorSize(){const actorSize=this.actor?.size??"med";return{tiny:.5,sm:1,med:1,lg:2,huge:3,grg:4}[actorSize]}get rulesBasedVision(){return"rulesBasedVision"in this.token?!!this.actor?.isOfType("creature")&&this.token.rulesBasedVision:game.pf2e.settings.rbv}async _prepareContext(options){const context=await super._prepareContext(options),actor=this.actor,sizeLinkable=!!actor&&SIZE_LINKABLE_ACTOR_TYPES.has(actor.type),linkToActorSize=sizeLinkable&&this.linkToActorSize,autoscale=this.autoscale;return Object.assign(context,{sizeLinkable,linkToActorSize,autoscale:sizeLinkable&&autoscale,linkToSizeTitle:linkToActorSize?"Unlink":"Link",autoscaleTitle:autoscale?"Unlink":"Link"})}async _onRender(context,options){if(await super._onRender(context,options),options.parts.includes("identity")&&(this.#swapDispositionField(),this.actor?.allowSynthetics===!1)){const control=htmlQuery(this.element,"input[name=actorLink]");if(control&&control.checked){control.disabled=!0;const typeLocalization=game.i18n.localize(`TYPES.Actor.${this.actor.type}`);control.dataset.tooltip=game.i18n.format("PF2E.Token.ActorLinkForced",{type:typeLocalization})}}options.parts.includes("vision")&&this.#disableVisionInputs()}#swapDispositionField(){const input=this.form?.elements.namedItem("disposition");if(!(input instanceof HTMLSelectElement))return;const formGroup=input.closest(".form-group");if(!formGroup)return;const label=formGroup.querySelector("label");label&&(label.innerText=game.i18n.localize("PF2E.Token.SecretDisposition.Label"));const pEl=document.createElement("p");pEl.className="hint",pEl.innerText=game.i18n.localize("PF2E.Token.SecretDisposition.Hint"),formGroup.append(pEl);const checkbox=document.createElement("input");checkbox.type="checkbox",checkbox.name=input.name,checkbox.id=input.id,checkbox.value=String(CONST.TOKEN_DISPOSITIONS.SECRET),checkbox.dataset.dtype="Number",checkbox.defaultChecked=this.token._source.disposition===CONST.TOKEN_DISPOSITIONS.SECRET,input.replaceWith(checkbox)}#disableVisionInputs(){if(!this.rulesBasedVision)return;const html2=this.element,sightInputs=Array.from(html2.querySelectorAll(TokenConfigMixin.#SIGHT_INPUT_NAMES.map(n2=>`[name="${n2}"]`).join(", "))),sightEnabledInput=html2.querySelector('input[name="sight.enabled"]');if(!sightEnabledInput)throw ErrorPF2e("sight.enabled input not found");sightEnabledInput.addEventListener("change",()=>{for(const input of sightInputs)if(input.disabled=!sightEnabledInput.checked,input.type==="range")sightEnabledInput.checked?input.closest(".form-group")?.classList.remove("children-disabled"):input.closest(".form-group")?.classList.add("children-disabled");else if(input.name==="sight.color"){const colorInput=input.parentElement?.querySelector("input[type=color]");colorInput&&(colorInput.disabled=!sightEnabledInput.checked)}});for(const input of sightInputs)input.disabled=!0;const addModeButton=html2.querySelector("button[data-action=addDetectionMode]");addModeButton&&(addModeButton.disabled=!0);const managedBy=createHTMLElement("button",{classes:["inline-control","icon","fa-solid","fa-robot"],dataset:{action:"openAutomationSettings",tooltip:!0},aria:{label:game.i18n.localize("PF2E.SETTINGS.Automation.RulesBasedVision.ManagedBy")}});managedBy.type="button",managedBy.disabled=!game.user.isGM;for(const sightInput of sightInputs){const button=managedBy.cloneNode(!0),label=sightInput.closest(".form-group")?.querySelector("label");label?.classList.add("managed-by-rbv","flexrow"),label?.append(button)}}static async#onClickOpenAutomationSettings(){const menu=game.settings.menus.get("pf2e.automation");if(menu){const options={highlightSetting:"rulesBasedVision"};new menu.type(void 0,options).render(!0)}}static async#onClickToggleAutoscale(){await this.submit({operation:{render:!1}}),await this.token.update({"flags.pf2e.autoscale":!this.autoscale})}static async#onClickToggleSizeLink(){await this.submit({operation:{render:!1}}),await this.token.update({"flags.pf2e.linkToActorSize":!this.linkToActorSize})}processFormData(data,form){const scaleInput=form.elements.namedItem("scale");return scaleInput instanceof foundry.applications.elements.HTMLRangePickerElement&&scaleInput.disabled&&(data.scale=Math.abs(this.token._source.texture.scaleX)),data.disposition===null&&(data.disposition=this.token.disposition===-2?-1:this.token.disposition),data}async processSubmitData(submitData){if(this.linkToActorSize)if(this.actor?.isOfType("vehicle")){const dimensions=this.actor.dimensions,width=Math.max(Math.round(dimensions.width/5),1),length=Math.max(Math.round(dimensions.length/5),1);submitData.width=width,submitData.height=length}else submitData.width=submitData.height=this.dimensionsFromActorSize}}return TokenConfigMixin}__name(TokenConfigMixinPF2e,"TokenConfigMixinPF2e"),__name2(TokenConfigMixinPF2e,"TokenConfigMixinPF2e");class PrototypeTokenConfigPF2e extends TokenConfigMixinPF2e(foundry.applications.sheets.PrototypeTokenConfig){static{__name(this,"PrototypeTokenConfigPF2e")}static{__name2(this,"PrototypeTokenConfigPF2e")}get linkToActorSize(){return this.actor.prototypeToken.flags.pf2e.linkToActorSize}get autoscale(){return this.actor.prototypeToken.flags.pf2e.autoscale}_processFormData(event2,form,formData){const data=super._processFormData(event2,form,formData);return this.processFormData(data,form)}async _processChanges(submitData){return this.processSubmitData(submitData),super._processChanges(submitData)}}class TokenConfigPF2e extends TokenConfigMixinPF2e(foundry.applications.sheets.TokenConfig){static{__name(this,"TokenConfigPF2e")}static{__name2(this,"TokenConfigPF2e")}get linkToActorSize(){return!!this.token.flags.pf2e.linkToActorSize}get autoscale(){return!!this.token.flags.pf2e.autoscale}_processFormData(event2,form,formData){return this.processFormData(formData.object,form),super._processFormData(event2,form,formData)}async _processSubmitData(event2,form,submitData,options){return this.processSubmitData(submitData),super._processSubmitData(event2,form,submitData,options)}}function resolveSheetDocument(html2){const doc=(ui.windows[Number(html2.closest(".app.sheet")?.dataset.appid)]??null)?.document;return doc&&(doc instanceof ActorPF2e||doc instanceof ItemPF2e||doc instanceof JournalEntry)?doc:null}__name(resolveSheetDocument,"resolveSheetDocument"),__name2(resolveSheetDocument,"resolveSheetDocument");function resolveActorAndItemFromHTML(html2){const messageId=htmlClosest(html2,"[data-message-id]")?.dataset.messageId,message=messageId?game.messages.get(messageId)??null:null,sheetDocument=resolveSheetDocument(html2),sheetActor=sheetDocument instanceof ActorPF2e?sheetDocument:null,sheetItem=sheetDocument instanceof ItemPF2e?sheetDocument:null,item=(()=>{if(UUIDUtils.isItemUUID(html2.dataset.itemUuid)){const document2=fromUuidSync(html2.dataset.itemUuid);if(document2 instanceof ItemPF2e)return document2}if(sheetItem)return sheetItem;if(sheetActor){const itemId=htmlClosest(html2,"[data-item-id]")?.dataset.itemId,document2=itemId?sheetActor.items.get(itemId):null;if(document2)return document2}return message?.item??null})();return{sheetActor,actor:item?.actor??message?.actor??null,item,message,appDocument:message??sheetDocument}}__name(resolveActorAndItemFromHTML,"resolveActorAndItemFromHTML"),__name2(resolveActorAndItemFromHTML,"resolveActorAndItemFromHTML");const inlineSelector=["action","check","effect-area"].map(keyword=>`[data-pf2-${keyword}]`).join(",");class InlineRollLinks{static{__name(this,"InlineRollLinks")}static{__name2(this,"InlineRollLinks")}static activatePF2eListeners(){document.addEventListener("click",event2=>{const getLinkOrSpan=__name2(attr=>htmlClosest(event2.target,`a[${attr}], span[${attr}]`),"getLinkOrSpan"),repostLink=htmlClosest(event2.target,"i[data-pf2-repost]");if(repostLink){const link=htmlClosest(repostLink,"a, span");link&&this.#onRepostAction(link);return}const checkLink=getLinkOrSpan("data-pf2-check");if(checkLink){this.#onClickInlineCheck(event2,checkLink);return}const actionLink=getLinkOrSpan("data-pf2-action");if(actionLink){this.#onClickInlineAction(event2,actionLink);return}const areaLink=getLinkOrSpan("data-pf2-effect-area");if(areaLink){this.#onClickInlineTemplate(event2,areaLink);return}},{passive:!0})}static injectRepostElements(html2,foundryDoc){const links=htmlQueryAll(html2,inlineSelector).filter(l=>["A","SPAN"].includes(l.nodeName));foundryDoc??=resolveSheetDocument(html2);for(const link of links){(!foundryDoc||foundryDoc.isOwner)&&link.classList.add("with-repost");const repostButtons=htmlQueryAll(link,"i[data-pf2-repost]");if(repostButtons.length>0){if(foundryDoc&&!foundryDoc.isOwner){for(const button of repostButtons)button.remove();link.classList.remove("with-repost")}continue}if(foundryDoc&&!foundryDoc.isOwner)continue;const newButton=document.createElement("i"),icon=link.parentElement?.dataset?.pf2Checkgroup!==void 0?"fa-comment-alt-dots":"fa-comment-alt";newButton.classList.add("fa-solid",icon),newButton.dataset.pf2Repost="",newButton.title=game.i18n.localize("PF2E.Repost"),link.appendChild(newButton)}}static#makeRepostHtml(target,defaultVisibility){const flavor=game.i18n.localize(target.dataset.pf2RepostFlavor??""),showDC=target.dataset.pf2ShowDc??defaultVisibility;return(flavor?`<span data-visibility="${showDC}">${flavor}</span> `:"")+`${target.outerHTML}`.trim()}static#onClickInlineAction(event2,link){const{pf2Action,pf2Glyph,pf2Variant,pf2Dc,pf2ShowDc,pf2Skill,pf2Options,pf2Traits}=link.dataset,slug=sluggify(pf2Action??""),visibility=pf2ShowDc??"all",difficultyClass=Number.isNumeric(pf2Dc)?{scope:"check",value:Number(pf2Dc)||0,visibility}:pf2Dc,maybeTraits=splitListString(pf2Traits??""),traits=maybeTraits.filter(trait=>trait in CONFIG.PF2E.actionTraits),rollOptions=n([maybeTraits,traits.map(trait=>`item:trait:${trait}`),splitListString(pf2Options??"")].flat());if(slug&&game.pf2e.actions.has(slug))game.pf2e.actions.get(slug)?.use({event:event2,variant:pf2Variant,difficultyClass,rollOptions,statistic:pf2Skill,traits}).catch(reason=>ui.notifications.warn(reason));else{const action2=game.pf2e.actions[pf2Action?sluggify(pf2Action,{camel:"dromedary"}):""];pf2Action&&action2?action2({event:event2,glyph:pf2Glyph,variant:pf2Variant,difficultyClass,rollOptions,skill:pf2Skill,traits}):console.warn(`PF2e System | Skip executing unknown action '${pf2Action}'`)}}static async#onClickInlineCheck(event2,link){const{pf2Check,pf2Dc,pf2Traits,pf2Label,pf2Adjustment,pf2Roller,pf2RollOptions}=link.dataset,against=link.dataset.against||link.dataset.pf2Defense,overrideTraits="overrideTraits"in link.dataset,targetOwner="targetOwner"in link.dataset;if(!pf2Check)return;const{actor:parentActor,item:itemFromDoc,sheetActor}=resolveActorAndItemFromHTML(link),actors=(()=>{switch(pf2Roller){case"self":return parentActor?.canUserModify(game.user,"update")?[parentActor]:[];case"party":return parentActor?.isOfType("party")?[parentActor]:[game.actors.party??[]].flat()}if(sheetActor&&!sheetActor.isOfType("loot","party")&&sheetActor.isOwner)return[sheetActor];if(parentActor?.isOfType("party")&&parentActor?.getStatistic(pf2Check))return[parentActor];const rollingActors=getSelectedActors({exclude:["loot"],assignedFallback:!0}),isSave=tupleHasValue(SAVE_TYPES,pf2Check);return rollingActors.length===0&&parentActor&&!isSave?[parentActor]:rollingActors})();if(actors.length===0){ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected",{localize:!0});return}const maybeTraits=splitListString(pf2Traits??""),additionalTraits=maybeTraits.filter(t2=>t2 in CONFIG.PF2E.actionTraits),extraRollOptions=n([maybeTraits,additionalTraits.map(t2=>`item:trait:${t2}`),splitListString(pf2RollOptions??"")].flat()),eventRollParams=eventToRollParams(event2,{type:"check"}),checkSlug=link.dataset.slug?sluggify(link.dataset.slug):null;if(pf2Check==="flat"){for(const actor of actors){const flatCheck=new Statistic(actor,{label:"",slug:"flat",modifiers:[],check:{type:"flat-check"}}),dc=Number.isInteger(Number(pf2Dc))?{label:pf2Label,value:Number(pf2Dc)}:null;flatCheck.roll({...eventRollParams,slug:checkSlug,extraRollOptions,dc})}return}const isSavingThrow=tupleHasValue(SAVE_TYPES,pf2Check),abilityTraits=isSavingThrow?[]:extraRollOptions.filter(t2=>t2 in CONFIG.PF2E.actionTraits),actorStatistics=actors.map(actor=>{const relatedItem=itemFromDoc?.actor?.uuid===actor.uuid?itemFromDoc:null;return{actor,statistic:actor.getStatistic(pf2Check,{item:relatedItem})}});if(!actorStatistics.some(({statistic})=>!!statistic)){ui.notifications.error(game.i18n.format("PF2E.ErrorMessage.MissingStatisticSelected",{statistic:pf2Check}));return}for(const{actor:rollingActor,statistic}of actorStatistics){if(!statistic){console.warn(ErrorPF2e(`Skip rolling unknown statistic ${pf2Check} for actor ${rollingActor.name}`).message);continue}const rollerRole=tupleHasValue(["origin","target"],link.dataset.rollerRole)?link.dataset.rollerRole:isSavingThrow?"target":"origin",opposingRole=rollerRole==="target"?"origin":"target",targetActor=against&&rollerRole==="target"?rollingActor:targetOwner?parentActor:game.user.targets.first()?.actor??null,opposingActor=rollerRole==="target"?parentActor:targetActor,originActor=rollerRole==="origin"?rollingActor:parentActor,item=itemFromDoc?.actor&&(itemFromDoc.isOfType("action","feat","campaignFeature")||isSavingThrow&&!itemFromDoc?.isOfType("weapon"))?itemFromDoc:null,dc=(()=>{const dcValue=pf2Dc==="@self.level"?calculateDC(rollingActor.level):Number(pf2Dc??"NaN"),adjustment=Number(pf2Adjustment)||0;if(Number.isInteger(dcValue))return{label:pf2Label,value:dcValue+adjustment};if(against){const defenseStat=opposingActor?.getStatistic(against)?.clone({modifiers:adjustment?[new Modifier({label:"PF2E.InlineCheck.DCAdjustment",modifier:adjustment})]:[],rollOptions:[item?.isOfType("action","feat")?`${opposingRole}:action:slug:${item.slug}`:null].filter(e$1)});if(defenseStat)return{label:defenseStat.dc.label??game.i18n.format("PF2E.InlineCheck.DCWithName",{name:defenseStat.label}),statistic:defenseStat.dc,scope:"check",value:defenseStat.dc.value}}return null})(),args={...eventRollParams,extraRollOptions,origin:originActor,dc,target:dc?.statistic?targetActor:null,item,traits:abilityTraits};if(!overrideTraits&&rollerRole==="origin"&&!!(item?.isOfType("action","feat")&&item.actionCost)){const subtitleLocKey=pf2Check in CONFIG.PF2E.magicTraditions?"PF2E.ActionsCheck.spell":statistic.check.type==="attack-roll"?"PF2E.ActionsCheck.x-attack-roll":"PF2E.ActionsCheck.x";args.label=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:getActionGlyph(item.actionCost),subtitle:game.i18n.format(subtitleLocKey,{type:statistic.label}),title:item.name}),extraRollOptions.push(...TextEditorPF2e.createActionOptions(item))}statistic.roll(args)}}static#onClickInlineTemplate(_event,link){if(!canvas.ready)return;const templateConversion={burst:"circle",cone:"cone",cube:"rect",emanation:"circle",line:"ray",rect:"rect",square:"rect"},{pf2EffectArea,pf2Distance,pf2TemplateData,pf2Traits,pf2Width}=link.dataset;if(typeof pf2EffectArea!="string"){console.warn("PF2e System | Could not create template'");return}const{actor,item,message}=resolveActorAndItemFromHTML(link),data=JSON.parse(pf2TemplateData??"{}");switch(data.distance||=Number(pf2Distance),data.fillColor||=game.user.color.toString(),data.t=templateConversion[pf2EffectArea],data.t){case"ray":data.width=Number(pf2Width)||CONFIG.MeasuredTemplate.defaults.width*canvas.dimensions.distance;break;case"cone":data.angle||=CONFIG.MeasuredTemplate.defaults.angle;break;case"rect":{const distance=data.distance??0;data.distance=Math.hypot(distance,distance),data.width=distance,data.direction=45;break}}const flags={pf2e:{}},normalSize=Math.ceil(data.distance)/5*5||5;if(tupleHasValue(EFFECT_AREA_SHAPES,pf2EffectArea)&&data.distance===normalSize&&(flags.pf2e.areaShape=pf2EffectArea),message&&(flags.pf2e.messageId=message.id),item){const origin=item.getOriginData();flags.pf2e.origin=origin}else(actor||pf2Traits)&&(flags.pf2e.origin={actor:actor?.uuid??null,traits:splitListString(pf2Traits??"")});e$4(flags.pf2e)||(data.flags=flags),canvas.templates.createPreview(data)}static async#onRepostAction(target){if(!["pf2Action","pf2Check","pf2EffectArea"].some(d=>d in target.dataset))return;const{actor,appDocument}=resolveActorAndItemFromHTML(target),defaultVisibility=(actor??appDocument)?.hasPlayerOwner?"all":"gm",content=target.parentElement?.dataset?.pf2Checkgroup!==void 0?`<div data-pf2-checkgroup>${htmlQueryAll(target.parentElement,inlineSelector).map(target2=>this.#makeRepostHtml(target2,defaultVisibility)).join("<br>")}</div>`:this.#makeRepostHtml(target,defaultVisibility),speaker=actor?ChatMessagePF2e.getSpeaker({actor,token:actor.getActiveTokens(!0,!0).shift()}):ChatMessagePF2e.getSpeaker(),message=game.messages.get(htmlClosest(target,"[data-message-id]")?.dataset.messageId??""),flags=appDocument instanceof JournalEntry?{pf2e:{journalEntry:appDocument.uuid}}:message?.flags.pf2e.origin?{pf2e:{origin:foundry.utils.deepClone(message.flags.pf2e.origin)}}:{};return ChatMessagePF2e.create({speaker,content,flags})}static flavorDamageRolls(html2,document2=null){const actor=resolveActor(document2??resolveActorAndItemFromHTML(html2).actor);for(const rollLink of htmlQueryAll(html2,"a.inline-roll[data-damage-roll]")){const itemId=htmlClosest(rollLink,"[data-item-id]")?.dataset.itemId,item=actor?.items.get(itemId??"");item&&(rollLink.dataset.flavor||=item.name)}}}function resolveActor(foundryDoc){return foundryDoc instanceof ActorPF2e?foundryDoc:foundryDoc instanceof ItemPF2e||foundryDoc instanceof ChatMessagePF2e?foundryDoc.actor:null}__name(resolveActor,"resolveActor"),__name2(resolveActor,"resolveActor");class UserVisibilityPF2e{static{__name(this,"UserVisibilityPF2e")}static{__name2(this,"UserVisibilityPF2e")}static process(html2,options={}){const visibilityElements=htmlQueryAll(html2,"[data-visibility]");for(const element of visibilityElements.filter(e2=>e2.dataset.visibility==="none"))element.remove();const message=options.message,document2=options.document??message?.actor??message?.journalEntry??message??null;if(document2){const ownerElements=visibilityElements.filter(e2=>e2.dataset.visibility==="owner");for(const element of ownerElements){if(element.dataset.action){document2.isOwner||element.remove(),delete element.dataset.visibility;continue}const whoseData=element.dataset.whose??"self";if(whoseData==="self"){element.dataset.visibility=document2.hasPlayerOwner?"all":"gm";continue}message?.target&&whoseData==="opposer"&&(element.dataset.visibility=message.target.actor.hasPlayerOwner?"all":"gm")}}const hasOwnership=document2?.isOwner??game.user.isGM,dcSetting=game.pf2e.settings.metagame.dcs,saveButtons=htmlQueryAll(html2,"button[data-action=save]");if(!document2?.hasPlayerOwner&&!hasOwnership&&!dcSetting)for(const button of saveButtons){const saveType=button.dataset.save;if(objectHasKey(CONFIG.PF2E.saves,saveType)){const saveName=game.i18n.localize(CONFIG.PF2E.saves[saveType]);button.innerText=game.i18n.format("PF2E.SavingThrowWithName",{saveName})}}else if(!document2?.hasPlayerOwner&&!dcSetting)for(const button of saveButtons)button.classList.add("hidden-to-others");for(const element of htmlQueryAll(html2,"[data-owner-title]"))if(hasOwnership){const value=element.dataset.ownerTitle??"";element.title=value}else element.removeAttribute("data-owner-title");if(!game.user.isGM)for(const element of visibilityElements.filter(e2=>e2.dataset.visibility==="gm"))element.remove();InlineRollLinks.injectRepostElements(html2,document2),InlineRollLinks.flavorDamageRolls(html2,document2)}static processMessageSender(message,html2){if(!game.pf2e.settings.tokens.nameVisibility)return;const token=message.token??(message.actor?new TokenDocumentPF2e(message.actor.prototypeToken.toObject()):null);if(token){const sender=html2.querySelector("h4.message-sender"),nameToHide=token.name.trim(),shouldHideName=!token.playersCanSeeName&&sender?.innerText.includes(nameToHide);sender&&shouldHideName&&(game.user.isGM?sender.dataset.visibility="gm":sender.innerText=message.author?.name??"Gamemaster")}}}const USER_VISIBILITIES=new Set(["all","owner","gm","none"]);class CriticalHitAndFumbleCards{static{__name(this,"CriticalHitAndFumbleCards")}static{__name2(this,"CriticalHitAndFumbleCards")}static#rollTypes=["attack-roll","spell-attack-roll"];static#diceSoNice;static#setting;static handleDraw(message){if(message.isAuthor&&message.isContentVisible){const type2=message.flags.pf2e.context?.type??"",firstDie=message.rolls.at(0)?.dice[0];firstDie&&firstDie.faces===20&&this.#rollTypes.includes(type2)&&(firstDie.total===20?this.#automaticDraw("critTable"):firstDie.total===1&&this.#automaticDraw("fumbleTable"))}}static#automaticDraw(table){this.#diceSoNice??=!!game.modules.get("dice-so-nice")?.active,this.#diceSoNice?Hooks.once("diceSoNiceRollComplete",()=>{this.#drawFromTable(table,!0)}):this.#drawFromTable(table,!0)}static#drawFromTable(table,automatic=!1){const tableId=table==="critTable"?"FTEpsIWWVrDj0jNG":"WzMGWMIrrPvSp75D";game.packs.get("pf2e.rollable-tables",{strict:!0}).getDocument(tableId).then(rollTable=>{rollTable?.draw({displayChat:!1}).then(draw=>{const data={roll:draw.roll,messageData:{}};automatic&&!this.#diceSoNice&&(data.messageData.sound=void 0),rollTable?.toMessage(draw.results,data)})})}static appendButtons(message,html2){if(this.#setting??=game.pf2e.settings.critFumble.buttons,!this.#setting||!(message.isAuthor||game.user.isGM)||!message.isContentVisible)return;const type2=message.flags.pf2e.context?.type??"";if(!this.#rollTypes.includes(type2))return;const $critButton=$(`<button class="dice-total-fullDamage-btn" style="width: 22px; height:22px; font-size:10px;line-height:1px"><i class="fa-solid fa-thumbs-up" title="${game.i18n.localize("PF2E.CriticalHitCardButtonTitle")}"></i></button>`),$fumbleButton=$(`<button class="dice-total-fullDamage-btn" style="width: 22px; height:22px; font-size:10px;line-height:1px"><i class="fa-solid fa-thumbs-down" title="${game.i18n.localize("PF2E.CriticalFumbleCardButtonTitle")}"></i></button>`),$container=$('<span class="dmgBtn-container" style="position:absolute; right:0; bottom:1px;"></span>');$container.append($critButton),$container.append($fumbleButton),$critButton.on("click",event2=>{event2.stopPropagation(),this.#drawFromTable("critTable"),event2.currentTarget.blur()}),$fumbleButton.on("click",event2=>{event2.stopPropagation(),this.#drawFromTable("fumbleTable"),event2.currentTarget.blur()}),$(html2).find(".dice-total").wrapInner('<span id="value"></span>').append($container)}}function buildRewards(...rewards){const[trained,expert,master,legendary]=rewards;return{1:new Coins(trained),2:new Coins(expert??trained),3:new Coins(master??expert??trained),4:new Coins(legendary??master??expert??trained)}}__name(buildRewards,"buildRewards"),__name2(buildRewards,"buildRewards");const earnIncomeTable={0:{failure:{cp:1},rewards:buildRewards({cp:5})},1:{failure:{cp:2},rewards:buildRewards({sp:2})},2:{failure:{cp:4},rewards:buildRewards({sp:3})},3:{failure:{cp:8},rewards:buildRewards({sp:5})},4:{failure:{sp:1},rewards:buildRewards({sp:7},{sp:8})},5:{failure:{sp:2},rewards:buildRewards({sp:9},{gp:1})},6:{failure:{sp:3},rewards:buildRewards({gp:1,sp:5},{gp:2})},7:{failure:{sp:4},rewards:buildRewards({gp:2},{gp:2,sp:5})},8:{failure:{sp:5},rewards:buildRewards({gp:2,sp:5},{gp:3})},9:{failure:{sp:6},rewards:buildRewards({gp:3},{gp:4})},10:{failure:{sp:7},rewards:buildRewards({gp:4},{gp:5},{gp:6})},11:{failure:{sp:8},rewards:buildRewards({gp:5},{gp:6},{gp:8})},12:{failure:{sp:9},rewards:buildRewards({gp:6},{gp:8},{gp:10})},13:{failure:{gp:1},rewards:buildRewards({gp:7},{gp:10},{gp:15})},14:{failure:{gp:1,sp:5},rewards:buildRewards({gp:8},{gp:15},{gp:20})},15:{failure:{gp:2},rewards:buildRewards({gp:10},{gp:20},{gp:28})},16:{failure:{gp:2,sp:5},rewards:buildRewards({gp:13},{gp:25},{gp:36},{gp:40})},17:{failure:{gp:3},rewards:buildRewards({gp:15},{gp:30},{gp:45},{gp:55})},18:{failure:{gp:4},rewards:buildRewards({gp:20},{gp:45},{gp:70},{gp:90})},19:{failure:{gp:6},rewards:buildRewards({gp:30},{gp:60},{gp:100},{gp:130})},20:{failure:{gp:8},rewards:buildRewards({gp:40},{gp:75},{gp:150},{gp:200})},21:{failure:{cp:0},rewards:buildRewards({gp:50},{gp:90},{gp:175},{gp:300})}};function getIncomeForLevel(level){const income=earnIncomeTable[Math.clamp(level,0,21)];return{failure:new Coins(income.failure),rewards:income.rewards}}__name(getIncomeForLevel,"getIncomeForLevel"),__name2(getIncomeForLevel,"getIncomeForLevel");function applyIncomeOptions({result,options,level,proficiency}){options.useLoreAsExperiencedProfessional&&(result.degreeOfSuccess===DegreeOfSuccess.CRITICAL_FAILURE?(result.degreeOfSuccess=DegreeOfSuccess.FAILURE,result.rewards=new Coins(getIncomeForLevel(level).failure)):result.degreeOfSuccess===DegreeOfSuccess.FAILURE&&proficiency!==1&&(result.rewards=new Coins(result.rewards).scale(2)))}__name(applyIncomeOptions,"applyIncomeOptions"),__name2(applyIncomeOptions,"applyIncomeOptions");function earnIncome({level,days,rollBrief,proficiency,options,dc}){const degree=new DegreeOfSuccess(rollBrief,dc),result={rewards:new Coins,degreeOfSuccess:degree.value};return degree.value===DegreeOfSuccess.CRITICAL_SUCCESS?result.rewards=getIncomeForLevel(level+1).rewards[proficiency]:degree.value===DegreeOfSuccess.SUCCESS?result.rewards=getIncomeForLevel(level).rewards[proficiency]:degree.value===DegreeOfSuccess.FAILURE&&(result.rewards=getIncomeForLevel(level).failure),applyIncomeOptions({result,options,level,proficiency}),{rewards:{perDay:result.rewards,combined:new Coins(result.rewards).scale(days)},degreeOfSuccess:result.degreeOfSuccess,daysSpentWorking:days,level,dc,roll:degree.rollTotal}}__name(earnIncome,"earnIncome"),__name2(earnIncome,"earnIncome");const appv1$h=foundry.appv1;function calculateDaysToNoCost(costs){return Math.ceil((costs.itemPrice.copperValue-costs.materials.copperValue)/costs.reductionPerDay.copperValue)}__name(calculateDaysToNoCost,"calculateDaysToNoCost"),__name2(calculateDaysToNoCost,"calculateDaysToNoCost");async function prepStrings(costs,item){const rollData=item.getRollData();return{reductionPerDay:costs.reductionPerDay.toString(),materialCost:game.i18n.format("PF2E.Actions.Craft.Details.PayMaterials",{cost:costs.materials.toString()}),itemCost:game.i18n.format("PF2E.Actions.Craft.Details.PayFull",{cost:costs.itemPrice.toString()}),lostMaterials:game.i18n.format("PF2E.Actions.Craft.Details.LostMaterials",{cost:costs.lostMaterials.toString()}),itemLink:await TextEditorPF2e.enrichHTML(item.link,{rollData})}}__name(prepStrings,"prepStrings"),__name2(prepStrings,"prepStrings");function calculateCosts(item,quantity,actor,degreeOfSuccess,skill="crafting"){const itemPrice=Coins.fromPrice(item.price,quantity),materialCosts=itemPrice.scale(.5),lostMaterials=new Coins,reductionPerDay=new Coins,proficiency=actor.skills[skill]?.rank;return proficiency?(degreeOfSuccess===DegreeOfSuccess.CRITICAL_SUCCESS?Object.assign(reductionPerDay,getIncomeForLevel(actor.level+1).rewards[proficiency]):degreeOfSuccess===DegreeOfSuccess.SUCCESS?Object.assign(reductionPerDay,getIncomeForLevel(actor.level).rewards[proficiency]):degreeOfSuccess===DegreeOfSuccess.CRITICAL_FAILURE&&Object.assign(lostMaterials,materialCosts.scale(.1)),{itemPrice,materials:materialCosts,lostMaterials,reductionPerDay}):null}__name(calculateCosts,"calculateCosts"),__name2(calculateCosts,"calculateCosts");async function craftItem(item,itemQuantity,actor,infused){const itemSource=item.toObject();itemSource.system.quantity=itemQuantity,itemSource.system.size=actor.size==="tiny"?"tiny":"med";const itemTraits=item.traits;if(infused&&itemTraits.has("alchemical")&&itemTraits.has("consumable")&&(itemSource.system.traits.value.push("infused"),itemSource.system.temporary=!0),!await actor.addToInventory(itemSource)){ui.notifications.warn(game.i18n.localize("PF2E.Actions.Craft.Warning.CantAddItem"));return}await ChatMessagePF2e.create({author:game.user.id,content:game.i18n.format("PF2E.Actions.Craft.Information.ReceiveItem",{actorName:actor.name,quantity:itemQuantity,itemName:item.name}),speaker:{alias:actor.name}})}__name(craftItem,"craftItem"),__name2(craftItem,"craftItem");async function craftSpellConsumable(item,itemQuantity,actor){const consumableType=item.category;if(!(consumableType==="scroll"||consumableType==="wand"))return;const rank=consumableType==="wand"?Math.ceil(item.level/2)-1:Math.ceil(item.level/2),validSpells=actor.itemTypes.spell.filter(s=>s.baseRank<=rank&&!s.isCantrip&&!s.isFocusSpell&&!s.isRitual).reduce((result,spell)=>(result[spell.baseRank]=[...result[spell.baseRank]||[],spell],result),{}),content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/crafting-select-spell-dialog.hbs",{spells:validSpells});new appv1$h.api.Dialog({title:game.i18n.localize("PF2E.Actions.Craft.SelectSpellDialog.Title"),content,buttons:{cancel:{icon:fontAwesomeIcon("times").outerHTML,label:game.i18n.localize("Cancel")},craft:{icon:fontAwesomeIcon("hammer").outerHTML,label:game.i18n.localize("PF2E.Actions.Craft.SelectSpellDialog.CraftButtonLabel"),callback:__name2(async $dialog=>{const spellId=String($dialog.find("select[name=spell]").val()),spell=actor.items.get(spellId);if(!spell?.isOfType("spell"))return;const data=await createConsumableFromSpell(spell,{type:consumableType,rank});return craftItem(new ItemProxyPF2e(data),itemQuantity,actor)},"callback")}},default:"craft"}).render(!0)}__name(craftSpellConsumable,"craftSpellConsumable"),__name2(craftSpellConsumable,"craftSpellConsumable");async function renderCraftingInline(item,roll,quantity,actor,free,skill="crafting"){if(!actor.isOfType("character"))return null;const degreeOfSuccess=roll.options.degreeOfSuccess??0,costs=calculateCosts(item,quantity,actor,degreeOfSuccess,skill);if(!costs)return null;const daysForZeroCost=degreeOfSuccess>1?calculateDaysToNoCost(costs):0;return await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/crafting-result.hbs",{daysForZeroCost,strings:await prepStrings(costs,item),item,quantity,success:degreeOfSuccess>1,criticalFailure:degreeOfSuccess===0,free})}__name(renderCraftingInline,"renderCraftingInline"),__name2(renderCraftingInline,"renderCraftingInline");const fields$1a=foundry.data.fields;class ElementalBlast{static{__name(this,"ElementalBlast")}static{__name2(this,"ElementalBlast")}actor;statistic;item;configs;infusion;constructor(actor){if(!actor.isOfType("character"))throw ErrorPF2e("Must construct with a PC");this.actor=actor,this.statistic=this.actor.getStatistic("impulse"),this.item=this.actor.itemTypes.action.find(a=>a.slug==="elemental-blast")??null,this.infusion=this.#prepareBlastInfusion(),this.configs=this.#prepareBlastConfigs()}static#blastConfigSchema=new fields$1a.SchemaField({element:new fields$1a.StringField({required:!0,choices:__name2(()=>CONFIG.PF2E.effectTraits,"choices"),initial:void 0}),label:new fields$1a.StringField({required:!0,blank:!1,initial:void 0}),img:new fields$1a.FilePathField({required:!0,categories:["IMAGE"],nullable:!1,initial:"systems/pf2e/icons/default-icons/spell.svg"}),damageTypes:new fields$1a.ArrayField(new fields$1a.StringField({required:!0,choices:__name2(()=>CONFIG.PF2E.damageTypes,"choices"),initial:void 0})),dieFaces:new fields$1a.NumberField({required:!0,nullable:!1,integer:!0,choices:[6,8],initial:void 0}),range:new fields$1a.NumberField({required:!0,nullable:!1,integer:!0,positive:!0,initial:void 0})});static#blastInfusionSchema=new fields$1a.SchemaField({damageTypes:new fields$1a.ArrayField(new fields$1a.StringField({required:!0,choices:__name2(()=>CONFIG.PF2E.damageTypes,"choices"),initial:void 0})),range:new fields$1a.SchemaField({increment:new fields$1a.NumberField({required:!0,integer:!0,positive:!0,nullable:!1}),max:new fields$1a.NumberField({required:!0,integer:!0,positive:!0,nullable:!1})},{required:!1,nullable:!0,initial:null}),traits:new fields$1a.SchemaField({melee:new fields$1a.ArrayField(new fields$1a.StringField({required:!0,nullable:!1,choices:__name2(()=>CONFIG.PF2E.weaponTraits,"choices"),initial:void 0})),ranged:new fields$1a.ArrayField(new fields$1a.StringField({required:!0,nullable:!1,choices:__name2(()=>CONFIG.PF2E.weaponTraits,"choices"),initial:void 0}))})});get actionCost(){const cost=this.item?.flags.pf2e.rulesSelections.actionCost??1;if(cost!==1&&cost!==2)throw ErrorPF2e("Action cost must be 1 or 2");return cost}#prepareBlastConfigs(){const{item,statistic,actionCost,infusion}=this;if(!item||!statistic)return[];const kineticist=this.actor.flags.pf2e.kineticist;if(!e$2(kineticist)||!e$2(kineticist.elementalBlast))return[this.#getDisabledBlast(statistic,item.name)];const schema=ElementalBlast.#blastConfigSchema,damageTypeSelections=(()=>{const flag=item.flags.pf2e.damageSelections;return e$2(flag)?flag:{}})(),blasts=Object.values(kineticist.elementalBlast).filter(b=>e$2(b)&&"element"in b).map(b=>schema.clean(b)),validationFailures=blasts.flatMap(b=>schema.validate(b)??[]);for(const failure of validationFailures)throw failure.asError();item.flags.pf2e.attackItemBonus=statistic.check.modifiers.find(m=>m.enabled&&["item","potency"].includes(m.type))?.value??0;const maps=(()=>{const domains=[...statistic.check.domains,"elemental-blast-attack-roll"],options=this.actor.getRollOptions(domains),mapsFor=__name2(melee=>{const modifiedItem=this.#createModifiedItem({melee})??item,modifier=this.#createAttackStatistic(statistic,modifiedItem).check.mod,penalties=calculateMAPs(modifiedItem,{domains,options});return{map0:signedInteger(modifier),map1:game.i18n.format("PF2E.MAPAbbreviationValueLabel",{value:signedInteger(modifier+penalties.map1),penalty:penalties.map1}),map2:game.i18n.format("PF2E.MAPAbbreviationValueLabel",{value:signedInteger(modifier+penalties.map2),penalty:penalties.map2})}},"mapsFor");return{melee:mapsFor(!0),ranged:mapsFor(!1)}})();return blasts.map(blast=>{const damageTypes2=n([blast.damageTypes,this.infusion?.damageTypes].flat().filter(e$1)).map(dt=>({value:dt,label:game.i18n.localize(CONFIG.PF2E.damageTypes[dt]),icon:DAMAGE_TYPE_ICONS[dt]??"",selected:damageTypeSelections[blast.element]===dt})).sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang)),firstDamageType=damageTypes2.at(0);firstDamageType&&!damageTypes2.some(dt=>dt.selected)&&(firstDamageType.selected=!0);const maxRange=infusion?.range?.max??blast.range,range=infusion?.range?.increment?{increment:infusion.range.increment,max:infusion.range.increment*6,label:game.i18n.format("PF2E.Action.Range.IncrementN",{n:infusion.range.increment})}:{increment:null,max:maxRange,label:game.i18n.format("PF2E.Action.Range.MaxN",{n:maxRange})};return{...blast,statistic,item,ready:!0,maps,actionCost,damageTypes:damageTypes2,range}})}#prepareBlastInfusion(){const schema=ElementalBlast.#blastInfusionSchema,flag=this.actor.flags.pf2e.kineticist,infusionData=e$2(flag)&&e$2(flag.elementalBlast)?flag.elementalBlast.infusion:null;return e$2(infusionData)?schema.clean(infusionData):null}#getBlastConfig(element,damageType){const config=this.configs.find(c=>c.element===element&&c.damageTypes.some(t2=>t2.value===damageType));if(!config)throw ErrorPF2e(`Elemental blast configuration of element ${element} and damage type ${damageType} not found.`);return config}#getDisabledBlast(statistic,label){if(!this.item)throw ErrorPF2e("Unexpected missing Elemental Blast item");return{ready:!1,statistic,item:this.item,img:"icons/magic/sonic/projectile-shock-wave-blue.webp",element:"fire",dieFaces:6,label,maps:{melee:{map0:"",map1:"",map2:""},ranged:{map0:"",map1:"",map2:""}},actionCost:this.actionCost,damageTypes:[{value:"fire",label:"",icon:"",selected:!0}],range:{increment:null,max:30,label:""}}}#createModifiedItem({melee,config,damageType}){const item=this.item;if(!item)return null;const traits=(()=>{const baseTraits=this.item?.system.traits.value??[],infusionTraits=melee?this.infusion?.traits.melee:this.infusion?.traits.ranged;return n([baseTraits,infusionTraits,config?.element,damageType].flat().filter(t2=>!!t2&&t2 in CONFIG.PF2E.actionTraits)).sort()})(),clone=item.clone({system:{traits:{value:traits}}},{keepId:!0});return clone.range=melee?null:config?.range??null,clone.isMelee=melee,clone}#createAttackStatistic(statistic,item){const newDomain="elemental-blast-attack-roll",domains=[...statistic.check.domains,newDomain];return statistic.extend({check:{domains:[newDomain],modifiers:AttackTraitHelpers.createAttackModifiers({item,domains})}})}async attack(params){const{statistic,actionCost}=this;if(!(statistic&&this.item))throw ErrorPF2e("Unable to blast");if(!this.actor.rollOptions.all["self:effect:kinetic-aura"])throw ErrorPF2e("No kinetic gate");const{element,damageType}=params;if(!element)throw ErrorPF2e("No element provided");if(!objectHasKey(effectTraits,element))throw ErrorPF2e(`Unrecognized element: ${element}`);if(!damageType)throw ErrorPF2e("No damage type provided");if(!objectHasKey(CONFIG.PF2E.damageTypes,damageType))throw ErrorPF2e(`Unrecognized damage type: ${damageType}`);const blastConfig=this.#getBlastConfig(element,damageType),melee=!!(params.melee??=!0),item=this.#createModifiedItem({config:blastConfig,damageType,melee});if(!item)return null;const thisToken=this.actor.getActiveTokens(!0,!1).shift()??null,targetToken=game.user.targets.first()??null;if(!params.melee&&thisToken&&targetToken&&thisToken.distanceTo(targetToken)>blastConfig.range.max)return ui.notifications.warn("PF2E.Action.Strike.OutOfRange",{localize:!0}),null;const blastStatistic=this.#createAttackStatistic(statistic,item),label=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{title:item.name,glyph:actionCost.toString(),subtitle:game.i18n.format("PF2E.ActionsCheck.x-attack-roll",{type:statistic.label})}),meleeOrRanged=params.melee?"melee":"ranged",mapIncreases=Math.clamp(params.mapIncreases??0,0,2)||0,actionSlug="elemental-blast";return blastStatistic.roll({identifier:`${blastConfig.element}.${params.damageType}.${meleeOrRanged}.${actionCost}`,action:actionSlug,attackNumber:mapIncreases+1,target:targetToken?.actor??null,token:thisToken?.document??null,item,label,traits:item.system.traits.value,melee,damaging:!0,dc:{slug:"ac"},extraRollOptions:[`action:${actionSlug}`,`action:cost:${this.actionCost}`,`self:action:cost:${this.actionCost}`,`self:action:${meleeOrRanged}`,meleeOrRanged,`item:${meleeOrRanged}`],...eventToRollParams(params.event,{type:"check"})})}async damage(params){if(!this.statistic)return null;const melee=!!(params.melee??=!0),blastConfig=this.#getBlastConfig(params.element,params.damageType);if(!blastConfig)return null;const item=this.#createModifiedItem({config:blastConfig,damageType:params.damageType,melee});if(!item)return null;const outcome=params.outcome??"success",meleeOrRanged=melee?"melee":"ranged",actionCost=Math.clamp(Number(params.actionCost??this.actionCost),1,2)||1,actionSlug="elemental-blast",domains=["damage","attack-damage","impulse-damage",`${actionSlug}-damage`];melee&&domains.push("melee-damage");const targetToken=game.user.targets.first()?.document??null,damageCategory=DamageCategorization.fromDamageType(params.damageType);item.flags.pf2e.attackItemBonus=blastConfig.statistic.check.modifiers.find(m=>m.enabled&&["item","potency"].includes(m.type))?.value??0;const context=await new DamageContext({viewOnly:params.getFormula??!1,origin:{actor:this.actor,statistic:this.statistic,item},target:{token:targetToken},domains,outcome,checkContext:params.checkContext,options:new Set([`action:${actionSlug}`,`action:cost:${actionCost}`,`self:action:slug:${actionSlug}`,`self:action:cost:${actionCost}`,`self:action:${meleeOrRanged}`,meleeOrRanged,`item:${meleeOrRanged}`,`item:damage:type:${params.damageType}`,damageCategory?`item:damage:category:${damageCategory}`:null,...item.traits].filter(e$1))}).resolve();if(!context.origin)return null;const processedDamage=processBaseDamage("elemental-blast-damage",{category:null,damageType:params.damageType,dice:1,die:`d${blastConfig.dieFaces}`,modifier:0,persistent:null},{actor:context.origin.actor,item,domains,options:context.options}),baseDamage={category:null,damageType:processedDamage.damageType,terms:[{modifier:0,dice:{number:processedDamage.dice,faces:Number(processedDamage.die?.replace(/^d/,""))}}]},damageSynthetics=processDamageCategoryStacking([baseDamage],{modifiers:extractModifiers(context.origin.actor.synthetics,domains,{test:context.options,resolvables:{blast:item}}),dice:extractDamageDice(context.origin.actor.synthetics.damageDice,{selectors:domains,test:context.options,resolvables:{blast:item,target:context.target?.actor??null}}),test:context.options}),extraModifiers=[...damageSynthetics.modifiers,this.#strengthModToDamage(item,domains)].filter(e$1);if(item.system.traits.value.includes("forceful")){const diceNumber=processedDamage.dice;extraModifiers.push(new Modifier({slug:"forceful-second",label:"PF2E.Item.Weapon.Forceful.Second",modifier:diceNumber,type:"circumstance",ignored:!0}),new Modifier({slug:"forceful-third",label:"PF2E.Item.Weapon.Forceful.Third",modifier:2*diceNumber,type:"circumstance",ignored:!0}))}const modifiers=new StatisticModifier("",extraModifiers).modifiers,formulaData={dice:damageSynthetics.dice,modifiers,base:[baseDamage]},damageContext={type:"damage-roll",sourceType:"attack",self:context.origin,target:context.target,outcome,options:context.options,domains,traits:item.system.traits.value,...eventToRollParams(params.event,{type:"damage"})};if(!params.getFormula&&!damageContext.skipDialog&&!await new DamageModifierDialog({formulaData,context:damageContext}).resolve())return null;const damageData=createDamageFormula(formulaData,outcome==="success"?DEGREE_OF_SUCCESS.SUCCESS:DEGREE_OF_SUCCESS.CRITICAL_SUCCESS),roll=new DamageRoll(damageData.formula);if(params.getFormula)return roll.formula;const damageTemplate={name:`${game.i18n.localize("PF2E.DamageRoll")}: ${item.name}`,materials:[],modifiers,damage:{roll,breakdown:damageData.breakdown}};return DamagePF2e.roll(damageTemplate,damageContext)}#strengthModToDamage(item,domains){if(!item.range)return null;const strengthModValue=this.actor.abilities.str.mod,{traits}=item,modifierValue=traits.has("thrown")?strengthModValue:traits.has("propulsive")?strengthModValue<0?strengthModValue:Math.floor(strengthModValue/2):null;return typeof modifierValue=="number"?new Modifier({slug:"str",label:CONFIG.PF2E.abilities.str,ability:"str",modifier:modifierValue,type:"ability",adjustments:extractModifierAdjustments(this.actor.synthetics.modifierAdjustments,domains,"str")}):null}async setDamageType({element,damageType}){if(!this.configs.some(c=>c.element===element&&c.damageTypes.some(dt=>dt.value===damageType)))throw ErrorPF2e(`Damage type "${damageType}" not available for ${element}`);await this.item?.update({[`flags.pf2e.damageSelections.${element}`]:damageType})}}const appv1$g=foundry.appv1;class SelectItemDialog extends appv1$g.api.Application{static{__name(this,"SelectItemDialog")}static{__name2(this,"SelectItemDialog")}#item=null;#resolve;#action;constructor(action2,resolve){super(),this.#action=action2,this.#resolve=resolve}static get defaultOptions(){return{...super.defaultOptions,width:270}}get template(){return this.#action==="craft"?"systems/pf2e/templates/system/actions/craft-target-item.hbs":"systems/pf2e/templates/system/actions/repair/select-item-dialog.hbs"}get title(){const key=sluggify(this.#action,{camel:"bactrian"});return game.i18n.localize(`PF2E.Actions.${key}.SelectItemDialog.Title`)}async getData(options={}){return options.classes=[`select-${this.#action}-item-dialog`],{...await super.getData(options),item:this.#item}}activateListeners($html){super.activateListeners($html);const html2=$html[0];html2.addEventListener("drop",async event2=>{const json2=event2.dataTransfer?.getData("text/plain");if(!json2?.startsWith("{")||!json2.endsWith("}"))return;const data=JSON.parse(json2),uuid=data.uuid??data.pf2e?.itemUuid,item=uuid?await fromUuid(uuid):null;if(this.#action==="repair"&&item&&!(item?.isEmbedded&&item.isOwner))ui.notifications.error("DOCUMENT.UsePermissionWarn",{localize:!0});else if(item instanceof PhysicalItemPF2e)this.#item=item,this.render();else{const key=sluggify(this.#action,{camel:"bactrian"});ui.notifications.error(game.i18n.localize(`PF2E.Actions.${key}.Error.ItemReferenceMismatch`))}}),htmlQuery(html2,`[data-event-handler=${this.#action}]`)?.addEventListener("click",()=>{this.close()}),htmlQuery(html2,"[data-event-handler=cancel]")?.addEventListener("click",()=>{this.#item=null,this.close()})}close(options){return this.#resolve(this.#item),super.close(options)}static async getItem(action2){return new Promise(resolve=>{new this(action2,resolve).render(!0)})}}async function repair(options){const item=options.item??await(options.uuid?fromUuid(options.uuid):SelectItemDialog.getItem("repair"));if(item instanceof ItemPF2e){if(!(item instanceof PhysicalItemPF2e)){ui.notifications.warn(game.i18n.format("PF2E.Actions.Repair.Warning.NotPhysicalItem",{item:item?.name??""}));return}}else{console.warn("PF2e System | No item selected to repair: aborting");return}const dc=options.difficultyClass??(()=>{if(item){const pwol=game.pf2e.settings.variants.pwol.enabled;return{label:game.i18n.format("PF2E.Actions.Repair.Labels.ItemLevelRepairDC",{level:item.level}),value:calculateDC(item.level,{pwol}),visibility:"all"}}})(),targetItemOptions=Array.from(item?.traits??[]).map(trait=>`target:trait:${trait}`),slug=options?.skill??"crafting",rollOptions=["action:repair",...targetItemOptions],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.Repair.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),content:__name2(async title=>{if(item){const content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/system/actions/repair/item-heading-partial.hbs",{item});return title+content}},"content"),traits:["exploration","manipulate"],event:options.event,difficultyClass:dc,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Repair","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Repair","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Repair","criticalFailure")],"extraNotes"),createMessage:!1,callback:__name2(async result=>{const{actor}=result;if(item&&result.message instanceof ChatMessagePF2e&&actor.isOfType("creature")){const messageSource=result.message.toObject(),flavor=await(async()=>{const proficiencyRank=actor.skills.crafting.rank??0;if(result.outcome==="criticalSuccess"){const label="PF2E.Actions.Repair.Labels.RestoreItemHitPoints",restored=String(10+proficiencyRank*10);return renderRepairResult(item,"restore",label,restored)}else if(result.outcome==="success"){const label="PF2E.Actions.Repair.Labels.RestoreItemHitPoints",restored=String(5+proficiencyRank*5);return renderRepairResult(item,"restore",label,restored)}else if(result.outcome==="criticalFailure")return renderRepairResult(item,"roll-damage","PF2E.Actions.Repair.Labels.RollItemDamage","2d6");return""})();flavor&&(messageSource.flavor+=flavor),await ChatMessage.create(messageSource)}},"callback")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(repair,"repair"),__name2(repair,"repair");async function onRepairChatCardEvent(event2,message,card){const itemUuid=card.dataset.itemUuid,item=await fromUuid(itemUuid??""),button=event2.currentTarget;if(!(item instanceof PhysicalItemPF2e)||!(button instanceof HTMLElement))return;const repair2=button.dataset.repair,speaker=message&&ChatMessagePF2e.getSpeaker({actor:message.actor,alias:message.alias,token:message.token});if(repair2==="restore"){const value=Number(button.dataset.repairValue)||0,beforeRepair=item.system.hp.value,afterRepair=Math.min(item.system.hp.max,beforeRepair+value);await item.update({"system.hp.value":afterRepair});const content=game.i18n.format("PF2E.Actions.Repair.Chat.ItemRepaired",{itemName:item.name,repairedDamage:afterRepair-beforeRepair,afterRepairHitPoints:afterRepair,maximumHitPoints:item.system.hp.max});await ChatMessagePF2e.create({content,speaker})}else if(repair2==="roll-damage"){const roll=await Roll.create("2d6").evaluate(),flavor=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/system/actions/repair/roll-damage-chat-message.hbs",{damage:{dealt:Math.max(0,roll.total-item.system.hardness),rolled:roll.total},item});await roll.toMessage({flags:{pf2e:{suppressDamageButtons:!0}},flavor,speaker})}else if(repair2==="damage"){const hardness=Math.max(0,item.system.hardness),damage=(message?.rolls.at(0)?.total??0)-hardness;if(damage>0){const beforeDamage=item.system.hp.value,afterDamage=Math.max(0,item.system.hp.value-damage);await item.update({"system.hp.value":afterDamage});const content=game.i18n.format("PF2E.Actions.Repair.Chat.ItemDamaged",{itemName:item.name,damageDealt:beforeDamage-afterDamage,afterDamageHitPoints:afterDamage,maximumHitPoints:item.system.hp.max});await ChatMessage.create({content,speaker})}else{const content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/system/actions/repair/roll-damage-chat-message.hbs",{damage:{dealt:0,rolled:message?.rolls.at(0)?.total??0},item});await ChatMessage.create({content,speaker})}}}__name(onRepairChatCardEvent,"onRepairChatCardEvent"),__name2(onRepairChatCardEvent,"onRepairChatCardEvent");async function renderRepairResult(item,result,buttonLabel,value){const templatePath="systems/pf2e/templates/system/actions/repair/repair-result-partial.hbs",label=game.i18n.format(buttonLabel,{value});return foundry.applications.handlebars.renderTemplate(templatePath,{item,label,result,value})}__name(renderRepairResult,"renderRepairResult"),__name2(renderRepairResult,"renderRepairResult");class ChatCards{static{__name(this,"ChatCards")}static{__name2(this,"ChatCards")}static#lastClick=0;static listen(message,html2){const selector=["a[data-action], button[data-action], .collapsed[data-action=expand-description]"].join(",");for(const button of htmlQueryAll(html2,selector))button.addEventListener("click",async event2=>this.#onClickButton({message,event:event2,html:html2,button}))}static async#onClickButton({message,event:event2,html:html2,button}){const currentTime=Date.now();if(currentTime-this.#lastClick<500)return;this.#lastClick=currentTime;const action2=button.dataset.action??"",item=message.item,actor=item?.actor??message.actor;if(!actor||!actor.isOwner&&!["spell-save","expand-description","roll-area-save"].includes(action2))return;const attack=message._attack;if(attack?.type==="strike"&&action2?.startsWith("strike-")){const context=message.rolls.some(r2=>r2 instanceof CheckRoll)?message.flags.pf2e.context??null:null,mapIncreases=context&&"mapIncreases"in context&&tupleHasValue([0,1,2],context.mapIncreases)?context.mapIncreases:null,altUsage=context&&"altUsage"in context?context.altUsage:null,target=message.target?.token?.object??null,rollArgs={event:event2,altUsage,mapIncreases,checkContext:context,target};switch(sluggify(action2??"")){case"strike-attack":attack.variants[0].roll(rollArgs);return;case"strike-attack2":attack.variants[1].roll(rollArgs);return;case"strike-attack3":attack.variants[2].roll(rollArgs);return;case"strike-damage":{const method=button.dataset.outcome==="success"?"damage":"critical";attack[method]?.(rollArgs);return}}}if(action2==="expand-description"){const element=htmlClosest(button,".description, .collapsed");if(element&&"autoCollapse"in element.dataset){element.classList.remove("collapsed");const shadow=element.nextElementSibling;shadow?.classList.contains("shadow")&&shadow.remove(),delete button.dataset.tooltip,delete button.dataset.action,game.tooltip.deactivate(),element.scrollIntoView({behavior:"smooth",block:"center"})}else element&&item&&(element.innerHTML=(await item.getDescription()).value,element.scrollIntoView({behavior:"smooth",block:"center"}));return}if(item){const spell=item.isOfType("spell")?item:item.isOfType("consumable")?item.embeddedSpell:null;switch(action2){case"spell-attack":await spell?.rollAttack(event2);return;case"spell-attack-2":await spell?.rollAttack(event2,2);return;case"spell-attack-3":await spell?.rollAttack(event2,3);return;case"spell-damage":spell?.rollDamage(event2);return;case"spell-save":{const saveType=button.dataset.save,dcValue=Number(button.dataset.dc??"NaN"),dc=Number.isInteger(dcValue)?{value:Number(dcValue)}:null;if(!tupleHasValue(SAVE_TYPES,saveType))throw ErrorPF2e(`"${saveType}" is not a recognized save type`);return this.#rollActorSaves({event:event2,saveType,origin:actor,item,dc})}case"affliction-save":item?.isOfType("affliction")&&item.rollRecovery();return;case"spell-counteract":spell?.rollCounteract(event2);return;case"spell-template":spell?.placeTemplate(message);return;case"spell-template-clear":{const templateIds=canvas.scene?.templates.filter(t2=>t2.message===message).map(t2=>t2.id)??[];button.disabled=!0,await canvas.scene?.deleteEmbeddedDocuments("MeasuredTemplate",templateIds),button.disabled=!1;return}case"spell-variant":{const castRank=Number(htmlQuery(html2,"div.chat-card")?.dataset.castRank)||1,overlayIds=button.dataset.overlayIds?.split(",").map(id=>id.trim());if(overlayIds){const variantSpell=spell?.loadVariant({overlayIds,castRank});if(variantSpell){const data={castRank},variantMessage=await variantSpell.toMessage(null,{data,create:!1});if(variantMessage){const whisper=message._source.whisper,changes=variantMessage.clone({whisper}).toObject();await message.update(changes)}}}else if(spell){const restoredMessage=await spell.loadBaseVariant().toMessage(null,{create:!1});if(restoredMessage){const whisper=message._source.whisper,changes=restoredMessage.clone({whisper}).toObject();await message.update(changes)}}return}case"consume":{if(item.isOfType("consumable"))item.consume();else if(item.isOfType("melee")){const consumable=actor.items.get(button.dataset.item??"");if(consumable?.isOfType("consumable")){const oldQuant=consumable.quantity,consumableString=game.i18n.localize("TYPES.Item.consumable"),toReplace=`${consumable.name} - ${consumableString} (${oldQuant})`;await consumable.consume();const currentQuant=oldQuant===1?0:consumable.quantity;let flavor=message.flavor.replace(toReplace,`${consumable.name} - ${consumableString} (${currentQuant})`);if(currentQuant===0){const buttonStr=`>${game.i18n.localize("PF2E.Item.Consumable.Uses.Use")}</button>`;flavor=flavor?.replace(buttonStr,` disabled${buttonStr}`)}await message.update({flavor}),message.render(!0)}}return}case"elemental-blast-damage":{if(!actor.isOfType("character"))return;const roll=message.rolls.find(r2=>r2 instanceof CheckRoll&&r2.options.action==="elemental-blast"),checkContext=roll?message.flags.pf2e.context??null:null,outcome=button.dataset.outcome==="success"?"success":"criticalSuccess",[element,damageType,meleeOrRanged,actionCost]=roll?.options.identifier?.split(".")??[];objectHasKey(effectTraits,element)&&objectHasKey(CONFIG.PF2E.damageTypes,damageType)&&await new ElementalBlast(actor).damage({element,damageType,melee:meleeOrRanged==="melee",actionCost:Number(actionCost)||1,checkContext,outcome,event:event2});return}case"roll-area-save":{const dc=attack&&"statistic"in attack?attack.statistic.dc:null;return this.#rollActorSaves({event:event2,saveType:"reflex",origin:actor,item,dc})}case"roll-area-damage":attack?.damage?.({event:event2});return;case"place-area-template":{const context=message.flags.pf2e.context,area=tupleHasValue(["area-fire","auto-fire"],context?.type)?context.area:null;area&&placeItemTemplate(area,{item,message});return}}}else if(action2&&actor.isOfType("character","npc")){const buttonGroup=htmlClosest(button,".chat-card, .message-buttons"),physicalItem=await(async()=>{const itemUuid=buttonGroup?.dataset.itemUuid??"",maybeItem=await fromUuid(itemUuid);return maybeItem instanceof PhysicalItemPF2e?maybeItem:null})(),quantity=Number(buttonGroup?.dataset.craftingQuantity)||1;if(action2==="repair-item"&&buttonGroup)await onRepairChatCardEvent(event2,message,buttonGroup);else if(physicalItem&&action2==="pay-crafting-costs"){const quantity2=Number(buttonGroup?.dataset.craftingQuantity)||1,craftingCost=Coins.fromPrice(physicalItem.price,quantity2),coinsToRemove=button.classList.contains("full")?craftingCost:craftingCost.scale(.5);if(!await actor.inventory.removeCoins(coinsToRemove)){ui.notifications.warn(game.i18n.localize("PF2E.Actions.Craft.Warning.InsufficientCoins"));return}if(isSpellConsumableUUID(physicalItem.uuid)&&physicalItem.isOfType("consumable")){craftSpellConsumable(physicalItem,quantity2,actor),ChatMessagePF2e.create({author:game.user.id,content:game.i18n.format("PF2E.Actions.Craft.Information.PayAndReceive",{actorName:actor.name,cost:coinsToRemove.toString(),quantity:quantity2,itemName:physicalItem.name}),speaker:{alias:actor.name}});return}const itemObject=physicalItem.toObject();if(itemObject.system.quantity=quantity2,!await actor.addToInventory(itemObject,void 0)){ui.notifications.warn(game.i18n.localize("PF2E.Actions.Craft.Warning.CantAddItem"));return}ChatMessagePF2e.create({author:game.user.id,content:game.i18n.format("PF2E.Actions.Craft.Information.LoseMaterials",{actorName:actor.name,cost:coinsToRemove.toString(),quantity:quantity2,itemName:physicalItem.name}),speaker:{alias:actor.name}})}else if(physicalItem&&action2==="lose-materials"){const coinsToRemove=Coins.fromPrice(physicalItem.price,quantity).scale(.5).scale(.1);await actor.inventory.removeCoins(coinsToRemove)?ChatMessagePF2e.create({author:game.user.id,content:game.i18n.format("PF2E.Actions.Craft.Information.PayAndReceive",{actorName:actor.name,cost:coinsToRemove.toString()}),speaker:{alias:actor.name}}):ui.notifications.warn(game.i18n.localize("PF2E.Actions.Craft.Warning.InsufficientCoins"))}else if(action2==="receieve-crafting-item"&&physicalItem)return isSpellConsumableUUID(physicalItem.uuid)&&physicalItem.isOfType("consumable")?craftSpellConsumable(physicalItem,quantity,actor):craftItem(physicalItem,quantity,actor)}else if(action2==="army-strike-damage"&&actor.isOfType("army")){const roll=message.rolls.find(r2=>r2 instanceof CheckRoll&&r2.options.action==="army-strike"),checkContext=roll?message.flags.pf2e.context??null:null,action22=button.dataset.outcome==="success"?"damage":"critical";actor.strikes[roll?.options.identifier??""]?.[action22]({checkContext,event:event2})}}static async#rollActorSaves({event:event2,saveType,origin,item,dc}){const tokens=game.user.getActiveTokens();if(tokens.length===0){ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected",{localize:!0});return}for(const token of tokens){const save=token.actor?.saves?.[saveType];if(!save)return;save.check.roll({...eventToRollParams(event2,{type:"check"}),dc,item,origin})}}}const DamageTaken={listen:__name2(async(message,html2)=>{const damageTakenCard=htmlQuery(html2,".damage-taken");if(!damageTakenCard)return;const settingEnabled=game.pf2e.settings.tokens.nameVisibility;if(!game.user.isGM&&settingEnabled&&message.token&&!message.token.playersCanSeeName){const nameElem=htmlQuery(damageTakenCard,".target-name");nameElem&&(nameElem.innerText=game.i18n.localize("PF2E.Actor.ApplyDamage.TheTarget"))}const iwrInfo=htmlQuery(damageTakenCard,".iwr");if(!iwrInfo)return;const iwrApplications=(()=>{try{const parsed=JSON.parse(iwrInfo?.dataset.applications??"null");return Array.isArray(parsed)&&parsed.every(a=>a instanceof Object&&"category"in a&&typeof a.category=="string"&&"type"in a&&typeof a.type=="string"&&"adjustment"in a&&typeof a.adjustment=="number")?parsed:null}catch{return null}})();iwrApplications&&$(iwrInfo).tooltipster({theme:"crb-hover",maxWidth:400,content:await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/damage/iwr-breakdown.hbs",{applications:iwrApplications}),contentAsHTML:!0})},"listen")};class ChatMessagePF2e extends ChatMessage{static{__name(this,"ChatMessagePF2e")}static{__name2(this,"ChatMessagePF2e")}_initializeSource(data,options){const source2=super._initializeSource(data,options);return source2.flags=foundry.utils.mergeObject(source2.flags,{core:{canPopout:source2.flags.core?.canPopout??!0},pf2e:{}}),source2}get isDamageRoll(){const firstRoll=this.rolls.at(0);if(!firstRoll||firstRoll.terms.some(t2=>t2 instanceof foundry.dice.terms.FateDie||t2 instanceof foundry.dice.terms.Coin))return!1;if(this.flags.pf2e.context?.type==="damage-roll")return!0;const isCheck=firstRoll instanceof CheckRoll||firstRoll.dice[0]?.faces===20,fromRollTable=!!this.flags.core.RollTable;return!(isCheck||fromRollTable)}get actor(){return this.speakerActor}get target(){const context=this.flags.pf2e.context;if(!context)return null;const targetUUID="target"in context?context.target?.token:null;if(!targetUUID)return null;const match=/^Scene\.(\w+)\.Token\.(\w+)$/.exec(targetUUID??"")??[],token=game.scenes.get(match[1]??"")?.tokens.get(match[2]??""),actor=token?.actor;return actor?{actor,token}:null}get journalEntry(){const uuid=this.flags.pf2e.journalEntry;if(!uuid)return null;const entryId=/^JournalEntry.([A-Za-z0-9]{16})$/.exec(uuid)?.at(1);return game.journal.get(entryId??"")??null}get isCheckRoll(){return this.rolls[0]instanceof CheckRoll}get isReroll(){const context=this.flags.pf2e.context;return!!context&&"isReroll"in context&&!!context.isReroll}get isRerollable(){const roll=this.rolls[0];return!!(this.speakerActor?.isOwner&&(this.isAuthor||this.isOwner)&&roll instanceof CheckRoll&&roll.isRerollable)}get item(){const actor=this.speakerActor;if(this.flags.pf2e.context?.type==="self-effect")return actor?.items.get(this.flags.pf2e.context.item)??null;const strike=this._strike;if(strike?.item)return strike.item;const embeddedSpell=this.flags.pf2e.casting?.embeddedSpell,origin=this.flags.pf2e.origin,item=actor&&embeddedSpell?new ItemProxyPF2e(embeddedSpell,{parent:actor}):origin?.uuid&&!origin.uuid.startsWith("Compendium.")?fromUuidSync(origin.uuid):null;if(!(item instanceof ItemPF2e))return null;if(item?.isOfType("spell")){const entryId=this.flags.pf2e?.casting?.id??null,overlayIds=origin?.variant?.overlays,castRank=origin?.castRank??item.rank;return item.loadVariant({overlayIds,castRank,entryId})??item}return item}get _strike(){const attack=this._attack;return attack?.type==="strike"?attack:null}get _attack(){const actor=this.speakerActor;if(!actor)return null;const origin=this.flags.pf2e.origin,parsedUUID=foundry.utils.parseUuid(origin?.uuid??"")??{id:""};if(actor?.isOfType("character")&&["xxxxxxFISTxxxxxx","xxPF2ExUNARMEDxx"].includes(parsedUUID.id))return actor?.system.actions?.find(s=>s.item.id===parsedUUID.id)??null;const context=this.flags.pf2e.context,identifier=this.rolls.find(r2=>r2 instanceof CheckRoll)?.options.identifier??(context&&"identifier"in context?context.identifier:null)??htmlQuery(document.body,`li.message[data-message-id="${this.id}"] [data-identifier]`)?.dataset.identifier,[itemId,slug,actionOrMeleeRanged]=identifier?.split(".")??[null,null,null];if(!actionOrMeleeRanged)return null;const strikeData=actor.system.actions?.find(s=>s.slug===slug&&s.item.id===itemId);return[strikeData,...strikeData?.altUsages??[]].find(attack=>attack?attack.type!=="strike"?attack.type===actionOrMeleeRanged:(attack.item.isMelee?"melee":"ranged")===actionOrMeleeRanged:!1)??null}async showDetails(){this.flags.pf2e.context&&new RollInspector({message:this}).render({force:!0})}get token(){if(!game.scenes)return null;const sceneId=this.speaker.scene??"",tokenId=this.speaker.token??"";return game.scenes.get(sceneId)?.tokens.get(tokenId)??null}getRollData(){const{speakerActor,item}=this;return{...speakerActor?.getRollData(),...item?.getRollData()}}async renderHTML(options){const actor=this.speakerActor;if(this.isContentVisible){const rollData=this.getRollData();this.flavor=await TextEditorPF2e.enrichHTML(this.flavor,{rollData,processVisibility:!1})}const html2=await super.renderHTML(options),header=html2?.querySelector("header.message-header");if(!(this.style===CONST.CHAT_MESSAGE_STYLES.OOC)&&actor&&header&&this.isContentVisible){const token=this.token??actor.prototypeToken,[imageUrl,scale]=(()=>{const tokenImage=token.texture.src;if(!(tokenImage&&foundry.helpers.media.ImageHelper.hasImageExtension(tokenImage))||isDefaultTokenImage(token))return[actor.img,1];const scaleCorrection=token.ring.enabled?1/(.1269848+.6666666):1;return[tokenImage,Math.max(1,token.texture.scaleX??1)*scaleCorrection]})(),image=document.createElement("img");if(image.alt=actor.name,image.src=imageUrl,image.inert=!0,image.style.transform=`scale(${scale})`,scale>1.2){const ringPercent=100-Math.floor((scale-.7)/scale*100),limitPercent=100-Math.floor((scale-1.15)/scale*100);image.style.maskImage=`radial-gradient(circle at center, black ${ringPercent}%, rgba(0, 0, 0, 0.2) ${limitPercent}%)`}const usedToken=imageUrl===token.texture.src,portrait=createHTMLElement("div",{children:[image],classes:["portrait",usedToken?"token":"actor-image"]});header.prepend(portrait),header.classList.toggle("with-image",!0),this.author&&header.append(createHTMLElement("span",{classes:["user"],children:[this.author.name]}))}const collapsableElement=html2.querySelector(".description[data-auto-collapse], .card-content[data-auto-collapse]");collapsableElement&&collapsableElement.innerText.length>250&&(collapsableElement.classList.add("collapsed"),collapsableElement.dataset.action="expand-description",collapsableElement.dataset.tooltipClass="pf2e",collapsableElement.dataset.tooltip="PF2E.Action.ExpandDescription",collapsableElement.after(createHTMLElement("div",{classes:["shadow"]}))),!this.flags.pf2e.suppressDamageButtons&&this.isDamageRoll&&htmlQueryAll(html2,".damage-application").forEach((buttons,index2)=>{buttons.dataset.rollIndex=index2.toString()}),await DamageTaken.listen(this,html2),CriticalHitAndFumbleCards.appendButtons(this,html2),ChatCards.listen(this,html2),this.#highlightDoS(this,html2),(canvas.ready||!game.settings.get("core","noCanvas"))&&this.#appendSetAsInitiative(html2);const roll=this.rolls[0];if(actor?.isOwner&&roll instanceof DamageRoll&&roll.options.evaluatePersistent){const damageType=roll.instances.find(i=>i.persistent)?.type;if(damageType?this.speakerActor?.getCondition(`persistent-damage-${damageType}`):null){const section=parseHTML(await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/persistent-damage-recovery.hbs"));html2.querySelector(".message-content")?.append(section),html2.dataset.actorIsTarget="true"}}return this.flags.pf2e.appliedDamage?.isReverted||this.speakerActor?.isOwner||htmlQuery(html2,"button[data-action=revertDamage]")?.remove(),html2.addEventListener("pointerenter",event2=>this.#onHoverIn(event2)),html2.addEventListener("pointerleave",event2=>this.#onHoverOut(event2)),UserVisibilityPF2e.processMessageSender(this,html2),(!actor||this.isRoll)&&this.content&&UserVisibilityPF2e.process(html2,{document:actor??this,message:this}),html2}#highlightDoS(message,html2){const firstRoll=message.rolls[0];if(!(firstRoll instanceof CheckRoll&&message.isContentVisible&&(game.user.isGM||firstRoll.options.showBreakdown)&&!html2.querySelector(".reroll-indicator")))return;const firstDice=firstRoll.dice.at(0);if(!(firstDice instanceof foundry.dice.terms.Die&&firstDice.faces===20))return;const diceTotal=htmlQuery(html2,".dice-total"),results=firstDice.results.filter(r2=>r2.active);results.every(r2=>r2.result===20)?diceTotal?.classList.add("success"):results.every(r2=>r2.result===1)&&diceTotal?.classList.add("failure")}#appendSetAsInitiative(html2){if((this.blind||!this.isAuthor)&&!game.user.isGM||!this.rolls.some(r2=>r2 instanceof CheckRoll&&["skill-check","perception-check"].includes(r2.options.type??""))||!this.token?.actor)return;const button=createHTMLElement("button",{classes:["set-as-initiative","icon","fa-solid","fa-swords"],dataset:{action:"setAsInitiative",tooltip:!0}});button.type="button",button.ariaLabel=game.i18n.format("PF2E.Check.SetAsInitiative",{actor:this.token.name});const selector=this.isReroll?".reroll-second .dice-total":".dice-total";html2.querySelector(selector)?.appendChild(button)}#onHoverIn(nativeEvent){if(!canvas.ready)return;const token=this.token?.object;token?.isVisible&&!token.controlled&&token.emitHoverIn(nativeEvent)}#onHoverOut(nativeEvent){canvas.ready&&this.token?.object?.emitHoverOut(nativeEvent)}_onCreate(data,options,userId){super._onCreate(data,options,userId),this.isRoll&&game.pf2e.settings.critFumble.cards&&CriticalHitAndFumbleCards.handleDraw(this),options.restForTheNight&&this.speakerActor?.render()}}class ItemTransfer{static{__name(this,"ItemTransfer")}static{__name2(this,"ItemTransfer")}#templatePaths={flavor:"./systems/pf2e/templates/chat/action/flavor.hbs",content:"./systems/pf2e/templates/chat/action/content.hbs"};source;target;quantity;containerId;mode;constructor(data){this.source=data.source,this.target=data.target,this.quantity=data.quantity,this.containerId=data.containerId,this.mode=data.mode??null}async request(){const gamemaster=game.users.find(u=>u.isGM&&u.active);if(!gamemaster){const source2=this.#getSource(),target=this.#getTarget(),loot=[source2,target].find(a=>a?.isLootableBy(game.user)&&!a.isOwner);if(!loot)throw ErrorPF2e("Unexpected missing actor");ui.notifications.error(game.i18n.format("PF2E.loot.GMSupervisionError",{loot:ItemTransfer.#tokenName(loot)}));return}console.debug(`PF2e System | Requesting item transfer from GM ${gamemaster.name}`),game.socket.emit("system.pf2e",{request:"itemTransfer",data:this})}async enact(requester){if(!game.user.isGM)throw ErrorPF2e("Unauthorized item transfer");console.debug("PF2e System | Enacting item transfer");const sourceActor=this.#getSource(),sourceItem=sourceActor?.inventory.find(i=>i.id===this.source.itemId),targetActor=this.#getTarget();if(!(sourceActor?.isLootableBy(game.user)&&sourceItem&&targetActor?.isLootableBy(game.user)))throw ErrorPF2e("Failed sanity check during item transfer");if(this.mode??=sourceActor.isOfType("loot")&&sourceActor.isMerchant?"purchase":"move",this.mode==="credits")await transferCredits({item:sourceItem,targetActor,quantity:this.quantity});else{const targetItem=await sourceActor.transferItemToActor(targetActor,sourceItem,this.quantity,this.containerId,!1,this.mode==="purchase"),sourceIsLoot=sourceActor.isOfType("loot")&&sourceActor.system.lootSheetType==="Loot";if(!sourceItem&&sourceIsLoot)return;this.#sendMessage(requester,sourceActor,targetActor,targetItem)}}#getActor(tokenId,actorId){return typeof tokenId=="string"?canvas.tokens.placeables.find(t2=>t2.id===tokenId)?.actor??null:game.actors.get(actorId)??null}#getSource(){return this.#getActor(this.source.tokenId,this.source.actorId)}#getTarget(){return this.#getActor(this.target.tokenId,this.target.actorId)}static#tokenName(document2){if("items"in document2){if(document2.isOfType("party"))return game.i18n.localize("PF2E.loot.PartyStash");const canSeeName=!game.pf2e.settings.tokens.nameVisibility||!document2.token||document2.token.playersCanSeeName;return document2.token?!canSeeName&&document2.isOfType("npc")?game.i18n.localize("PF2E.loot.LootUnknownNPCMessage"):document2.token.name:document2.prototypeToken?.name??document2.name}return document2.character?canvas.tokens.placeables.find(t2=>t2.actor?.id===document2.id)?.name??document2.character?.name:document2.name}async#sendMessage(requester,sourceActor,targetActor,item){const localize=localizer("PF2E.loot");if(!item){if(this.mode!=="purchase")throw ErrorPF2e("Unexpected item-transfer failure");const message=localize("InsufficientFundsMessage"),content2=await foundry.applications.handlebars.renderTemplate(this.#templatePaths.content,{imgPath:targetActor.img,message:game.i18n.format(message,{buyer:targetActor.name})}),flavor2=await this.#messageFlavor(sourceActor,targetActor,localize("BuySubtitle"));await ChatMessagePF2e.create({author:requester.id,speaker:{alias:ItemTransfer.#tokenName(targetActor)},style:CONST.CHAT_MESSAGE_STYLES.EMOTE,flavor:flavor2,content:content2});return}const[speaker,subtitle,formatArgs]=(()=>{const isMerchant=__name2(actor=>actor.isOfType("loot")&&actor.isMerchant,"isMerchant"),isWhat=__name2(actor=>({isCharacter:actor.testUserPermission(requester,"OWNER")&&actor.isOfType("character"),isMerchant:isMerchant(actor),isNPC:actor.isOfType("npc")&&actor.isLootableBy(requester)&&!actor.testUserPermission(requester,"OWNER"),isLoot:(actor.isOfType("party")||actor.isOfType("loot"))&&actor.isLootableBy(requester)&&!actor.testUserPermission(requester,"OWNER")&&!isMerchant(actor)}),"isWhat"),source2=isWhat(sourceActor),target=isWhat(targetActor);if(source2.isCharacter&&target.isLoot)return[ItemTransfer.#tokenName(sourceActor),localize("DepositSubtitle"),[localize("DepositMessage"),{depositor:ItemTransfer.#tokenName(sourceActor),container:ItemTransfer.#tokenName(targetActor)}]];if(source2.isCharacter&&target.isMerchant)return[ItemTransfer.#tokenName(sourceActor),localize("GiveSubtitle"),[localize("GiveMessage"),{giver:ItemTransfer.#tokenName(sourceActor),recipient:ItemTransfer.#tokenName(targetActor)}]];if(source2.isCharacter&&target.isNPC)return[ItemTransfer.#tokenName(sourceActor),localize("PlantSubtitle"),[localize("PlantMessage"),{planter:ItemTransfer.#tokenName(sourceActor),corpse:ItemTransfer.#tokenName(targetActor)}]];if(source2.isLoot&&target.isCharacter)return[ItemTransfer.#tokenName(targetActor),localize("TakeSubtitle"),[localize("TakeMessage"),{taker:ItemTransfer.#tokenName(targetActor),container:ItemTransfer.#tokenName(sourceActor)}]];if(source2.isNPC&&target.isCharacter)return[ItemTransfer.#tokenName(targetActor),localize("LootSubtitle"),[localize("LootMessage"),{looter:ItemTransfer.#tokenName(targetActor),corpse:ItemTransfer.#tokenName(sourceActor)}]];if([source2,target].every(actor=>actor.isLoot||actor.isNPC))return[requester.character?.name??requester.name,localize("TransferSubtitle"),[localize("TransferMessage"),{transferrer:requester.character?.name??requester.name,fromContainer:ItemTransfer.#tokenName(sourceActor),toContainer:ItemTransfer.#tokenName(targetActor)}]];if(source2.isLoot&&target.isMerchant)return[requester.character?.name??requester.name,localize("GiveSubtitle"),[localize("GiveMessage"),{seller:requester.character?.name??requester.name,buyer:ItemTransfer.#tokenName(targetActor)}]];if(source2.isMerchant&&target.isCharacter)return[ItemTransfer.#tokenName(sourceActor),localize("SellSubtitle"),[localize("SellMessage"),{seller:ItemTransfer.#tokenName(sourceActor),buyer:ItemTransfer.#tokenName(targetActor)}]];if(source2.isMerchant&&target.isLoot)return[requester.character?.name??requester.name,localize("SellSubtitle"),[localize("SellMessage"),{seller:ItemTransfer.#tokenName(sourceActor),buyer:requester.character?.name??requester.name}]];throw ErrorPF2e("Unexpected item-transfer failure")})(),formatProperties=formatArgs[1];if(!formatProperties)throw ErrorPF2e("Unexpected item-transfer failure");formatProperties.quantity=this.quantity,formatProperties.item=await TextEditorPF2e.enrichHTML(item.link);const content=await foundry.applications.handlebars.renderTemplate(this.#templatePaths.content,{imgPath:item.img,message:game.i18n.format(...formatArgs).replace(/\b1 Ã— /,"")}),flavor=await this.#messageFlavor(sourceActor,targetActor,subtitle);await ChatMessagePF2e.create({author:requester.id,speaker:{alias:speaker},style:CONST.CHAT_MESSAGE_STYLES.EMOTE,flavor,content})}async#messageFlavor(sourceActor,targetActor,subtitle){const glyph=getActionGlyph(sourceActor.isOfType("loot")&&targetActor.isOfType("loot")?2:1),action2={title:"PF2E.Actions.Interact.Title",subtitle,glyph},traits=[{name:"manipulate",label:CONFIG.PF2E.featTraits.manipulate,description:CONFIG.PF2E.traitsDescriptions.manipulate}];return await foundry.applications.handlebars.renderTemplate(this.#templatePaths.flavor,{action:action2,traits})}}const REINFORCING_RUNE_LOC_PATHS=[null,"PF2E.Item.Shield.Rune.Reinforcing.Minor","PF2E.Item.Shield.Rune.Reinforcing.Lesser","PF2E.Item.Shield.Rune.Reinforcing.Moderate","PF2E.Item.Shield.Rune.Reinforcing.Greater","PF2E.Item.Shield.Rune.Reinforcing.Major","PF2E.Item.Shield.Rune.Reinforcing.Supreme"];function getMaterialValuationData(item){const material=item.material;if(!material.type||!material.grade)return null;const valuationData=item.isOfType("weapon")?MATERIAL_DATA.weapon:item.isOfType("armor")?MATERIAL_DATA.armor:item.isOfType("shield")?item.isBuckler?MATERIAL_DATA.shield.buckler:item.isTowerShield?MATERIAL_DATA.shield.towerShield:MATERIAL_DATA.shield.shield:null;return valuationData?valuationData[material.type]?.[material.grade]??null:null}__name(getMaterialValuationData,"getMaterialValuationData"),__name2(getMaterialValuationData,"getMaterialValuationData");const WEAPON_MATERIAL_VALUATION_DATA={"":{low:null,standard:null,high:null},abysium:{low:null,standard:{level:12,price:2e3,rarity:"rare"},high:{level:18,price:24e3,rarity:"rare"}},adamantine:{low:null,standard:{level:11,price:1400,rarity:"uncommon"},high:{level:17,price:13500,rarity:"uncommon"}},"cold-iron":{low:{level:2,price:40,rarity:"common"},standard:{level:10,price:880,rarity:"common"},high:{level:16,price:9e3,rarity:"common"}},dawnsilver:{low:null,standard:{level:11,price:1400,rarity:"uncommon"},high:{level:17,price:13500,rarity:"uncommon"}},djezet:{low:null,standard:{level:12,price:1800,rarity:"rare"},high:{level:18,price:22e3,rarity:"rare"}},duskwood:{low:null,standard:{level:11,price:1400,rarity:"uncommon"},high:{level:17,price:13500,rarity:"uncommon"}},inubrix:{low:null,standard:{level:11,price:1400,rarity:"rare"},high:{level:17,price:13500,rarity:"rare"}},"keep-stone":{low:null,standard:null,high:{level:18,price:22500,rarity:"rare"}},noqual:{low:null,standard:{level:12,price:1600,rarity:"rare"},high:{level:18,price:24e3,rarity:"rare"}},peachwood:{low:null,standard:{level:12,price:2e3,rarity:"uncommon"},high:{level:18,price:19e3,rarity:"uncommon"}},orichalcum:{low:null,standard:null,high:{level:18,price:22500,rarity:"rare"}},siccatite:{low:null,standard:{level:11,price:1400,rarity:"rare"},high:{level:17,price:15e3,rarity:"rare"}},silver:{low:{level:2,price:40,rarity:"common"},standard:{level:10,price:880,rarity:"common"},high:{level:16,price:9e3,rarity:"common"}},"sisterstone-dusk":{low:{level:3,price:70,rarity:"rare"},standard:{level:11,price:1200,rarity:"rare"},high:{level:19,price:32e3,rarity:"rare"}},"sisterstone-scarlet":{low:{level:3,price:70,rarity:"rare"},standard:{level:11,price:1200,rarity:"rare"},high:{level:19,price:32e3,rarity:"rare"}},sloughstone:{low:null,standard:{level:8,price:3500,rarity:"rare"},high:{level:16,price:6e3,rarity:"rare"}},"sovereign-steel":{low:null,standard:{level:12,price:1600,rarity:"rare"},high:{level:19,price:32e3,rarity:"rare"}},warpglass:{low:null,standard:null,high:{level:17,price:14e3,rarity:"rare"}}},ARMOR_MATERIAL_VALUATION_DATA={"":{low:null,standard:null,high:null},abysium:{low:null,standard:{level:12,price:2e3,rarity:"rare"},high:{level:19,price:4e4,rarity:"rare"}},adamantine:{low:null,standard:{level:12,price:1600,rarity:"uncommon"},high:{level:19,price:32e3,rarity:"uncommon"}},"cold-iron":{low:{level:5,price:140,rarity:"common"},standard:{level:11,price:1200,rarity:"common"},high:{level:18,price:2e4,rarity:"common"}},dawnsilver:{low:null,standard:{level:12,price:1600,rarity:"uncommon"},high:{level:19,price:32e3,rarity:"uncommon"}},djezet:{low:null,standard:{level:12,price:1800,rarity:"rare"},high:{level:19,price:35e3,rarity:"rare"}},dragonhide:{low:null,standard:{level:12,price:1600,rarity:"uncommon"},high:{level:19,price:32e3,rarity:"uncommon"}},dreamweb:{low:null,standard:{level:5,price:150,rarity:"rare"},high:{level:14,price:3e3,rarity:"rare"}},duskwood:{low:null,standard:{level:12,price:1600,rarity:"uncommon"},high:{level:19,price:32e3,rarity:"uncommon"}},"grisantian-pelt":{low:null,standard:{level:12,price:1800,rarity:"rare"},high:{level:19,price:33e3,rarity:"rare"}},inubrix:{low:null,standard:{level:11,price:1200,rarity:"rare"},high:{level:18,price:18e3,rarity:"rare"}},"keep-stone":{low:null,standard:null,high:{level:20,price:56e3,rarity:"rare"}},noqual:{low:null,standard:{level:12,price:1600,rarity:"rare"},high:{level:19,price:32e3,rarity:"rare"}},peachwood:{low:null,standard:null,high:null},orichalcum:{low:null,standard:null,high:{level:20,price:55e3,rarity:"rare"}},siccatite:{low:null,standard:{level:12,price:1600,rarity:"rare"},high:{level:19,price:32e3,rarity:"rare"}},silver:{low:{level:5,price:140,rarity:"common"},standard:{level:11,price:1200,rarity:"common"},high:{level:18,price:2e4,rarity:"common"}},"sisterstone-dusk":{low:{level:5,price:140,rarity:"rare"},standard:{level:10,price:1e3,rarity:"rare"},high:{level:18,price:19500,rarity:"rare"}},"sisterstone-scarlet":{low:{level:5,price:140,rarity:"rare"},standard:{level:10,price:1e3,rarity:"rare"},high:{level:18,price:19500,rarity:"rare"}},"sovereign-steel":{low:null,standard:{level:13,price:2400,rarity:"rare"},high:{level:20,price:5e4,rarity:"rare"}},warpglass:{low:null,standard:null,high:null}},BUCKLER_MATERIAL_VALUATION_DATA={"":{low:null,standard:null,high:null},abysium:{low:null,standard:{level:8,price:400,hardness:4,maxHP:16,rarity:"rare"},high:{level:16,price:8e3,hardness:7,maxHP:28,rarity:"rare"}},adamantine:{low:null,standard:{level:8,price:400,rarity:"uncommon",hardness:8,maxHP:32},high:{level:16,price:8e3,hardness:11,maxHP:44,rarity:"uncommon"}},"cold-iron":{low:{level:2,price:30,hardness:3,maxHP:12,rarity:"common"},standard:{level:7,price:300,hardness:5,maxHP:20,rarity:"common"},high:{level:15,price:5e3,hardness:8,maxHP:32,rarity:"common"}},dawnsilver:{low:null,standard:{level:8,price:400,hardness:3,maxHP:12,rarity:"uncommon"},high:{level:16,price:8e3,hardness:6,maxHP:24,rarity:"uncommon"}},djezet:{low:null,standard:{level:9,price:600,hardness:3,maxHP:12,rarity:"rare"},high:{level:16,price:8e3,hardness:6,maxHP:24,rarity:"rare"}},duskwood:{low:null,standard:{level:8,price:400,hardness:3,maxHP:12,rarity:"uncommon"},high:{level:16,price:8e3,hardness:5,maxHP:20,rarity:"uncommon"}},inubrix:{low:null,standard:{level:7,price:320,hardness:2,maxHP:8,rarity:"rare"},high:{level:15,price:5e3,hardness:5,maxHP:20,rarity:"rare"}},noqual:{low:null,standard:null,high:{level:17,price:14e3,hardness:7,maxHP:28,rarity:"rare"}},orichalcum:{low:null,standard:null,high:{level:17,price:12e3,hardness:14,maxHP:56,rarity:"rare"}},siccatite:{low:null,standard:{level:8,price:400,hardness:4,maxHP:16,rarity:"rare"},high:{level:16,price:8e3,hardness:7,maxHP:28,rarity:"rare"}},silver:{low:{level:2,price:30,hardness:1,maxHP:4,rarity:"common"},standard:{level:7,price:300,hardness:3,maxHP:12,rarity:"common"},high:{level:15,price:5e3,hardness:6,maxHP:24,rarity:"common"}}},SHIELD_MATERIAL_VALUATION_DATA={"":{low:null,standard:null,high:null},abysium:{low:null,standard:{level:8,price:440,hardness:6,maxHP:24,rarity:"rare"},high:{level:16,price:8800,hardness:10,maxHP:40,rarity:"rare"}},adamantine:{low:null,standard:{level:8,price:440,rarity:"uncommon",hardness:10,maxHP:40},high:{level:16,price:8800,hardness:13,maxHP:52,rarity:"uncommon"}},"cold-iron":{low:{level:2,price:34,hardness:5,maxHP:20,rarity:"common"},standard:{level:7,price:340,hardness:7,maxHP:28,rarity:"common"},high:{level:15,price:5500,hardness:10,maxHP:40,rarity:"common"}},dawnsilver:{low:null,standard:{level:8,price:440,hardness:5,maxHP:20,rarity:"uncommon"},high:{level:16,price:8800,hardness:8,maxHP:32,rarity:"uncommon"}},djezet:{low:null,standard:{level:9,price:660,hardness:5,maxHP:20,rarity:"rare"},high:{level:16,price:8800,hardness:8,maxHP:32,rarity:"rare"}},duskwood:{low:null,standard:{level:8,price:440,hardness:5,maxHP:20,rarity:"uncommon"},high:{level:16,price:8800,hardness:8,maxHP:32,rarity:"uncommon"}},inubrix:{low:null,standard:{level:7,price:352,hardness:4,maxHP:16,rarity:"rare"},high:{level:15,price:5500,hardness:7,maxHP:28,rarity:"rare"}},"keep-stone":{low:null,standard:null,high:{level:17,price:13200,hardness:11,maxHP:46,rarity:"rare"}},noqual:{low:null,standard:null,high:{level:17,price:15400,hardness:10,maxHP:40,rarity:"rare"}},orichalcum:{low:null,standard:null,high:{level:17,price:13200,hardness:16,maxHP:64,rarity:"rare"}},siccatite:{low:null,standard:{level:8,price:440,hardness:6,maxHP:24,rarity:"rare"},high:{level:16,price:8800,hardness:10,maxHP:40,rarity:"rare"}},silver:{low:{level:2,price:34,hardness:3,maxHP:12,rarity:"common"},standard:{level:7,price:340,hardness:5,maxHP:20,rarity:"common"},high:{level:15,price:5500,hardness:8,maxHP:32,rarity:"common"}}},TOWER_SHIELD_MATERIAL_VALUATION_DATA={"":{low:null,standard:null,high:null},duskwood:{low:null,standard:{level:8,price:560,hardness:5,maxHP:20,rarity:"uncommon"},high:{level:16,price:11200,hardness:8,maxHP:32,rarity:"uncommon"}}},MATERIAL_DATA={armor:ARMOR_MATERIAL_VALUATION_DATA,shield:{shield:SHIELD_MATERIAL_VALUATION_DATA,buckler:BUCKLER_MATERIAL_VALUATION_DATA,towerShield:TOWER_SHIELD_MATERIAL_VALUATION_DATA},weapon:WEAPON_MATERIAL_VALUATION_DATA};function computePrice(item){if(item.isOfType("treasure"))return item.price.value;const materialPrice=getMaterialValuationData(item)?.price??0,heldOrStowedBulk=new Bulk(item.system.bulk.heldOrStowed),bulk=item.isOfType("shield")?0:Math.max(heldOrStowedBulk.normal,1),materialValue=item.isSpecific?0:materialPrice+bulk*materialPrice/10,runesData=getRuneValuationData(item),reinforcingRuneValue=!item.isOfType("shield")||item.isSpecific?0:RUNE_DATA.shield.reinforcing[item.system.runes.reinforcing]?.price??0,runeValue=item.isSpecific?0:runesData.reduce((sum,rune)=>sum+rune.price,0)-reinforcingRuneValue,basePrice=materialValue>0||runeValue>0?new Coins:item.price.value,gradeValue=item.isSpecific?0:getGradeData(item).price,afterMaterialAndRunes=runeValue?new Coins({gp:runeValue+materialValue}):basePrice.plus({gp:gradeValue+materialValue}),afterReinforcingRune=(afterMaterialAndRunes.copperValue>basePrice.copperValue?afterMaterialAndRunes:basePrice).plus(new Coins({gp:reinforcingRuneValue})),afterShoddy=item.isShoddy?afterReinforcingRune.scale(.5):afterReinforcingRune;return item.system.price.sizeSensitive?afterShoddy.adjustForSize(item.size):afterShoddy}__name(computePrice,"computePrice"),__name2(computePrice,"computePrice");function computeLevelRarityPrice(item){const materialData=getMaterialValuationData(item),price=computePrice(item),gradeData=getGradeData(item);if(!(item.isMagical||materialData||gradeData.level)||item.isSpecific)return{...t$3(item,["level","rarity"]),price};const runesData=getRuneValuationData(item),level=Math.max(...runesData.map(r2=>r2.level),materialData?.level??0,gradeData.level,item.level),rarityOrder={common:0,uncommon:1,rare:2,unique:3},baseRarity=item.rarity,rarity=runesData.map(runeData=>runeData.rarity).concat(materialData?.rarity??"common").reduce((highest,rarity2)=>rarityOrder[rarity2]>rarityOrder[highest]?rarity2:highest,baseRarity);return{level,rarity,price}}__name(computeLevelRarityPrice,"computeLevelRarityPrice"),__name2(computeLevelRarityPrice,"computeLevelRarityPrice");function getGradeData(item){if(!item.isOfType("weapon","armor","shield")||item.system.grade===null)return{level:0,price:0};const gradeData=item.isOfType("weapon")?CONFIG.PF2E.weaponImprovements[item.system.grade]:item.isOfType("armor")?CONFIG.PF2E.armorImprovements[item.system.grade]:CONFIG.PF2E.shieldImprovements[item.system.grade],price=gradeData.credits/10;return{level:gradeData?.level,price}}__name(getGradeData,"getGradeData"),__name2(getGradeData,"getGradeData");async function checkPhysicalItemSystemChange(item,changed){const newTraits=changed.system?.traits?.value;if(!item.isOfType("weapon","armor","shield")||!newTraits)return null;const sf2eTraits=["tech","analog"],beforeSF2eTraits=item._source.system.traits.value.filter(t2=>tupleHasValue(sf2eTraits,t2)),wasSF2e=!!beforeSF2eTraits.length,becomingSF2e=newTraits.some(t2=>tupleHasValue(sf2eTraits,t2)),runes=item._source.system.runes,hasPotency="potency"in runes&&runes.potency>0,hasRunes=hasPotency||"striking"in runes&&runes.striking>0||"reinforcing"in runes&&runes.reinforcing>0||hasPotency&&"property"in runes&&runes.property.length>0,hasGrade=item.system.grade&&item.system.grade!=="commercial";if(wasSF2e===becomingSF2e||!(hasRunes||hasGrade))return null;const key=`PF2E.Item.Physical.ChangeEquipmentSystem.${becomingSF2e?"ToStarfinder":"ToPathfinder"}`,removedTrait=beforeSF2eTraits.find(t2=>!newTraits.includes(t2)),otherTrait=removedTrait==="tech"?"analog":"tech",newTrait=newTraits.find(t2=>tupleHasValue(sf2eTraits,t2)),otherTraitLabel=game.i18n.localize(CONFIG.PF2E.equipmentTraits[otherTrait]),result=await foundry.applications.api.DialogV2.wait({window:{title:"PF2E.Item.Physical.ChangeEquipmentSystem.Title"},position:{width:400},modal:!0,content:game.i18n.format(key,{type:game.i18n.localize(`TYPES.Item.${item.type}`),newTrait:newTrait&&game.i18n.localize(CONFIG.PF2E.equipmentTraits[newTrait]),removedTrait:removedTrait&&game.i18n.localize(CONFIG.PF2E.equipmentTraits[removedTrait]),otherTrait:otherTraitLabel}),buttons:[{action:"yes",label:"Yes",icon:"fa-solid fa-check",callback:__name2(()=>!0,"callback")},!becomingSF2e&&{action:"change",label:otherTraitLabel,icon:"fa-solid fa-robot"},{action:"no",label:"No",icon:"fa-solid fa-xmark",default:!0,callback:__name2(()=>!1,"callback")}].filter(e$1)});if(result){if(result==="change")return newTraits.push(otherTrait),null}else throw item.render(),Error;return becomingSF2e?"sf2e":"pf2e"}__name(checkPhysicalItemSystemChange,"checkPhysicalItemSystemChange"),__name2(checkPhysicalItemSystemChange,"checkPhysicalItemSystemChange");function generateItemName(item){if(!item.isOfType("armor","shield","weapon"))return item.name;const[baseItemDictionary,propertyDictionary,fundamentalTwoDictionary]=item.isOfType("armor")?[CONFIG.PF2E.baseArmorTypes,RUNE_DATA.armor.property,RUNE_DATA.armor.resilient]:item.isOfType("shield")?[CONFIG.PF2E.baseShieldTypes,null,null]:[{...CONFIG.PF2E.baseWeaponTypes,...CONFIG.PF2E.baseShieldTypes},RUNE_DATA.weapon.property,RUNE_DATA.weapon.striking],storedName=item._source.name,baseType=item.baseType??"";if(!baseType||!(baseType in baseItemDictionary)||item.isSpecific||storedName!==game.i18n.localize(baseItemDictionary[baseType]??""))return item.name;const{runes,material,grade}=item.system,baseLabel=baseType?material.type&&["hide-armor","steel-shield","wooden-shield"].includes(baseType)?game.i18n.localize(`TYPES.Item.${item.type}`):game.i18n.localize(baseItemDictionary[baseType]??""):item.name,materialLabel=material.type&&game.i18n.localize(CONFIG.PF2E.preciousMaterials[material.type]);if(grade&&!AutomaticBonusProgression.isEnabled(item.actor)){const params={base:baseLabel,material:materialLabel,grade:game.i18n.localize(CONFIG.PF2E.grades[grade])},formatString=["Grade",params.material&&"Material"].filter(e$1).join("");return game.i18n.format(`PF2E.Item.Physical.GeneratedName.${formatString}`,params)}else{const potency="potency"in runes?runes.potency:null,fundamental2="resilient"in runes?runes.resilient:"striking"in runes?runes.striking:null,reinforcing="reinforcing"in runes&&game.i18n.localize(REINFORCING_RUNE_LOC_PATHS[Number(runes.reinforcing)]??"")||null,params={base:baseLabel,material:materialLabel,potency,reinforcing,fundamental2:fundamental2&&fundamentalTwoDictionary&&game.i18n.localize(fundamentalTwoDictionary[fundamental2]?.name??"")||null};if("property"in runes&&propertyDictionary)for(const index2 of[0,1,2,3])params[`property${index2+1}`]=game.i18n.localize(propertyDictionary[runes.property[index2]]?.name??"")||null;const formatString=(()=>{const potency2=params.potency?"Potency":null,reinforcing2=params.reinforcing?"Reinforcing":null,fundamental22=params.fundamental2&&"Fundamental2",properties=params.property4?"FourProperties":params.property3?"ThreeProperties":params.property2?"TwoProperties":params.property1?"OneProperty":null,material2=params.material&&"Material",key=[potency2,reinforcing2,fundamental22,properties,material2].filter(e$1).join("")||null;return key&&game.i18n.localize(key)})();return formatString?game.i18n.format(`PF2E.Item.Physical.GeneratedName.${formatString}`,params):item.name}}__name(generateItemName,"generateItemName"),__name2(generateItemName,"generateItemName");function handleHPChange(item,changed){for(const property of["value","max"])changed.system?.hp&&changed.system.hp[property]!==void 0&&(changed.system.hp[property]=Math.max(Math.floor(Number(changed.system.hp[property])),0)||0);const actorSource=item.actor?.toObject(),changedSource=item.clone(foundry.utils.deepClone(changed),{keepId:!0}).toObject(),itemIndex=actorSource?.items.findIndex(i=>i._id===item._id);if(itemIndex===-1)return;actorSource?.items.splice(itemIndex??0,1,changedSource);const itemClone=(()=>{try{return actorSource?new ActorProxyPF2e(actorSource):null}catch{}return null})()?.inventory.get(item.id,{strict:!0})??item.clone(changed,{keepId:!0}),maxHPDifference=itemClone.system.hp.max-item.system.hp.max;maxHPDifference!==0&&(changed.system=foundry.utils.mergeObject(changed.system??{},{hp:{value:Math.max(item.system.hp.value+maxHPDifference,0)}})),(changed.system?.hp?.value??itemClone.system.hp.value)>itemClone.system.hp.max&&(changed.system=foundry.utils.mergeObject(changed.system??{},{hp:{value:itemClone.system.hp.max}}))}__name(handleHPChange,"handleHPChange"),__name2(handleHPChange,"handleHPChange");function prepareBulkData(item){const per=(objectHasKey(STACK_DEFINITIONS,item.system.stackGroup)?STACK_DEFINITIONS[item.system.stackGroup]??null:null)?.size??1,sourceBulk=item._source.system.bulk,heldOrStowed=item.isOfType("armor")?new Bulk(sourceBulk.value).increment().value:"heldOrStowed"in sourceBulk?Number(sourceBulk.heldOrStowed)||0:sourceBulk.value,worn=item.system.bulk.value,value=!item.actor||item.isEquipped?worn:heldOrStowed,data={heldOrStowed,value,per};return item.isOfType("backpack")?{...data,capacity:item.system.bulk.capacity,ignored:item.system.bulk.ignored}:data}__name(prepareBulkData,"prepareBulkData"),__name2(prepareBulkData,"prepareBulkData");function sizeItemForActor(item,actor){if(item.isOfType("treasure")||!actor.isOfType("creature"))return item.clone();const actorSize=new ActorSizePF2e({value:actor.system.traits.naturalSize??actor.size,smallIsMedium:!0}),itemSize=actorSize.value,sizeSensitive=actor.isOfType("character")&&actorSize.isLargerThan("med")&&!item.isMagical?!1:void 0;return itemSize==="med"?item.clone():item.clone({system:{size:itemSize,price:{sizeSensitive}}})}__name(sizeItemForActor,"sizeItemForActor"),__name2(sizeItemForActor,"sizeItemForActor");function getDefaultEquipStatus(item){const equipStatus={carryType:"worn"};return item.system.usage.type==="worn"&&!!item.system.usage.where&&item.actor?.isOfType("character")&&(equipStatus.inSlot=!1),equipStatus}__name(getDefaultEquipStatus,"getDefaultEquipStatus"),__name2(getDefaultEquipStatus,"getDefaultEquipStatus");async function transferCredits({item,targetActor,quantity}){const actor=item.actor;if(!actor)throw ErrorPF2e("Source credstick must have an actor");if(!item.isOfType("treasure")||item.system.category!=="credstick")throw ErrorPF2e("Must transfer from credstick");if(__name2((source2,target)=>{const bothAreOwned=source2.isOwner&&target.isOwner,sourceIsOwnedOrLoot=source2.isLootableBy(game.user),targetIsOwnedOrLoot=target.isLootableBy(game.user);return!bothAreOwned&&sourceIsOwnedOrLoot&&targetIsOwnedOrLoot},"gmMustTransfer")(actor,targetActor)){const source2={tokenId:actor.token?.id,actorId:actor.id,itemId:item.id},target={tokenId:targetActor.token?.id,actorId:targetActor.id};return await new ItemTransfer({source:source2,target,quantity,mode:"credits"}).request()}quantity=Math.min(quantity,item.system.price.value.credits),await targetActor.inventory.addCurrency({credits:quantity}),await item.update({"system.price.value":new Coins({credits:item.system.price.value.credits-quantity}).toObject()})}__name(transferCredits,"transferCredits"),__name2(transferCredits,"transferCredits");class ActiveEffectPF2e extends ActiveEffect{static{__name(this,"ActiveEffectPF2e")}static{__name2(this,"ActiveEffectPF2e")}static fromEffect(effect){const isEffect=effect.isOfType("effect"),isCondition=effect.isOfType("condition"),duration={seconds:null,rounds:isEffect&&effect.system.duration.unit==="rounds"?effect.system.duration.value:null,turns:null,combat:effect.actor.combatant?.encounter._id??null,startTime:isEffect?effect.system.start.value:null,startRound:null,startTurn:isEffect?effect.system.start.initiative:null};return new this({name:effect.name,img:effect.img,system:{},description:effect.system.description.value,disabled:isCondition?!effect.active:!1,duration,origin:effect.uuid,transfer:!0,statuses:[effect.slug].filter(e$1),flags:foundry.utils.deepClone(effect.flags),_stats:foundry.utils.deepClone(effect._stats)},{parent:effect.actor})}async _preCreate(data,options,user){return data.statuses?.includes("dead")?super._preCreate(data,options,user):!1}}function loreSkillsFromActors(actors){const characters=(Array.isArray(actors)?actors:[actors]).filter(a=>a?.type==="character");return Object.fromEntries(characters.flatMap(m=>Object.values(m.skills)).filter(s=>s.lore).map(s=>[s.slug,s.label]))}__name(loreSkillsFromActors,"loreSkillsFromActors"),__name2(loreSkillsFromActors,"loreSkillsFromActors");async function getActions(){const indexFields=["system.slug"],pack=game.packs.get("pf2e.actionspf2e");if(pack){const actions=(await pack.getIndex({fields:indexFields})).map(a=>[a.system.slug,a.name]);return Object.fromEntries(actions)}else return{}}__name(getActions,"getActions"),__name2(getActions,"getActions");const appv1$f=foundry.appv1;class CheckPromptDialog extends appv1$f.api.Application{static{__name(this,"CheckPromptDialog")}static{__name2(this,"CheckPromptDialog")}#actions;#lores;static get defaultOptions(){return{...super.defaultOptions,classes:["dialog"],id:"generate-check-prompt",tabs:[{navSelector:".skill-save-navigation",contentSelector:".check-prompt-content",initial:"skills"},{navSelector:".dc-navigation",contentSelector:".dc-content",initial:"set-dc"}],template:"systems/pf2e/templates/gm/check-prompt.hbs",title:game.i18n.localize("PF2E.Actor.Party.CheckPrompt.Title"),width:400,height:"auto"}}async getData(){return this.#actions=await getActions(),this.#lores=loreSkillsFromActors(this.options.actors??game.actors.party?.members??[]),{proficiencyRanks:this.#prepareProficiencyRanks(),dcAdjustments:this.#prepareDCAdjustments(),partyLevel:game.actors.party?.level??null}}#prepareProficiencyRanks(){const pwol=game.pf2e.settings.variants.pwol.enabled;return PROFICIENCY_RANKS.map(value=>({value,label:`${value} (${calculateSimpleDC(value,{pwol})})`}))}#prepareDCAdjustments(){return Object.entries(CONFIG.PF2E.dcAdjustments).filter(([value,_])=>value!=="normal").map(([value,name2])=>({value,label:`${game.i18n.localize(name2)} (${signedInteger(adjustDC(0,value))})`}))}activateListeners($html){const html2=$html[0],skillEl=html2.querySelector("input#check-prompt-skills"),skills={...t$5(CONFIG.PF2E.skills,s=>s.label),perception:"PF2E.PerceptionLabel"};tagify(skillEl,{whitelist:skills});const saveEl=html2.querySelector("input#check-prompt-saves");tagify(saveEl,{whitelist:CONFIG.PF2E.saves});const loreEl=html2.querySelector("input#check-prompt-lores"),loreOptions=e$4(this.#lores||{})?{}:{whitelist:this.#lores};tagify(loreEl,loreOptions);const actionEl=html2.querySelector("input#check-prompt-actions"),actionOptions=e$4(this.#actions||{})?{}:{whitelist:this.#actions,enforceWhitelist:!1};tagify(actionEl,actionOptions);const traitEl=html2.querySelector("input#check-prompt-traits");tagify(traitEl,{whitelist:CONFIG.PF2E.actionTraits,enforceWhitelist:!1}),html2.querySelector("div.form-group a.add-roll-options")?.addEventListener("click",()=>{const sectionEl=html2.querySelector("section.check-prompt-content");sectionEl&&sectionEl.classList.toggle("show-roll-options")}),htmlQuery(html2,"[data-action=post]")?.addEventListener("click",async()=>{this.#generatePrompt()}),htmlQuery(html2,"[data-action=cancel]")?.addEventListener("click",async()=>{this.close()})}#generatePrompt(){const html2=this.element[0],types=[],traits=[],extras=[],activeSkillSaveTab=htmlQuery(html2,"section.check-prompt-content section.tab.active");if(activeSkillSaveTab?.dataset.tab==="skills"?(types.push(...this.#htmlQueryTags(html2,"input#check-prompt-skills")),types.push(...this.#htmlQueryTags(html2,"input#check-prompt-lores").map(t2=>this.#formatLoreType(t2))),traits.push(...this.#htmlQueryTags(html2,"input#check-prompt-traits")),traits.push(...this.#htmlQueryTags(html2,"input#check-prompt-actions").map(a=>this.#formatActionType(a))),html2.querySelector("input#check-prompt-secret:checked")&&!traits.includes("secret")&&traits.push("secret")):activeSkillSaveTab?.dataset.tab==="saves"&&(types.push(...this.#htmlQueryTags(html2,"input#check-prompt-saves")),htmlQuery(html2,"input#check-prompt-basic-save:checked")&&extras.push("basic:true")),types.length>0){const titleEl=htmlQuery(html2,"input#check-prompt-title"),flavor=titleEl?.value?`<h4 class="action"><strong>${titleEl.value}</strong></h4><hr>`:"",dc=this.#getDC(html2),content=types.map(type2=>this.#constructCheck(type2,dc,traits,extras)).join("");ChatMessagePF2e.create({author:game.user.id,flavor,content})}}#htmlQueryTags(html2,selector){const el=htmlQuery(html2,selector);return(el instanceof HTMLInputElement&&el.value?JSON.parse(el.value):[]).map(tag=>tag.id||tag.value)}#formatLoreType(type2){let loreType=type2.toLowerCase().replaceAll(" ","-").trim();return loreType.includes("lore")||(loreType=loreType.concat("-lore")),loreType}#formatActionType(type2){return`action:${type2.toLowerCase().replace("action:","").trim()}`}#getDC(html2){const dc=(()=>{const pwol=game.pf2e.settings.variants.pwol.enabled,activeDCTab=htmlQuery(html2,"section.dc-content section.tab.active");if(activeDCTab?.dataset.tab==="set-dc")return Number(htmlQuery(html2,"input#check-prompt-dc")?.value||NaN);if(activeDCTab?.dataset.tab==="simple-dc"){const profRank=htmlQuery(html2,"select#check-prompt-simple-dc")?.value;if(tupleHasValue(PROFICIENCY_RANKS,profRank))return calculateSimpleDC(profRank,{pwol})}else if(activeDCTab?.dataset.tab==="level-dc"){const level=Number(htmlQuery(html2,"input#check-prompt-level-dc")?.value||NaN);if(Number.isInteger(level))return calculateDC(+level,{pwol})}return NaN})();if(Number.isInteger(dc)){const dcAdjustment=htmlQuery(html2,"select#check-prompt-adjust-difficulty")?.value;return dcAdjustment?adjustDC(dc,dcAdjustment):dc}return null}#constructCheck(type2,dc,traits,extras){return`<p>@Check[${[type2,Number.isInteger(dc)?`dc:${dc}`:null,traits.length?`traits:${traits.join(",")}`:null].concat(...extras).filter(p=>p).join("|")}]</p>`}}async function checkPrompt(options={}){new CheckPromptDialog(options.actors?{actors:options.actors}:{}).render(!0)}__name(checkPrompt,"checkPrompt"),__name2(checkPrompt,"checkPrompt");function escapeHtml(text2){const p=document.createElement("p");return p.innerText=text2,p.innerHTML}__name(escapeHtml,"escapeHtml"),__name2(escapeHtml,"escapeHtml");function isExperiencedProfessional(actor){return actor.itemTypes.feat.some(i=>i.slug==="experienced-professional")}__name(isExperiencedProfessional,"isExperiencedProfessional"),__name2(isExperiencedProfessional,"isExperiencedProfessional");function degreeOfSuccessLabel(degreeIndex){const degreeSlug=DEGREE_OF_SUCCESS_STRINGS[degreeIndex];return game.i18n.localize(`PF2E.Check.Result.Degree.Check.${degreeSlug}`)}__name(degreeOfSuccessLabel,"degreeOfSuccessLabel"),__name2(degreeOfSuccessLabel,"degreeOfSuccessLabel");function coinsToString(coins,degreeOfSuccess){return degreeOfSuccess===0?"none":coins.toString()}__name(coinsToString,"coinsToString"),__name2(coinsToString,"coinsToString");function chatTemplate(skillName,earnIncomeResult){const degreeOfSuccess=degreeOfSuccessLabel(earnIncomeResult.degreeOfSuccess),payPerDay=escapeHtml(coinsToString(earnIncomeResult.rewards.perDay,earnIncomeResult.degreeOfSuccess)),combinedPay=escapeHtml(coinsToString(earnIncomeResult.rewards.combined,earnIncomeResult.degreeOfSuccess)),level=earnIncomeResult.level,daysSpentWorking=earnIncomeResult.daysSpentWorking,forDays=daysSpentWorking>1?`<p><strong>Salary for ${daysSpentWorking} days</strong> ${combinedPay}</p>`:"",successColor=earnIncomeResult.degreeOfSuccess>1?"darkgreen":"darkred",dc=earnIncomeResult.dc,roll=earnIncomeResult.roll;return`
    <div class="pf2e chat-card">
        <header class="card-header flexrow">
            <img src="systems/pf2e/icons/equipment/treasure/currency/gold-pieces.webp" title="Income" width="36" height="36">
            <h3>Earn Income Level ${level}</h3>
        </header>
        <div class="card-content">
            <p><strong>Result</strong> <span style="color: ${successColor}">${degreeOfSuccess} (DC: ${dc}, Roll: ${roll})</span></p>
            <p><strong>Skill</strong> ${escapeHtml(skillName)}</p>
            <p><strong>Salary per day</strong> ${payPerDay}</p>
            ${forDays}
        </div>
    </div>
    `}__name(chatTemplate,"chatTemplate"),__name2(chatTemplate,"chatTemplate");function postToChat(skillName,earnIncomeResult){const content=chatTemplate(skillName,earnIncomeResult);return ChatMessagePF2e.create({author:game.user.id,content,speaker:ChatMessage.getSpeaker()})}__name(postToChat,"postToChat"),__name2(postToChat,"postToChat");function calculateIncome({actor,skill,rollBrief,level,days,dc}){const options={useLoreAsExperiencedProfessional:isExperiencedProfessional(actor)&&!!skill.lore},proficiency=Math.max(1,skill.rank??1),result=earnIncome({level,days,rollBrief,proficiency,options,dc});postToChat(skill.label,result)}__name(calculateIncome,"calculateIncome"),__name2(calculateIncome,"calculateIncome");function runEarnIncome({actor,event:event2,skill,level,days}){const dc=calculateDC(level,{pwol:game.pf2e.settings.variants.pwol.enabled});actor.getStatistic(skill.slug)?.roll({...eventToRollParams(event2,{type:"check"}),action:"earn-income",dc,label:`Earn Income: ${skill.label}`,extraRollOptions:["action:earn-income"],traits:["downtime"],callback:__name2(roll=>{const dieValue=roll.dice[0].results[0].result,modifier=roll.total-dieValue;calculateIncome({actor,skill,rollBrief:{dieValue,modifier},level,days,dc})},"callback")})}__name(runEarnIncome,"runEarnIncome"),__name2(runEarnIncome,"runEarnIncome");function askSkillPopupTemplate(skills){const level=Number(localStorage.getItem("earnIncomeLevel"))||0,days=Number(localStorage.getItem("earnIncomeDays"))||1,skillAcronym=localStorage.getItem("earnIncomeSkillAcronym"),skillOptions=skills.map(skill=>{const skillName=escapeHtml(skill.label),selected=skillAcronym===skill.slug?"selected":"";return`<option value="${skill.slug}" ${selected}>${skillName}</option>`}).join(""),levelOptions=Array(21).fill(0).map((_,index2)=>`<option value="${index2}" ${index2===level?"selected":""}>${index2}</option>`).join("");return`
    <form>
    <div class="form-group">
        <label>Trained Skills/Lores</label>
        <select name="skillAcronym">
            ${skillOptions}
        </select>
    </div>
    <div class="form-group">
        <label>Level</label>
        <select name="level">
            ${levelOptions}
        </select>
    </div>
    <div class="form-group">
        <label>Days</label>
        <input type="number" name="days" value="${days}">
    </div>
    </form>
    `}__name(askSkillPopupTemplate,"askSkillPopupTemplate"),__name2(askSkillPopupTemplate,"askSkillPopupTemplate");function showEarnIncomePopup(actor){if(!actor?.isOfType("character")){ui.notifications.error("You must select at least one PC");return}const skills=Object.values(actor.skills).filter(s=>s.proficient);new foundry.appv1.api.Dialog({title:"Earn Income",content:askSkillPopupTemplate(skills),buttons:{no:{icon:fontAwesomeIcon("times").outerHTML,label:"Cancel"},yes:{icon:fontAwesomeIcon("coins").outerHTML,label:"Earn Income",callback:__name2(($html,event2)=>{const html2=$html[0],level=Number(html2.querySelector("[name=level]")?.value)||0,days=Number(html2.querySelector("[name=days]")?.value)||1,skillAcronym=html2.querySelector("[name=skillAcronym]")?.value??"soc",skill=skills.find(s=>s.slug===skillAcronym);if(!skill)throw ErrorPF2e("Skill not found");localStorage.setItem("earnIncomeLevel",level.toString()),localStorage.setItem("earnIncomeDays",days.toString()),localStorage.setItem("earnIncomeSkillAcronym",skillAcronym),runEarnIncome({actor,event:event2?.originalEvent,skill,level,days})},"callback")}},default:"yes"}).render(!0)}__name(showEarnIncomePopup,"showEarnIncomePopup"),__name2(showEarnIncomePopup,"showEarnIncomePopup");async function editPersistent(options){const actors=[options.actors].flat().filter(e$1);if(actors.length===0){ui.notifications.error(game.i18n.localize("PF2E.ErrorMessage.NoTokenSelected"));return}for(const actor of actors)new PersistentDamageEditor({actor}).render({force:!0})}__name(editPersistent,"editPersistent"),__name2(editPersistent,"editPersistent");function encouragingWords(options){const localize=localizer("PF2E.Actions.EncouragingWords"),actors=Array.isArray(options.actors)?options.actors:[options.actors],actor=actors[0];if(actors.length>1||!(actor instanceof CharacterPF2e)){ui.notifications.error(localize("BadArgs"));return}const encouragingWordsMacro=__name2(async(DC,bonus,diplomacy)=>{diplomacy.roll({dc:{value:DC},extraRollOptions:["action:encouraging-words"],callback:__name2(async roll=>{let healFormula,successLabel;const degreeOfSuccess=Number(roll.options.degreeOfSuccess)||0,bonusString=bonus>0?`+ ${bonus}`:"";if(degreeOfSuccess===3?(healFormula=`2d8${bonusString}`,successLabel=localize("CritSuccess")):degreeOfSuccess===2?(healFormula=`1d8${bonusString}`,successLabel=localize("Success")):degreeOfSuccess===1?successLabel=localize("Failure"):degreeOfSuccess===0&&(healFormula="1d8",successLabel=localize("CritFailure")),healFormula){const healRoll=await new Roll(healFormula).roll(),rollType=degreeOfSuccess>1?localize("Recovery"):localize("Damage"),token=actor.getActiveTokens().shift()?.document??null;ChatMessagePF2e.create({speaker:ChatMessagePF2e.getSpeaker({actor,token}),flavor:`<strong>${rollType} ${localize("Title")}</strong> (${successLabel})`,rolls:[healRoll.toJSON()]})}},"callback")})},"encouragingWordsMacro"),applyChanges=__name2($html=>{const{diplomacy}=actor.skills,mod=Number($html.find("[name=modifier]").val())||0,requestedProf=Number($html.find("[name=dc-type]").val())||1,rank=diplomacy.rank??0,usedProf=requestedProf<=rank?requestedProf:rank,roll=[()=>ui.notifications.warn(localize("NotTrained",{name:actor.name})),()=>encouragingWordsMacro(15+mod,0,diplomacy),()=>encouragingWordsMacro(20+mod,5,diplomacy),()=>encouragingWordsMacro(30+mod,15,diplomacy),()=>encouragingWordsMacro(40+mod,25,diplomacy)][usedProf];roll()},"applyChanges");new foundry.appv1.api.Dialog({title:localize("Title"),content:`
    <div>${localize("ContentMain")}</div>
    <hr/>
    <form>
    <div class="form-group">
    <label for="dc-type">${localize("ContentLabel1")}</label>
    <select id="dc-type" name="dc-type">
    <option value="1">${localize("ContentOption1")}</option>
    <option value="2">${localize("ContentOption2")}</option>
    <option value="3">${localize("ContentOption3")}</option>
    <option value="4">${localize("ContentOption4")}</option>
    </select>
    </div>
    </form>
    <form>
    <div class="form-group">
    <label for="modifier">${localize("ContentLabel2")}</label>
    <input id="modifier" name="modifier" type="number" />
    </div>
    </form>
    `,buttons:{yes:{icon:fontAwesomeIcon("hand-holding-medical").outerHTML,label:localize("Title"),callback:applyChanges},no:{icon:fontAwesomeIcon("times").outerHTML,label:localize("Cancel")}},default:"yes"}).render(!0)}__name(encouragingWords,"encouragingWords"),__name2(encouragingWords,"encouragingWords");var root_1$b=from_html("<span> </span>"),root_2$a=from_html('<span class="tag"> </span>'),root_3$9=from_html('<span class="tag light property"> </span>'),root$h=from_html('<div class="tags paizo-style"><!> <!> <!></div>');function Item_traits($$anchor,$$props){push($$props,!0);const traits=prop($$props,"traits",19,()=>[]),properties=prop($$props,"properties",19,()=>[]),rarityLabel=$$props.rarity?CONFIG.PF2E.rarityTraits[$$props.rarity]:null;var div=root$h(),node=child(div);{var consequent=__name2($$anchor2=>{var span=root_1$b(),text2=child(span);template_effect(($0,$1)=>{set_class(span,1,$0),set_text(text2,$1)},[()=>clsx(["tag","rarity",$$props.rarity].join(" ")),()=>game.i18n.localize(rarityLabel)]),append($$anchor2,span)},"consequent");if_block(node,$$render=>{$$props.rarity&&$$props.rarity!=="common"&&rarityLabel&&$$render(consequent)})}var node_1=sibling(node,2);each(node_1,17,()=>traits().filter(t2=>!t2.mystified),trait=>trait.value,($$anchor2,trait)=>{var span_1=root_2$a(),text_1=child(span_1);template_effect(()=>{set_attribute(span_1,"data-trait",get(trait).value),set_text(text_1,get(trait).label)}),append($$anchor2,span_1)});var node_2=sibling(node_1,2);each(node_2,16,properties,property=>property,($$anchor2,property)=>{var span_2=root_3$9(),text_2=child(span_2);template_effect($0=>set_text(text_2,$0),[()=>game.i18n.localize(property)]),append($$anchor2,span_2)}),append($$anchor,div),pop()}__name(Item_traits,"Item_traits"),__name2(Item_traits,"Item_traits"),enable_legacy_mode_flag();var root$g=from_svg('<svg height="512" width="512" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><g style="" transform="translate(32,23)"><path d="M96 36.61L41.21 173.6c.26.6.84 1.4 2.15 2.5 2.16 1.8 6.2 4 11.49 5.8 10.57 3.5 25.9 5.5 41.15 5.5 15.2 0 30.6-2 41.2-5.5 5.2-1.8 9.3-4 11.4-5.8 1.3-1.2 1.9-1.9 2.2-2.5zm160 0L201.2 173.6c.3.6.9 1.3 2.2 2.5 2.1 1.8 6.2 4 11.4 5.8 10.6 3.5 26 5.5 41.2 5.5 15.3 0 30.6-2 41.2-5.5 5.2-1.8 9.3-4 11.4-5.8 1.3-1.2 1.9-1.9 2.2-2.5zm160 0L361.2 173.6c.3.6.9 1.3 2.2 2.5 2.1 1.8 6.2 4 11.4 5.8 10.6 3.5 26 5.5 41.2 5.5 15.2 0 30.6-2 41.2-5.5 5.2-1.8 9.3-4 11.4-5.8 1.3-1.2 1.9-1.9 2.2-2.5zM41 195.7v17c0 1 .2 1.8 2.36 3.7 2.16 1.8 6.2 4 11.49 5.8 10.57 3.5 25.9 5.5 41.15 5.5 15.2 0 30.6-2 41.2-5.5 5.2-1.8 9.3-4 11.4-5.8 2.2-1.9 2.4-2.7 2.4-3.7v-17c-2.6 1.2-5.3 2.3-8.2 3.2-13.4 4.5-30 6.5-46.8 6.5-16.75 0-33.42-2-46.85-6.5-2.87-.9-5.59-2-8.15-3.2zm160 0v17c0 1 .2 1.8 2.4 3.7 2.1 1.8 6.2 4 11.4 5.8 10.6 3.5 26 5.5 41.2 5.5 15.3 0 30.6-2 41.2-5.5 5.2-1.8 9.3-4 11.4-5.8 2.2-1.9 2.4-2.7 2.4-3.7v-17c-2.6 1.2-5.3 2.3-8.2 3.2-13.4 4.5-30 6.5-46.8 6.5-16.8 0-33.4-2-46.8-6.5-2.9-.9-5.6-2-8.2-3.2zm160 0v17c0 1 .2 1.8 2.4 3.7 2.1 1.8 6.2 4 11.4 5.8 10.6 3.5 26 5.5 41.2 5.5 15.2 0 30.6-2 41.2-5.5 5.2-1.8 9.3-4 11.4-5.8 2.2-1.9 2.4-2.7 2.4-3.7v-17c-2.6 1.2-5.3 2.3-8.2 3.2-13.4 4.5-30 6.5-46.8 6.5-16.8 0-33.4-2-46.8-6.5-2.9-.9-5.6-2-8.2-3.2zM41 236v158.3l17.06 34.1-16.71 33.4c.3.6.87 1.3 2.01 2.3 2.16 1.8 6.2 4 11.49 5.8 10.57 3.5 25.9 5.5 41.15 5.5 15.2 0 30.6-2 41.2-5.5 5.2-1.8 9.3-4 11.4-5.8 1.2-1 1.7-1.7 2.1-2.3l-16.8-33.4 17.1-34.1V236c-2.6 1.2-5.3 2.3-8.2 3.2-13.4 4.5-30 6.5-46.8 6.5-16.75 0-33.42-2-46.85-6.5-2.87-.9-5.59-2-8.15-3.2zm160 0v158.3l17.1 34.1-16.8 33.4c.4.6.9 1.3 2.1 2.3 2.1 1.8 6.2 4 11.4 5.8 10.6 3.5 26 5.5 41.2 5.5 15.3 0 30.6-2 41.2-5.5 5.2-1.8 9.3-4 11.4-5.8 1.2-1 1.7-1.7 2.1-2.3l-16.8-33.4 17.1-34.1V236c-2.6 1.2-5.3 2.3-8.2 3.2-13.4 4.5-30 6.5-46.8 6.5-16.8 0-33.4-2-46.8-6.5-2.9-.9-5.6-2-8.2-3.2zm160 0v158.3l17.1 34.1-16.8 33.4c.4.6.9 1.3 2.1 2.3 2.1 1.8 6.2 4 11.4 5.8 10.6 3.5 26 5.5 41.2 5.5 15.2 0 30.6-2 41.2-5.5 5.2-1.8 9.3-4 11.4-5.8 1.2-1 1.7-1.7 2.1-2.3l-16.8-33.4 17.1-34.1V236c-2.6 1.2-5.3 2.3-8.2 3.2-13.4 4.5-30 6.5-46.8 6.5-16.8 0-33.4-2-46.8-6.5-2.9-.9-5.6-2-8.2-3.2z" fill="#000000" fill-opacity="1"></path></g></svg>');function Heavy_bullets($$anchor){var svg=root$g();append($$anchor,svg)}__name(Heavy_bullets,"Heavy_bullets"),__name2(Heavy_bullets,"Heavy_bullets");var on_click$6=__name2((_,$$props,ammo)=>$$props.foundryApp.reloadWeapon(get(ammo).id),"on_click$6"),on_click_1$5=__name2((__1,$$props,ammo)=>$$props.foundryApp.reloadWeapon(get(ammo).id,!0),"on_click_1$5"),root_3$8=from_html('<button type="button" class="select svelte-152e5ll" data-tooltip=""><!></button>'),on_click_2$3=__name2((__2,openStates,ammo)=>openStates[get(ammo).uuid]=!openStates[get(ammo).uuid],"on_click_2$3"),root_4$4=from_html('<i class="fa-solid fa-stopwatch" inert></i>'),root_5$5=from_html('<span class="uses svelte-152e5ll"><span class="icon svelte-152e5ll"><!></span> </span>'),root_2$9=from_html('<div><button type="button" class="icon fa-solid fa-check select svelte-152e5ll" data-tooltip=""></button> <!> <img alt="item" class="svelte-152e5ll"/> <button class="name flat svelte-152e5ll"><span> <!> <!> <span class="quantity svelte-152e5ll"> </span></span> <!></button> <!></div>'),root$f=from_html("<div><!> <!></div>");function App$5($$anchor,$$props){push($$props,!0);const openStates=proxy({});var div=root$f();let classes;var node=child(div);{var consequent=__name2($$anchor2=>{var text$1=text();text$1.nodeValue=game.i18n.localize("PF2E.Item.Weapon.Reloader.EmptyMessage"),append($$anchor2,text$1)},"consequent");if_block(node,$$render=>{$$props.state.compatible.length===0&&$$render(consequent)})}var node_1=sibling(node,2);each(node_1,17,()=>$$props.state.compatible,index,($$anchor2,ammo)=>{var div_1=root_2$9();let classes_1;var button=child(div_1);set_attribute(button,"aria-label",game.i18n.localize("PF2E.Item.Weapon.Reloader.Reload1")),button.__click=[on_click$6,$$props,ammo];var node_2=sibling(button,2);{var consequent_1=__name2($$anchor3=>{var button_1=root_3$8();set_attribute(button_1,"aria-label",game.i18n.localize("PF2E.Item.Weapon.Reloader.ReloadAll")),button_1.__click=[on_click_1$5,$$props,ammo];var node_3=child(button_1);Heavy_bullets(node_3),append($$anchor3,button_1)},"consequent_1");if_block(node_2,$$render=>{$$props.state.loaded.max>1&&$$render(consequent_1)})}var img2=sibling(node_2,2),button_2=sibling(img2,2);button_2.__click=[on_click_2$3,openStates,ammo];var span=child(button_2),text_1=child(span),node_4=sibling(text_1);{var consequent_2=__name2($$anchor3=>{var i=root_4$4();append($$anchor3,i)},"consequent_2");if_block(node_4,$$render=>{get(ammo).isTemporary&&$$render(consequent_2)})}var node_5=sibling(node_4,2);{var consequent_3=__name2($$anchor3=>{var span_1=root_5$5(),span_2=child(span_1),node_6=child(span_2);Heavy_bullets(node_6);var text_2=sibling(span_2);template_effect(()=>set_text(text_2,` ${get(ammo).uses.value??""}`)),append($$anchor3,span_1)},"consequent_3");if_block(node_5,$$render=>{get(ammo).uses&&$$render(consequent_3)})}var span_3=sibling(node_5,2),text_3=child(span_3),node_7=sibling(span,2);{var consequent_4=__name2($$anchor3=>{Item_traits($$anchor3,{get traits(){return get(ammo).traits},get rarity(){return get(ammo).rarity}})},"consequent_4");if_block(node_7,$$render=>{get(ammo).traits.length&&$$render(consequent_4)})}var node_8=sibling(button_2,2);{let $0=user_derived(()=>!!openStates[get(ammo).uuid]);Item_summary(node_8,{get uuid(){return get(ammo).uuid},get open(){return get($0)},exclude:["traits"]})}template_effect($0=>{classes_1=set_class(div_1,1,"choice svelte-152e5ll",null,classes_1,$0),set_attribute(img2,"src",get(ammo).img),set_attribute(button_2,"data-rarity",get(ammo).rarity),set_text(text_1,`${get(ammo).name??""} `),set_text(text_3,`x${get(ammo).quantity??""}`)},[()=>({depleted:get(ammo).depleted})]),append($$anchor2,div_1)}),template_effect($0=>classes=set_class(div,1,"choices svelte-152e5ll",null,classes,$0),[()=>({empty:$$props.state.compatible.length===0})]),append($$anchor,div),pop()}__name(App$5,"App$5"),__name2(App$5,"App$5"),delegate(["click"]);class WeaponReloader extends SvelteApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"WeaponReloader")}static{__name2(this,"WeaponReloader")}static DEFAULT_OPTIONS={id:"reload-weapon",classes:["application","absolute","themed","theme-dark"],tag:"aside",position:{width:400,height:"auto"},window:{frame:!1}};root=App$5;#targetElement=null;#closeSignal=new AbortController;#interval=0;#closeListener=__name2(evt=>{evt instanceof KeyboardEvent&&evt.key==="Escape"?(evt.stopPropagation(),this.close()):evt instanceof MouseEvent&&evt.target instanceof HTMLElement&&evt.target.closest(".application")!==this.element&&this.close()},"#closeListener");get glyph(){const weapon=this.options.weapon,numActions=weapon.system.traits.value.includes("repeating")?3:Number(weapon.reload);return numActions>0&&Number.isInteger(numActions)?getActionGlyph(numActions):null}async activate(element){return this.#targetElement=element,await this.render({force:!0}),this}async _prepareContext(){const weapon=this.options.weapon,actor=weapon.actor,compatible=[...actor.itemTypes.ammo.filter(i=>!i.isStowed),...actor.itemTypes.weapon.filter(w=>w.system.usage.canBeAmmo)].filter(a=>a.isAmmoFor(weapon)),loaded=getLoadedAmmo(weapon);return{foundryApp:this,state:{loaded:{value:loaded.length,max:weapon.system.ammo?.capacity??1},weapon:getBasePhysicalItemViewData(weapon),compatible:t(compatible.map(c=>({...getBasePhysicalItemViewData(c),quantity:c.quantity,uses:c.isOfType("ammo")&&c.uses.max>1?c.uses:null,depleted:c.quantity===0||c.isOfType("ammo")&&c.uses.value===0})),c=>c.depleted?1:0)}}}async _onRender(context,options){await super._onRender(context,options),this.#reposition()}async reloadWeapon(ammoId,all=!1){const weapon=this.options.weapon,ammo=weapon.actor.inventory.get(ammoId,{strict:!0}),capacity=weapon.system.ammo?.capacity??0,loaded=getLoadedAmmo(weapon).filter(a=>!(a.isOfType("ammo")&&a.isMagazine&&a.system.uses.value===0)),numLoaded=t$1(loaded,l=>l.quantity),remainingSpace=Math.max(0,capacity-numLoaded),quantity=all?Math.min(remainingSpace,ammo.quantity):1;remainingSpace>0&&(await weapon.attach(ammo,{quantity,stack:!0}),await this.#sendMessage(ammo));const weaponAmmo=weapon.system.ammo;weaponAmmo?.capacity&&numLoaded+quantity>=weaponAmmo.capacity&&await this.close()}async#sendMessage(ammo){const weapon=this.options.weapon,actor=weapon.actor;if(!game.combat||!actor)return;const templates={flavor:"./systems/pf2e/templates/chat/action/flavor.hbs",content:"./systems/pf2e/templates/chat/action/content.hbs"},actionKey="Interact",annotationKey="Reload",flavorAction={title:`PF2E.Actions.${actionKey}.Title`,subtitle:`PF2E.Actions.${actionKey}.${annotationKey}.Title`,glyph:this.glyph},traits=[traitSlugToObject("manipulate",CONFIG.PF2E.actionTraits)],message=`PF2E.Actions.${actionKey}.${annotationKey}.Description`,flavor=await foundry.applications.handlebars.renderTemplate(templates.flavor,{action:flavorAction,traits}),content=await foundry.applications.handlebars.renderTemplate(templates.content,{imgPath:weapon.img,message:game.i18n.format(message,{actor:actor.name,weapon:weapon.name,ammo:ammo.name})}),token=actor.getActiveTokens(!1,!0).shift();await ChatMessagePF2e.create({content,speaker:ChatMessagePF2e.getSpeaker({actor,token}),flavor,style:CONST.CHAT_MESSAGE_STYLES.EMOTE})}#reposition(){const anchorId=this.#targetElement?.dataset.anchorId;if(this.#targetElement=anchorId?document.querySelector(`[data-anchor-id="${anchorId}"]`):null,this.#targetElement&&this.element.parentElement){const bounds=this.#targetElement.getBoundingClientRect(),pad=foundry.helpers.interaction.TooltipManager.TOOLTIP_MARGIN_PX;this.setPosition({left:bounds.left,top:bounds.bottom+pad})}}async _onFirstRender(context,options){await super._onFirstRender(context,options),this.options.weapon.actor.apps[this.id]=this;const signal=this.#closeSignal.signal;document.addEventListener("click",this.#closeListener,{capture:!0,signal}),document.addEventListener("wheel",this.#closeListener,{capture:!0,signal}),document.addEventListener("keydown",this.#closeListener,{signal}),this.#interval=window.setInterval(()=>this.#reposition(),200)}_onClose(options){try{delete this.options.weapon.actor.apps[this.id],super._onClose(options)}finally{this.#closeSignal.abort(),clearInterval(this.#interval)}}}async function craft(options){const item=options.item??await(options.uuid?fromUuid(options.uuid):SelectItemDialog.getItem("craft"));if(item instanceof ItemPF2e){if(!(item instanceof PhysicalItemPF2e)){ui.notifications.warn(game.i18n.format("PF2E.Actions.Craft.Warning.NotPhysicalItem",{item:item.name??""}));return}}else{console.warn("PF2e System | No item selected to craft: aborting");return}const quantity=options.quantity??1,pwol=game.pf2e.settings.variants.pwol.enabled,dc=options.difficultyClass??{value:calculateDC(item.level,{pwol}),visible:!0},free=!!options.free,slug=options?.skill??"crafting",rollOptions=["action:craft"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.Craft.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["downtime","manipulate"],event:options.event,difficultyClass:dc,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Craft","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Craft","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Craft","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.Craft","criticalFailure")],"extraNotes"),createMessage:!1,callback:__name2(async result=>{if(result.message instanceof ChatMessagePF2e){const message=result.message,flavor=await(async()=>["criticalSuccess","success","criticalFailure"].includes(result.outcome??"")?await renderCraftingInline(item,result.roll,quantity,result.actor,free,slug):"")();flavor&&message.updateSource({flavor:message.flavor+flavor}),ChatMessage.create(message.toObject())}else console.error("PF2E | Unable to amend chat message with craft result.",result.message);options.callback?.(result)},"callback")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(craft,"craft"),__name2(craft,"craft");const appv1$e=foundry.appv1;class SpellcastingCreateAndEditDialog extends appv1$e.api.FormApplication{static{__name(this,"SpellcastingCreateAndEditDialog")}static{__name2(this,"SpellcastingCreateAndEditDialog")}constructor(object,options){super(object.clone({},{keepId:!0}),options)}static get defaultOptions(){return{...super.defaultOptions,id:"spellcasting-dialog",template:"systems/pf2e/templates/actors/spellcasting-dialog.hbs",title:"PF2E.SpellcastingSettings.Title",width:350,height:"auto",closeOnSubmit:!1,submitOnChange:!0}}async getData(){const actor=this.object.actor,extraStatistics=actor.synthetics.statistics.values(),classDCs=actor.isOfType("character")?Object.values(actor.system.proficiencies.classDCs).filter(cdc=>cdc.rank>0):[],selectedStatistic=actor.getStatistic(this.object.system.proficiency.slug);return{...await super.getData(),actor,system:this.object.toObject().system,statistics:[...extraStatistics,...classDCs.map(c=>({slug:c.slug,label:game.i18n.format("PF2E.Actor.Character.ClassDC.LabelSpecific",{class:c.label})}))],magicTraditions:CONFIG.PF2E.magicTraditions,spellcastingTypes:n$1(CONFIG.PF2E.preparationType,["ritual",actor.type==="character"?"items":null].filter(e$1)),attributes:CONFIG.PF2E.abilities,isAttributeConfigurable:this.#canSetAttribute(),selectedAttribute:selectedStatistic?.attribute??this.object.attribute,autoHeightenLevels:Object.fromEntries(t$c(1,11).map(level=>[level.toString(),game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ordinalString(level)})])),validItemTypes:{scroll:"PF2E.Actor.Creature.Spellcasting.ValidItemTypes.Scroll"}}}#canSetAttribute(){const slug=this.object._source.system.proficiency.slug,actor=this.object.actor,baseStat=actor.isOfType("character")?actor.getStatistic(slug):null;return!slug||!!baseStat&&!baseStat.attribute}async _updateObject(event2,formData){const wasInnate=this.object.isInnate,inputData=foundry.utils.expandObject(formData),system2=foundry.utils.mergeObject(inputData.system??{},{prepared:{value:this.object.system.prepared.value},ability:{value:"cha"}},{overwrite:!1});if(inputData.system=system2,system2.prepared.value==="innate"&&!wasInnate&&(system2.ability.value="cha"),system2.proficiency?.slug&&(system2.ability.value=""),system2?.autoHeightenLevel&&(system2.autoHeightenLevel.value||=null),this.object.updateSource(inputData),event2.type!=="submit"){this.render();return}return this.updateAndClose()}async updateAndClose(){const updateData=this.object.toObject();this.object.isPrepared||delete updateData.system.prepared.flexible;const actor=this.object.actor;if(this.object.id===null)updateData.name=(()=>{const locKey=CONFIG.PF2E.preparationType[updateData.system.prepared.value],preparationType=game.i18n.localize(locKey),magicTraditions2=CONFIG.PF2E.magicTraditions,traditionSpells=game.i18n.localize(magicTraditions2[this.object.tradition??""]);return traditionSpells?game.i18n.format("PF2E.SpellCastingFormat",{preparationType,traditionSpells}):preparationType})(),await actor.createEmbeddedDocuments("Item",[updateData]);else{const actualEntry=actor.spellcasting.get(this.object.id);if(!(actualEntry instanceof SpellcastingEntryPF2e))return;const system2=t$3(updateData.system,["prepared","tradition","ability","proficiency","autoHeightenLevel"]);await actualEntry.update({system:system2})}this.close()}}async function createSpellcastingDialog(object){const item="prototypeToken"in object?new SpellcastingEntryPF2e({name:"Untitled",type:"spellcastingEntry",system:{ability:{value:"cha"},spelldc:{value:0,dc:0},tradition:{value:"arcane"},prepared:{value:"innate"}}},{parent:object}):object;return new SpellcastingCreateAndEditDialog(item).render(!0)}__name(createSpellcastingDialog,"createSpellcastingDialog"),__name2(createSpellcastingDialog,"createSpellcastingDialog");class MystifiedTraits{static{__name(this,"MystifiedTraits")}static{__name2(this,"MystifiedTraits")}static mystifiedTraits=new Set;static compile(){this.mystifiedTraits=new Set(["artifact","extradimensional","invested","shadow",...Object.keys(CONFIG.PF2E.consumableTraits).filter(t2=>!["consumable","nonlethal"].includes(t2))].sort())}static has(trait){return this.mystifiedTraits.has(trait)}}const ITEM_CARRY_TYPES=Object.freeze(["attached","dropped","held","implanted","installed","stowed","worn"]),appv1$d=foundry.appv1;class CompendiumMigrationStatus extends appv1$d.api.Application{static{__name(this,"CompendiumMigrationStatus")}static{__name2(this,"CompendiumMigrationStatus")}compendium;static get defaultOptions(){const options=super.defaultOptions;return options.template="systems/pf2e/templates/system/compendium-migration-status.hbs",options.classes=["compendium-migration-status"],options.height="auto",options.title=game.i18n.localize("PF2E.CompendiumMigrationStatus.Title"),options}constructor(compendium){super(),this.compendium=compendium}get id(){return`compendium-info-${this.compendium.metadata.id}`}async getData(options){const index2=await this.compendium.getIndex({fields:[foundry.utils.randomID(),"system._migration","system.schema","data.schema"]}),schemaVersion=Math.min(...index2.map(d=>{const system2=d.system??d.data;return Number(system2?._migration?.version??system2?.schema?.version)})),foundryVersion=t$a(Object.entries(MigrationRunner.FOUNDRY_SCHEMA_VERSIONS),t(([_,schema])=>schema),t$d(([_,schema])=>schemaVersion>=schema))?.[0]??game.i18n.localize("PF2E.CompendiumMigrationStatus.FoundryOld");return{...await super.getData(options),compendium:this.compendium,schemaVersion:Number.isNaN(schemaVersion)?game.i18n.localize("PF2E.CompendiumMigrationStatus.Invalid"):schemaVersion,foundryVersion,module:game.modules.get(this.compendium.metadata.packageName??""),updated:schemaVersion>=MigrationRunner.LATEST_SCHEMA_VERSION,size:index2.contents.length}}activateListeners($html){super.activateListeners($html);const html2=$html[0];htmlQuery(html2,"[data-action=migrate]")?.addEventListener("click",async()=>{await new MigrationRunner(MigrationList.constructFromVersion(null)).runCompendiumMigration(this.compendium),this.render(!0)})}}class CompendiumDirectoryPF2e extends foundry.applications.sidebar.tabs.CompendiumDirectory{static{__name(this,"CompendiumDirectoryPF2e")}static{__name2(this,"CompendiumDirectoryPF2e")}static STOP_WORDS=new Set(["of","th","the"]);static#searchEngine=null;static DEFAULT_OPTIONS={actions:{openBrowser:CompendiumDirectoryPF2e.#onClickOpenBrowser,openSheet:CompendiumDirectoryPF2e.#onClickOpenSheet}};#matchDragDrop=new foundry.applications.ux.DragDrop({dragSelector:"li.match",permissions:{dragstart:this._canDragStart.bind(this),drop:this._canDragDrop.bind(this)},callbacks:{dragover:this._onDragOver.bind(this),dragstart:this._onDragStart.bind(this),drop:this._onDrop.bind(this)}});static PARTS={...super.PARTS,match:{template:"systems/pf2e/templates/sidebar/compendium-directory/search-result.hbs"}};get searchEngine(){if(!CompendiumDirectoryPF2e.#searchEngine){const wordSegmenter="Segmenter"in Intl?new Intl.Segmenter(game.i18n.lang,{granularity:"word"}):{segment(term){return[{segment:term}]}};CompendiumDirectoryPF2e.#searchEngine=new MiniSearch({fields:["name","originalName"],idField:"uuid",processTerm:__name2(term=>term.length<=1||CompendiumDirectoryPF2e.STOP_WORDS.has(term)?null:Array.from(wordSegmenter.segment(term)).map(t2=>foundry.applications.ux.SearchFilter.cleanQuery(t2.segment.toLocaleLowerCase(game.i18n.lang)).replace(/['"]/g,"")).filter(t2=>t2.length>1),"processTerm"),searchOptions:{combineWith:"AND",prefix:!0},storeFields:["uuid","img","name","type","documentType","packLabel"]})}return CompendiumDirectoryPF2e.#searchEngine}async _prepareContext(options){return{...await super._prepareContext(options),searchContents:game.user.settings.searchPackContents}}async _preparePartContext(partId,context,options){return partId==="footer"&&(context.buttons??=[]).push({type:"button",action:"openBrowser",icon:"fa-solid fa-magnifying-glass",label:"PF2E.CompendiumBrowser.Title"}),super._preparePartContext(partId,context,options)}async _onFirstRender(context,options){return this._createContextMenu(this.#getDocumentMatchContextEntries,"ol.document-matches > li"),super._onFirstRender(context,options)}#getDocumentMatchContextEntries(){return[{name:"COMPENDIUM.ImportEntry",icon:fontAwesomeIcon("download").outerHTML,condition:__name2(li=>{const uuid=li.dataset.uuid;if(!uuid)throw ErrorPF2e("Unexpected missing uuid");return game.packs.get(fromUuidSync(uuid)?.pack??"",{strict:!0}).documentClass.canUserCreate(game.user)},"condition"),callback:__name2(li=>{const uuid=li.dataset.uuid;if(!uuid)throw ErrorPF2e("Unexpected missing uuid");const packCollection=game.packs.get(fromUuidSync(uuid)?.pack??"",{strict:!0}),worldCollection=game.collections.get(packCollection.documentName,{strict:!0}),indexData=fromUuidSync(uuid)??{_id:""};if(!("_id"in indexData&&typeof indexData._id=="string"))throw ErrorPF2e("Unexpected missing document _id");return worldCollection.importFromCompendium(packCollection,indexData._id,{},{renderSheet:!0})},"callback")}]}_onRender(context,options){if(options.parts.includes("directory")){const matchesList=createHTMLElement("ol",{classes:["document-matches"]}),html2=this.element;html2.querySelector("ol.directory-list")?.append(matchesList),this.#matchDragDrop.bind(html2)}return super._onRender(context,options)}_getEntryContextOptions(){const options=super._getEntryContextOptions();return options.push({name:"COMPENDIUM.MigrationStatus",icon:fontAwesomeIcon("info").outerHTML,condition:__name2(li=>{const compendium=game.packs.get(li.dataset.pack,{strict:!0}),actorOrItem=compendium.documentClass===CONFIG.Actor.documentClass||compendium.documentClass===CONFIG.Item.documentClass,isSystemCompendium=compendium.metadata.packageType==="system";return game.user.isGM&&actorOrItem&&!isSystemCompendium},"condition"),callback:__name2(async li=>{const compendium=game.packs.get(li.dataset.pack,{strict:!0});new CompendiumMigrationStatus(compendium).render(!0)},"callback")}),options}_onSearchFilter(event2,query,rgx,listElem){super._onSearchFilter(event2,query,rgx,listElem);const html2=this.element,docMatches=query.length>0?this.searchEngine.search(query):[],filters=this.activeFilters,filteredMatches=filters.size>0?docMatches.filter(m=>filters.has(m.documentType)):docMatches,matchTemplate=htmlQuery(html2,".compendium-search-match");if(!matchTemplate)throw ErrorPF2e("Match template not found");const listElements=filteredMatches.map(match=>{const li=matchTemplate.content.firstElementChild?.cloneNode(!0);li.dataset.score=match.score.toString(),li.dataset.uuid=match.uuid;const thumbnail=li.querySelector("img");thumbnail&&(typeof match.img=="string"?thumbnail.src=game.pf2e.system.moduleArt.map.get(match.uuid)?.img??match.img:match.documentType==="JournalEntry"&&(thumbnail.src="icons/svg/book.svg"));const docAnchor=li.querySelector("a[data-action=openSheet]"),packAnchor=li.querySelector("a[data-action=activateEntry]"),systemType=["Actor","Item"].includes(match.documentType)?game.i18n.localize(`TYPES.${match.documentType}.${match.type}`):null;if(docAnchor&&packAnchor){docAnchor.innerText=match.name,packAnchor.append(systemType?`${systemType} (${match.packLabel})`:`(${match.packLabel})`);const collection=foundry.utils.parseUuid(match.uuid)?.collection;packAnchor.dataset.pack=collection?.metadata.id}return li}),matchesList=htmlQuery(html2,"ol.document-matches");matchesList&&(matchesList.replaceChildren(...listElements),this.#matchDragDrop.bind(matchesList))}_canDragStart(selector){return selector==="li.match"||super._canDragStart(selector)}_onDragStart(event2){if(!(event2.currentTarget instanceof HTMLElement))return super._onDragStart(event2);const uuid=event2.currentTarget.dataset.uuid;if(!uuid)return super._onDragStart(event2);const indexEntry=fromUuidSync(uuid);if(!indexEntry)throw ErrorPF2e("Unexpected error retrieving index data");const dragData=indexEntry instanceof foundry.abstract.Document?indexEntry.toDragData():{uuid,type:foundry.utils.parseUuid(uuid)?.type};event2.dataTransfer?.setData("text/plain",JSON.stringify(dragData))}compileSearchIndex(){console.debug("PF2e System | compiling search index");const packs=game.packs.filter(p=>p.index.size>0&&p.testUserPermission(game.user,"OBSERVER"));this.searchEngine.removeAll();for(const pack of packs){const contents=pack.index.map(i=>({...i,documentType:pack.metadata.type,packLabel:pack.metadata.label}));this.searchEngine.addAll(contents)}console.debug("PF2e System | Finished compiling search index")}static async#onClickOpenBrowser(){game.pf2e.compendiumBrowser.render({force:!0})}static async#onClickOpenSheet(_event,target){(await fromUuid(target.closest("li")?.dataset.uuid??""))?.sheet?.render(!0)}}function focusQuantityInput(event2){event2.currentTarget.querySelector("input")?.focus()}__name(focusQuantityInput,"focusQuantityInput"),__name2(focusQuantityInput,"focusQuantityInput");var on_click$5=__name2((e2,updateTradeQuantity,item)=>updateTradeQuantity(get(item),e2),"on_click$5"),on_input=__name2((e2,editQuantity,item)=>editQuantity(get(item),e2),"on_input"),on_click_1$4=__name2((e2,updateTradeQuantity,item)=>updateTradeQuantity(get(item),e2),"on_click_1$4"),root_1$a=from_html('<li><img class="svelte-pt88a0"/> <span class="name svelte-pt88a0"> </span> <span class="quantity flexrow svelte-pt88a0" role="button"><button type="button" class="icon fa-solid fa-left svelte-pt88a0" value="-1" tabindex="-1"></button> <button type="button" class="ratio plain svelte-pt88a0"> </button> <input type="number" hidden="" class="svelte-pt88a0"/> <button type="button" class="icon fa-solid fa-right svelte-pt88a0" value="1" tabindex="-1"></button></span></li>'),root_4$3=from_html('<i class="fa-solid fa-left svelte-pt88a0" inert></i> <span class="ratio svelte-pt88a0"> </span>',1),root_3$7=from_html('<li><img class="svelte-pt88a0"/> <span class="name svelte-pt88a0"> </span> <span class="quantity flexrow svelte-pt88a0"><!></span></li>'),root$e=from_html('<div class="content standard-form svelte-pt88a0" data-tooltip-class="pf2e"><section class="panel self flexcol svelte-pt88a0"><header class="flexrow svelte-pt88a0"><img class="svelte-pt88a0"/> <div class="name flexcol svelte-pt88a0"><span class="actor svelte-pt88a0"> </span> <span class="user svelte-pt88a0"> </span></div> <button type="button" data-tooltip=""><i></i></button></header> <div class="flexrow search"><input type="search" placeholder="\uF002" aria-label="Search" class="svelte-pt88a0"/></div> <ul class="flexcol scrollable svelte-pt88a0"></ul> <footer class="flexrow svelte-pt88a0"><p class="svelte-pt88a0"> </p></footer></section> <section class="panel trader flexcol svelte-pt88a0"><header class="flexrow svelte-pt88a0"><div data-tooltip=""><i></i></div> <div class="name flexcol svelte-pt88a0"><span class="actor svelte-pt88a0"> </span> <span class="user svelte-pt88a0"> </span></div> <img class="svelte-pt88a0"/></header> <ul class="scrollable svelte-pt88a0" tabindex="-1"></ul> <footer class="flexrow svelte-pt88a0"><p class="svelte-pt88a0"> </p></footer></section></div>');function App$4($$anchor,$$props){push($$props,!0);const{self,trader}=$$props.state,portraitAlt={self:$$props.localize("ImgAlt.Actor",{actor:self.actor.name,user:$$props.localize("You")}),trader:$$props.localize("ImgAlt.Actor",{actor:trader.actor.name,user:$$props.traderUser.name})},listFormatter=game.i18n.getListFormatter({style:"narrow"}),selfItems=user_derived(()=>self.items.filter(i=>i.matchScore>0).sort((a,b)=>b.matchScore-a.matchScore||a.name.localeCompare(b.name,game.i18n.lang))),withQuantity=__name2(i=>i.quantity>1?`${i.marked}x ${i.name}`:i.name,"withQuantity"),itemsToSend=user_derived(()=>{const list=listFormatter.format(get(selfItems).filter(i=>i.marked>0).map(i=>withQuantity(i)));return list.length>0?$$props.localize("Sending",{list}):""}),traderItems=user_derived(()=>trader.items.filter(i=>i.visible||i.marked).sort((a,b)=>+(b.marked>0)-+(a.marked>0)||a.name.localeCompare(b.name))),itemsToReceive=user_derived(()=>{const list=listFormatter.format(get(traderItems).filter(i=>i.marked>0).map(i=>withQuantity(i)));return list.length>0?$$props.localize("Receiving",{list}):""}),pendingQueries=new Set;async function sendQuery(data){await Promise.allSettled(pendingQueries);const promise=$$props.traderUser.query("pf2e.trade",data,{timeout:15e3});pendingQueries.add(promise),promise.then(data2=>{data2?.ok===!1&&$$props.foundryApp.abortTrade(data2.message)}).catch(()=>$$props.foundryApp.abortTrade($$props.localize("Error.Timeout",{user:$$props.traderUser.name,timeout:15}))).finally(()=>pendingQueries.delete(promise))}__name(sendQuery,"sendQuery"),__name2(sendQuery,"sendQuery");function toggleAccepted(){self.accepted=!self.accepted;const marked=Object.fromEntries(self.items.values().filter(i=>i.marked>0).map(i=>[i.id,i.marked]));self.accepted&&trader.accepted&&$$props.foundryApp.close({success:!0}),sendQuery({action:"update",marked,accepted:self.accepted})}__name(toggleAccepted,"toggleAccepted"),__name2(toggleAccepted,"toggleAccepted");function search(event2){if(!(event2.target instanceof HTMLInputElement))throw ErrorPF2e("Unexpected event received during search");const searchText=event2.target.value.trim(),results=new Map($$props.searchEngine.search(searchText).map(r2=>[r2.id,r2.score])),fallbackScore=results.size>0?0:1;for(const item of self.items)item.matchScore=results.get(item.id)??fallbackScore}__name(search,"search"),__name2(search,"search");function showQuantityInput(event2){const button=event2.currentTarget;button.hidden=!0;const input=button.nextElementSibling;input instanceof HTMLInputElement&&(input.hidden=!1,event2 instanceof FocusEvent&&input.focus())}__name(showQuantityInput,"showQuantityInput"),__name2(showQuantityInput,"showQuantityInput");function hideQuantityInput(event2){const input=event2.currentTarget;input.hidden=!0;const button=input.previousElementSibling;button instanceof HTMLButtonElement&&(button.hidden=!1)}__name(hideQuantityInput,"hideQuantityInput"),__name2(hideQuantityInput,"hideQuantityInput");function editQuantity(item,event2){const input=event2.target;if(!(input instanceof HTMLInputElement))return;const quantity=Math.clamp(Number(input.value)||0,0,item.quantity);if(quantity!==item.marked){item.marked=quantity;const queryData={action:"update",marked:Object.fromEntries(self.items.values().filter(i=>i.marked>0).map(i=>[i.id,i.marked]))};sendQuery(queryData)}}__name(editQuantity,"editQuantity"),__name2(editQuantity,"editQuantity");function updateTradeQuantity(item,event2){if(!$$props.traderUser.active){$$props.foundryApp.abortTrade($$props.localize("Error.LoggedOut",{user:$$props.traderUser.name}));return}const button=event2.currentTarget,ctrlKey=foundry.helpers.interaction.KeyboardManager.CONTROL_KEY_STRING==="Control"?"ctrlKey":"metaKey",multiplier=event2[ctrlKey]&&event2.shiftKey?50:event2.shiftKey?10:event2[ctrlKey]?5:1;item.marked=Math.clamp(item.marked+Number(button.value)*multiplier,0,item.quantity);const queryData={action:"update",marked:Object.fromEntries(self.items.values().filter(i=>i.marked>0).map(i=>[i.id,i.marked]))};sendQuery(queryData)}__name(updateTradeQuantity,"updateTradeQuantity"),__name2(updateTradeQuantity,"updateTradeQuantity");var div=root$e(),section=child(div),header=child(section),img2=child(header),div_1=sibling(img2,2),span=child(div_1),text$1=child(span),span_1=sibling(span,2),text_1=child(span_1),button_1=sibling(div_1,2);let classes;button_1.__click=toggleAccepted;var i_1=child(button_1),div_2=sibling(header,2),input_1=child(div_2);input_1.__input=search;var ul=sibling(div_2,2);each(ul,21,()=>get(selfItems),item=>item.id,($$anchor2,item)=>{var li=root_1$a();let classes_1;var img_1=child(li),span_2=sibling(img_1,2),text_2=child(span_2),span_3=sibling(span_2,2);span_3.__pointerup=[focusQuantityInput];var button_2=child(span_3);button_2.__click=[on_click$5,updateTradeQuantity,item];var button_3=sibling(button_2,2);button_3.__pointerdown=showQuantityInput;var text_3=child(button_3),input_2=sibling(button_3,2);input_2.__input=[on_input,editQuantity,item];var button_4=sibling(input_2,2);button_4.__click=[on_click_1$4,updateTradeQuantity,item],template_effect(($0,$1,$2,$3,$4)=>{classes_1=set_class(li,1,"flexrow svelte-pt88a0",null,classes_1,$0),set_attribute(img_1,"src",get(item).img),set_attribute(img_1,"alt",$1),set_text(text_2,get(item).name),set_attribute(button_2,"id",`${$$props.foundryApp.id??""}-${get(item).id??""}-decrement`),button_2.disabled=get(item).marked===0||trader.accepted,set_attribute(button_2,"aria-label",$2),set_attribute(button_3,"aria-label",$3),set_text(text_3,`${get(item).marked??""} / ${get(item).quantity??""}`),set_attribute(input_2,"id",`${$$props.foundryApp.id??""}-${get(item).id??""}-edit`),set_value(input_2,get(item).marked),set_attribute(button_4,"id",`${$$props.foundryApp.id??""}-${get(item).id??""}-increment`),button_4.disabled=get(item).marked===get(item).quantity||trader.accepted,set_attribute(button_4,"aria-label",$4)},[()=>({marked:get(item).marked}),()=>$$props.localize("ImgAlt.Item",{item:get(item).name}),()=>$$props.localize("Quantity.Decrement",{item:get(item).name}),()=>$$props.localize("Quantity.Label",{item:get(item).name}),()=>$$props.localize("Quantity.Increment",{item:get(item).name})]),event$1("focus",button_3,showQuantityInput),event$1("blur",input_2,hideQuantityInput),append($$anchor2,li)});var footer=sibling(ul,2),p=child(footer),text_4=child(p),section_1=sibling(section,2),header_1=child(section_1),div_3=child(header_1);let classes_2;var i_2=child(div_3),div_4=sibling(div_3,2),span_4=child(div_4),text_5=child(span_4),span_5=sibling(span_4,2),text_6=child(span_5),img_2=sibling(div_4,2),ul_1=sibling(header_1,2);each(ul_1,21,()=>get(traderItems),item=>item.id,($$anchor2,item)=>{var fragment=comment(),node=first_child(fragment);{var consequent_1=__name2($$anchor3=>{var li_1=root_3$7();let classes_3;var img_3=child(li_1),span_6=sibling(img_3,2),text_7=child(span_6),span_7=sibling(span_6,2),node_1=child(span_7);{var consequent=__name2($$anchor4=>{var fragment_1=root_4$3(),span_8=sibling(first_child(fragment_1),2),text_8=child(span_8);template_effect(()=>set_text(text_8,`${get(item).marked??""} / ${get(item).quantity??""}`)),append($$anchor4,fragment_1)},"consequent"),alternate=__name2($$anchor4=>{var text_9=text();template_effect(()=>set_text(text_9,get(item).quantity)),append($$anchor4,text_9)},"alternate");if_block(node_1,$$render=>{get(item).marked>0?$$render(consequent):$$render(alternate,!1)})}template_effect(($0,$1)=>{classes_3=set_class(li_1,1,"flexrow svelte-pt88a0",null,classes_3,$0),set_attribute(li_1,"data-item-id",get(item).id),set_attribute(img_3,"src",get(item).img),set_attribute(img_3,"alt",$1),set_text(text_7,get(item).name)},[()=>({marked:get(item).marked>0}),()=>$$props.localize("ImgAlt.Item",{item:get(item).name})]),append($$anchor3,li_1)},"consequent_1");if_block(node,$$render=>{get(item).visible&&$$render(consequent_1)})}append($$anchor2,fragment)});var footer_1=sibling(ul_1,2),p_1=child(footer_1),text_10=child(p_1);template_effect(($0,$1,$2,$3,$4)=>{set_attribute(img2,"src",self.actor.img),set_attribute(img2,"alt",portraitAlt.self),set_text(text$1,self.actor.name),set_text(text_1,`(${$0??""})`),set_attribute(button_1,"id",`${$$props.foundryApp.id??""}-self-accepted`),classes=set_class(button_1,1,"toggle-accepted svelte-pt88a0",null,classes,$1),set_attribute(button_1,"aria-label",$2),set_class(i_1,1,`fa-solid fa-${self.accepted?"check":"xmark"}`,"svelte-pt88a0"),set_attribute(input_1,"id",`${$$props.foundryApp.id??""}-search`),set_text(text_4,get(itemsToSend)),classes_2=set_class(div_3,1,"toggle-accepted svelte-pt88a0",null,classes_2,$3),set_attribute(div_3,"aria-label",$4),set_class(i_2,1,`fa-solid fa-${trader.accepted?"check accepted":"xmark"}`,"svelte-pt88a0"),set_text(text_5,trader.actor.name),set_text(text_6,`(${$$props.traderUser.name??""})`),set_attribute(img_2,"src",trader.actor.img),set_attribute(img_2,"alt",portraitAlt.trader),set_text(text_10,get(itemsToReceive))},[()=>$$props.localize("You"),()=>({accepted:self.accepted}),()=>self.accepted?$$props.localize("Acceptance.Rescind"):$$props.localize("Acceptance.Accept"),()=>({accepted:trader.accepted}),()=>$$props.localize(`Acceptance.${trader.accepted?"":"Not"}Accepted`,{user:$$props.traderUser.name})]),append($$anchor,div),pop()}__name(App$4,"App$4"),__name2(App$4,"App$4"),delegate(["click","input","pointerup","pointerdown"]);class TradeDialog extends SvelteApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"TradeDialog")}static{__name2(this,"TradeDialog")}constructor({self,trader,...options}){super(options);const initiator=!!self.initiator;this.#self={actor:self.actor,initiator,initialMarked:self.item?.id??null,gift:self.gift??0},this.#self.actor.apps[this.id]=this,this.#trader={user:trader.user,actor:trader.actor,items:trader.actor.inventory.map(i=>i.clone({},{keepId:!0})),initialMarked:trader.item?.id??null,gift:trader.gift??0},this.#trader.actor.apps[this.id]=this}static DEFAULT_OPTIONS={tag:"article",id:"trade-dialog",window:{icon:"fa-regular fa-money-bill-transfer"},position:{width:854}};static#userTrading=!1;static localize=localizer("PF2E.TradeDialog");root=App$4;#self;#trader;get title(){const trader=TradeDialog.#getObfuscatedActorName(this.#trader.actor);return game.i18n.format("PF2E.TradeDialog.Title",{trader})}static canTrade(args,{checkReach=!1}={}){if(TradeDialog.#userTrading)return!1;const{self,trader}=args,traderActor=trader.actor;if(!traderActor?.isOfType("creature")||!trader.user?.active||trader.user.isSelf||!self.actor?.isOwner||!self.actor.isOfType("character","npc")||!self.actor.testUserPermission(game.user,"OWNER")||self.actor.uuid===traderActor?.uuid||!self.actor.isOfType("character","npc")||!self.actor.isAllyOf(traderActor)&&traderActor.alliance!==null||self.gift&&!self.item||self.item&&(!self.item.isOfType("physical")||!self.actor.inventory.has(self.item.id)||self.item.quantity===0))return!1;if(!checkReach||!canvas.grid.isSquare)return!0;const traderTokens=traderActor.getActiveTokens(!0,!1),selfReach=self.actor.system.attributes.reach.manipulate,traderReach=traderActor.system.attributes.reach.manipulate;if(!self.actor.getActiveTokens(!0,!1).some(selfToken=>traderTokens.some(traderToken=>{const distance=selfToken.distanceTo(traderToken);return selfReach>=distance&&traderReach>=distance}))){const formatArgs={self:self.actor.name,trader:traderActor.name},message=TradeDialog.localize("Error.OutOfReach",formatArgs);return ui.notifications.error(message,{console:!1}),!1}return!0}static async requestTrade({self,trader}){TradeDialog.#userTrading=!0;const giftQuantity=self.gift&&self.item?(await ItemTransferDialog.wait({recipient:trader.actor,item:self.item,mode:"gift"}))?.quantity:0;if(self.gift&&!giftQuantity){TradeDialog.#userTrading=!1;return}const queryData={action:"request",initiator:{user:game.user.uuid,actor:self.actor.uuid,item:self.item?.id,gift:giftQuantity},target:{actor:trader.actor.uuid}},traderName=TradeDialog.#getObfuscatedActorName(trader.actor);ui.notifications.info(TradeDialog.localize("Request.Requesting",{trader:traderName}));try{const response=await trader.user.query("pf2e.trade",queryData,{timeout:3e4});if(!response)throw ErrorPF2e("No response from other side.");if(response.ok){const dialog=new TradeDialog({self:{...self,gift:giftQuantity,initiator:!0},trader});await(self.gift?dialog.close({success:!0}):dialog.render({force:!0}))}else ui.notifications.error(response.message,{console:!1}),TradeDialog.#userTrading=!1}catch{const message=TradeDialog.localize("Request.Timeout",{user:trader.user.name});ui.notifications.error(message,{console:!1}),TradeDialog.#userTrading=!1}}static#validateConstructorParams(data){const{self,trader}=data,error="Invalid trade construction data";if(!trader.user?.active||!trader.actor?.testUserPermission(trader.user,"OWNER"))throw ErrorPF2e(error);for(const side of[self,trader])if(side.actor?.inCompendium||!side.actor?.isOfType("character","npc")||side.gift&&(!side.item||side.gift<1)||side.item&&(!side.item.isOfType("physical")||side.item.actor?.uuid!==side.actor.uuid))throw ErrorPF2e(error)}static#getObfuscatedActorName(actor,user=game.user){return actor.testUserPermission(user,"LIMITED")?actor.name:actor.token?.name??actor.prototypeToken.name}#itemToData(item,marked){const selfActor=this.#self.actor,otherActor=this.#trader.actor;return{...t$3(item,["id","name","img","quantity"]),marked:Math.clamp(marked,0,item.quantity),matchScore:1,visible:item.actor===selfActor||game.user.isGM||otherActor.isAllyOf(selfActor)&&!item.isStowed}}async _prepareContext(options){const context=await super._prepareContext(options),self=this.#self,trader=this.#trader,selfItems=this.#prepareItems(self,this.$state.self?.items??[]),wordSegmenter="Segmenter"in Intl?new Intl.Segmenter(game.i18n.lang,{granularity:"word"}):{segment(term){return[{segment:term}]}},searchEngine=new MiniSearch({fields:["name","originalName"],idField:"id",processTerm:__name2(term=>term.length<2||CompendiumDirectoryPF2e.STOP_WORDS.has(term)?null:Array.from(wordSegmenter.segment(term)).map(t2=>foundry.applications.ux.SearchFilter.cleanQuery(t2.segment.toLocaleLowerCase(game.i18n.lang)).replace(/['"]/g,"")).filter(t2=>t2.length>=2),"processTerm"),searchOptions:{combineWith:"AND",prefix:!0},storeFields:["id","name"]});return searchEngine.addAll([...selfItems]),Object.assign(context,{state:{self:{actor:t$3(self.actor,["id","img","name"]),items:selfItems,accepted:!1},trader:{actor:{id:trader.actor.id,img:trader.actor.img,name:TradeDialog.#getObfuscatedActorName(trader.actor)},items:this.#prepareItems(trader,this.$state.trader?.items??[]),accepted:!1}},foundryApp:this,traderUser:trader.user,searchEngine,localize:TradeDialog.localize})}#prepareItems(trader,current){const initial=trader.initialMarked,data=trader.actor.inventory.filter(i=>i.quantity>0).map(item=>{const marked=current.find(i=>i.id===item.id)?.marked??(initial===item.id?item.quantity:0);return this.#itemToData(item,marked)});return trader===this.#self?data.sort((a,b)=>a.name.localeCompare(b.name,game.i18n.lang)):data.sort((a,b)=>b.marked-a.marked||a.name.localeCompare(b.name,game.i18n.lang)),data}async abortTrade(message){return message&&ui.notifications.error(message,{console:!1}),this.#trader.user.query("pf2e.trade",{action:"abort"}),this.close({aborted:!0})}async#transact(){const state2=this.$state,selfActor=this.#self.actor;if(!state2.trader.accepted)throw ErrorPF2e(`${this.#trader.user.name} hasn't accepted the trade`);const receivedQuantities=t$9(state2.trader.items.filter(i=>i.marked>0),i=>[i.id,i.marked]),toDelete2=state2.self.items.filter(i=>i.marked===i.quantity).map(i=>i.id);await selfActor.deleteEmbeddedDocuments("Item",toDelete2,{render:!1});const toReceive=this.#trader.items.filter(i=>!!receivedQuantities[i.id]).map(i=>i.clone({system:{container:null,quantity:receivedQuantities[i.id]},"_stats.duplicateSource":i.uuid}));await selfActor.inventory.add(toReceive,{stack:!0,render:!1});const toUpdate=state2.self.items.filter(i=>selfActor.inventory.has(i.id)&&i.marked>0&&i.marked<i.quantity).map(i=>{const quantity=Math.max(0,(selfActor.inventory.get(i.id)?.quantity??i.quantity)-i.marked);return{_id:i.id,"system.quantity":quantity}});await selfActor.updateEmbeddedDocuments("Item",toUpdate,{render:!1}),this.#trader.actor.render(),selfActor.render()}#setGiftData(){if(!this.#self.gift&&!this.#trader.gift)throw ErrorPF2e("Cannot perform gift transaction: nothing marked for gifting");const traderActor=this.#trader.actor;this.$state={self:{actor:t$3(this.#self.actor,["id","img","name"]),items:[this.#self.actor.inventory.get(this.#self.initialMarked??"")].filter(e$7).map(i=>this.#itemToData(i,this.#self.gift)),accepted:!0},trader:{actor:{id:traderActor.id,img:traderActor.img,name:TradeDialog.#getObfuscatedActorName(traderActor)},items:[traderActor.inventory.get(this.#trader.initialMarked??"")].filter(e$7).map(i=>this.#itemToData(i,this.#trader.gift)),accepted:!0}}}#notifySuccess(itemsExchanged){const self=this.#self,selfName=self.actor.name,trader=this.#trader,traderName=TradeDialog.#getObfuscatedActorName(trader.actor);if(self.gift)ui.notifications.success(TradeDialog.localize("Gift.Accepted",{trader:traderName}));else if(trader.gift)ui.notifications.success(TradeDialog.localize("Gift.Received",{self:selfName,trader:traderName}));else if(itemsExchanged){const message=TradeDialog.localize("Success.Finished",{self:selfName,trader:traderName});ui.notifications.success(message)}else ui.notifications.info(TradeDialog.localize("Success.NoItems"))}async#postMessage(itemsExchanged){const self=this.#self,trader=this.#trader;if(!self.initiator||!itemsExchanged||!self.actor.combatant?.combat.started)return;const receivedItems=!self.gift&&this.$state.trader.items.some(i=>i.marked),mutualExchange=receivedItems&&!trader.gift&&this.$state.self.items.some(i=>i.marked),annotationKey=mutualExchange?"ExchangeItems":"GiveItem",flavorData={action:{title:"PF2E.Actions.Interact.Title",subtitle:`PF2E.Actions.Interact.${annotationKey}.Title`,glyph:mutualExchange?2:1},traits:[traitSlugToObject("manipulate",CONFIG.PF2E.actionTraits)]},templates={flavor:"systems/pf2e/templates/chat/action/flavor.hbs",content:"systems/pf2e/templates/chat/action/content.hbs"},itemExchanged=mutualExchange?null:receivedItems?trader.actor.inventory.get(this.$state.trader.items.find(i=>i.marked)?.id??""):self.actor.inventory.get(this.$state.self.items.find(i=>i.marked)?.id??""),flavor=await foundry.applications.handlebars.renderTemplate(templates.flavor,flavorData),speakerActor=receivedItems&&!mutualExchange?trader.actor:self.actor,speaker=ChatMessagePF2e.getSpeaker({actor:speakerActor,token:speakerActor.token??speakerActor.getActiveTokens(!0,!0)[0]}),other=speakerActor===self.actor?trader.actor:self.actor,content=await foundry.applications.handlebars.renderTemplate(templates.content,{imgPath:itemExchanged?.img??"systems/pf2e/icons/actions/interact/trade.webp",message:game.i18n.format(`PF2E.Actions.Interact.${annotationKey}.Description`,{actor:speaker.alias,other:TradeDialog.#getObfuscatedActorName(other),item:itemExchanged?.name??game.i18n.localize("PF2E.Actions.Interact.GiveItem.AnItem")})});await ChatMessagePF2e.create({speaker,flavor,content,style:CONST.CHAT_MESSAGE_STYLES.EMOTE,author:speakerActor===self.actor?game.user.id:this.#trader.user.id})}async close(options={}){if(options.success){(this.#self.gift||this.#trader.gift)&&this.#setGiftData();const itemsExchanged=this.$state.self.items.some(i=>i.marked)||this.$state.trader.items.some(i=>i.marked);this.#notifySuccess(itemsExchanged),await this.#postMessage(itemsExchanged),this.#transact()}else if(!options.aborted){const trader=this.#trader,message=TradeDialog.localize("Aborted",{user:trader.user.name});trader.user.query("pf2e.trade",{action:"abort",message})}return TradeDialog.#userTrading=!1,delete this.#self.actor.apps[this.id],delete this.#trader.actor.apps[this.id],super.close(options)}static handleQuery=__name2(async data=>{switch(data.action){case"request":return TradeDialog.#userTrading?{ok:!1,message:TradeDialog.localize("Error.Engaged",{user:game.user.name})}:TradeDialog.#onRequest(data);case"update":{const dialog=foundry.applications.instances.get("trade-dialog");return dialog instanceof TradeDialog?dialog.#onUpdate(data):{ok:!1,message:TradeDialog.localize("Error.NotTrading",{user:game.user.name})}}case"abort":return TradeDialog.#onAbort(data);default:throw ErrorPF2e("Unrecognized trade query action")}},"handleQuery");static async#onRequest(data){const otherActor=fromUuidSync(data.initiator.actor),args={self:{actor:fromUuidSync(data.target.actor)},trader:{user:fromUuidSync(data.initiator.user),actor:otherActor,item:otherActor?.inventory.get(data.initiator.item??"")??null,gift:data.initiator.gift??0}};TradeDialog.#validateConstructorParams(args),TradeDialog.#userTrading=!0;const dialog=new TradeDialog(args),initiatorName=TradeDialog.#getObfuscatedActorName(args.trader.actor);if(args.trader.item&&args.trader.gift){const{user,item,gift:quantity}=args.trader,title2=TradeDialog.localize("Gift.Prompt.Title",{trader:initiatorName}),ok2=await foundry.applications.api.DialogV2.confirm({window:{icon:"fa-solid fa-gift",title:title2},content:TradeDialog.localize("Gift.Prompt.Content",{trader:initiatorName,user:user.name,item:item.name,quantity,self:args.self.actor.name}),yes:{default:!0}});if(ok2)return dialog.close({success:!0}),{ok:ok2};dialog.close({aborted:!0});const selfName2=TradeDialog.#getObfuscatedActorName(args.self.actor,args.trader.user);return{ok:ok2,message:TradeDialog.localize("Gift.Declined",{trader:selfName2,user:user.name})}}const windowIcon=TradeDialog.DEFAULT_OPTIONS.window.icon,title=TradeDialog.localize("Request.Prompt.Title",{trader:initiatorName}),ok=await foundry.applications.api.DialogV2.confirm({window:{icon:windowIcon,title},content:TradeDialog.localize("Request.Prompt.Content",{trader:initiatorName,user:args.trader.user.name,self:args.self.actor.name}),yes:{default:!0}});if(ok)return await dialog.render({force:!0}),{ok};const selfName=TradeDialog.#getObfuscatedActorName(args.self.actor,args.trader.user),message=TradeDialog.localize("Request.Declined",{trader:selfName,user:game.user.name});return dialog.close({aborted:!0}),{ok,message}}async#onUpdate(data){const trader=this.$state.trader;if(typeof data.accepted=="boolean"&&(trader.accepted=data.accepted),data.marked)for(let i=0;i<trader.items.length;i++){const itemData=trader.items[i],itemId=itemData.id;itemData.marked=data.marked[itemId]??0}return data.accepted&&this.$state.self.accepted&&this.close({success:!0}),{ok:!0}}static async#onAbort(data){const dialog=foundry.applications.instances.get("trade-dialog");return dialog instanceof TradeDialog?(data.message&&ui.notifications.warn(data.message),await dialog.close({aborted:!0}),{ok:!0}):{ok:!1,message:TradeDialog.localize("Error.NotTrading",{user:game.user.name})}}}const appv1$c=foundry.appv1;class SpellPreparationSheet extends appv1$c.sheets.ActorSheet{static{__name(this,"SpellPreparationSheet")}static{__name2(this,"SpellPreparationSheet")}itemRenderer=new ItemSummaryRenderer(this);item;#searchEngine=new MiniSearch({fields:["name"],idField:"id",processTerm:__name2(t2=>t2.length>1?t2.toLocaleLowerCase(game.i18n.lang):null,"processTerm"),searchOptions:{combineWith:"AND",prefix:!0}});constructor(item,options){super(item.actor,options),this.item=item}static get defaultOptions(){return{...super.defaultOptions,classes:["default","sheet","spellcasting-entry","preparation"],width:480,height:600,template:"systems/pf2e/templates/actors/spell-preparation-sheet.hbs",scrollY:[".sheet-content"],dragDrop:[{dragSelector:"li[data-item-id]"}],filters:[{inputSelector:"input[type=search]",contentSelector:"ol.spell-list"}],sheetConfig:!1}}get id(){return`${super.id}-spellprep-${this.item.id}`}get title(){return game.i18n.format("PF2E.Actor.Creature.SpellPreparation.Title",{actor:this.actor.name})}_getHeaderButtons(){return super._getHeaderButtons().filter(b=>b.class==="close")}async getData(){this.#searchEngine.removeAll();const entry=await this.item.getSheetData({prepList:!0}),spells=Object.values(entry.prepList??{}).flat().map(s=>t$3(s.spell,["id","name"]));return this.#searchEngine.addAll(spells),{...await super.getData(),owner:this.actor.isOwner,maxRank:this.item.highestRank,entry}}activateListeners($html){super.activateListeners($html),$html[0].addEventListener("click",event2=>{const anchor=htmlClosest(event2.target,"[data-action]"),action2=anchor?.dataset.action;if(anchor&&action2)switch(action2){case"edit-spell":{this.#getSpellFromEvent(event2).sheet.render(!0);return}case"delete-spell":{this.#getSpellFromEvent(event2).delete();return}case"spell-to-chat":{this.#getSpellFromEvent(event2).toMessage(event2);return}case"toggle-flexible-collection":{const spell=this.#getSpellFromEvent(event2);spell.update({"system.location.signature":!spell.system.location.signature});return}case"toggle-summary":{const element=htmlClosest(anchor,"[data-item-id]");element&&this.itemRenderer.toggleSummary(element);return}case"create-spell":{onClickCreateSpell(this.actor,{...anchor?.dataset,location:this.item.id});return}case"browse-spells":{const maxRank=Number(anchor.dataset.rank)||10,category=anchor.dataset.category??null;game.pf2e.compendiumBrowser.openSpellTab(this.item,maxRank,category)}}})}#getSpellFromEvent(event2){const itemId=htmlClosest(event2.target,"li[data-item-id]")?.dataset.itemId,item=this.actor.items.get(itemId,{strict:!0});if(!item.isOfType("spell"))throw ErrorPF2e("Unexpected item type");return item}_onSearchFilter(_event,query,_rgx,html2){const matches=query.length>1?new Set(this.#searchEngine.search(query).map(s=>s.id)):new Set;for(const row of htmlQueryAll(html2,"li[data-item-id]"))row.hidden=query.length>1&&!matches.has(row.dataset.itemId??"")}async _onDropItemCreate(itemSource){const spellSources=(Array.isArray(itemSource)?itemSource:[itemSource]).filter(source2=>source2.type==="spell");for(const spellSource of spellSources)spellSource.system.location.value=this.item.id;return super._onDropItemCreate(spellSources)}async _onSortItem(event2,itemData){if(itemData.type!=="spell")return[];const spell=this.actor.items.get(itemData._id);return itemData.system.location.value!==this.item.id&&spell?.isOfType("spell")?[await this.item.spells?.addSpell(spell)??[]].flat():super._onSortItem(event2,itemData)}async _renderInner(data,options){return this.itemRenderer.saveAndRestoreState(()=>super._renderInner(data,options))}}class CreatureSheetPF2e extends ActorSheetPF2e{static{__name(this,"CreatureSheetPF2e")}static{__name2(this,"CreatureSheetPF2e")}async getData(options){const sheetData=await super.getData(options),actor=this.actor,unavailableLanguages=game.settings.get("pf2e","homebrew.languageRarities").unavailable,languages=actor.isOfType("character")?[]:actor.system.details.languages.value.filter(l=>l in CONFIG.PF2E.languages&&!unavailableLanguages.has(l)).map(slug=>({slug,label:game.i18n.localize(CONFIG.PF2E.languages[slug]??slug)})).sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang));sheetData.data.perception.senses=t(sheetData.data.perception.senses,a=>a.label??"");const initiativeOptions=[{value:"perception",label:"PF2E.PerceptionLabel"}];return initiativeOptions.push(...Object.values(this.actor.skills).map(s=>({value:s.slug,label:s.label}))),{...sheetData,languages,actorSizes:CONFIG.PF2E.actorSizes,rarity:CONFIG.PF2E.rarityTraits,frequencies:CONFIG.PF2E.frequencies,pfsFactions:CONFIG.PF2E.pfsFactions,initiativeOptions,dying:{maxed:actor.attributes.dying.value>=actor.attributes.dying.max,remainingDying:Math.max(actor.attributes.dying.max-actor.attributes.dying.value),remainingWounded:Math.max(actor.attributes.wounded.max-actor.attributes.wounded.value)},specialResources:Object.values(this.actor.synthetics.resources).map(r2=>t$3(r2,["slug","label","value","max"]))}}#openSpellPreparation(collectionId,event2){const entry=this.actor.items.get(collectionId,{strict:!0});if(entry?.isOfType("spellcastingEntry")&&entry.isPrepared){const referenceEl=htmlClosest(event2?.target,"[data-action=open-spell-preparation]"),offset=referenceEl?$(referenceEl).offset()??{left:0,top:0}:null,options=offset?{top:offset.top-60,left:offset.left+200}:{};new SpellPreparationSheet(entry,options).render(!0)}}async prepareSpellcasting(){return(await Promise.all(this.actor.spellcasting.collections.map(spells=>spells.entry.getSheetData({spells})))).sort((a,b)=>a.sort-b.sort)}getProficiencyIcon(level){return[...Array(level)].map(()=>fontAwesomeIcon("check-circle").outerHTML).join("")}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const pips of htmlQueryAll(html2,"a[data-action=adjust-condition-value]")){const slug=pips.dataset.condition==="dying"?"dying":"wounded";pips.addEventListener("click",()=>{const currentMax=this.actor.system.attributes[slug]?.max;return this.actor.increaseCondition(slug,{max:currentMax})}),pips.addEventListener("contextmenu",()=>this.actor.decreaseCondition(slug))}const resourcePips=htmlQueryAll(html2,"[data-action=adjust-resource]:not(input)");if(resourcePips.length>0){const listener=__name2(event2=>{const resourceSlug=htmlClosest(event2.target,"[data-resource]")?.dataset.resource??"",resource=this.actor.getResource(resourceSlug);if(resource){const current=resource.value,change=event2.type==="click"?1:-1;this.actor.updateResource(resourceSlug,current+change)}},"listener");for(const pips of resourcePips)pips.addEventListener("click",listener),pips.addEventListener("contextmenu",listener)}const resourceInputs=htmlQueryAll(html2,"input[data-resource]");for(const element of resourceInputs){const resourceSlug=element.dataset.resource??"",resource=this.actor.getResource(resourceSlug);resource&&element.addEventListener("change",()=>{const rawValue=element.value.trim(),newValue=rawValue.startsWith("+")||rawValue.startsWith("-")?resource.value+Number(rawValue):Number(rawValue);Number.isNaN(newValue)?element.value=String(resource.value):this.actor.updateResource(resourceSlug,newValue)})}}activateClickListener(html2){const handlers=super.activateClickListener(html2),actor=this.actor;return handlers["perception-check"]=(event2,anchor)=>{const extraRollOptions=anchor.dataset.secret?["secret"]:[];return actor.perception.roll({...eventToRollParams(event2,{type:"check"}),extraRollOptions})},handlers["draw-item"]=event2=>{const itemId=htmlClosest(event2.target,"[data-item-id")?.dataset.itemId,item=actor.inventory.get(itemId,{strict:!0});return actor.changeCarryType(item,{carryType:"held",handsHeld:1})},handlers["recovery-check"]=event2=>actor.rollRecovery(event2),handlers["consume-item"]=event2=>{const itemId=htmlClosest(event2.target,"[data-item-id]")?.dataset.itemId,item=actor.inventory.get(itemId,{strict:!0});return item.isOfType("consumable")&&item.consume()},handlers["open-carry-type-menu"]=(_,anchor)=>this.#openCarryTypeMenu(anchor),handlers["cast-spell"]=event2=>{const spellRow=htmlClosest(event2.target,"[data-item-id]"),{itemId,entryId,slotId}=spellRow?.dataset??{},collection=actor.spellcasting.collections.get(entryId,{strict:!0}),spell=collection.get(itemId,{strict:!0}),maybeCastRank=Number(spellRow?.dataset.castRank)||NaN;if(Number.isInteger(maybeCastRank)&&maybeCastRank.between(1,10)){const rank=maybeCastRank;return spell.parentItem?.consume()??collection.entry.cast(spell,{rank,slotId:Number(slotId)})}},handlers["browse-spells"]=(_,anchor)=>{this.#onClickBrowseSpells(anchor)},handlers["open-spell-preparation"]=event2=>{const collectionId=htmlClosest(event2.target,"[data-container-id]")?.dataset.containerId;if(!collectionId)throw ErrorPF2e("Unexpected failure looking up spell collection");this.#openSpellPreparation(collectionId,event2)},handlers["unprepare-spell"]=event2=>{const row=htmlClosest(event2.target,"[data-item-id]"),groupId=coerceToSpellGroupId(row?.dataset.groupId);if(!groupId)throw ErrorPF2e("Unexpected slot group ID");const slotIndex=Number(row?.dataset.slotId)||0,entryId=row?.dataset.entryId;return actor.spellcasting.collections.get(entryId,{strict:!0}).prepareSpell(null,groupId,slotIndex)},handlers["toggle-slot-expended"]=event2=>{const row=htmlClosest(event2.target,"[data-item-id]"),groupId=coerceToSpellGroupId(row?.dataset.groupId);if(!groupId)throw ErrorPF2e("Unexpected error toggling expended state");const slotId=Number(row?.dataset.slotId)||0,entryId=row?.dataset.entryId??"",expend=row?.dataset.slotExpended===void 0;return actor.spellcasting.collections.get(entryId)?.setSlotExpendedState(groupId,slotId,expend)},handlers["toggle-signature-spell"]=event2=>{const itemId=htmlClosest(event2.target,"[data-item-id]")?.dataset.itemId,spell=actor.items.get(itemId,{strict:!0});if(spell?.isOfType("spell"))return spell.update({"system.location.signature":!spell.system.location.signature})},handlers["toggle-show-slotless-ranks"]=event2=>{const collectionId=htmlClosest(event2.target,"[data-container-id]")?.dataset.containerId,spellcastingEntry=actor.items.get(collectionId,{strict:!0});if(!spellcastingEntry.isOfType("spellcastingEntry"))throw ErrorPF2e("Tried to toggle visibility of slotless ranks on a non-spellcasting entry");return spellcastingEntry.update({"system.showSlotlessLevels.value":!spellcastingEntry.showSlotlessRanks})},handlers["reset-spell-slots"]=event2=>{const row=htmlClosest(event2.target,"[data-item-id]"),itemId=row?.dataset.itemId,item=actor.items.get(itemId,{strict:!0});if(item.isOfType("spellcastingEntry")){const{system:system2}=item.toObject();if(!system2.slots)return;const groupNumber=spellSlotGroupIdToNumber(row?.dataset.groupId)||0,propertyKey=goesToEleven(groupNumber)?`slot${groupNumber}`:"slot0";return system2.slots[propertyKey].value=system2.slots[propertyKey].max,item.update({system:system2})}else if(item.isOfType("spell")){const max=item.system.location.uses?.max;return max?item.update({"system.location.uses.value":max}):void 0}},handlers["spellcasting-create"]=()=>createSpellcastingDialog(actor),handlers["spellcasting-edit"]=event2=>{const containerId=htmlClosest(event2.target,"[data-item-id]")?.dataset.itemId,entry=actor.items.get(containerId,{strict:!0});if(entry.isOfType("spellcastingEntry"))return createSpellcastingDialog(entry)},handlers["spellcasting-remove"]=async event2=>{const itemId=htmlClosest(event2.target,"[data-item-id]")?.dataset.itemId,item=actor.items.get(itemId,{strict:!0}),content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/delete-spellcasting-dialog.hbs");if(await foundry.applications.api.DialogV2.confirm({window:{title:"PF2E.DeleteSpellcastEntryTitle",icon:"fa-solid fa-trash"},content}))return item.delete()},handlers}async#openCarryTypeMenu(anchor){!!document.body.querySelector("aside.locked-tooltip.carry-type-menu")&&game.tooltip.dismissLockedTooltips();const itemId=htmlClosest(anchor,"[data-item-id]")?.dataset.itemId,item=this.actor.inventory.get(itemId,{strict:!0}),hasStowingContainers=this.actor.itemTypes.backpack.some(i=>i.system.stowing&&!i.isInContainer),templatePath="systems/pf2e/templates/actors/partials/carry-type.hbs",templateArgs={item,hasStowingContainers},template=await foundry.applications.handlebars.renderTemplate(templatePath,templateArgs),html2=createHTMLElement("ul",{innerHTML:template});html2.addEventListener("click",event2=>{const menuOption=htmlClosest(event2.target,"a[data-carry-type]");if(!menuOption)return;const carryType=menuOption.dataset.carryType;if(!tupleHasValue(ITEM_CARRY_TYPES,carryType))throw ErrorPF2e("Unexpected error retrieving requested carry type");const handsHeld=Number(menuOption.dataset.handsHeld)||0;if(!tupleHasValue([0,1,2],handsHeld))throw ErrorPF2e("Invalid number of hands specified");const inSlot="inSlot"in menuOption.dataset,current=item.system.equipped;(carryType!==current.carryType||inSlot!==current.inSlot||carryType==="held"&&handsHeld!==current.handsHeld)&&(this.actor.changeCarryType(item,{carryType,handsHeld,inSlot}),game.tooltip.dismissLockedTooltips())}),game.tooltip.activate(anchor,{cssClass:"pf2e carry-type-menu",html:html2,locked:!0})}async _onDropItem(event2,data){const actor=this.actor,spellFrom=data.spellFrom;if(spellFrom){const{collectionId,groupId,slotIndex}=spellFrom,collection=actor.spellcasting.collections.get(spellFrom.collectionId,{strict:!0}),isPrepared=collection.entry.category==="prepared",collectionEl=htmlClosest(event2.target,"[data-container-id]"),sameCollectionId=collectionId===collectionEl?.dataset.containerId,targetDataset=htmlClosest(event2.target,"[data-item-id]")?.dataset??{},sameGroupId=groupId===targetDataset.groupId,targetIsEmpty=targetDataset.itemId?.length!==16;if(isPrepared&&sameCollectionId&&sameGroupId&&!targetIsEmpty){const draggedSpell=await ItemPF2e.fromDropData(data),dropTargetSpell=actor.items.get(targetDataset.itemId??"");if(!draggedSpell?.isOfType("spell")||!dropTargetSpell?.isOfType("spell"))throw ErrorPF2e("Unexpected data received while swapping spells");return collection.swapSlotPositions(groupId,slotIndex,Number(targetDataset.slotId)),[draggedSpell]}}return await this.#attemptTrade(data,event2)?[]:super._onDropItem(event2,data)}async#attemptTrade(data,event2){if(game.user.isGM)return!1;const traderActor=this.actor;if(traderActor.isLootableBy(game.user))return!1;const item=await ItemPF2e.fromDropData(data),selfActor=item?.actor;if(!item?.isOfType("physical")||!selfActor?.isOfType("creature"))return!1;const traderUser=game.users.filter(u=>u.active&&!u.isSelf&&traderActor.testUserPermission(u,"OWNER")).sort((a,b)=>Number(a.isGM)-Number(b.isGM))[0],args={self:{actor:selfActor,item,gift:event2.shiftKey},trader:{user:traderUser,actor:traderActor}};if(!TradeDialog.canTrade(args))return!1;if(game.pf2e.settings.automation.reachEnforcement.has("merchants")){const traderTokens=traderActor.getActiveTokens(!0,!1),selfReach=selfActor.system.attributes.reach.manipulate,traderReach=traderActor.system.attributes.reach.manipulate;if(!selfActor.getActiveTokens(!0,!1).some(selfToken=>traderTokens.some(traderToken=>{const distance=selfToken.distanceTo(traderToken);return selfReach>=distance&&traderReach>=distance})))return!0}return TradeDialog.requestTrade(args),!0}async _onSortItem(event2,itemData){const dropItemEl=htmlClosest(event2.target,"[data-item-id]"),dropContainerEl=htmlClosest(event2.target,"[data-container-id]"),dropSlotType=dropItemEl?.dataset.itemType,dropContainerType=dropContainerEl?.dataset.containerType,item=this.actor.items.get(itemData._id);if(!item)return[];if(item.isOfType("spell")){if(!(dropItemEl&&dropContainerEl))return[];const entryId=dropContainerEl.dataset.containerId,collection=this.actor.spellcasting.collections.get(entryId,{strict:!0}),groupId=coerceToSpellGroupId(dropItemEl.dataset.groupId),slotId=Number(dropItemEl.dataset.slotId);if(dropSlotType==="spell-slot-group"){const spell=await collection.addSpell(item,{groupId});return this.#openSpellPreparation(collection.id),[spell??[]].flat()}else{if(groupId&&Number.isInteger(slotId))return await collection.prepareSpell(item,groupId,slotId),[item];if(dropSlotType==="spell"){const dropId=dropItemEl.dataset.itemId??"",target=this.actor.items.get(dropId);if(target?.isOfType("spell")&&item.id!==dropId){const sourceLocation=item.system.location.value,testSibling=__name2((item2,test)=>item2.isCantrip!==test.isCantrip?!1:!!(item2.isCantrip&&test.isCantrip||item2.isFocusSpell&&test.isFocusSpell||item2.rank===test.rank),"testSibling");if(sourceLocation===entryId&&testSibling(item,target)){const siblings=collection.filter(s=>testSibling(item,s));return await item.sortRelative({target,siblings}),[target]}else{const spell=await collection.addSpell(item,{groupId:target.rank});return this.#openSpellPreparation(collection.id),[spell??[]].flat()}}}else if(dropContainerType==="spellcastingEntry"){CONFIG.debug.hooks&&console.debug("PF2e System | ***** spell from same actor dropped on a spellcasting entry *****");const dropId=htmlClosest(event2.target,"li[data-container-id]")?.dataset.containerId,updated=dropId?await item.update({"system.location.value":dropId}):null;return updated?[updated]:[]}}}else if(item.isOfType("spellcastingEntry")&&dropContainerType==="spellcastingEntry"){const sourceId=item.id,dropId=dropContainerEl?.dataset.containerId??"",source2=this.actor.items.get(sourceId),target=this.actor.items.get(dropId);if(source2?.isOfType("spellcastingEntry")&&target?.isOfType("spellcastingEntry")&&source2.id!==target.id){const siblings=this.actor.itemTypes.spellcastingEntry;return await source2.sortRelative({target,siblings}),[source2]}}return super._onSortItem(event2,itemData)}async _handleDroppedItem(event2,item,data){const containerEl=htmlClosest(event2.target,"[data-container-type=spellcastingEntry]");if(containerEl&&item.isOfType("spell")&&!item.isRitual){const collectionId=containerEl.dataset.containerId,collection=this.actor.spellcasting.collections.get(collectionId,{strict:!0});this.#openSpellPreparation(collection.id,event2);const groupId=coerceToSpellGroupId(htmlClosest(event2.target,"[data-group-id]")?.dataset.groupId);return[await collection.addSpell(item,{groupId})??[]].flat()}return super._handleDroppedItem(event2,item,data)}_getHeaderButtons(){const buttons=super._getHeaderButtons();if(!this.actor.isOfType("character","npc"))return buttons;if(this.isEditable){const index2=buttons.findIndex(b=>b.class==="close");buttons.splice(index2,0,{label:"Configure",class:"configure-creature",icon:"fa-solid fa-user-gear",onclick:__name2(()=>this.#onConfigureActor(),"onclick")})}return buttons}#onConfigureActor(){this.actorConfigClass&&new this.actorConfigClass(this.actor).render(!0)}#onClickBrowseSpells(anchor){const spellcastingIndex=htmlClosest(anchor,"[data-container-id]")?.dataset.containerId??"",entry=this.actor.spellcasting.get(spellcastingIndex);if(!entry)return;const maxRank=Number(anchor.dataset.rank)||10,category=anchor.dataset.category??null;game.pf2e.compendiumBrowser.openSpellTab(entry,maxRank,category)}async _updateObject(event2,formData){const heldShield=this.actor.heldShield;return heldShield&&typeof formData["system.attributes.shield.hp.value"]=="number"&&await heldShield.update({"system.hp.value":formData["system.attributes.shield.hp.value"]}),delete formData["system.attributes.shield.hp.value"],super._updateObject(event2,formData)}}async function add(actor){const message=game.i18n.localize("PF2E.AddCombatProficiency.Message"),weaponGroups2=CONFIG.PF2E.weaponGroups,baseWeapons=CONFIG.PF2E.baseWeaponTypes,template=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/add-combat-proficiency-dialog.hbs",{message,weaponGroups:weaponGroups2,baseWeapons});new foundry.appv1.api.Dialog({title:game.i18n.localize("PF2E.AddCombatProficiency.Title"),content:template,buttons:{add:{icon:fontAwesomeIcon("check").outerHTML,label:game.i18n.localize("PF2E.AddShortLabel"),callback:__name2(async $dialog=>{const dialog2=$dialog[0],selection=htmlQuery(dialog2,"select[name=proficiency]")?.value;if(selection){const proficiencyKey=selection in weaponGroups2?`weapon-group-${selection}`:`weapon-base-${selection}`;await actor.addAttackProficiency(proficiencyKey)}},"callback")},cancel:{icon:fontAwesomeIcon("times").outerHTML,label:game.i18n.localize("Cancel")}},default:"cancel"}).render(!0)}__name(add,"add"),__name2(add,"add");function remove(actor,event2){const weaponGroups2=CONFIG.PF2E.weaponGroups,baseWeapons=CONFIG.PF2E.baseWeaponTypes,baseShields=CONFIG.PF2E.baseShieldTypes,key=htmlClosest(event2.target,"[data-slug]")?.dataset.slug??"",translationKey=key?.replace(/^weapon-(?:base|group)-/,"")??"",name2=objectHasKey(weaponGroups2,translationKey)?game.i18n.localize(weaponGroups2[translationKey]):baseWeapons[translationKey]??baseShields[translationKey]??translationKey,localize=localizer("PF2E.RemoveCombatProficiency"),message=localize("Message",{proficiency:name2});foundry.applications.api.DialogV2.confirm({window:{title:localize("Title")},content:`<p>${message}</p>`,yes:{callback:__name2(()=>{key in(actor._source.system.proficiencies?.attacks??{})&&actor.update({[`system.proficiencies.attacks.-=${key}`]:null})},"callback"),default:!1}})}__name(remove,"remove"),__name2(remove,"remove");const ManageAttackProficiencies={add,remove},viewItemSheet=__name2(async event2=>{const uuid=event2.currentTarget.closest("li")?.dataset?.uuid??"";(await fromUuid(uuid))?.sheet.render(!0)},"viewItemSheet"),saveSelection=__name2(async(event2,$$props)=>{const uuid=event2.currentTarget.closest("li")?.dataset?.uuid??"",item=await fromUuid(uuid);if(!(item instanceof Item)||item.type!==$$props.state.itemType)throw ErrorPF2e(`Unexpected error retrieving ${$$props.state.itemType}`);$$props.actor.createEmbeddedDocuments("Item",[{...item.toObject(),_id:null}]),$$props.foundryApp.close()},"saveSelection");var root_2$8=from_html('<div class="tags paizo-style svelte-xk23fq"><span> </span></div>'),root_1$9=from_html('<li><img loading="lazy" alt="Class icon" class="svelte-xk23fq"/> <div class="name svelte-xk23fq"> </div> <!> <div> </div> <div class="buttons svelte-xk23fq"><button type="button" class="confirm icon fa-solid fa-check svelte-xk23fq" data-tooltip=""></button> <button type="button" class="icon fa-solid fa-memo-pad" data-tooltip=""></button></div></li>'),root$d=from_html('<search class="svelte-xk23fq"><i class="fa-solid fa-search"></i> <input type="search" spellcheck="false" class="svelte-xk23fq"/></search> <menu class="scrollable svelte-xk23fq"></menu>',1);function App$3($$anchor,$$props){push($$props,!0);let searchQuery=state("");const filteredItems=user_derived(()=>{const query=get(searchQuery).trim();if(!query.length)return $$props.state.items;const regexp=new RegExp(RegExp.escape(query),"i");return $$props.state.items.filter(item=>{if(get(searchQuery).length===0)return!0;const name2=item.name,originalName=item.originalName;return regexp.test(name2)||originalName&&regexp.test(originalName)})}),typePlural=game.i18n.localize(`PF2E.Item.${$$props.state.itemType.capitalize()}.Plural`),searchPlaceholder=game.i18n.format("PF2E.Actor.Character.ABCPicker.SearchPlaceholder",{items:typePlural});var fragment=root$d(),search=first_child(fragment),input=sibling(child(search),2),menu=sibling(search,2);each(menu,21,()=>get(filteredItems),index,($$anchor2,item)=>{var li=root_1$9();let classes;var img2=child(li),div=sibling(img2,2),text2=child(div),node=sibling(div,2);{var consequent=__name2($$anchor3=>{var div_1=root_2$8(),span=child(div_1),text_1=child(span);template_effect(()=>{set_class(span,1,`tag rarity ${get(item).rarity.slug??""}`,"svelte-xk23fq"),set_text(text_1,get(item).rarity.label)}),append($$anchor3,div_1)},"consequent");if_block(node,$$render=>{get(item).rarity&&$$render(consequent)})}var div_2=sibling(node,2);let classes_1;var text_2=child(div_2),div_3=sibling(div_2,2),button=child(div_3);set_attribute(button,"aria-label",game.i18n.localize("PF2E.Actor.Character.ABCPicker.Tooltip.ConfirmSelection")),button.__click=[saveSelection,$$props];var button_1=sibling(button,2);set_attribute(button_1,"aria-label",game.i18n.localize("PF2E.Actor.Character.ABCPicker.Tooltip.ViewSheet")),button_1.__click=[viewItemSheet],template_effect(($0,$1)=>{set_attribute(li,"data-uuid",get(item).uuid),set_attribute(li,"data-original-name",get(item).originalName||null),classes=set_class(li,1,"svelte-xk23fq",null,classes,$0),set_attribute(img2,"src",get(item).img),set_text(text2,get(item).name),classes_1=set_class(div_2,1,"source svelte-xk23fq",null,classes_1,$1),set_text(text_2,get(item).source.name)},[()=>({"no-rarity":!get(item).rarity}),()=>({publication:get(item).source.publication})]),append($$anchor2,li)}),template_effect(()=>set_attribute(input,"placeholder",searchPlaceholder)),bind_value(input,()=>get(searchQuery),$$value=>set(searchQuery,$$value)),append($$anchor,fragment),pop()}__name(App$3,"App$3"),__name2(App$3,"App$3"),delegate(["click"]);class ABCPicker extends SvelteApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"ABCPicker")}static{__name2(this,"ABCPicker")}static DEFAULT_OPTIONS={id:"{id}",classes:["abc-picker"],position:{width:350,height:650},window:{contentClasses:["standard-form","compact"]}};root=App$3;get title(){const type2=game.i18n.localize(`TYPES.Item.${this.options.itemType}`);return game.i18n.format("PF2E.Actor.Character.ABCPicker.Title",{type:type2})}_initializeApplicationOptions(options){const initialized=super._initializeApplicationOptions(options);return initialized.window.icon=CONFIG.Item.typeIcons[initialized.itemType],initialized.uniqueId=`abc-picker-${initialized.itemType}-${initialized.actor.uuid}`,initialized}async#gatherItems(){const{actor,itemType}=this.options,worldItems=game.items.filter(i=>i.type===itemType&&i.testUserPermission(game.user,"LIMITED")),packItems=await UUIDUtils.fromUUIDs(game.packs.filter(p=>p.documentName==="Item"&&p.testUserPermission(game.user,"LIMITED")).flatMap(p=>p.index.filter(e2=>e2.type===itemType).map(e2=>e2.uuid))),items=[...worldItems,...packItems].filter(item=>{if(item.type!==itemType||item.parent||item.pack?.startsWith("pf2e-animal-companions.")||item.system.traits.value?.includes("eidolon"))return!1;if(item.isOfType("heritage")){const ancestrySlug=actor.ancestry?actor.ancestry.slug??sluggify(actor.ancestry.name):null;return item.system.ancestry?.slug===ancestrySlug||item.system.ancestry===null}return!0}).sort((a,b)=>a.name.localeCompare(b.name)).sort((a,b)=>RARITIES.indexOf(a.rarity??"common")-RARITIES.indexOf(b.rarity??"common"));items.every(i=>i.isOfType("heritage"))&&items.sort((a,b)=>a.isVersatile===b.isVersatile?0:a.isVersatile?1:-1);const resolveSource=__name2(item=>{const publication=item.system.publication.title.trim();if(publication)return{name:publication,publication:!0};if(item.uuid.startsWith("Item."))return{name:game.world.title,publication:!1};const compendiumPack=game.packs.get(item.pack??"");return{name:game.modules.get(compendiumPack?.metadata.packageName??"")?.title??compendiumPack?.title??"???",publication:!1}},"resolveSource"),rarities={uncommon:game.i18n.localize(CONFIG.PF2E.rarityTraits.uncommon),rare:game.i18n.localize(CONFIG.PF2E.rarityTraits.rare),unique:game.i18n.localize(CONFIG.PF2E.rarityTraits.unique)};return items.map(item=>{const ref={...t$3(item,["name","img","uuid"]),source:resolveSource(item),hidden:!1};return"rarity"in item&&item.rarity!=="common"&&(ref.rarity={slug:item.rarity,label:rarities[item.rarity]}),typeof item.flags.babele?.originalName=="string"&&(ref.originalName=item.flags.babele.originalName),ref})}async _prepareContext(){const itemType=this.options.itemType;return{actor:this.options.actor,foundryApp:this,state:{prompt:game.i18n.localize(`PF2E.Actor.Character.ABCPicker.Prompt.${itemType}`),itemType,items:await this.#gatherItems()}}}}const appv1$b=foundry.appv1;class AttributeBuilder extends appv1$b.api.Application{static{__name(this,"AttributeBuilder")}static{__name2(this,"AttributeBuilder")}actor;#abpEnabled;constructor(actor){super(),this.actor=actor,this.#abpEnabled=game.pf2e.variantRules.AutomaticBonusProgression.isEnabled(actor),actor.apps[this.appId]=this}static get defaultOptions(){return{...super.defaultOptions,classes:["attribute-builder"],title:game.i18n.localize("PF2E.Actor.Character.Attribute.Boosts"),template:"systems/pf2e/templates/actors/character/attribute-builder.hbs",width:"auto",height:"auto"}}get id(){return`attribute-builder-${this.actor.uuid}`}async getData(options={}){const{actor}=this,build=actor.system.build.attributes;return{...await super.getData(options),actor,attributes:CONFIG.PF2E.abilities,manual:build.manual,ancestry:actor.ancestry,background:actor.background,class:actor.class,attributeModifiers:t$5(actor.abilities,(value,attribute)=>{const mod=build.manual?actor._source.system.abilities?.[attribute].mod??0:value.base;return{mod:Number(mod.toFixed(1)).signedString(),label:CONFIG.PF2E.abilities[attribute]}}),manualKeyAttribute:actor.keyAttribute,keyOptions:build.keyOptions,...this.#calculateAncestryBoosts(),backgroundBoosts:this.#calculateBackgroundBoosts(),legacyFlaws:actor.ancestry?.system.voluntary?.boost!==void 0,levelBoosts:this.#calculateLeveledBoosts()}}#createButtons(){return Array.from(ATTRIBUTE_ABBREVIATIONS).reduce((accumulated,attribute)=>(accumulated[attribute]={ability:attribute},accumulated),{})}#calculateAncestryBoosts(){const{actor}=this,ancestry=actor.ancestry;if(!ancestry)return{ancestryBoosts:null,voluntaryFlaws:null};const buttons=this.#createButtons(),[maxBoosts,selectedBoosts]=(()=>{const alternateAncestryBoosts=ancestry.system.alternateAncestryBoosts;if(alternateAncestryBoosts)return[2,alternateAncestryBoosts];const baseBoosts=Object.values(ancestry.system.boosts),selectedBoosts2=baseBoosts.map(b=>b.selected).filter(b=>!!b);return[baseBoosts.filter(b=>b.value.length>0||b.selected).length,selectedBoosts2]})(),build=actor.system.build.attributes,netBoosted=r(build.boosts.ancestry,build.flaws.ancestry),remaining=maxBoosts-selectedBoosts.length,lockedBoosts=ancestry.system.alternateAncestryBoosts?null:ancestry.lockedBoosts,lockedFlaws=ancestry.system.alternateAncestryBoosts?null:ancestry.lockedFlaws;for(const attribute of ATTRIBUTE_ABBREVIATIONS){const state2=buttons[attribute],selected=selectedBoosts.includes(attribute);state2.boost={selected,locked:lockedBoosts?.includes(attribute),disabled:selected?!1:!remaining||netBoosted.includes(attribute)},lockedFlaws?.includes(attribute)&&(state2.flaw={selected:!0,locked:!0})}const voluntaryFlaws=(()=>{const voluntary=ancestry.system.voluntary??{flaws:[]},legacyFlaws=voluntary.boost!==void 0,flawsComplete=legacyFlaws&&voluntary.flaws.length>=2,buttons2=this.#createButtons();for(const attribute of ATTRIBUTE_ABBREVIATIONS){const state2=buttons2[attribute],numFlaws=voluntary.flaws.filter(f=>f===attribute).length;if(state2.flaw={selected:numFlaws>0,disabled:!numFlaws&&flawsComplete},legacyFlaws){lockedBoosts?.includes(attribute)&&(state2.flaw.second={selected:numFlaws>1,disabled:!numFlaws||numFlaws<2&&flawsComplete});const boosted=voluntary.boost===attribute;state2.boost={selected:boosted,disabled:boosted?!1:!flawsComplete||!!voluntary.boost||netBoosted.includes(attribute)}}}return{remaining:voluntary&&legacyFlaws&&!voluntary.boost?1:0,buttons:buttons2,voluntaryBoostsRemaining:0,labels:this.#getBoostFlawLabels(ancestry.system.flaws)}})();return{ancestryBoosts:{buttons,remaining,labels:this.#getBoostFlawLabels(ancestry.system.boosts),flawLabels:this.#getBoostFlawLabels(ancestry.system.flaws),alternate:!!ancestry.system.alternateAncestryBoosts},voluntaryFlaws}}#calculateBackgroundBoosts(){const{actor}=this;if(!actor.background)return null;const buttons=this.#createButtons(),boosts=Object.values(actor.background.system.boosts).filter(b=>b.value.length>0),selectedBoosts=boosts.map(b=>b.selected).filter(b=>!!b),unselectedRestricted=boosts.filter(b=>b.value.length<6&&!b.selected).flatMap(b=>b.value),remaining=boosts.length-selectedBoosts.length;for(const attribute of ATTRIBUTE_ABBREVIATIONS){const selected=selectedBoosts.includes(attribute),mightBeForced=unselectedRestricted.includes(attribute);buttons[attribute].boost={selected,disabled:!(selected||remaining)||unselectedRestricted.length>0&&!mightBeForced}}const labels=this.#getBoostFlawLabels(actor.background.system.boosts),tooltip=(()=>{const boosts2=actor.background?.system.boosts??{};if(Object.values(boosts2).length===2&&Object.values(boosts2)[0].value.length===2&&Object.values(boosts2)[1].value.length===6){const choices=Object.values(boosts2)[0].value.map(b=>game.i18n.localize(CONFIG.PF2E.abilities[b]));return game.i18n.format("PF2E.Actor.Character.AttributeBuilder.BackgroundBoostDescription",{a:choices[0],b:choices[1]})}else return null})();return{buttons,remaining,labels,tooltip}}#calculateLeveledBoosts(){const build=this.actor.system.build.attributes,isGradual=game.settings.get("pf2e","gradualBoostsVariant"),boostIsPartial=__name2((attribute,level,isApex)=>{if(level<5||build.manual||isApex)return!1;const boosts=[build.boosts.ancestry.find(a=>a===attribute),build.boosts.background.find(a=>a===attribute),build.boosts.class===attribute?attribute:null,build.boosts[1].find(a=>a===attribute),level===20?build.boosts[20].find(a=>a===attribute):null,level>=15?build.boosts[15].find(a=>a===attribute):null,level>=10?build.boosts[10].find(a=>a===attribute):null,level>=5?build.boosts[5].find(a=>a===attribute):null].filter(e$1).length,flaws=Number(build.flaws.ancestry.some(a=>a===attribute)),netBoosts=boosts-flaws,cssClasses={0:!1,1:!0};return netBoosts>=5?cssClasses[netBoosts%2]:!1},"boostIsPartial");return[1,5,10,15,17,20].flatMap(level=>{const isApex=level===17;if(isApex&&!this.#abpEnabled)return[];const remaining=isApex?+!build.apex:build.allowedBoosts[level]-build.boosts[level].length,buttons=this.#createButtons();for(const attribute of ATTRIBUTE_ABBREVIATIONS){const selected=isApex?build.apex===attribute:build.boosts[level].includes(attribute),partial=selected&&boostIsPartial(attribute,level,isApex);buttons[attribute].boost={selected,partial,disabled:!remaining}}const eligible=isApex?this.actor.level>=17:build.allowedBoosts[level]>0,minLevel=isGradual&&!isApex?Math.max(1,level-3):level;return{buttons,remaining,level,eligible,minLevel,isApex}})}#getBoostFlawLabels(boostData){return Object.values(boostData).flatMap(boosts=>boosts.value.length===6?game.i18n.localize("PF2E.AbilityFree"):boosts.value.length>0?boosts.value.map(b=>game.i18n.localize(CONFIG.PF2E.abilities[b])).join(" or "):[])}async _render(force,options){return maintainFocusInRender(this,()=>super._render(force,options))}async close(options={}){return delete this.actor.apps[this.appId],super.close(options)}activateListeners($html){super.activateListeners($html);const html2=$html[0],actor=this.actor;for(const contentEl of htmlQueryAll(html2,"[data-tooltip-content]"))createTooltipster(contentEl,{contentAsHTML:!0,arrow:!1,debug:!1,interactive:!0,maxWidth:350,side:["bottom"],theme:"crb-hover"});for(const input of htmlQueryAll(html2,"input[type=text], input[type=number]"))input.addEventListener("focus",()=>{input.type==="text"&&input.dataset.dtype==="Number"&&(input.value=input.value.replace(/[^-.0-9]/g,""),input.type="number"),input.select()}),input.addEventListener("blur",()=>{if(input.type==="number"&&input.dataset.dtype==="Number"){input.type="text";const newValue=Math.clamp(Number(input.value)||0,-5,10);input.value=signedInteger(newValue);const propertyPath=input.dataset.property;if(!propertyPath)throw ErrorPF2e("Empty property path");actor.update({[propertyPath]:newValue})}});htmlQuery(html2,"[data-action=toggle-alternate-ancestry-boosts]")?.addEventListener("click",()=>{actor.ancestry&&(actor.ancestry.system.alternateAncestryBoosts?actor.ancestry.update({"system.-=alternateAncestryBoosts":null}):actor.ancestry.update({"system.alternateAncestryBoosts":[]}))}),htmlQuery(html2,"[data-action=toggle-legacy-voluntary-flaw]")?.addEventListener("click",async()=>{const ancestry=actor.ancestry;if(!ancestry)return;const voluntary=ancestry.system.voluntary;if(voluntary?.boost!==void 0){const flaws=n(voluntary.flaws);ancestry.update({system:{voluntary:{"-=boost":null,flaws}}})}else{const flaws=voluntary?.flaws.slice(0,2)??[];ancestry.update({system:{voluntary:{boost:null,flaws}}})}});for(const button of htmlQueryAll(html2,"[data-section=ancestry] .boost"))button.addEventListener("click",async()=>{const ancestry=actor.ancestry,attribute=button.dataset.attribute;if(!ancestry||!setHasElement(ATTRIBUTE_ABBREVIATIONS,attribute))return;if(ancestry.system.alternateAncestryBoosts){const existingBoosts=ancestry.system.alternateAncestryBoosts,boosts=existingBoosts.includes(attribute)?existingBoosts.filter(b=>b!==attribute):[...existingBoosts,attribute].slice(0,2);ancestry.update({"system.alternateAncestryBoosts":boosts});return}const boostToRemove=Object.entries(ancestry.system.boosts??{}).find(([,b])=>b.selected===attribute);if(boostToRemove){await ancestry.update({[`system.boosts.${boostToRemove[0]}.selected`]:null});return}const freeBoost=Object.entries(ancestry.system.boosts??{}).find(([,b])=>!b.selected&&b.value.length>0);freeBoost&&await ancestry.update({[`system.boosts.${freeBoost[0]}.selected`]:attribute})});for(const button of htmlQueryAll(html2,"[data-section=voluntary] .boost-button"))button.addEventListener("click",()=>{const ancestry=actor.ancestry,attribute=button.dataset.attribute;if(!ancestry||!setHasElement(ATTRIBUTE_ABBREVIATIONS,attribute))return;const removing=button.classList.contains("selected");if(button.dataset.action==="flaw"){const{flaws,boost}=ancestry.system.voluntary??{flaws:[]},alreadyHasFlaw=flaws.includes(attribute),isLegacy=boost!==void 0;if(removing&&alreadyHasFlaw&&!boost){flaws.splice(flaws.indexOf(attribute),1),ancestry.update({system:{voluntary:{flaws}}});return}const canDoubleFlaw=ancestry.lockedBoosts.includes(attribute)&&isLegacy,maxFlaws=isLegacy?2:6;flaws.length<maxFlaws&&(!alreadyHasFlaw||canDoubleFlaw)&&(flaws.push(attribute),ancestry.update({system:{voluntary:{flaws}}}))}else{const boost=removing?null:attribute;ancestry.update({system:{voluntary:{boost}}})}});for(const button of htmlQueryAll(html2,"[data-section=background] .boost"))button.addEventListener("click",()=>{const attribute=button.dataset.attribute;if(!setHasElement(ATTRIBUTE_ABBREVIATIONS,attribute))return;const boostToRemove=Object.entries(actor.background?.system.boosts??{}).find(([,b])=>b.selected===attribute);if(boostToRemove){actor.background?.update({[`system.boosts.${boostToRemove[0]}.selected`]:null});return}const freeBoost=Object.entries(actor.background?.system.boosts??{}).find(([,b])=>!b.selected&&b.value.length>0);freeBoost&&actor.background?.update({[`system.boosts.${freeBoost[0]}.selected`]:attribute})});for(const button of htmlQueryAll(html2,"button[data-action=class-key-attribute]"))button.addEventListener("click",()=>{const attribute=button.dataset.attribute;if(!setHasElement(ATTRIBUTE_ABBREVIATIONS,attribute))throw ErrorPF2e(`Unrecognized attribute abbreviation: ${attribute}`);actor.system.build.attributes.manual?actor.update({"system.details.keyability.value":attribute}):actor.class?.update({"system.keyAbility.selected":attribute})});for(const button of htmlQueryAll(html2,"[data-level] .boost"))button.addEventListener("click",()=>{const level=Number(htmlClosest(button,"[data-level]")?.dataset.level),attribute=button.dataset.attribute;if(!setHasElement(ATTRIBUTE_ABBREVIATIONS,attribute)||!tupleHasValue([1,5,10,15,20],level))return;const buildSource=foundry.utils.mergeObject(actor.toObject().system.build??{},{attributes:{boosts:{}}}),boosts=buildSource.attributes.boosts[level]??=[];boosts.includes(attribute)?boosts.splice(boosts.indexOf(attribute),1):boosts.push(attribute),actor.update({"system.build":buildSource})});for(const button of htmlQueryAll(html2,"button[data-action=apex]"))button.addEventListener("click",()=>{const attribute=button.dataset.attribute;if(!setHasElement(ATTRIBUTE_ABBREVIATIONS,attribute))throw ErrorPF2e(`Unrecognized attribute abbreviation: ${attribute}`);const current=this.actor.system.build.attributes.apex;actor.update({"system.build.attributes.apex":this.#abpEnabled&&attribute!==current?attribute:null})});htmlQuery(html2,"input[name=toggle-manual-mode]")?.addEventListener("click",()=>{this.#toggleAttributeManagement()}),htmlQuery(html2,"button[data-action=close]")?.addEventListener("click",()=>this.close())}async#toggleAttributeManagement(){const{actor}=this;if(Object.keys(actor._source.system.abilities??{}).length===0){const baseAbilities=Array.from(ATTRIBUTE_ABBREVIATIONS).reduce((accumulated,abbrev)=>({...accumulated,[abbrev]:{value:10}}),{});await actor.update({"system.abilities":baseAbilities})}else await actor.update({"system.abilities":null})}}const appv1$a=foundry.appv1;class CreatureConfig extends appv1$a.api.DocumentSheet{static{__name(this,"CreatureConfig")}static{__name2(this,"CreatureConfig")}get title(){const namespace=this.actor.isOfType("character")?"Character":"NPC";return game.i18n.localize(`PF2E.Actor.${namespace}.Configure.Title`)}get template(){return`systems/pf2e/templates/actors/${this.actor.type}/config.hbs`}get actor(){return this.object}static get defaultOptions(){const options=super.defaultOptions;return options.sheetConfig=!1,options.width=450,options}async getData(options={}){const source2=this.actor._source,alliance=source2.system.details?.alliance===null?"neutral":source2.system.details?.alliance??"default",defaultValue=game.i18n.localize(this.actor.hasPlayerOwner?"PF2E.Actor.Creature.Alliance.Party":"PF2E.Actor.Creature.Alliance.Opposition"),allianceOptions={default:game.i18n.format("PF2E.Actor.Creature.Alliance.Default",{alliance:defaultValue}),opposition:"PF2E.Actor.Creature.Alliance.Opposition",party:"PF2E.Actor.Creature.Alliance.Party",neutral:"PF2E.Actor.Creature.Alliance.Neutral"};return{...await super.getData(options),alliances:createSheetOptions(allianceOptions,{value:[alliance]})}}async _updateObject(event2,formData){const key="system.details.alliance",alliance=formData[key];if(alliance==="default")delete formData[key],formData["system.details.-=alliance"]=null;else if(alliance==="neutral")formData[key]=null;else if(!setHasElement(ALLIANCES,alliance))throw ErrorPF2e("Unrecognized alliance");return super._updateObject(event2,formData)}}class CharacterConfig extends CreatureConfig{static{__name(this,"CharacterConfig")}static{__name2(this,"CharacterConfig")}async getData(options={}){const{showBasicUnarmed}=this.actor.flags.pf2e;return{...await super.getData(options),showBasicUnarmed}}}class CraftingAbility{static{__name(this,"CraftingAbility")}static{__name2(this,"CraftingAbility")}actor;#preparedFormulas=null;constructor(actor){this.actor=actor}initialize(data){this.slug=data.slug,this.resource=data.resource,this.label=data.label,this.isAlchemical=data.isAlchemical,this.isDailyPrep=data.isDailyPrep,this.isPrepared=data.isPrepared,this.maxSlots=Math.floor(data.maxSlots??0),this.maxItemLevel=data.maxItemLevel,this.fieldDiscovery=data.fieldDiscovery?new Predicate(data.fieldDiscovery):null,this.batchSize=data.batchSize,this.craftableItems=t(data.craftableItems,[c=>c.batchSize??1,"desc"]),this.fieldDiscoveryBatchSize=data.fieldDiscoveryBatchSize??3,this.preparedFormulaData=data.preparedFormulaData??[],this.#preparedFormulas=null,this.isAlchemical&&(this.resource="infused-reagents",this.isDailyPrep=!0,this.isPrepared=!0)}async getPreparedCraftingFormulas(){if(this.#preparedFormulas)return this.#preparedFormulas;const knownFormulas=await this.actor.crafting.getFormulas();return this.preparedFormulaData=(this.preparedFormulaData??[]).filter(d=>knownFormulas.some(f=>f.item.uuid===d.uuid)),this.#preparedFormulas=this.preparedFormulaData.flatMap(prepData=>{const formula=knownFormulas.find(f=>f.uuid===prepData.uuid),rollOptions=formula?.item.getRollOptions("item")??[],batchSize=(formula?this.craftableItems.find(c=>c.predicate.test(rollOptions)):null)?.batchSize??this.batchSize??1,batches=Math.ceil((prepData.quantity||1)/batchSize);return formula?{...formula,batchSize,batches,quantity:batches*batchSize,expended:!!prepData.expended,isSignatureItem:!!prepData.isSignatureItem}:[]}),this.#preparedFormulas}async calculateResourceCost(){if(!this.resource)return 0;const preparedCraftingFormulas=await this.getPreparedCraftingFormulas(),values=await Promise.all(preparedCraftingFormulas.map(async f=>f.quantity/await this.#batchSizeFor(f)));return Math.ceil(values.reduce((total,part)=>total+part,0))}canCraft(item,{warn=!0}={}){const rollOptions=item.getRollOptions("item");if(!this.craftableItems.some(c=>c.predicate.test(rollOptions)))return warn&&ui.notifications.warn(game.i18n.localize("PF2E.CraftingTab.Alerts.ItemMissingTraits")),!1;if(item.level>this.maxItemLevel)return warn&&ui.notifications.warn(game.i18n.format("PF2E.CraftingTab.Alerts.MaxItemLevel",{level:this.maxItemLevel})),!1;const resourceUUID=this.resource?this.actor.synthetics.resources[sluggify(this.resource,{camel:"dromedary"})]?.itemUUID:null;return item.uuid!==resourceUUID}async getValidFormulas(){const validFormulas=(await this.actor.crafting.getFormulas()).filter(f=>this.canCraft(f.item,{warn:!1}));return Promise.all(validFormulas.map(async f=>({...f,batchSize:await this.#batchSizeFor(f)})))}async prepareFormula(uuid){await this.setFormulaQuantity(uuid,"increase")}async unprepareFormula(indexOrUuid){return typeof indexOrUuid=="string"?(this.preparedFormulaData=this.preparedFormulaData.filter(p=>p.uuid!==indexOrUuid),this.#updateRuleElement()):(this.preparedFormulaData.splice(indexOrUuid,1),this.#updateRuleElement())}async setFormulaQuantity(indexOrUuid,value){const index2=typeof indexOrUuid=="number"?indexOrUuid:this.preparedFormulaData.findIndex(d=>d.uuid===indexOrUuid),data=this.preparedFormulaData[index2]??null;if(!data&&typeof indexOrUuid!="string")return;const prepared=await this.getPreparedCraftingFormulas(),consumed=prepared.reduce((sum,p)=>sum+p.batches,0),itemUuid=data?.uuid??(typeof indexOrUuid=="string"?indexOrUuid:null),item=itemUuid?await fromUuid(itemUuid):null,batchSize=this.fieldDiscovery?.test(item?.getRollOptions("item")??[])||!item?1:await this.#batchSizeFor(item),individualPrep=!this.isDailyPrep,currentQuantity=individualPrep?prepared.filter(p=>p.uuid===item?.uuid).length:data?.quantity??0;if(!itemUuid)return;const increasing=value==="increase"||!data||typeof value=="number"&&value>currentQuantity;if(!this.resource&&consumed>=this.maxSlots&&increasing){ui.notifications.warn(game.i18n.localize("PF2E.CraftingTab.Alerts.MaxSlots"));return}const validMaxQuantity=this.maxSlots?currentQuantity+(this.maxSlots-consumed)*batchSize:1/0,newQuantity=Math.clamp(typeof value=="number"?value:value==="increase"?currentQuantity+batchSize:currentQuantity-batchSize,0,validMaxQuantity);if(!(newQuantity>currentQuantity&&(!item?.isOfType("physical")||!this.canCraft(item)))){if(newQuantity===0)return this.unprepareFormula(itemUuid??index2);if(individualPrep){if(newQuantity>currentQuantity){if(!item)return;this.preparedFormulaData.push(...t$c(0,newQuantity-currentQuantity).map(()=>({uuid:item.uuid})))}else for(let i=0;i<currentQuantity-newQuantity;i++){const idx=this.preparedFormulaData.findLastIndex(p=>p.uuid===itemUuid);this.preparedFormulaData.splice(idx,1)}return this.#updateRuleElement()}if(data)data.quantity=Math.ceil(Math.clamp(newQuantity,batchSize,batchSize*50)/batchSize)*batchSize;else{if(!item)return;this.preparedFormulaData.push({uuid:item.uuid,quantity:newQuantity})}return this.#updateRuleElement()}}async toggleFormulaExpended(index2,value){const data=this.preparedFormulaData[index2];return data.expended=value??!data.expended,this.#updateRuleElement()}async toggleSignatureItem(itemUUID){const data=this.preparedFormulaData.find(f=>f.uuid===itemUUID);if(data?.uuid===itemUUID)return data.isSignatureItem=!data.isSignatureItem,this.setFormulaQuantity(this.preparedFormulaData.indexOf(data),data.quantity??await this.#batchSizeFor(data))}async updateFormulas(formulas,operation){return this.preparedFormulaData=formulas,this.#preparedFormulas=null,this.#updateRuleElement(operation)}async craft(itemOrUUIDOrIndex,{consume=!0,destination}={}){const preparedFormulas=await this.getPreparedCraftingFormulas(),[item,index2]=await(async()=>{if(typeof itemOrUUIDOrIndex=="number")return[preparedFormulas[itemOrUUIDOrIndex].item,itemOrUUIDOrIndex];const item2=typeof itemOrUUIDOrIndex=="string"?await fromUuid(itemOrUUIDOrIndex):itemOrUUIDOrIndex;if(!(item2 instanceof PhysicalItemPF2e))return[null,-1];if(this.isPrepared){const validIndex=preparedFormulas.findIndex(f=>f.item.uuid===item2.uuid&&!f.expended),index22=validIndex<0?preparedFormulas.findIndex(f=>f.item.uuid===item2.uuid):validIndex;return[item2,index22]}else return[item2,-1]})();if(!item)return null;if(this.isPrepared&&consume){if(!this.preparedFormulaData[index2]||this.preparedFormulaData[index2].expended)return ui.notifications.warn("PF2E.CraftingTab.Alerts.FormulaExpended",{localize:!0}),null;await this.toggleFormulaExpended(index2)}const rollOptions=item.getRollOptions("item"),batchSize=this.craftableItems.find(c=>c.predicate.test(rollOptions))?.batchSize??this.batchSize;if(this.resource&&consume){const value=this.actor.getResource(this.resource??"")?.value??0;if(value)await this.actor.updateResource(this.resource,value-1);else return ui.notifications.warn("PF2E.Actor.Character.Crafting.MissingResource",{localize:!0}),null}if(item.system.traits.value.includes("snare"))return null;const itemSource=item.toObject(!0);itemSource.system.quantity=batchSize,itemSource.system.temporary=!0,itemSource.system.size=this.actor.ancestry?.size==="tiny"?"tiny":"med",item.isAlchemical&&itemIsOfType(itemSource,"consumable","equipment","weapon")&&(itemSource.system.traits.value.push("infused"),itemSource.system.traits.value.sort()),destination==="hand"&&(itemSource.system.equipped={carryType:"held",handsHeld:1});const stackable=this.actor.inventory.findStackableItem(itemSource);return stackable?(stackable.update({"system.quantity":stackable.quantity+batchSize}),stackable):(await this.actor.createEmbeddedDocuments("Item",[itemSource]))[0]??null}async calculateDailyCrafting(){if(!this.isDailyPrep)return{items:[],resource:null,insufficient:!1};const prepared=await this.getPreparedCraftingFormulas(),consumed=prepared.reduce((sum,p)=>sum+p.batches,0);return{items:prepared.filter(f=>!f.expended).map(formula=>{const item=formula.item,itemSource=item.toObject();return itemSource.system.quantity=formula.quantity,itemSource.system.temporary=!0,itemSource.system.size=this.actor.ancestry?.size==="tiny"?"tiny":"med",item.isAlchemical&&itemIsOfType(itemSource,"consumable","equipment","weapon","ammo")&&(itemSource.system.traits.value.push("infused"),itemSource.system.traits.value.sort()),itemSource}),resource:this.resource?{slug:this.resource,cost:await this.calculateResourceCost()}:null,insufficient:this.maxSlots>0&&consumed>this.maxSlots}}async getSheetData(){const prepared=[...await this.getPreparedCraftingFormulas()],consumed=prepared.reduce((sum,p)=>sum+p.batches,0),remainingSlots=Math.max(0,this.maxSlots-consumed);return{label:this.label,slug:this.slug,isAlchemical:this.isAlchemical,isPrepared:this.isPrepared,isDailyPrep:this.isDailyPrep,insufficient:this.maxSlots>0&&consumed>this.maxSlots,maxItemLevel:this.maxItemLevel,resource:this.resource?this.actor.getResource(this.resource):null,resourceCost:await this.calculateResourceCost(),maxSlots:this.maxSlots,prepared,remainingSlots}}async#batchSizeFor(data){const isSignatureItem="isSignatureItem"in data&&!!data.isSignatureItem,item=data instanceof ItemPF2e?data:"item"in data?data.item:(await this.actor.crafting.getFormulas()).find(f=>f.item.uuid===data.uuid)?.item;if(!item)return 1;const rollOptions=item.getRollOptions("item");return isSignatureItem||this.fieldDiscovery?.test(rollOptions)?this.fieldDiscoveryBatchSize:this.craftableItems.find(c=>c.predicate.test(rollOptions))?.batchSize??this.batchSize}async#updateRuleElement(operation){const rules=this.actor.rules.filter(r2=>r2.key==="CraftingAbility"&&r2.slug===this.slug),itemUpdates=createBatchRuleElementUpdate(rules,{prepared:this.preparedFormulaData});itemUpdates.length&&await this.actor.updateEmbeddedDocuments("Item",itemUpdates,operation)}}class CharacterCrafting{static{__name(this,"CharacterCrafting")}static{__name2(this,"CharacterCrafting")}actor;abilities=new Collection;#formulas=null;constructor(actor){this.actor=actor}initialize(){this.#formulas=null;const abilityData=Object.values(this.actor.system.crafting.entries).filter(d=>!!d?.label&&!!d.slug&&d.craftableItems.length>0),abilities2=[];for(const data of abilityData){const ability=this.abilities.get(data.slug)??new CraftingAbility(this.actor);ability.initialize(data),abilities2.push(ability)}this.abilities.clear();for(const ability of abilities2)this.abilities.set(ability.slug,ability)}async getFormulas(){if(this.#formulas)return this.#formulas;const formulas=this.actor.system.crafting.formulas,formulaMap=new Map(formulas.map(data=>[data.uuid,data])),result=(await UUIDUtils.fromUUIDs(formulas.map(f=>f.uuid))).filter(i=>i instanceof ItemPF2e&&i.isOfType("physical")).map(item=>{const formula=formulaMap.get(item.uuid);if(!formula)return null;const isConsumable=item.system.traits.value.includes("consumable"),batchSize=Math.max(item.system.price.per,isConsumable?4:1);return{...formula,item,dc:calculateDC(item.level,{rarity:item.rarity,pwol:game.pf2e.settings.variants.pwol.enabled}),batchSize}}).filter(f=>!!f);return this.#formulas=result,result}async resetDailyCrafting(){const actor=this.actor,deletedItems=await this.actor.inventory.deleteTemporaryItems({render:!1}),abilitiesToReset=this.abilities.filter(a=>a.isDailyPrep&&a.preparedFormulaData.some(f=>f.expended));for(const ability of abilitiesToReset){const formulas=ability.preparedFormulaData.map(f=>({...f,expended:!1}));await ability.updateFormulas(formulas,{render:!1})}const resourcesToRestore=n(abilitiesToReset.map(a=>a.resource).filter(r2=>!!r2));for(const slug of resourcesToRestore){const resource=actor.getResource(slug);resource&&await actor.updateResource(slug,resource.max,{render:!1})}const wasDailyCraftingComplete=actor.flags.pf2e.dailyCraftingComplete;await actor.update({"flags.pf2e.dailyCraftingComplete":!1},{render:!1}),(deletedItems.length>0||abilitiesToReset.length>0||resourcesToRestore.length>0||wasDailyCraftingComplete)&&actor.render()}async performDailyCrafting(){const actor=this.actor,abilities2=this.abilities.filter(e2=>e2.isDailyPrep),results=await Promise.all(abilities2.map(a=>a.calculateDailyCrafting())),itemsToAdd=results.flatMap(r2=>r2.items);if(itemsToAdd.length===0)return;if(results.some(r2=>r2.insufficient)){ui.notifications.warn("PF2E.Actor.Character.Crafting.MissingResource",{localize:!0});return}const resourceCosts=results.reduce((costs,result)=>(result.resource&&(costs[result.resource.slug]??=0,costs[result.resource.slug]+=result.resource.cost),costs),{}),resourceUpdates={};for(const[slug,cost]of Object.entries(resourceCosts)){const resource=actor.getResource(slug);if(!resource||cost>resource.value){ui.notifications.warn("PF2E.Actor.Character.Crafting.MissingResource",{localize:!0});return}resourceUpdates[slug]=resource.value-cost}for(const[slug,value]of Object.entries(resourceUpdates))await actor.updateResource(slug,value,{render:!1});for(const ability of abilities2){const formulas=ability.preparedFormulaData.map(f=>({...f,expended:!0}));await ability.updateFormulas(formulas,{render:!1})}await actor.update({"flags.pf2e.dailyCraftingComplete":!0},{render:!1}),await actor.inventory.add(itemsToAdd,{stack:!0}),ui.notifications.info("PF2E.Actor.Character.Crafting.Daily.Complete",{localize:!0})}}class PCSheetTabManager{static{__name(this,"PCSheetTabManager")}static{__name2(this,"PCSheetTabManager")}actor;link;constructor(actor,link){this.actor=actor,this.link=link,this.initialize()}async initialize(){const content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/character/manage-tabs.hbs");createTooltipster(this.link,{content,contentAsHTML:!0,delay:250,interactive:!0,theme:"crb-hover",title:game.i18n.localize("PF2E.TabManageTabsLabel"),trigger:"custom",triggerOpen:{click:!0},triggerClose:{originClick:!0,mouseleave:!0},functionReady:__name2((_origin,helper)=>this.#onReady(helper.tooltip),"functionReady"),functionAfter:this.#onClose.bind(this)})}#onReady(tooltip=null){if(!tooltip)return;const tabVisibility=this.actor.flags.pf2e.sheetTabs,tabs2=this.link.closest("nav")?.querySelectorAll("a.item[data-tab]")??[];for(const tab of Array.from(tabs2)){const tabName=tab.dataset.tab??"",selector=`input[data-tab-name="${tabName}"]`,input=tooltip.querySelector(selector);input&&(input.checked=tabVisibility[tabName]),tab.classList.contains("hidden")&&(tab.classList.remove("hidden"),tab.classList.add("to-hide"))}const checkboxes=Array.from(tooltip.querySelectorAll('input[type="checkbox"]'));for(const checkbox of checkboxes)this.#handleOnChange(checkbox,checkboxes)}#handleOnChange(checkbox,checkboxes){checkbox.addEventListener("change",async()=>{const nav=this.link.closest("nav"),tabName=checkbox?.dataset.tabName??"",tab=nav?.querySelector(`a.item[data-tab="${tabName}"]`);for(const c of checkboxes)c.readOnly=!0;checkbox.checked?(tab?.classList.remove("to-hide"),await this.actor.update({[`flags.pf2e.sheetTabs.-=${tabName}`]:null},{render:!1})):(tab?.classList.add("to-hide"),await this.actor.update({[`flags.pf2e.sheetTabs.${tabName}`]:!1},{render:!1}));for(const c of checkboxes)c.readOnly=!1})}#onClose(){const tabs2=Array.from(this.link.closest("nav")?.querySelectorAll("a.item[data-tab]")??[]);for(const tab of tabs2)tab.classList.contains("to-hide")&&(tab.classList.remove("to-hide"),tab.classList.add("hidden"))}}class CharacterSheetPF2e extends CreatureSheetPF2e{static{__name(this,"CharacterSheetPF2e")}static{__name2(this,"CharacterSheetPF2e")}actorConfigClass=CharacterConfig;#knownFormulas={};#formulaQuantities={};static get defaultOptions(){const options=super.defaultOptions;return options.classes=[...options.classes,"character"],options.width=750,options.height=750,options.scrollY.push(".tab[data-tab=spellcasting] > [data-panels]",".tab.active .tab-content"),options.dragDrop.push({dragSelector:"ol[data-strikes] > li, ol[data-elemental-blasts] > li"}),options.tabs=[{navSelector:"nav.sheet-navigation",contentSelector:".sheet-content",initial:"character"},{navSelector:"nav.actions-nav",contentSelector:".actions-panels",initial:"encounter"},{navSelector:"nav[data-group=spell-collections]",contentSelector:"div[data-tab=spellcasting] > [data-panels]",group:"spell-collections",initial:"known-spells"}],options}get template(){return`systems/pf2e/templates/actors/character/${this.actor.limited&&!game.user.isGM?"limited":"sheet"}.hbs`}async getData(options){const sheetData=await super.getData(options),actor=this.actor;if(this.actor.limited){const tab=options?.tabs.find(t2=>t2.navSelector===".sheet-navigation");tab&&(tab.initial="biography")}sheetData.numberToRank=t$9([0,1,2,3,4],n2=>[n2,game.i18n.localize(`PF2E.ProficiencyLevel${n2}`)]),sheetData.senses=condenseSenses(this.actor.perception.senses.contents);for(const section of["attacks","defenses"])for(const key of Object.keys(sheetData.data.proficiencies[section])){const proficiency=sheetData.data.proficiencies[section][key];(!proficiency?.visible||proficiency?.rank===0&&!proficiency.custom)&&delete sheetData.data.proficiencies[section][key]}sheetData.martialProficiencies={attacks:sortLabeledRecord(t$5(sheetData.data.proficiencies.attacks,(data,key)=>{const groupMatch=/^weapon-group-([-\w]+)$/.exec(key),baseWeaponMatch=/^weapon-base-([-\w]+)$/.exec(key);if(objectHasKey(CONFIG.PF2E.weaponCategories,key)){const locKey=sluggify(key,{camel:"bactrian"});data.label=tupleHasValue(WEAPON_CATEGORIES,key)?`PF2E.Actor.Character.Proficiency.Attack.${locKey}`:CONFIG.PF2E.weaponCategories[key]}else if(Array.isArray(groupMatch)){const weaponGroup=groupMatch[1];data.label=CONFIG.PF2E.weaponGroups[weaponGroup]??weaponGroup}else if(Array.isArray(baseWeaponMatch)){const baseType=baseWeaponMatch[1],baseWeaponTypes2=CONFIG.PF2E.baseWeaponTypes,baseShieldTypes2=CONFIG.PF2E.baseShieldTypes;data.label=baseWeaponTypes2[baseType]??baseShieldTypes2[baseType]??baseType}else data.label??=key;const rank=data.rank??0;return data.value=createProficiencyModifier({actor,rank,domains:[]}).value,data})),defenses:sortLabeledRecord(t$5(sheetData.data.proficiencies.defenses,(data,key)=>{if(key in CONFIG.PF2E.armorCategories){const locKey=sluggify(key,{camel:"bactrian"});data.label=`PF2E.Actor.Character.Proficiency.Defense.${locKey}`}const rank=data.rank??0;return data.value=createProficiencyModifier({actor,rank,domains:[]}).value,data}))},sheetData.ancestry=actor.ancestry,sheetData.heritage=actor.heritage,sheetData.background=actor.background,sheetData.class=actor.class,sheetData.deity=actor.deity;const resources=this.actor.system.resources,headerResource=this.actor.getResource(resources.mythicPoints.max>0?"mythic-points":"hero-points");sheetData.headerResource={...headerResource,icon:headerResource?.slug==="mythic-points"?"fa-circle-m":"fa-hospital-symbol"},sheetData.attributeBoostsAllocated=(()=>{const build=actor.system.build;if(build.attributes.manual||!isReallyPC(actor))return!0;const keyAttributeSelected=!sheetData.class||build.attributes.keyOptions.includes(sheetData.data.details.keyability.value),ancestryBoostsSelected=(sheetData.ancestry?.system.alternateAncestryBoosts?.length===2||Object.values(sheetData.ancestry?.system.boosts??{}).every(b=>b.value.length===0||!!b.selected))&&sheetData.ancestry?.system.voluntary?.boost!==null,backgroundBoostsSelected=Object.values(sheetData.background?.system.boosts??{}).every(b=>b.value.length===0||!!b.selected);return ancestryBoostsSelected&&backgroundBoostsSelected&&keyAttributeSelected&&[1,5,10,15,20].filter(l=>build.attributes.allowedBoosts[l]>build.attributes.boosts[l].length).length===0})();const allClassDCs=Object.values(sheetData.data.proficiencies.classDCs),classDCs=allClassDCs.filter(cdc=>cdc.rank>0||allClassDCs.length>1).map(classDC=>({...classDC,icon:this.getProficiencyIcon(classDC.rank),hover:CONFIG.PF2E.proficiencyLevels[classDC.rank]})).sort((a,b)=>a.primary?-1:b.primary?1:a.slug.localeCompare(b.slug)),primaryClassDC=sheetData.data.attributes.classDC?.slug??null;sheetData.classDCs={dcs:classDCs,primary:primaryClassDC,perDCDetails:classDCs.length>1||!primaryClassDC};const abpEnabled=game.pf2e.variantRules.AutomaticBonusProgression.isEnabled(actor);sheetData.apexAttributeOptions=abpEnabled?[]:this.actor.inventory.contents.flatMap(e2=>e2.system.apex?.selected===!1&&e2.isInvested&&e2.system.apex.attribute!==actor.system.build.attributes.apex?e2.system.apex.attribute:[]);const collectionGroups=foundry.utils.mergeObject({"known-spells":[],rituals:[],activations:[]},t$2(await this.prepareSpellcasting(),a=>a.category==="items"?"activations":a.category==="ritual"?"rituals":"known-spells"));sheetData.magicTraditions=CONFIG.PF2E.magicTraditions,sheetData.preparationType=CONFIG.PF2E.preparationType,sheetData.spellCollectionGroups=collectionGroups,sheetData.hasNormalSpellcasting=sheetData.spellCollectionGroups["known-spells"].some(s=>s.usesSpellProficiency),sheetData.data.saves={fortitude:sheetData.data.saves.fortitude,reflex:sheetData.data.saves.reflex,will:sheetData.data.saves.will};for(const save of Object.values(sheetData.data.saves))save.short=game.i18n.format(`PF2E.Saves${save.label}Short`);sheetData.data.details.keyability.singleOption=actor.class?.system.keyAbility.value.length===1,sheetData.hasStamina=game.pf2e.settings.variants.stamina,sheetData.actions=this.#prepareAbilities(),sheetData.feats=[...actor.feats,actor.feats.bonus],sheetData.crafting=await this.#prepareCrafting(),sheetData.abpEnabled=AutomaticBonusProgression$1.isEnabled(actor),sheetData.languages=(()=>{const languagesBuild=actor.system.build.languages,sourceLanguages=actor._source.system.details.languages.value.filter(l=>l in CONFIG.PF2E.languages).sort(),isOverMax=languagesBuild.value>languagesBuild.max,languageSlugs=actor.system.details.languages.value,commonLanguage=game.pf2e.settings.campaign.languages.commonLanguage,sortedLanguages=languageSlugs.flatMap(language=>{if(language===commonLanguage&&languageSlugs.includes("common"))return[];const label=language==="common"&&commonLanguage?game.i18n.format("PF2E.Actor.Creature.Language.CommonLanguage",{language:game.i18n.localize(CONFIG.PF2E.languages[commonLanguage])}):game.i18n.localize(CONFIG.PF2E.languages[language]);return{slug:language,label,tooltip:null,overLimit:!1}}).sort((a,b)=>a.label.localeCompare(b.label)),commonFirst=t(sortedLanguages,l=>l.slug!=="common");for(const language of commonFirst.filter(l=>l.slug&&sourceLanguages.includes(l.slug)).reverse())language.slug&&(language.overLimit=isOverMax&&sourceLanguages.indexOf(language.slug)+1>languagesBuild.max,language.tooltip=language.overLimit?game.i18n.localize("PF2E.Actor.Character.Language.OverLimit"):null);const unallocatedLabel=game.i18n.localize("PF2E.Actor.Character.Language.Unallocated.Label"),unallocatedTooltip=game.i18n.localize("PF2E.Actor.Character.Language.Unallocated.Tooltip"),unallocatedLanguages=Array.fromRange(Math.max(0,languagesBuild.max-languagesBuild.value)).map(()=>({slug:null,label:unallocatedLabel,tooltip:unallocatedTooltip,overLimit:!1}));return commonFirst.push(...unallocatedLanguages),commonFirst})(),sheetData.data.skills=Object.fromEntries(Object.entries(sheetData.data.skills).sort(([_keyA,skillA],[_keyB,skillB])=>game.i18n.localize(skillA.label??"").localeCompare(game.i18n.localize(skillB.label??""),game.i18n.lang))),sheetData.tabVisibility=foundry.utils.deepClone(actor.flags.pf2e.sheetTabs);const rollData=actor.getRollData(),biography=sheetData.biography=actor.system.details.biography,enrichmentOptions={rollData,secrets:actor.isOwner,async:!0},enrichPromises={appearance:TextEditorPF2e.enrichHTML(biography.appearance,enrichmentOptions),backstory:TextEditorPF2e.enrichHTML(biography.backstory,enrichmentOptions),campaignNotes:TextEditorPF2e.enrichHTML(biography.campaignNotes,enrichmentOptions),allies:TextEditorPF2e.enrichHTML(biography.allies,enrichmentOptions),enemies:TextEditorPF2e.enrichHTML(biography.enemies,enrichmentOptions),organizations:TextEditorPF2e.enrichHTML(biography.organizations,enrichmentOptions)};await Promise.all(Object.values(enrichPromises));for(const[key,content]of Object.entries(enrichPromises))sheetData.enrichedContent[key]=await content;try{const action2=new ElementalBlast(this.actor),blastData=(await Promise.all(action2.configs.map(c=>this.#getBlastData(action2,c)))).sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang));sheetData.elementalBlasts=blastData}catch{sheetData.elementalBlasts=[]}const speedIcons={land:"person-running",swim:"person-swimming",climb:"mountain",fly:"feather-pointed",burrow:"water-ladder"};return sheetData.speeds=t$4(speedIcons).map(slug=>{const data=this.actor.system.movement.speeds[slug];return{slug,icon:fontAwesomeIcon(speedIcons[slug]).outerHTML,action:["swim","climb"].includes(slug)&&!data?.value?slug:null,label:`PF2E.Actor.Speed.Type.${slug.capitalize()}`,value:data?.value??null,breakdown:data?.breakdown??null}}),sheetData}#prepareAbilities(){const result={encounter:{action:{label:game.i18n.localize("PF2E.ActionsActionsHeader"),actions:[]},reaction:{label:game.i18n.localize("PF2E.ActionsReactionsHeader"),actions:[]},free:{label:game.i18n.localize("PF2E.ActionsFreeActionsHeader"),actions:[]}},exploration:{active:[],other:[]},downtime:[]},actor=this.actor,elementalBlasts=actor.itemTypes.action.filter(i=>i.slug==="elemental-blast");for(const item of actor.items){if(!item.isOfType("action")&&!(item.isOfType("feat")&&item.actionCost)||item.suppressed||actor.flags.pf2e.kineticist&&item===elementalBlasts[0])continue;const baseData=createAbilityViewData(item),action2={...baseData,img:(()=>{const actionIcon=getActionIcon(item.actionCost),defaultIcon=ItemPF2e.getDefaultArtwork(item._source).img,isDefaultImage=[actionIcon,defaultIcon,"icons/sundries/books/book-red-exclamation.webp"].includes(item.img);return item.isOfType("action")&&!isDefaultImage?item.img:item.system.selfEffect?.img??(baseData.usable&&!isDefaultImage?item.img:actionIcon)})(),feat:item.isOfType("feat")?item:null,toggles:item.system.traits.toggles?.getSheetData()??[]},traits=item.system.traits.value;if(traits.includes("exploration")){const active=actor.system.exploration.includes(item.id);action2.exploration={active},(active?result.exploration.active:result.exploration.other).push(action2)}else traits.includes("downtime")?result.downtime.push(action2):result.encounter[item.actionCost?.type??"free"]?.actions.push(action2)}for(const list of["action","reaction","free"])result.encounter[list].actions.sort((a,b)=>a.name.localeCompare(b.name,game.i18n.lang));return result.exploration.active.sort((a,b)=>a.name.localeCompare(b.name,game.i18n.lang)),result.exploration.other.sort((a,b)=>a.name.localeCompare(b.name,game.i18n.lang)),result.downtime.sort((a,b)=>a.name.localeCompare(b.name,game.i18n.lang)),result}async#prepareCrafting(){const actor=this.actor,flags=actor.flags.pf2e,formulas=await actor.crafting.getFormulas();this.#knownFormulas=t$9(formulas,f=>[f.uuid,f]);const sheetFormulas=formulas.map(f=>({uuid:f.uuid,item:f.item,dc:f.dc,batchSize:this.#formulaQuantities[f.uuid]??f.batchSize,cost:Coins.fromPrice(f.item.price,this.#formulaQuantities[f.uuid]??f.batchSize).toString()})),knownFormulas=t$a(sheetFormulas,t$2(f=>f.item.level),t$f(),t$e(),t$b(f=>({level:f[0],formulas:f[1]}))),abilities2=this.actor.crafting.abilities,sheetData=await Promise.all(abilities2.map(e2=>e2.getSheetData()));return{noCost:flags.freeCrafting,hasQuickAlchemy:abilities2.some(a=>a.isAlchemical)&&!!(actor.rollOptions.all["feature:quick-alchemy"]||actor.rollOptions.all["feat:quick-alchemy"]),hasDailyCrafting:this.actor.crafting.abilities.some(a=>a.isDailyPrep||a.isAlchemical),dailyCraftingComplete:!!this.actor.flags.pf2e.dailyCraftingComplete,abilities:{spontaneous:sheetData.filter(s=>!s.isPrepared),prepared:sheetData.filter(s=>!s.isAlchemical&&s.isPrepared),alchemical:{entries:sheetData.filter(s=>s.isAlchemical),resource:actor.getResource("infused-reagents"),resourceCost:sheetData.filter(s=>s.isAlchemical).reduce((sum,a)=>sum+a.resourceCost,0)}},knownFormulas}}prepareInventoryItem(item){const data=super.prepareInventoryItem(item);data.isInvestable=!item.isStowed&&item.isIdentified&&item.isInvested!==null;const actor=this.actor,invested=actor.inventory.invested,canInvest=invested&&invested.value<invested.max;if(item.isOfType("armor")&&getItemProficiencyRank(actor,item)>0){const isWearingArmor=!!actor.wornArmor;(item.isEquipped||!isWearingArmor)&&!item.isInvested&&data.isInvestable&&canInvest?data.notifyInvest=!0:isWearingArmor||(data.notifyEquip=!0)}return data}openTab(name2){["encounter","exploration","downtime"].includes(name2)?(super.openTab("actions"),this._tabs[1].activate(name2)):super.openTab(name2)}activateListeners($html){super.activateListeners($html);const html2=$html[0];this.#activateNavListeners(html2),this.toggleInitiativeLink(),htmlQuery(html2,".sidebar a[data-action=roll-initiative]")?.addEventListener("pointerenter",()=>{this.toggleInitiativeLink()}),$html.find(".adjust-item-stat").on("click contextmenu",event2=>this.#onClickAdjustItemStat(event2)),$html.find(".adjust-item-stat-select").on("change",event2=>this.#onChangeAdjustItemStat(event2));const mainPanel=htmlQuery(html2,".tab[data-tab=character]");if(mainPanel&&this.isEditable){new foundry.applications.ux.ContextMenu(mainPanel,".detail-item-control",[{name:"PF2E.EditItemTitle",icon:fontAwesomeIcon("edit").outerHTML,callback:__name2(target=>{const itemId=htmlClosest(target,"[data-item-id]")?.dataset.itemId;this.actor.items.get(itemId,{strict:!0}).sheet.render(!0,{focus:!0})},"callback")},{name:"PF2E.DeleteItemTitle",icon:fontAwesomeIcon("trash").outerHTML,callback:__name2(target=>{const itemId=htmlClosest(target,"[data-item-id]")?.dataset.itemId,item=this.actor.items.get(itemId,{strict:!0});this.deleteItem(item)},"callback")}],{eventName:"click",fixed:!0,jQuery:!1,onOpen:__name2(()=>{Promise.resolve().then(()=>{const menu=document.getElementById("context-menu");if(menu){const leftPlacement=-1*Math.floor(.95*menu.clientWidth);menu.style.left=`${leftPlacement}px`}})},"onOpen")});for(const link of htmlQueryAll(html2,".crb-tag-selector"))link.addEventListener("click",()=>this.openTagSelector(link))}const actionsPanel=htmlQuery(html2,".tab[data-tab=actions]");for(const strikeElem of htmlQueryAll(actionsPanel,"ol[data-strikes] > li")){const auxActionButtons=htmlQueryAll(strikeElem,"button[data-action=auxiliary-action]");for(const button of auxActionButtons){const modularSelect=htmlQuery(button,"select");button.addEventListener("click",()=>{const auxiliaryActionIndex=Number(button.dataset.auxiliaryActionIndex??NaN),strike=this.getAttackActionFromDOM(button),selection=modularSelect?.value??null;strike?.auxiliaryActions?.at(auxiliaryActionIndex)?.execute({selection})});for(const eventType of["change","click","dragenter","input"])modularSelect?.addEventListener(eventType,event2=>{event2.stopImmediatePropagation()})}const ammoSelect=htmlQuery(strikeElem,"select[data-action=link-ammo]");ammoSelect?.addEventListener("change",event2=>{event2.stopPropagation();const weapon=this.getAttackActionFromDOM(ammoSelect)?.item,ammo=this.actor.items.get(ammoSelect.value);weapon?.update({system:{selectedAmmoId:ammo?.id??null}})});const ammoQuantity=strikeElem.querySelector("input[data-action=change-ammo-quantity]");ammoQuantity?.addEventListener("blur",event2=>{event2.stopPropagation();const weapon=this.getAttackActionFromDOM(ammoQuantity)?.item;if(!weapon)return;const itemId=htmlClosest(ammoQuantity,"[data-item-id]")?.dataset.itemId,item=weapon.subitems.get(itemId,{strict:!0});if(!item.isOfType("ammo","weapon"))return;const value=Math.max(0,Number(ammoQuantity.value));value===0&&!(item.isOfType("ammo")&&item.isMagazine&&!item.system.uses.autoDestroy)?item.delete():item.isOfType("ammo")&&item.isMagazine?item.update({"system.uses.value":value}):item.update({"system.quantity":value})})}for(const customModifierEl of htmlQueryAll(html2,".modifiers-tooltip")){const stat=customModifierEl.dataset.stat;if(!stat)continue;for(const removeButton of htmlQueryAll(customModifierEl,"[data-action=remove-modifier]")){const slug=removeButton.dataset.slug??"";removeButton.addEventListener("click",()=>{this.actor.removeCustomModifier(stat,slug)})}const modifierValueEl=htmlQuery(customModifierEl,".add-modifier input[type=number]");htmlQuery(customModifierEl,"[data-action=increment]")?.addEventListener("click",()=>{modifierValueEl?.stepUp()}),htmlQuery(customModifierEl,"[data-action=decrement]")?.addEventListener("click",()=>{modifierValueEl?.stepDown()}),htmlQuery(customModifierEl,"[data-action=create-custom-modifier]")?.addEventListener("click",()=>{const modifier=modifierValueEl?.valueAsNumber||1,type2=htmlQuery(customModifierEl,".add-modifier-type")?.value??"",label=htmlQuery(customModifierEl,".add-modifier-name")?.value?.trim()??game.i18n.localize(`PF2E.ModifierType.${type2}`);if(!setHasElement(MODIFIER_TYPES,type2)){ui.notifications.error("Type is required.");return}this.actor.addCustomModifier(stat,label,modifier,type2)})}this.#activateBlastListeners(actionsPanel);for(const hoverEl of htmlQueryAll(html2,".hover")){const allSides=["top","right","bottom","left"],side=hoverEl.dataset.tooltipSide?.split(",")?.filter(t2=>tupleHasValue(allSides,t2))??["right","bottom"];createTooltipster(hoverEl,{trigger:"click",arrow:!1,contentAsHTML:!0,debug:!1,interactive:!0,side,theme:"crb-hover",minWidth:120})}const castingPanel=htmlQuery(html2,".tab[data-tab=spellcasting]");for(const select of htmlQueryAll(html2,"select[data-action=update-spellcasting-rank]"))select.addEventListener("change",()=>{const newRank=Number(select.value);if(![1,2,3,4].includes(newRank))throw ErrorPF2e("Unexpected rank received while changing proficiency");const autoChanges=(this.actor.system.autoChanges["system.proficiencies.spellcasting.rank"]??[]).filter(ac=>typeof ac.value=="number"&&ac.mode==="upgrade"),highestUpgrade=t(autoChanges,ac=>Number(ac.value)).at(-1);if(typeof highestUpgrade?.value=="number"&&highestUpgrade.value>newRank){const rank=CONFIG.PF2E.proficiencyLevels[highestUpgrade.value];ui.notifications.warn(game.i18n.format("PF2E.Actor.Character.Proficiency.HigherUpgrade",{ability:highestUpgrade.source,rank:game.i18n.format(rank)})),this.render()}else{const entries=this.actor.itemTypes.spellcastingEntry.filter(e2=>!e2.system.proficiency.slug);this.actor.updateEmbeddedDocuments("Item",entries.map(e2=>({_id:e2.id,"system.proficiency.value":newRank})))}});const craftingTab=htmlQuery(html2,".tab[data-tab=crafting]");for(const element of htmlQueryAll(craftingTab,"li.formula-item")){const quantity=htmlQuery(element,"input[data-craft-quantity]");quantity?.addEventListener("change",async event2=>{const row=htmlClosest(event2?.target,"li"),formula=this.#knownFormulas[row?.dataset.itemUuid??""],minBatchSize=formula.item.system.price.per,newValue=Number(quantity.value)||minBatchSize;if(newValue<1)return;const slug=htmlClosest(event2?.target,"li")?.dataset.ability;if(slug){const ability=this.actor.crafting.abilities.get(slug,{strict:!0}),index2=element.dataset.itemIndex;return ability.setFormulaQuantity(Number(index2),newValue)}this.#formulaQuantities[formula.uuid]=Math.max(newValue,minBatchSize),this.render()})}for(const spellcastingCollectionEl of htmlQueryAll(castingPanel,".spellcasting-entry[data-item-id]")){const entry=this.actor.spellcasting.get(spellcastingCollectionEl.dataset.itemId??"");htmlQuery(spellcastingCollectionEl,"[data-action=spell-attack]")?.addEventListener("click",event2=>{entry?.statistic?.check.roll(eventToRollParams(event2,{type:"check"}))})}}#activateNavListeners(html2){const sheetNavigation=htmlQuery(html2,"nav.sheet-navigation");if(!sheetNavigation)return;const navTitleArea=htmlQuery(sheetNavigation,":scope > .panel-title"),activeTab=htmlQuery(sheetNavigation,"a[data-tab].active");if(!(navTitleArea&&activeTab))throw ErrorPF2e("Sheet navigation not found");navTitleArea.innerText=game.i18n.localize(activeTab.dataset.tooltip??"");const manageTabsAnchor=htmlQuery(sheetNavigation,":scope > a[data-action=manage-tabs]");manageTabsAnchor&&new PCSheetTabManager(this.actor,manageTabsAnchor),sheetNavigation.addEventListener("click",event2=>{const anchor=htmlClosest(event2.target,"a[data-tab]");anchor&&(navTitleArea.innerText=game.i18n.localize(anchor.dataset.tooltip??""))})}activateClickListener(html2){const handlers=super.activateClickListener(html2);handlers.rest=async event2=>game.pf2e.actions.restForTheNight({event:event2,actors:this.actor}),handlers["open-abc-picker"]=async(_event,target)=>{const itemType=target.dataset.itemType;if(!tupleHasValue(["ancestry","heritage","background","class","deity"],itemType))throw ErrorPF2e("Unexpected item type");new ABCPicker({actor:this.actor,itemType}).render({force:!0})},handlers["edit-attribute-boosts"]=()=>(Object.values(this.actor.apps).find(a=>a instanceof AttributeBuilder)??new AttributeBuilder(this.actor)).render(!0),handlers["select-apex-attribute"]=event2=>{if(game.pf2e.variantRules.AutomaticBonusProgression.isEnabled(this.actor))return;const attribute=htmlClosest(event2.target,"[data-attribute]")?.dataset.attribute;if(setHasElement(ATTRIBUTE_ABBREVIATIONS,attribute)){const apexItems=this.actor.inventory.filter(e2=>e2.system.apex),selection=apexItems.find(e2=>e2.isInvested&&e2.system.apex?.attribute===attribute);this.actor.updateEmbeddedDocuments("Item",apexItems.map(e2=>({_id:e2.id,"system.apex.selected":e2===selection})))}},handlers["open-compendium"]=(_,actionTarget)=>game.packs.get(actionTarget.dataset.compendium??"")?.render(!0),handlers["toggle-hide-stowed"]=()=>{this.actor.update({"flags.pf2e.hideStowed":!this.actor.flags.pf2e.hideStowed})},handlers["toggle-weapon-trait"]=async(_,button)=>{if(!(button instanceof HTMLButtonElement))return;const weapon=this.getAttackActionFromDOM(button)?.item,trait=button.dataset.trait,errorMessage="Unexpected failure while toggling weapon trait";if(trait==="double-barrel"){const selected=!weapon?.system.traits.toggles.doubleBarrel.selected;if(!weapon?.traits.has("double-barrel"))throw ErrorPF2e(errorMessage);return weapon.system.traits.toggles.update({trait,selected})}else if(trait==="versatile"){const baseType=weapon?.system.damage.damageType??null,selected=button.classList.contains("selected")||button.value===baseType?null:button.value,selectionIsValid=objectHasKey(CONFIG.PF2E.damageTypes,selected)||selected===null;if(weapon&&selectionIsValid)return weapon.system.traits.toggles.update({trait,selected})}throw ErrorPF2e(errorMessage)},handlers["toggle-trait"]=async(_,button)=>{const itemId=htmlClosest(button,"[data-item-id]")?.dataset.itemId,item=this.actor.items.get(itemId,{strict:!0});if(!item.isOfType("action","feat"))throw ErrorPF2e("Unexpected item retrieved while toggling trait");const trait=button.dataset.trait;if(trait!=="mindshift")throw ErrorPF2e("Unexpected trait received while toggling");const toggle=item.system.traits.toggles?.[trait];if(!toggle)throw ErrorPF2e("Unexpected failure to look up trait toggle");return item.system.traits.toggles?.update({trait,selected:!toggle.selected})},handlers.unload=async(event2,button)=>{const weapon=this.getAttackActionFromDOM(button)?.item;if(weapon){const itemId=htmlClosest(button,"[data-item-id]")?.dataset.itemId;weapon.subitems.get(itemId,{strict:!0}).detach({skipConfirm:event2.shiftKey})}},handlers["select-ammo"]=async(_,button)=>{const weapon=this.getAttackActionFromDOM(button)?.item,ammoId=htmlClosest(button,"[data-item-id]")?.dataset.itemId;if(!weapon||!ammoId||!weapon.subitems)return;const ammoSubItems=weapon.subitems.filter(i=>i.isOfType("ammo","weapon")&&i.isAmmoFor(weapon)),purgedItems=ammoSubItems.filter(i=>!i.quantity).map(i=>i.id),sources=t(foundry.utils.deepClone(weapon._source.system.subitems),s=>s.sort).filter(i=>!purgedItems.includes(i._id??"")),sourcesSorted=t$a(sources,t(i=>i.sort),t(i=>ammoSubItems.some(a=>a.id===i._id)?i._id===ammoId?1:2:0));for(const[idx,item]of sourcesSorted.entries())item.sort=idx;weapon.update({"system.subitems":sources})},handlers.reload=async(_,button)=>{const weapon=this.getAttackActionFromDOM(button)?.item;weapon&&new WeaponReloader({weapon}).activate(button)},handlers["toggle-exploration"]=async event2=>{const actionId=htmlClosest(event2.target,"[data-item-id]")?.dataset.itemId;if(!actionId)return;const exploration=this.actor.system.exploration.filter(id=>this.actor.items.has(id));exploration.findSplice(id=>id===actionId)||exploration.push(actionId),await this.actor.update({"system.exploration":exploration})},handlers["clear-exploration"]=async()=>{await this.actor.update({"system.exploration":[]})},handlers["channel-elements"]=async event2=>{const abilityItem=this.actor.itemTypes.action.find(i=>i.slug==="channel-elements"&&i.system.selfEffect);abilityItem&&await createUseActionMessage(abilityItem,eventToRollMode(event2))},handlers["toggle-invested"]=async event2=>{const itemId=htmlClosest(event2.target,"[data-item-id]")?.dataset.itemId;itemId&&await this.actor.toggleInvested(itemId)},handlers["add-attack-proficiency"]=()=>ManageAttackProficiencies.add(this.actor),handlers["delete-attack-proficiency"]=event2=>ManageAttackProficiencies.remove(this.actor,event2),handlers["create-feat"]=()=>{this.actor.createEmbeddedDocuments("Item",[{name:game.i18n.localize(CONFIG.PF2E.featCategories.bonus),type:"feat",system:{category:"bonus"}}])},handlers["browse-feats"]=(_,anchor)=>this.#onClickBrowseFeats(anchor),handlers["formula-to-chat"]=async event2=>{const uuid=htmlClosest(event2.target,"li")?.dataset.itemUuid;if(!UUIDUtils.isItemUUID(uuid))throw ErrorPF2e(`Invalid UUID: ${uuid}`);const formula=this.#knownFormulas[uuid];formula&&await new ItemProxyPF2e(formula.item.toObject(),{parent:this.actor}).toMessage(event2,{create:!0,data:{fromFormula:!0}})},handlers["toggle-free-crafting"]=async()=>{const freeCrafting=!this.actor.flags.pf2e.freeCrafting;this.actor.update({"flags.pf2e.freeCrafting":freeCrafting})},handlers["prepare-formula"]=(_,anchor)=>{const actor=this.actor,abilitySlug=htmlClosest(anchor,"[data-ability]")?.dataset.ability,ability=actor.crafting.abilities.get(abilitySlug??"",{strict:!0});new FormulaPicker({actor,ability,mode:"prepare"}).render({force:!0})},handlers["craft-item"]=async(event2,anchor)=>{const row=htmlClosest(anchor,"li");if(!row)return;const ability=this.actor.crafting.abilities.get(row.dataset.ability??"");if(ability){const craftParam=ability.isPrepared&&row.dataset.itemIndex?Number(row.dataset.itemIndex):null,consume=!ability.resource||!!this.actor.getResource(ability.resource)?.value,item=craftParam!==null?await ability.craft(craftParam,{consume}):null;item&&await ChatMessagePF2e.create({author:game.user.id,content:game.i18n.format("PF2E.Actions.Craft.Information.ReceiveItem",{actorName:this.actor.name,itemName:item.name,quantity:1}),speaker:{alias:this.actor.name}});return}const uuid=row.dataset.itemUuid;if(!UUIDUtils.isItemUUID(uuid))throw ErrorPF2e(`Invalid UUID: ${uuid}`);const quantityInput=htmlQuery(row,"input[data-craft-quantity]"),quantity=Number(quantityInput?.value)||1,formula=this.#knownFormulas[uuid];if(!formula)return;if(this.actor.flags.pf2e.quickAlchemy){const reagentValue=this.actor.system.resources.crafting.infusedReagents.value-1;if(reagentValue<0){ui.notifications.warn("PF2E.Actor.Character.Crafting.MissingResource",{localize:!0});return}return await this.actor.update({"system.resources.crafting.infusedReagents.value":reagentValue},{render:!1}),craftItem(formula.item,1,this.actor,!0)}if(this.actor.flags.pf2e.freeCrafting)return isSpellConsumableUUID(uuid)&&formula.item.isOfType("consumable")?craftSpellConsumable(formula.item,quantity,this.actor):craftItem(formula.item,quantity,this.actor);const difficultyClass={value:formula.dc,visible:!0,scope:"check"};craft({difficultyClass,item:formula.item,quantity,actors:this.actor,event:event2,free:anchor.dataset.free==="true"})},handlers["toggle-formula-expended"]=async event2=>{const row=htmlClosest(event2.target,"li");if(!row)return;const uuid=row.dataset.itemUuid,index2=row.dataset.itemIndex,slug=row.dataset.ability;if(!uuid||!index2||!slug)return;await this.actor.crafting.abilities.get(slug,{strict:!0}).toggleFormulaExpended(Number(index2))},handlers["toggle-signature-item"]=async event2=>{const row=htmlClosest(event2.target,"li");if(!row)return;const uuid=row.dataset.itemUuid,slug=row.dataset.ability;return!uuid||!slug?void 0:this.actor.crafting.abilities.get(slug,{strict:!0}).toggleSignatureItem(uuid)},handlers["perform-daily-crafting"]=()=>this.actor.crafting.performDailyCrafting(),handlers["reset-daily-crafting"]=()=>this.actor.crafting.resetDailyCrafting(),handlers["delete-formula"]=async event2=>{const uuid=htmlClosest(event2.target,"li")?.dataset.itemUuid;if(!UUIDUtils.isItemUUID(uuid))throw ErrorPF2e(`Invalid UUID: ${uuid}`);const name2=this.#knownFormulas[uuid]?.item.name,content=`<p class="note">${game.i18n.format("PF2E.CraftingTab.RemoveFormulaDialogQuestion",{name:name2})}</p>`;if(event2.ctrlKey||event2.metaKey||await foundry.applications.api.DialogV2.confirm({window:{title:"PF2E.CraftingTab.RemoveFormulaDialogTitle",icon:"fa-solid fa-trash"},content})){const actorFormulas=this.actor.toObject().system.crafting?.formulas??[];return actorFormulas.findSplice(f=>f.uuid===uuid),this.actor.update({"system.crafting.formulas":actorFormulas})}},handlers["unprepare-formula"]=async event2=>{const itemEl=htmlClosest(event2.target,"li"),uuid=itemEl?.dataset.itemUuid;if(!itemEl||!UUIDUtils.isItemUUID(uuid))throw ErrorPF2e(`Invalid UUID: ${uuid}`);const index2=itemEl.dataset.itemIndex,slug=itemEl.dataset.ability;if(!index2||!slug)return;const ability=this.actor.crafting.abilities.get(slug,{strict:!0}),name2=this.#knownFormulas[uuid]?.item.name,content=`<p class="hint">${game.i18n.format("PF2E.CraftingTab.UnprepareFormulaDialogQuestion",{name:name2})}</p>`;if(event2.ctrlKey||await foundry.applications.api.DialogV2.confirm({window:{title:"PF2E.CraftingTab.UnprepareFormulaDialogTitle"},content}))return ability.unprepareFormula(Number(index2))};const adjustCraftQuantity=__name2(async(_,anchor)=>{const row=htmlClosest(anchor,"li"),quantityInput=htmlQuery(row,"input[data-craft-quantity]"),formula=this.#knownFormulas[row?.dataset.itemUuid??""];if(!row||!quantityInput||!formula)return;const index2=row.dataset.itemIndex,slug=row.dataset.ability,currentQuantity=Number(quantityInput.value)||0;if(index2&&slug){const ability=this.actor.crafting.abilities.get(slug,{strict:!0}),direction=anchor.dataset.action==="increase-craft-quantity"?"increase":"decrease";return ability.setFormulaQuantity(Number(index2),direction)}const minBatchSize=formula.item.price.per,step2=anchor.dataset.action==="increase-craft-quantity"?minBatchSize:-minBatchSize,newQuantity=Math.max(currentQuantity+step2,1);newQuantity!==currentQuantity&&(this.#formulaQuantities[formula.uuid]=Math.max(newQuantity,minBatchSize),this.render())},"adjustCraftQuantity");return handlers["increase-craft-quantity"]=adjustCraftQuantity,handlers["decrease-craft-quantity"]=adjustCraftQuantity,handlers["toggle-bio-visibility"]=event2=>{const section=htmlClosest(event2.target,"a[data-action=toggle-bio-visibility")?.dataset.section;if(tupleHasValue(["appearance","backstory","personality","campaign"],section)){const{biography}=this.actor.system.details,path=`system.details.biography.visibility.${section}`;return this.actor.update({[path]:!biography.visibility[section]})}},handlers["add-edict-anathema"]=(_,anchor)=>{anchor.style.pointerEvents="none";const field=htmlClosest(anchor,"[data-field]")?.dataset.field;if(!tupleHasValue(["edicts","anathema"],field))throw ErrorPF2e("Unexpected error adding edicts or anathema");const list=this.actor._source.system.details.biography[field];return this.actor.update({[`system.details.biography.${field}`]:[...list,""]})},handlers["delete-edict-anathema"]=(_,anchor)=>{anchor.style.pointerEvents="none";const field=htmlClosest(anchor,"[data-field]")?.dataset.field,index2=anchor.dataset.index??"";if(!tupleHasValue(["edicts","anathema"],field)||!/^\d+$/.test(index2))throw ErrorPF2e("Unexpected error adding edicts or anathema");const list=[...this.actor._source.system.details.biography[field]];return list.splice(Number(index2),1),this.actor.update({[`system.details.biography.${field}`]:list})},handlers}async#getBlastData(blast,config){const damageType=config.damageTypes.find(dt=>dt.selected)?.value??"untyped",formulaFor=__name2((outcome,melee=!0)=>blast.damage({element:config.element,damageType,melee,outcome,getFormula:!0}),"formulaFor");return{...config,damageType,formula:{melee:{damage:await formulaFor("success"),critical:await formulaFor("criticalSuccess")},ranged:{damage:await formulaFor("success",!1),critical:await formulaFor("criticalSuccess",!1)}}}}#activateBlastListeners(panel){const blastList=htmlQuery(panel,"ol[data-elemental-blasts]"),{effectTraits:effectTraits2,damageTypes:damageTypes2}=CONFIG.PF2E,selectors=["roll-attack","roll-damage","set-damage-type"].map(s=>`button[data-action=${s}]`).join(",");blastList?.addEventListener("click",async event2=>{const button=htmlClosest(event2.target,selectors),blastRow=htmlClosest(button,"li");if(!(button&&blastRow))return;event2.stopPropagation();const blast=new ElementalBlast(this.actor),{element}=blastRow.dataset,damageType=button.value||blastRow.dataset.damageType;if(!objectHasKey(effectTraits2,element))throw ErrorPF2e("Unexpected error retrieve element");if(!objectHasKey(damageTypes2,damageType))throw ErrorPF2e("Unexpected error retrieving damage type");const melee=button.dataset.melee==="true";switch(button.dataset.action){case"roll-attack":{const mapIncreases=Math.clamp(Number(button.dataset.mapIncreases)||0,0,2);await blast.attack({mapIncreases,element,damageType,melee,event:event2});break}case"roll-damage":{const outcome=button.dataset.outcome==="success"?"success":"criticalSuccess";await blast.damage({element,damageType,melee,outcome,event:event2});break}case"set-damage-type":blast.setDamageType({element,damageType})}})}async#onClickBrowseFeats(element){const{featFilters,maxLevel}=(()=>{const groupId=htmlClosest(element,"[data-group-id]")?.dataset.groupId;if(groupId==="pfs")return{featFilters:{categories:["pfsboon"]},maxLevel:this.actor.level};if(groupId==="intercession")return{featFilters:{categories:["deityboon","curse"]}};const dataSetLevel=Number(element.dataset.level),featGroup=groupId==="bonus"?this.actor.feats.bonus:this.actor.feats.get(groupId,{strict:!0});return{featFilters:featGroup.slots[htmlClosest(element,"[data-slot-id]")?.dataset.slotId??""]?.filter??featGroup.filter,maxLevel:dataSetLevel||featGroup.level}})(),featTab=game.pf2e.compendiumBrowser.tabs.feat,filter=await featTab.getFilterData();if(filter.traits.conjunction=featFilters?.conjunction??"or",typeof maxLevel=="number"){const level=filter.level;level.to=Math.min(maxLevel,level.max),level.isExpanded=level.to!==level.max}const category=filter.checkboxes.category;for(const value of featFilters.categories??[])category.isExpanded=!0,category.options[value].selected=!0,category.selected.push(value);const traits=filter.traits,filterTraits=[(featFilters?.traits??[]).map(trait=>({trait,not:!1})),(featFilters?.omitTraits??[]).map(trait=>({trait,not:!0}))].flat();for(const{trait,not}of filterTraits){const data=traits.options.find(t2=>t2.value===trait);data&&traits.selected.push({...foundry.utils.deepClone(data),not})}return featTab.open({filter})}async#onChangeAdjustItemStat(event2){const $select=$(event2.delegateTarget),propertyKey=$select.attr("data-item-property")??"",selectedValue=Number($select.val()),itemId=$select.closest(".item").attr("data-item-id")??"",item=this.actor.items.get(itemId);if(!item)throw ErrorPF2e("Item not found");const newValue=(()=>{if(item.isOfType("spellcastingEntry"))return{"system.proficiency.value":__name2(()=>Math.clamp(selectedValue,0,4),"system.proficiency.value")}[propertyKey]?.();if(item.isOfType("lore"))return Math.clamp(selectedValue,0,4);throw ErrorPF2e("Item not recognized")})();typeof newValue=="number"&&await item.update({[propertyKey]:newValue}),newValue!==foundry.utils.getProperty(item,propertyKey)&&ui.notifications.warn(game.i18n.localize("PF2E.ErrorMessage.MinimumProfLevelSetByFeatures"))}async#onClickAdjustItemStat(event2){const $button=$(event2.delegateTarget),itemId=$button.closest(".item").attr("data-item-id")??"",item=this.actor.items.get(itemId);if(!item)throw ErrorPF2e("Item not found");const propertyKey=$button.attr("data-item-property")??"",change=event2.type==="click"?1:-1,newValue=(()=>{if(item.isOfType("spellcastingEntry")){const proficiencyRank=item.system.proficiency.value;return{"system.proficiency.value":__name2(()=>Math.clamp(proficiencyRank+change,0,4),"system.proficiency.value")}[propertyKey]?.()}else if(item.isOfType("lore")){const currentRank=item.system.proficient.value;return Math.clamp(currentRank+change,0,4)}else throw ErrorPF2e("Item not recognized")})();typeof newValue=="number"&&await item.update({[propertyKey]:newValue})}#getFeatSlotData(event2){const groupId=htmlClosest(event2.target,"[data-group-id]")?.dataset.groupId,slotId=htmlClosest(event2.target,"[data-slot-id]")?.dataset.slotId||null;return groupId?{groupId,slotId}:null}toggleInitiativeLink(link){if(link??=htmlQuery(this.element.get(0),".sidebar a[data-action=roll-initiative]"),!link)return;const alreadyRolled=typeof this.actor.combatant?.initiative=="number";if(!!(this.isEditable&&game.combat&&!alreadyRolled))link.classList.remove("disabled"),link.dataset.tooltip="COMBAT.InitiativeRoll";else{link.classList.add("disabled");const reason=this.isEditable?game.combat?alreadyRolled?"AlreadyRolled":null:"NoActiveEncounter":"";reason&&(link.dataset.tooltip=game.i18n.format(`PF2E.Encounter.${reason}`,{actor:this.actor.name}))}}async _onDropItem(event2,data){const item=await ItemPF2e.fromDropData(data);if(!item)throw ErrorPF2e("Unable to create item from drop data!");if(this.actor.uuid===item.parent?.uuid)return super._onDropItem(event2,data);if(item.isOfType("feat")){const slotData=this.#getFeatSlotData(event2);return this.actor.feats.insertFeat(item,slotData)}return super._onDropItem(event2,data)}async _onDrop(event2){const dropData=TextEditorPF2e.getDragEventData(event2);if(e$2(dropData.pf2e)&&dropData.pf2e.type==="CraftingFormula"){const dropAbilitySlug=typeof dropData.ability=="string"?dropData.ability:null;if(!dropAbilitySlug){const containerEl=htmlClosest(event2.target,".item-container");if(containerEl?.dataset.containerType==="craftingEntry"){const slug=containerEl.dataset.ability??"",ability=this.actor.crafting.abilities.get(slug);if(!ability)return;ability.prepareFormula(String(dropData.uuid??""));return}}const uuid=dropData.uuid;if(typeof uuid=="string"){const formula=this.#knownFormulas[uuid];if(formula){const targetUuid=htmlClosest(event2.target,"li.formula-item")?.dataset.itemUuid??"";return this.#sortFormulas(formula,targetUuid,dropAbilitySlug)}}}else return super._onDrop(event2)}async#sortFormulas(sourceFormula,targetUuid,slug){if(!UUIDUtils.isItemUUID(targetUuid)||sourceFormula.uuid===targetUuid)return;const sourceLevel=sourceFormula.item.level,targetLevel=this.#knownFormulas[targetUuid].item.level;if(!slug&&sourceLevel!==targetLevel)return;const ability=slug?this.actor.crafting.abilities.get(slug,{strict:!0}):null,formulas=foundry.utils.deepClone(ability?.preparedFormulaData??this.actor.system.crafting.formulas),source2=formulas.find(f=>f.uuid===sourceFormula.uuid),target=formulas.find(f=>f.uuid===targetUuid);if(source2&&target){const sourceIdx=formulas.indexOf(source2),targetIdx=formulas.indexOf(target);formulas.splice(sourceIdx,1),formulas.splice(targetIdx,0,source2),slug?await this.actor.crafting.abilities.get(slug)?.updateFormulas(formulas):await this.actor.update({"system.crafting.formulas":formulas})}}async _onSortItem(event2,itemData){const item=this.actor.items.get(itemData._id);if(item?.isOfType("feat")){const featSlot=this.#getFeatSlotData(event2);if(featSlot){const group=this.actor.feats.get(featSlot.groupId)??null,resorting=item.group===group&&!group?.slotted;if(group?.slotted&&!featSlot.slotId)return[];if(!resorting)return this.actor.feats.insertFeat(item,featSlot)}}return super._onSortItem(event2,itemData)}_updateObject(event2,formData){for(const field of["edicts","anathema"]){const keys=Array.fromRange(this.actor._source.system.details.biography[field].length).map(i=>`system.details.biography.${field}.${i}`),lines=keys.map(k=>String(formData[k]??"").trim());for(const key of keys)delete formData[key];lines.length>0&&(formData[`system.details.biography.${field}`]=lines)}return super._updateObject(event2,formData)}}class AttackPopout extends CharacterSheetPF2e{static{__name(this,"AttackPopout")}static{__name2(this,"AttackPopout")}type="strike";#itemId="";#slug="";#attack;#elementTrait;#blasts=[];get template(){return"systems/pf2e/templates/actors/character/attack-popout.hbs"}get id(){const id=super.id;return this.type==="blast"?`${id}-blast-${this.#elementTrait}`:`${id}-${this.type}-${this.#itemId}-${this.#slug}`}static get defaultOptions(){const options=super.defaultOptions;return{...options,classes:[...options.classes,"attack-popout"],submitOnChange:!1,submitOnClose:!1,width:520,height:"auto",resizable:!1}}get label(){return this.type==="blast"?this.#blasts.at(0)?.label??null:this.#attack?.label??null}constructor(object,options){if(super(object,options),!options.type)throw ErrorPF2e('AttackPopout is missing mandatory "type" option.');if(options.type==="blast"){if(!options.elementTrait)throw ErrorPF2e('AttackPopout of type "blast" is missing mandatory "elementalTrait" option.');this.#elementTrait=options.elementTrait}else{if(!options.slug)throw ErrorPF2e('AttackPopout of type "strike" is missing mandatory "slug" option.');if(!options.itemId)throw ErrorPF2e('AttackPopout of type "strike" is missing mandatory "itemId" option.');this.#slug=options.slug,this.#itemId=options.itemId}this.type=options.type}async getData(options){const base=await super.getData(options);return this.type==="blast"?(base.elementalBlasts=this.#blasts=base.elementalBlasts.filter(b=>b.element===this.#elementTrait),base.data.actions=[],base.toggles.actions=base.toggles.actions?.filter(t2=>t2.domain==="elemental-blast")??[]):(base.elementalBlasts=[],this.#slug&&this.#itemId&&(this.#attack=base.data.actions.find(a=>a.item.id===this.#itemId&&a.slug===this.#slug))),{...base,attack:this.#attack,index:base.data.actions.findIndex(a=>a===this.#attack),popoutType:this.type}}activateListeners($html){super.activateListeners($html);const html2=$html[0],{label}=this;if(label){const title=htmlQuery(htmlClosest(html2,"div.window-app"),"h4.window-title");title&&(title.innerHTML=game.i18n.localize(label))}}_getHeaderButtons(){return super._getHeaderButtons().filter(b=>b.label==="Close")}}class MacroPF2e extends Macro{static{__name(this,"MacroPF2e")}static{__name2(this,"MacroPF2e")}get visible(){return this.permission>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER}}async function rollItemMacro(itemIdOrUuid,event2=null){const speaker=ChatMessage.getSpeaker(),item=await(async()=>{if(UUIDUtils.isItemUUID(itemIdOrUuid)){const item3=await fromUuid(itemIdOrUuid);return item3 instanceof ItemPF2e&&item3.actor?item3:(ui.notifications.warn(`Item with uuid ${itemIdOrUuid} does not exist`),null)}const item2=(canvas.tokens.get(speaker.token??"")?.actor??game.actors.get(speaker.actor??""))?.items?.get(itemIdOrUuid);return item2||(ui.notifications.warn(`Your controlled Actor does not have an item with ID ${itemIdOrUuid}`),null)})();return item?item.isOfType("action","feat")?createUseActionMessage(item,eventToRollMode(event2)):await item.toMessage(event2)??null:null}__name(rollItemMacro,"rollItemMacro"),__name2(rollItemMacro,"rollItemMacro");async function createActionMacro({actorUUID,actionIndex,elementTrait,slot}){const actor=resolveMacroActor(actorUUID);if(!actor?.isOfType("character","npc"))return;const data=(()=>{if(actor.isOfType("character")&&objectHasKey(CONFIG.PF2E.effectTraits,elementTrait)){const config=new ElementalBlast(actor).configs.find(c=>c.element===elementTrait);return config?{name:game.i18n.localize(config.label),command:`game.pf2e.rollActionMacro({ actorUUID: "${actorUUID}", type: "blast", elementTrait: "${elementTrait}" })`,img:config.img}:null}else if(actionIndex!==void 0){const action2=actor.system.actions[actionIndex];return action2?{name:`${game.i18n.localize(action2.type==="strike"?"PF2E.WeaponStrikeLabel":action2.attackRollType)}: ${action2.label}`,command:`game.pf2e.rollActionMacro({ actorUUID: "${actorUUID}",  type: "${action2.type}", itemId: "${action2.item.id}", slug: "${action2.slug}" })`,img:action2.item.img}:null}return null})();if(!data)return;const actionMacro=game.macros.find(macro=>macro.name===data.name&&macro.command===data.command)??await MacroPF2e.create({command:data.command,name:data.name,type:"script",img:data.img,flags:{pf2e:{actionMacro:!0}}},{renderSheet:!1});game.user.assignHotbarMacro(actionMacro??null,slot)}__name(createActionMacro,"createActionMacro"),__name2(createActionMacro,"createActionMacro");async function rollActionMacro({actorUUID,itemId,elementTrait,slug,type:type2}){const actor=resolveMacroActor(actorUUID);if(!actor?.isOfType("character","npc")){ui.notifications.error("PF2E.MacroActionNoActorError",{localize:!0});return}const strikes=actor.system.actions,strike=strikes.find(s=>s.item.id===itemId&&s.slug===slug)??strikes.find(s=>s.slug===slug);if(actor.isOfType("character")){const closedExisting=__name2(partialId=>{const appId=`AttackPopout-Actor-${actor.id}-${partialId}`,existing=Object.values(actor.apps).find(a=>a?.id===appId);return existing?(existing.close({force:!0}),!0):!1},"closedExisting");switch(type2){case"blast":{if(closedExisting(`blast-${elementTrait}`))return;if(!actor.itemTypes.effect.find(e2=>e2.slug==="effect-kinetic-aura")){ui.notifications.error("PF2E.MacroActionNoActionError",{localize:!0});return}new AttackPopout(actor,{type:type2,elementTrait}).render(!0);return}case"strike":case"area-fire":case"auto-fire":{if(closedExisting(`${type2}-${itemId}-${slug}`))return;if(!strike){ui.notifications.error("PF2E.MacroActionNoActionError",{localize:!0});return}new AttackPopout(actor,{type:type2,itemId,slug}).render(!0);return}}}if(!strike){ui.notifications.error("PF2E.MacroActionNoActionError",{localize:!0});return}const meleeOrRanged=strike.item.isMelee?"melee":"ranged",identifier=`${strike.item.id}.${strike.slug}.${meleeOrRanged}`,description=await TextEditorPF2e.enrichHTML(game.i18n.localize(strike.description)),templateData={actor,strike,identifier,description},content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/strike-card.hbs",templateData),token=actor.token??actor.getActiveTokens(!0,!0).shift()??null,chatData={speaker:ChatMessagePF2e.getSpeaker({actor,token}),content,style:CONST.CHAT_MESSAGE_STYLES.OTHER},rollMode=game.settings.get("core","rollMode");return["gmroll","blindroll"].includes(rollMode)&&(chatData.whisper=ChatMessage.getWhisperRecipients("GM").map(u=>u.id)),rollMode==="blindroll"&&(chatData.blind=!0),ChatMessagePF2e.create(chatData)}__name(rollActionMacro,"rollActionMacro"),__name2(rollActionMacro,"rollActionMacro");async function createToggleEffectMacro(effect,slot){const uuid=effect.uuid.startsWith("Actor")?effect.sourceId:effect.uuid;if(!uuid){ui.notifications.error("PF2E.ErrorMessage.CantCreateEffectMacro",{localize:!0});return}const command=`const actors = game.user.getActiveTokens().flatMap((t) => t.actor ?? []);
if (actors.length === 0) {
    return ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected", { localize: true });
}

const ITEM_UUID = "${uuid}"; // ${effect.name}
const item = await fromUuid(ITEM_UUID);
if (item?.type === "condition") {
    for (const actor of actors) {
        actor.toggleCondition(item.slug);
    }
} else if (item?.type === "effect") {
    const source = item.toObject();
    source._stats.compendiumSource = ITEM_UUID;

    for (const actor of actors) {
        const existing = actor.itemTypes.effect.find((e) => e._stats.compendiumSource === ITEM_UUID);
        if (existing) {
            existing.delete();
        } else {
            actor.createEmbeddedDocuments("Item", [source]);
        }
    }
} else {
    ui.notifications.error(game.i18n.format("PF2E.ErrorMessage.ItemNotFoundByUUID", { uuid: ITEM_UUID }));
}
`,toggleMacro=game.macros.contents.find(macro=>macro.name===effect.name&&macro.command===command)??await MacroPF2e.create({command,name:effect.name,type:"script",img:effect.img},{renderSheet:!1});game.user.assignHotbarMacro(toggleMacro??null,slot)}__name(createToggleEffectMacro,"createToggleEffectMacro"),__name2(createToggleEffectMacro,"createToggleEffectMacro");function resolveMacroActor(uuid){if(uuid){const actor=fromUuidSync(uuid);return actor instanceof ActorPF2e?actor:null}const speaker=ChatMessage.getSpeaker();return canvas.tokens.get(speaker.token??"")?.actor??game.actors.get(speaker.actor??"")??null}__name(resolveMacroActor,"resolveMacroActor"),__name2(resolveMacroActor,"resolveMacroActor");async function perceptionForSelected(event2){const actors=canvas.tokens.controlled.flatMap(t2=>t2.actor??[]).filter(a=>!!a.isOfType("creature"));if(actors.length===0){ui.notifications.error("You must select at least one PC/NPC token.");return}const argsFromEvent=eventToRollParams(event2,{type:"check"});for(const actor of actors)await actor.perception.roll({...argsFromEvent,traits:["secret"]})}__name(perceptionForSelected,"perceptionForSelected"),__name2(perceptionForSelected,"perceptionForSelected");const ITEM_UUID="Compendium.pf2e.equipment-effects.Item.2YgXoHvJfrDHucMr",TEMPLATES={flavor:"./systems/pf2e/templates/chat/action/flavor.hbs",content:"./systems/pf2e/templates/chat/action/content.hbs"};async function raiseAShield(options){const localize=localizer("PF2E.Actions.RaiseAShield"),actors=Array.isArray(options.actors)?options.actors:[options.actors],actor=actors[0];if(actors.length>1||!actor?.isOfType("character","npc")){ui.notifications.error(localize("BadArgs"));return}const existingEffect=actor.itemTypes.effect.find(e2=>e2.sourceId===ITEM_UUID);if(existingEffect){await existingEffect.delete();return}if(actor.isOfType("character")){const{heldShield}=actor;return actor.system.actions.find(a=>a.ready&&!!a.item.shield&&a.item.shield===heldShield)?.auxiliaryActions.find(aux=>aux.action==="raise-a-shield")?.execute()}const shield=actor.heldShield,speaker=ChatMessagePF2e.getSpeaker({actor}),isSuccess=await(async()=>{if(shield?.isDestroyed)return ui.notifications.warn(localize("ShieldIsDestroyed",{actor:speaker.alias,shield:shield.name})),!1;if(shield?.isBroken===!1){const effect=await fromUuid(ITEM_UUID);if(!(effect instanceof EffectPF2e))throw ErrorPF2e("Raise a Shield effect not found");return await actor.createEmbeddedDocuments("Item",[effect.toObject()]),!0}else return shield?.isBroken?(ui.notifications.warn(localize("ShieldIsBroken",{actor:speaker.alias,shield:shield.name})),!1):(ui.notifications.warn(localize("NoShieldEquipped",{actor:speaker.alias})),!1)})();if(shield&&isSuccess){const combatActor=game.combat?.started&&game.combat.combatant?.actor||null,[actionType,glyph]=combatActor&&combatActor!==actor?["Reaction","R"]:["SingleAction","1"],content=await foundry.applications.handlebars.renderTemplate(TEMPLATES.content,{imgPath:shield.img,message:localize("Content",{actor:speaker.alias,shield:game.i18n.localize("TYPES.Item.shield")})}),flavor=await foundry.applications.handlebars.renderTemplate(TEMPLATES.flavor,{action:{title:localize(`${actionType}Title`),glyph}});await ChatMessagePF2e.create({style:CONST.CHAT_MESSAGE_STYLES.EMOTE,speaker,flavor,content})}}__name(raiseAShield,"raiseAShield"),__name2(raiseAShield,"raiseAShield");async function restForTheNight(options){const characters=(Array.isArray(options.actors)?options.actors:[options.actors]).filter(a=>a?.type==="character");if(characters.length===0)return ui.notifications.error(game.i18n.localize("PF2E.ErrorMessage.NoPCTokenSelected")),[];const localize=localizer("PF2E.Action.RestForTheNight"),promptMessage=(()=>{const element=document.createElement("p");return element.innerText=localize("Prompt"),element.outerHTML})();if(!options.skipDialog&&!await foundry.applications.api.DialogV2.confirm({window:{title:localize("Label")},content:promptMessage,yes:{default:!0}}))return[];const messages=[];for(const actor of characters){const actorUpdates={attributes:{hp:{value:actor._source.system.attributes.hp.value}},resources:{}},itemCreates=[],itemUpdates=[],statements=[],{abilities:abilities2,attributes,hitPoints,level}=actor,conModifier=abilities2.con.mod,maxRestored=Math.max(conModifier,1)*level*hitPoints.recoveryMultiplier+hitPoints.recoveryAddend,hpLost=attributes.hp.max-attributes.hp.value,hpRestored=hpLost>=maxRestored?maxRestored:hpLost;if(hpRestored>0){const singularOrPlural=hpRestored===1?"PF2E.Action.RestForTheNight.Message.HitPointsSingle":"PF2E.Action.RestForTheNight.Message.HitPoints";actorUpdates.attributes.hp={value:attributes.hp.value+=hpRestored},statements.push(game.i18n.format(singularOrPlural,{hitPoints:hpRestored}))}const RECOVERABLE_CONDITIONS=["doomed","drained","fatigued","wounded"],conditionChanges={doomed:null,drained:null,fatigued:null,wounded:null};actor.hasCondition("fatigued")&&(await actor.decreaseCondition("fatigued"),conditionChanges.fatigued="removed");for(const slug of["doomed","drained"]){const condition=actor.getCondition(slug);if(!condition)continue;const newValue=(condition.value??1)-1;await actor.decreaseCondition(slug),conditionChanges[slug]=newValue===0?"removed":"reduced"}actor.hasCondition("wounded")&&attributes.hp.value===attributes.hp.max&&(await actor.decreaseCondition("wounded",{forceRemove:!0}),conditionChanges.wounded="removed");const wands=actor.itemTypes.consumable.filter(i=>i.category==="wand"&&i.uses.value<i.uses.max);itemUpdates.push(...wands.map(wand=>({_id:wand.id,"system.uses.value":wand.uses.max})));const wandRecharged=itemUpdates.length>0,resources=actor.system.resources,reagents=resources.crafting.infusedReagents;reagents&&reagents.value<reagents.max&&(actorUpdates.resources.crafting={infusedReagents:{value:reagents.max}},statements.push(localize("Message.InfusedReagents"))),(await actor.inventory.deleteTemporaryItems({render:!1})).length&&statements.push(localize("Message.TemporaryItems"));const recharges=await actor.recharge({duration:"day",commit:!1});if(recharges.actorUpdates?.system&&"resources"in recharges.actorUpdates.system&&(actorUpdates.resources=foundry.utils.mergeObject(actorUpdates.resources,recharges.actorUpdates.system.resources)),itemCreates.push(...recharges.itemCreates),itemUpdates.push(...recharges.itemUpdates),game.pf2e.settings.variants.stamina){const stamina=attributes.hp.sp??{value:0,max:0},resolve=resources.resolve??{value:0,max:0};stamina.value<stamina.max&&(actorUpdates.attributes.hp.sp={value:stamina.max},statements.push(localize("Message.StaminaPoints"))),resolve.value<resolve.max&&(actorUpdates.resources.resolve={value:resolve.max},statements.push(localize("Message.Resolve")))}(Object.keys({...actorUpdates.attributes,...actorUpdates.resources}).length>0||actor.flags.pf2e.dailyCraftingComplete)&&await actor.update({"flags.pf2e.dailyCraftingComplete":!1,system:actorUpdates},{render:!1}),itemCreates.length>0&&await actor.createEmbeddedDocuments("Item",itemCreates,{render:!1}),itemUpdates.length>0&&await actor.updateEmbeddedDocuments("Item",itemUpdates,{render:!1}),recharges.affected.frequencies&&statements.push(localize("Message.Frequencies"));const abilitiesToReset=actor.crafting.abilities.filter(a=>a.isDailyPrep&&a.preparedFormulaData.some(f=>f.expended));if(abilitiesToReset.length>0){for(const ability of abilitiesToReset){const formulas=ability.preparedFormulaData.map(f=>({...f,expended:!1}));await ability.updateFormulas(formulas,{render:!1})}statements.push(localize("Message.CraftingSlots"))}for(const resource of recharges.affected.resources)if(resource==="focus")statements.push(localize("Message.FocusPoints"));else if(resource in actor.synthetics.resources){const name2=actor.synthetics.resources[resource].label;statements.push(localize("Message.Resource",{name:name2}))}recharges.affected.spellSlots&&statements.push(localize("Message.SpellSlots")),wandRecharged&&statements.push(localize("Message.WandsCharges"));const reducedConditions=RECOVERABLE_CONDITIONS.filter(c=>conditionChanges[c]==="reduced");for(const slug of reducedConditions){const{name:name2}=game.pf2e.ConditionManager.getCondition(slug);statements.push(localize("Message.ConditionReduced",{condition:name2}))}const removedConditions=RECOVERABLE_CONDITIONS.filter(c=>conditionChanges[c]==="removed");for(const slug of removedConditions){const{name:name2}=game.pf2e.ConditionManager.getCondition(slug);statements.push(localize("Message.ConditionRemoved",{condition:name2}))}const actorAwakens=localize("Message.Awakens",{actor:actor.name}),recoveryList=document.createElement("ul");recoveryList.append(...statements.map(statement=>{const listItem=document.createElement("li");return listItem.innerText=statement,listItem}));const content=[actorAwakens,recoveryList.outerHTML].join(`
`);Hooks.callAll("pf2e.restForTheNight",actor),messages.push({author:game.user.id,content,speaker:ChatMessagePF2e.getSpeaker({actor})})}return ChatMessagePF2e.createDocuments(messages,{restForTheNight:!0})}__name(restForTheNight,"restForTheNight"),__name2(restForTheNight,"restForTheNight");async function stealthForSelected(event2){const actors=canvas.tokens.controlled.flatMap(t2=>t2.actor??[]).filter(a=>!!a.isOfType("creature"));if(actors.length===0){ui.notifications.error("You must select at least one PC/NPC token.");return}const argsFromEvent=eventToRollParams(event2,{type:"check"});for(const actor of actors)await actor.skills.stealth.roll({...argsFromEvent,traits:["secret"]})}__name(stealthForSelected,"stealthForSelected"),__name2(stealthForSelected,"stealthForSelected");function steelYourResolve(options){const localize=localizer("PF2E.Actions.SteelYourResolve"),actors=Array.isArray(options.actors)?options.actors:[options.actors],actor=actors[0];if(actors.length>1||!(actor instanceof CharacterPF2e)){ui.notifications.error(localize("BadArgs"));return}const toChat=__name2((alias,content)=>{ChatMessage.create({author:game.user.id,content,speaker:{alias}})},"toChat");if(!game.pf2e.settings.variants.stamina){ui.notifications.error(localize("StaminaNotEnabled"));return}foundry.applications.api.DialogV2.confirm({window:{title:localize("Title")},content:localize("Content"),yes:{callback:__name2(()=>{const sp=actor.system.attributes.hp.sp??{value:0,max:0},resolve=actor.system.resources.resolve??{value:0},spRatio=`${sp.value}/${sp.max}`,recoverStamina=localize("RecoverStamina",{name:actor.name,ratio:spRatio}),noStamina=localize("NoStamina",{name:actor.name});if(resolve.value>0){toChat(actor.name,recoverStamina);const newSP=sp.value+Math.floor(sp.max/2);actor.update({"system.attributes.hp.sp.value":Math.min(newSP,sp.max),"system.resources.resolve.value":resolve.value-1})}else toChat(actor.name,noStamina)},"callback"),default:!0}})}__name(steelYourResolve,"steelYourResolve"),__name2(steelYourResolve,"steelYourResolve");async function takeABreather(){if(!game.pf2e.settings.variants.stamina)return;const pcs=n(game.user.getActiveTokens().map(t2=>t2.actor)).filter(e$6).filter(a=>a.isOfType("character"));if(pcs.length===0){ui.notifications.error("PF2E.ErrorMessage.NoPCTokenSelected",{localize:!0});return}await foundry.applications.api.DialogV2.confirm({window:{title:"Take a Breather"},content:"<div>Rest for 10 minutes, spend a resolve point, and regain stamina?</div>",yes:{callback:__name2(async()=>{for(const actor of pcs){const token=actor.getActiveTokens(!0,!0).shift(),name2=token?.name??actor.name,sp=actor.system.attributes.hp.sp,resolve=actor.system.resources.resolve;if(!(sp&&resolve))continue;const speaker=ChatMessagePF2e.getSpeaker({token,actor});resolve.value>0?(actor.update({"system.attributes.hp.sp.value":sp.max,"system.resources.resolve.value":resolve.value-1}),await ChatMessagePF2e.create({speaker,content:`${name2} has ${sp.value}/${sp.max} SP and spends a resolve point, taking a 10 minute breather. Stamina refreshed.`})):await ChatMessagePF2e.create({speaker,content:`${name2} is tired and needs to go to bed! No resolve points remaining.`})}},"callback"),default:!0}})}__name(takeABreather,"takeABreather"),__name2(takeABreather,"takeABreather");var ExplorationActivities=(ExplorationActivities2=>(ExplorationActivities2[ExplorationActivities2.NONE=0]="NONE",ExplorationActivities2[ExplorationActivities2.HALF_SPEED=1]="HALF_SPEED",ExplorationActivities2[ExplorationActivities2.AVOID_NOTICE=2]="AVOID_NOTICE",ExplorationActivities2[ExplorationActivities2.DEFEND=3]="DEFEND",ExplorationActivities2[ExplorationActivities2.DETECT_MAGIC=4]="DETECT_MAGIC",ExplorationActivities2[ExplorationActivities2.SCOUT=5]="SCOUT",ExplorationActivities2[ExplorationActivities2.SEARCH=6]="SEARCH",ExplorationActivities2))(ExplorationActivities||{}),DetectionMode=(DetectionMode2=>(DetectionMode2[DetectionMode2.NONE=0]="NONE",DetectionMode2[DetectionMode2.DETECT_EVERYTHING=1]="DETECT_EVERYTHING",DetectionMode2[DetectionMode2.DETECT_BEFORE_WALKING_INTO_IT=2]="DETECT_BEFORE_WALKING_INTO_IT",DetectionMode2))(DetectionMode||{});function sneaksAtFullSpeed(activity,explorationOptions){return activity===2&&(explorationOptions.legendarySneak||explorationOptions.swiftSneak)}__name(sneaksAtFullSpeed,"sneaksAtFullSpeed"),__name2(sneaksAtFullSpeed,"sneaksAtFullSpeed");function defendsAtFullSpeed(activity,explorationOptions){return activity===3&&explorationOptions.practicedDefender}__name(defendsAtFullSpeed,"defendsAtFullSpeed"),__name2(defendsAtFullSpeed,"defendsAtFullSpeed");function calculateNormalizedCharacterSpeed(defaultSpeedInFeet,activity,detectionMode,explorationOptions){return Math.max(5,calculateCharacterSpeed(defaultSpeedInFeet,activity,detectionMode,explorationOptions))}__name(calculateNormalizedCharacterSpeed,"calculateNormalizedCharacterSpeed"),__name2(calculateNormalizedCharacterSpeed,"calculateNormalizedCharacterSpeed");function calculateCharacterSpeed(defaultSpeedInFeet,activity,detectionMode,explorationOptions){const halvedSpeed=defaultSpeedInFeet/2;if(sneaksAtFullSpeed(activity,explorationOptions)||defendsAtFullSpeed(activity,explorationOptions))return defaultSpeedInFeet;if(activity===6){let searchSpeedFactor=1;return explorationOptions.expeditiousSearchLegendary?searchSpeedFactor=4:explorationOptions.expeditiousSearch&&(searchSpeedFactor=2),detectionMode===1?Math.min(halvedSpeed,searchSpeedFactor*30):detectionMode===2?Math.min(halvedSpeed,searchSpeedFactor*15):halvedSpeed}else return activity===4?detectionMode===1?Math.min(halvedSpeed,30):detectionMode===2?Math.min(halvedSpeed,15):halvedSpeed:activity===0?defaultSpeedInFeet:halvedSpeed}__name(calculateCharacterSpeed,"calculateCharacterSpeed"),__name2(calculateCharacterSpeed,"calculateCharacterSpeed");var LengthUnit=(LengthUnit2=>(LengthUnit2[LengthUnit2.MILES=0]="MILES",LengthUnit2[LengthUnit2.FEET=1]="FEET",LengthUnit2))(LengthUnit||{});const golarionMileInFeet=6e3;function toFeet(distance){return distance.unit===0?distance.value*golarionMileInFeet:distance.value}__name(toFeet,"toFeet"),__name2(toFeet,"toFeet");function speedToVelocity(speedInFeet){return{distance:{unit:1,value:speedInFeet*10},time:0}}__name(speedToVelocity,"speedToVelocity"),__name2(speedToVelocity,"speedToVelocity");function toFeetPerMinute(velocity){return toFeet(velocity.distance)}__name(toFeetPerMinute,"toFeetPerMinute"),__name2(toFeetPerMinute,"toFeetPerMinute");var Terrain=(Terrain2=>(Terrain2[Terrain2.NORMAL=0]="NORMAL",Terrain2[Terrain2.DIFFICULT=1]="DIFFICULT",Terrain2[Terrain2.GREATER_DIFFICULT=2]="GREATER_DIFFICULT",Terrain2))(Terrain||{});function increaseDistanceByTerrain(trip2){const feet=toFeet(trip2.distance);return trip2.terrain===1?feet*trip2.terrainSlowdown.difficult.numerator/trip2.terrainSlowdown.difficult.denominator:trip2.terrain===2?feet*trip2.terrainSlowdown.greaterDifficult.numerator/trip2.terrainSlowdown.greaterDifficult.denominator:feet*trip2.terrainSlowdown.normal.numerator/trip2.terrainSlowdown.normal.denominator}__name(increaseDistanceByTerrain,"increaseDistanceByTerrain"),__name2(increaseDistanceByTerrain,"increaseDistanceByTerrain");const minutesPerHour=60,daysPerWeek=7;function toTravelDuration({distanceInFeet,feetPerMinute,hustleDurationInMinutes,hoursPerDay=8}){const minutesPerDay=hoursPerDay*minutesPerHour,minutesPerWeek=minutesPerDay*daysPerWeek,hustleDuration=Math.min(hustleDurationInMinutes,minutesPerDay),normalTravelDuration=minutesPerDay-hustleDuration,averageSpeed=(feetPerMinute*2*hustleDuration+feetPerMinute*normalTravelDuration)/minutesPerDay,totalMinutes=Math.round(distanceInFeet/averageSpeed),weeks=Math.floor(totalMinutes/minutesPerWeek),days=Math.floor((totalMinutes-weeks*minutesPerWeek)/minutesPerDay),remainingMinutesMovingAtDoubleSpeed=(distanceInFeet-weeks*minutesPerWeek*averageSpeed-days*minutesPerDay*averageSpeed)/(feetPerMinute*2),remainingMinutesSpentHustling=Math.min(remainingMinutesMovingAtDoubleSpeed,hustleDurationInMinutes)+Math.max(0,remainingMinutesMovingAtDoubleSpeed-hustleDurationInMinutes)*2,hours=Math.floor(remainingMinutesSpentHustling/minutesPerHour),minutes=Math.round(remainingMinutesSpentHustling-hours*minutesPerHour);return{weeks,days,hours,minutes}}__name(toTravelDuration,"toTravelDuration"),__name2(toTravelDuration,"toTravelDuration");function calculateTravelDuration({journey,velocity,hustleDurationInMinutes=0,hoursPerDay=8}){const distanceInFeet=t$1(journey,increaseDistanceByTerrain),feetPerMinute=toFeetPerMinute(velocity);return toTravelDuration({distanceInFeet,feetPerMinute,hustleDurationInMinutes,hoursPerDay})}__name(calculateTravelDuration,"calculateTravelDuration"),__name2(calculateTravelDuration,"calculateTravelDuration");class TravelSpeedSheet extends foundry.appv1.api.FormApplication{static{__name(this,"TravelSpeedSheet")}static{__name2(this,"TravelSpeedSheet")}formData=void 0;static get defaultOptions(){const options=super.defaultOptions;return options.id="travel-duration",options.classes=["travel-duration"],options.title=game.i18n.localize("PF2E.TravelSpeed.Title"),options.template="systems/pf2e/templates/gm/travel/travel-speed-sheet.hbs",options.width="auto",options.submitOnChange=!0,options.closeOnSubmit=!1,options}async _updateObject(_event,formData){const data=foundry.utils.expandObject(formData);data.actors=toArray(data.actors),this.formData=data,this.render(!0)}actorFormToSheetData(actor,data){return{requiresDetectionMode:data.explorationActivity==="Search"||data.explorationActivity==="DetectMagic",detectionMode:data.detectionMode,explorationActivity:data.explorationActivity,explorationSpeed:parseFloat(calculateNormalizedCharacterSpeed(data.speed,parseExplorationActivity(data.explorationActivity),parseDetectionModeData(data.detectionMode),parseExplorationOptions(actor)).toFixed(2)),speed:data.speed,name:actor.name}}getInitialActorData(actor){return this.actorFormToSheetData(actor,{detectionMode:"before",explorationActivity:"Search",speed:actor.system.movement.speeds.land.value})}formToSheetData(actors,data){const journey=[{terrainSlowdown:{difficult:data.difficultTerrainSlowdown,greaterDifficult:data.greaterDifficultTerrainSlowdown,normal:data.normalTerrainSlowdown},terrain:parseTerrainData(data.terrain),distance:{value:data.distance,unit:parseDistanceUnit(data.distanceUnit)}}],actorFormData=t$g(actors,data.actors,(a,d)=>this.actorFormToSheetData(a,d)),partySpeedInFeet=Math.min(...actorFormData.map(data2=>data2.explorationSpeed)),velocity=speedToVelocity(partySpeedInFeet);return{travelDuration:calculateTravelDuration({journey,hoursPerDay:data.hoursPerDay,velocity,hustleDurationInMinutes:data.hustleMinutes}),distance:data.distance,actors:actorFormData,normalTerrainSlowdown:data.normalTerrainSlowdown,difficultTerrainSlowdown:data.difficultTerrainSlowdown,greaterDifficultTerrainSlowdown:data.greaterDifficultTerrainSlowdown,distanceUnit:data.distanceUnit,terrain:data.terrain,partySpeedInFeet,hustleMinutes:data.hustleMinutes,hoursPerDay:data.hoursPerDay}}getInitialFormData(actors){return this.formToSheetData(actors,{actors:actors.map(actor=>this.getInitialActorData(actor)),terrain:"normal",distanceUnit:"miles",normalTerrainSlowdown:{denominator:1,numerator:1},difficultTerrainSlowdown:{denominator:1,numerator:2},greaterDifficultTerrainSlowdown:{denominator:1,numerator:3},distance:1,hustleMinutes:getHustleMinutes(actors),hoursPerDay:8})}async getData(){const sheetData=await super.getData();let data;return this.formData===void 0?data=this.getInitialFormData(this.options.actors):data=this.formToSheetData(this.options.actors,this.formData),Object.assign(sheetData,data),{...sheetData,detectionModeOptions:[{value:"none",label:"PF2E.TravelSpeed.None"},{value:"everything",label:"PF2E.TravelSpeed.DetectEverything"},{value:"before",label:"PF2E.TravelSpeed.DetectBeforeRunningIntoIt"}],explorationActivityOptions:[{value:"AvoidNotice",label:"PF2E.TravelSpeed.ExplorationActivities.AvoidNotice"},{value:"CoverTracks",label:"PF2E.TravelSpeed.ExplorationActivities.CoverTracks"},{value:"Defend",label:"PF2E.TravelSpeed.ExplorationActivities.Defend"},{value:"DetectMagic",label:"PF2E.TravelSpeed.ExplorationActivities.DetectMagic"},{value:"Investigate",label:"PF2E.TravelSpeed.ExplorationActivities.Investigate"},{value:"RepeatASpell",label:"PF2E.TravelSpeed.ExplorationActivities.RepeatASpell"},{value:"Scout",label:"PF2E.TravelSpeed.ExplorationActivities.Scout"},{value:"Search",label:"PF2E.TravelSpeed.ExplorationActivities.Search"},{value:"Track",label:"PF2E.TravelSpeed.ExplorationActivities.Track"},{value:"None",label:"PF2E.TravelSpeed.ExplorationActivities.None"},{value:"HalfSpeed",label:"PF2E.TravelSpeed.ExplorationActivities.HalfSpeed"}],distanceUnitOptions:[{value:"miles",label:"PF2E.TravelSpeed.Miles"},{value:"feet",label:"PF2E.TravelSpeed.Feet"}],terrainOptions:[{value:"normal",label:"PF2E.TravelSpeed.NormalTerrain"},{value:"difficult",label:"PF2E.TravelSpeed.DifficultTerrain"},{value:"greaterDifficult",label:"PF2E.TravelSpeed.GreaterDifficultTerrain"}],oneToFour:t$c(1,5).map(n2=>({value:n2.toString(),label:n2.toString()}))}}}function parseDistanceUnit(unit){return unit==="feet"?LengthUnit.FEET:LengthUnit.MILES}__name(parseDistanceUnit,"parseDistanceUnit"),__name2(parseDistanceUnit,"parseDistanceUnit");function parseTerrainData(terrain){return terrain==="normal"?Terrain.NORMAL:terrain==="difficult"?Terrain.DIFFICULT:Terrain.GREATER_DIFFICULT}__name(parseTerrainData,"parseTerrainData"),__name2(parseTerrainData,"parseTerrainData");function parseDetectionModeData(detectionMode){return detectionMode==="none"?DetectionMode.NONE:detectionMode==="before"?DetectionMode.DETECT_BEFORE_WALKING_INTO_IT:DetectionMode.DETECT_EVERYTHING}__name(parseDetectionModeData,"parseDetectionModeData"),__name2(parseDetectionModeData,"parseDetectionModeData");function parseExplorationActivity(activity){return activity==="AvoidNotice"?ExplorationActivities.AVOID_NOTICE:activity==="Defend"?ExplorationActivities.DEFEND:activity==="DetectMagic"?ExplorationActivities.DETECT_MAGIC:activity==="Scout"?ExplorationActivities.SCOUT:activity==="Search"?ExplorationActivities.SEARCH:activity==="None"?ExplorationActivities.NONE:ExplorationActivities.HALF_SPEED}__name(parseExplorationActivity,"parseExplorationActivity"),__name2(parseExplorationActivity,"parseExplorationActivity");function getHustleMinutes(actors){return Math.min(...actors.map(actor=>Math.max(1,actor.system.abilities.con.mod)*10))}__name(getHustleMinutes,"getHustleMinutes"),__name2(getHustleMinutes,"getHustleMinutes");function hasFeat(actor,slug){return actor.itemTypes.feat.some(feat=>feat.slug===slug)}__name(hasFeat,"hasFeat"),__name2(hasFeat,"hasFeat");function parseExplorationOptions(actor){return{practicedDefender:hasFeat(actor,"practiced-defender"),swiftSneak:hasFeat(actor,"swift-sneak"),legendarySneak:hasFeat(actor,"legendary-sneak"),expeditiousSearch:hasFeat(actor,"expeditious-search"),expeditiousSearchLegendary:hasFeat(actor,"expeditious-search")&&actor.perception.rank===4}}__name(parseExplorationOptions,"parseExplorationOptions"),__name2(parseExplorationOptions,"parseExplorationOptions");function toArray(data){return Object.entries(data).sort(([a],[b])=>parseInt(a)-parseInt(b)).map(([_,a])=>a)}__name(toArray,"toArray"),__name2(toArray,"toArray");function launchTravelSheet(actors){new TravelSpeedSheet({},{actors}).render(!0)}__name(launchTravelSheet,"launchTravelSheet"),__name2(launchTravelSheet,"launchTravelSheet");function getHazards(actors){return actors.filter(a=>a.type==="hazard")}__name(getHazards,"getHazards"),__name2(getHazards,"getHazards");function getLevels(actors,alliance){return actors.filter(a=>a.alliance===alliance).map(a=>a.level)}__name(getLevels,"getLevels"),__name2(getLevels,"getLevels");function dialogTemplate(xp){return`
<h2>XP</h2>
<table>
    <tr>
        <th>${game.i18n.localize("PF2E.Encounter.Budget.PartySize")}</th>
        <td>${xp.partySize}</td>
    </tr>
    <tr>
        <th>${game.i18n.localize("PF2E.Encounter.Budget.PartyLevel")}</th>
        <td>${xp.partyLevel}</td>
    </tr>
    <tr>
        <th>${game.i18n.localize("PF2E.Encounter.Budget.Threat")}</th>
        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats."+xp.rating)} (${xp.totalXP} XP)</td>
    </tr>
    <tr>
        <th>${game.i18n.localize("PF2E.Encounter.Budget.Reward")}</th>
        <td>${xp.xpPerPlayer} XP</td>
    </tr>
</table>
<h2>${game.i18n.localize("PF2E.Encounter.Budget.EncounterBudget")}</h2>
<table class="pf2-table">
    <tr>
        <th>${game.i18n.localize("PF2E.Encounter.Budget.Threat")}</th>
        <th>${game.i18n.localize("PF2E.Encounter.Budget.XPBudget")}</th>
        <th>${game.i18n.localize("PF2E.Encounter.Budget.XPNeeded")}</th>
        <th>${game.i18n.localize("PF2E.Encounter.Budget.Reward")}</th>
    </tr>
    <tr>
        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats.trivial")}</td>
        <td>${xp.encounterBudgets.trivial}</td>
        <td>${xp.encounterBudgets.trivial-xp.totalXP}</td>
        <td>40</td>
    </tr>
    <tr>
        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats.low")}</td>
        <td>${xp.encounterBudgets.low}</td>
        <td>${xp.encounterBudgets.low-xp.totalXP}</td>
        <td>60</td>
    </tr>
    <tr>
        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats.moderate")}</td>
        <td>${xp.encounterBudgets.moderate}</td>
        <td>${xp.encounterBudgets.moderate-xp.totalXP}</td>
        <td>80</td>
    </tr>
    <tr>
        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats.severe")}</td>
        <td>${xp.encounterBudgets.severe}</td>
        <td>${xp.encounterBudgets.severe-xp.totalXP}</td>
        <td>120</td>
    </tr>
    <tr>
        <td>${game.i18n.localize("PF2E.Encounter.Budget.Threats.extreme")}</td>
        <td>${xp.encounterBudgets.extreme}</td>
        <td>${xp.encounterBudgets.extreme-xp.totalXP}</td>
        <td>160</td>
    </tr>
</table>
<h2>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureXPAndRole")}</h2>
<table class="pf2-table">
    <tr>
        <th>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevel")}</th>
        <th>XP</th>
        <th>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.SuggestedRole")}</th>
    </tr>
    <tr>
        <td>${xp.partyLevel-4}</td>
        <td>10</td>
        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.-4")}</td>
    </tr>
    <tr>
        <td>${xp.partyLevel-3}</td>
        <td>15</td>
        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.-3")}</td>
    </tr>
    <tr>
        <td>${xp.partyLevel-2}</td>
        <td>20</td>
        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.-2")}</td>
    </tr>
    <tr>
        <td>${xp.partyLevel-1}</td>
        <td>30</td>
        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.-1")}</td>
    </tr>
    <tr>
        <td>${xp.partyLevel}</td>
        <td>40</td>
        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.0")}</td>
    </tr>
    <tr>
        <td>${xp.partyLevel+1}</td>
        <td>60</td>
        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.1")}</td>
    </tr>
    <tr>
        <td>${xp.partyLevel+2}</td>
        <td>80</td>
        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.2")}</td>
    </tr>
    <tr>
        <td>${xp.partyLevel+3}</td>
        <td>120</td>
        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.3")}</td>
    </tr>
    <tr>
        <td>${xp.partyLevel+4}</td>
        <td>160</td>
        <td>${game.i18n.localize("PF2E.Encounter.CreatureXPAndRole.CreatureLevels.4")}</td>
    </tr>
</table>`}__name(dialogTemplate,"dialogTemplate"),__name2(dialogTemplate,"dialogTemplate");const askLevelPopupTemplate=__name2(()=>{const partySize=Math.trunc(Number(localStorage.getItem("xpMacroPartySize")??4)),partyLevel=Math.trunc(Number(localStorage.getItem("xpMacroPartyLevel")??1));return`
    <form>
    <div class="form-group">
        <label>${game.i18n.localize("PF2E.Encounter.Budget.PartySize")}</label>
        <input id="party-size" name="party-size" type="number" value="${partySize}">
    </div>
    <div class="form-group">
        <label>${game.i18n.localize("PF2E.Encounter.Budget.PartyLevel")}</label>
        <input id="party-level" name="party-level" type="number" value="${partyLevel}">
    </div>
    </form>
    `},"askLevelPopupTemplate");function showXP(partyLevel,partySize,npcLevels,hazards){const pwol=game.pf2e.settings.variants.pwol.enabled,xp=game.pf2e.gm.calculateXP(partyLevel,partySize,npcLevels,hazards,{pwol});new foundry.appv1.api.Dialog({title:"XP",content:dialogTemplate(xp),buttons:{}}).render(!0)}__name(showXP,"showXP"),__name2(showXP,"showXP");function askPartyLevelAndSize(npcLevels,hazards){new foundry.appv1.api.Dialog({title:"Party Information",content:askLevelPopupTemplate,buttons:{no:{icon:fontAwesomeIcon("times").outerHTML,label:"Cancel"},yes:{icon:fontAwesomeIcon("calculator").outerHTML,label:"Calculate XP",callback:__name2($html=>{const html2=$html[0],partySize=Math.abs(Math.trunc(Number(htmlQuery(html2,"[name=party-size]")?.value||1))),partyLevel=Math.abs(Math.trunc(Number(htmlQuery(html2,"[name=party-level]")?.value||1)));localStorage.setItem("xpMacroPartySize",partySize.toString()),localStorage.setItem("xpMacroPartyLevel",partyLevel.toString()),showXP(partyLevel,partySize,npcLevels,hazards)},"callback")}},default:"yes"}).render(!0)}__name(askPartyLevelAndSize,"askPartyLevelAndSize"),__name2(askPartyLevelAndSize,"askPartyLevelAndSize");function xpFromEncounter(){const actors=canvas.tokens.controlled.flatMap(a=>a.actor??[]).filter(a=>!a.traits.has("minion")),npcLevels=getLevels(actors,"opposition"),pcLevels=getLevels(actors,"party"),hazards=getHazards(actors);if(npcLevels.length===0&&hazards.length===0){ui.notifications.error("You must select at least one opposition and/or hazard token and optionally all PC tokens");return}pcLevels.length===0?askPartyLevelAndSize(npcLevels,hazards):showXP(pcLevels[0],pcLevels.length,npcLevels,hazards)}__name(xpFromEncounter,"xpFromEncounter"),__name2(xpFromEncounter,"xpFromEncounter");const xpVariantCreatureDifferences=new Map([[-7,9],[-6,12],[-5,14],[-4,18],[-3,21],[-2,26],[-1,32],[0,40],[1,48],[2,60],[3,72],[4,90],[5,108],[6,135],[7,160]]),xpCreatureDifferences=new Map([[-4,10],[-3,15],[-2,20],[-1,30],[0,40],[1,60],[2,80],[3,120],[4,160]]),xpSimpleHazardDifferences=new Map([[-4,2],[-3,3],[-2,4],[-1,6],[0,8],[1,12],[2,16],[3,24],[4,32]]);function getXPFromMap(partyLevel,entityLevel,values){const difference=entityLevel+1-(partyLevel+1),range=Math.floor(values.size/2),boundedDifference=Math.clamp(difference,0-range,range);return values.get(boundedDifference)??0}__name(getXPFromMap,"getXPFromMap"),__name2(getXPFromMap,"getXPFromMap");function calculateCreatureXP(partyLevel,npcLevel,dcOptions){return dcOptions.pwol?getXPFromMap(partyLevel,npcLevel,xpVariantCreatureDifferences):getXPFromMap(partyLevel,npcLevel,xpCreatureDifferences)}__name(calculateCreatureXP,"calculateCreatureXP"),__name2(calculateCreatureXP,"calculateCreatureXP");function getHazardXp(partyLevel,hazard,dcOptions){return hazard.isComplex?calculateCreatureXP(partyLevel,hazard.level,dcOptions):getXPFromMap(partyLevel,hazard.level,xpSimpleHazardDifferences)}__name(getHazardXp,"getHazardXp"),__name2(getHazardXp,"getHazardXp");function generateEncounterBudgets(partySize){const budget=partySize*20;return{trivial:Math.floor(budget*.5),low:Math.floor(budget*.75),moderate:budget,severe:Math.floor(budget*1.5),extreme:Math.floor(budget*2)}}__name(generateEncounterBudgets,"generateEncounterBudgets"),__name2(generateEncounterBudgets,"generateEncounterBudgets");const rewardEncounterBudgets=generateEncounterBudgets(4);function calculateEncounterRating(challenge,budgets){return challenge<=budgets.trivial?"trivial":challenge<=budgets.low?"low":challenge<=budgets.moderate?"moderate":challenge<=budgets.severe?"severe":"extreme"}__name(calculateEncounterRating,"calculateEncounterRating"),__name2(calculateEncounterRating,"calculateEncounterRating");function calculateXP(partyLevel,partySize,npcLevels,hazards,dcOptions){const creatureChallenge=npcLevels.map(level=>calculateCreatureXP(partyLevel,level,dcOptions)).reduce((a,b)=>a+b,0),hazardChallenge=hazards.map(hazard=>getHazardXp(partyLevel,hazard,dcOptions)).reduce((a,b)=>a+b,0),totalXP=creatureChallenge+hazardChallenge,encounterBudgets=generateEncounterBudgets(partySize),rating=calculateEncounterRating(totalXP,encounterBudgets),ratingXP=rewardEncounterBudgets[rating];return{partyLevel,partySize,totalXP,encounterBudgets,rating,ratingXP,xpPerPlayer:Math.floor(totalXP/partySize*4)}}__name(calculateXP,"calculateXP"),__name2(calculateXP,"calculateXP");class EncounterPF2e extends Combat{static{__name(this,"EncounterPF2e")}static{__name2(this,"EncounterPF2e")}_sortCombatants(a,b){const resolveTie=__name2(()=>{const[priorityA,priorityB]=[a,b].map(c=>c.overridePriority(c.initiative??0)??c.actor?.initiative?.tiebreakPriority??3);return priorityA===priorityB?a.id.localeCompare(b.id):priorityA-priorityB},"resolveTie");return typeof a.initiative=="number"&&typeof b.initiative=="number"&&a.initiative===b.initiative?resolveTie():super._sortCombatants(a,b)}getCombatantWithHigherInit(a,b){const sortResult=this._sortCombatants(a,b);return sortResult>0?b:sortResult<0?a:null}analyze(){if(!game.ready)return null;const{party}=game.actors,partyMembers=party?.members.filter(a=>a.alliance==="party"&&isReallyPC(a))??[],fightyPartyMembers=(()=>{const inEncounter=partyMembers.filter(m=>m.combatant?.encounter===this);return inEncounter.length>0?inEncounter:partyMembers})(),opposition=n(this.combatants.filter(c=>!!(c.actor?.alliance==="opposition"||c.actor?.isOfType("hazard"))&&!partyMembers.includes(c.actor)).flatMap(c=>c.actor??[]));if(!party||fightyPartyMembers.length===0||opposition.length===0)return null;const partyLevel=Math.round(t$h(fightyPartyMembers.filter(m=>m.isOfType("character")),m=>m.level)),result=calculateXP(partyLevel,fightyPartyMembers.length,opposition.filter(e2=>e2.isOfType("character","npc")).map(e2=>e2.level),opposition.filter(e2=>e2.isOfType("hazard")),{pwol:game.pf2e.settings.variants.pwol.enabled}),threat=result.rating,budget={spent:result.totalXP,max:result.encounterBudgets[threat],partyLevel},award={xp:Math.floor(result.xpPerPlayer*(fightyPartyMembers.length/partyMembers.length)),recipients:partyMembers};return{threat,budget,award,participants:{party:fightyPartyMembers,opposition}}}prepareDerivedData(){super.prepareDerivedData(),this.metrics=this.analyze()}async createEmbeddedDocuments(embeddedName,data,operation={}){const createData=data.filter(datum=>{const token=canvas.tokens.placeables.find(canvasToken=>canvasToken.id===datum.tokenId);if(!token)return!1;const{actor}=token;if(!actor)return ui.notifications.warn(`${token.name} has no associated actor.`),!1;const actorTraits=actor.system.traits?.value??[];if(actor.type==="loot"||["minion","eidolon"].some(t2=>actorTraits.includes(t2))){const actorTypes2=CONFIG.PF2E.actorTypes,type2=game.i18n.localize(actorTraits.includes("minion")?CONFIG.PF2E.creatureTraits.minion:actorTraits.includes("eidolon")?CONFIG.PF2E.creatureTraits.eidolon:actorTypes2[actor.type]);return ui.notifications.info(game.i18n.format("PF2E.Encounter.ExcludingFromInitiative",{type:type2,actor:actor.name})),!1}return!0});return super.createEmbeddedDocuments(embeddedName,createData,operation)}async rollInitiative(ids,options={}){const extraRollOptions=options.extraRollOptions??[],rollMode=options.messageOptions?.rollMode??options.rollMode;options.secret&&extraRollOptions.push("secret");const fightyCombatants=ids.flatMap(id=>this.combatants.get(id)??[]).filter(c=>!!c.actor?.initiative),initiatives=(await Promise.all(fightyCombatants.map(async combatant=>combatant.actor?.initiative?.roll({...options,combatant,extraRollOptions,updateTracker:!1,rollMode})??null))).flatMap(result=>result?{id:result.combatant.id,value:result.roll.total,statistic:result.roll.options.domains?.find(s=>s in CONFIG.PF2E.skills||s==="perception")??null}:[]);await this.setMultipleInitiatives(initiatives);const remainingIds=ids.filter(id=>!fightyCombatants.some(c=>c.id===id));return super.rollInitiative(remainingIds,options)}async setMultipleInitiatives(initiatives){const currentId=this.combatant?.id,updates=initiatives.map(i=>({_id:i.id,initiative:i.value,flags:{pf2e:{initiativeStatistic:i.statistic??null,overridePriority:{[i.value]:i.overridePriority}}}}));await this.updateEmbeddedDocuments("Combatant",updates),this.turn!==null&&await this.update({turn:this.turns.findIndex(c=>c.id===currentId)})}async setInitiative(id,value,statistic=null){const combatant=this.combatants.get(id,{strict:!0});if(combatant.actor?.isOfType("character","npc"))return this.setMultipleInitiatives([{id:combatant.id,value,statistic:objectHasKey(CONFIG.PF2E.skills,statistic)||statistic==="perception"?statistic:combatant.actor.system.initiative.statistic||"perception"}]);super.setInitiative(id,value)}async resetActors(){const actors=n(this.combatants.contents.flatMap(c=>[c.actor,c.actor?.isOfType("character")?c.actor.familiar:null]).filter(e$6));resetActors(actors,{sheets:!1,tokens:!0})}_onCreate(data,options,userId){super._onCreate(data,options,userId);const pcSheets=Object.values(ui.windows).filter(sheet=>sheet.constructor.name==="CharacterSheetPF2e");for(const sheet of pcSheets)sheet.toggleInitiativeLink()}_onUpdate(changed,options,userId){super._onUpdate(changed,options,userId),game.pf2e.StatusEffects.onUpdateEncounter(this);const{combatant,previous}=this,actor=combatant?.actor;if(!this.started)return;const[newRound,newTurn]=[changed.round,changed.turn],isRoundChange=typeof newRound=="number",isTurnChange=typeof newTurn=="number",isNextRound=isRoundChange&&(previous.round===null||newRound>previous.round),isNextTurn=isTurnChange&&(previous.turn===null||newTurn>previous.turn);(isRoundChange||isTurnChange)&&Promise.resolve().then(async()=>{if(isNextRound||isNextTurn){const previousCombatant=this.combatants.get(previous.combatantId??"");if(game.user===previousCombatant?.actor?.primaryUpdater){const alreadyWent=previousCombatant.flags.pf2e.roundOfLastTurnEnd===previous.round;typeof previous.round=="number"&&!alreadyWent&&await previousCombatant.endTurn({round:previous.round})}if(game.user===actor?.primaryUpdater){const alreadyWent=combatant?.roundOfLastTurn===this.round;combatant&&!alreadyWent&&await combatant.startTurn()}for(const otherCombatant of this.combatants)combatant!==otherCombatant&&otherCombatant.actor?.recharge({duration:"turn"})}this.resetActors(),await game.pf2e.effectTracker.refresh(),game.pf2e.effectPanel.refresh()})}_onDelete(options,userId){if(this.turn=null,super._onDelete(options,userId),this.started&&(Hooks.callAll("pf2e.endTurn",this.combatant??null,this,userId),game.pf2e.effectTracker.onEncounterEnd(this)),!game.combat){const pcSheets=Object.values(ui.windows).filter(sheet=>sheet.constructor.name==="CharacterSheetPF2e");for(const sheet of pcSheets)sheet.toggleInitiativeLink()}game.user.clearTargets(),this.resetActors()}async _onEndTurn(combatant){await super._onEndTurn(combatant),await this.clearMovementHistories()}}class CombatantPF2e extends Combatant{static{__name(this,"CombatantPF2e")}static{__name2(this,"CombatantPF2e")}static async createDocuments(data=[],operation={}){return this.#swapPartyForMembers(data,operation),super.createDocuments(data,operation)}static#swapPartyForMembers(data,operation){for(const datum of[...data]){const actor=game.actors.get(datum.actorId??""),scene=game.scenes.get(datum.sceneId??"");if(!(!scene||!actor?.isOfType("party"))){data.findSplice(d=>d.actorId===actor.id);for(const member of actor.members){const token=member.getDependentTokens({scenes:[scene],linked:!0}).at(0),alreadyAdded=operation.parent?.combatants.some(c=>c.actor===member),validInEncounter=!member.system.traits.value.some(t2=>["minion","eidolon"].includes(t2)),alreadyBeingAdded=data.some(d=>d.actorId===member.id);token&&!alreadyAdded&&!alreadyBeingAdded&&validInEncounter&&data.push({actorId:member.id,sceneId:scene.id,tokenId:token.id,hidden:!!datum.hidden})}}}}static async fromActor(actor,render=!0,options={}){if(!game.combat)return ui.notifications.error(game.i18n.localize("PF2E.Encounter.NoActiveEncounter")),null;const token=actor.getActiveTokens().pop(),existing=game.combat.combatants.find(combatant=>combatant.actor===actor);return existing||(token?(await(options.combat??game.combat).createEmbeddedDocuments("Combatant",[{tokenId:token.id,actorId:token.actor?.id,sceneId:token.scene.id,hidden:token.document.hidden}],{render})).at(0)??null:(ui.notifications.error(game.i18n.format("PF2E.Encounter.NoTokenInScene",{actor:actor.name})),null))}get encounter(){return this.parent}get roundOfLastTurn(){return this.flags.pf2e.roundOfLastTurn}get playersCanSeeName(){return!!this.token?.playersCanSeeName}overridePriority(initiative){return this.flags.pf2e.overridePriority[initiative]??null}hasHigherInitiative({than}){if(this.parent.id!==than.parent.id)throw ErrorPF2e("The initiative of Combatants from different combats cannot be compared");return this.parent.getCombatantWithHigherInit(this,than)===this}async startTurn(){const{actor,encounter}=this;if(!encounter||!actor)return;this.update({"flags.pf2e.roundOfLastTurn":encounter.round},{render:!1});const eventType="turn-start";await this.#performActorUpdates(eventType);for(const effect of actor.itemTypes.effect)await effect.onEncounterEvent(eventType);if(actor.isOfType("character")&&actor.familiar)for(const effect of actor.familiar.itemTypes.effect)await effect.onEncounterEvent(eventType);Hooks.callAll("pf2e.startTurn",this,encounter,game.user.id)}async endTurn(options){const round=options.round,{actor,encounter}=this;if(!encounter||!actor)return;if(!actor.isDead){const activeConditions=actor.conditions.active;for(const condition of activeConditions)await condition.onEndTurn({token:this.token})}const eventType="turn-end";for(const effect of actor.itemTypes.effect)await effect.onEncounterEvent(eventType);if(actor.isOfType("character")&&actor.familiar)for(const effect of actor.familiar.itemTypes.effect)await effect.onEncounterEvent(eventType);await this.update({"flags.pf2e.roundOfLastTurnEnd":round}),Hooks.callAll("pf2e.endTurn",this,encounter,game.user.id)}prepareBaseData(){super.prepareBaseData(),this.flags.pf2e=foundry.utils.mergeObject(this.flags.pf2e??{},{overridePriority:{}}),this.flags.pf2e.roundOfLastTurn??=null,this.flags.pf2e.initiativeStatistic??=null}async toggleDefeated({to=!this.isDefeated,overlayIcon=!0}={}){to!==this.isDefeated&&(await this.update({defeated:to}),overlayIcon&&await this.token?.actor?.toggleStatusEffect("dead",{overlay:!0}),this.isDefeated&&this.token?.object?.isTargeted&&this.token.object.setTarget(!1,{releaseOthers:!1}))}updateResource(){return this.isNPC&&!game.user.isGM?this.resource=null:super.updateResource()}_getInitiativeFormula(){const actor=this.actor,modifier=actor?.initiative?.mod??actor?.perception?.mod??0;return modifier<0?`1d20${modifier}`:`1d20+${modifier}`}async toggleNameVisibility(){if(!this.token)return;const currentVisibility=this.token.displayName,visibilityToggles={[CONST.TOKEN_DISPLAY_MODES.ALWAYS]:CONST.TOKEN_DISPLAY_MODES.OWNER,[CONST.TOKEN_DISPLAY_MODES.CONTROL]:CONST.TOKEN_DISPLAY_MODES.HOVER,[CONST.TOKEN_DISPLAY_MODES.HOVER]:CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,[CONST.TOKEN_DISPLAY_MODES.NONE]:CONST.TOKEN_DISPLAY_MODES.HOVER,[CONST.TOKEN_DISPLAY_MODES.OWNER]:CONST.TOKEN_DISPLAY_MODES.ALWAYS,[CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER]:CONST.TOKEN_DISPLAY_MODES.HOVER};await this.token.update({displayName:visibilityToggles[currentVisibility]})}async#performActorUpdates(event2){const actor=this.actor;if(!actor)return;const actorUpdates={};for(const rule of actor.rules??[])await rule.onUpdateEncounter?.({event:event2,actorUpdates});await actor.update(actorUpdates),event2==="turn-start"&&await actor.recharge({duration:"round"})}_onUpdate(changed,options,userId){if(super._onUpdate(changed,options,userId),typeof changed.initiative=="number"&&(this.encounter?.started&&this.encounter.resetActors(),userId===game.user.id)){const eventType="initiative-roll";this.#performActorUpdates(eventType).then(()=>{for(const effect of this.actor?.itemTypes.effect??[])effect.onEncounterEvent(eventType)})}if(changed.defeated&&game.user.id===userId)for(const action2 of this.actor?.itemTypes.action??[])action2.system.deathNote&&action2.toMessage(void 0,{rollMode:this.actor?.hasPlayerOwner?"publicroll":"gmroll"})}_onDelete(options,userId){super._onDelete(options,userId),this.encounter?.started&&this.encounter.resetActors()}}async function preImportJSON(json2){const source2=JSON.parse(json2);if(!e$2(source2)||("data"in source2&&("items"in source2?ActorPF2e.migrateData(source2):ItemPF2e.migrateData(source2)),!e$2(source2.system))||(e$2(source2.system.schema)&&!e$2(source2.system._migration)&&(source2.system._migration={version:Number(source2.system.schema.version)||null},delete source2.system.schema),!e$2(source2.system._migration)))return null;const sourceSchemaVersion=Number(source2.system?._migration?.version)||0,worldSchemaVersion=MigrationRunnerBase.LATEST_SCHEMA_VERSION;if(foundry.utils.isNewerVersion(sourceSchemaVersion,worldSchemaVersion))return ui.notifications.error(game.i18n.format("PF2E.ErrorMessage.CantImportTooHighVersion",{sourceName:game.i18n.localize("DOCUMENT.Actor"),sourceSchemaVersion,worldSchemaVersion})),null;const Cls="items"in source2&&Array.isArray(source2.items)?ActorProxyPF2e:ItemProxyPF2e,newDoc=new Cls(source2),migrations=MigrationList.constructFromVersion(newDoc.schemaVersion);return await MigrationRunner.ensureSchemaVersion(newDoc,migrations),JSON.stringify(newDoc.toObject())}__name(preImportJSON,"preImportJSON"),__name2(preImportJSON,"preImportJSON");function combatantAndTokenDoc(document2){return document2 instanceof CombatantPF2e?{combatant:document2,tokenDoc:document2.token}:{combatant:document2.combatant,tokenDoc:document2}}__name(combatantAndTokenDoc,"combatantAndTokenDoc"),__name2(combatantAndTokenDoc,"combatantAndTokenDoc");function applyIWR(actor,roll,rollOptions){if(actor.isDead)return{finalDamage:0,applications:[],persistent:[]};if(!game.pf2e.settings.iwr)return{finalDamage:roll.total,applications:[],persistent:roll.instances.filter(i=>i.persistent&&!i.options.evaluatePersistent)};const{immunities,weaknesses,resistances}=actor.attributes,instances=roll.instances,persistent=[],ignoredResistances=roll.options.bypass?.resistance.ignore.map(ir=>new Resistance({type:ir.type,value:ir.max}))??[],irRedirects={immunities:roll.options.bypass?.immunity.redirect??[],resistances:roll.options.bypass?.resistance.redirect??[]},applyOnceWeaknesses=weaknesses.filter(w=>w.applyOnce&&instances.some(i=>w.test([...i.formalDescription,...rollOptions]))),damageWeaknesses=weaknesses.filter(w=>!applyOnceWeaknesses.includes(w)),applications2=instances.flatMap(instance=>{const formalDescription=new Set([...instance.formalDescription,...rollOptions]),wasIncreased=instance.total<=0&&typeof roll.options.increasedFrom=="number",isFirst=instances.indexOf(instance)===0,instanceTotal=wasIncreased&&isFirst?1:Math.max(instance.total,0);if(!actor.isAffectedBy(instance.type))return[{category:"unaffected",type:instance.type,adjustment:-1*instanceTotal}];const applicableImmunities=immunities.filter(i=>i.type!=="critical-hits"&&i.test(formalDescription)),appliedImmunity=applicableImmunities.find(i=>!hasImmunityRedirection(i,immunities,irRedirects.immunities));if(appliedImmunity)return[{category:"immunity",type:appliedImmunity.label,adjustment:-1*instanceTotal}];const instanceApplications=[];let redirectedFromImmunity=null;for(const immunity of applicableImmunities){const redirect=irRedirects.immunities.find(ir=>hasImmunityRedirection(immunity,immunities,[ir])),redirectLabel=redirect?new Immunity({type:redirect.to}).typeLabel:"???";redirect&&(redirectedFromImmunity=redirect.to),instanceApplications.push({category:"immunity",type:immunity.typeLabel,adjustment:0,redirect:redirectLabel})}const critImmunity=immunities.find(i=>i.type==="critical-hits"&&i.test(formalDescription)),isCriticalSuccess=roll.options.degreeOfSuccess===DEGREE_OF_SUCCESS.CRITICAL_SUCCESS,critImmuneTotal=instance.critImmuneTotal,critImmunityApplies=isCriticalSuccess&&!!critImmunity&&critImmuneTotal<instanceTotal;critImmunityApplies&&instanceApplications.push({category:"immunity",type:critImmunity.label,adjustment:-1*(instanceTotal-critImmuneTotal)});const precisionImmunity=immunities.find(i=>i.type==="precision"),precisionDamage=critImmunityApplies?Math.floor(instance.componentTotal("precision")/2):instance.componentTotal("precision");if(precisionDamage>0&&precisionImmunity?.test([...formalDescription,"damage:component:precision"])){const maxReducible=critImmunityApplies?critImmuneTotal:instanceTotal;maxReducible>0&&instanceApplications.push({category:"immunity",type:precisionImmunity.applicationLabel,adjustment:-1*Math.min(precisionDamage,maxReducible)})}const afterImmunities=Math.max(instanceTotal+instanceApplications.reduce((sum,a)=>sum+a.adjustment,0),0);if(instance.persistent&&!instance.options.evaluatePersistent&&persistent.push(instance),afterImmunities===0)return instanceApplications;const mainWeaknesses=damageWeaknesses.filter(w=>w.test(formalDescription)),splashWeakness=instance.componentTotal("splash")?weaknesses.find(w=>w.type==="splash-damage")??null:null,precisionWeakness=precisionDamage>0?weaknesses.find(r2=>r2.type==="precision"&&r2.test([...formalDescription,"damage:component:precision"])):null,highestWeakness=[...mainWeaknesses,precisionWeakness,splashWeakness].filter(e$1).reduce((highest,w)=>w&&!highest||w&&highest&&w.value>highest.value?w:highest,null);highestWeakness&&instanceApplications.push({category:"weakness",type:highestWeakness.applicationLabel,adjustment:highestWeakness.value});const afterWeaknesses=afterImmunities+(highestWeakness?.value??0),workingResistanceData=resistances.map(r2=>new WorkingResistanceData(r2,{applicable:r2.test(formalDescription)&&!applicableImmunities.some(i=>i.type===r2.type&&i.exceptions.every(e2=>tupleHasValue(r2.exceptions,e2))),value:r2.getDoubledValue(formalDescription),ignored:ignoredResistances.some(ir=>ir.test(formalDescription))})),applicableResistances=workingResistanceData.filter(r2=>r2.applicable),criticalResistance=resistances.find(r2=>r2.type==="critical-hits");if(criticalResistance&&isCriticalSuccess){const maxResistable=instanceTotal-critImmuneTotal;maxResistable>0&&applicableResistances.push(new WorkingResistanceData(criticalResistance,{value:Math.min(criticalResistance.getDoubledValue(formalDescription),maxResistable),ignored:ignoredResistances.some(ir=>ir.test(formalDescription))}))}const precisionResistance=(()=>{const resistance=precisionDamage>0&&!precisionImmunity?resistances.find(r2=>r2.type==="precision"&&r2.test([...formalDescription,"damage:component:precision"])):null;return resistance?new WorkingResistanceData(resistance,{value:Math.min(resistance.getDoubledValue(formalDescription),precisionDamage)}):null})();precisionResistance&&applicableResistances.push(precisionResistance);const highestResistance=applicableResistances.filter(r2=>!r2.ignored).reduce((highest,r2)=>r2&&!highest||r2&&highest&&r2.value>highest.value?r2:highest,null),highestIgnored=applicableResistances.filter(r2=>r2.ignored).reduce((highest,r2)=>r2&&(!highest||highest&&r2.value>highest.value)?r2:highest,null),resistanceRedirect=getResistanceRedirection({immunities,resistances:workingResistanceData,highest:applicableImmunities.at(0)??highestResistance,redirects:irRedirects.resistances}),finalResistance=highestResistance??resistanceRedirect?.resistance;if(finalResistance?.value){const application={category:"resistance",type:finalResistance.label,adjustment:-1*Math.min(afterWeaknesses,finalResistance.value),ignored:!1};resistanceRedirect&&(application.adjustment=-1*Math.min(afterWeaknesses,resistanceRedirect.resistance?.value??0),resistanceRedirect.redirect.to!==redirectedFromImmunity&&(application.redirect=new Resistance({type:resistanceRedirect.redirect.to,value:0}).typeLabel)),instanceApplications.push(application)}else highestIgnored&&instanceApplications.push({category:"resistance",type:ignoredResistances.find(ir=>ir.test(formalDescription))?.typeLabel??"???",adjustment:0,ignored:!0});return instanceApplications}).concat(...applyOnceWeaknesses.map(w=>({category:"weakness",type:w.typeLabel,adjustment:w.value}))).sort((a,b)=>{if(a.category===b.category)return 0;switch(a.category){case"unaffected":return-1;case"immunity":return b.type==="unaffected"?1:-1;case"weakness":return["unaffected","immunity"].includes(b.category)?1:-1;default:return 1}}),adjustment=applications2.reduce((sum,a)=>sum+a.adjustment,0);return{finalDamage:Math.max(roll.total+adjustment,0),applications:applications2,persistent}}__name(applyIWR,"applyIWR"),__name2(applyIWR,"applyIWR");class WorkingResistanceData{static{__name(this,"WorkingResistanceData")}static{__name2(this,"WorkingResistanceData")}resistance;applicable;value;ignored;constructor(resistance,options){this.resistance=resistance,this.applicable=options.applicable??!0,this.value=options.value,this.ignored=options.ignored??!1}get type(){return this.resistance.type}get label(){return this.resistance.applicationLabel}}function hasImmunityRedirection(testImmunity,immunities,redirections){return redirections.some(redirect=>{const categoryFrom=DamageCategorization.fromDamageType(redirect.from),categoryTo=DamageCategorization.fromDamageType(redirect.to);return testImmunity.test([`damage:type:${redirect.from}`,`damage:category:${categoryFrom}`])&&!immunities.some(i=>i.test([`damage:type:${redirect.to}`,`damage:category:${categoryTo}`]))})}__name(hasImmunityRedirection,"hasImmunityRedirection"),__name2(hasImmunityRedirection,"hasImmunityRedirection");function getResistanceRedirection(params){const{immunities,resistances,highest,redirects}=params;if(!highest)return null;const createDefinition=__name2(type2=>[`damage:type:${type2}`,`damage:category:${DamageCategorization.fromDamageType(type2)}`],"createDefinition"),applicableRedirects=redirects.filter(redirect=>{const toDefinition=createDefinition(redirect.to);return redirect.from===highest.type&&redirect.to!==highest.type&&!immunities.some(i=>i.test(toDefinition))}),highestValue=highest instanceof Immunity?1/0:highest.value;return applicableRedirects.reduce((bestMatch,redirect)=>{if(bestMatch&&!bestMatch.resistance)return bestMatch;const toDefinition=createDefinition(redirect.to),redirectTarget=resistances.find(r2=>!r2.ignored&&r2.resistance.test(toDefinition))??null,redirectReduction=redirectTarget?.value??0,mostReduction=Math.min(highestValue,bestMatch?.resistance?.value??1/0);return redirectReduction<mostReduction?{redirect,resistance:redirectTarget}:bestMatch},null)}__name(getResistanceRedirection,"getResistanceRedirection"),__name2(getResistanceRedirection,"getResistanceRedirection");class ActorConditions extends DelegatedCollection{static{__name(this,"ActorConditions")}static{__name2(this,"ActorConditions")}#slugMap=new Collection;#finalized=!1;#conditionsHad=new Set;get active(){return this.filter(c=>c.active)}get stored(){return this.filter(c=>!c.inMemoryOnly)}get clumsy(){return this.bySlug("clumsy",{active:!0}).shift()??null}get cursebound(){return this.bySlug("cursebound",{active:!0}).shift()??null}get doomed(){return this.bySlug("doomed",{active:!0}).shift()??null}get drained(){return this.bySlug("drained",{active:!0}).shift()??null}get dying(){return this.bySlug("dying",{active:!0}).shift()??null}get enfeebled(){return this.bySlug("enfeebled",{active:!0}).shift()??null}get frightened(){return this.bySlug("frightened",{active:!0}).shift()??null}get sickened(){return this.bySlug("sickened",{active:!0}).shift()??null}get slowed(){return this.bySlug("slowed",{active:!0}).shift()??null}get stunned(){return this.bySlug("stunned",{active:!0}).shift()??null}get stupefied(){return this.bySlug("stupefied",{active:!0}).shift()??null}get wounded(){return this.bySlug("wounded",{active:!0}).shift()??null}hasType(slug){return this.#finalized?this.#conditionsHad.has(slug):this.bySlug(slug,{active:!0}).length>0}finalize(){this.#conditionsHad=new Set(this.active.map(c=>c.slug)),this.#finalized=!0}get(key,{strict=!1,active=null,temporary=null}={}){const condition=super.get(key,{strict});if(!(active===!0&&!condition?.active)&&!(active===!1&&condition?.active)&&!(temporary===!0&&condition?.actor.items.has(key))&&!(temporary===!1&&!condition?.actor.items.has(key)))return condition}set(id,condition){super.set(id,condition);const listBySlug=this.#slugMap.get(condition.slug)??[];return listBySlug.push(condition),this.#slugMap.set(condition.slug,listBySlug),this}every(condition){return this.contents.every(condition)}delete(){return!1}bySlug(slug,{active=null,temporary=null}={}){return(this.#slugMap.get(slug)??[]).filter(condition=>{const activeFilterSatisfied=active===!0?condition.active:active===!1?!condition.active:!0,temporaryFilterSatisfied=temporary===!0?!condition.actor.items.has(condition.id):temporary===!1?condition.actor.items.has(condition.id):!0;return activeFilterSatisfied&&temporaryFilterSatisfied})}}var VisionLevels=(VisionLevels2=>(VisionLevels2[VisionLevels2.BLINDED=0]="BLINDED",VisionLevels2[VisionLevels2.NORMAL=1]="NORMAL",VisionLevels2[VisionLevels2.LOWLIGHT=2]="LOWLIGHT",VisionLevels2[VisionLevels2.DARKVISION=3]="DARKVISION",VisionLevels2))(VisionLevels||{});class InventoryBulk{static{__name(this,"InventoryBulk")}static{__name2(this,"InventoryBulk")}actor;#value=null;encumberedAfterAddend=0;maxAddend=0;constructor(actor){this.actor=actor}get#actorStrength(){return this.actor.isOfType("character","npc")?this.actor.abilities.str.mod:1/0}get encumberedAfter(){return Math.floor(this.#actorStrength+5+this.encumberedAfterAddend)}get encumberedAfterBreakdown(){const addend=this.encumberedAfterAddend,stat=game.i18n.localize(CONFIG.PF2E.abilities.str);return`5 + ${this.#actorStrength} (${stat})`+(addend?` + ${addend}`:"")}get max(){return Math.floor(this.#actorStrength+10+this.maxAddend)}get maxBreakdown(){const addend=this.maxAddend,stat=game.i18n.localize(CONFIG.PF2E.abilities.str);return`10 + ${this.#actorStrength} (${stat})`+(addend?` + ${addend}`:"")}get value(){return this.#value?this.#value:(this.#value=InventoryBulk.computeTotalBulk(this.actor.inventory.filter(i=>!i.isInContainer),this.actor),this.#value)}get encumberedPercentage(){const totalTimes10=this.value.toLightUnits(),encumberedAtTimes10=this.encumberedAfter*10+10;return Math.floor(totalTimes10/encumberedAtTimes10*100)}get maxPercentage(){const totalTimes10=this.value.toLightUnits(),limitTimes10=this.max*10+10;return Math.floor(totalTimes10/limitTimes10*100)}get maxPercentageInteger(){return this.maxPercentage>100?100:this.maxPercentage}get isEncumbered(){return this.value.normal>this.encumberedAfter}get isOverMax(){return this.value.normal>this.max}get bulk(){return this.value.normal}static computeTotalBulk(items,actor){items=this.#flattenNonStowing(items);const nonStackingItems=items.filter(i=>i.isOfType("backpack")||i.system.bulk.per===1&&i.system.baseItem),nonStackingIds=new Set(nonStackingItems.map(i=>i.id)),stackingItems=items.filter(i=>!nonStackingIds.has(i.id)),withSubitems=__name2(i=>i.subitems.reduce((total,subitem)=>total.plus(subitem.bulk),i.bulk),"withSubitems"),baseBulk=nonStackingItems.map(i=>withSubitems(i)).reduce((first,second)=>first.plus(second),new Bulk),stackingBehaviors=stackingItems.map(item=>({per:item.system.bulk.per,item,group:item.system.baseItem,bulk:actor?.isOfType("creature")?new Bulk(item.system.bulk.value).convertToSize(item.size,actor.size):new Bulk(item.system.bulk.value)})),bulks=[...groupBy(stackingBehaviors,d=>`${d.group}-${d.per}-${d.bulk.toLightUnits()}`).values()].map(dataEntries=>{const{bulk,per}=dataEntries[0],quantity=dataEntries.map(entry=>entry.item.quantity).reduce((sum,value)=>sum+value,0),bulkRelevantQuantity=Math.floor(quantity/per);return bulk.times(bulkRelevantQuantity)});return baseBulk.plus(bulks.reduce((first,second)=>first.plus(second),new Bulk))}static#flattenNonStowing(items){return items.map(item=>item.isOfType("backpack")&&!item.stowsItems?this.#flattenNonStowing(item.contents.contents):item).flat()}}const _id$1="penfpVFkOqZYpmkU",img$1="icons/sundries/gaming/playing-cards-grey.webp",name$1="Credstick",system$1={slug:"credstick",baseItem:null,bulk:{value:0},category:"credstick",containerId:null,description:{value:`<p>Most people in Starfinder keep their wealth on a protected item known as a credstick. These devices are often flat and roughly the size of a human finger. They range in dimensions and quality, but at the end of the day, they\u2019re just a means of conveniently carrying and spending money. Usage of these devices is determined by the owner, and a credstick can accept or spend funds with as simple an action as tapping it near a suitable banking device. When more rigorous security is necessary, they can require audio or biometric imprints in order to activate. Some advanced credsticks even have a magical component that might require a mental password or the recitation of a specific spell to access stored funds.</p>
<p>Credsticks aren\u2019t gateways to the entirety of one\u2019s wealth, and larger stores of credits are often kept secured in banks, personal vaults, or secure databases. Instead, a credstick is a safe and anonymous means of moving credits around without being traced. Adventurers and common citizens alike often keep a credstick on their person to handle any purchases they might be called upon to make, while also only keeping just enough credits on them that losing the credstick wouldn\u2019t result in bankruptcy.</p>
<p>Individuals in the Pact Worlds often carry credsticks, and other civilizations that interact with the Pact often turn local funds into credits and thus carry them to spend their converted currency. Sometimes a person might carry several credsticks, dedicating each one to a different use, or simply trading the stick away if they want to make a purchase of a predefined amount. If ever the number of credsticks on a person becomes too cumbersome, it\u2019s easy enough to move the funds between individual sticks and discard emptied sticks to save on space, however a credstick always has a negligible bulk.</p>`},hardness:0,hp:{max:0,value:0},level:{value:0},material:{grade:null,type:null},price:{per:1,value:{sp:1}},publication:{license:"ORC",remaster:!0,title:"Starfinder Player Core"},quantity:1,rules:[],size:"med",temporary:!1,traits:{rarity:"common",value:[]}},type$1="treasure",credstickJSON={_id:_id$1,img:img$1,name:name$1,system:system$1,type:type$1},_id="ALqTYbYspMMrJIDs",img="systems/pf2e/icons/equipment/treasure/currency/upb.webp",name="UPB",system={slug:"upb",baseItem:null,bulk:{value:1},category:"material",containerId:null,description:{value:`<p>A universal polymer base, or UPB, is a tiny multifunction component, not much larger than a grain of rice. Used in the crafting of most common galactic goods, UPBs can be configured to act as a brace, capacitor, circuit, diode, fastener, insulator, lens, modulator, pipe, resistor, and dozens of other constituent parts. UPBs can even be spun out into fabric, broken down into component chemicals, reconstituted into new chemicals, or supplemented with base materials (such as dirt or sand) to form massive braces or walls. The right combination of hundreds or even thousands of UPBs can create everything from a comm unit to a laser weapon to powered armor. In their raw form, UPBs have a bulk of 1 per 1,000 UPBs.</p>
<p>UPBs are so common that they\u2019re used as currency in many major settlements and trade hubs. While credsticks are a more convenient and secure way to carry value, UPBs have the advantage of direct utility and untraceability.</p>
<p>Characters can use UPBs in place of credits for crafting items using maker\u2019s kits; in fact, they\u2019re necessary for the use of certain tools.</p>`},hardness:0,hp:{max:0,value:0},level:{value:0},material:{grade:null,type:null},price:{per:1,value:{sp:1}},publication:{license:"ORC",remaster:!0,title:"Starfinder Player Core"},quantity:1,rules:[],size:"med",temporary:!1,traits:{rarity:"common",value:[]}},type="treasure",upbJSON={_id,img,name,system,type};class ActorInventory extends DelegatedCollection{static{__name(this,"ActorInventory")}static{__name2(this,"ActorInventory")}actor;bulk;constructor(actor,entries){super(entries?.map(entry=>[entry.id,entry])),this.actor=actor,this.bulk=new InventoryBulk(this.actor)}get coins(){return this.currency}get currency(){return this.filter(i=>i.isOfType("treasure")&&i.isCurrency).map(item=>item.assetValue).reduce((first,second)=>first.plus(second),new Coins)}get totalWealth(){return this.filter(item=>game.user.isGM||item.isIdentified).map(item=>item.assetValue).reduce((first,second)=>first.plus(second),new Coins)}get invested(){return this.actor.isOfType("character")?{value:this.filter(i=>i.isInvested).length,max:this.actor.system.resources.investiture.max}:null}findStackableItem(item,{containerId=null}={}){const testItem=item instanceof PhysicalItemPF2e?item.clone():new ItemProxyPF2e(foundry.utils.deepClone(item));if(!testItem.isOfType("physical"))return null;const stackCandidates=this.filter(i=>(containerId?i.container?.id===containerId:!i.isInContainer)&&i.isStackableWith(testItem));if(stackCandidates.length>1){const notEquipped=stackCandidates.filter(item2=>!item2.isEquipped);return notEquipped.length>0?notEquipped[0]:stackCandidates[0]}else return stackCandidates.at(0)??null}addCoins(coins,options={}){return this.addCurrency(coins,options)}removeCoins(coins,options){return this.removeCurrency(coins,options)}async addCurrency(coins,{combineStacks=!0}={}){const topLevelCoins=this.actor.itemTypes.treasure.filter(item=>combineStacks&&item.isCurrency),coinsByDenomination=groupBy(topLevelCoins,item=>item.unit),updates=createActorGroupUpdate();for(const denomination of CURRENCY_TYPES){const quantity=coins[denomination]??0;if(quantity<=0)continue;const item=coinsByDenomination.get(denomination)?.at(0);if(item)if(denomination==="credits"){const newPrice=item.system.price.value.plus({credits:quantity});updates.itemUpdates.push({_id:item.id,"system.price.value":newPrice.toObject()})}else updates.itemUpdates.push({_id:item.id,"system.quantity":item.quantity+quantity});else{const source2=denomination==="upb"?foundry.utils.deepClone(upbJSON):denomination==="credits"?foundry.utils.deepClone(credstickJSON):(await fromUuid(coinCompendiumUuids[denomination]))?.toObject(!0)??null;if(source2?.type!=="treasure")throw ErrorPF2e("Unexpected error retrieving currency item");delete source2._id,source2.system??={},denomination==="credits"?(source2.system.price??={},source2.system.price.value={pp:void 0,gp:void 0,sp:quantity,cp:void 0}):source2.system.quantity=quantity,updates.itemCreates.push(source2)}}await applyActorGroupUpdate(this.actor,updates)}async removeCurrency(coins,{byValue=!0}={}){const actorCoins=this.currency,totalValueToRemove=new Coins(coins).copperValue;if(totalValueToRemove>actorCoins.copperValue)return!1;const removeResult=t$9(CURRENCY_TYPES,d=>[d,0]),addResult=t$9(CURRENCY_TYPES,d=>[d,0]);for(const type2 of CURRENCY_TYPES){const toRemove=Math.min(coins[type2]??0,actorCoins[type2]);removeResult[type2]=toRemove,actorCoins[type2]-=toRemove}let valueToRemove=totalValueToRemove-new Coins(removeResult).copperValue;if(valueToRemove&&!byValue)return!1;if(byValue&&valueToRemove){for(const[type2,rate]of t$f(DENOMINATION_RATES).toReversed()){const toRemove=Math.min(actorCoins[type2],Math.floor(valueToRemove/rate));toRemove&&(removeResult[type2]+=toRemove,actorCoins[type2]-=toRemove,valueToRemove-=toRemove*rate)}for(const[type2,rate]of t$f(t$3(DENOMINATION_RATES,["cp","sp","gp"])))if(valueToRemove/rate%10>actorCoins[type2]){const toRemove=valueToRemove/rate%10;valueToRemove+=(10-toRemove)*rate,addResult[type2]+=10,removeResult[type2]+=toRemove}else{const toRemove=valueToRemove/rate%10;valueToRemove-=toRemove*rate;const newValue=actorCoins[type2]-toRemove,extraCoins=Math.min(valueToRemove/rate,Math.trunc(newValue/10))*10;removeResult[type2]+=toRemove+extraCoins,valueToRemove-=extraCoins*rate}removeResult.pp=valueToRemove/1e3;for(const type2 of CURRENCY_TYPES){const min=Math.min(addResult[type2],removeResult[type2]);addResult[type2]-=min,removeResult[type2]-=min}}await this.addCoins(addResult);const moneyItems=this.actor.itemTypes.treasure.filter(item=>item.isCurrency),moneyByType=t$2(moneyItems,item=>item.unit??""),update=createActorGroupUpdate();for(const[type2,coinItems]of t$f(moneyByType))if(type2){for(const item of coinItems){if(removeResult[type2]===0)break;const moneyQuantity=type2==="credits"?item.system.price.value.credits:item.quantity;if(moneyQuantity>removeResult[type2]){type2==="credits"?update.itemUpdates.push({_id:item.id,"system.price.==value":{sp:moneyQuantity-removeResult[type2]}}):update.itemUpdates.push({_id:item.id,"system.quantity":item.quantity-removeResult[type2]}),removeResult[type2]=0;break}else removeResult[type2]-=moneyQuantity,update.itemDeletes.push(item.id)}removeResult[type2]>0&&console.warn("Attempted to remove more coinage than exists")}return await applyActorGroupUpdate(this.actor,update),!0}async sellAllTreasure(){const treasures=this.actor.itemTypes.treasure.filter(item=>!item.isCurrency),treasureIds=treasures.map(item=>item.id),coins=treasures.map(item=>item.assetValue).reduce((first,second)=>first.plus(second),new Coins);await this.actor.deleteEmbeddedDocuments("Item",treasureIds),await this.actor.inventory.addCurrency(coins)}async deleteTemporaryItems(operation){const actor=this.actor,specialResourceItems=Object.values(actor.synthetics.resources).map(r2=>r2.itemUUID).filter(i=>!!i);return this.#massDelete([...iterateAllItems(actor)].filter(i=>i.isOfType("physical")&&i.system.temporary&&(!!i.parentItem||!i.sourceId||!specialResourceItems.includes(i.sourceId))),operation)}async#massDelete(items,operation={}){const actor=this.actor,itemsToDelete=items.filter(i=>!i.parentItem).map(i=>i.id),subItemsToDelete=items.filter(i=>i.parentItem),render=operation?.render??!0;if(!itemsToDelete.length&&!subItemsToDelete.length)return[];const subItemDeleteGroups=Object.values(t$2(subItemsToDelete,s=>s.parentItem?._id??"")),deletedItems=[];if(itemsToDelete.length){const deleted=await actor.deleteEmbeddedDocuments("Item",itemsToDelete,{...operation,render:render&&!subItemsToDelete.length});deletedItems.push(...deleted)}for(const[idx,group]of subItemDeleteGroups.entries()){const parentItem=group[0].parentItem,isLast=idx===subItemDeleteGroups.length-1;await parentItem.update({"system.subitems":parentItem._source.system.subitems?.filter(s=>!group.some(d=>d.id===s._id))},{render:render&&isLast})}return deletedItems.push(...subItemsToDelete),deletedItems}async add(itemOrItems,{stack=!0,render=!0,container,keepId}={}){const items=Array.isArray(itemOrItems)?itemOrItems:[itemOrItems],itemCreates=[],newQuantities={},containerId=container?.id??null,resultIds=[];for(const item of items){const isPhysical=itemIsOfType(item,"physical");if(stack&&isPhysical){const source22="_source"in item?item._source:item,stackableItem=this.findStackableItem(source22,{containerId});if(stackableItem){resultIds.push(stackableItem.id),newQuantities[stackableItem.id]??=stackableItem.quantity,newQuantities[stackableItem.id]+=item.system.quantity;continue}}const source2=item instanceof ItemPF2e?item.toObject():item;source2._id=keepId?source2._id??foundry.utils.randomID():foundry.utils.randomID();const alreadyInValidContainer=keepId&&isPhysical&&items.some(i=>i._id===item.system.containerId);itemIsOfType(source2,"physical")&&(source2.system.containerId=alreadyInValidContainer?source2.system.containerId:containerId),itemCreates.push(source2),resultIds.push(source2._id)}const itemUpdates=Object.entries(newQuantities).map(([_id2,quantity])=>({_id:_id2,"system.quantity":quantity}));return await applyActorGroupUpdate(this.actor,{itemCreates,itemUpdates},{render,keepId:!0}),resultIds.map(id=>this.actor.inventory.get(id,{strict:!0}))}}const coinCompendiumUuids={pp:"Compendium.pf2e.equipment-srd.Item.JuNPeK5Qm1w6wpb4",gp:"Compendium.pf2e.equipment-srd.Item.B6B7tBWJSqOBz5zz",sp:"Compendium.pf2e.equipment-srd.Item.5Ew82vBF9YfaiY9f",cp:"Compendium.pf2e.equipment-srd.Item.lzJ8AVhRcbFul5fh"};class ActorPF2e extends Actor{static{__name(this,"ActorPF2e")}static{__name2(this,"ActorPF2e")}constructor(data,context={}){super(data,context),Object.defineProperty(this,"checkAreaEffects",{value:foundry.utils.debounce(checkAreaEffects,50)})}static getDefaultArtwork(actorData){const img2=`systems/pf2e/icons/default-icons/${actorData.type}.svg`;return{img:img2,texture:{src:img2}}}get allowedItemTypes(){return["condition","effect"]}get allowSynthetics(){return this.type!=="party"}get sourceId(){return this._id&&this.pack?this.uuid:this._stats.duplicateSource??this._stats.compendiumSource}get schemaVersion(){const legacyValue=e$2(this._source.system.schema)&&Number(this._source.system.schema.version)||null;return Number(this._source.system._migration?.version)||legacyValue}get primaryUpdater(){const{activeGM}=game.users;if(activeGM)return activeGM;const activeUsers=game.users.filter(u=>u.active),primaryPlayer=this.isToken?null:activeUsers.find(u=>u.character?.id===this.id);return primaryPlayer||(game.users.filter(u=>this.canUserModify(u,"update")).sort((a,b)=>a.id>b.id?1:-1).shift()??null)}get abilities(){return null}get attributes(){return this.system.attributes}get hitPoints(){const{hp}=this.system.attributes;return hp?{value:hp.value,max:hp.max,temp:hp.temp,unrecoverable:hp.unrecoverable,negativeHealing:hp.negativeHealing}:null}get traits(){return new Set(this.system.traits?.value)}get level(){return this.system.details.level.value}get size(){return this.system.traits?.size?.value??"med"}get dimensions(){const size=this.system.traits?.size??new ActorSizePF2e({value:"med"});return{length:size.long,width:size.wide,height:Math.min(size.long,size.wide)}}get canSee(){return!0}get canAct(){return!0}get canAttack(){return!1}get isDead(){return this.statuses.has("dead")}get modeOfBeing(){const traits=this.system.traits?.value??[],isPC=isReallyPC(this);return traits.includes("undead")&&!traits.includes("eidolon")?"undead":traits.includes("construct")&&!isPC&&!traits.includes("eidolon")?"construct":"living"}get visionLevel(){return VisionLevels.NORMAL}get emitsSound(){return!1}get rollOptions(){return this.flags.pf2e.rollOptions}get heldShield(){return null}get hardness(){return 0}get canHostRuleElements(){return!0}get alliance(){return this.system.details.alliance}get combatant(){return game.combat?.combatants.find(c=>c.actor?.uuid===this.uuid)??null}get temporaryEffects(){const fromConditions=this.conditions.map(c=>ActiveEffectPF2e.fromEffect(c)),fromEffects=this.itemTypes.effect.filter(e2=>e2.system.tokenIcon?.show&&(e2.isIdentified||game.user.isGM)).map(e2=>ActiveEffectPF2e.fromEffect(e2)),allEffects=[super.temporaryEffects,fromConditions,fromEffects,this.synthetics.tokenEffectIcons].flat();return n$2(allEffects,e2=>e2.img)}isOfType(...types){return types.some(t2=>t2==="creature"?tupleHasValue(CREATURE_ACTOR_TYPES,this.type):this.type===t2)}isAllyOf(actor){return this.alliance!==null&&this!==actor&&this.alliance===actor.alliance}isEnemyOf(actor){return this.alliance!==null&&actor.alliance!==null&&this.alliance!==actor.alliance}isImmuneTo(effect){if(!game.pf2e.settings.iwr)return!1;const item=typeof effect=="string"?null:"parent"in effect?effect:new ItemProxyPF2e(effect),statements=new Set(item?item.getRollOptions("item"):["item:type:condition",`item:slug:${effect}`]);return this.attributes.immunities.some(i=>i.test(statements))}isAffectedBy(damage){const damageType=objectHasKey(CONFIG.PF2E.damageTypes,damage)?damage:damage.isOfType("condition")?damage.system.persistent?.damageType??null:null;if(!setHasElement(UNAFFECTED_TYPES,damageType))return!0;const traits=this.system.traits?.value??[];return{good:traits.includes("evil"),evil:traits.includes("good"),lawful:traits.includes("chaotic"),chaotic:traits.includes("lawful"),vitality:!!this.attributes.hp?.negativeHealing,void:!(this.modeOfBeing==="construct"||this.attributes.hp?.negativeHealing),bleed:this.modeOfBeing==="living",spirit:!this.itemTypes.effect.some(e2=>e2.traits.has("possession"))}[damageType]}checkItemValidity(source2){return itemIsOfType(source2,...this.allowedItemTypes)?!0:(ui.notifications.error(game.i18n.format("PF2E.Item.CannotAddType",{type:game.i18n.localize(CONFIG.Item.typeLabels[source2.type]??source2.type.titleCase())})),!1)}getStatistic(slug){return["armor","ac"].includes(slug)?this.armorClass?.parent??null:tupleHasValue(SAVE_TYPES,slug)?this.saves?.[slug]??null:this.skills&&objectHasKey(this.skills,slug)?this.skills[slug]??null:this.synthetics.statistics.get(slug)??null}getResource(_resource){return null}getSelfRollOptions(prefix="self"){const{rollOptions}=this;return Object.keys(rollOptions.all).flatMap(o=>o.startsWith("self:")&&rollOptions.all[o]?o.replace(/^self/,prefix):[])}getReach(_options){return 0}clone(data,context){const clone=super.clone(data,context);if(context?.keepId)for(const[key,value]of this._dependentTokens.entries())clone._dependentTokens.set(key,value);return clone}getContextualClone(rollOptions,ephemeralEffects=[]){const rollOptionsAll=rollOptions.reduce((options,option)=>({...options,[option]:!0}),{}),applicableEffects=ephemeralEffects.filter(e2=>!this.isImmuneTo(e2));return this.clone({items:[foundry.utils.deepClone(this._source.items),applicableEffects].flat(),flags:{pf2e:{rollOptions:{all:rollOptionsAll}}}},{keepId:!0})}async applyAreaEffects(aura,origin){if(game.user!==this.primaryUpdater||this.isOfType("party")||!this.allowedItemTypes.includes("effect")||origin.token.hidden)return;const toCreate=[],rollOptions=aura.effects.some(e2=>e2.predicate.length>0)?[...origin.actor.getRollOptions(),...this.getSelfRollOptions("target")]:[],parentOptionsCache={};for(const data of aura.effects){if(this.itemTypes.effect.some(e2=>e2.sourceId===data.uuid))continue;const parentOptions=parentOptionsCache[data.parent.uuid]??(parentOptionsCache[data.parent.uuid]=data.parent.getRollOptions("parent")??[]);if(data.predicate.test([...rollOptions,...parentOptions])&&auraAffectsActor(data,origin.actor,this)){const effect=await fromUuid(data.uuid);if(!(effect instanceof ItemPF2e&&effect.isOfType("affliction","effect"))){console.warn(`Effect from ${data.uuid} not found`);continue}const flags={pf2e:{aura:{slug:aura.slug,origin:origin.actor.uuid,removeOnExit:data.removeOnExit}}},source2=foundry.utils.mergeObject(effect.toObject(),{flags});source2.system.level.value=aura.level??source2.system.level.value,source2.system.duration.unit="unlimited",source2.system.duration.expiry=null,source2._stats.compendiumSource=effect._stats.compendiumSource,source2._stats.duplicateSource=effect.uuid,source2.system.traits.value.length===0&&source2.system.traits.value.push(...aura.traits),source2.system.context={target:null,origin:{actor:origin.actor.uuid,token:origin.token.uuid,item:null,spellcasting:null,rollOptions:[]},roll:null};for(const alteration of data.alterations)alteration.applyTo(source2);toCreate.push(source2)}}toCreate.length>0&&await this.createEmbeddedDocuments("Item",toCreate)}async recharge(options){const commitData={...createActorGroupUpdate(),affected:{frequencies:!1,spellSlots:!1,resources:[]}},elapsed=options.duration,specificDurations=["turn","round","day"];for(const item of[this.itemTypes.action,this.itemTypes.feat].flat()){if(!item.frequency||item.frequency.value>=item.frequency.max)continue;const per=item.frequency.per,specificPerIdx=specificDurations.indexOf(per);if((specificPerIdx>=0||elapsed==="day")&&(specificPerIdx>=0?specificDurations.indexOf(elapsed)>=specificPerIdx:Duration.fromISO(per)<=Duration.fromISO("PT8H"))){const frequency={value:item.frequency.max};commitData.itemUpdates.push({_id:item.id,system:{frequency}}),commitData.affected.frequencies=!0}}if(elapsed==="day"){const spellcastingRecharge=this.spellcasting?.recharge();spellcastingRecharge&&(commitData.actorUpdates=spellcastingRecharge.actorUpdates,commitData.itemUpdates.push(...spellcastingRecharge.itemUpdates),commitData.affected.spellSlots=spellcastingRecharge.itemUpdates.length>0)}for(const resource of Object.values(this.synthetics.resources)){const updates=await resource.renewUses(elapsed);commitData.itemCreates.push(...updates.itemCreates),commitData.itemUpdates.push(...updates.itemUpdates),(updates.itemCreates.length||updates.itemUpdates.length)&&commitData.affected.resources.push(resource.slug)}const commitSystemData=commitData.actorUpdates?.system;return commitData.affected.resources=commitSystemData&&"resources"in commitSystemData?Object.keys(commitSystemData.resources??{}):[],options.commit!==!1&&await applyActorGroupUpdate(this,commitData),commitData}static createDialog(data,createOptions,options={}){options.types=n([options.types??ACTOR_TYPES].flat());const omittedTypes=game.settings.get("pf2e","campaignType")!=="kingmaker"?["army"]:[];data?.folder&&omittedTypes.push("party");for(const type2 of omittedTypes)options.types.findSplice(t2=>t2===type2);return super.createDialog(data,createOptions,options)}static async createDocuments(data=[],operation={}){const sources=data.map(d=>d instanceof ActorPF2e?d.toObject():d);for(const source2 of[...sources]){const linkable=SIZE_LINKABLE_ACTOR_TYPES.has(source2.type),linkToActorSize=linkable&&(source2.prototypeToken?.flags?.pf2e?.linkToActorSize??!0),autoscale=linkable&&(typeof source2.prototypeToken?.texture?.scaleX!="number"||source2.prototypeToken.texture.scaleX===1)&&(source2.prototypeToken?.flags?.pf2e?.autoscale??(linkToActorSize&&game.settings.get("pf2e","tokens.autoscale"))),merged=foundry.utils.mergeObject(source2,{ownership:source2.ownership??{default:CONST.DOCUMENT_OWNERSHIP_LEVELS.NONE},prototypeToken:{flags:{pf2e:{linkToActorSize,autoscale}}}}),dimensionMap={familiar:.5,vehicle:2};merged.prototypeToken.height??=dimensionMap[source2.type]??1,merged.prototypeToken.width??=merged.prototypeToken.height;const sourceSize=source2.system?.traits?.size?.value;if(linkToActorSize&&sourceSize){const{width,height}=new ActorSizePF2e({value:sourceSize}).tokenDimensions;merged.prototypeToken.width=width,merged.prototypeToken.height=height}switch(merged.type){case"character":case"familiar":merged.ownership.default=CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED,merged.prototypeToken.actorLink=!0,merged.prototypeToken.sight={enabled:!0};break;case"hazard":merged.prototypeToken.sight={enabled:!1};break;case"loot":merged.ownership.default=CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED,merged.prototypeToken.actorLink=!0,merged.prototypeToken.sight={enabled:!1};break;case"party":merged.ownership.default=CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER,merged.prototypeToken.actorLink=!0,merged.prototypeToken.sight={enabled:!0,range:1};break}const migrated=await migrateActorSource(source2);sources.splice(sources.indexOf(source2),1,migrated)}return super.createDocuments(sources,operation)}static async updateDocuments(updates=[],operation={}){if(!((operation?.diff??!0)&&(operation?.recursive??!0)))return super.updateDocuments(updates,operation);for(const changed of updates)await processPreUpdateActorHooks(changed,{pack:operation.pack??null});return super.updateDocuments(updates,operation)}_initializeSource(source2,options){const initialized=super._initializeSource(source2,options);if(options?.pack&&initialized._id){const uuid=`Compendium.${options.pack}.Actor.${initialized._id}`,art=game.pf2e.system.moduleArt.map.get(uuid)??{};return foundry.utils.mergeObject(initialized,art)}return initialized}_initialize(options){this.armorClass=null,this.auras=new Map,this.conditions=new ActorConditions,this.initiative=null,this.rules=[],this.spellcasting=null,this.synthetics={criticalSpecializations:{standard:[],alternate:[]},damageAlterations:{},damageDice:{damage:[]},degreeOfSuccessAdjustments:{},dexterityModifierCaps:[],itemAlterations:[],modifierAdjustments:{all:[],damage:[]},modifiers:{all:[],damage:[]},movementTypes:{},multipleAttackPenalties:{},ephemeralEffects:{},resources:{},rollNotes:{},rollSubstitutions:{},rollTwice:{},senses:[],statistics:new Map,strikeAdjustments:[],strikes:{},striking:{},tokenMarks:new Map,toggles:{},tokenEffectIcons:[],tokenOverrides:{},weaponPotency:{}},super._initialize(options)}prepareData(){this.signature??=v5(this.uuid??"","e9fa1461-0edc-4791-826e-08633f1c6ef7"),super.prepareData();const spellcasting=this.itemTypes.spellcastingEntry,basic=spellcasting.filter(s=>!s.system.proficiency.slug),other=spellcasting.filter(s=>!!s.system.proficiency.slug);for(const entry of basic)entry.prepareStatistic();for(const rule of this.rules)rule.afterPrepareData?.();for(const entry of other)entry.prepareStatistic();if(this.attributes.flanking.offGuardable&&this.isImmuneTo("off-guard")&&(this.attributes.flanking.offGuardable=!1),this.preparePrototypeToken(),canvas.ready){const thisTokenIsControlled=canvas.tokens.controlled.some(t2=>t2.document===this.parent||t2.document.actorLink&&t2.actor===this);(game.user.character===this||thisTokenIsControlled)&&game.pf2e.effectPanel.refresh()}this.conditions.finalize()}prepareBaseData(){super.prepareBaseData(),this.system.autoChanges={},this.system.attributes.flanking={canFlank:!1,canGangUp:[],flankable:!1,offGuardable:!1};const{attributes,details}=this.system;attributes.hp&&=foundry.utils.mergeObject(attributes.hp,{negativeHealing:!1,unrecoverable:0}),attributes.immunities=attributes.immunities?.map(i=>new Immunity(i))??[],attributes.weaknesses=attributes.weaknesses?.map(w=>new Weakness(w))??[],attributes.resistances=attributes.resistances?.map(r2=>new Resistance(r2))??[],details.level.value=Math.floor(details.level.value)||0;const traits=this.system.traits;traits?.size&&(traits.size=new ActorSizePF2e(traits.size)),this.flags.pf2e=foundry.utils.mergeObject(this.flags.pf2e??{},{rollOptions:{all:{[`self:type:${this.type}`]:!0,[`self:signature:${this.signature}`]:!0,...createEncounterRollOptions(this),...createEnvironmentRollOptions(this)}},trackedItems:{}})}prepareEmbeddedDocuments(){super.prepareEmbeddedDocuments();const physicalItems=this.items.filter(i=>i.isOfType("physical"));this.inventory=new ActorInventory(this,physicalItems);for(const effect of this.itemTypes.effect)game.pf2e.effectTracker.register(effect);this.prepareDataFromItems();for(const rule of this.rules)rule.onApplyActiveEffects?.()}prepareDataFromItems(){for(const condition of this.itemTypes.condition)this.conditions.set(condition.id,condition);for(const item of this.items)item.prepareSiblingData?.();for(const item of this.items)item.prepareActorData?.();this.rules=this.prepareRuleElements()}prepareRuleElements(){const sortOrder={ancestry:0,heritage:1,background:2,class:3};return t(this.items.contents,i=>sortOrder[i.type]??1/0,i=>i.isOfType("affliction","condition","effect")).flatMap(item=>item.prepareRuleElements()).filter(rule=>!rule.ignored).sort((elementA,elementB)=>elementA.priority-elementB.priority)}prepareSynthetics(){for(const rule of this.rules.filter(r2=>!r2.ignored))try{rule.beforePrepareData?.()}catch(error){const ruleName=game.i18n.localize(`PF2E.RuleElement.${rule.key}`);console.error(`PF2e | Failed to execute onBeforePrepareData on rule element ${ruleName}.`,error)}for(const item of this.items)item.onPrepareSynthetics?.()}prepareDerivedData(){const rollOptionsAll=this.flags.pf2e.rollOptions.all;for(const trait of this.system.traits?.value??[])rollOptionsAll[`self:trait:${trait}`]=!0}preparePrototypeToken(){const prototypeToken=this.prototypeToken,flags=foundry.utils.mergeObject(prototypeToken.flags,{pf2e:{}});flags.pf2e.linkToActorSize??=SIZE_LINKABLE_ACTOR_TYPES.has(this.type);const settingEnabled=game.pf2e.settings.tokens.autoscale;if(flags.pf2e.autoscale=settingEnabled&&flags.pf2e.linkToActorSize?flags.pf2e.autoscale??!0:!1,flags.pf2e.linkToActorSize&&this.system.traits?.size){const tokenDimensions=this.system.traits.size.tokenDimensions;prototypeToken.width=tokenDimensions.width,prototypeToken.height=tokenDimensions.height}TokenDocumentPF2e.prepareScale(prototypeToken)}async toggleRollOption(domain,option,itemId=null,value,suboption=null){return value=typeof itemId=="boolean"?itemId:value??!this.rollOptions[domain]?.[option],this.rules.find(r2=>r2.key==="RollOption"&&r2.domain===domain&&r2.option===option&&(typeof itemId!="string"||itemId===r2.item.id))?.toggle(value,suboption)??null}async getTokenDocument(data={},options){return this.prototypeToken.flags.pf2e.linkToActorSize&&Object.assign(data,this.system.traits?.size?.tokenDimensions),super.getTokenDocument(data,options)}async modifyTokenAttribute(attribute,value,isDelta=!1,isBar){const token=this.getActiveTokens(!0,!0).shift(),{hitPoints}=this;if(!!(attribute==="attributes.hp"&&hitPoints&&(isDelta||value===0&&token?.combatant))&&token){const damage=isDelta?-1*value:hitPoints.value-value;return this.applyDamage({damage,token,final:!0})}if(!!(attribute==="attributes.shield.hp"&&this.isOfType("character","npc"))&&token){const{hp,itemId}=this.attributes.shield;if(itemId){const damage=isDelta?hp.value+value:value;await this.items.get(itemId)?.update({"system.hp.value":damage})}return this}const actor=token?.actor,isCreature=actor?.isOfType("creature"),resourceMatch=isCreature?/^resources\.([\w-]+)/.exec(attribute):null;if(isCreature&&resourceMatch){const resource=resourceMatch[1],newValue=isDelta?(actor.system.resources?.[resource]?.value??0)+value:value;return await actor.updateResource(resource,newValue),this}return super.modifyTokenAttribute(attribute,value,isDelta,isBar)}async applyDamage({damage,token,item,rollOptions=new Set,skipIWR=!1,shieldBlockRequest=!1,breakdown=[],notes=[],outcome=null,final=!1}){const{hitPoints,heldShield}=this;if(!hitPoints)return this;final&&(shieldBlockRequest=!1,skipIWR=!0);const result=typeof damage=="number"?{finalDamage:Math.trunc(damage),applications:[],persistent:[]}:skipIWR?{finalDamage:damage.total,applications:[],persistent:[]}:applyIWR(this,damage,rollOptions),domain=result.finalDamage<0?"healing-received":"damage-received",isDamage=domain==="damage-received",isHealing=!isDamage,{modifiers,damageDice}=(()=>{if(final||isDamage)return{modifiers:[],damageDice:[]};const critical=outcome==="criticalSuccess",resolvables=item?.isOfType("spell")?{spell:item}:item?.isOfType("weapon")?{weapon:item}:{},damageDice2=extractDamageDice(this.synthetics.damageDice,{selectors:[domain],resolvables,test:rollOptions}).filter(d=>(d.critical===null||d.critical===critical)&&d.predicate.test(rollOptions));return{modifiers:extractModifiers(this.synthetics,[domain],{resolvables}).filter(m=>(m.critical===null||m.critical===critical)&&m.predicate.test(rollOptions)),damageDice:damageDice2}})(),diceAdjustment=(await Promise.all(damageDice.map(async dice=>{const formula=`${dice.diceNumber}${dice.dieSize}[${dice.label}]`,roll=await new Roll(formula).evaluate();return roll._formula=`${dice.diceNumber}${dice.dieSize}`,await roll.toMessage({flags:{pf2e:{suppressDamageButtons:!0}},flavor:dice.label,speaker:ChatMessage.getSpeaker({token})}),roll.total}))).reduce((previous,current)=>previous+current,0),modifierAdjustment=applyStackingRules(modifiers??[]),finalDamage=(isDamage?Math.max:Math.min)(0,result.finalDamage-(diceAdjustment+modifierAdjustment));breakdown.push(...damageDice.map(dice=>`${dice.label} ${dice.diceNumber}${dice.dieSize}`),...modifiers.filter(m=>m.enabled).map(m=>`${m.label} ${signedInteger(m.modifier)}`));const extractedNotes=finalDamage!==0?extractNotes(this.synthetics.rollNotes,[domain]).filter(n2=>(!outcome||n2.outcome.length===0||n2.outcome.includes(outcome))&&n2.predicate.test(rollOptions)):[];notes.push(...extractedNotes);const localize=localizer("PF2E.Actor.ApplyDamage"),actorShield=isDamage&&this.isOfType("character","npc")?this.attributes.shield:null,shieldBlock=actorShield&&shieldBlockRequest?actorShield.broken?(ui.notifications.warn(game.i18n.format("PF2E.Actions.RaiseAShield.ShieldIsBroken",{actor:token.name,shield:actorShield.name})),!1):actorShield.destroyed?(ui.notifications.warn(game.i18n.format("PF2E.Actions.RaiseAShield.ShieldIsDestroyed",{actor:token.name,shield:actorShield.name})),!1):actorShield.raised?!0:(ui.notifications.warn(localize("ShieldNotRaised",{actor:token.name})),!1):!1,shieldHardness=shieldBlock?actorShield?.hardness??0:0,damageAbsorbedByShield=finalDamage>0?Math.min(shieldHardness,finalDamage):0,blockingShield=heldShield?.id===actorShield?.itemId?heldShield:null,currentShieldHP=blockingShield?blockingShield._source.system.hp.value:actorShield?.hp.value??0,shieldDamage=shieldBlock?Math.min(currentShieldHP,Math.abs(finalDamage)-damageAbsorbedByShield):0,baseActorHardness=this.hardness,effectiveActorHardness=(()=>{if(final)return 0;const damageHasAdamantine=typeof damage=="number"?!1:damage.materials.has("adamantine"),materialGrade=item?.isOfType("weapon")&&item.system.material.type==="adamantine"?item.system.material.grade??"standard":"standard",itemHardness={low:0,standard:10,high:13}[materialGrade];return damageHasAdamantine&&itemHardness>=baseActorHardness?Math.floor(baseActorHardness/2):baseActorHardness})(),damageAbsorbedByActor=finalDamage>0?Math.min(finalDamage-damageAbsorbedByShield,effectiveActorHardness):0;if(damageAbsorbedByActor>0){const typeLabel=effectiveActorHardness===baseActorHardness?"PF2E.Damage.Hardness.Full":"PF2E.Damage.Hardness.Half";result.applications.push({category:"reduction",type:game.i18n.localize(typeLabel),adjustment:-1*damageAbsorbedByActor})}const damageResult=this.calculateHealthDelta({hp:hitPoints,sp:this.isOfType("character")?this.attributes.hp.sp:null,delta:finalDamage-damageAbsorbedByShield-damageAbsorbedByActor}),preUpdateSource=this.toObject();blockingShield&&shieldDamage>0&&await blockingShield.update({"system.hp.value":Math.max(blockingShield._source.system.hp.value-shieldDamage,0)},{render:damageResult.totalApplied===0});const staminaMax=this.isOfType("character")?this.attributes.hp.sp?.max??0:0,instantDeath=damageResult.totalApplied<=0||damageResult.updates["system.attributes.hp.value"]!==0?null:rollOptions.has("item:trait:death")&&!this.attributes.immunities.some(i=>i.type==="death-effects")?"death-effect":rollOptions.has("item:type:spell")&&rollOptions.has("item:slug:disintegrate")?"fine-powder":this.isOfType("npc")&&this.modeOfBeing==="undead"?"destroyed":damageResult.totalApplied>=(hitPoints.max+staminaMax)*2?"massive-damage":null,finePowder=instantDeath==="fine-powder";if(damageResult.totalApplied!==0){const updated=await this.update(foundry.utils.deepClone(damageResult.updates),{damageTaken:damageResult.totalApplied,finePowder}),setting=game.settings.get("pf2e","automation.actorsDeadAtZero"),deadAtZero=this.isOfType("npc")&&["npcsOnly","both"].includes(setting)||this.isOfType("character")&&setting==="both"&&!!instantDeath;updated?.isDead&&deadAtZero&&(isDamage&&!token.combatant?.isDefeated||damageResult.totalApplied<0&&token.combatant?.isDefeated)&&(await token.combatant?.toggleDefeated({overlayIcon:!finePowder}),finePowder&&await this.createEmbeddedDocuments("Item",[createDisintegrateEffect()]))}const hpStatement=isHealing?hitPoints.value===hitPoints.max?localize("AtFullHealth"):localize("HealedForN"):isDamage&&(hitPoints.max===0||finalDamage-damageAbsorbedByActor===0)?localize("TakesNoDamage"):damageAbsorbedByShield>0?damageResult.totalApplied>0?localize("DamagedForNShield"):localize("ShieldAbsorbsAll"):localize("DamagedForN"),updatedShield=this.isOfType("character","npc")?this.attributes.shield:null,shieldStatement=isDamage&&updatedShield&&shieldDamage>0?updatedShield.broken?localize("ShieldDamagedForNBroken"):updatedShield.destroyed?localize("ShieldDamagedForNDestroyed"):localize("ShieldDamagedForN"):null,statements=(()=>{const deathMessage=instantDeath&&localize(`InstantDeath.${sluggify(instantDeath,{camel:"bactrian"})}`),concatenated=[hpStatement,shieldStatement,deathMessage].filter(e$1).map(s=>game.i18n.format(s,{actor:token.name.replace(/[<>]/g,""),hpDamage:Math.abs(damageResult.totalApplied),absorbedDamage:damageAbsorbedByShield,shieldDamage})).join(" "),tempElem=document.createElement("div");return tempElem.innerHTML=concatenated,TextEditorPF2e.convertXMLNode(tempElem,"actor",{whose:null,classes:["target-name"]}),tempElem.innerHTML})(),persistentDamage=result.persistent.map(instance=>{const condition=game.pf2e.ConditionManager.getCondition("persistent-damage").toObject();return condition.system.persistent={formula:instance.head.expression,damageType:instance.type,dc:15,criticalHit:damage instanceof Roll?damage.options.degreeOfSuccess===3:!1},condition.system.traits={value:n(Array.from(rollOptions).map(o=>o.replace(/^origin:action:trait:/,""))).filter(t2=>t2 in CONFIG.PF2E.effectTraits),otherTags:[]},condition}),persistentCreated=persistentDamage.length>0?await this.createEmbeddedDocuments("Item",persistentDamage):[],canUndoDamage=!!(damageResult.totalApplied||shieldDamage||persistentCreated.length),content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/damage/damage-taken.hbs",{breakdown,statements,persistent:persistentCreated.map(p=>p.system.persistent?.damage.formula).filter(e$1),iwr:{applications:result.applications,visibility:this.hasPlayerOwner?"all":"gm"},canUndoDamage}),flavor=await(async()=>{if(breakdown.length||notes.length)return foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/damage/damage-taken-flavor.hbs",{breakdown,notes:RollNotePF2e.notesToHTML(notes)?.outerHTML})})(),appliedDamage=canUndoDamage?{uuid:this.uuid,isHealing:damageResult.totalApplied<0,shield:shieldDamage!==0?{id:actorShield?.itemId??"",damage:shieldDamage}:null,persistent:persistentCreated.map(c=>c.id),updates:Object.entries(damageResult.updates).map(([path,newValue])=>{const preUpdateValue=foundry.utils.getProperty(preUpdateSource,path);if(typeof preUpdateValue=="number"){const difference=preUpdateValue-newValue;return difference===0?[]:{path,value:difference}}return[]}).flat()}:null;return await ChatMessagePF2e.create({speaker:ChatMessagePF2e.getSpeaker({token}),flags:{pf2e:{appliedDamage,context:{type:"damage-taken",domains:[domain],options:Array.from(rollOptions)},origin:item?.getOriginData()}},flavor,content,style:CONST.CHAT_MESSAGE_STYLES.OTHER,whisper:game.settings.get("pf2e","metagame_secretDamage")&&!token.actor?.hasPlayerOwner?ChatMessagePF2e.getWhisperRecipients("GM").map(u=>u.id):[]}),this}async undoDamage(appliedDamage){const{updates,shield,persistent}=appliedDamage,actorUpdates={};for(const update of updates){const currentValue=foundry.utils.getProperty(this,update.path);typeof currentValue=="number"&&(actorUpdates[update.path]=currentValue+update.value)}if(shield){const item=this.inventory.get(shield.id);item&&(actorUpdates.items=[{_id:shield.id,"system.hp.value":item.hitPoints.value+shield.damage}])}const updateCount=Object.keys(actorUpdates).length;if(persistent.length&&await this.deleteEmbeddedDocuments("Item",persistent,{render:updateCount===0}),updateCount){const{hitPoints}=this,damageTaken=hitPoints&&typeof actorUpdates["system.attributes.hp.value"]=="number"?hitPoints.value-actorUpdates["system.attributes.hp.value"]:0;this.update(actorUpdates,{damageTaken,damageUndo:!0})}}isLootableBy(user){return this.canUserModify(user,"update")}exportToJSON(options={}){options.clearSource??=!1,super.exportToJSON(options)}async importFromJSON(json2){const processed=await preImportJSON(json2);return processed?super.importFromJSON(processed):this}async transferItemToActor(targetActor,item,quantity,containerId,newStack=!1,isPurchase=null){if(isPurchase??=this.isOfType("loot")&&this.isMerchant,!item.isOfType("physical"))throw ErrorPF2e("Only physical items (with quantities) can be transfered between actors");const container=targetActor.inventory.get(containerId??"");if(container&&!container?.isOfType("backpack"))throw ErrorPF2e("containerId refers to a non-container");if(__name2((source2,target)=>{const bothAreOwned=source2.isOwner&&target.isOwner,sourceIsOwnedOrLoot=source2.isLootableBy(game.user),targetIsOwnedOrLoot=target.isLootableBy(game.user);return!bothAreOwned&&sourceIsOwnedOrLoot&&targetIsOwnedOrLoot},"gmMustTransfer")(this,targetActor)){const source2={tokenId:this.token?.id,actorId:this.id,itemId:item.id},target={tokenId:targetActor.token?.id,actorId:targetActor.id},mode=isPurchase?"purchase":"move";return await new ItemTransfer({source:source2,target,quantity,containerId:container?.id,mode}).request(),null}if(!this.canUserModify(game.user,"update"))return ui.notifications.error(game.i18n.localize("PF2E.ErrorMessage.CantMoveItemSource")),null;if(!targetActor.canUserModify(game.user,"update"))return ui.notifications.error(game.i18n.localize("PF2E.ErrorMessage.CantMoveItemDestination")),null;if(quantity=Math.min(quantity,item.quantity),isPurchase){const itemValue=Coins.fromPrice(item.price,quantity);if(await targetActor.inventory.removeCoins(itemValue))await item.actor.inventory.addCoins(itemValue);else return ui.notifications.warn(game.i18n.format("PF2E.loot.InsufficientFundsMessage",{buyer:targetActor.name})),null}const newQuantity=item.quantity-quantity,removeFromSource=newQuantity<1,update=createActorGroupUpdate();removeFromSource?update.itemDeletes.push(item.id):update.itemUpdates.push({_id:item.id,"system.quantity":newQuantity});const newItemData=item.toObject();newItemData._id=foundry.utils.randomID(),newItemData.system.quantity=quantity,newItemData.system.equipped=getDefaultEquipStatus(item);const itemTransfer=[newItemData];if(item.isOfType("backpack")){const addBackpack=__name2((container2,containerId2)=>{for(const item2 of container2.contents){const source2=item2.toObject();source2._id=foundry.utils.randomID(),source2.system.containerId=containerId2,itemTransfer.push(source2),update.itemDeletes.push(item2.id),item2.isOfType("backpack")&&addBackpack(item2,source2._id)}},"addBackpack");addBackpack(item,newItemData._id)}return await applyActorGroupUpdate(this,update),(await targetActor.inventory.add(itemTransfer,{container,stack:itemTransfer.length<2&&!newStack,keepId:!0}))[0]}async addToInventory(itemSource,container,newStack){const containerId=container?.id??null,stackItem=newStack?null:this.inventory.findStackableItem(itemSource,{containerId});if(!newStack&&stackItem&&stackItem.type!=="backpack"){const stackQuantity=stackItem.quantity+itemSource.system.quantity;return await stackItem.update({"system.quantity":stackQuantity}),stackItem}const result=await ItemPF2e.create(itemSource,{parent:this});if(!result)return null;const movedItem=this.inventory.get(result.id);return movedItem?(await this.stowOrUnstow(movedItem,container),movedItem):null}async stowOrUnstow(item,container){if(!container)await item.update({"system.containerId":null,"system.equipped.carryType":"worn","system.equipped.handsHeld":0,"system.equipped.inSlot":!1});else if(!isContainerCycle(item,container)){const carryType=container.stowsItems?"stowed":"worn";await item.update({"system.containerId":container.id,"system.equipped.carryType":carryType,"system.equipped.handsHeld":0,"system.equipped.inSlot":!1})}}calculateHealthDelta(args){const updates={},{hp,sp,delta}=args;if(hp.max===0)return{updates,totalApplied:0};const appliedToTemp=(()=>{if(!hp.temp||delta<=0)return 0;const applied=Math.min(hp.temp,delta);return updates["system.attributes.hp.temp"]=Math.max(hp.temp-applied,0),applied})(),appliedToSP=(()=>{if(!(!!sp&&game.pf2e.settings.variants.stamina)||delta<=0)return 0;const remaining=delta-appliedToTemp,applied=Math.min(sp.value,remaining);return updates["system.attributes.hp.sp.value"]=Math.max(sp.value-applied,0),applied})(),appliedToHP=(()=>{const remaining=delta-appliedToTemp-appliedToSP;return updates["system.attributes.hp.value"]=Math.clamp(hp.value-remaining,0,hp.max),remaining})(),totalApplied=appliedToTemp+appliedToSP+appliedToHP;return{updates,totalApplied}}getRollOptions(domains=[]){const options=[];for(const domain of new Set(["all",...domains])){const optionsRecord=this.rollOptions[domain]??{};for(const option of Object.keys(optionsRecord))optionsRecord[option]&&options.push(option)}return options}getRollData(){return{actor:this}}getCondition(slugOrKey,{all=!1}={}){const conditions=this.conditions.filter(c=>c.key===slugOrKey||c.slug===slugOrKey);return all?conditions.sort((conditionA,conditionB)=>{const[valueA,valueB]=[conditionA.value??0,conditionB.value??0];return valueA>valueB?-1:valueA<valueB?1:0}):conditions.find(c=>c.active)??null}hasCondition(...slugs){return slugs.some(s=>this.conditions.hasType(s))}async decreaseCondition(conditionSlug,{forceRemove}={forceRemove:!1}){const condition=typeof conditionSlug=="string"?this.getCondition(conditionSlug):conditionSlug;if(!condition)return;if(condition.slug==="persistent-damage"){const matching=this.conditions.stored.filter(c=>c.key===condition.key).map(c=>c.id);await this.deleteEmbeddedDocuments("Item",matching);return}const currentValue=condition._source.system.value.value,newValue=typeof currentValue=="number"?Math.max(currentValue-1,0):null;newValue!==null&&!forceRemove?await game.pf2e.ConditionManager.updateConditionValue(condition.id,this,newValue):await this.deleteEmbeddedDocuments("Item",[condition.id])}async increaseCondition(conditionSlug,{max=Number.MAX_SAFE_INTEGER,value}={}){if(conditionSlug==="persistent-damage")return new PersistentDamageEditor({actor:this}).render({force:!0}),null;const existing=(()=>{if(typeof conditionSlug!="string")return conditionSlug;const conditions=this.itemTypes.condition;return value?conditions.find(c=>c.slug===conditionSlug&&!c.isLocked):conditions.find(c=>c.slug===conditionSlug&&c.active)})();if(existing){const newValue=(()=>{const currentValue=existing._source.system.value.value;if(currentValue===null)return null;const addend=value??1;return Math.clamp(currentValue+addend,1,max)})();return newValue?(await game.pf2e.ConditionManager.updateConditionValue(existing.id,this,newValue),existing):null}else if(typeof conditionSlug=="string"){const conditionSource=game.pf2e.ConditionManager.getCondition(conditionSlug).toObject(),conditionValue=typeof conditionSource.system.value.value=="number"&&max?Math.clamp(conditionSource.system.value.value,value??1,max):null;return conditionSource.system.value.value=conditionValue,(await this.createEmbeddedDocuments("Item",[conditionSource])).shift()??null}return null}async toggleCondition(conditionSlug,options){if(!setHasElement(CONDITION_SLUGS,conditionSlug))throw ErrorPF2e(`Unrecognized condition: ${conditionSlug}`);const hasCondition=this.hasCondition(conditionSlug),active=options?.active??!hasCondition;if(active&&!hasCondition)await this.increaseCondition(conditionSlug);else{if(active)return!0;if(!active&&hasCondition)return await this.decreaseCondition(conditionSlug,{forceRemove:!0}),!1}}async toggleStatusEffect(statusId,options){return setHasElement(CONDITION_SLUGS,statusId)?this.toggleCondition(statusId,options):super.toggleStatusEffect(statusId,options)}#prepareDamageBroadcast(changed,options){const currentHP=this._source.system.attributes?.hp?.value,updatedHP=changed.system?.attributes?.hp?.value??currentHP;if(!options.damageTaken&&this.hasPlayerOwner&&currentHP&&typeof updatedHP=="number"&&updatedHP!==currentHP){const damageTaken=-1*(updatedHP-currentHP),currentLevel=this._source.system.details.level?.value,updatedLevel=changed.system?.details?.level?.value??currentLevel;damageTaken&&currentLevel===updatedLevel&&(options.damageTaken=damageTaken)}}async _preUpdate(changed,options,user){const result=await super._preUpdate(changed,options,user);return result===!1?!1:((options.diff??!0)&&(options.recursive??!0)&&this.#prepareDamageBroadcast(changed,options),result)}_preUpdateDescendantDocuments(parent,collection,changes,options,userId){super._preUpdateDescendantDocuments(parent,collection,changes,options,userId),parent===this&&collection==="items"&&(options.previous={maxHitPoints:this.hitPoints?.max})}_onUpdateDescendantDocuments(parent,collection,documents,changes,options,userId){if(super._onUpdateDescendantDocuments(parent,collection,documents,changes,options,userId),this!==parent||collection!=="items"||game.user.id!==userId)return;const items=documents.filter(d=>d instanceof ItemPF2e);if(this?.isOfType("character")&&items.every(d=>d.isOfType("ancestry","background","class","feat","heritage"))){const previousHitPoints=options.previous?.maxHitPoints,hpMaxDifference=typeof previousHitPoints=="number"?this.hitPoints.max-previousHitPoints:0;if(hpMaxDifference!==0){const newHitPoints=this._source.system.attributes.hp.value+hpMaxDifference;this.update({"system.attributes.hp.value":newHitPoints},{allowHPOverage:!0})}}const containersToCheck=[];for(const change of changes){if(!e$2(change))continue;const expanded=foundry.utils.expandObject(change);e$2(expanded.system)&&expanded.system.containerId&&containersToCheck.push(String(expanded.system.containerId))}const updates=createActorGroupUpdate();for(const containerId of n(containersToCheck)){const container=this.items.get(containerId);if(container?.isOfType("backpack")&&container.system.quantity>1&&container.contents.size>0){const clone=container.toObject(!0);clone._id=null,clone.system.quantity=container.system.quantity-1,updates.itemCreates.push(clone),updates.itemUpdates.push({_id:container.id,"system.quantity":1})}}applyActorGroupUpdate(this,updates)}_onUpdate(changed,options,userId){super._onUpdate(changed,options,userId);const hideFromUser=!this.hasPlayerOwner&&!game.user.isGM&&game.settings.get("pf2e","metagame_secretDamage");if(options.damageTaken&&!hideFromUser){const tokens=this.getActiveTokens();for(const token of tokens)token.showFloatyText(-1*options.damageTaken)}if(canvas.ready&&changed.system?.details&&"alliance"in changed.system.details)for(const token of this.getActiveTokens(!0,!0))token.reset();if(!options.damageTaken){const currentHP=this.hitPoints?.value??0,hpChange=Number(changed.system?.attributes?.hp?.value)||0;if(currentHP>0&&hpChange>0&&this.isDead&&game.user.id===userId){const combatant=this.combatant;combatant?combatant.toggleDefeated({to:!1}):this.toggleStatusEffect("dead")}}}_onDelete(options,userId){for(const effect of this.itemTypes.effect)game.pf2e.effectTracker.unregister(effect);super._onDelete(options,userId)}}const ActorProxyPF2e=new Proxy(ActorPF2e,{construct(_target,args){const type2=args[0]?.type,ActorClass=CONFIG.PF2E.Actor.documentClasses[type2];if(!ActorClass)throw ErrorPF2e(`Actor type ${type2} does not exist and actor module sub-types are not supported`);return new ActorClass(...args)}}),CHARACTER_SHEET_TABS=["character","actions","inventory","spellcasting","crafting","proficiencies","feats","effects","biography","pfs"],CORE_RESOURCES=["hero-points","focus","investiture","resolve","mythic-points"];class SpellCollection extends Collection{static{__name(this,"SpellCollection")}static{__name2(this,"SpellCollection")}entry;actor;name;constructor(entry,name2=entry.name){if(!entry.actor)throw ErrorPF2e("a spell collection must have an associated actor");super(),this.entry=entry,this.actor=entry.actor,this.name=name2}get id(){return this.entry.id}get highestRank(){const highestSpell=Math.max(...this.map(s=>s.rank)),actorSpellRank=Math.ceil((this.actor?.level??0)/2);return Math.min(10,Math.max(highestSpell,actorSpellRank))}#assertEntryIsDocument(entry){if(!(entry instanceof ItemPF2e))throw ErrorPF2e("`this#entry` is not a `SpellcastingEntryPF2e`")}async addSpell(spell,options){const actor=this.actor;if(!actor.isOfType("creature"))throw ErrorPF2e("Spellcasting entries can only exist on creatures");const canHeighten=!(spell.isCantrip||spell.isFocusSpell||spell.isRitual)&&["innate","spontaneous"].includes(this.entry.category),groupId=options?.groupId,heightenedRank=canHeighten?spellSlotGroupIdToNumber(groupId)??spell.rank:spell.baseRank;if(spell.system.location.value===this.id&&spell.rank===heightenedRank)return null;if(spell.isFocusSpell&&!this.entry.isFocusPool)return this.#warnInvalidDrop("invalid-spell",{spell}),null;if(spell.baseRank>heightenedRank&&this.id===spell.system.location?.value)return this.#warnInvalidDrop("invalid-rank",{spell,groupId}),null;const heightenedUpdate=canHeighten&&heightenedRank>=spell.baseRank?{"system.location.heightenedLevel":heightenedRank}:{};if(spell.actor===actor)return spell.update({"system.location.value":this.id,...heightenedUpdate});{const source2=spell.clone({sort:0,"system.location.value":this.id,...heightenedUpdate}).toObject(),created=(await actor.createEmbeddedDocuments("Item",[source2])).shift();return created instanceof SpellPF2e?created:null}}async swapSlotPositions(groupId,slotIndexA,slotIndexB){this.#assertEntryIsDocument(this.entry);const groupNumber=spellSlotGroupIdToNumber(groupId);if(typeof groupNumber!="number")return null;const prepared=this.entry.system.slots[`slot${groupNumber}`].prepared,slotA=prepared.at(slotIndexA),slotB=prepared.at(slotIndexB);return slotA&&slotB?(prepared[slotIndexA]=slotB,prepared[slotIndexB]=slotA,await this.entry.update({[`system.slots.slot${groupNumber}.prepared`]:prepared})?this:null):null}async prepareSpell(spell,groupId,slotIndex){if(this.#assertEntryIsDocument(this.entry),spell){if(groupId==="cantrips"!==spell.isCantrip)return this.#warnInvalidDrop("cantrip-mismatch",{spell}),null;if(groupId!=="cantrips"&&spell.baseRank>groupId)return this.#warnInvalidDrop("invalid-rank",{spell,groupId}),null}const groupNumber=spellSlotGroupIdToNumber(groupId),slots=foundry.utils.deepClone(this.entry.system.slots[`slot${groupNumber}`].prepared),expended=slots[slotIndex].expended;return slots[slotIndex]={id:spell?.id??null,expended},await this.entry.update({[`system.slots.slot${groupNumber}.prepared`]:slots})?this:null}async setSlotExpendedState(groupId,slotIndex,value){this.#assertEntryIsDocument(this.entry);const groupNumber=spellSlotGroupIdToNumber(groupId),prepared=this.entry.system.slots[`slot${groupNumber}`].prepared,slot=prepared[slotIndex];return slot&&(slot.expended=value),await this.entry.update({[`system.slots.slot${groupNumber}.prepared`]:prepared})?this:null}async getSpellData({prepList=!1}={}){const actor=this.actor;if(!actor.isOfType("character","npc"))throw ErrorPF2e("Spellcasting entries can only exist on characters and npcs");if(!(this.entry instanceof SpellcastingEntryPF2e))return this.#getEphemeralData();const groups=[],spells=this.contents.sort((a,b)=>a.name.localeCompare(b.name,game.i18n.lang)).sort((a,b)=>a.sort-b.sort),isFlexible=this.entry.isFlexible,maxCantripRank=Math.max(1,Math.ceil(actor.level/2));if(this.entry.isPrepared&&this.entry instanceof SpellcastingEntryPF2e)for(let rank=0;rank<=this.highestRank;rank++){const group=this.entry.system.slots[`slot${rank}`],active=(this.entry.showSlotlessRanks||group.max>0)&&(rank===0||!isFlexible)?group.prepared.map(slot=>{const spell=slot&&this.get(slot.id??""),castRank=spell?.computeCastRank(rank);return spell?{castRank,spell,expended:slot.expended}:null}):[],[groupId,maxRank]=rank===0?["cantrips",maxCantripRank]:[rank,rank],label=groupId==="cantrips"?"PF2E.Actor.Creature.Spellcasting.Cantrips":game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ordinalString(rank)}),uses={value:rank>0&&isFlexible?group.value||0:void 0,max:group.max};groups.push({id:groupId,maxRank,label,uses,active,number:rank})}else if(this.entry.isFocusPool){const cantrips=spells.filter(spell=>spell.isCantrip),normal=spells.filter(spell=>!spell.isCantrip);if(cantrips.length){const active=cantrips.map(spell=>({spell}));groups.push({id:"cantrips",maxRank:maxCantripRank,label:"PF2E.Actor.Creature.Spellcasting.Cantrips",active})}if(normal.length>0){const active=normal.map(spell=>({spell}));groups.push({id:maxCantripRank,maxRank:maxCantripRank,label:actor.type==="character"?"PF2E.Focus.Spells":"PF2E.Focus.Pool",uses:actor.system.resources.focus??{value:0,max:0},active})}}else{const alwaysShowHeader=!this.entry.isRitual,spellsByRank=groupBy(spells,spell=>spell.isCantrip?0:spell.rank),isInnate=this.entry.category==="innate";for(let rank=0;rank<=this.highestRank;rank++){const data=this.entry.system.slots[`slot${rank}`],spells2=spellsByRank.get(rank)??[];if(alwaysShowHeader||spells2.length>0){const uses=this.entry.isSpontaneous&&rank!==0?{value:data.value,max:data.max}:void 0,active=spells2.map(spell=>({spell,expended:isInnate&&!spell.system.location.uses?.value,uses:isInnate&&!spell.atWill?spell.system.location.uses:void 0})),hideForSpontaneous=this.entry.isSpontaneous&&uses?.max===0&&active.length===0,hideForInnate=this.entry.isInnate&&active.length===0;if(!this.entry.system.showSlotlessLevels.value&&(hideForSpontaneous||hideForInnate))continue;const[groupId,maxRank]=rank===0?["cantrips",maxCantripRank]:[rank,rank];groups.push({id:groupId,label:groupId==="cantrips"?"PF2E.Actor.Creature.Spellcasting.Cantrips":game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ordinalString(rank)}),maxRank,uses,active,number:rank})}}}const canHaveSignatureSpells=this.entry.isSpontaneous||isFlexible,signatureSpells=canHaveSignatureSpells?spells.filter(s=>s.system.location.signature).sort((a,b)=>a.name.localeCompare(b.name,game.i18n.lang)):[];if(canHaveSignatureSpells){for(const spell of signatureSpells)for(const group of groups){if(group.id==="cantrips"||spell.baseRank>group.id||!this.entry.showSlotlessRanks&&group.uses?.max===0)continue;const existing=group.active.find(a=>a?.spell.id===spell.id);if(existing)existing.signature=!0;else if(group.uses?.max){const castRank=group.id;group.active.push({spell,castRank,signature:!0,virtual:!0})}}for(const group of groups)if(group.id!=="cantrips"&&group.uses?.value===0&&group.uses.max>=0)for(const slot of group.active)slot&&(slot.expended=!0)}const flexibleAvailable=(()=>{if(!isFlexible)return null;const totalSlots=groups.filter(g=>g.id!=="cantrips").map(g=>g.uses?.max||0).reduce((a,b)=>a+b,0);return{value:signatureSpells.length,max:totalSlots}})();return{groups,flexibleAvailable,prepList:prepList?this.#getSpellPrepList(spells):null}}#getEphemeralData(){const groupedByRank=t$2(Array.from(this.values()),s=>s.rank);return{groups:t$f(groupedByRank).sort(([a],[b])=>Number(a)-Number(b)).map(([rank,spells])=>({id:Number(rank),label:game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ordinalString(Number(rank))}),maxRank:10,active:spells.map(spell=>({spell,expended:spell.parentItem?.uses.value===0}))})),prepList:null}}#getSpellPrepList(spells){const indices=Array.fromRange(11),prepList=t$9(indices,i=>[i,[]]);if(this.entry.category!=="prepared")return prepList;for(const spell of spells)if(spell.isCantrip)prepList[0].push({spell,signature:!1});else{const signature=this.entry.isFlexible&&!!spell.system.location.signature;prepList[spell.baseRank].push({spell,signature})}return prepList}#warnInvalidDrop(warning,{spell,groupId}){const localize=localizer("PF2E.Item.Spell.Warning");if(warning==="invalid-rank"&&typeof groupId=="number"){const spellRank=getSpellRankLabel(spell.baseRank),targetRank=getSpellRankLabel(groupId);ui.notifications.warn(localize("InvalidRank",{spell:spell.name,spellRank,targetRank}))}else if(warning==="cantrip-mismatch"){const locKey=spell.isCantrip?"CantripToRankedSlots":"NonCantripToCantrips";ui.notifications.warn(localize(locKey,{spell:spell.name}))}else if(warning==="invalid-spell"){const type2=game.i18n.format("PF2E.TraitFocus");ui.notifications.warn(localize("WrongSpellType",{type:type2}))}}}class RitualSpellcasting{static{__name(this,"RitualSpellcasting")}static{__name2(this,"RitualSpellcasting")}actor;spells;constructor(actor){this.actor=actor,this.spells=new SpellCollection(this,this.name);for(const ritual of this.actor.itemTypes.spell.filter(s=>s.isRitual))this.spells.set(ritual.id,ritual)}get id(){return"rituals"}get name(){return game.i18n.localize("PF2E.Actor.Creature.Spellcasting.Rituals")}get sort(){return Math.max(0,...this.actor.itemTypes.spellcastingEntry.map(e2=>e2.sort))+20}get category(){return"ritual"}get tradition(){return null}get isFlexible(){return!1}get isFocusPool(){return!1}get isRitual(){return!0}get isEphemeral(){return!0}canCast(spell){return spell.isRitual}async cast(spell,options={}){if(!spell.isRitual)throw ErrorPF2e("Attempted to cast non-ritual from `RitualSpellcasting`");await spell.toMessage(void 0,{rollMode:options.rollMode})}async getSheetData(){const collectionData=await this.spells.getSpellData();return foundry.utils.mergeObject(collectionData,{id:this.id,name:this.name,statistic:null,tradition:null,category:this.category,isRitual:!0,isEphemeral:!0,hasCollection:!0,sort:this.sort,usesSpellProficiency:!1})}}class ActorSpellcasting extends DelegatedCollection{static{__name(this,"ActorSpellcasting")}static{__name2(this,"ActorSpellcasting")}actor;collections=new Collection;#trickEntries={};constructor(actor){super(),this.actor=actor}initialize(entries){this.clear();for(const entry of entries)this.set(entry.id,entry);this.collections.clear();for(const entry of entries)entry.spells&&this.collections.set(entry.spells.id,entry.spells)}get regular(){return this.filter(e2=>e2 instanceof SpellcastingEntryPF2e)}get ritual(){const ritualCasting=this.collections.get("rituals")?.entry;return ritualCasting instanceof RitualSpellcasting?ritualCasting:null}get orphanedSpells(){return this.actor.itemTypes.spell.filter(s=>!s.spellcasting)}get spellcastingFeatures(){return this.regular.filter(e2=>e2.isPrepared||e2.isSpontaneous)}get(id){const existing=this.#trickEntries[id]??super.get(id);if(!existing&&id.startsWith("trick-")){const skill=id.split("-")[1];if(tupleHasValue(TRICK_MAGIC_SKILLS,skill))return this.#trickEntries[id]=new TrickMagicItemEntry(this.actor,skill),this.#trickEntries[id]}return existing}canCastConsumable(item){const spell=item.embeddedSpell;return!!spell&&this.some(e2=>e2.canCast(spell,{origin:item}))}refocus(options={}){if(!options.all)throw ErrorPF2e("Actors do not currently support regular refocusing");if(this.actor.isOfType("character","npc")){const focus=this.actor.system.resources.focus,rechargeFocus=focus?.max&&focus.value<focus.max;if(focus&&rechargeFocus)return focus.value=focus.max,{system:{resources:{focus:{value:focus.value}}}}}return null}recharge(){const itemUpdates=this.contents.flatMap(entry=>{if(!(entry instanceof SpellcastingEntryPF2e))return[];if(entry.isFocusPool||!entry.spells)return[];if(entry.isInnate)return entry.spells.map(spell=>{const value=spell.system.location.uses?.max??1;return{_id:spell.id,system:{location:{uses:{value}}}}});const slots=entry.system.slots;let updated=!1;for(const slot of Object.values(slots))if(entry.isPrepared&&!entry.isFlexible)for(const preparedSpell of Object.values(slot.prepared))preparedSpell.expended&&(preparedSpell.expended=!1,updated=!0);else slot.value<slot.max&&(slot.value=slot.max,updated=!0);return updated?{_id:entry.id,system:{slots}}:[]}),actorUpdates=this.refocus({all:!0})??{};return createActorGroupUpdate({actorUpdates,itemUpdates})}}class ItemSpellcasting{static{__name(this,"ItemSpellcasting")}static{__name2(this,"ItemSpellcasting")}id;name;actor;statistic;tradition;original;castPredicate;constructor({id,name:name2,actor,statistic,tradition,original,castPredicate}){this.id=id,this.name=name2,this.actor=actor,this.statistic=statistic,this.tradition=tradition??null,this.original=original??null,this.castPredicate=castPredicate}get counteraction(){return createCounteractStatistic(this)}get attribute(){return this.statistic.attribute??"cha"}get category(){return"items"}get sort(){return Math.max(0,...this.actor.itemTypes.spellcastingEntry.map(e2=>e2.sort))+10}get spells(){return null}get isFlexible(){return!1}get isFocusPool(){return!1}get isEphemeral(){return!0}canCast(spell,{origin}={}){if(!origin||!spell.actor?.isOfType("creature"))return!1;const rollOptions=new Set([...this.actor.getRollOptions(),...origin.getRollOptions("item"),...spell.getRollOptions("spell",{includeVariants:!0})]);return this.castPredicate.test(rollOptions)}async cast(spell,options={}){(options.message??!0)&&this.canCast(spell,{origin:spell.parentItem})&&(spell.system.location.value=this.id,await spell.toMessage(null,{rollMode:options.rollMode,data:{castRank:spell.rank}}))}async getSheetData({spells}={}){const collectionData=await spells?.getSpellData()??{groups:[],prepList:null};return{...t$3(this,["category","tradition","sort","isFlexible","isFocusPool","isEphemeral"]),...collectionData,id:spells?.id??this.id,name:spells?.name??this.name,statistic:this.statistic.getChatData(),attribute:this.statistic.attribute,hasCollection:!!spells?.size,usesSpellProficiency:!1}}}class ItemAttacher extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"ItemAttacher")}static{__name2(this,"ItemAttacher")}constructor({item}){if(super(),!item.isAttachable)throw ErrorPF2e("Not an attachable item");const actor=item.actor,collection=actor?[...iterateAllItems(actor)]:game.items.contents;if(this.item=item,this.choices=collection.filter(i=>i.isOfType("physical")).filter(i=>i.quantity>0&&i.acceptsSubitem(item)).sort((a,b)=>a.name.localeCompare(b.name,game.i18n.lang)),this.choices.length===0){const message=game.i18n.format("PF2E.Item.Physical.Attach.NoEligibleItem",{attachable:this.item.name});ui.notifications.warn(message),this.close()}}static DEFAULT_OPTIONS={id:"item-attacher",window:{icon:"fa-solid fa-paperclip",contentClasses:["standard-form"],resizable:!1},position:{height:"auto",width:"auto"},actions:{attach:ItemAttacher.#onClickAttach}};static PARTS={base:{template:"systems/pf2e/templates/items/item-attacher.hbs",root:!0}};item;choices;get title(){return game.i18n.format("PF2E.Item.Physical.Attach.PromptTitle",{item:this.item.name})}static#onClickAttach(){const selectElement=this.element.querySelector("select[data-choices]"),selection=selectElement?this.choices.at(Number(selectElement.value)):null;selection&&this.#attach(selection),this.close()}_canRender(options){if(this.choices.length===0){const message=game.i18n.format("PF2E.Item.Physical.Attach.NoEligibleItem",{attachable:this.item.name});return ui.notifications.warn(message),!1}return super._canRender(options)}async _prepareContext(){return{item:this.item,choices:this.choices.map((i,index2)=>({label:i.name,value:index2})),user:game.user,requiresCrafting:!!this.item.actor?.skills?.crafting&&this.item.system.usage.type!=="installed"}}async#attach(attachmentTarget){return!!this.element?.querySelector("input[data-crafting-check]")?.checked&&!await this.#craftingCheck(attachmentTarget)?!1:attachmentTarget.attach(this.item)}async#craftingCheck(attachmentTarget){const statistic=this.item.actor?.skills?.crafting;if(!statistic)throw ErrorPF2e("Item not owned by a creature");const dc={value:10,visible:!0},args={dc,label:await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/header.hbs",{glyph:null,subtitle:game.i18n.format("PF2E.ActionsCheck.x",{type:statistic.label}),title:this.title}),extraRollNotes:[new RollNotePF2e({outcome:["failure","criticalFailure"],selector:"crafting-check",text:game.i18n.format("PF2E.Item.Physical.Attach.Outcome.Failure",{attachable:this.item.name}),title:"PF2E.Check.Result.Degree.Check.failure"}),new RollNotePF2e({outcome:["success","criticalSuccess"],selector:"crafting-check",text:game.i18n.format("PF2E.Item.Physical.Attach.Outcome.Success",{attachable:this.item.name,target:attachmentTarget.name}),title:"PF2E.Check.Result.Degree.Check.success"})]};return((await statistic.roll(args))?.total??0)>=dc.value}}class SpeedStatistic extends BaseStatistic{static{__name(this,"SpeedStatistic")}static{__name2(this,"SpeedStatistic")}constructor(actor,options){const type2=options.type,slug=`${type2}-speed`,domains=options.domains??=["all-speeds","speed",slug],typeLabel=game.i18n.localize(`PF2E.Actor.Speed.Type.${type2.capitalize()}`),label=options.label??=game.i18n.format("PF2E.Actor.Speed.Type.Label",{type:typeLabel});if(super(actor,Object.assign(options,{label,slug})),this.type=type2,this.base=Math.max(5,options.base??=25),this.source=options.source??=null,!Number.isInteger(this.base)||this.base<0)throw ErrorPF2e("Non-integer or insufficient base speed provided");this.rollOptions=this.createRollOptions(domains);const additionalModifiers=options.modifiers??=[],modifierAdjustments=actor.synthetics.modifierAdjustments;for(const modifier of additionalModifiers)modifier.adjustments=extractModifierAdjustments(modifierAdjustments,domains,modifier.slug);const syntheticModifiers=extractModifiers(actor.synthetics,domains,{test:this.rollOptions});this.modifiers=[...syntheticModifiers,...additionalModifiers]}type;base;source;rollOptions;get value(){return this.#value??=this.base+new StatisticModifier("",this.modifiers,this.rollOptions).totalModifier,this.#value}#value=null;get breakdown(){const localize=localizer("PF2E.Actor.Speed"),typeLabel=localize(`Type.${this.type.capitalize()}`),baseKey=this.source?"BaseWithSource":"BaseLabel",baseLabel=localize(baseKey,{value:this.base,type:typeLabel,source:this.source}),components=this.modifiers.filter(m=>m.enabled&&m.value!==0).map(m=>`${m.label} ${m.signedValue}`);return game.i18n.getListFormatter({style:"narrow"}).format([baseLabel,...components])}extend(options){const{type:type2,base=this.value,modifiers=[],source:source2=this.source}=options;return new SpeedStatistic(this.actor,{type:type2,base,modifiers,domains:[`${type2}-speed`],source:source2})}getTraceData(){const data={type:this.type,slug:this.slug,label:this.label,value:this.value,base:this.base,source:this.source,breakdown:this.breakdown,modifiers:this.modifiers.filter(m=>m.enabled&&m.value!==0).map(m=>m.toObject())};return this.type==="land"&&(data.crawl=5,data.step=5),data}}class CreaturePF2e extends ActorPF2e{static{__name(this,"CreaturePF2e")}static{__name2(this,"CreaturePF2e")}get allowedItemTypes(){return[...super.allowedItemTypes,"affliction"]}get creatureTypes(){return this.system.traits.value.filter(t2=>t2 in CONFIG.PF2E.creatureTypes).sort()}get rarity(){return this.system.traits.rarity}get hardness(){return Math.floor(Math.abs(this.system.attributes.hardness.value))||0}getReach({action:action2="interact",weapon=null}={}){const baseReach=this.attributes.reach.base,weaponReach=weapon?.isOfType("melee")?weapon.reach:null;if(action2==="interact"||this.type==="familiar")return baseReach;if(typeof weaponReach=="number")return weaponReach;{const traitsFromItems=(weapon?[{item:weapon,ready:!0}]:this.system.actions??[]).filter(a=>a.ready).map(a=>new Set(a.item.system.traits?.value??[]));if(traitsFromItems.length===0)return baseReach;const reaches=traitsFromItems.map(traits=>{if(setHasElement(traits,"reach"))return baseReach+5;const reachNPattern=/^reach-\d{1,3}$/;return Number([...traits].find(t2=>reachNPattern.test(t2))?.replace("reach-",""))||baseReach});return Math.max(...reaches)}}get visionLevel(){const senseTypes=this.system.perception.senses.map(sense=>sense.type);return this.hasCondition("blinded")?VisionLevels.BLINDED:senseTypes.includes("darkvision")||senseTypes.includes("greater-darkvision")?VisionLevels.DARKVISION:senseTypes.includes("low-light-vision")?VisionLevels.LOWLIGHT:VisionLevels.NORMAL}get hasDarkvision(){return this.visionLevel===VisionLevels.DARKVISION&&!this.hasCondition("blinded")}get hasLowLightVision(){return this.visionLevel>=VisionLevels.LOWLIGHT&&!this.hasCondition("blinded")}get canSee(){return canvas.scene?this.visionLevel===VisionLevels.BLINDED?!1:canvas.scene.lightLevel>LightLevels.DARKNESS||this.hasDarkvision:!0}get canAct(){const traits=this.system.traits.value;return(!this.isDead||traits.some(t2=>t2==="eidolon"))&&!this.hasCondition("paralyzed","stunned","unconscious")}get canAttack(){return this.type!=="familiar"&&this.canAct}get isDead(){const{hitPoints}=this;return hitPoints.max>0&&hitPoints.value===0&&!this.hasCondition("dying","unconscious")?!0:this.statuses.has("dead")}get emitsSound(){return this.system.attributes.emitsSound}get isSpellcaster(){const itemTypes=this.itemTypes;return itemTypes.spellcastingEntry.length>0&&itemTypes.spell.length>0}get wornArmor(){return this.itemTypes.armor.find(a=>a.isEquipped)??null}get heldShield(){const heldShields=this.itemTypes.shield.filter(s=>s.isEquipped);return heldShields.length===0?null:heldShields.slice(0,-1).reduce((bestShield,shield)=>{if(bestShield===shield)return bestShield;const withBetterAC=bestShield.acBonus>shield.acBonus?bestShield:shield.acBonus>bestShield.acBonus?shield:null,withMoreHP=bestShield.hitPoints.value>shield.hitPoints.value?bestShield:shield.hitPoints.value>bestShield.hitPoints.value?shield:null,withBetterHardness=bestShield.hardness>shield.hardness?bestShield:shield.hardness>bestShield.hardness?shield:null;return withBetterAC??withMoreHP??withBetterHardness??bestShield},heldShields.slice(-1)[0])}getStatistic(slug,options){const item=options?.item;switch(slug){case"perception":return this.perception;case"spell":case"spell-attack":return this.spellcasting.contents.flatMap(sc=>sc.statistic??[]).sort((a,b)=>b.mod-a.mod).shift()??null;case"spell-dc":return this.spellcasting.contents.flatMap(sc=>sc.statistic??[]).sort((a,b)=>b.dc.value-a.dc.value).shift()??null;case"counteract":return item?.isOfType("spell")&&item.actor?.uuid===this.uuid&&item.spellcasting instanceof SpellcastingEntryPF2e?item.spellcasting.counteraction:this.spellcasting.values().filter(sc=>sc instanceof SpellcastingEntryPF2e).map(sc=>sc.counteraction).reduce((best,candidate)=>candidate.mod>best.mod?candidate:best)??null}return slug in CONFIG.PF2E.magicTraditions?this.spellcasting.filter(c=>c.tradition===slug).flatMap(s=>s.statistic??[]).sort((a,b)=>b.check.mod-a.check.mod).shift()??null??null:this.spellcasting.contents.flatMap(sc=>sc.statistic??[]).find(s=>s.slug===slug)??super.getStatistic(slug)}_initialize(options){this.parties??=new Set;const getSystem=__name2(()=>this.system,"getSystem");this.movement={speeds:{},get terrain(){return foundry.utils.deepClone(getSystem().movement.terrain)}},super._initialize(options)}prepareData(){super.prepareData();const spellConsumables=this.itemTypes.consumable.filter(c=>["scroll","wand"].includes(c.category)&&c.isIdentified&&!c.isStowed);for(const consumable of spellConsumables){const spell=consumable.embeddedSpell;if(!spell?.id)continue;const ability=this.spellcasting.filter(e2=>!!e2.statistic&&e2.canCast(spell,{origin:consumable})).reduce((best,e2)=>best===null||e2.statistic.dc.value>best.statistic.dc.value?e2:best,null);if(ability){const collectionId=`${consumable.id}-casting`,itemCasting=new ItemSpellcasting({id:collectionId,name:consumable.name,actor:this,statistic:ability.statistic,tradition:ability.tradition??spell.traditions.first()??null,original:ability,castPredicate:new Predicate([`item:id:${consumable.id}`,`spell:id:${spell.id}`])});spell.system.location.value=itemCasting.id;const collection=new SpellCollection(itemCasting);collection.set(spell.id,spell),this.spellcasting.set(itemCasting.id,itemCasting),this.spellcasting.collections.set(collectionId,collection)}}for(const party of this.parties)party.reset({actor:!0})}prepareBaseData(){super.prepareBaseData(),this.flags.pf2e.rollOptions.all["self:creature"]=!0,this.system.perception=foundry.utils.mergeObject({attribute:"wis",senses:[]},this.system.perception),this.system.resources??={};const attributes=this.system.attributes;attributes.ac=foundry.utils.mergeObject({attribute:"dex"},attributes.ac),attributes.hardness??={value:0},attributes.flanking.canFlank=this.type!=="familiar",attributes.flanking.flankable=!0,attributes.flanking.offGuardable=!0;const baseReach=this.type==="familiar"?0:5;attributes.reach={base:baseReach,manipulate:baseReach},this.system.initiative&&(this.system.initiative.tiebreakPriority=this.hasPlayerOwner?2:1);const customModifiers=this.system.customModifiers??={};for(const selector of Object.keys(customModifiers))customModifiers[selector]=customModifiers[selector].map(rawModifier=>new Modifier(rawModifier));this.isOfType("character","npc")&&(attributes.shield={itemId:null,name:game.i18n.localize("PF2E.ArmorTypeShield"),ac:0,hp:{value:0,max:0},brokenThreshold:0,hardness:0,raised:!1,broken:!1,destroyed:!1,icon:"systems/pf2e/icons/actions/raise-a-shield.webp"}),attributes.doomed={value:0,max:3},attributes.dying={value:0,max:4,recoveryDC:10},attributes.wounded={value:0,max:3},setImmunitiesFromTraits(this);const withPartialMovement=this.system;withPartialMovement.movement={speeds:{},terrain:{difficult:{ignored:[]},greater:{ignored:[]}}};const sourceSystemData=this._source.system.attributes,legacyData="speed"in sourceSystemData?sourceSystemData.speed:{value:25,otherSpeeds:[]};for(const speed of[{type:"land",value:legacyData.value},...legacyData.otherSpeeds]){const{type:type2,value}=speed;withPartialMovement.movement.speeds[type2]={value,base:value}}"speed"in this.system.attributes&&delete this.system.attributes.speed,Object.defineProperty(this.system.attributes,"speed",{get:__name2(()=>{const message=["You are accessing CreaturePF2e#system#attributes#speed.","Movement data is now found at #system#movement#speeds."].join(" ");foundry.utils.logCompatibilityWarning(message,{since:"7.5.0",until:"8.0.0",once:!0});const speeds=this.system.movement.speeds,land=speeds.land,otherSpeeds=Object.entries(speeds).filter(e2=>!!e2[1]&&["burrow","fly","swim"].includes(e2[0])).map(([type2,s])=>({type:type2,value:s.base,total:s.value,breakdown:s.breakdown}));return{value:land.base,total:land.value,breakdown:land.breakdown,otherSpeeds}},"get")})}prepareEmbeddedDocuments(){super.prepareEmbeddedDocuments();for(const changeEntries of Object.values(this.system.autoChanges))changeEntries?.sort((a,b)=>(a.level??0)-(b.level??0));if(this.rollOptions.all[`self:mode:${this.modeOfBeing}`]=!0,this.isOfType("character")){const spellcasting=this.system.proficiencies.spellcasting,actualSpellcasting=this.spellcasting.filter(e2=>e2.system&&!e2.system?.proficiency.slug);actualSpellcasting.some(e2=>e2.category==="innate")?spellcasting.rank=Math.max(spellcasting.rank,this.level>=12?2:1):actualSpellcasting.length&&(spellcasting.rank||=1)}this.spellcasting.base=new Statistic(this,{slug:"base-spellcasting",label:"PF2E.Actor.Creature.Spellcasting.Label",rank:this.isOfType("character")?this.system.proficiencies.spellcasting.rank:1,domains:["all","spell-attack-dc"],check:{type:"attack-roll"}})}prepareDataFromItems(){this.spellcasting??=new ActorSpellcasting(this),this.spellcasting.initialize([...this.itemTypes.spellcastingEntry,new RitualSpellcasting(this)]),super.prepareDataFromItems()}prepareDerivedData(){if(super.prepareDerivedData(),this.system.abilities)for(const[shortForm,data]of t$f(this.system.abilities))data.label=CONFIG.PF2E.abilities[shortForm],data.shortLabel=`PF2E.AbilityId.${shortForm}`;const{attributes,rollOptions}=this;this.hitPoints.negativeHealing&&(rollOptions.all["self:negative-healing"]=!0),rollOptions.all["self:armored"]=!!this.wornArmor&&this.wornArmor.category!=="unarmored",attributes.shield?.raised&&!attributes.shield.broken&&!attributes.shield.destroyed&&(rollOptions.all["self:shield:raised"]=!0),attributes.emitsSound=!this.isDead,this.prepareSynthetics();const sizeIndex=SIZES.indexOf(this.size),sizeSlug=SIZE_SLUGS[sizeIndex];rollOptions.all[`self:size:${sizeIndex}`]=!0,rollOptions.all[`self:size:${sizeSlug}`]=!0,attributes.wounded.max=Math.max(0,attributes.dying.max-1),attributes.doomed.max=attributes.dying.max;for(const conditionSlug of["doomed","wounded","dying"]){const condition=this.conditions.bySlug(conditionSlug,{active:!0}).at(0),status=attributes[conditionSlug];conditionSlug==="dying"&&(status.max-=attributes.doomed.value),status.value=Math.min(condition?.value??0,status.max)}const resources=this.system.resources;resources.focus&&(resources.focus.max=Math.floor(Math.clamp(resources.focus.max,0,resources.focus.cap))||0);for(const key of["heroPoints","mythicPoints","focus"]){const resource=resources[key];resource&&(resource.value=Math.floor(Math.clamp(resource.value,0,resource.max))||0)}this.system.details.alliance===null&&(attributes.flanking.canFlank=!1),imposeEncumberedCondition(this)}prepareSynthetics(){super.prepareSynthetics();for(const[selector,modifiers]of Object.entries(this.system.customModifiers))(this.synthetics.modifiers[selector]??=[]).push(...modifiers.map(m=>()=>m))}async changeCarryType(item,{carryType,handsHeld=0,inSlot=!1}){const usage=item.system.usage;if(carryType==="stowed"){const container=item.actor.itemTypes.backpack.find(c=>c!==item.container&&!isContainerCycle(item,c));container&&await item.actor.stowOrUnstow(item,container)}else if(carryType==="attached"&&item.quantity>0)await new ItemAttacher({item}).render({force:!0});else{const equipped={carryType,handsHeld:carryType==="held"?handsHeld:0,inSlot:usage.type==="worn"&&usage.where?inSlot:void 0},updates=[];if(isEquipped(usage,equipped)&&item.isOfType("armor")){const wornArmors=this.itemTypes.armor.filter(a=>a!==item&&a.isEquipped);for(const armor of wornArmors)updates.push({_id:armor.id,system:{equipped:{inSlot:!1}}})}else if(equipped.carryType!=="held"&&item.isOfType("weapon")&&item.shield?.isRaised){const effectIds=item.actor.itemTypes.effect.filter(e2=>e2.slug==="effect-raise-a-shield"||e2.slug==="effect-cover"&&e2.system.traits.otherTags.includes("tower-shield")&&item.shield?.isTowerShield).map(e2=>e2.id);await this.deleteEmbeddedDocuments("Item",effectIds)}updates.push({_id:item.id,system:{containerId:null,equipped}}),await this.updateEmbeddedDocuments("Item",updates)}}async addCustomModifier(stat,label,value,type2){if(stat=stat==="armor"?"ac":stat,!this.isOfType("character","npc"))return;if(stat.length===0)throw ErrorPF2e("A custom modifier's statistic must be a non-empty string");if(label.length===0)throw ErrorPF2e("A custom modifier's label must be a non-empty string");const modifiers=(this.toObject().system.customModifiers??{})[stat]??[];if(!modifiers.some(m=>m.label===label)){const modifierType=setHasElement(MODIFIER_TYPES,type2)?type2:"untyped",modifier=new Modifier({label,modifier:value,type:modifierType,custom:!0}).toObject();await this.update({[`system.customModifiers.${stat}`]:[...modifiers,modifier]})}}async removeCustomModifier(stat,slug){if(stat=stat==="armor"?"ac":stat,stat.length===0)throw ErrorPF2e("A custom modifier's statistic must be a non-empty string");const modifiers=(this.toObject().system.customModifiers??{})[stat]??[];if(modifiers.length!==0)if(typeof slug=="string"){const withRemoved=modifiers.filter(m=>m.slug!==slug);await this.update({[`system.customModifiers.${stat}`]:withRemoved})}else throw ErrorPF2e("Custom modifiers can only be removed by slug (string) or index (number)")}async rollRecovery(event2){const{dying}=this.attributes;if(!dying?.value)return null;const localize=localizer("PF2E.Recovery"),recoveryDC=dying.recoveryDC,dc={label:localize("rollingDescription",{dying:dying.value,dc:"{dc}"}),value:recoveryDC+dying.value,visible:!0},notes=[new RollNotePF2e({selector:"all",text:localize("critSuccess"),outcome:["criticalSuccess"]}),new RollNotePF2e({selector:"all",text:localize("success"),outcome:["success"]}),new RollNotePF2e({selector:"all",text:localize("failure"),outcome:["failure"]}),new RollNotePF2e({selector:"all",text:localize("critFailure"),outcome:["criticalFailure"]})];return new Statistic(this,{slug:"dying-recovery",label:"PF2E.Check.Specific.Recovery",check:{type:"flat-check"}}).roll({...eventToRollParams(event2,{type:"check"}),dc,extraRollNotes:notes})}getResource(resource){const slug=sluggify(resource),key=sluggify(resource,{camel:"dromedary"});if(slug==="infused-reagents"&&this.isOfType("character"))return{...this.system.resources.crafting.infusedReagents,slug,label:"PF2E.CraftingTab.Alchemical.InfusedReagents"};const data=this.system.resources[key];if(!data)return null;const label=tupleHasValue(CORE_RESOURCES,slug)?game.i18n.localize(`PF2E.Actor.Resource.${key.capitalize()}`):this.synthetics.resources[key]?.label??key.capitalize();return{...data,slug,label}}async updateResource(resource,value,{render}={}){const slug=sluggify(resource),key=sluggify(resource,{camel:"dromedary"});if(key==="investiture")return;if(slug==="infused-reagents"&&this.isOfType("character")){value=Math.clamp(value,0,this.system.resources.crafting.infusedReagents.max),await this.update({"system.resources.crafting.infusedReagents.value":value});return}const resources=this.system.resources,special=this.synthetics.resources[key];special?await special.update(Math.clamp(value,0,special.max),{render}):resources?.[key]&&tupleHasValue(CORE_RESOURCES,slug)&&(value=Math.clamp(value,0,resources[key]?.max??0),await this.update({[`system.resources.${key}.value`]:value},{render}))}prepareMovementData(modifiers=[]){const synthetics=this.synthetics.movementTypes,baseSpeedOptions=this.getRollOptions(),baseSpeed=[this.system.movement.speeds.land.base,...synthetics.land?.flatMap(d=>d({test:baseSpeedOptions})?.value??[])??[]].reduce((highest,v)=>Math.max(highest,v),0);baseSpeed>0&&(this.flags.pf2e.rollOptions.all["speed:land"]=!0);const landSpeed=new SpeedStatistic(this,{type:"land",base:baseSpeed,modifiers});this.system.movement.speeds.land=landSpeed.getTraceData();const otherSpeeds=Object.fromEntries(MOVEMENT_TYPES.filter(t2=>t2!=="land").map(type2=>{const fromSynthetics=n$3(synthetics[type2]?.map(d=>d({test:baseSpeedOptions}))??[],e$6),systemDataSpeed=this.system.movement.speeds[type2]??{value:-1/0,source:null},syntheticSpeed=n$4(fromSynthetics,[s=>s.value??0,"desc"]);if(!syntheticSpeed&&systemDataSpeed.value<=0)return[type2,null];this.flags.pf2e.rollOptions.all[`speed:${type2}`]=!0;const selected=syntheticSpeed&&syntheticSpeed.value>systemDataSpeed.value?syntheticSpeed:systemDataSpeed;if(selected===syntheticSpeed&&syntheticSpeed.derivedFromLand){const domain=this.flags.pf2e.rollOptions[`${type2}-speed`]??={};domain["derived-from-land"]=!0}const statistic=selected.derivedFromLand?landSpeed.extend({type:type2,base:selected.value,source:selected.source}):new SpeedStatistic(this,{type:type2,base:selected.value,modifiers:modifiers.filter(m=>["all-speeds",`${type2}-speed`].some(d=>m.domains.includes(d))).map(m=>m.clone()),source:selected.source});return[type2,statistic]})),travelSpeed=landSpeed.extend({type:"travel"});this.movement.speeds={[landSpeed.type]:landSpeed,...otherSpeeds,[travelSpeed.type]:travelSpeed},this.system.movement.speeds=t$5(this.movement.speeds,s=>s?.type==="land"?this.system.movement.speeds.land:s?.getTraceData()??null)}deleteEmbeddedDocuments(embeddedName,ids,operation){if(embeddedName==="Item"){const linked=ids.map(id=>this.items.get(id)).flatMap(item=>item?.getLinkedItems?.()??[]);ids.push(...linked.map(item=>item.id))}return super.deleteEmbeddedDocuments(embeddedName,[...new Set(ids)],operation)}async _preUpdate(changed,options,user){const isFullReplace=!((options.diff??!0)&&(options.recursive??!0));if(!changed.system||isFullReplace)return super._preUpdate(changed,options,user);const currentHP=this.hitPoints,changedHP=changed.system.attributes?.hp;if(typeof changedHP?.value=="number"&&(changedHP.value=options.allowHPOverage?Math.max(0,changedHP.value):Math.clamp(changedHP.value,0,Math.max(currentHP.max-currentHP.unrecoverable,0))),changed.system.attributes?.hp?.temp!==void 0){const inputValue=changed.system.attributes.hp.temp;changed.system.attributes.hp.temp=Math.floor(Math.clamp(Number(inputValue)||0,0,999))}const focusUpdate=changed.system.resources?.focus;if(focusUpdate&&this.system.resources){typeof focusUpdate.max=="number"&&(focusUpdate.max=Math.clamp(focusUpdate.max,0,3));const updatedPoints=Number(focusUpdate.value??this.system.resources.focus?.value)||0,enforcedMax=(Number(focusUpdate.max)||this.system.resources.focus?.max)??0;focusUpdate.value=Math.clamp(updatedPoints,0,enforcedMax)}if(changed.system.resources)for(const special of Object.keys(this.synthetics.resources))special in changed.system.resources&&delete changed.system.resources[special];const traitChanges=changed.system.traits;if(e$2(traitChanges)&&Array.isArray(traitChanges.value)){const sourceAlignmentTraits=this._source.system.traits?.value.filter(t2=>["good","evil","lawful","chaotic"].includes(t2)&&!(t2 in CONFIG.PF2E.creatureTraits));traitChanges.value=n([traitChanges.value,sourceAlignmentTraits].flat()).filter(e$1).sort()}return super._preUpdate(changed,options,user)}_onDelete(options,userId){super._onDelete(options,userId);for(const party of this.parties){const updater=party.primaryUpdater;game.user===updater?party.removeMembers(this.uuid):updater||(party.reset(),ui.actors.render())}}}class ActorInitiative{static{__name(this,"ActorInitiative")}static{__name2(this,"ActorInitiative")}actor;statistic;tiebreakPriority;constructor(actor,{statistic,tiebreakPriority}){this.actor=actor,this.tiebreakPriority=tiebreakPriority;const base=actor.getStatistic(statistic),ponderousPenalty=actor.isOfType("character")?createPonderousPenalty(actor):null,rollLabel=game.i18n.format("PF2E.InitiativeWithSkill",{skillName:base?.label??""}),data={slug:"initiative",label:base?.label??"PF2E.InitiativeLabel",domains:["initiative"],rollOptions:[base?.slug??[]].flat(),check:{type:"initiative",label:rollLabel},modifiers:[ponderousPenalty??[]].flat()};this.statistic=base?base.extend(data):new Statistic(actor,data)}get attribute(){return this.statistic.attribute}get mod(){return this.statistic.check.mod}async roll(args={}){const combatant=args.combatant?.actor===this.actor?args.combatant:await CombatantPF2e.fromActor(this.actor,!1);if(!combatant)return null;combatant.hidden&&(args.rollMode=CONST.DICE_ROLL_MODES.PRIVATE);const roll=await this.statistic.roll(args);return roll?((args.updateTracker??!0)&&combatant.encounter.setInitiative(combatant.id,roll.total,this.statistic.base?.slug),{combatant,roll}):(game.combats.render(!1),null)}getTraceData(){const initiativeData=this.actor.system.initiative;return{...this.statistic.getTraceData(),statistic:initiativeData?.statistic??"perception",tiebreakPriority:this.tiebreakPriority}}}class FeatGroup{static{__name(this,"FeatGroup")}static{__name2(this,"FeatGroup")}actor;id;label;feats=[];slotted=!1;supported=[];filter;slots={};limit;level;#data;customLimit;constructor(actor,data,options={}){if(this.#data=data,this.actor=actor,this.id=data.id,this.label=data.label,this.supported=data.supported??[],this.filter=data.filter??{},this.filter.categories??=this.supported,this.customLimit=data.customLimit??null,this.customLimit&&actor.isOfType("character")){const{min,max}=this.customLimit;this.limit=Math.clamp(options.limit??actor.flags.pf2e.featLimits[this.id]??0,min,max),actor.flags.pf2e.featLimits[this.id]=this.limit}else this.limit=options.limit??actor.level;if(data.slots){this.slotted=!0;for(const slotData of data.slots){const slotObject=typeof slotData=="object"?slotData:{id:`${this.id}-${slotData}`,level:Number(slotData),label:slotData.toString()};if(typeof slotObject.level=="number"&&(slotObject.tier??slotObject.level)>this.limit)continue;const slot={...slotObject,id:slotObject.id??`${this.id}-${slotObject.level}`,label:game.i18n.localize(String(slotObject.label??slotObject.level)),level:slotObject.level??null,placeholder:slotObject.placeholder??data.placeholder??"PF2E.EmptySlot",children:[]};slot.filter&&(slot.filter.categories??=this.supported),this.feats.push(slot),this.slots[slot.id]=slot}}const slotLevels=this.feats.map(f=>f.level).filter(l=>typeof l=="number");this.level=slotLevels.length===0?actor.level:Math.max(...slotLevels)}get isFull(){return this.slotted&&Object.values(this.slots).every(s=>!!s?.feat)}assignFeat(feat){const slotId=feat.isOfType("feat")&&feat.system.location===this.id?feat.system.level.taken?.toString()??"":feat.system.location??"",slot=this.slots[slotId];if(!slot&&this.slotted||feat.suppressed)return!1;if(slot?.feat)return console.debug(`PF2e System | Multiple feats with same index: ${feat.name}, ${slot.feat.name}`),!1;const childSlots=this.#getChildSlots(feat);if(slot)slot.feat=feat,slot.children=childSlots;else{const label=feat.category==="classfeature"?feat.system.level?.value.toString()??null:null;this.feats.push({feat,label,children:childSlots})}return feat.group=this,!0}#getChildSlots(feat){if(!feat?.isOfType("feat"))return[];const grantsById=t$i(feat.flags.pf2e.itemGrants,(_,g)=>g.id);return feat.grants.filter(g=>grantsById[g.id]?.nested!==!1).map(grant=>({id:grant.id,label:null,level:grant.system.level?.taken??null,feat:grant,children:this.#getChildSlots(grant)}))}isFeatValid(feat){return this.supported.length===0||tupleHasValue(this.supported,feat.category)}async insertFeat(feat,slotId=null){if(this.slotted&&slotId&&this.slots[slotId]?.feat===feat)return[];const slot=this.slots[slotId??""],location=this.slotted||this.id==="bonus"?slot?.id??null:this.id,existing=this.actor.items.filter(i=>isFeatLike(i)&&i.system.location===location),isFeatValidInSlot=this.isFeatValid(feat),alreadyHasFeat=this.actor.items.has(feat.id),changed=[];if(!alreadyHasFeat&&(isFeatValidInSlot||!location)){const source2=foundry.utils.mergeObject(feat.toObject(),{system:{location,level:{taken:slot?.level??this.actor.level}}});changed.push(...await this.actor.createEmbeddedDocuments("Item",[source2]));const label=game.i18n.localize(this.label);ui.notifications.info(game.i18n.format("PF2E.Item.Feat.Info.Added",{item:feat.name,category:label}))}const locationUpdates=this.slotted?existing.map(f=>({_id:f.id,"system.location":null,..."taken"in(feat._source.system.level??{})?{"system.level.-=taken":null}:{}})):[];return alreadyHasFeat&&isFeatValidInSlot&&locationUpdates.push({_id:feat.id,"system.location":location,...slot?.level&&feat.isOfType("feat")?{"system.level.taken":slot.level}:{}}),locationUpdates.length>0&&changed.push(...await this.actor.updateEmbeddedDocuments("Item",locationUpdates)),changed}postProcess(){this.#data.sorted&&!this.slotted&&this.feats.sort((a,b)=>(a.feat?.level||0)-(b.feat?.level||0)),this.slotted&&this.#data.requiresInitial&&!this.feats.at(0)?.feat&&(this.feats=this.feats.filter((f,idx)=>idx===0||!!f.feat),this.filter=this.feats[0].filter??this.filter)}}function isFeatLike(item){return"category"in item&&"location"in item.system&&"isFeat"in item&&"isFeature"in item}__name(isFeatLike,"isFeatLike"),__name2(isFeatLike,"isFeatLike");class CharacterFeats extends Collection{static{__name(this,"CharacterFeats")}static{__name2(this,"CharacterFeats")}constructor(actor){super(),this.actor=actor;const classFeatSlots=actor.class?.grantedFeatSlots;this.bonus=new FeatGroup(actor,{id:"bonus",label:"PF2E.Actor.Character.FeatSlot.BonusHeader"}),this.createGroup({id:"ancestryfeature",label:"PF2E.Actor.Character.FeatSlot.AncestryFeaturesHeader",supported:["ancestryfeature"]}),this.createGroup({id:"classfeature",label:"PF2E.Actor.Character.FeatSlot.ClassFeaturesHeader",supported:["classfeature"],sorted:!0});const ancestry=actor.system.details.ancestry;this.createGroup({id:"ancestry",label:"PF2E.Actor.Character.FeatSlot.AncestryHeader",supported:["ancestry"],filter:{traits:ancestry?.countsAs.flatMap(t2=>t2 in CONFIG.PF2E.featTraits?t2:[])??[]},slots:classFeatSlots?.ancestry??[]});const classTrait=(()=>{const slug=actor.class?actor.class.slug??sluggify(actor.class.name):null;return slug&&slug in CONFIG.PF2E.featTraits?slug:null})(),hasDedicationFeat=this.actor.itemTypes.feat.some(f=>f.traits.has("dedication"));this.createGroup({id:"class",label:"PF2E.Actor.Character.FeatSlot.ClassHeader",supported:["class"],filter:{traits:[classTrait,hasDedicationFeat?"archetype":"dedication"].filter(t2=>!!t2)},slots:classFeatSlots?.class??[]});const evenLevels=new Array(actor.level).fill(0).map((_,idx)=>idx+1).filter(idx=>idx%2===0);game.pf2e.settings.variants.fa&&this.createGroup({id:"archetype",label:"PF2E.Actor.Character.FeatSlot.ArchetypeHeader",supported:["class"],filter:{traits:[this.actor.itemTypes.feat.some(f=>f.traits.has("dedication"))?"archetype":"dedication"]},slots:evenLevels});const backgroundSkillFeats=actor.background&&Object.keys(actor.background.system.items??{}).length>0?{id:actor.background.id,level:1,label:game.i18n.localize("PF2E.FeatBackgroundShort")}:null;this.createGroup({id:"skill",label:"PF2E.Actor.Character.FeatSlot.SkillHeader",supported:["skill"],slots:[backgroundSkillFeats,classFeatSlots?.skill].flat().filter(e$1)}),this.createGroup({id:"general",label:"PF2E.Actor.Character.FeatSlot.GeneralHeader",supported:["general","skill"],slots:classFeatSlots?.general??[]});const mythicSetting=game.pf2e.settings.campaign.mythic;mythicSetting!=="disabled"&&this.createGroup({id:"mythic",label:"PF2E.Actor.Character.FeatSlot.MythicHeader",placeholder:"PF2E.Actor.Character.FeatSlot.MythicFeatPlaceholder",customLimit:mythicSetting==="variant-tiers"?{label:"PF2E.Actor.Character.FeatSlot.MythicTier",min:0,max:10}:null,filter:{traits:["mythic"]},slots:[{id:"mythic-calling",label:"PF2E.Actor.Character.FeatSlot.MythicCallingShort",placeholder:"PF2E.Actor.Character.FeatSlot.MythicCallingPlaceholder",filter:{categories:["calling"]}},...[2,4,6,8,10,12,14,16,18,20].map((level,idx)=>{const tier=mythicSetting==="variant-tiers"?idx+1:null,label=String(mythicSetting==="variant-tiers"?idx+1:level),base={id:`mythic-${level}`,level,tier,label};return level===12?{...base,placeholder:"PF2E.Actor.Character.FeatSlot.MythicDestinyPlaceholder",filter:{traits:["destiny"]}}:{...base,filter:{categories:["class"],traits:["mythic"],omitTraits:["calling","destiny"],conjunction:"and"}}})],requiresInitial:!0}),game.pf2e.settings.campaign.feats.enabled&&this.createGroup({id:"campaign",label:"PF2E.Actor.Character.FeatSlot.CampaignHeader"})}bonus;createGroup(data){const group=new FeatGroup(this.actor,data);return this.set(data.id,group),group}async insertFeat(feat,slotData){const alreadyHasFeat=this.actor.items.has(feat.id);if(isBoonOrCurse(feat))return alreadyHasFeat?[]:this.actor.createEmbeddedDocuments("Item",[feat.toObject()]);const groupId=slotData?.groupId??"",{group,slotId}=this.get(groupId)?.isFeatValid(feat)?{group:this.get(groupId),slotId:slotData?.slotId??null}:this.#findBestLocation(feat,{requested:groupId}),isFeatValidInSlot=!!group?.isFeatValid(feat);if(groupId!=="bonus"&&!group){const badGroup=this.get(groupId);if(badGroup)return ui.notifications.warn(game.i18n.format("PF2E.Item.Feat.Warning.InvalidCategory",{item:feat.name,category:game.i18n.format(badGroup.label)})),[]}return alreadyHasFeat&&feat.system.location&&!isFeatValidInSlot?this.actor.updateEmbeddedDocuments("Item",[{_id:feat.id,"system.location":null}]):group?.insertFeat(feat,slotId)??this.bonus.insertFeat(feat)}#findBestLocation(feat,{requested}){if(feat.isFeature)return{group:this.get(feat.category)??null,slotId:null};if(requested==="bonus")return{group:null,slotId:null};const validGroups=this.filter(c=>c.isFeatValid(feat)&&!c.isFull),group=validGroups.at(0);if(validGroups.length===1&&group){const slotId=group.slotted?Object.values(group.slots).find(slot=>!slot?.feat)?.id??null:null;return{group,slotId}}return{group:null,slotId:null}}assignToSlots(){const groupsBySlot=this.contents.filter(g=>g.slotted).reduce((previous,current)=>{for(const slot of Object.keys(current.slots))previous[slot]=current;return previous},{}),feats=this.actor.itemTypes.feat.sort((f1,f2)=>f1.sort-f2.sort);for(const feat of feats.filter(f=>!isBoonOrCurse(f))){const grantedBy=feat.flags.pf2e.grantedBy;if(grantedBy&&!feat.system.location){const granter=this.actor.items.get(grantedBy.id),isNested=(granter?t$i(granter.flags.pf2e.itemGrants,(_,g)=>g.id):null)?.[feat.id]?.nested!==!1;if(granter?.isOfType("feat")&&granter.grants.includes(feat)&&isNested)continue}const location=feat.system.location??"";(groupsBySlot[location]??this.get(location)??this.get(feat.category))?.assignFeat(feat)||this.bonus.assignFeat(feat)}for(const group of this)group.postProcess()}}function isBoonOrCurse(feat){return["pfsboon","deityboon","curse"].includes(feat.category)}__name(isBoonOrCurse,"isBoonOrCurse"),__name2(isBoonOrCurse,"isBoonOrCurse");class CharacterPF2e extends CreaturePF2e{static{__name(this,"CharacterPF2e")}static{__name2(this,"CharacterPF2e")}get allowedItemTypes(){const buildItems=["ancestry","heritage","background","class","deity","feat"];return[...super.allowedItemTypes,...buildItems,"physical","spellcastingEntry","spell","action","lore","kit"]}get keyAttribute(){return this.system.details.keyability.value||"str"}get abilities(){return foundry.utils.deepClone(this.system.abilities)}get handsFree(){return this.system.hands.free.value}get handsReallyFree(){return this.system.hands.free.really}get hitPoints(){return{...super.hitPoints,recoveryMultiplier:this.system.attributes.hp.recoveryMultiplier,recoveryAddend:this.system.attributes.hp.recoveryAddend}}get heroPoints(){return foundry.utils.deepClone(this.system.resources.heroPoints)}getStatistic(slug,options){switch(slug){case"class":case"class-dc":case"classDC":return this.classDC;case"class-spell":{const highestClass=Object.values(this.classDCs).sort((a,b)=>b.mod-a.mod).shift(),highestSpell=this.spellcasting.contents.flatMap(s=>s.statistic??[]).sort((a,b)=>b.mod-a.mod).shift();return[highestClass,highestSpell].filter(e$1).sort((a,b)=>b.mod-a.mod).shift()??null}case"base-spellcasting":return this.spellcasting.base}return this.classDCs[slug]??super.getStatistic(slug,options)}_initialize(options){this.familiar??=null,super._initialize(options)}prepareData(){super.prepareData(),game.ready&&this.familiar&&game.actors.has(this.familiar.id)&&this.familiar.reset({fromMaster:!0})}prepareBaseData(){super.prepareBaseData();const levelData=this.system.details.level;(!Number.isInteger(levelData.value)||levelData.value<0)&&(levelData.value=1),this.system.traits={value:[],rarity:"unique",size:new ActorSizePF2e({value:"med"})};const flags=this.flags;flags.pf2e.favoredWeaponRank=0,flags.pf2e.freeCrafting??=!1,flags.pf2e.quickAlchemy??=!1,flags.pf2e.sheetTabs=foundry.utils.mergeObject(CHARACTER_SHEET_TABS.reduce((tabs2,tab)=>({...tabs2,[tab]:!0}),{}),flags.pf2e.sheetTabs??{}),flags.pf2e.showBasicUnarmed??=!0,flags.pf2e.featLimits??={};const isGradual=game.pf2e.settings.variants.gab,allowedBoosts=[1,5,10,15,20].reduce((result,level)=>{const allowed=this.level===0&&level===1?4:isGradual?4-Math.clamp(level-this.level,0,4):this.level>=level?4:0;return result[level]=allowed,result},{}),manualAttributes=Object.keys(this.system.abilities??{}).length>0;this.system.abilities=t$9(Array.from(ATTRIBUTE_ABBREVIATIONS),a=>[a,foundry.utils.mergeObject({mod:0},this.system.abilities?.[a]??{})]),this.system.perception.rank=0;const system2=this.system,existingBoosts=system2.build?.attributes?.boosts,isABP=game.pf2e.variantRules.AutomaticBonusProgression.isEnabled(this);system2.build={attributes:{manual:manualAttributes,keyOptions:[],boosts:{ancestry:[],background:[],class:null,1:existingBoosts?.[1]?.slice(0,allowedBoosts[1])??[],5:existingBoosts?.[5]?.slice(0,allowedBoosts[5])??[],10:existingBoosts?.[10]?.slice(0,allowedBoosts[10])??[],15:existingBoosts?.[15]?.slice(0,allowedBoosts[15])??[],20:existingBoosts?.[20]?.slice(0,allowedBoosts[20])??[]},allowedBoosts,flaws:{ancestry:[]},apex:isABP?system2.build?.attributes?.apex??null:null},languages:{value:0,max:0,granted:[]}},system2.saves=t$9(SAVE_TYPES,t2=>[t2,{rank:0,attribute:SAVING_THROW_ATTRIBUTES[t2]}]);const details=this.system.details;for(const property of["ancestry","heritage","background","class","deity"])this[property]=null,property==="deity"?details.deities={primary:null,secondary:null,domains:{}}:property!=="background"&&(details[property]=null);details.alliance=ALLIANCES.has(details.alliance)?details.alliance:this.hasPlayerOwner?"party":"opposition";const attributes=this.system.attributes;attributes.classDC=null,attributes.spellDC=null,attributes.classOrSpellDC={rank:0,value:0};const hitPoints=this.system.attributes.hp;hitPoints.recoveryMultiplier=1,hitPoints.recoveryAddend=0,attributes.ancestryhp=0,attributes.classhp=0,system2.skills=t$9(t$f(CONFIG.PF2E.skills),([key,{attribute}])=>{const rank=Math.clamp(this._source.system.skills[key]?.rank||0,0,4);return[key,{rank,attribute,armor:["dex","str"].includes(attribute)}]}),attributes.familiarAbilities={value:0},system2.proficiencies={...system2.proficiencies,classDCs:{}},system2.proficiencies.spellcasting??={rank:0};const{resources}=this.system,isMythic=game.pf2e.settings.campaign.mythic!=="disabled"&&this.itemTypes.feat.some(f=>f.category==="calling");resources.heroPoints.max=isMythic?0:3,resources.investiture={value:0,max:10},resources.focus={value:resources.focus?.value||0,max:0,cap:3},resources.crafting=foundry.utils.mergeObject({infusedReagents:{value:0,max:0}},resources.crafting??{}),resources.crafting.infusedReagents.max=0,resources.mythicPoints={value:resources.mythicPoints?.value??0,max:isMythic?3:0},this.system.traits.size=new ActorSizePF2e({value:"med"});const attacks=system2.proficiencies.attacks??={};for(const attack of Object.values(attacks).filter(e$7))attack.visible=!0;for(const category of Object.keys(CONFIG.PF2E.weaponCategories))attacks[category]={rank:attacks[category]?.rank??0,visible:!0};const defenses=system2.proficiencies.defenses??={};for(const category of ARMOR_CATEGORIES)defenses[category]={rank:defenses[category]?.rank??0,visible:!0};system2.crafting=foundry.utils.mergeObject({formulas:[],entries:{}},system2.crafting??{}),this.system.hands={max:{value:2,active:2},free:{value:2,really:2}},this.rollOptions.all[`self:level:${this.level}`]=!0}prepareEmbeddedDocuments(){super.prepareEmbeddedDocuments();for(const attribute of Object.values(this.system.abilities))attribute.mod=Math.trunc(attribute.mod)||0;const strengthRequirement=this.wornArmor?.system.strength;if(typeof strengthRequirement=="number"&&this.system.abilities.str.mod>=strengthRequirement)for(const selector of["dex-skill-check","str-skill-check"]){const rollOptions=this.rollOptions[selector]??={};rollOptions["armor:strength-requirement-met"]=!0}const build=this.system.build,sourceLanguages=this._source.system.details.languages.value.filter(l=>l in CONFIG.PF2E.languages);build.languages.granted=build.languages.granted.filter(l=>l.slug in CONFIG.PF2E.languages);const grantedLanguages=build.languages.granted.map(g=>g.slug);this.system.details.languages.value=n([...sourceLanguages,...grantedLanguages]);const commonAndCommon=["common",game.pf2e.settings.campaign.languages.commonLanguage].filter(e$1),countReducedBy=commonAndCommon.length===2&&commonAndCommon.every(l=>this.system.details.languages.value.includes(l))?1:0;build.languages.value=sourceLanguages.filter(l=>!grantedLanguages.includes(l)).length-countReducedBy,build.languages.max+=Math.max(this.system.abilities.int.mod,0),this.prepareHandsData(),this.setNumericRollOptions(),this.deity?.setFavoredWeaponRank()}prepareDataFromItems(){for(const feat of this.itemTypes.feat)feat.establishHierarchy();super.prepareDataFromItems(),this.prepareBuildData()}prepareHandsData(){const maxHands=this.system.hands.max.value;let heldCount=0,reallyHeldCount=0;for(const item of this.inventory){const handsHeld=item.handsHeld;handsHeld&&(reallyHeldCount+=handsHeld,item.type!=="shield"&&!item.system.traits.value.includes("free-hand")&&(heldCount+=handsHeld))}this.system.hands.free.value=Math.clamp(maxHands-heldCount,0,maxHands),this.system.hands.free.really=Math.clamp(maxHands-reallyHeldCount,0,maxHands)}prepareDerivedData(){super.prepareDerivedData(),this.crafting??=new CharacterCrafting(this),this.crafting.initialize(),imposeOversizedWeaponCondition(this),game.pf2e.variantRules.AutomaticBonusProgression.concatModifiers(this);const{synthetics,system:system2}=this;if(system2.details.xp.pct=Math.min(Math.round(system2.details.xp.value*100/system2.details.xp.max),99.5),system2.pfs.levelBump){const params={slug:"level-bump",label:"PF2E.PFS.LevelBump",modifier:1};this.synthetics.modifiers.all.push(()=>new Modifier(params)),this.synthetics.modifiers.damage.push(()=>new Modifier(params))}{const ancestryHP=system2.attributes.ancestryhp,classHP=system2.attributes.classhp,hitPoints=system2.attributes.hp,modifiers=[new Modifier("PF2E.AncestryHP",ancestryHP,"untyped")];if(game.pf2e.settings.variants.stamina){const halfClassHp=Math.floor(classHP/2);system2.attributes.hp.sp={value:system2.attributes.hp.sp?.value??0,max:(halfClassHp+system2.abilities.con.mod)*this.level},system2.resources.resolve={value:system2.resources.resolve?.value??0,max:system2.abilities[system2.details.keyability.value].mod},modifiers.push(new Modifier("PF2E.ClassHP",halfClassHp*this.level,"untyped"))}else{modifiers.push(new Modifier("PF2E.ClassHP",classHP*this.level,"untyped")),delete system2.resources.resolve;const conHP=system2.abilities.con.mod*Math.max(this.level,1);modifiers.push(new Modifier({slug:"hp-con",label:"PF2E.AbilityCon",ability:"con",type:"ability",modifier:conHP,adjustments:extractModifierAdjustments(synthetics.modifierAdjustments,["con-based"],"hp-con")}))}const hpRollOptions=this.getRollOptions(["hp"]);modifiers.push(...extractModifiers(synthetics,["hp"],{test:hpRollOptions}));const perLevelRollOptions=this.getRollOptions(["hp-per-level"]);modifiers.push(...extractModifiers(synthetics,["hp-per-level"],{test:perLevelRollOptions}).map(clone=>(clone.modifier*=this.level,clone)));const stat=foundry.utils.mergeObject(new StatisticModifier("hp",modifiers),hitPoints,{overwrite:!1});if(system2.pfs.levelBump){const hitPointsBump=Math.max(10,Math.floor(stat.totalModifier*.1));stat.push(new Modifier("PF2E.PFS.LevelBump",hitPointsBump,"untyped"))}stat.max=stat.totalModifier,stat.value=Math.min(stat.value,stat.max),stat.breakdown=stat.modifiers.filter(m=>m.enabled).map(m=>`${m.label} ${m.modifier<0?"":"+"}${m.modifier}`).join(", "),system2.attributes.hp=stat,setHitPointsRollOptions(this)}this.prepareFeats(),this.prepareSaves(),this.prepareMartialProficiencies(),this.perception=new PerceptionStatistic(this,{slug:"perception",label:"PF2E.PerceptionLabel",attribute:"wis",rank:system2.perception.rank,domains:["perception","all"],check:{type:"perception-check"},senses:system2.perception.senses}),system2.perception=foundry.utils.mergeObject(this.perception.getTraceData(),{attribute:this.perception.attribute??"wis",rank:system2.perception.rank}),this.prepareSkills(),this.classDC=null,this.classDCs={};for(const[slug,classDC]of Object.entries(system2.proficiencies.classDCs)){const statistic=this.prepareClassDC(slug,classDC);system2.proficiencies.classDCs[slug]=foundry.utils.mergeObject(classDC,statistic.getTraceData({value:"dc"})),this.classDCs[slug]=statistic,classDC.primary&&(this.classDC=statistic)}system2.attributes.classDC=Object.values(system2.proficiencies.classDCs).find(c=>c.primary)??null,system2.attributes.classDC&&(system2.attributes.classOrSpellDC=t$3(system2.attributes.classDC,["rank","value"]));const armorStatistic=this.createArmorStatistic();this.armorClass=armorStatistic.dc,system2.attributes.ac=foundry.utils.mergeObject(armorStatistic.getTraceData(),{attribute:armorStatistic.attribute??"dex"}),this.prepareMovementData(),system2.actions=this.prepareAttacks(),this.flags.pf2e.highestWeaponDamageDice=Math.max(...system2.actions.filter(s=>s.ready).map(s=>s.item.system.damage.dice),0),this.initiative=new ActorInitiative(this,t$3(system2.initiative,["statistic","tiebreakPriority"])),system2.initiative=this.initiative.getTraceData();const crafting=system2.resources.crafting;crafting.infusedReagents.max=Math.floor(crafting.infusedReagents.max)||0,crafting.infusedReagents.value=Math.clamp(crafting.infusedReagents.value,0,crafting.infusedReagents.max),system2.attributes.familiarAbilities.value>0&&(this.rollOptions.all["self:has-familiar"]=!0)}prepareBuildData(){const build=this.system.build;if(!build.attributes.manual){for(const section of["ancestry","background","class",1,5,10,15,20]){const boosts=build.attributes.boosts[section];if(typeof boosts=="string"){const ability=this.system.abilities[boosts];ability.mod+=ability.mod>=4?.5:1}else if(Array.isArray(boosts))for(const abbrev of boosts){const ability=this.system.abilities[abbrev];ability.mod+=ability.mod>=4?.5:1}const flaws=section==="ancestry"?build.attributes.flaws[section]:[];for(const abbrev of flaws){const ability=this.system.abilities[abbrev];ability.mod-=1}}const isABP=game.pf2e.variantRules.AutomaticBonusProgression.isEnabled(this);if(build.attributes.apex&&(!isABP||this.level>=17)){const attribute=this.system.abilities[build.attributes.apex];attribute.mod=Math.max(attribute.mod+1,4)}}for(const attribute of Object.values(this.system.abilities))attribute.mod=Math.clamp(attribute.mod,-5,10),attribute.base=Math.trunc(attribute.mod)}setNumericRollOptions(){const rollOptionsAll=this.rollOptions.all,perceptionRank=this.system.perception.rank;rollOptionsAll[`perception:rank:${perceptionRank}`]=!0;for(const key of ATTRIBUTE_ABBREVIATIONS){const mod=this.abilities[key].mod;rollOptionsAll[`attribute:${key}:mod:${mod}`]=!0}for(const key of t$4(CONFIG.PF2E.skills)){const rank=this.system.skills[key].rank;rollOptionsAll[`skill:${key}:rank:${rank}`]=!0}for(const key of t$4(CONFIG.PF2E.weaponCategories)){const rank=this.system.proficiencies.attacks[key].rank;rollOptionsAll[`attack:${key}:rank:${rank}`]=!0}for(const key of ARMOR_CATEGORIES){const rank=this.system.proficiencies.defenses[key].rank;rollOptionsAll[`defense:${key}:rank:${rank}`]=!0}for(const key of SAVE_TYPES){const rank=this.system.saves[key].rank;rollOptionsAll[`save:${key}:rank:${rank}`]=!0}const{handsFree,handsReallyFree}=this;this.attributes.handsFree=handsFree,rollOptionsAll[`hands-free:${handsFree}`]=!0,rollOptionsAll[`hands-free:but-really:${handsReallyFree}`]=!0}createArmorStatistic(){const{synthetics,wornArmor}=this;this.system.proficiencies.defenses["light-barding"].rank||=this.system.traits.value.includes("animal")&&!isReallyPC(this)?Math.max(this.system.proficiencies.defenses["light-barding"].rank,1):0;const modifiers=[],dexCapSources=[{value:1/0,source:""},...synthetics.dexterityModifierCaps];wornArmor&&dexCapSources.push({value:Number(wornArmor.dexCap??0),source:wornArmor.name});const dexCap=dexCapSources.reduce((lowest,candidate)=>lowest.value>candidate.value?candidate:lowest),dexModifier=createAttributeModifier({actor:this,attribute:"dex",domains:["all","ac","dex-based"],max:dexCap.value}),attributeModifier=modifiers.filter(m=>m.type==="ability"&&!!m.ability).reduce((best,modifier)=>modifier.modifier>best.modifier?modifier:best,dexModifier),attribute=attributeModifier.ability??"dex",rank=wornArmor?getItemProficiencyRank(this,wornArmor):this.system.proficiencies.defenses.unarmored.rank;return new ArmorStatistic(this,{rank,attribute,modifiers:[attributeModifier]})}prepareSaves(){const wornArmor=this.wornArmor;this.saves=t$9(SAVE_TYPES,saveType=>{const save=this.system.saves[saveType],saveName=game.i18n.localize(CONFIG.PF2E.saves[saveType]),modifiers=[],selectors=[saveType,`${save.attribute}-based`,"saving-throw","all"];if(wornArmor){const fromTraits=wornArmor.system.traits.config?.resilient??0,fromRunes=wornArmor.isInvested?wornArmor.system.runes.resilient:0,resilientModifier=Math.max(fromTraits,fromRunes);if(resilientModifier){const slug="resilient",modifierAdjustments=this.synthetics.modifierAdjustments;modifiers.push(new Modifier({slug,type:"item",label:wornArmor.name,modifier:resilientModifier,adjustments:extractModifierAdjustments(modifierAdjustments,selectors,slug)}))}}if(saveType==="reflex"&&wornArmor?.traits.has("bulwark")){const slug="bulwark",bulwarkModifier=new Modifier({slug,type:"untyped",label:CONFIG.PF2E.armorTraits.bulwark,modifier:3,predicate:["damaging-effect"],adjustments:extractModifierAdjustments(this.synthetics.modifierAdjustments,selectors,slug)});modifiers.push(bulwarkModifier),(this.synthetics.modifierAdjustments[saveType]??=[]).push({slug:"dex",test:__name2(options=>new Predicate("damaging-effect").test(options),"test"),suppress:!0})}const statistic=new Statistic(this,{slug:saveType,label:saveName,attribute:save.attribute,rank:save.rank,modifiers,domains:selectors,check:{type:"saving-throw"}});return this.system.saves[saveType]=foundry.utils.mergeObject(this.system.saves[saveType],statistic.getTraceData()),[saveType,statistic]})}prepareSkills(){const{synthetics,system:system2,wornArmor}=this;this.skills=t$9(t$f(CONFIG.PF2E.skills),([skillSlug,{label,attribute}])=>{const skill=system2.skills[skillSlug],domains=[skillSlug,`${attribute}-based`,"skill-check",`${attribute}-skill-check`,"all"],modifiers=[];if(skill.armor&&typeof wornArmor?.strength=="number"&&wornArmor.checkPenalty<0){const slug="armor-check-penalty",armorCheckPenalty=new Modifier({slug,label:"PF2E.ArmorCheckPenalty",modifier:wornArmor.checkPenalty,type:"untyped",adjustments:extractModifierAdjustments(synthetics.modifierAdjustments,domains,slug)});armorCheckPenalty.predicate.push({nor:["attack","armor:ignore-check-penalty"]}),["acrobatics","athletics"].includes(skillSlug)?armorCheckPenalty.predicate.push({nor:["armor:strength-requirement-met","armor:trait:flexible"]}):skillSlug==="stealth"&&wornArmor.traits.has("noisy")?armorCheckPenalty.predicate.push({nand:["armor:strength-requirement-met","armor:ignore-noisy-penalty"]}):armorCheckPenalty.predicate.push({not:"armor:strength-requirement-met"}),modifiers.push(armorCheckPenalty)}skillSlug==="athletics"&&modifiers.push(createForceOpenPenalty(this,domains));const statistic=new Statistic(this,{slug:skillSlug,label,rank:skill.rank,attribute,domains,modifiers,lore:!1,check:{type:"skill-check"}});return[skillSlug,statistic]});const loreItems=t$9(this.itemTypes.lore,loreItem=>[loreItem.slug,loreItem]);for(const[slug,loreItem]of Object.entries(loreItems)){const rank=loreItem.system.proficient.value;this.skills[slug]=new Statistic(this,{slug,label:loreItem.name,rank,attribute:"int",domains:[slug,"skill-check","lore-skill-check","int-skill-check","all"],lore:!0,check:{type:"skill-check"}})}this.system.skills=t$9(Object.entries(this.skills),([key,statistic])=>{const loreItem=statistic.lore?loreItems[statistic.slug]:null,baseData=this.system.skills[key]??{},data=foundry.utils.mergeObject(baseData,{...statistic.getTraceData(),rank:statistic.rank,armor:baseData.armor??!1,itemId:loreItem?.id??null,lore:!!statistic.lore});return[key,data]})}prepareMovementData(){const{wornArmor,heldShield}=this,basePenalty=wornArmor?.speedPenalty??0,strength=this.system.abilities.str.mod,requirement=wornArmor?.strength??null,penaltyValue=Math.min(typeof requirement=="number"&&strength>=requirement?Math.min(basePenalty+5,0):basePenalty,0),slug="armor-speed-penalty",armorPenalty=penaltyValue?new Modifier({slug,label:wornArmor?.name??"PF2E.ArmorSpeedLabel",domains:["all-speeds"],modifier:penaltyValue,type:"untyped",predicate:new Predicate({nor:["armor:ignore-speed-penalty"]})}):null,shieldPenalty=heldShield?.speedPenalty?new Modifier({slug:"shield-speed-penalty",label:heldShield.name,domains:["all-speeds"],modifier:heldShield.speedPenalty,predicate:new Predicate({not:"self:shield:ignore-speed-penalty"})}):null,hinderingPenalty=wornArmor?.traits.has("hindering")?new Modifier({slug:"hindering",label:"PF2E.TraitHindering",domains:["all-speeds"],modifier:-5}):null;super.prepareMovementData([armorPenalty,shieldPenalty,hinderingPenalty].filter(e$6))}prepareFeats(){this.pfsBoons=[],this.divineIntercessions=[],this.feats=new CharacterFeats(this);for(const section of game.pf2e.settings.campaign.feats.sections)this.feats.createGroup(section);this.feats.assignToSlots();const feats=this.itemTypes.feat.filter(f=>["pfsboon","deityboon","curse"].includes(f.category)).sort((f1,f2)=>f1.sort-f2.sort);for(const feat of feats)feat.category==="pfsboon"?this.pfsBoons.push(feat):this.divineIntercessions.push(feat)}prepareClassDC(slug,classDC){"ability"in classDC&&setHasElement(ATTRIBUTE_ABBREVIATIONS,classDC.ability)&&(classDC.attribute=classDC.ability),classDC.attribute??="str",classDC.rank??=0,classDC.primary??=!1;const classNames=CONFIG.PF2E.classTraits;return classDC.label=classDC.label??classNames[slug]??slug.titleCase(),new Statistic(this,{slug,label:classDC.label,attribute:classDC.attribute,rank:classDC.rank,domains:["class",slug,"all"],check:{type:"check"}})}prepareAttacks({includeBasicUnarmed=!0}={}){const{itemTypes,synthetics}=this,handwraps=itemTypes.weapon.find(w=>w.system.traits.otherTags.includes("handwraps-of-mighty-blows")&&w.category==="unarmed"&&w.isEquipped&&w.isInvested),unarmedRunes=foundry.utils.deepClone(handwraps?._source.system.runes)??{potency:0,striking:0,property:[]},basicUnarmed=includeBasicUnarmed?(()=>{const source2={_id:"xxPF2ExUNARMEDxx",name:game.i18n.localize("PF2E.WeaponTypeUnarmed"),type:"weapon",img:"icons/skills/melee/unarmed-punch-fist.webp",system:{slug:"basic-unarmed",category:"unarmed",baseItem:null,bonus:{value:0},damage:{dice:1,die:"d4",damageType:"bludgeoning"},equipped:{carryType:"worn",inSlot:!0,handsHeld:0},group:"brawling",traits:{value:["agile","finesse","nonlethal","unarmed"]},usage:{value:"worngloves"},runes:unarmedRunes}},attack=new WeaponPF2e(source2,{parent:this});for(const rule of this.synthetics.itemAlterations)rule.applyAlteration({singleItem:attack});return attack})():null,ammos=[...itemTypes.ammo.filter(i=>!i.isStowed),...itemTypes.weapon.filter(w=>w.system.usage.canBeAmmo)],syntheticWeapons=Object.values(synthetics.strikes).map(s=>s(unarmedRunes)).filter(e$6),weapons=[itemTypes.weapon.filter(w=>!w.system.traits.otherTags.includes("handwraps-of-mighty-blows")),syntheticWeapons,basicUnarmed??[],this.itemTypes.shield.filter(s=>!s.isStowed&&!s.isBroken&&!s.isDestroyed).map(s=>s.generateWeapon()),this.inventory.flatMap(i=>i.isEquipped?i.subitems.filter(sub=>sub.isOfType("weapon")&&!(i.isOfType("weapon")&&sub.isAmmoFor(i))):[])].flat().filter(e$1),handsReallyFree=this.handsReallyFree,attacks=weapons.map(w=>w.baseType==="grenade"||w.system.traits.config.area?this.prepareAreaAttack(w,{handsReallyFree,ammos}):this.prepareStrike(w,{handsReallyFree,ammos})).sort((a,b)=>a.label.toLocaleLowerCase(game.i18n.lang).replace(/[-0-9\s]/g,"").localeCompare(b.label.toLocaleLowerCase(game.i18n.lang).replace(/[-0-9\s]/gi,""),game.i18n.lang)).sort((a,b)=>a.slug==="basic-unarmed"?1:b.slug==="basic-unarmed"?-1:0).sort((a,b)=>a.item.isHeld===b.item.isHeld?0:a.item.isHeld?-1:1).sort((a,b)=>a.ready===b.ready?0:a.ready?-1:1);for(const attack of attacks){const weapon=attack.item;attack.altUsages.push(...weapon.getAltUsages().map(w=>this.prepareStrike(w,{handsReallyFree}))),attack.type==="area-fire"&&weapon.baseType!=="grenade"?attack.altUsages.unshift(this.prepareStrike(weapon,{handsReallyFree})):weapon.system.traits.value.includes("automatic")&&attack.altUsages.push(this.prepareAreaAttack(weapon,{handsReallyFree}))}for(const subitemStrike of attacks.filter(s=>s.item.parentItem)){const subitem=subitemStrike.item,parentStrike=attacks.find(s=>(s.item.shield??s.item)===subitem.parentItem);parentStrike&&(attacks.splice(attacks.indexOf(subitemStrike),1),attacks.splice(attacks.indexOf(parentStrike)+1,0,subitemStrike))}return attacks}prepareAreaAttack(weapon,{handsReallyFree,ammos=[]}){const actor=weapon.actor,action2=weapon.system.traits.value.includes("automatic")?"auto-fire":"area-fire",classDC=actor.getStatistic("class")??new Statistic(this,{slug:"class",label:"PF2E.Actor.Character.ClassDC.Label"}),tracking=weapon.system.traits.config?.tracking,statistic=classDC.extend({domains:["all",`${action2}-dc`],modifiers:tracking?[new Modifier({slug:"tracking",label:"PF2E.Item.Weapon.Tracking",type:"item",modifier:tracking})]:[]}),area=(()=>{if(weapon.baseType==="grenade"){const areaMatch=weapon.system.description.value.match(/Template\[burst\|distance:(?<distance>\d+)\]/);return{type:"burst",value:Number(areaMatch?.groups?.distance??5)}}const itemRange=weapon.system.range||actor.getReach({weapon});if(weapon.system.traits.value.includes("automatic"))return{type:"cone",value:Math.max(5,Math.floor(itemRange/2)-Math.floor(itemRange/2)%5)};const areaAnnotation=weapon.system.traits.config.area;if(!areaAnnotation)throw ErrorPF2e(`Unable to calculate area for weapon ${weapon.uuid}`);const type2=areaAnnotation.type;return{type:type2,value:areaAnnotation.value||(type2==="burst"?5:itemRange)}})(),actionLabel=`PF2E.Actions.${sluggify(action2,{camel:"bactrian"})}.Title`,weaponSlug=weapon.slug??sluggify(weapon.name),meleeOrRanged=weapon.isMelee?"melee":"ranged",actionCost={type:"action",value:weapon.baseType==="grenade"?1:2},weaponRollOptions=new Set(weapon.getRollOptions("item")),proficiencyRank=getItemProficiencyRank(actor,weapon,weaponRollOptions),options=[`self:action:slug:${action2}`,meleeOrRanged,"area-damage","area-effect",`item:proficiency:rank:${proficiencyRank}`,PROFICIENCY_RANK_OPTION[proficiencyRank],...weaponRollOptions],identifier=`${weapon.id}.${weaponSlug}.${action2}`,hiddenCauseStowed=weapon.isStowed&&this.flags.pf2e.hideStowed,hiddenCauseUnarmed=weapon.slug==="basic-unarmed"&&!this.flags.pf2e.showBasicUnarmed,handsAvailable=!weapon.system.graspingAppendage||handsReallyFree>0;return{slug:weaponSlug,type:action2,attackRollType:actionLabel,label:weapon.name,visible:!(hiddenCauseStowed||hiddenCauseUnarmed),glyph:getActionGlyph(actionCost),description:action2==="area-fire"?game.i18n.localize("PF2E.Actions.AreaFire.Description"):game.i18n.localize("PF2E.Actions.AutoFire.Description"),ready:weapon.isEquipped&&handsAvailable||weapon.isThrown&&weapon.reload==="0"&&weapon.isWorn&&handsReallyFree>0,canAttack:!0,altUsages:[],auxiliaryActions:getWeaponAuxiliaryActions(weapon),modifiers:[],item:weapon,statistic,handsAvailable,traits:["attack"].map(t2=>traitSlugToObject(t2,CONFIG.PF2E.actionTraits)),weaponTraits:weapon.system.traits.value.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.npcAttackTraits)).sort((a,b)=>a.label.localeCompare(b.label)),variants:[{label:game.i18n.format("PF2E.ActionWithDC",{label:game.i18n.localize(actionLabel),dc:statistic.dc.value}),roll:__name2(()=>{createAreaAttackMessage({actor,item:weapon,statistic,action:action2,identifier,actionCost,options,area})},"roll")}],...createDamageRollFunctions(weapon,{action:action2,statistic,baseOptions:options,actionTraits:["attack"],proficiencyRank}),ammunition:getAttackAmmo(weapon,{ammos})}}prepareStrike(weapon,{handsReallyFree,ammos=[]}){const synthetics=this.synthetics,modifiers=[],strikeAdjustments=[synthetics.strikeAdjustments,getPropertyRuneStrikeAdjustments(weapon.system.runes.property)].flat();for(const adjustment of strikeAdjustments)adjustment.adjustWeapon?.(weapon);processTwoHandTrait(weapon);const weaponTraits2=weapon.system.traits.value,weaponRollOptions=new Set(weapon.getRollOptions("item")),proficiencyRank=getItemProficiencyRank(this,weapon,weaponRollOptions),meleeOrRanged=weapon.isMelee?"melee":"ranged",baseOptions=["action:strike","self:action:slug:strike",`item:proficiency:rank:${proficiencyRank}`,PROFICIENCY_RANK_OPTION[proficiencyRank],...weaponTraits2,meleeOrRanged],attackDomains=getStrikeAttackDomains(weapon,proficiencyRank,baseOptions),defaultAttribute=weapon.defaultAttribute;modifiers.push(createAttributeModifier({actor:this,attribute:defaultAttribute,domains:attackDomains})),weapon.isMelee&&weaponTraits2.includes("finesse")&&modifiers.push(createAttributeModifier({actor:this,attribute:"dex",domains:attackDomains})),weapon.isRanged&&weaponTraits2.includes("brutal")&&modifiers.push(createAttributeModifier({actor:this,attribute:"str",domains:attackDomains})),modifiers.push(createProficiencyModifier({actor:this,rank:proficiencyRank,domains:attackDomains}));const initialRollOptions=new Set([...baseOptions,...this.getRollOptions(attackDomains),...weaponRollOptions]),ABP=game.pf2e.variantRules.AutomaticBonusProgression;if(weapon.group==="bomb"&&!ABP.isEnabled(this)){const attackBonus=Number(weapon.system.bonus?.value)||0;attackBonus!==0&&modifiers.push(new Modifier("PF2E.ItemBonusLabel",attackBonus,"item"))}{const grade=weapon.system.grade,potencyRune=weapon.system.runes.potency,trackingMod=weapon.system.traits.config.tracking||0,potencySynthetics=attackDomains.flatMap(key=>foundry.utils.deepClone(synthetics.weaponPotency[key]??[])).filter(wp=>wp.predicate.test(initialRollOptions)&&(!grade||wp.type==="potency")),bestSynthetic=potencySynthetics.length?potencySynthetics.reduce((highest,current)=>highest.bonus>current.bonus?highest:current):null,sources=[{slug:"weapon-potency",label:"PF2E.Item.Weapon.Rune.Potency",type:"item",modifier:potencyRune},{slug:"tracking",label:"PF2E.Item.Weapon.Tracking",type:"item",modifier:trackingMod}];bestSynthetic&&sources.push({slug:bestSynthetic.type==="item"?"weapon-potency":"attack-potency",label:bestSynthetic.label,type:bestSynthetic.type,modifier:bestSynthetic.bonus,magical:!0});const best=sources.reduce((result,current)=>result.modifier>=current.modifier?result:current);if(best.modifier>0){const{slug,type:type2}=best;modifiers.push(new Modifier({...t$3(best,["slug","type","label","modifier"]),adjustments:extractModifierAdjustments(synthetics.modifierAdjustments,attackDomains,slug)})),!weapon.isMagical&&best.magical&&(type2==="item"||!ABP.isEnabled(weapon.actor))&&weapon.system.traits.value.push("magical"),weapon.flags.pf2e.attackItemBonus=best.modifier}}const shoddyPenalty=createShoddyPenalty(this,weapon,attackDomains);shoddyPenalty&&modifiers.push(shoddyPenalty),modifiers.push(...PCAttackTraitHelpers.createAttackModifiers({item:weapon,domains:attackDomains}),...extractModifiers(synthetics,attackDomains,{injectables:{weapon},resolvables:{weapon}}));const weaponSlug=weapon.slug??sluggify(weapon.name),flavor=this.getStrikeDescription(weapon),rollOptions=[...this.getRollOptions(attackDomains),...weaponRollOptions,...weaponTraits2,meleeOrRanged],strikeStat=new StatisticModifier(weaponSlug,modifiers,rollOptions),versatileLabel=__name2(damageType=>{switch(damageType){case"bludgeoning":return CONFIG.PF2E.weaponTraits["versatile-b"];case"piercing":return CONFIG.PF2E.weaponTraits["versatile-p"];case"slashing":return CONFIG.PF2E.weaponTraits["versatile-s"];default:return CONFIG.PF2E.weaponTraits[`versatile-${damageType}`]??CONFIG.PF2E.damageTypes[damageType]}},"versatileLabel"),handsAvailable=!weapon.system.graspingAppendage||handsReallyFree>0,actionTraits2=["attack",weapon.baseType==="alchemical-bomb"?"manipulate":[]].flat();for(const adjustment of strikeAdjustments)adjustment.adjustTraits?.(weapon,actionTraits2);const ready2=weapon.isEquipped&&handsAvailable||weapon.isThrown&&weapon.reload==="0"&&weapon.isWorn&&handsReallyFree>0,traitToggles=weapon.system.traits.toggles,doubleBarrel=weaponTraits2.includes("double-barrel")?traitToggles.doubleBarrel:null,versatileOptions=weapon.altUsageType==="thrown"?[]:traitToggles.versatile.options.map(o=>({value:o,selected:traitToggles.versatile.selected===o,label:versatileLabel(o),glyph:DAMAGE_TYPE_ICONS[o]})),hiddenCauseStowed=weapon.isStowed&&this.flags.pf2e.hideStowed,hiddenCauseUnarmed=weapon.slug==="basic-unarmed"&&!this.flags.pf2e.showBasicUnarmed,action2=foundry.utils.mergeObject(strikeStat,{label:weapon.name,quantity:weapon.quantity,ready:ready2,domains:attackDomains,visible:!(hiddenCauseStowed||hiddenCauseUnarmed),glyph:"A",item:weapon,type:"strike",...flavor,options:Array.from(baseOptions),traits:actionTraits2.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.actionTraits)),handsAvailable,weaponTraits:weaponTraits2.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.npcAttackTraits)).sort((a,b)=>a.label.localeCompare(b.label)),variants:[],selectedAmmoId:weapon.system.selectedAmmoId,canAttack:!0,altUsages:[],auxiliaryActions:getWeaponAuxiliaryActions(weapon),doubleBarrel,versatileOptions,ammunition:getAttackAmmo(weapon,{ammos})});action2.versatileOptions.length>0&&action2.versatileOptions.unshift({value:weapon.system.damage.damageType,selected:traitToggles.versatile.selected===null,label:CONFIG.PF2E.damageTypes[weapon.system.damage.damageType],glyph:DAMAGE_TYPE_ICONS[weapon.system.damage.damageType]}),action2.breakdown=action2.modifiers.filter(m=>m.enabled).map(m=>`${m.label} ${m.signedValue}`).join(", ");const createMAPenalty=__name2((data,increases)=>increases===0?null:new Modifier({slug:data.slug,label:data.label,modifier:data[`map${increases}`],adjustments:extractModifierAdjustments(synthetics.modifierAdjustments,attackDomains,data.slug)}),"createMAPenalty"),initialMAPs=calculateMAPs(weapon,{domains:attackDomains,options:initialRollOptions}),checkModifiers=[(statistic,otherModifiers)=>new CheckModifier("strike",statistic,otherModifiers),(statistic,otherModifiers)=>new CheckModifier("strike-map1",statistic,otherModifiers),(statistic,otherModifiers)=>new CheckModifier("strike-map2",statistic,otherModifiers)];action2.variants=[0,1,2].map(mapIncreases=>({get label(){const penalty=createMAPenalty(initialMAPs,mapIncreases);return adjustModifiers([penalty].filter(e$1),initialRollOptions),penalty?game.i18n.format("PF2E.MAPAbbreviationValueLabel",{value:signedInteger(action2.totalModifier+penalty.value),penalty:penalty.value}):signedInteger(action2.totalModifier)},roll:__name2(async(params={})=>{params.options??=[];const expend=weapon.system.expend??0,configuredAmmo=weapon.ammo,ammoRemaining=configuredAmmo?.isOfType("ammo")?configuredAmmo.uses.max>1?configuredAmmo.uses.value:configuredAmmo.quantity:configuredAmmo?.quantity??0;if(params.consumeAmmo=weapon.system.ammo?.builtIn?!1:params.consumeAmmo??expend>0,params.consumeAmmo&&expend>ammoRemaining){const message=ammoRemaining?"PF2E.Strike.Ranged.InsufficientAmmo":"PF2E.Strike.Ranged.NoAmmo";return ui.notifications.warn(game.i18n.format(message,{weapon:weapon.name,actor:this.name})),null}const targetToken=params.getFormula?null:(params.target??game.user.targets.first())?.document??null,context=await new CheckContext({domains:attackDomains,origin:{actor:this,statistic:action2,item:weapon},target:{token:targetToken},against:"armor",options:new Set([...baseOptions,...params.options]),viewOnly:params.getFormula,traits:actionTraits2}).resolve();if(action2.traits=context.traits.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.actionTraits)),!context.origin)return null;const statistic=context.origin.statistic??action2,maps=calculateMAPs(context.origin.item,{domains:context.domains,options:context.options}),allModifiers=[createMAPenalty(maps,mapIncreases),params.modifiers,context.origin.modifiers].flat().filter(e$1),check=checkModifiers[mapIncreases](statistic,allModifiers);if(context.origin.item.isRanged&&typeof context.target?.distance=="number"){const maxRange=context.origin.item.range?.max??10;if(context.target.distance>maxRange)return ui.notifications.warn("PF2E.Action.Strike.OutOfRange",{localize:!0}),null}for(const rule of this.rules.filter(r2=>!r2.ignored))rule.beforeRoll?.(context.domains,context.options);const dc=params.dc??context.dc,notes=extractNotes(context.origin.actor.synthetics.rollNotes,context.domains),rollTwice=params.rollTwice||extractRollTwice(context.origin.actor.synthetics.rollTwice,context.domains,context.options),substitutions=extractRollSubstitutions(context.origin.actor.synthetics.rollSubstitutions,context.domains,context.options),dosAdjustments=[getPropertyRuneDegreeAdjustments(context.origin.item),extractDegreeOfSuccessAdjustments(context.origin.actor.synthetics,context.domains)].flat(),title=game.i18n.format(weapon.isMelee?"PF2E.Action.Strike.MeleeLabel":"PF2E.Action.Strike.RangedLabel",{weapon:weapon.name}),checkContext={type:"attack-roll",identifier:`${weapon.id}.${weaponSlug}.${meleeOrRanged}`,action:"strike",title,actor:context.origin.actor,token:context.origin.token,origin:context.origin,target:context.target,item:context.origin.item,altUsage:params.altUsage??null,damaging:context.origin.item.dealsDamage,domains:context.domains,options:context.options,notes,dc,traits:context.traits,rollTwice,substitutions,dosAdjustments,mapIncreases,createMessage:params.createMessage??!0};if(params.consumeAmmo&&!this.consumeAmmo(context.origin.item,params))return null;const roll=await Check.roll(check,checkContext,params.event,params.callback);if(roll)for(const rule of context.origin.actor.rules.filter(r2=>!r2.ignored))await rule.afterRoll?.({roll,check,context:checkContext,domains:context.domains,rollOptions:context.options});return roll},"roll")})),action2.attack=action2.roll=action2.variants[0].roll;const originalDiceUpgraded=weapon.flags.pf2e.damageFacesUpgraded;for(const method of["damage","critical"])action2[method]=async(params={})=>{params.options=new Set(params.options??[]);const targetToken=params.target??game.user.targets.first()??null,context=await new DamageContext({viewOnly:params.getFormula??!1,origin:{actor:this,statistic:action2,item:weapon},target:{token:targetToken?.document},domains:getAttackDamageDomains(weapon,proficiencyRank),outcome:method==="damage"?"success":"criticalSuccess",options:new Set([...baseOptions,...params.options]),traits:actionTraits2,checkContext:params.checkContext}).resolve();if(!context.origin)return null;const weaponClone=context.origin.item;if(!weaponClone?.isOfType("weapon"))throw Error();if(!weaponClone.dealsDamage)return params.getFormula?"":(ui.notifications.warn("PF2E.ErrorMessage.WeaponNoDamage",{localize:!0}),null);const outcome=method==="damage"?"success":"criticalSuccess",{origin,target,options}=context,damageContext={type:"damage-roll",sourceType:"attack",self:origin,target,outcome,options,domains:context.domains,traits:context.traits,createMessage:params.createMessage??!0,...eventToRollParams(params.event,{type:"damage"})};typeof params.mapIncreases=="number"&&(damageContext.mapIncreases=params.mapIncreases,damageContext.options.add(`map:increases:${params.mapIncreases}`)),params.getFormula&&(damageContext.skipDialog=!0);const damage=await WeaponDamagePF2e.calculate({weapon:weaponClone,actor:context.origin.actor,weaponPotency:weapon.flags.pf2e.attackItemBonus,context:damageContext});if(!damage)return null;if(weapon.flags.pf2e.damageFacesUpgraded=originalDiceUpgraded,params.getFormula){const formula=damage.damage.formula[outcome];return formula?new DamageRoll(formula).formula:""}else return DamagePF2e.roll(damage,damageContext,params.callback)};return action2}getStrikeDescription(weapon){const flavor={description:"PF2E.Strike.Default.Description",criticalSuccess:"PF2E.Strike.Default.CriticalSuccess",success:"PF2E.Strike.Default.Success"},traits=weapon.traits;return traits.has("unarmed")?(flavor.description="PF2E.Strike.Unarmed.Description",flavor.success="PF2E.Strike.Unarmed.Success"):[...traits].some(trait=>trait.startsWith("thrown-")||trait==="combination")?(flavor.description="PF2E.Strike.Combined.Description",flavor.success="PF2E.Strike.Combined.Success"):weapon.isMelee?(flavor.description="PF2E.Strike.Melee.Description",flavor.success="PF2E.Strike.Melee.Success"):(flavor.description="PF2E.Strike.Ranged.Description",flavor.success="PF2E.Strike.Ranged.Success"),{description:[createHTMLElement("p",{children:[game.i18n.localize(flavor.description)]}).outerHTML,createHTMLElement("hr").outerHTML,createHTMLElement("dl",{children:[createHTMLElement("dt",{innerHTML:game.i18n.localize("PF2E.CritSuccess")}),createHTMLElement("dd",{children:[game.i18n.localize(flavor.criticalSuccess)]}),createHTMLElement("dt",{innerHTML:game.i18n.localize("PF2E.Success")}),createHTMLElement("dd",{children:[game.i18n.localize(flavor.success)]})]}).outerHTML].join("")}}consumeAmmo(weapon,params){const ammo=weapon.ammo;if(ammo){if(ammo.quantity<1)return ui.notifications.warn(game.i18n.localize("PF2E.ErrorMessage.NotEnoughAmmo")),!1;{const existingCallback=params.callback;return params.callback=async(...args)=>{await existingCallback?.(...args),await weapon.consumeAmmo()},!0}}else return!0}prepareMartialProficiencies(){for(const key of["attacks","defenses"]){const proficiencies=this.system.proficiencies[key],linkedProficiencies=Object.values(proficiencies).filter(p=>!!p?.sameAs&&p.sameAs in proficiencies);for(const proficiency of linkedProficiencies){const category=proficiencies[proficiency.sameAs??""],maxRankIndex=PROFICIENCY_RANKS.indexOf(proficiency.maxRank??"legendary");proficiency.rank=Math.min(category?.rank??0,maxRankIndex)}const allProficiencies=Object.entries(proficiencies);for(const[_key,proficiency]of allProficiencies){if(!proficiency)continue;const duplicates=allProficiencies.flatMap(([k,p])=>p&&proficiency!==p&&proficiency.rank>=p.rank&&"definition"in proficiency&&"definition"in p&&proficiency.sameAs===p.sameAs&&t$6(p.definition??[],proficiency.definition??[])?k:[]);for(const duplicate of duplicates)delete proficiencies[duplicate];const proficiencyBonus=createProficiencyModifier({actor:this,rank:proficiency.rank,domains:[]});proficiency.value=proficiencyBonus.value,proficiency.breakdown=`${proficiencyBonus.label} ${proficiencyBonus.signedValue}`}}}async toggleInvested(itemId){const item=this.inventory.get(itemId);if(!item?.traits.has("invested"))throw ErrorPF2e("Unexpected error toggling item investment");const invested=item.isInvested;if(!invested&&!item.isEquipped){const newCarryType=item.system.usage.type==="carried"?"worn":item.system.usage.type;await this.changeCarryType(item,{carryType:newCarryType,handsHeld:item.system.usage.hands,inSlot:!0})}return!!await item.update({"system.equipped.invested":!invested})}async addAttackProficiency(key){const currentProficiencies=this.system.proficiencies.attacks;if(key in currentProficiencies)return;const newProficiency={rank:1,custom:!0};await this.update({[`system.proficiencies.attacks.${key}`]:newProficiency})}async _preUpdate(changed,options,user){if(!((options.diff??!0)&&(options.recursive??!0)))return super._preUpdate(changed,options,user);if(changed.flags?.pf2e?.freeCrafting?changed.flags.pf2e.quickAlchemy=!1:changed.flags?.pf2e?.quickAlchemy&&(changed.flags.pf2e.freeCrafting=!1),!changed.system)return super._preUpdate(changed,options,user);const attributeChanged=!!changed.system.build?.attributes&&!e$4(foundry.utils.diffObject(this._source.system.build?.attributes??{},changed.system.build.attributes)),levelData=changed.system.details?.level;levelData?.value!==void 0&&(Number.isInteger(levelData.value)||(levelData.value=1),levelData.value=Math.clamp(levelData.value,0,30));const newLevel=levelData?.value??this.level;if(newLevel!==this.level||attributeChanged){const hpMaxDifference=this.clone(changed).hitPoints.max-this.hitPoints.max;if(hpMaxDifference!==0){options.allowHPOverage=!0;const currentHP=this.hitPoints.value,newHP=Math.max(currentHP+hpMaxDifference,currentHP===0?0:1);changed.system=foundry.utils.mergeObject(changed.system,{attributes:{hp:{value:newHP}}})}}if(changed.system.resources?.crafting?.infusedReagents?.value!==void 0){const infusedReagents=changed.system.resources.crafting.infusedReagents,max=Math.max(0,this.system.resources.crafting.infusedReagents.max||0);infusedReagents.value=Math.clamp(Math.floor(infusedReagents.value||0),0,max)}game.pf2e.settings.variants.stamina&&(changed.system.attributes?.hp?.sp&&(changed.system.attributes.hp.sp.value=Math.floor(Math.clamp(changed.system.attributes.hp.sp?.value??0,0,this.system.attributes.hp.sp?.max??0))||0),changed.system.resources?.resolve&&(changed.system.resources.resolve.value=Math.floor(Math.clamp(changed.system.resources.resolve.value??0,0,this.system.resources.resolve?.max??0))||0));const xp=changed.system.details?.xp??{};typeof xp.value=="number"&&(xp.value=Math.max(xp.value,0)),typeof xp.max=="number"&&(xp.max=Math.max(xp.max,1));const actorClass=this.class;if(actorClass&&newLevel!==this.level){const current=this.itemTypes.feat.filter(feat=>feat.category==="classfeature");if(newLevel>this.level){const classFeaturesToCreate=(await actorClass.createGrantedItems({level:newLevel})).filter(feature=>feature.system.level.value>this.level&&!current.some(cf=>cf.sourceId===feature.sourceId)).map(i=>i.toObject());await this.createEmbeddedDocuments("Item",classFeaturesToCreate,{keepId:!0,render:!1})}else if(newLevel<this.level){const classFeaturestoDelete=current.filter(f=>f.level>newLevel&&!f.grantedBy).map(f=>f.id);await this.deleteEmbeddedDocuments("Item",classFeaturestoDelete,{render:!1})}}for(const property of["playerNumber","characterNumber"])if(typeof changed.system.pfs?.[property]=="number"){const[min,max]=property==="playerNumber"?[1,9999999]:[2001,9999];changed.system.pfs[property]=Math.clamp(changed.system.pfs[property]||0,min,max)}else changed.system.pfs&&changed.system.pfs[property]!==null&&(changed.system.pfs[property]=this.system.pfs[property]??null);return super._preUpdate(changed,options,user)}}class FamiliarPF2e extends CreaturePF2e{static{__name(this,"FamiliarPF2e")}static{__name2(this,"FamiliarPF2e")}get allowedItemTypes(){return[...super.allowedItemTypes,"action"]}get master(){if(!this.system.master.id)return null;const master=game.actors.get(this.system.master.id);return master?.isOfType("character")?(master.familiar??=this,master):null}get masterAttributeModifier(){const attribute=this.system.master.ability;return attribute?this.master?.system.abilities[attribute].mod??0:0}get masterAbilityModifier(){return this.masterAttributeModifier}get combatant(){return this.master?.combatant??null}reset({fromMaster=!1}={}){super.reset(),fromMaster&&this.sheet.render()}prepareBaseData(){super.prepareBaseData();const isItemBonus=new Predicate(["bonus:type:item"]);this.synthetics.modifierAdjustments.all.push({slug:null,test:__name2(options=>isItemBonus.test(options),"test"),suppress:!0});const master=this.master;master&&(this.flags.pf2e.rollOptions.all=foundry.utils.mergeObject(this.flags.pf2e.rollOptions.all,createEncounterRollOptions(master)))}prepareRuleElements(){return this.master?super.prepareRuleElements():[]}prepareDerivedData(){super.prepareDerivedData();const{level,master,masterAttributeModifier,system:system2}=this,attributeModifier=masterAttributeModifier>2?new Modifier(`PF2E.MasterAbility.${system2.master.ability}`,masterAttributeModifier,"untyped"):new Modifier("PF2E.Actor.Familiar.MinimumAttributeModifier",3,"untyped"),hitPoints=new HitPointsStatistic(this,{baseMax:level*5});this.system.attributes.hp=hitPoints.getTraceData(),setHitPointsRollOptions(this);const masterModifier=master?new Modifier({label:"PF2E.Actor.Familiar.Master.ArmorClass",slug:"base",modifier:master.armorClass.modifiers.filter(m=>m.enabled&&!["status","circumstance"].includes(m.type)).reduce((total,modifier)=>total+modifier.value,0)}):null,statistic=new ArmorStatistic(this,{modifiers:[masterModifier].filter(e$1)});this.armorClass=statistic.dc,system2.attributes.ac=foundry.utils.mergeObject(statistic.getTraceData(),{attribute:statistic.attribute??"dex"}),this.saves=SAVE_TYPES.reduce((partialSaves,saveType)=>{const source2=master?.saves[saveType]?.modifiers.filter(m=>!["status","circumstance"].includes(m.type))??[],totalMod=applyStackingRules(source2),attribute=CONFIG.PF2E.savingThrowDefaultAttributes[saveType],selectors=[saveType,`${attribute}-based`,"saving-throw","all"],stat=new Statistic(this,{slug:saveType,label:game.i18n.localize(CONFIG.PF2E.saves[saveType]),domains:selectors,modifiers:[new Modifier(`PF2E.MasterSavingThrow.${saveType}`,totalMod,"untyped")],check:{type:"saving-throw"}});return{...partialSaves,[saveType]:stat}},{}),system2.saves=SAVE_TYPES.reduce((partial,saveType)=>({...partial,[saveType]:this.saves[saveType].getTraceData()}),{});const masterLevel=game.pf2e.settings.variants.pwol.enabled?0:level;this.attackStatistic=new Statistic(this,{slug:"attack-roll",label:"PF2E.Familiar.AttackRoll",modifiers:[new Modifier("PF2E.MasterLevel",masterLevel,"untyped")],check:{type:"attack-roll"}}),system2.attack=this.attackStatistic.getTraceData(),this.perception=new PerceptionStatistic(this,{slug:"perception",label:"PF2E.PerceptionLabel",attribute:"wis",domains:["perception","wis-based","all"],modifiers:[new Modifier("PF2E.MasterLevel",masterLevel,"untyped"),attributeModifier],check:{type:"perception-check"},senses:system2.perception.senses}),system2.perception=foundry.utils.mergeObject(this.perception.getTraceData(),{attribute:"wis"}),this.skills=t$9(t$f(CONFIG.PF2E.skills),([skill,{label,attribute}])=>{const modifiers=[new Modifier("PF2E.MasterLevel",masterLevel,"untyped")];["acrobatics","stealth"].includes(skill)&&modifiers.push(attributeModifier);const domains=[skill,`${attribute}-based`,"skill-check","all"],statistic2=new Statistic(this,{slug:skill,label,attribute,domains,modifiers,lore:!1,check:{type:"skill-check"}});return this.system.skills[skill]=foundry.utils.mergeObject(statistic2.getTraceData(),{attribute}),[skill,statistic2]}),this.prepareMovementData()}async _preUpdate(changed,options,user){return(changed.system?.master?.id??this.system.master.id)!==this.system.master.id&&(options.previousMaster=this.master?.uuid),changed.system?.master&&(changed.system.master.ability||=null),super._preUpdate(changed,options,user)}_onUpdate(changed,options,userId){if(super._onUpdate(changed,options,userId),options.previousMaster&&options.previousMaster!==this.master?.uuid){const previousMaster=fromUuidSync(options.previousMaster);previousMaster?.isOfType("character")&&(previousMaster.familiar=null)}}_onDelete(options,userId){this.master&&(this.master.familiar=null),super._onDelete(options,userId)}}const identifySkills=new Map([["aberration",["occultism"]],["animal",["nature"]],["astral",["occultism"]],["beast",["arcana","nature"]],["celestial",["religion"]],["construct",["arcana","crafting"]],["dragon",["arcana"]],["dream",["occultism"]],["elemental",["arcana","nature"]],["ethereal",["occultism"]],["fey",["nature"]],["fiend",["religion"]],["fungus",["nature"]],["humanoid",["society"]],["monitor",["religion"]],["ooze",["occultism"]],["shade",["religion"]],["plant",["nature"]],["spirit",["occultism"]],["time",["occultism"]],["undead",["religion"]]]);function toKnowledgeDC(dc,rarity,loreAdjustment="normal"){const rarityAdjustment=rarityToDCAdjustment(rarity),start=combineDCAdjustments(rarityAdjustment,loreAdjustment),progression=createDifficultyScale(dc,start);return{dc:adjustDC(dc,start),progression,start}}__name(toKnowledgeDC,"toKnowledgeDC"),__name2(toKnowledgeDC,"toKnowledgeDC");function creatureIdentificationDCs(creature,{pwol=!1}={}){const{level,rarity}=creature,dc=calculateDC(level,{pwol}),traits=creature.system.traits.value;return{skills:Array.from(new Set(traits.flatMap(t2=>identifySkills.get(t2)??[]))),standard:toKnowledgeDC(dc,rarity,"normal"),lore:[toKnowledgeDC(dc,rarity,"easy"),toKnowledgeDC(dc,rarity,"very-easy")]}}__name(creatureIdentificationDCs,"creatureIdentificationDCs"),__name2(creatureIdentificationDCs,"creatureIdentificationDCs");class NPCPF2e extends CreaturePF2e{static{__name(this,"NPCPF2e")}static{__name2(this,"NPCPF2e")}get allowedItemTypes(){return[...super.allowedItemTypes,"physical","spellcastingEntry","spell","action","melee","lore"]}get baseLevel(){return this._source.system.details.level.value}get abilities(){return foundry.utils.deepClone(this.system.abilities)}get description(){return this.system.details.publicNotes}get isElite(){return this.attributes.adjustment==="elite"}get isWeak(){return this.attributes.adjustment==="weak"}get identificationDCs(){const pwol=game.pf2e.settings.variants.pwol.enabled;return creatureIdentificationDCs(this,{pwol})}get visible(){return super.visible&&this.prototypeToken.actorLink||this.permission>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER}canUserModify(user,action2){return super.canUserModify(user,action2)||action2==="update"&&this.isDead&&(this.flags.pf2e.lootable||game.settings.get("pf2e","automation.lootableNPCs"))}prepareBaseData(){super.prepareBaseData(),this.flags.pf2e.lootable??=!1,this.system.actions=[];for(const key of SAVE_TYPES)this.system.saves[key].attribute=CONFIG.PF2E.savingThrowDefaultAttributes[key];const{attributes,details}=this.system;details.alliance===void 0&&(details.alliance=this.hasPlayerOwner?"party":"opposition"),attributes.hp.negativeHealing=this.system.traits.value.includes("undead"),attributes.flanking.flankable=!this.system.traits.value.includes("troop");const level=details.level;level.base=Math.clamp(level.value,-1,100),level.value=this.isElite?level.base<1?level.base+2:level.base+1:this.isWeak?level.base===1?level.base-2:level.base-1:level.base,this.rollOptions.all[`self:level:${level.value}`]=!0,attributes.spellDC=null,attributes.classDC=(()=>{const pwol=game.pf2e.settings.variants.pwol.enabled,levelBasedDC=calculateDC(level.base,{pwol,rarity:this.rarity});return{value:this.isElite?levelBasedDC+2:this.isWeak?levelBasedDC-2:levelBasedDC}})(),attributes.classOrSpellDC={value:attributes.classDC.value},this.system.spellcasting=foundry.utils.mergeObject({rituals:{dc:0}},this.system.spellcasting);const resources=this.system.resources;resources.focus=foundry.utils.mergeObject({value:0,max:0,cap:3},resources.focus),resources.mythicPoints={value:resources.mythicPoints?.value??3,max:this.system.traits.value.includes("mythic")?3:0};const speeds=this.system.movement.speeds,sourceSpeeds=this._source.system.attributes.speed;speeds.land={value:sourceSpeeds.value,base:sourceSpeeds.value};const otherSpeeds=sourceSpeeds.otherSpeeds;for(const speed of otherSpeeds)speeds[speed.type]={value:speed.value,base:speed.value}}prepareDerivedData(){super.prepareDerivedData();const{system:system2,synthetics}=this,modifierAdjustments=synthetics.modifierAdjustments,baseLevel=system2.details.level.base;synthetics.modifiers.hp??=[],this.isElite?(modifierAdjustments.all.push({slug:"base",getNewValue:__name2(base=>base+2,"getNewValue"),test:__name2(()=>!0,"test")}),synthetics.modifiers.hp.push(()=>new Modifier("PF2E.NPC.Adjustment.EliteLabel",this.getHpAdjustment(baseLevel,"elite"),"untyped"))):this.isWeak&&(modifierAdjustments.all.push({slug:"base",getNewValue:__name2(base=>base-2,"getNewValue"),test:__name2(()=>!0,"test")}),synthetics.modifiers.hp.push(()=>new Modifier("PF2E.NPC.Adjustment.WeakLabel",this.getHpAdjustment(baseLevel,"weak")*-1,"untyped"))),system2.details.level.base=baseLevel;for(const attribute of Object.values(system2.abilities))attribute.mod=Math.trunc(Number(attribute.mod))||0;{const base=system2.attributes.hp.max,modifiers=[extractModifiers(synthetics,["hp"],{test:this.getRollOptions(["hp"])}),extractModifiers(synthetics,["hp-per-level"],{test:this.getRollOptions(["hp-per-level"])}).map(modifier=>(modifier.modifier*=this.level,modifier))].flat(),hpData=foundry.utils.deepClone(system2.attributes.hp),stat=foundry.utils.mergeObject(new StatisticModifier("hp",modifiers),hpData,{overwrite:!1});stat.base=base,stat.max=stat.max+stat.totalModifier,stat.value=Math.min(stat.value,stat.max),stat.breakdown=[game.i18n.format("PF2E.MaxHitPointsBaseLabel",{base}),...stat.modifiers.filter(m=>m.enabled).map(m=>`${m.label} ${signedInteger(m.modifier)}`)].join(", "),system2.attributes.hp=stat,setHitPointsRollOptions(this)}this.prepareMovementData();const armorStatistic=new ArmorStatistic(this,{modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:system2.attributes.ac.value-10,adjustments:extractModifierAdjustments(modifierAdjustments,["all","ac","dex-based"],"base")})],details:system2.attributes.ac.details});this.armorClass=armorStatistic.dc,system2.attributes.ac=foundry.utils.mergeObject(armorStatistic.getTraceData(),{attribute:armorStatistic.attribute??"dex"}),this.prepareSaves();{const domains=["perception","wis-based","all"];this.perception=new PerceptionStatistic(this,{slug:"perception",label:"PF2E.PerceptionLabel",attribute:"wis",domains,modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:system2.perception.mod,adjustments:extractModifierAdjustments(modifierAdjustments,domains,"base")})],check:{type:"perception-check"},senses:system2.perception.senses,vision:system2.perception.vision}),system2.perception=foundry.utils.mergeObject(this.perception.getTraceData(),{attribute:this.perception.attribute??"wis",details:system2.perception.details,mod:this.perception.mod})}this.prepareSkills();const generatedMelee=Object.values(synthetics.strikes).map(s=>s()).filter(e$6).flatMap(w=>w.toNPCAttacks({keepId:!0})),meleeItems=t([this.itemTypes.melee,generatedMelee].flat(),m=>m.system.action==="strike"?0:1,m=>m.name,m=>m.sort);for(const item of meleeItems)system2.actions.push(attackFromMeleeItem(item));this.initiative=new ActorInitiative(this,t$3(system2.initiative,["statistic","tiebreakPriority"])),system2.initiative=this.initiative.getTraceData()}prepareSaves(){const system2=this.system,modifierAdjustments=this.synthetics.modifierAdjustments,saves={};for(const saveType of SAVE_TYPES){const save=system2.saves[saveType],saveName=game.i18n.localize(CONFIG.PF2E.saves[saveType]),base=save.value,attribute=save.attribute,domains=[saveType,`${attribute}-based`,"saving-throw","all"],statistic=new Statistic(this,{slug:saveType,label:saveName,domains,modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:base,adjustments:extractModifierAdjustments(modifierAdjustments,domains,"base")})],check:{type:"saving-throw"}});saves[saveType]=statistic,foundry.utils.mergeObject(this.system.saves[saveType],statistic.getTraceData()),system2.saves[saveType].base=base}this.saves=saves}prepareSkills(){const modifierAdjustments=this.synthetics.modifierAdjustments;this.skills=t$9(t$f(CONFIG.PF2E.skills),([skillSlug,{attribute,label}])=>{const skill=this._source.system.skills[skillSlug],domains=[skillSlug,`${attribute}-based`,"skill-check",`${attribute}-skill-check`,"all"],specialModifiers=skill?.special?.filter(v=>v.predicate?.length).map(special=>new Modifier({slug:"variant",label:special.label,modifier:special.base-skill.base,predicate:special.predicate,hideIfDisabled:!0,domains}))??[],statistic=new Statistic(this,{slug:skillSlug,label,attribute,domains,modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:skill?.base??this.system.abilities[attribute].mod,adjustments:extractModifierAdjustments(modifierAdjustments,domains,"base")}),...specialModifiers],lore:!1,proficient:skillSlug in this._source.system.skills,check:{type:"skill-check"}});return[skillSlug,statistic]});const loreItems=t$9(this.itemTypes.lore,loreItem=>[loreItem.slug,loreItem]);for(const[slug,loreItem]of Object.entries(loreItems)){const domains=[slug,"skill-check","lore-skill-check","int-skill-check","all"],statistic=new Statistic(this,{slug,label:loreItem.name,attribute:"int",domains,modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:loreItem.system.mod.value,adjustments:extractModifierAdjustments(modifierAdjustments,domains,"base")})],lore:!0,proficient:!0,check:{type:"skill-check"}});this.skills[slug]=statistic}this.system.skills=t$9(Object.entries(this.skills),([key,statistic])=>{const loreItem=statistic.lore?loreItems[statistic.slug]:null,baseData=this.system.skills[key]??{base:loreItem?.system.mod.value??0},data=foundry.utils.mergeObject(baseData,{...statistic.getTraceData(),mod:statistic.check.mod,itemId:loreItem?.id??null,lore:!!statistic.lore,visible:statistic.proficient}),enabledVariantMod=statistic.check.modifiers.find(m=>m.slug==="variant"&&m.enabled)?.modifier??0;data.special??=[];for(const variant of data.special)variant.mod=variant.base+(statistic.check.mod-baseData.base-enabledVariantMod);return[key,data]})}async getAttackEffects(attack){const notes=[];attack.description&&notes.push(new RollNotePF2e({selector:"all",visibility:"gm",text:attack.description}));const formatItemName=__name2(item=>{if(item.isOfType("consumable")){const button=createHTMLElement("button",{dataset:{action:"consume",item:item.id}});return button.style.width="auto",button.style.lineHeight="14px",button.innerHTML=game.i18n.localize("PF2E.Item.Consumable.Uses.Use"),`${item.name} - ${game.i18n.localize("TYPES.Item.consumable")} (${item.quantity}) ${button.outerHTML}`}return item.name},"formatItemName"),formatNoteText=__name2(item=>{const rollData=item.getRollData();return TextEditorPF2e.enrichHTML(item.description,{rollData})},"formatNoteText");for(const attackEffect of attack.attackEffects){const item=this.items.find(i=>i.type!=="melee"&&(i.slug??sluggify(i.name))===sluggify(attackEffect));if(item){const note=new RollNotePF2e({selector:"all",visibility:"gm",title:formatItemName(item),text:await formatNoteText(item)});notes.push(note)}else{const packItem=(await game.packs.get("pf2e.bestiary-ability-glossary-srd",{strict:!0}).getDocuments({system:{slug:attackEffect}}))[0];if(packItem instanceof Item){const note=new RollNotePF2e({selector:"all",visibility:"gm",title:formatItemName(packItem),text:await formatNoteText(packItem)});notes.push(note)}}}return notes}getHpAdjustment(level,adjustment){if(adjustment==="elite"){if(level>=20)return 30;if(level<=19&&level>=5)return 20;if(level<=4&&level>=2)return 15;if(level<=1)return 10}else if(adjustment==="weak"){if(level>=21)return 30;if(level<=20&&level>=6)return 20;if(level<=5&&level>=3)return 15;if(level===1||level===2)return 10}return 0}async applyAdjustment(adjustment){const{isElite,isWeak}=this;if(isElite&&adjustment==="elite"||isWeak&&adjustment==="weak"||!isElite&&!isWeak&&!adjustment)return;const currentHPAdjustment=isElite?this.getHpAdjustment(this.baseLevel,"elite"):isWeak?this.getHpAdjustment(this.baseLevel,"weak"):0,newHPAdjustment=this.getHpAdjustment(this.baseLevel,adjustment),currentHP=this.system.attributes.hp.value,maxHP=this.system.attributes.hp.max,newHP=(()=>{if(isElite){if(adjustment==="weak")return currentHP-currentHPAdjustment-newHPAdjustment;if(!adjustment)return currentHP-currentHPAdjustment}else if(isWeak){if(adjustment==="elite")return this.system.attributes.hp.max=maxHP+currentHPAdjustment+newHPAdjustment,currentHP+currentHPAdjustment+newHPAdjustment;if(!adjustment)return this.system.attributes.hp.max=maxHP+currentHPAdjustment,currentHP+currentHPAdjustment}else{if(adjustment==="elite")return this.system.attributes.hp.max=currentHP+newHPAdjustment,currentHP+newHPAdjustment;if(adjustment==="weak")return currentHP-newHPAdjustment}return currentHP})();await this.update({"system.attributes.hp.value":Math.max(0,newHP),"system.attributes.adjustment":adjustment})}variantClone(params){const source2=this._source,changes={name:params.name??this.name,system:{details:{publicNotes:params.description??source2.system.details.publicNotes}},img:params.img?.actor??source2.img,prototypeToken:{texture:{src:params.img?.token??source2.prototypeToken.texture.src}}};return this.clone(changes,{save:params.save,keepId:params.keepId})}async _preUpdate(changed,options,user){const result=await super._preUpdate(changed,options,user);if(!((options.diff??!0)&&(options.recursive??!0))||result===!1||!changed.system)return result;if(this.#updatePrototypeToken(changed),changed.system.skills)for(const[key,skill]of Object.entries(changed.system.skills))key.startsWith("-=")||!skill||skill.note===""&&(delete skill.note,foundry.utils.mergeObject(skill,{"-=note":null}))}async#updatePrototypeToken(changes){if(this.isToken||!this.prototypeToken.flags.pf2e.linkToActorSize||!changes.system?.traits?.size?.value)return;const newSize=new ActorSizePF2e({value:changes.system.traits.size.value}),currentSize=this.system.traits.size;if(newSize.wide!==currentSize.wide||newSize.long!==currentSize.long){const prototypeToken=changes.prototypeToken??={};prototypeToken.width=newSize.wide/5,prototypeToken.height=newSize.long/5}}}function resolveKingdomBoosts(entry,choices){const notFreeBoosts=entry.boosts.filter(b=>b!=="free");return n([notFreeBoosts,choices].flat()).filter(b=>b!==entry.flaw).slice(0,entry.boosts.length)}__name(resolveKingdomBoosts,"resolveKingdomBoosts"),__name2(resolveKingdomBoosts,"resolveKingdomBoosts");function calculateKingdomCollectionData(kingdom){const commodityTypes=["luxuries","lumber","ore","stone"];return{formula:`${kingdom.resources.dice.number}d${kingdom.resources.dice.faces}`,commodities:t$9(commodityTypes,type2=>{const value=kingdom.resources.workSites[type2];return[type2,value.value+value.resource*2]})}}__name(calculateKingdomCollectionData,"calculateKingdomCollectionData"),__name2(calculateKingdomCollectionData,"calculateKingdomCollectionData");async function importDocuments(actor,items,skipDialog){const createData=items.filter(d=>!actor.items.some(i=>i.sourceId===d.uuid)).map(d=>d.toObject()),incomingDataByUUID=t$9(items,d=>[d.uuid,d.toObject(!0)]),updateData=actor.itemTypes.campaignFeature.map(d=>{const incoming=d.sourceId&&incomingDataByUUID[d.sourceId];if(!incoming)return null;const data=t$3(incoming,["name","img","system"]),diff=foundry.utils.diffObject(d.toObject(!0),data);return e$4(diff)?null:{_id:d.id,...diff}}).filter(e$1);!updateData.length&&!createData.length||!skipDialog&&!await foundry.applications.api.DialogV2.confirm({window:{title:"PF2E.Kingmaker.Kingdom.ImportDialog.Title",icon:"fa-solid cloud-arrow-down"},content:game.i18n.format("PF2E.Kingmaker.Kingdom.ImportDialog.Content",{added:createData.length,updated:updateData.length}),yes:{default:!0}})||(await actor.updateEmbeddedDocuments("Item",updateData),await actor.createEmbeddedDocuments("Item",createData))}__name(importDocuments,"importDocuments"),__name2(importDocuments,"importDocuments");const KINGDOM_ABILITIES=["culture","economy","loyalty","stability"],KINGDOM_LEADERSHIP=["ruler","counselor","general","emissary","magister","treasurer","viceroy","warden"],KINGDOM_COMMODITIES=["food","luxuries","lumber","ore","stone"],KINGDOM_SKILLS=["agriculture","arts","boating","defense","engineering","exploration","folklore","industry","intrigue","magic","politics","scholarship","statecraft","trade","warfare","wilderness"],KINGDOM_LEADERSHIP_ABILITIES={ruler:"loyalty",counselor:"culture",general:"stability",emissary:"loyalty",magister:"culture",treasurer:"economy",viceroy:"economy",warden:"stability"},KINGDOM_SKILL_ABILITIES={agriculture:"stability",arts:"culture",boating:"economy",defense:"stability",engineering:"stability",exploration:"economy",folklore:"culture",industry:"economy",intrigue:"loyalty",magic:"culture",politics:"loyalty",scholarship:"culture",statecraft:"loyalty",trade:"economy",warfare:"loyalty",wilderness:"stability"},KINGDOM_ABILITY_LABELS=t$9(KINGDOM_ABILITIES,a=>[a,`PF2E.Kingmaker.Abilities.${a}`]),KINGDOM_COMMODITY_LABELS=t$9(KINGDOM_COMMODITIES,c=>[c,`PF2E.Kingmaker.Kingdom.Commodity.${c}`]),KINGDOM_RUIN_LABELS={culture:"PF2E.Kingmaker.Kingdom.Ruin.corruption",economy:"PF2E.Kingmaker.Kingdom.Ruin.crime",stability:"PF2E.Kingmaker.Kingdom.Ruin.decay",loyalty:"PF2E.Kingmaker.Kingdom.Ruin.strife"},KINGDOM_SKILL_LABELS=t$9(KINGDOM_SKILLS,a=>[a,`PF2E.Kingmaker.Skills.${a}`]),CONTROL_DC_BY_LEVEL=[14,15,16,18,20,22,23,24,26,27,28,30,31,32,34,35,36,38,39,40],KINGDOM_SIZE_DATA={1:{faces:4,type:"territory",controlMod:0,storage:4},10:{faces:6,type:"province",controlMod:1,storage:8},25:{faces:8,type:"state",controlMod:2,storage:12},50:{faces:10,type:"country",controlMod:3,storage:16},100:{faces:12,type:"dominion",controlMod:4,storage:20}},KINGDOM_SETTLEMENT_TYPES=["village","town","city","metropolis"],KINGDOM_SETTLEMENT_TYPE_LABELS=t$9(KINGDOM_SETTLEMENT_TYPES,size=>[size,`PF2E.Kingmaker.Settlement.Type.${size}`]),KINGDOM_SETTLEMENT_TYPE_DATA={village:{blocks:1,population:[0,400],level:[1,1],consumption:1,maxItemBonus:1,influence:0},town:{blocks:4,population:[401,2e3],level:[2,4],consumption:2,maxItemBonus:1,influence:1},city:{blocks:9,population:[2001,25e3],level:[5,9],consumption:4,maxItemBonus:2,influence:2},metropolis:{blocks:1/0,population:[25001,1/0],level:[10,1/0],consumption:6,maxItemBonus:3,influence:3}},vacancyLabel=__name2(role=>game.i18n.format("PF2E.Kingmaker.Kingdom.VacantRole",{role:game.i18n.localize(`PF2E.Kingmaker.Kingdom.LeadershipRole.${role}`)}),"vacancyLabel"),VACANCY_PENALTIES={ruler:__name2(()=>({modifiers:{"kingdom-check":[{slug:"vacancy-ruler",label:vacancyLabel("ruler"),modifier:-1}],"control-dc":[{slug:"vacancy-ruler",label:vacancyLabel("ruler"),modifier:2}]}}),"ruler"),counselor:__name2(()=>({modifiers:{"culture-based":[{slug:"vacancy",label:vacancyLabel("counselor"),modifier:-1}]}}),"counselor"),general:__name2(()=>({modifiers:{warfare:[{slug:"vacancy",label:vacancyLabel("general"),modifier:0}]},adjustments:{warfare:[{slug:"vacancy",test:__name2(()=>!0,"test"),relabel:vacancyLabel("general"),getNewValue:__name2(()=>-4,"getNewValue")}]}}),"general"),emissary:__name2(()=>({modifiers:{"loyalty-based":[{slug:"vacancy",label:vacancyLabel("emissary"),modifier:-1}]}}),"emissary"),magister:__name2(()=>({modifiers:{warfare:[{slug:"vacancy",label:vacancyLabel("magister"),modifier:0}]},adjustments:{warfare:[{slug:"vacancy",test:__name2(()=>!0,"test"),relabel:vacancyLabel("magister"),getNewValue:__name2(()=>-4,"getNewValue")}]}}),"magister"),treasurer:__name2(()=>({modifiers:{"economy-based":[{slug:"vacancy",label:vacancyLabel("treasurer"),modifier:-1}]}}),"treasurer"),viceroy:__name2(()=>({modifiers:{"stability-based":[{slug:"vacancy",label:vacancyLabel("viceroy"),modifier:-1}]}}),"viceroy"),warden:__name2(()=>({modifiers:{"kingdom-check":[{slug:"vacancy",label:vacancyLabel("warden"),modifier:0}]},adjustments:{"kingdom-check":[{slug:"vacancy",test:__name2(options=>[...options].includes("region"),"test"),relabel:vacancyLabel("warden"),getNewValue:__name2(()=>-4,"getNewValue")}]}}),"warden")};function getKingdomCHGData(){const localize=localizer("PF2E.Kingmaker");return{charter:{conquest:{name:localize("Charter.conquest.Name"),description:localize("Charter.conquest.Description"),img:"icons/weapons/swords/sword-guard-steel-green.webp",boosts:["loyalty","free"],flaw:"culture"},expansion:{name:localize("Charter.expansion.Name"),description:localize("Charter.expansion.Description"),img:"icons/skills/trades/woodcutting-logging-axe-stump.webp",boosts:["culture","free"],flaw:"stability"},exploration:{name:localize("Charter.exploration.Name"),description:localize("Charter.exploration.Description"),img:"icons/tools/navigation/map-chart-tan.webp",boosts:["stability","free"],flaw:"economy"},grant:{name:localize("Charter.grant.Name"),description:localize("Charter.grant.Description"),img:"icons/skills/trades/academics-merchant-scribe.webp",boosts:["economy","free"],flaw:"loyalty"},open:{name:localize("Charter.open.Name"),description:localize("Charter.open.Description"),img:"icons/sundries/documents/document-sealed-brown-red.webp",boosts:["free"],flaw:null}},heartland:{forestOrSwamp:{name:localize("Heartland.forestOrSwamp.Name"),description:localize("Heartland.forestOrSwamp.Description"),img:"icons/environment/wilderness/tree-oak.webp",boosts:["culture"]},hillOrPlain:{name:localize("Heartland.hillOrPlain.Name"),description:localize("Heartland.hillOrPlain.Description"),img:"icons/environment/creatures/horses.webp",boosts:["loyalty"]},lakeOrRiver:{name:localize("Heartland.lakeOrRiver.Name"),description:localize("Heartland.lakeOrRiver.Description"),img:"icons/environment/settlement/bridge-stone.webp",boosts:["economy"]},mountainOrRuins:{name:localize("Heartland.mountainOrRuins.Name"),description:localize("Heartland.mountainOrRuins.Description"),img:"icons/environment/wilderness/cave-entrance-mountain.webp",boosts:["stability"]}},government:{despotism:{name:localize("Government.despotism.Name"),description:localize("Government.despotism.Description"),img:"icons/environment/settlement/pyramid.webp",boosts:["stability","economy","free"],skills:["intrigue","warfare"],feat:"Compendium.pf2e.kingmaker-features.Item.WGpkcIChjIk1i0q0"},feudalism:{name:localize("Government.feudalism.Name"),description:localize("Government.feudalism.Description"),img:"icons/environment/settlement/watchtower-cliff.webp",boosts:["stability","culture","free"],skills:["defense","trade"],feat:"Compendium.pf2e.kingmaker-features.Item.JYY8vQxPe9AIGTvv"},oligarchy:{name:localize("Government.oligarchy.Name"),description:localize("Government.oligarchy.Description"),img:"icons/environment/settlement/house-manor.webp",boosts:["loyalty","economy","free"],skills:["arts","industry"],feat:"Compendium.pf2e.kingmaker-features.Item.9dkyZ7r1z7loOxI7"},republic:{name:localize("Government.republic.Name"),description:localize("Government.republic.Description"),img:"icons/environment/settlement/gazebo.webp",boosts:["stability","economy","free"],skills:["engineering","politics"],feat:"Compendium.pf2e.kingmaker-features.Item.BChcBEZpcqMnLISC"},thaumocracy:{name:localize("Government.thaumocracy.Name"),description:localize("Government.thaumocracy.Description"),img:"icons/environment/settlement/wizard-castle.webp",boosts:["economy","culture","free"],skills:["folklore","magic"],feat:"Compendium.pf2e.kingmaker-features.Item.nDDEbrWj2JouxlRw"},yeomanry:{name:localize("Government.yeomanry.Name"),description:localize("Government.yeomanry.Description"),img:"icons/environment/settlement/house-farmland-small.webp",boosts:["loyalty","culture","free"],skills:["agriculture","wilderness"],feat:"Compendium.pf2e.kingmaker-features.Item.WFng3pxgEAdpdy1p"}}}}__name(getKingdomCHGData,"getKingdomCHGData"),__name2(getKingdomCHGData,"getKingdomCHGData");const KINGDOM_TRAITS=["commerce","leadership","region","civic","army"];class KingdomSheetPF2e extends ActorSheetPF2e{static{__name(this,"KingdomSheetPF2e")}static{__name2(this,"KingdomSheetPF2e")}selectedFilter=null;focusElement=null;#editingSettlements={};constructor(actor,options){super(actor,options)}get kingdom(){const campaign=this.actor.campaign;if(!(campaign instanceof Kingdom))throw this.close(),ErrorPF2e("Only actors with kingdom data is supported");return campaign}get title(){return this.kingdom.name}static get defaultOptions(){const options=super.defaultOptions;return{...options,classes:[...options.classes,"kingdom"],width:750,height:630,template:"systems/pf2e/templates/actors/party/kingdom/sheet.hbs",scrollY:[...options.scrollY,".tab.active",".tab.active .content",".sidebar"],tabs:[{navSelector:"form > nav",contentSelector:".container",initial:"main"}]}}_getHeaderButtons(){const buttons=super._getHeaderButtons();return game.user.isGM&&buttons.unshift({label:"JOURNAL.ActionShow",class:"show-sheet",icon:"fa-solid fa-eye",onclick:__name2(()=>{const users=game.users.filter(u=>!u.isSelf);game.socket.emit("system.pf2e",{request:"showSheet",users:users.map(u=>u.uuid),document:this.actor.uuid,options:{campaign:!0,tab:this._tabs[0].active}})},"onclick")}),buttons}async getData(options){const data=await super.getData(options),kingdom=this.kingdom,settlementEntries=t(Object.entries(this.kingdom.settlements).filter(e2=>!!e2[1]),e2=>e2[1].sort);return{...data,actor:this.actor,kingdom:this.kingdom,nationTypeLabel:game.i18n.localize(`PF2E.Kingmaker.Kingdom.NationType.${kingdom.nationType}`),abilities:KINGDOM_ABILITIES.map(slug=>({...this.kingdom.abilities[slug],slug,label:game.i18n.localize(KINGDOM_ABILITY_LABELS[slug]),ruinLabel:game.i18n.localize(KINGDOM_RUIN_LABELS[slug])})),commodities:KINGDOM_COMMODITIES.map(type2=>({...kingdom.resources.commodities[type2],type:type2,label:game.i18n.localize(KINGDOM_COMMODITY_LABELS[type2]),workSites:{label:game.i18n.localize(`PF2E.Kingmaker.WorkSites.${type2}.Name`),description:game.i18n.localize(`PF2E.Kingmaker.WorkSites.${type2}.Description`),hasResource:["lumber","ore","stone"].includes(type2),value:kingdom.resources.workSites[type2].value,resource:kingdom.resources.workSites[type2].resource}})),resourceDice:{...kingdom.resources.dice,icon:fontAwesomeIcon(`dice-d${kingdom.resources.dice.faces}`).outerHTML,bonusAdjustment:getAdjustment(kingdom.resources.dice.bonus,kingdom._source.resources.dice.bonus),penaltyAdjustment:getAdjustment(kingdom.resources.dice.penalty,kingdom._source.resources.dice.penalty)},leadership:KINGDOM_LEADERSHIP.map(slug=>{const data2=this.kingdom.leadership[slug],document2=fromUuidSync(data2.uuid??""),actor=document2 instanceof ActorPF2e?document2:null;return{...data2,slug,label:game.i18n.localize(`PF2E.Kingmaker.Kingdom.LeadershipRole.${slug}`),actor,img:actor?.prototypeToken.texture.src??actor?.img??ActorPF2e.DEFAULT_ICON,abilityLabel:game.i18n.localize(KINGDOM_ABILITY_LABELS[KINGDOM_LEADERSHIP_ABILITIES[slug]]),penaltyLabel:game.i18n.localize(`PF2E.Kingmaker.Kingdom.VacancyPenalty.${slug}`)}}),actions:t(kingdom.activities,a=>a.name).map(item=>({item,traits:createSheetTags(CONFIG.PF2E.kingmakerTraits,item.system.traits.value.filter(t2=>t2!=="downtime"))})),skills:t(Object.values(this.kingdom.skills),s=>s.label),feats:[kingdom.features,kingdom.feats,kingdom.bonusFeats],actionFilterChoices:KINGDOM_TRAITS.map(trait=>({label:game.i18n.localize(CONFIG.PF2E.kingmakerTraits[trait]),value:trait,selected:!1})),armies:await this.#prepareArmies(),settlements:await Promise.all(settlementEntries.map(async([id,data2])=>this.#prepareSettlement(id,data2))),eventText:await TextEditorPF2e.enrichHTML(kingdom.event.text,{rollData:this.actor.getRollData()}),settlementTypes:KINGDOM_SETTLEMENT_TYPE_LABELS,abilityLabels:KINGDOM_ABILITY_LABELS,skillLabels:KINGDOM_SKILL_LABELS,proficiencyOptions:Object.values(CONFIG.PF2E.proficiencyRanks).map((label,i)=>({value:i.toString(),label}))}}_configureProseMirrorPlugins(name2,options){const plugins=super._configureProseMirrorPlugins(name2,options);return plugins.menu=foundry.prosemirror.ProseMirrorMenu.build(foundry.prosemirror.defaultSchema,{destroyOnSave:options.remove,onSave:__name2(()=>this.saveEditor(name2,options),"onSave"),compact:!0}),plugins}async#prepareArmies(){const data=this.kingdom.armies.map(async a=>({document:a,link:await TextEditorPF2e.enrichHTML(a.link),consumption:getAdjustedValue(a.system.consumption,a._source.system.consumption,{better:"lower"})}));return(await Promise.all(data)).sort((a,b)=>a.document.name.localeCompare(b.document.name))}async#prepareSettlement(id,settlement){const data=KINGDOM_SETTLEMENT_TYPE_DATA[settlement.type],levelRange=data.level[1]===1/0?`${data.level[0]}+`:data.level[0]===data.level[1]?String(data.level[0]):data.level.join("-"),populationRange=data.population[1]===1/0?`${data.population[0]}+`:data.population.join("-");return{...settlement,id,description:await TextEditorPF2e.enrichHTML(settlement.description,{rollData:this.actor.getRollData()}),editing:this.#editingSettlements[id]??!1,blocks:data.blocks===1/0?"10+":data.blocks,populationRange,levelRange,typeLabel:KINGDOM_SETTLEMENT_TYPE_LABELS[settlement.type],storage:KINGDOM_COMMODITIES.map(type2=>({type:type2,value:settlement.storage[type2],label:game.i18n.localize(KINGDOM_COMMODITY_LABELS[type2])}))}}activateListeners($html){super.activateListeners($html);const html2=$html[0];this.focusElement&&(htmlQuery(html2,this.focusElement)?.focus(),this.focusElement=null);for(const openSheetLink of htmlQueryAll(html2,"[data-action=open-sheet]")){const actorUUID=htmlClosest(openSheetLink,"[data-actor-uuid]")?.dataset.actorUuid,actor=fromUuidSync(actorUUID??"");openSheetLink.addEventListener("click",()=>actor?.sheet?.render(!0))}for(const button of htmlQueryAll(html2,"[data-action=builder]")){const tab=button.dataset.tab??null;button.addEventListener("click",()=>{new KingdomBuilder(this.kingdom).render(!0,{tab})})}const{fame}=this.kingdom.resources,famePips=htmlQuery(html2,"[data-action=adjust-fame]");famePips?.addEventListener("click",async()=>{const newValue=Math.min(fame.value+1,fame.max);await this.kingdom.update({"resources.fame.value":newValue})}),famePips?.addEventListener("contextmenu",async event2=>{event2.preventDefault();const newValue=Math.max(fame.value-1,0);await this.kingdom.update({"resources.fame.value":newValue})});for(const leader of htmlQueryAll(html2,".leader[data-role]")){const{role,uuid}=leader.dataset;if(htmlQuery(leader,"[data-action=remove-leader]")?.addEventListener("click",()=>{this.kingdom.update({[`leadership.${role}`]:null})}),uuid)for(const clickable of htmlQueryAll(leader,"[data-action=open-sheet]"))clickable.addEventListener("click",async()=>{(await fromUuid(uuid))?.sheet?.render(!0)});const vacantEl=htmlQuery(leader,".vacant[title]");if(vacantEl){const lines=vacantEl.title.split(/;\s*/).map(l=>createHTMLElement("li",{children:[l]})),content=createHTMLElement("ul",{children:lines});createTooltipster(vacantEl,{content,contentAsHTML:!0,side:"right",theme:"crb-hover"})}}for(const rollableStat of htmlQueryAll(html2,".rollable")){const statSlug=htmlClosest(rollableStat,"[data-statistic]")?.dataset.statistic;statSlug&&rollableStat.addEventListener("click",event2=>{this.actor.getStatistic(statSlug)?.roll(eventToRollParams(event2,{type:"check"}))})}htmlQuery(html2,"[data-action=collect]")?.addEventListener("click",async()=>{ChatMessagePF2e.create({speaker:{...ChatMessagePF2e.getSpeaker(this.actor),alias:this.kingdom.name},content:await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/party/kingdom/collection.hbs",calculateKingdomCollectionData(this.kingdom))})}),this.filterActions(this.selectedFilter,{instant:!0}),htmlQuery(html2,".filters")?.addEventListener("click",event2=>{const filterButton=htmlClosest(event2.target,".choice");filterButton&&this.filterActions(filterButton.dataset.slug??null)});for(const content of htmlQueryAll(html2,"[data-tooltip-content]"))createTooltipster(content,{trigger:"click",arrow:!1,contentAsHTML:!0,debug:!1,interactive:!0,side:["right","bottom"],theme:"crb-hover",minWidth:120});for(const customModifierEl of htmlQueryAll(html2,".modifiers-tooltip")){const stat=customModifierEl.dataset.stat;if(!stat)continue;for(const removeButton of htmlQueryAll(customModifierEl,"[data-action=remove-modifier]")){const slug=removeButton.dataset.slug??"";removeButton.addEventListener("click",()=>{this.kingdom.removeCustomModifier(stat,slug)})}const modifierValueEl=htmlQuery(customModifierEl,".add-modifier input[type=number]");htmlQuery(customModifierEl,"[data-action=increment]")?.addEventListener("click",()=>{modifierValueEl?.stepUp()}),htmlQuery(customModifierEl,"[data-action=decrement]")?.addEventListener("click",()=>{modifierValueEl?.stepDown()}),htmlQuery(customModifierEl,"[data-action=create-custom-modifier]")?.addEventListener("click",()=>{const modifier=modifierValueEl?.valueAsNumber||1,type2=htmlQuery(customModifierEl,".add-modifier-type")?.value??"",label=htmlQuery(customModifierEl,".add-modifier-name")?.value?.trim()??game.i18n.localize(`PF2E.ModifierType.${type2}`);if(!setHasElement(MODIFIER_TYPES,type2)){ui.notifications.error("Type is required.");return}this.kingdom.addCustomModifier(stat,{label,modifier,type:type2})})}htmlQuery(html2,"[data-action=add-settlement]")?.addEventListener("click",()=>{const id=foundry.utils.randomID();this.#editingSettlements[id]=!0,this.focusElement=`[name="settlements.${id}.name"]`,this.kingdom.update({[`settlements.${id}`]:{}})});for(const settlementElement of htmlQueryAll(html2,".settlement"))this.#activateSettlementEvents(settlementElement);for(const link of htmlQueryAll(html2,"[data-action=browse-feats]")){const maxLevel=Number(link.dataset.level)||this.kingdom.level;link.addEventListener("click",async()=>{const compendiumTab=game.pf2e.compendiumBrowser.tabs.campaignFeature,filter=await compendiumTab.getFilterData(),levels=filter.level;levels.to=Math.min(maxLevel,levels.max),levels.isExpanded=levels.to!==levels.max,filter.checkboxes.category.options["kingdom-feat"].selected=!0,filter.checkboxes.category.selected.push("kingdom-feat"),filter.checkboxes.category.isExpanded=!0,compendiumTab.open({filter})})}htmlQuery(html2,"[data-action=random-event]")?.addEventListener("click",()=>{new Statistic(this.actor,{slug:"random-event",label:"Random Kingdom Event",check:{type:"flat-check"}}).roll({dc:this.kingdom.event.dc})}),htmlQuery(html2,"[data-action=reset-event-dc]")?.addEventListener("click",()=>{this.kingdom.update({event:{dc:16}})});const settlementList=htmlQuery(html2,".settlement-list");settlementList&&createSortable(settlementList,{...SORTABLE_BASE_OPTIONS,handle:".drag-handle",onEnd:__name2(event2=>{const settlements=this.kingdom.settlements,settlementsWithIds=Object.entries(settlements).map(([id,value])=>({id,...value})),settlement=settlementsWithIds.find(s=>s.id===event2.item.dataset.settlementId),newIndex=event2.newDraggableIndex;if(!settlement||newIndex===void 0){this.render();return}const siblings=t(settlementsWithIds.filter(s=>s!==settlement),s=>s.sort);siblings.splice(newIndex,0,settlement);const updates=t$9(siblings,(s,index2)=>[`settlements.${s.id}.sort`,index2]);this.kingdom.update(updates)},"onEnd")})}activateClickListener(html2){const handlers=super.activateClickListener(html2);return handlers["create-feat"]=()=>{this.actor.createEmbeddedDocuments("Item",[{name:game.i18n.localize(CONFIG.PF2E.featCategories.bonus),type:"campaignFeature",system:{campaign:"kingmaker",category:"kingdom-feat"}}])},handlers}#activateSettlementEvents(settlementElement){const id=settlementElement.dataset.settlementId??null;if(id===null)return;const rerenderSettlement=__name2(async()=>{const settlement=this.kingdom.settlements[id];if(!settlement)return;const newHTML=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/party/kingdom/partials/settlement.hbs",{...await this.getData(),settlement:await this.#prepareSettlement(id,settlement)}),newElement=createHTMLElement("div",{innerHTML:newHTML}).firstElementChild;if(newElement instanceof HTMLElement){const isExpanded=!htmlQuery(settlementElement,".item-summary")?.hidden;htmlQuery(newElement,".item-summary").hidden=!isExpanded,settlementElement.replaceWith(newElement),super.activateListeners($(newElement)),this.#activateSettlementEvents(newElement),this.#editingSettlements[id]&&this.itemRenderer.toggleSummary(newElement,{visible:!0})}},"rerenderSettlement");htmlQuery(settlementElement,"[data-action=edit-settlement]")?.addEventListener("click",()=>{this.#editingSettlements[id]=!0,rerenderSettlement()}),htmlQuery(settlementElement,"[data-action=finish-settlement]")?.addEventListener("click",async()=>{this.#editingSettlements[id]=!1,rerenderSettlement()}),htmlQuery(settlementElement,"[data-action=delete-settlement]")?.addEventListener("click",async event2=>{const settlement=this.kingdom.settlements[id];if(!settlement)return;(event2?.ctrlKey||await foundry.applications.api.DialogV2.confirm({window:{title:"PF2E.DeleteItemTitle",icon:"fa-solid fa-trash"},content:`<p>${game.i18n.format("PF2E.DeleteQuestion",{name:`"${settlement.name}"`})}</p>`,no:{default:!0}}))&&this.kingdom.update({[`settlements.-=${id}`]:null})})}filterActions(trait,options={}){const html2=this.element.get(0),duration=.4;this.selectedFilter=trait;const animateElement=__name2((element,visible)=>{options.instant?element.hidden=!visible:visible&&element.hidden?gsap.fromTo(element,{height:0,opacity:0,hidden:!1},{height:"auto",opacity:1,duration}):!visible&&!element.hidden&&gsap.to(element,{height:0,duration,opacity:0,paddingTop:0,paddingBottom:0,margin:0,clearProps:"all",onComplete:__name2(()=>{element.hidden=!0,this.itemRenderer.toggleSummary(element,{visible:!1,instant:!0})},"onComplete")})},"animateElement");for(const action2 of this.kingdom.activities){const element=htmlQuery(html2,`[data-item-id="${action2.id}"]`),visible=!trait||tupleHasValue(action2.system.traits.value,trait);element&&animateElement(element,visible)}for(const summary of htmlQueryAll(html2,".phase-summary"))animateElement(summary,summary.dataset.phase===trait);for(const choice of htmlQueryAll(html2,".filters .choice")){const active=choice.dataset.slug?choice.dataset.slug===trait:trait===null;choice.classList.toggle("active",active)}const actionsList=htmlQuery(html2,".actions-list");actionsList&&(actionsList.scrollTop=0)}async _onDropItem(event2,data){const item=await ItemPF2e.fromDropData(data);if(!item)throw ErrorPF2e("Unable to create item from drop data!");if(this.actor.uuid===item.parent?.uuid)return super._onDropItem(event2,data);if(item?.isOfType("campaignFeature")&&(item.isFeat||item.isFeature)){const slotData=this.#getFeatSlotData(event2)??{groupId:"bonus",slotId:null};return(slotData.groupId==="bonus"?this.kingdom.bonusFeats:this.kingdom.feats).insertFeat(item,slotData.slotId)}return super._onDropItem(event2,data)}async _onSortItem(event2,itemData){const item=this.actor.items.get(itemData._id);if(item?.isOfType("campaignFeature")&&(item.isFeat||item.isFeature)){const featSlot=this.#getFeatSlotData(event2);if(!featSlot)return[];const group=featSlot.groupId==="bonus"?this.kingdom.bonusFeats:this.kingdom.feats,resorting=item.group===group&&!group?.slotted;if(group?.slotted&&!featSlot.slotId)return[];if(!resorting)return group.insertFeat(item,featSlot.slotId)}return super._onSortItem(event2,itemData)}async _onDropActor(event2,data){await super._onDropActor(event2,data);const actor=fromUuidSync(data.uuid),closestLeader=htmlClosest(event2.target,".leader[data-role]");if(actor instanceof CreaturePF2e&&closestLeader){const role=String(closestLeader.dataset.role),uuid=actor.uuid;this.kingdom.update({leadership:{[role]:{uuid}}})}}#getFeatSlotData(event2){const groupId=htmlClosest(event2.target,"[data-group-id]")?.dataset.groupId,slotId=htmlClosest(event2.target,"[data-slot-id]")?.dataset.slotId;return typeof groupId=="string"?{slotId,groupId}:null}_disableFields(form){for(const gmOnlyField of htmlQueryAll(form,"input, textarea, [data-access=owner]"))gmOnlyField instanceof HTMLTextAreaElement?gmOnlyField.readOnly=!0:(gmOnlyField instanceof HTMLInputElement||gmOnlyField instanceof HTMLButtonElement)&&(gmOnlyField.disabled=!0)}async _updateObject(_event,formData){if(!this.actor.id)return;const data=foundry.utils.expandObject(formData);for(const abilitySlug of KINGDOM_ABILITIES){const ability=data.abilities?.[abilitySlug];ability?.penalty&&(ability.penalty=-Math.abs(ability.penalty))}return this.kingdom.update(data)}}const appv1$9=foundry.appv1,KINGDOM_BUILD_CATEGORIES=["charter","heartland","government"],KINGDOM_BOOST_LEVELS=[1,5,10,15,20];class KingdomBuilder extends appv1$9.api.FormApplication{static{__name(this,"KingdomBuilder")}static{__name2(this,"KingdomBuilder")}selected={charter:null,heartland:null,government:null};static get defaultOptions(){return{...super.defaultOptions,classes:["sheet","kingdom-builder"],title:game.i18n.localize("PF2E.Kingmaker.KingdomBuilder.Title"),template:"systems/pf2e/templates/actors/party/kingdom/builder.hbs",width:560,height:"auto",submitOnChange:!0,closeOnSubmit:!1,tabs:[{navSelector:"form > nav",contentSelector:".container",initial:"main"}]}}static showToPlayers(options){const users=game.users.filter(u=>!u.isSelf);game.socket.emit("system.pf2e",{request:"showSheet",users:users.map(u=>u.uuid),document:options.uuid,options:{campaign:"builder",tab:options.tab}})}get id(){return`kingdom-builder-${this.actor.id}`}get kingdom(){return this.object}get actor(){return this.object.actor}get isEditable(){return this.actor.isOwner}_getHeaderButtons(){const buttons=super._getHeaderButtons();return game.user.isGM&&(buttons.unshift({label:"JOURNAL.ActionShow",class:"show-sheet",icon:"fa-solid fa-eye",onclick:__name2(()=>{KingdomBuilder.showToPlayers({uuid:this.actor.uuid,tab:this._tabs[0].active})},"onclick")}),this.kingdom.active==="building"&&buttons.unshift({label:"PF2E.Kingmaker.KingdomBuilder.CancelCreation",class:"cancel",icon:"fa-solid fa-xmark",onclick:__name2(()=>{this.kingdom.update({active:!1})},"onclick")})),buttons}async getData(){const database=getKingdomCHGData(),getActiveForCategory=__name2(category=>{const active=this.kingdom.build[category];return active?active?.id??Object.entries(database[category]).find(([_,entry])=>entry?.name===active.name)?.[0]??null:null},"getActiveForCategory");for(const category of KINGDOM_BUILD_CATEGORIES)this.selected[category]??=getActiveForCategory(category);const categories=await t$a(KINGDOM_BUILD_CATEGORIES,t$b(async category=>{const selected=this.selected[category],entries=database[category],buildEntry=entries[selected??""]??Object.values(entries)[0],featItem=await(async()=>{try{return buildEntry?.feat?await fromUuid(buildEntry.feat):null}catch(ex){return console.error(ex),null}})(),savedEntry=this.kingdom.build[category],result={selected,active:getActiveForCategory(category),buildEntry,featLink:featItem?await TextEditorPF2e.enrichHTML(featItem.link):null,stale:!buildEntry||!savedEntry?buildEntry!==savedEntry:!t$6(buildEntry,savedEntry)};return[category,result]}),items=>Promise.all(items).then(result=>t$j(result))),{build}=this.kingdom,finished=!!(build.charter&&build.heartland&&build.government);return{options:{editable:this.isEditable},kingdom:this.kingdom,database,categories,abilityLabels:KINGDOM_ABILITY_LABELS,skillLabels:KINGDOM_SKILL_LABELS,build:this.#prepareAbilityBuilder(),finished,aspirationOptions:[{value:"fame",label:"PF2E.Kingmaker.Kingdom.Aspiration.fame"},{value:"infamy",label:"PF2E.Kingmaker.Kingdom.Aspiration.infamy"}]}}#prepareAbilityBuilder(){function createButtons(){return Array.from(KINGDOM_ABILITIES).reduce((accumulated,ability)=>(accumulated[ability]={ability},accumulated),{})}__name(createButtons,"createButtons"),__name2(createButtons,"createButtons");const choices=this.kingdom.build.boosts,mainBoosts=t$9(KINGDOM_BUILD_CATEGORIES,prop2=>{const buildItem=this.kingdom[prop2];if(!buildItem)return[prop2,null];const buttons=createButtons(),selectedChoices=objectHasKey(choices,prop2)?choices[prop2]:[],boosts=resolveKingdomBoosts(buildItem,selectedChoices),remaining=Math.max(0,buildItem.boosts.length-boosts.length);for(const ability of KINGDOM_ABILITIES){const selected=boosts.includes(ability);ability===buildItem.flaw?buttons[ability].flaw={selected:!0,locked:!0}:(selected||buildItem.boosts.includes("free"))&&(buttons[ability].boost={selected,locked:buildItem.boosts.includes(ability),disabled:!selected&&!remaining})}return[prop2,{buttons,remaining}]}),levelBoosts=t$9(KINGDOM_BOOST_LEVELS,level=>{const eligible=this.kingdom.level>=level,buttons=createButtons(),boosts=this.kingdom.build.boosts[level],remaining=eligible?Math.max(0,2-boosts.length):0;for(const ability of KINGDOM_ABILITIES){const selected=boosts.includes(ability)&&eligible;buttons[ability].boost={selected,disabled:!selected&&!remaining}}return[level,{buttons,remaining,eligible}]});return{...mainBoosts,levelBoosts}}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const categoryEl of htmlQueryAll(html2,"[data-category]")){const category=categoryEl.dataset.category??null;if(!tupleHasValue(KINGDOM_BUILD_CATEGORIES,category))continue;for(const choiceElement of htmlQueryAll(categoryEl,".choice"))choiceElement.addEventListener("click",evt=>{const slug=htmlClosest(evt.target,"[data-slug]")?.dataset.slug;category&&objectHasKey(this.selected,category)&&(this.selected[category]=slug??null,this.render())});const saveCategory=__name2(async()=>{const database=getKingdomCHGData(),id=this.selected[category]??"",selected=database[category][id];selected&&(this.selected[category]=null,await this.kingdom.update({[`build.${category}`]:{id,...selected},[`build.boosts.${category}`]:[]}))},"saveCategory");htmlQuery(categoryEl,"[data-action=set]")?.addEventListener("click",()=>{saveCategory()}),htmlQuery(categoryEl,"[data-action=save-and-continue]")?.addEventListener("click",async event2=>{event2.preventDefault(),event2.stopPropagation(),await saveCategory();const activeTab=this._tabs[0].active,idx=KINGDOM_BUILD_CATEGORIES.indexOf(activeTab),newTab=KINGDOM_BUILD_CATEGORIES[idx+1]??"ability";this._tabs[0].activate(newTab,{triggerCallback:!0})})}for(const button of htmlQueryAll(html2,".ability-builder [data-section] .boost")){const sectionId=htmlClosest(button,"[data-section]")?.dataset.section,ability=htmlClosest(button,"[data-ability]")?.dataset.ability;!tupleHasValue(KINGDOM_ABILITIES,ability)||!tupleHasValue(KINGDOM_BUILD_CATEGORIES,sectionId)||button.addEventListener("click",()=>{const object=this.kingdom[sectionId],current=this.kingdom.build.boosts[sectionId],maxBoosts=object?.boosts.length;if(!object)return;const boosts=(current.includes(ability)?current.filter(a=>a!==ability):[...current,ability]).filter(a=>!object.boosts.includes(a)&&object.flaw!==a).slice(0,maxBoosts);this.kingdom.update({[`build.boosts.${sectionId}`]:boosts})})}for(const button of htmlQueryAll(html2,".ability-builder [data-level] .boost")){const level=Number(htmlClosest(button,"[data-level]")?.dataset.level),ability=htmlClosest(button,"[data-ability]")?.dataset.ability;!tupleHasValue(KINGDOM_ABILITIES,ability)||!tupleHasValue(KINGDOM_BOOST_LEVELS,level)||button.addEventListener("click",()=>{const current=this.kingdom.build.boosts[level],boosts=(current.includes(ability)?current.filter(a=>a!==ability):[...current,ability]).slice(0,2);this.kingdom.update({[`build.boosts.${level}`]:boosts})})}htmlQuery(html2,"[data-action=complete]")?.addEventListener("click",async()=>{this.close(),await this.kingdom.update({active:!0}),await this.kingdom.importActivities(),new KingdomSheetPF2e(this.actor).render(!0)})}async _updateObject(_event,formData){if(this.actor.id)return this.object.update(formData)}async _render(force,options){if(this.kingdom.active===!1){this.close({force:!0});return}await super._render(force,options),this.kingdom.actor.apps[this.appId]??=this,options?.tab&&this._tabs.at(0)?.activate(options.tab,{triggerCallback:!0})}}const fields$19=foundry.data.fields,validation$2=foundry.data.validation;class PrunedSchemaField extends fields$19.SchemaField{static{__name(this,"PrunedSchemaField")}static{__name2(this,"PrunedSchemaField")}initialize(value,model,options){if(!value)return super.initialize(value,model,options);for(const key in value)value[key]===void 0&&delete value[key];const initialized=super.initialize(value,model,options);for(const key in initialized)value[key]===void 0&&delete value[key];return initialized}}class LaxSchemaField extends fields$19.SchemaField{static{__name(this,"LaxSchemaField")}static{__name2(this,"LaxSchemaField")}_cleanType(data,options={}){options.source=options.source??data;for(const[name2,field]of this.entries())!(name2 in data)&&options.partial||(data[name2]=field.clean(data[name2],options),data[name2]===void 0&&delete data[name2]);return data}}class StrictSchemaField extends fields$19.SchemaField{static{__name(this,"StrictSchemaField")}static{__name2(this,"StrictSchemaField")}_cast(value){return value}_cleanType(data,options){if(!e$2(data))throw Error(`${this.name} is not an object`);return super._cleanType(data,options)}}class StrictStringField extends fields$19.StringField{static{__name(this,"StrictStringField")}static{__name2(this,"StrictStringField")}_cast(value){return value}}class StrictNumberField extends fields$19.NumberField{static{__name(this,"StrictNumberField")}static{__name2(this,"StrictNumberField")}_cast(value){return value}}class NullableBooleanField extends fields$19.BooleanField{static{__name(this,"NullableBooleanField")}static{__name2(this,"NullableBooleanField")}_cast(value){return value==="true"?!0:value==="false"?!1:value==="null"||value===""?this.nullable?null:!1:typeof value=="object"?!1:!!value}_toInput(config){if(!this.nullable)return super._toInput(config);const value=String(config.value??null),options=[{value:"true",label:game.i18n.localize("Yes"),selected:value==="true"},{value:"false",label:game.i18n.localize("No"),selected:value==="false"},{value:"null",label:"",selected:value==="null"}];return foundry.applications.fields.createSelectInput(foundry.utils.mergeObject(config,{value,options,dataset:{data:"JSON"}}))}}class StrictBooleanField extends fields$19.BooleanField{static{__name(this,"StrictBooleanField")}static{__name2(this,"StrictBooleanField")}_cast(value){return value}}class StrictArrayField extends fields$19.ArrayField{static{__name(this,"StrictArrayField")}static{__name2(this,"StrictArrayField")}_cast(value){return value}_cleanType(value){return Array.isArray(value)?super._cleanType(value):value}initialize(value,model,options){return Array.isArray(value)?super.initialize(value,model,options):this.nullable?null:void 0}}class LaxArrayField extends fields$19.ArrayField{static{__name(this,"LaxArrayField")}static{__name2(this,"LaxArrayField")}_validateElements(value,options){const failure=super._validateElements(value,options);if(!failure)return failure;for(const element of failure.elements)value.splice(Number(element.id),1);return failure.unresolved=!1,failure}}class StrictObjectField extends fields$19.ObjectField{static{__name(this,"StrictObjectField")}static{__name2(this,"StrictObjectField")}_cast(value){return value}}class AnyChoiceField extends fields$19.DataField{static{__name(this,"AnyChoiceField")}static{__name2(this,"AnyChoiceField")}static get _defaults(){return{...super._defaults,choices:[]}}constructor(options,context){super(options,context)}_cleanType(value){if(typeof value=="string"&&!this.choices.includes(value)){const index2=this.choices.findIndex(c=>String(c)===value);return index2>=0?this.choices[index2]:value}return value}_cast(value){return value}_validateType(value){if(!(this.options.nullable&&value===null)&&!tupleHasValue(this.choices,value))throw new Error(`${value} is not a valid choice`)}_toInput(config){return config.choices??=t$9(this.choices,c=>[String(c),c]),fields$19.StringField._prepareChoiceConfig(config),foundry.applications.fields.createSelectInput(config)}}class DataUnionField extends fields$19.DataField{static{__name(this,"DataUnionField")}static{__name2(this,"DataUnionField")}fields;constructor(fields2,options){super(options),this.fields=fields2}_cast(value){return typeof value=="string"&&(value=value.trim()),value}clean(value,options){if(Array.isArray(value)&&this.fields.some(f=>f instanceof fields$19.ArrayField))return this.fields.find(f=>f instanceof StrictArrayField)?.clean(value,options)??value;if(e$2(value)){const initial=this.fields.find(f=>f instanceof fields$19.SchemaField||f instanceof fields$19.ObjectField)?.getInitialValue();if(!e$2(initial))return super.clean(value,options);for(const key of Object.keys(initial))key in value||(value[key]=initial[key]);return value}return super.clean(value,options)}_validateType(value,options){const errors=[];for(const field of this.fields){const result=field.validate(value,options);if(result instanceof validation$2.DataModelValidationFailure)errors.push({field,result});else return!0}const lastError=errors.at(-1)?.result;return lastError?Array.isArray(value)?errors.findLast(e2=>e2.field instanceof fields$19.ArrayField)?.result??lastError:typeof value=="object"?errors.findLast(e2=>e2.field instanceof fields$19.ObjectField||e2.field instanceof fields$19.SchemaField)?.result??lastError:lastError:!1}initialize(value,model,options){return this.fields.find(f=>!f.validate(value))?.initialize(value,model,options)}}class SlugField extends StrictStringField{static{__name(this,"SlugField")}static{__name2(this,"SlugField")}constructor(options={}){options.blank=!1,options.camel??=null,super(options)}static get _defaults(){return{...super._defaults,nullable:!0,initial:null,camel:null}}_cleanType(value,options){const slug=super._cleanType(value,options),camel=this.options.camel??null;return typeof slug=="string"?sluggify(slug,{camel}):slug}}class PredicateStatementField extends fields$19.DataField{static{__name(this,"PredicateStatementField")}static{__name2(this,"PredicateStatementField")}constructor(options={}){super({...options,required:!0,nullable:!1,initial:void 0,validationError:"must be a recognized predication statement"})}_validateType(value){return StatementValidator.isStatement(value)}_cast(value){return value}_cleanType(value){return typeof value=="string"?value.trim():value}}class PredicateField extends StrictArrayField{static{__name(this,"PredicateField")}static{__name2(this,"PredicateField")}constructor(options={}){super(new PredicateStatementField,options)}initialize(value,model,options){const statements=super.initialize(value,model,options);return Array.isArray(statements)?new Predicate(...statements):statements}_toInput(config){return foundry.applications.fields.createTextInput(Object.assign(config,{value:JSON.stringify(config.value??[])}))}}class RecordField extends fields$19.ObjectField{static{__name(this,"RecordField")}static{__name2(this,"RecordField")}static recursive=!0;keyField;valueField;constructor(keyField,valueField,options){if(super(options),!this._isValidKeyFieldType(keyField))throw new Error("key field must be a StringField or a NumberField");if(this.keyField=keyField,!(valueField instanceof fields$19.DataField))throw new Error(`${this.name} must have a DataField as its contained field`);this.valueField=valueField}_isValidKeyFieldType(keyField){if(keyField instanceof fields$19.StringField||keyField instanceof fields$19.NumberField){if(keyField.options.required!==!0||keyField.options.nullable===!0)throw new Error("key field must be required and non-nullable");return!0}return!1}_validateValues(values,options){const failures=new validation$2.DataModelValidationFailure;for(const[key,value]of Object.entries(values)){if(key.startsWith("-=")&&options?.partial)continue;const keyFailure=this.keyField.validate(key,options);keyFailure&&failures.elements.push({id:key,failure:keyFailure});const valueFailure=this.valueField.validate(value,options);valueFailure&&failures.elements.push({id:`${key}-value`,failure:valueFailure})}if(failures.elements.length)return failures.elements.every(f=>f.id in values)?failures.unresolved=!1:failures.unresolved=failures.elements.some(e2=>e2.failure.unresolved),failures}_cleanType(values,options){for(const[key,value]of Object.entries(values))key.startsWith("-=")||(values[key]=this.valueField.clean(value,options));return values}_validateType(values,options){return e$2(values)?this._validateValues(values,options):new validation$2.DataModelValidationFailure({message:"must be an Object"})}initialize(values,model,options){if(!values)return values;const failureKeys=(this.fieldPath.startsWith(model.schema.fieldPath+".")?this.fieldPath.substring(model.schema.fieldPath.length+1):this.fieldPath).split(".").reduce((fields2,part)=>fields2?fields2.fields[part]:null,model.validationFailures.fields)?.elements.map(e2=>e2.id)??[],data={};for(const[key,value]of Object.entries(values))failureKeys.includes(key)||(data[key]=this.valueField.initialize(value,model,options));return data}}class NullField extends fields$19.DataField{static{__name(this,"NullField")}static{__name2(this,"NullField")}constructor(){super({required:!0,nullable:!0,initial:null})}_cast(){return null}}const fields$18=foundry.data.fields;function defineKingdomSchema(){const defineCHGSchema=__name2(()=>({id:new fields$18.StringField({required:!1,initial:void 0,blank:!1}),name:new fields$18.StringField({required:!0,nullable:!1,blank:!1}),img:new fields$18.StringField({required:!0,nullable:!1}),description:new fields$18.StringField({required:!0,nullable:!1}),boosts:new fields$18.ArrayField(new fields$18.StringField({choices:[...KINGDOM_ABILITIES,"free"],nullable:!1}))}),"defineCHGSchema"),KINGDOM_BUILD_SCHEMA={manual:new fields$18.BooleanField({required:!0,nullable:!1,initial:!1}),charter:new fields$18.SchemaField({...defineCHGSchema(),flaw:new fields$18.StringField({choices:KINGDOM_ABILITIES,required:!0,nullable:!0})},{nullable:!0,initial:null}),heartland:new fields$18.SchemaField(defineCHGSchema(),{nullable:!0,initial:null}),government:new fields$18.SchemaField({...defineCHGSchema(),skills:new fields$18.ArrayField(new fields$18.StringField({required:!0,nullable:!1,choices:KINGDOM_SKILLS})),feat:new fields$18.DocumentUUIDField({required:!0,nullable:!0})},{nullable:!0,initial:null}),skills:new fields$18.SchemaField(t$9(KINGDOM_SKILLS,skill=>{const schema=new fields$18.SchemaField({rank:new fields$18.NumberField({initial:0,min:0,max:4,required:!0,nullable:!1})});return[skill,schema]})),boosts:new fields$18.SchemaField(t$9(["charter","heartland","government","1","5","10","15","20"],category=>{const schema=new fields$18.ArrayField(new fields$18.StringField({choices:KINGDOM_ABILITIES,nullable:!1}));return[category,schema]}))},KINGDOM_RESOURCES_SCHEMA={dice:new fields$18.SchemaField({number:new fields$18.NumberField,faces:new fields$18.NumberField,bonus:new fields$18.NumberField({required:!0,nullable:!1,initial:0}),penalty:new fields$18.NumberField({required:!0,nullable:!1,initial:0})}),fame:new fields$18.SchemaField({value:new fields$18.NumberField({required:!0,nullable:!1,initial:0}),max:new fields$18.NumberField({required:!0,nullable:!1,initial:3})}),commodities:new fields$18.SchemaField(t$9(KINGDOM_COMMODITIES,type2=>{const schema=new fields$18.SchemaField({value:new fields$18.NumberField({required:!0,nullable:!1,initial:0}),max:new fields$18.NumberField({required:!0,nullable:!1,initial:0})});return[type2,schema]})),points:new fields$18.NumberField({min:0,required:!0,nullable:!1,initial:0}),workSites:new fields$18.SchemaField(t$9(["food","luxuries","lumber","ore","stone"],type2=>{const schema=new fields$18.SchemaField({value:new fields$18.NumberField({required:!0,nullable:!1,min:0,initial:0}),resource:new fields$18.NumberField({required:!0,nullable:!1,min:0,initial:0})});return[type2,schema]}))},KINGDOM_SETTLEMENT_SCHEMA={name:new fields$18.StringField({required:!0,blank:!0,nullable:!1,initial:""}),type:new fields$18.StringField({required:!1,nullable:!1,choices:KINGDOM_SETTLEMENT_TYPES,initial:"village"}),level:new fields$18.NumberField({min:1,initial:1,max:30,nullable:!1}),overcrowded:new fields$18.BooleanField,description:new fields$18.StringField({required:!0,nullable:!1,blank:!0,initial:""}),sort:new fields$18.IntegerSortField,consumption:new fields$18.SchemaField({base:new fields$18.NumberField({required:!0,nullable:!1,initial:0}),reduction:new fields$18.NumberField({required:!0,nullable:!1,initial:0}),total:new fields$18.NumberField({required:!0,nullable:!1,initial:0})}),storage:new fields$18.SchemaField(t$9(["food","luxuries","lumber","ore","stone"],type2=>{const schema=new fields$18.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:0});return[type2,schema]}))};return{type:new fields$18.StringField({choices:["kingmaker"],required:!0,nullable:!1,initial:"kingmaker"}),active:new DataUnionField([new StrictStringField({required:!1,nullable:!1,choices:["building"],initial:void 0}),new StrictBooleanField({initial:!1,required:!1,nullable:!1})],{required:!1,nullable:!1,initial:!1}),name:new fields$18.StringField({required:!0,nullable:!1,blank:!1,initial:__name2(()=>game.i18n.localize("PF2E.TraitKingdom"),"initial")}),img:new fields$18.FilePathField({categories:["IMAGE"],required:!0,nullable:!1,initial:"systems/pf2e/icons/default-icons/kingdom.svg"}),capital:new fields$18.StringField({initial:"",required:!0}),size:new fields$18.NumberField({initial:1,min:1,required:!0,nullable:!1}),level:new fields$18.NumberField({required:!0,nullable:!1,min:1,max:20,initial:1}),xp:new fields$18.SchemaField({value:new fields$18.NumberField({required:!0,nullable:!1,initial:0}),max:new fields$18.NumberField({required:!0,nullable:!1,initial:1e3})}),aspiration:new fields$18.StringField({choices:["fame","infamy"],required:!0,nullable:!1,initial:"fame"}),abilities:new fields$18.SchemaField(t$9(KINGDOM_ABILITIES,ability=>{const schema=new fields$18.SchemaField({value:new fields$18.NumberField({initial:10,required:!0,nullable:!1}),mod:new fields$18.NumberField({initial:0,required:!0,nullable:!1}),ruin:new fields$18.SchemaField({value:new fields$18.NumberField({required:!0,nullable:!1,initial:0}),max:new fields$18.NumberField({required:!0,nullable:!1,initial:10})}),penalty:new fields$18.NumberField({initial:0,required:!0,nullable:!1})});return[ability,schema]})),build:new fields$18.SchemaField(KINGDOM_BUILD_SCHEMA),customModifiers:new fields$18.ObjectField,leadership:new fields$18.SchemaField(t$9(KINGDOM_LEADERSHIP,role=>{const schema=new fields$18.SchemaField({uuid:new fields$18.DocumentUUIDField({required:!0,nullable:!0,initial:null}),vacant:new fields$18.BooleanField({initial:!0}),invested:new fields$18.BooleanField});return[role,schema]})),resources:new fields$18.SchemaField(KINGDOM_RESOURCES_SCHEMA),settlements:new RecordField(new fields$18.StringField({required:!0,nullable:!1,blank:!1}),new fields$18.SchemaField(KINGDOM_SETTLEMENT_SCHEMA,{required:!0}),{required:!0,nullable:!1}),consumption:new fields$18.SchemaField({settlement:new fields$18.NumberField({required:!0,nullable:!1,min:0,initial:0}),army:new fields$18.NumberField({required:!0,nullable:!1,min:0,initial:0}),value:new fields$18.NumberField({required:!0,nullable:!1,min:0,initial:0}),breakdown:new fields$18.StringField}),unrest:new fields$18.SchemaField({value:new fields$18.NumberField({required:!0,nullable:!1,integer:!0,min:0,max:99,initial:0}),anarchyThreshold:new fields$18.NumberField({integer:!0,required:!0,nullable:!1,initial:20})}),event:new fields$18.SchemaField({dc:new fields$18.NumberField({required:!0,nullable:!1,min:0,max:20,initial:16}),text:new fields$18.StringField({required:!0,nullable:!1,blank:!0,initial:""})}),module:new fields$18.ObjectField({required:!0})}}__name(defineKingdomSchema,"defineKingdomSchema"),__name2(defineKingdomSchema,"defineKingdomSchema");class Kingdom extends foundry.abstract.DataModel{static{__name(this,"Kingdom")}static{__name2(this,"Kingdom")}static defineSchema(){return defineKingdomSchema()}get actor(){return this.parent.parent}get extraItemTypes(){return["campaignFeature","effect"]}get activities(){return this.actor.itemTypes.campaignFeature.filter(k=>k.category==="kingdom-activity")}get charter(){return this.build.charter}get heartland(){return this.build.heartland}get government(){return this.build.government}createSidebarButtons(){if(!(this.active||game.user.isGM)||game.pf2e.settings.campaign.type!=="kingmaker")return[];const hoverIcon=this.active==="building"?["icon-plus","icon-wrench"]:this.active?[]:["icon-plus"],icon=createHTMLElement("button",{classes:["create-button","icon",...hoverIcon],children:[fontAwesomeIcon("crown")],dataset:{tooltip:game.i18n.localize(`PF2E.Kingmaker.SIDEBAR.${this.active===!0?"OpenSheet":"CreateKingdom"}`)}});return icon.addEventListener("click",async event2=>{if(event2.stopPropagation(),!this.active)await foundry.applications.api.DialogV2.confirm({window:{title:"PF2E.Kingmaker.KingdomBuilder.Title",icon:"fa-solid fa-castle"},content:`<p>${game.i18n.localize("PF2E.Kingmaker.KingdomBuilder.ActivationMessage")}</p>`})&&(await this.update({active:"building"}),KingdomBuilder.showToPlayers({uuid:this.actor.uuid}),new KingdomBuilder(this).render(!0));else{const type2=this.active===!0?null:"builder";this.renderSheet({type:type2})}}),[icon]}async collect(){const{formula,commodities}=calculateKingdomCollectionData(this),roll=await new Roll(formula).evaluate();await roll.toMessage({flavor:game.i18n.localize("PF2E.Kingmaker.Kingdom.CollectDialog.NewResourcePoints"),speaker:{...ChatMessagePF2e.getSpeaker(this.actor),alias:this.name}},{rollMode:"publicroll"}),this.update({resources:{points:roll.total,commodities:t$5(commodities,(incoming,type2)=>{const current=this.resources.commodities[type2];return{value:Math.min(current.value+incoming,current.max)}})}})}async addCustomModifier(stat,data){if(stat.length===0)throw ErrorPF2e("A custom modifier's statistic must be a non-empty string");if(data.label.length===0)throw ErrorPF2e("A custom modifier's label must be a non-empty string");const modifiers=(this.toObject().customModifiers??{})[stat]??[];if(!modifiers.some(m=>m.label===data.label)){data.type=setHasElement(MODIFIER_TYPES,data.type)?data.type:"untyped";const modifier=new Modifier({...data,custom:!0}).toObject();await this.update({[`customModifiers.${stat}`]:[...modifiers,modifier]})}}async removeCustomModifier(stat,slug){if(stat.length===0)throw ErrorPF2e("A custom modifier's statistic must be a non-empty string");const modifiers=(this.toObject().customModifiers??{})[stat]??[];if(modifiers.length!==0)if(typeof slug=="string"){const withRemoved=modifiers.filter(m=>m.slug!==slug);await this.update({[`customModifiers.${stat}`]:withRemoved})}else throw ErrorPF2e("Custom modifiers can only be removed by slug (string) or index (number)")}async update(data){const expanded=foundry.utils.expandObject(data),updateData=foundry.utils.mergeObject(expanded,expanded.system?.campaign??{});delete updateData.system,await this.actor.update({"system.campaign":updateData}),updateData.level&&await this.updateFeatures(updateData.level)}notifyUpdate=foundry.utils.debounce(()=>{this.reset(),this.prepareBaseData(),this.prepareDerivedData(),this.actor.render()},50);prepareBaseData(){const synthetics=this.actor.synthetics,build=this.build;if(this.armies=game.actors.filter(a=>a.isOfType("army")&&a.alliance==="party"),this.consumption.army=t$1(this.armies,a=>a.system.consumption),!build.manual){for(const ability of KINGDOM_ABILITIES)this.abilities[ability].value=10;for(const category of["charter","heartland","government"]){const data=build[category],chosen=build.boosts[category];if(!data)continue;"flaw"in data&&data.flaw&&(this.abilities[data.flaw].value-=2);const activeBoosts=resolveKingdomBoosts(data,chosen);for(const ability of activeBoosts)this.abilities[ability].value+=this.abilities[ability].value>=18?1:2}const activeLevels=[1,5,10,15,20].filter(l=>this.level>=l);for(const level of activeLevels){const chosen=build.boosts[level].slice(0,2);for(const ability of chosen)this.abilities[ability].value+=this.abilities[ability].value>=18?1:2}}if(build.government&&build.government.skills.length>0)for(const skill of build.government.skills)build.skills[skill].rank=Math.max(1,build.skills[skill].rank);const customModifiers=this.customModifiers??={};for(const selector of Object.keys(customModifiers)){const modifiers=customModifiers[selector]=customModifiers[selector].map(rawModifier=>new Modifier(rawModifier));(synthetics.modifiers[selector]??=[]).push(...modifiers.map(m=>()=>m))}const sizeData=Object.entries(KINGDOM_SIZE_DATA).findLast(([size])=>this.size>=Number(size))?.[1]??KINGDOM_SIZE_DATA[1];this.nationType=sizeData.type,this.resources.dice.faces=sizeData.faces,sizeData.controlMod&&(synthetics.modifiers["control-dc"]??=[]).push(()=>new Modifier({slug:"size",label:"Size Modifier",modifier:sizeData.controlMod}));for(const ability of KINGDOM_ABILITIES){const penalty=this.abilities[ability].penalty;penalty&&(synthetics.modifiers[`${ability}-based`]??=[]).push(()=>new Modifier({slug:"ruin",type:"item",label:KINGDOM_RUIN_LABELS[ability],modifier:penalty}))}for(const role of KINGDOM_LEADERSHIP){const data=this.leadership[role],actor=fromUuidSync(data.uuid??"");if(actor instanceof ActorPF2e?actor.hasPlayerOwner||(data.vacant=!1):data.vacant=!0,data.vacant){const penalties=VACANCY_PENALTIES[role]();for(const[selector,entries]of Object.entries(penalties.adjustments??{}))(synthetics.modifierAdjustments[selector]??=[]).push(...entries);for(const[selector,entries]of Object.entries(penalties.modifiers??{}))(synthetics.modifiers[selector]??=[]).push(...entries.map(e2=>()=>new Modifier(e2)))}if(data.invested){const ability=KINGDOM_LEADERSHIP_ABILITIES[role];(synthetics.modifiers[`${ability}-skill-check`]??=[]).push(()=>new Modifier({slug:"invested",label:"PF2E.Kingmaker.Kingdom.Invested",type:"status",modifier:1}))}}if(this.unrest.value>0){const modifier=-([1,5,10,15].findLastIndex(t2=>this.unrest.value>=t2)+1);(synthetics.modifiers["kingdom-check"]??=[]).push(()=>new Modifier({slug:"unrest",label:"PF2E.Kingmaker.Kingdom.Unrest",type:"status",modifier}))}const settlements=Object.values(this.settlements).filter(e$1);for(const settlement of settlements){if(!settlement)continue;const typeData=KINGDOM_SETTLEMENT_TYPE_DATA[settlement.type];settlement.consumption.base=typeData.consumption,settlement.consumption.total=Math.max(0,typeData.consumption-settlement.consumption.reduction)}for(const[type2,value]of t$f(this.resources.commodities)){const settlementStorage=t$1(settlements,s=>s.storage[type2]);value.max=sizeData.storage+settlementStorage}}prepareDerivedData(){const synthetics=this.actor.synthetics,{consumption,resources}=this;for(const ability of KINGDOM_ABILITIES)this.abilities[ability].mod=(this.abilities[ability].value-10)/2;resources.dice.number=Math.max(0,this.level+4+resources.dice.bonus-resources.dice.penalty);const settlements=Object.values(this.settlements).filter(e$1);consumption.settlement=t$1(settlements,s=>s.consumption.total);const consumptionStatistic=new Statistic(this.actor,{slug:"consumption",label:"PF2E.Kingmaker.Consumption.Label",domains:["consumption"],modifiers:[consumption.settlement&&new Modifier({slug:"settlements",label:"PF2E.Kingmaker.Settlement.Label",modifier:consumption.settlement}),consumption.army&&new Modifier({slug:"army",label:"PF2E.Kingmaker.Army.Label",modifier:consumption.army}),this.resources.workSites.food.value&&new Modifier({slug:"farmland",label:"PF2E.Kingmaker.WorkSites.food.Name",modifier:-this.resources.workSites.food.value})].filter(e$1)});consumption.value=Math.max(0,consumptionStatistic.mod),consumption.breakdown=consumptionStatistic.check.breakdown;const controlMod=CONTROL_DC_BY_LEVEL[Math.clamp(this.level-1,0,19)]-10;this.control=new Statistic(this.actor,{slug:"control",label:"PF2E.Kingmaker.Kingdom.ControlDC",domains:["control-dc"],modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:controlMod})]}),this.skills=t$9(KINGDOM_SKILLS,skill=>{const ability=KINGDOM_SKILL_ABILITIES[skill],abilityMod=this.abilities[ability].mod,rank=this.build.skills[skill].rank,domains=["kingdom-check",`${ability}-based`,`${ability}-skill-check`,skill],statistic=new Statistic(this.actor,{slug:skill,rank,label:KINGDOM_SKILL_LABELS[skill],domains,modifiers:[new Modifier({slug:ability,label:KINGDOM_ABILITY_LABELS[ability],modifier:abilityMod,type:"ability",adjustments:extractModifierAdjustments(synthetics.modifierAdjustments,domains,ability)}),createProficiencyModifier({actor:this.actor,rank,domains,level:this.level})],check:{type:"skill-check"}});return[skill,statistic]});const evenLevels=new Array(this.level).fill(0).map((_,idx)=>idx+1).filter(idx=>idx%2===0);this.features=new FeatGroup(this.actor,{id:"features",label:"PF2E.Kingmaker.Kingdom.FeatSlot.Features"},{limit:this.level}),this.feats=new FeatGroup(this.actor,{id:"kingdom",label:"PF2E.Kingmaker.Kingdom.FeatSlot.Feats",slots:[{id:"government",label:"G"},...evenLevels],filter:{traits:["kingdom"]}},{limit:this.level}),this.bonusFeats=new FeatGroup(this.actor,{id:"bonus",label:"PF2E.Kingmaker.Kingdom.FeatSlot.Bonus",filter:{traits:["kingdom"]}},{limit:this.level});const allFeatures=this.actor.itemTypes.campaignFeature,features=t(allFeatures.filter(f=>f.isFeature),f=>f.level??1,f=>f.name),feats=t(allFeatures.filter(f=>f.isFeat),f=>f.sort);for(const feature of features)this.features.assignFeat(feature);for(const feat of feats)this.feats.assignFeat(feat)||this.bonusFeats.assignFeat(feat)}getRollOptions(){return[this.unrest.value?`kingdom:unrest:${this.unrest.value}`:null].filter(e$1)}getRollData(){return{kingdom:this}}async importActivities({skipDialog=!1}={}){const pack=game.packs.get("pf2e.kingmaker-features");if(!pack)throw ErrorPF2e("Could not load kingdom features compendium");await this.updateFeatures(this.level);const documents=(await pack.getDocuments({type:"campaignFeature"})).filter(d=>d instanceof ItemPF2e&&d.isOfType("campaignFeature")).filter(d=>d.system.category==="kingdom-activity");await importDocuments(this.actor,documents,skipDialog)}async updateFeatures(level){const featuresToDelete=this.actor.itemTypes.campaignFeature.filter(f=>f.isFeature).filter(f=>(f.level??0)>level).map(f=>f.id),featuresToAdd=await(async()=>{const pack=game.packs.get("pf2e.kingmaker-features");return pack?(await pack.getDocuments({type:"campaignFeature"})).filter(d=>d instanceof ItemPF2e&&d.isOfType("campaignFeature")).filter(d=>d.system.category==="kingdom-feature").filter(d=>level>=(d.level??0)).filter(d=>!this.actor.items.some(i=>i.sourceId===d.uuid)).map(i=>i.toObject()):(console.error("PF2E System | Could not load kingdom features compendium"),[])})();await this.actor.deleteEmbeddedDocuments("Item",featuresToDelete),await this.actor.createEmbeddedDocuments("Item",featuresToAdd)}getStatistic(slug){return this.skills&&objectHasKey(this.skills,slug)?this.skills[slug]??null:null}renderSheet(options={}){options.type==="builder"?new KingdomBuilder(this).render(!0):new KingdomSheetPF2e(this.actor).render(!0,{tab:options.tab})}_preUpdate(changed){const actor=this.actor,feat=changed.build?.government?.feat;feat&&(console.log("Replacing feat"),fromUuid(feat).then(async f=>{if(!(f instanceof CampaignFeaturePF2e))return;const currentGovernmentFeat=actor.itemTypes.campaignFeature.find(f2=>f2.system.location==="government"),newFeat=f.clone({"system.location":"government"});await currentGovernmentFeat?.delete(),await actor.createEmbeddedDocuments("Item",[newFeat.toObject()])}))}}const BASIC_WAR_ACTIONS_FOLDER="Vqp8b64uH35zkncy",ARMY_TYPES=["infantry","cavalry","siege","skirmisher"],ARMY_STATS={scouting:[0,7,8,9,11,12,14,15,16,18,19,21,22,23,25,26,28,29,30,32,33],ac:[0,16,18,19,21,22,24,25,27,28,30,31,33,34,36,37,39,40,42,43,45],strongSave:[0,10,11,12,14,15,17,18,19,21,22,24,25,26,28,29,30,32,33,35,36],weakSave:[0,4,5,6,8,9,11,12,13,15,16,18,19,20,22,23,25,26,27,29,30],attack:[0,9,11,12,14,15,17,18,20,21,23,24,26,27,29,30,32,33,35,36,38],maxTactics:[0,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,6]};function getArmyGearData(){return{...t$9(["melee","ranged"],type2=>[`additional-${type2}`,{img:type2==="melee"?"icons/weapons/axes/axe-battle-black.webp":"icons/weapons/crossbows/crossbow-simple-brown.webp",name:game.i18n.format("PF2E.Kingmaker.Army.Gear.AdditionalWeapon.Name",{type:game.i18n.format(`PF2E.Kingmaker.Army.Strikes.${type2}`)}),description:"PF2E.Kingmaker.Army.Gear.AdditionalWeapon.Description",traits:["army"],level:1,price:10}]),...t$9(["melee","ranged"],type2=>[type2,{img:type2==="melee"?"icons/weapons/axes/axe-battle-black.webp":"icons/weapons/crossbows/crossbow-simple-brown.webp",name:game.i18n.format("PF2E.Kingmaker.Army.Gear.MagicWeapons.Name",{type:game.i18n.format(`PF2E.Kingmaker.Army.Strikes.${type2}`)}),description:"PF2E.Kingmaker.Army.Gear.MagicWeapons.Description",traits:["army","magical"],ranks:[{price:20,level:2},{price:40,level:10},{price:60,level:16}].map((d,idx)=>({...d,name:`PF2E.Kingmaker.Army.Gear.MagicWeapons.rank${idx+1}.Name`,description:`PF2E.Kingmaker.Army.Gear.MagicWeapons.rank${idx+1}.Description`}))}]),potions:{img:"icons/consumables/potions/bottle-round-corked-orante-red.webp",name:"PF2E.Kingmaker.Army.Gear.Potions.Name",description:"PF2E.Kingmaker.Army.Gear.Potions.Description",traits:["army","consumable","healing","magical","potion"],level:1,price:15},armor:{img:"icons/equipment/shield/heater-wooden-brown-axe.webp",name:game.i18n.localize("PF2E.Kingmaker.Army.Gear.Armor.Name"),description:game.i18n.localize("PF2E.Kingmaker.Army.Gear.Armor.Description"),traits:["army","magical"],ranks:[{price:25,level:5},{price:50,level:11},{price:75,level:18}].map((d,idx)=>({...d,name:`PF2E.Kingmaker.Army.Gear.Armor.rank${idx+1}.Name`,description:`PF2E.Kingmaker.Army.Gear.Armor.rank${idx+1}.Description`}))}}}__name(getArmyGearData,"getArmyGearData"),__name2(getArmyGearData,"getArmyGearData");class ArmyPF2e extends ActorPF2e{static{__name(this,"ArmyPF2e")}static{__name2(this,"ArmyPF2e")}get allowedItemTypes(){return["campaignFeature","effect"]}get underRoutThreshold(){return this.hitPoints.value<=this.system.attributes.hp.routThreshold}get kingdom(){if(this.alliance==="party"){const campaign=game.actors.party?.campaign;return campaign instanceof Kingdom?campaign:null}return null}get maxTactics(){return ARMY_STATS.maxTactics[this.level]}get strongSave(){return this.system.saves.maneuver>=this.system.saves.morale?"maneuver":"morale"}prepareData(){super.prepareData(),this.kingdom?.notifyUpdate()}prepareBaseData(){super.prepareBaseData(),this.system.details.level.value=Math.clamp(this.system.details.level.value,1,20),this.system.resources.potions.max=3,this.system.resources.ammunition.max=5,this.system.perception={senses:[]},this.system.details.alliance=this.hasPlayerOwner?"party":"opposition",this.rollOptions.all[`self:trait:${this.system.traits.type}`]=!0,this.rollOptions.all["self:under-rout-threshold"]=this.underRoutThreshold}prepareDerivedData(){if(super.prepareDerivedData(),this.prepareSynthetics(),this.system.consumption=Math.max(0,this.system.consumption),this.itemTypes.campaignFeature.some(f=>f.slug==="darkvision")){const sense=new Sense({type:"darkvision"},{parent:this}).toObject(!1);this.system.perception.senses.push(sense)}else if(this.itemTypes.campaignFeature.some(f=>f.slug==="low-light-vision")){const sense=new Sense({type:"low-light-vision"},{parent:this}).toObject(!1);this.system.perception.senses.push(sense)}this.tactics=new FeatGroup(this,{id:"tactics",label:"PF2E.Kingmaker.Army.Tactics",slots:t$c(0,this.maxTactics).map(idx=>({id:String(idx),label:""}))}),this.bonusTactics=new FeatGroup(this,{id:"bonus",label:"PF2E.Kingmaker.Army.TacticsFree"});const expectedAC=ARMY_STATS.ac[this.level],acAdjustment=this.system.ac.value-expectedAC;this.armorClass=new ArmorStatistic(this,{attribute:null,modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:expectedAC-10}),acAdjustment&&new Modifier({slug:"adjustment",label:"PF2E.Kingmaker.Army.Adjustment",modifier:acAdjustment}),this.system.ac.potency&&new Modifier({slug:"potency",label:"Potency",modifier:this.system.ac.potency})].filter(e$1)}).dc,this.system.ac.value=this.armorClass.value;const baseScouting=ARMY_STATS.scouting[this.level],scoutAdjustment=this.system.scouting-baseScouting;this.scouting=new Statistic(this,{slug:"scouting",label:"PF2E.Kingmaker.Army.Scouting",domains:["scouting"],modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:baseScouting}),scoutAdjustment?new Modifier({slug:"adjustment",label:"PF2E.Kingmaker.Army.Adjustment",modifier:scoutAdjustment}):null].filter(e$1)}),this.system.scouting=this.scouting.mod;for(const saveType of["maneuver","morale"]){const baseValue=(this.strongSave===saveType?ARMY_STATS.strongSave:ARMY_STATS.weakSave)[this.level],adjustment=this.system.saves[saveType]-baseValue;this[saveType]=new Statistic(this,{slug:saveType,label:`PF2E.Kingmaker.Army.Save.${saveType}`,domains:["saving-throw",saveType],modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:baseValue}),adjustment?new Modifier({slug:"adjustment",label:"PF2E.Kingmaker.Army.Adjustment",modifier:adjustment}):null].filter(e$1)})}const tiebreakPriority=this.hasPlayerOwner?2:1;this.initiative=new ActorInitiative(this,{statistic:"scouting",tiebreakPriority}),this.strikes=Object.fromEntries(["melee","ranged"].map(t2=>this.system.weapons[t2]?[t2,this.prepareArmyStrike(t2)]:null).filter(e$1));for(const tactic of this.itemTypes.campaignFeature.filter(i=>i.category==="army-tactic"))this.tactics.assignFeat(tactic)||this.bonusTactics.assignFeat(tactic)}async usePotion(){const newPotions=Math.max(0,this.system.resources.potions.value-1),newHP=Math.min(this.attributes.hp.value+1,this.attributes.hp.max);await this.update({"system.attributes.hp.value":newHP,"system.resources.potions.value":newPotions}),await ChatMessagePF2e.create({speaker:ChatMessagePF2e.getSpeaker({actor:this,token:this.token}),flavor:createHTMLElement("div",{children:[createHTMLElement("strong",{children:[game.i18n.localize("PF2E.Kingmaker.Army.Potions.UsedPotionHeader")]}),document.createElement("hr")]}).outerHTML,content:createHTMLElement("p",{children:[game.i18n.localize("PF2E.Kingmaker.Army.Potions.UsedPotionContent")]}).outerHTML,style:CONST.CHAT_MESSAGE_STYLES.EMOTE})}prepareArmyStrike(type2){const synthetics=this.synthetics,data=this.system.weapons[type2];if(data===null)return null;const attackDomains=["attack","attack-roll",`${type2}-attack-roll`],maps=(()=>{const baseMap={slug:"multiple-attack-penalty",label:"PF2E.MultipleAttackPenalty",map1:-5,map2:-10},optionSet=new Set(this.getRollOptions(attackDomains)),maps2=this.synthetics.multipleAttackPenalties??{},fromSynthetics=attackDomains.flatMap(d=>maps2[d]??[]).filter(p=>p.predicate?.test(optionSet)??!0).map(p=>({slug:baseMap.slug,label:p.label,map1:p.penalty,map2:p.penalty*2}));return[baseMap,...fromSynthetics].reduce((lowest,p)=>p.map1>lowest.map1?p:lowest)})(),createMapModifier=__name2(prop2=>new Modifier({slug:maps.slug,label:maps.label,modifier:maps[prop2],adjustments:extractModifierAdjustments(synthetics.modifierAdjustments,attackDomains,maps.slug)}),"createMapModifier"),statistic=new Statistic(this,{slug:`${type2}-strike`,label:data.name,domains:attackDomains,rollOptions:[`item:${type2}`],check:{type:"attack-roll"},modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:ARMY_STATS.attack[this.level]}),data.potency&&new Modifier({slug:"potency",label:"Potency",modifier:data.potency}),new Modifier({slug:"concealed",label:"PF2E.Kingmaker.Army.Condition.concealed.name",type:"circumstance",modifier:-2,predicate:["target:effect:concealed"],hideIfDisabled:!0})].filter(e$1)}),dealDamage=__name2(async(params={},outcome="success")=>{const targetToken=(params.target??game.user.targets.first())?.document??null,domains=["damage","strike-damage",`${type2}-damage`],context=await new DamageContext({viewOnly:params.getFormula??!1,origin:{actor:this,statistic},target:{token:targetToken},domains,outcome,checkContext:params.checkContext,options:new Set}).resolve(),origin=context.origin;if(!origin)return null;const damageContext={type:"damage-roll",sourceType:"attack",self:context.origin,target:context.target,outcome,options:context.options,domains,...eventToRollParams(params.event,{type:"damage"})},{formula,breakdown}=createDamageFormula({base:[{modifier:outcome==="success"?1:2,damageType:"untyped",category:null}],modifiers:extractModifiers(origin.actor.synthetics,domains,{test:context.options}),dice:extractDamageDice(origin.actor.synthetics.damageDice,{selectors:domains,test:context.options,resolvables:{target:context.target?.actor??null}})}),template={name:"Army damage",materials:[],modifiers:[],damage:{roll:new DamageRoll(formula),breakdown}};return DamagePF2e.roll(template,damageContext)},"dealDamage");return{slug:`${type2}-strike`,label:data.name,type:"strike",glyph:"A",variants:[0,1,2].map(idx=>{const mapModifier=idx===0?null:createMapModifier(`map${idx}`),penalty=mapModifier?.modifier??0;return{label:idx===0?signedInteger(statistic.mod):game.i18n.format("PF2E.MAPAbbreviationValueLabel",{value:signedInteger(statistic.mod+penalty),penalty}),mod:statistic.mod,roll:__name2(async params=>{const targetToken=params.target??game.user.targets.find(t2=>!!t2.actor?.isOfType("army")),roll=await statistic.roll({identifier:type2,action:"army-strike",melee:type2==="melee",modifiers:mapModifier?[mapModifier]:[],target:targetToken?.actor,dc:{slug:"ac"},damaging:!0,extraRollOptions:["origin:action:slug:army-strike"],...eventToRollParams(params.event,{type:"check"})});if(roll&&type2==="ranged"){const newAmmo=Math.max(0,this.system.resources.ammunition.value-1);this.update({"system.resources.ammunition.value":newAmmo})}return roll},"roll")}}),damage:__name2(params=>dealDamage(params,"success"),"damage"),critical:__name2(params=>dealDamage(params,"criticalSuccess"),"critical")}}updateLevel(newLevel){newLevel=Math.clamp(newLevel,1,20);const currentLevel=this.system.details.level.value,system2=this._source.system,strongSave=system2.saves.maneuver>=system2.saves.morale?"maneuver":"morale",strongSaveDifference=ARMY_STATS.strongSave[newLevel]-ARMY_STATS.strongSave[currentLevel],weakSaveDifference=ARMY_STATS.weakSave[newLevel]-ARMY_STATS.weakSave[currentLevel];return this.update({system:{ac:{value:system2.ac.value+(ARMY_STATS.ac[newLevel]-ARMY_STATS.ac[currentLevel])},details:{level:{value:newLevel}},saves:{maneuver:system2.saves.maneuver+(strongSave==="maneuver"?strongSaveDifference:weakSaveDifference),morale:system2.saves.morale+(strongSave==="morale"?strongSaveDifference:weakSaveDifference)},scouting:system2.scouting+(ARMY_STATS.scouting[newLevel]-ARMY_STATS.scouting[currentLevel])}})}checkItemValidity(source2){if(source2.type==="campaignFeature"&&source2.system?.category==="army-tactic"){const validArmyTypes=ARMY_TYPES.filter(t2=>source2.system?.traits?.value?.includes(t2));if(validArmyTypes.length>0&&!validArmyTypes.includes(this.system.traits.type))return ui.notifications.error("PF2E.Kingmaker.Army.Error.InvalidTacticType",{format:{name:source2.name,type:game.i18n.localize(CONFIG.PF2E.kingmakerTraits[this.system.traits.type])}}),!1}return super.checkItemValidity(source2)}getStatistic(slug){return tupleHasValue(["scouting","morale","maneuver"],slug)?this[slug]:this.kingdom?.getStatistic(slug)??super.getStatistic(slug)}_preUpdate(changed,options,user){if(!((options.diff??!0)&&(options.recursive??!0)))return super._preUpdate(changed,options,user);if(typeof changed?.system?.attributes?.hp?.value=="number"){const max=Number(changed.system.attributes.hp.max??this.system.attributes.hp.max);changed.system.attributes.hp.value=Math.clamp(changed.system.attributes.hp.value,0,max)}return super._preUpdate(changed,options,user)}_onDelete(options,userId){super._onDelete(options,userId),this.kingdom?.reset()}}class HazardPF2e extends ActorPF2e{static{__name(this,"HazardPF2e")}static{__name2(this,"HazardPF2e")}get allowedItemTypes(){return[...super.allowedItemTypes,"action","melee"]}get rarity(){return this.system.traits.rarity}get isComplex(){return this.system.details.isComplex}get hardness(){return Math.abs(this.system.attributes.hardness)}get hasDefenses(){return!!(this.hitPoints?.max||this.attributes.ac.value)}get canAttack(){return this.itemTypes.melee.length>0}get emitsSound(){const{emitsSound}=this.system.attributes;return!this.isDead&&typeof emitsSound=="boolean"?emitsSound:!!game.combats.active?.started&&game.combats.active.combatants.some(c=>c.actor===this)}isAffectedBy(effect){const damageType=objectHasKey(CONFIG.PF2E.damageTypes,effect)?effect:e$3(effect)?effect.system.persistent?.damageType??null:null;if(!this.system.attributes.hasHealth&&damageType)return!1;const{weaknesses,resistances}=this.system.attributes;return damageType&&["vitality","void"].includes(damageType)?weaknesses.some(w=>w.type===damageType)||resistances.some(r2=>r2.type===damageType):super.isAffectedBy(effect)}prepareBaseData(){super.prepareBaseData();const{attributes,details}=this.system;if(attributes.hp.negativeHealing=!1,attributes.hp.brokenThreshold=Math.floor(attributes.hp.max/2),attributes.hasHealth=attributes.hp.max>0,attributes.immunities.some(i=>i.type==="object-immunities")||attributes.immunities.unshift(new Immunity({type:"object-immunities",source:"TYPES.Actor.hazard"})),this.isComplex){attributes.stealth.value??=0;const withPartialInitiative=this.system;withPartialInitiative.initiative={statistic:"stealth",tiebreakPriority:this.hasPlayerOwner?2:1}}details.alliance=null}prepareDerivedData(){super.prepareDerivedData(),this.prepareSynthetics(),setHitPointsRollOptions(this);const system2=this.system;this.skills={stealth:new Statistic(this,{slug:"stealth",label:CONFIG.PF2E.skills.stealth.label,domains:["stealth","dex-based","skill-check","dex-skill-check","all"],modifiers:[new Modifier({label:"PF2E.ModifierTitle",slug:"base",type:"untyped",modifier:system2.attributes.stealth.value??0})],check:{type:"skill-check"}})};const stealthSource=this._source.system.attributes.stealth;if(this.system.attributes.stealth=foundry.utils.mergeObject(this.skills.stealth.getTraceData(),{details:stealthSource.details.trim()}),stealthSource.value===null){const traceData=this.system.attributes.stealth;traceData.value=traceData.dc=traceData.totalModifier=null}if(system2.initiative&&(this.initiative=new ActorInitiative(this,t$3(system2.initiative,["statistic","tiebreakPriority"])),system2.initiative=this.initiative.getTraceData()),this.hasDefenses){const baseModifier=new Modifier({slug:"base",label:"PF2E.BaseModifier",modifier:system2.attributes.ac.value-10}),statistic=new ArmorStatistic(this,{rank:1,modifiers:[baseModifier]});this.armorClass=statistic.dc,system2.attributes.ac=statistic.getTraceData()}this.saves=this.prepareSaves(),this.system.actions=this.itemTypes.melee.map(m=>attackFromMeleeItem(m))}prepareData(){super.prepareData();const weaknessesAndResistances=new Set([this.system.attributes.weaknesses.map(w=>w.type),this.system.attributes.resistances.map(r2=>r2.type)].flat()),objectImmunities=this.system.attributes.immunities.find(i=>i.type==="object-immunities");for(const wrType of["bleed","mental","poison","spirit"])weaknessesAndResistances.has(wrType)&&objectImmunities?.exceptions.push(wrType)}prepareSaves(){const system2=this.system;return SAVE_TYPES.reduce((saves,saveType)=>{const save=system2.saves[saveType],label=game.i18n.localize(CONFIG.PF2E.saves[saveType]),base=save.value;if(!base)return saves;const statistic=new Statistic(this,{slug:saveType,label,attribute:CONFIG.PF2E.savingThrowDefaultAttributes[saveType],domains:[saveType,"saving-throw"],modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:base})],check:{type:"saving-throw"}});return this.system.saves[saveType]=foundry.utils.mergeObject(save,statistic.getTraceData()),saves[saveType]=statistic,saves},{})}}class LootPF2e extends ActorPF2e{static{__name(this,"LootPF2e")}static{__name2(this,"LootPF2e")}armorClass=null;get allowedItemTypes(){return["physical"]}get isLoot(){return this.system.lootSheetType==="Loot"}get isMerchant(){return this.system.lootSheetType==="Merchant"}get hiddenWhenEmpty(){return this.isLoot&&this.system.hiddenWhenEmpty}get canHostRuleElements(){return!1}get canAct(){return!1}isAffectedBy(){return!1}get visible(){return this.permission>=CONST.DOCUMENT_OWNERSHIP_LEVELS.OBSERVER}canUserModify(user,action2){return super.canUserModify(user,action2)||action2==="update"&&this.permission>=CONST.DOCUMENT_OWNERSHIP_LEVELS.LIMITED}async toggleTokenHiding(){if(!this.hiddenWhenEmpty||!this.isOwner)return;const hiddenStatus=this.items.size===0,promises=game.scenes.map(s=>[s,s.tokens.filter(t2=>t2.actor===this)]).map(([scene,tokenDocs])=>scene.updateEmbeddedDocuments("Token",tokenDocs.map(tokenDoc=>({_id:tokenDoc.id,hidden:hiddenStatus}))));await Promise.allSettled(promises)}prepareBaseData(){const system2=this.system;system2.attributes={},super.prepareBaseData()}prepareDerivedData(){this.rules=[],super.prepareDerivedData()}_onCreate(data,options,userId){game.user.id===userId&&this.toggleTokenHiding(),super._onCreate(data,options,userId)}_onUpdate(changed,options,userId){game.user.id===userId&&changed.system?.hiddenWhenEmpty!==void 0&&this.toggleTokenHiding(),super._onUpdate(changed,options,userId)}_onCreateDescendantDocuments(parent,collection,documents,data,options,userId){game.user.id===userId&&this.toggleTokenHiding(),super._onCreateDescendantDocuments(parent,collection,documents,data,options,userId)}_onDeleteDescendantDocuments(parent,collection,documents,ids,options,userId){game.user.id===userId&&this.toggleTokenHiding(),super._onDeleteDescendantDocuments(parent,collection,documents,ids,options,userId)}}class PartyPF2e extends ActorPF2e{static{__name(this,"PartyPF2e")}static{__name2(this,"PartyPF2e")}armorClass=null;get active(){return game.actors.party===this}get baseAllowedItemTypes(){return["physical"]}get allowedItemTypes(){return[...this.baseAllowedItemTypes,...this.campaign?.extraItemTypes??[]]}get canAct(){return!1}canUserModify(user,action2){return super.canUserModify(user,action2)||action2==="update"&&this.members.some(m=>m.canUserModify(user,action2))}isAffectedBy(){return!1}validate(options){if(!super.validate(options))return!1;const changes=options?.changes??{};return!(changes.system?.campaign&&!this.campaign?.validate({...options,changes:changes.system.campaign}))}updateSource(data,options){if(!data||options?.dryRun||!this.campaign)return super.updateSource(data,options);const expanded=foundry.utils.expandObject(data??{});return expanded.system?.campaign&&(this.campaign.updateSource(expanded.system.campaign,options),this.campaign.schema.clean(this.campaign._source),this.campaign.reset()),super.updateSource(data,options)}prepareRuleElements(){return this.items.contents.filter(item=>!item.isOfType("physical")).flatMap(item=>item.prepareRuleElements()).filter(rule=>!rule.ignored).sort((elementA,elementB)=>elementA.priority-elementB.priority)}prepareBaseData(){if(super.prepareBaseData(),this.members=this.system.details.members.map(m=>fromUuidSync(m.uuid)).filter(a=>a instanceof ActorPF2e&&a.isOfType("creature")).sort((a,b)=>a.name.localeCompare(b.name,game.i18n.lang)),fromUuidSync(this.uuid)===this)for(const member of this.members)member.parties.add(this);game.pf2e.settings.campaign.type==="kingmaker"&&!this.campaign?Object.defineProperty(this,"campaign",{value:new Kingdom(foundry.utils.deepClone(this.system._source.campaign??{}),{parent:this.system}),writable:!0,enumerable:!1}):game.pf2e.settings.campaign.type||(this.campaign=null),this.campaign?.prepareBaseData()}prepareDerivedData(){super.prepareDerivedData(),this.prepareSynthetics(),this.campaign?.prepareDerivedData()}async addMembers(...membersToAdd){const existing=this.system.details.members.filter(d=>this.members.some(m=>m.uuid===d.uuid)),existingUUIDs=new Set(existing.map(data=>data.uuid)),newMembers=membersToAdd.filter(a=>a.uuid.startsWith("Actor.")&&!existingUUIDs.has(a.uuid));for(const member of newMembers){const allianceUpdate=member.isOfType("character","npc")?{"system.details.alliance":member._source.system.details.alliance??"party"}:{};await member.update({folder:null,...allianceUpdate})}const members=[...existing,...newMembers.map(m=>({uuid:m.uuid}))];await this.update({system:{details:{members}}}),await resetActors(newMembers)}async removeMembers(...remove2){const uuids=remove2.map(d=>typeof d=="string"?d:d.uuid),members=this.system.details.members.filter(d=>this.members.some(m=>m.uuid===d.uuid)).filter(m=>!tupleHasValue(uuids,m.uuid));await this.update({system:{details:{members}}})}getRollOptions(domains){return super.getRollOptions(domains).concat(this.campaign?.getRollOptions?.()??[])}getRollData(){return foundry.utils.mergeObject(super.getRollData(),this.campaign?.getRollData?.()??{})}reset({actor=!1}={}){actor?this._resetAndRerenderDebounced():super.reset()}getStatistic(slug){const statistic=super.getStatistic(slug);return statistic||(this.campaign?.getStatistic?.(slug)??null)}_resetAndRerenderDebounced=foundry.utils.debounce(()=>{super.reset(),this.sheet.render(!1,{actor:!0})},50);_preCreate(data,options,user){return data.folder=null,super._preCreate(data,options,user)}async _preUpdate(changed,options,user){if(changed.folder=null,!changed.system)return super._preUpdate(changed,options,user);const members=this.members,newMemberUUIDs=changed.system.details?.members?.map(m=>m?.uuid);if(newMemberUUIDs){const deletedMembers=members.filter(m=>m?.uuid&&!newMemberUUIDs.includes(m.uuid));options.removedMembers=deletedMembers.map(m=>m.uuid)}const campaign=this.system._source.campaign;return campaign&&changed.system.campaign&&changed.system.campaign.type!==campaign.type&&(changed.system.campaign.type=campaign.type,this.campaign?._preUpdate?.(changed.system.campaign)),super._preUpdate(changed,options,user)}_onUpdate(changed,options,userId){super._onUpdate(changed,options,userId);const removedCreatures=(options.removedMembers??[]).map(uuid=>fromUuidSync(uuid)).filter(a=>a instanceof ActorPF2e&&a.isOfType("creature"));for(const actor of removedCreatures)actor.parties.delete(this);if(resetActors(removedCreatures),changed.system?.details?.members&&game.combat)for(const encounter of game.combats)encounter.reset(),ui.combat.render();game.ready&&changed.system?.campaign&&game.actors.get(this.id)===this&&ui.actors.render()}_onDelete(options,userId){super._onDelete(options,userId);for(const member of this.members)member.parties.delete(this);resetActors(this.members),ui.actors.saveActivePartyFolderState()}}class VehiclePF2e extends ActorPF2e{static{__name(this,"VehiclePF2e")}static{__name2(this,"VehiclePF2e")}get allowedItemTypes(){return[...super.allowedItemTypes,"physical","action"]}get dimensions(){return{length:this.system.details.space.long,width:this.system.details.space.wide,height:this.system.details.space.high}}get hardness(){return this.system.attributes.hardness}get emitsSound(){const{emitsSound}=this.system.attributes;return!this.isDead&&typeof emitsSound=="boolean"?emitsSound:!!game.combats.active?.started&&game.combats.active.combatants.some(c=>c.actor===this)}prepareBaseData(){if(super.prepareBaseData(),this.prototypeToken.flags?.pf2e?.linkToActorSize){const{width,height}=this.system.traits.size.tokenDimensions;this.prototypeToken.width=width,this.prototypeToken.height=height}}prepareDerivedData(){if(super.prepareDerivedData(),this.prepareSynthetics(),this.hasCondition("broken"))for(const selector of["ac","saving-throw"]){const modifiers=this.synthetics.modifiers[selector]??=[],brokenModifier=new Modifier({slug:"broken",label:"PF2E.ConditionTypeBroken",modifier:-2,adjustments:extractModifierAdjustments(this.synthetics.modifierAdjustments,[selector],"broken")});modifiers.push(()=>brokenModifier)}const{attributes}=this,hitPoints=new HitPointsStatistic(this,{baseMax:attributes.hp.max});attributes.hp=foundry.utils.mergeObject(hitPoints.getTraceData(),{brokenThreshold:Math.floor(hitPoints.max/2)}),setHitPointsRollOptions(this);const armorStatistic=new ArmorStatistic(this,{modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:this.system.attributes.ac.value-10,adjustments:extractModifierAdjustments(this.synthetics.modifierAdjustments,["all","ac"],"base")})]});this.armorClass=armorStatistic.dc,this.system.attributes.ac=armorStatistic.getTraceData(),this.prepareSaves()}prepareSaves(){const{synthetics}=this,slug="fortitude",domains=[slug,"saving-throw","all"],modifiers=[new Modifier({label:"PF2E.ModifierTitle",slug,type:"untyped",modifier:this.system.saves.fortitude.value}),...extractModifiers(synthetics,domains)],fortitude=new Statistic(this,{slug:"fortitude",label:CONFIG.PF2E.saves.fortitude,modifiers,domains,check:{type:"saving-throw"}});this.saves={fortitude},this.system.saves.fortitude=foundry.utils.mergeObject(this.system.saves.fortitude,fortitude.getTraceData())}async _preUpdate(changed,options,user){const result=await super._preUpdate(changed,options,user);if(result===!1)return result;if(this.prototypeToken.flags?.pf2e?.linkToActorSize){const currentSpace=this.system.details.space,spaceUpdates={wide:changed.system?.details?.space?.wide??currentSpace.wide,long:changed.system?.details?.space?.long??currentSpace.long},sizeCategory=changed.system?.traits?.size?.value??this.size,tokenDimensions=new ActorSizePF2e({value:sizeCategory,...spaceUpdates}).tokenDimensions;if(changed.prototypeToken=foundry.utils.mergeObject(changed.prototypeToken??{},tokenDimensions),canvas.scene){const updates=this.getActiveTokens(!0,!0).filter(token=>token.linkToActorSize).map(token=>({_id:token.id,...tokenDimensions}));await TokenDocumentPF2e.updateDocuments(updates,{parent:canvas.scene})}}}}function extractModifiers(synthetics,domains,options={}){domains=n(domains);const modifiers=domains.flatMap(s=>synthetics.modifiers[s]??[]).flatMap(d=>d(options)??[]);for(const modifier of modifiers)modifier.domains=[...domains],modifier.adjustments=extractModifierAdjustments(synthetics.modifierAdjustments,domains,modifier.slug),domains.some(s=>s.endsWith("damage"))&&(modifier.alterations=extractDamageAlterations(synthetics.damageAlterations,domains,modifier.slug));return modifiers}__name(extractModifiers,"extractModifiers"),__name2(extractModifiers,"extractModifiers");function extractModifierAdjustments(adjustmentsRecord,selectors,slug){return n(selectors.flatMap(s=>adjustmentsRecord[s]??[])).filter(a=>[slug,null].includes(a.slug))}__name(extractModifierAdjustments,"extractModifierAdjustments"),__name2(extractModifierAdjustments,"extractModifierAdjustments");function extractDamageAlterations(alterationsRecord,selectors,slug){return n(selectors.flatMap(s=>alterationsRecord[s]??[])).filter(a=>[slug,null].includes(a.slug))}__name(extractDamageAlterations,"extractDamageAlterations"),__name2(extractDamageAlterations,"extractDamageAlterations");function extractNotes(rollNotes,selectors){return selectors.flatMap(s=>(rollNotes[s]??[]).map(n2=>n2.clone()))}__name(extractNotes,"extractNotes"),__name2(extractNotes,"extractNotes");function extractDamageDice(synthetics,options){return options.selectors.flatMap(s=>synthetics[s]??[]).flatMap(d=>d(options)??[])}__name(extractDamageDice,"extractDamageDice"),__name2(extractDamageDice,"extractDamageDice");function processDamageCategoryStacking(base,options){const dice=options.dice,groupedModifiers=t$2(options.modifiers,m=>m.category==="persistent"?"persistent":"main"),modifiers=[...new StatisticModifier("damage",groupedModifiers.main??[],options.test).modifiers,...new StatisticModifier("persistent",groupedModifiers.persistent??[],options.test).modifiers],allPersistent=base.length>0&&base.every(b=>b.category==="persistent");return{modifiers:allPersistent?modifiers.filter(m=>m.category==="persistent"):modifiers,dice:allPersistent?dice.filter(d=>d.category==="persistent"):dice}}__name(processDamageCategoryStacking,"processDamageCategoryStacking"),__name2(processDamageCategoryStacking,"processDamageCategoryStacking");async function extractEphemeralEffects({affects,origin,target,item,domains,options}){if(!(origin&&target))return[];const[effectsFrom,effectsTo]=affects==="target"?[origin,target]:[target,origin],fullOptions=[...options,effectsFrom.getRollOptions(domains),effectsTo.getSelfRollOptions(affects)].flat(),resolvables=item?item.isOfType("spell")?{spell:item}:{weapon:item}:{};return(await Promise.all(domains.flatMap(s=>effectsFrom.synthetics.ephemeralEffects[s]?.[affects]??[]).map(d=>d({test:fullOptions,resolvables})))).filter(e$6).map(effect=>(effect.type==="effect"&&(effect.system.context={origin:{actor:effectsFrom.uuid,token:null,item:null,spellcasting:null,rollOptions:[]},target:{actor:effectsTo.uuid,token:null},roll:null},effect.system.duration={value:-1,unit:"unlimited",expiry:null,sustained:!1}),effect))}__name(extractEphemeralEffects,"extractEphemeralEffects"),__name2(extractEphemeralEffects,"extractEphemeralEffects");function extractRollTwice(rollTwices,selectors,options){const twices=selectors.flatMap(s=>rollTwices[s]??[]).filter(rt=>rt.predicate?.test(options)??!0);return twices.length===0||twices.some(rt=>rt.keep==="higher")&&twices.some(rt=>rt.keep==="lower")?!1:twices.at(0)?.keep==="higher"?"keep-higher":"keep-lower"}__name(extractRollTwice,"extractRollTwice"),__name2(extractRollTwice,"extractRollTwice");function extractRollSubstitutions(substitutions,domains,rollOptions){return domains.flatMap(d=>foundry.utils.deepClone(substitutions[d]??[])).filter(s=>s.predicate?.test(rollOptions)??!0)}__name(extractRollSubstitutions,"extractRollSubstitutions"),__name2(extractRollSubstitutions,"extractRollSubstitutions");function extractDegreeOfSuccessAdjustments(synthetics,selectors){return selectors.reduce((adjustments,selector)=>{const forSelector=synthetics.degreeOfSuccessAdjustments[selector]??[];return adjustments.push(...forSelector),adjustments},[])}__name(extractDegreeOfSuccessAdjustments,"extractDegreeOfSuccessAdjustments"),__name2(extractDegreeOfSuccessAdjustments,"extractDegreeOfSuccessAdjustments");async function processPreUpdateActorHooks(changed,{pack}){const actorId=String(changed._id),actor=pack?await game.packs.get(pack)?.getDocument(actorId):game.actors.get(actorId);if(!(actor instanceof ActorPF2e))return;const rules=actor.rules.filter(r2=>!!r2.preUpdateActor);if(rules.length===0)return;actor.flags.pf2e.rollOptions=actor.clone(changed,{keepId:!0}).flags.pf2e.rollOptions;const createDeletes=(await Promise.all(rules.map(r2=>actor.items.has(r2.item.id)?r2.preUpdateActor():Promise.resolve({create:[],delete:[]})))).reduce((combined,cd)=>(combined.create.push(...cd.create),combined.delete.push(...cd.delete),combined),{create:[],delete:[]});createDeletes.delete=n(createDeletes.delete).filter(id=>actor.items.has(id)),createDeletes.create.length>0&&await actor.createEmbeddedDocuments("Item",createDeletes.create,{keepId:!0,render:!1}),createDeletes.delete.length>0&&await actor.deleteEmbeddedDocuments("Item",createDeletes.delete,{render:!1})}__name(processPreUpdateActorHooks,"processPreUpdateActorHooks"),__name2(processPreUpdateActorHooks,"processPreUpdateActorHooks");function getSubItemPath(item){if(item.isOfType("physical")&&item.parentItem){const path=getSubItemPath(item.parentItem)??[item.parentItem];return path.push(item),path}return null}__name(getSubItemPath,"getSubItemPath"),__name2(getSubItemPath,"getSubItemPath");function createBatchRuleElementUpdate(rules,update){const itemUpdates=[],rulesByItem=t$2(rules,r2=>r2.item.uuid);if(!rules[0]?.actor)return[];const nestedUpdatesById={};for(const rules2 of Object.values(rulesByItem)){const item=rules2[0].item,ruleSources=item.toObject().system.rules,rollOptionSources=rules2.map(rule=>typeof rule.sourceIndex=="number"?ruleSources[rule.sourceIndex]:null).filter(source2=>!!source2);for(const ruleSource of rollOptionSources)foundry.utils.mergeObject(ruleSource,update);const subItemPath=getSubItemPath(item);if(subItemPath?.length){const root2=subItemPath[0],path=subItemPath.slice(1).map(i=>i.id);nestedUpdatesById[root2.id]??=[],nestedUpdatesById[root2.id].push({root:root2,item,path,ruleSources})}else itemUpdates.push({_id:item.id,system:{rules:ruleSources}})}for(const nestedRuleGroup of Object.values(nestedUpdatesById)){const root2=nestedRuleGroup[0].root,subitems=foundry.utils.deepClone(root2.toObject().system.subitems);if(!subitems)continue;for(const update2 of nestedRuleGroup){const startingItem=subitems.find(s=>s._id===update2.path[0]),item=update2.path.slice(1).reduce((item2,id)=>item2?.system.subitems?.find(s=>s._id===id),startingItem);item&&(item.system.rules=update2.ruleSources)}const existingUpdate=itemUpdates.find(u=>u._id===root2.id);existingUpdate?existingUpdate.system.subitems=subitems:itemUpdates.push({_id:root2.id,system:{subitems}})}return itemUpdates}__name(createBatchRuleElementUpdate,"createBatchRuleElementUpdate"),__name2(createBatchRuleElementUpdate,"createBatchRuleElementUpdate");function processChoicesFromData(data){if(Array.isArray(data))return data.every(c=>e$2(c)&&typeof c.value=="string")?data:[];if(e$3(data)){const entries=Object.entries(data);return entries.every(([_,c])=>typeof(e$2(c)?c.label:c)=="string")?entries.map(([key,entryValue])=>{const choice=typeof entryValue=="string"?{label:entryValue}:entryValue;return{...choice,label:String(choice.label),value:key}}):[]}return[]}__name(processChoicesFromData,"processChoicesFromData"),__name2(processChoicesFromData,"processChoicesFromData");const PROFICIENCY_RANK_OPTION=["proficiency:untrained","proficiency:trained","proficiency:expert","proficiency:master","proficiency:legendary"];function ensureProficiencyOption(options,rank){rank>=0&&options.add(`skill:rank:${rank}`).add(PROFICIENCY_RANK_OPTION[rank])}__name(ensureProficiencyOption,"ensureProficiencyOption"),__name2(ensureProficiencyOption,"ensureProficiencyOption");const MODIFIER_TYPES=new Set(["ability","circumstance","item","potency","proficiency","status","untyped"]);class Modifier{static{__name(this,"Modifier")}static{__name2(this,"Modifier")}slug;label;domains;modifier;#originalValue;type;ability;adjustments;alterations;force;enabled;ignored;rule;source;custom;damageType;damageCategory;predicate;critical;tags;hideIfDisabled;kind;constructor(...args){const params=__name2(args2=>typeof args2[0]=="string","isLegacyParams")(args)?{label:args[0],modifier:args[1],type:args[2]??"untyped",enabled:args[3],ignored:args[4],source:args[5]}:args[0];if(this.label=game.i18n.localize(params.label??params.name),this.slug=sluggify(params.slug??this.label),this.#originalValue=this.modifier=params.modifier,this.type=setHasElement(MODIFIER_TYPES,params.type)?params.type:"untyped",this.ability=params.ability??null,this.domains=params.domains??[],this.force=params.force??!1,this.adjustments=foundry.utils.deepClone(params.adjustments)??[],this.alterations=foundry.utils.deepClone(params.alterations)??[],this.enabled=params.enabled??!0,this.ignored=params.ignored??!1,this.custom=params.custom??!1,this.source=params.source??null,this.predicate=new Predicate(params.predicate??[]),this.tags=n(foundry.utils.deepClone(params.tags)??[]),this.hideIfDisabled=params.hideIfDisabled??!1,this.rule=params.rule??null,Object.defineProperty(this,"rule",{enumerable:!1}),this.damageType=objectHasKey(CONFIG.PF2E.damageTypes,params.damageType)?params.damageType:null,this.damageCategory=this.damageType==="bleed"?"persistent":params.damageCategory??null,this.critical=this.damageCategory==="splash"?!!params.critical:params.critical??null,this.kind=this.modifier>=0&&!["ability","untyped"].includes(this.type)?"bonus":this.modifier<0&&this.type!=="ability"?"penalty":"modifier",this.force&&this.type==="untyped")throw ErrorPF2e("A forced modifier must have a type")}get category(){return this.damageCategory}get value(){return this.kind==="penalty"&&this.modifier===0?-this.modifier:this.modifier}get signedValue(){return this.modifier===0&&this.kind==="penalty"?signedInteger(-this.modifier):signedInteger(this.modifier)}applyAdjustments({rollOptions}){this.modifier=this.#originalValue;const allRollOptions=[...rollOptions,...this.getRollOptions()],adjustments=this.adjustments.filter(a=>a.test(allRollOptions));if(adjustments.some(a=>a.suppress)){this.ignored=!0;return}const resolvedAdjustment=adjustments.reduce((resolved,adjustment)=>{const newValue=adjustment.getNewValue?.(resolved.value)??resolved.value;return newValue!==resolved.value&&(resolved.value=newValue,resolved.relabel=adjustment.relabel??null),resolved},{value:this.modifier,relabel:null});this.modifier=resolvedAdjustment.value,resolvedAdjustment.relabel&&(this.label=game.i18n.localize(resolvedAdjustment.relabel)),this.damageType=adjustments.reduce((damageType,adjustment)=>adjustment.getDamageType?.(damageType)??damageType,this.damageType)}applyDamageAlterations(options){for(const alteration of this.alterations)alteration.applyTo(this,options)}clone(data={},options={}){const clone=new Modifier({...this,modifier:this.#originalValue,rule:this.rule,...data});return options.test&&clone.test(options.test),clone}getRollOptions(){const options=["slug","type","value"].map(p=>`${this.kind}:${p}:${this[p]}`);this.type==="ability"&&this.ability&&options.push(`modifier:ability:${this.ability}`),options.push(...this.tags.map(t2=>`${this.kind}:tag:${t2}`));const damageKinds=[this.domains.some(d=>/\bdamage$/.test(d))?"damage":null,this.domains.some(d=>/\bhealing$/.test(d))?"healing":null].filter(e$1);for(const damageKind of damageKinds){if(options.push(damageKind),options.push(`${this.kind}:${damageKind}`),this.damageType){options.push(`${damageKind}:type:${this.damageType}`),options.push(`${this.kind}:${damageKind}:type:${this.damageType}`);const categoryFromType=DamageCategorization.fromDamageType(this.damageType);damageKind==="damage"&&categoryFromType&&(options.push(`${damageKind}:category:${categoryFromType}`),options.push(`${this.kind}:${damageKind}:category:${categoryFromType}`))}this.damageCategory&&(options.push(`${damageKind}:category:${this.damageCategory}`),options.push(`${this.kind}:${damageKind}:category:${this.damageCategory}`)),options.push(...this.tags.flatMap(t2=>[`${damageKind}:tag:${t2}`,`${this.kind}:${damageKind}:tag:${t2}`]))}return options}test(options){if(this.predicate.length===0)return;const rollOptions=this.rule?[...options,...this.rule.item.getRollOptions("parent")]:options;this.enabled=this.predicate.test(rollOptions),this.ignored=!this.enabled}toObject(){return{...n$1(this,["alterations","predicate","rule"]),predicate:this.predicate.toObject()}}toString(){return this.label}}function createAttributeModifier({actor,attribute,domains,max}){const withAttributeBased=domains.includes(`${attribute}-based`)?domains:[...domains,`${attribute}-based`],modifierValue=actor.abilities[attribute].mod,cappedValue=Math.min(modifierValue,max??modifierValue);return new Modifier({slug:attribute,label:CONFIG.PF2E.abilities[attribute],modifier:cappedValue,type:"ability",ability:attribute,adjustments:extractModifierAdjustments(actor.synthetics.modifierAdjustments,withAttributeBased,attribute)})}__name(createAttributeModifier,"createAttributeModifier"),__name2(createAttributeModifier,"createAttributeModifier");function createProficiencyModifier({actor,rank,domains,level,addLevel}){rank=Math.clamp(rank,0,4),addLevel??=rank>0;const pwolVariant=game.pf2e.settings.variants.pwol.enabled,baseBonuses=pwolVariant?game.pf2e.settings.variants.pwol.modifiers:[0,2,4,6,8],addedLevel=addLevel&&!pwolVariant?level??actor.level:0,bonus=baseBonuses[rank]+addedLevel;return new Modifier({slug:"proficiency",label:`PF2E.ProficiencyLevel${rank}`,modifier:bonus,type:"proficiency",adjustments:extractModifierAdjustments(actor.synthetics.modifierAdjustments,domains,"proficiency")})}__name(createProficiencyModifier,"createProficiencyModifier"),__name2(createProficiencyModifier,"createProficiencyModifier");const HIGHER_BONUS=__name2((a,b)=>a.modifier>=b.modifier,"HIGHER_BONUS"),LOWER_PENALTY=__name2((a,b)=>a.modifier<=b.modifier,"LOWER_PENALTY");function applyStacking(best,modifier,isBetter){const existing=best[modifier.type];return existing===void 0?(modifier.enabled=!0,best[modifier.type]=modifier,modifier.modifier):isBetter(modifier,existing)?(existing.enabled=!1,modifier.enabled=!0,best[modifier.type]=modifier,modifier.modifier-existing.modifier):(modifier.enabled=!1,0)}__name(applyStacking,"applyStacking"),__name2(applyStacking,"applyStacking");function applyStackingRules(modifiers){let total=0;const highestBonus={},lowestPenalty={},abilityModifiers=modifiers.filter(m=>m.type==="ability"&&!m.ignored),bestAbility=abilityModifiers.reduce((best,modifier)=>best===null||modifier.force?modifier:best.force?best:modifier.modifier>best.modifier?modifier:best,null);for(const modifier of abilityModifiers)modifier.ignored=modifier!==bestAbility;for(const modifier of modifiers){if(modifier.ignored){modifier.enabled=!1;continue}if(modifier.type==="untyped"){modifier.enabled=!0,total+=modifier.modifier;continue}modifier.modifier<0?total+=applyStacking(lowestPenalty,modifier,LOWER_PENALTY):total+=applyStacking(highestBonus,modifier,HIGHER_BONUS)}return total}__name(applyStackingRules,"applyStackingRules"),__name2(applyStackingRules,"applyStackingRules");class StatisticModifier{static{__name(this,"StatisticModifier")}static{__name2(this,"StatisticModifier")}slug;_modifiers;breakdown="";notes;constructor(slug,modifiers=[],rollOptions=new Set){rollOptions=rollOptions instanceof Set?rollOptions:new Set(rollOptions),this.slug=slug;const seen=modifiers.reduce((result,modifier)=>((!result[modifier.slug]?.enabled||Math.abs(modifier.modifier)>Math.abs(result[modifier.slug].modifier))&&(result[modifier.slug]=modifier),result),{});this._modifiers=Object.values(seen),this.calculateTotal(rollOptions)}get modifiers(){return[...this._modifiers]}push(modifier){const existingIdx=this._modifiers.findIndex(o=>o.slug===modifier.slug),existing=this._modifiers[existingIdx];return existing?Math.abs(modifier.modifier)>Math.abs(existing.modifier)&&(this._modifiers[existingIdx]=modifier,this.calculateTotal()):(this._modifiers.push(modifier),this.calculateTotal()),this._modifiers.length}unshift(modifier){return this._modifiers.find(o=>o.slug===modifier.slug)===void 0&&(this._modifiers.unshift(modifier),this.calculateTotal()),this._modifiers.length}delete(modifierSlug){const toDelete2=typeof modifierSlug=="object"?modifierSlug:this._modifiers.find(modifier=>modifier.slug===modifierSlug),wasDeleted=toDelete2&&this._modifiers.includes(toDelete2)?!!this._modifiers.findSplice(modifier=>modifier===toDelete2):!1;return wasDeleted&&this.calculateTotal(),wasDeleted}calculateTotal(rollOptions=new Set){if(rollOptions.size>0){for(const modifier of this._modifiers)modifier.test(rollOptions);adjustModifiers(this._modifiers,rollOptions)}applyStackingRules(this._modifiers),this.totalModifier=this._modifiers.filter(m=>m.enabled).reduce((total,m)=>total+m.modifier,0)}}function adjustModifiers(modifiers,rollOptions){for(const modifier of modifiers)for(const adjustment of modifier.adjustments)adjustment.applications=0;for(const modifier of[...modifiers].sort((a,b)=>Math.abs(b.value)-Math.abs(a.value)))modifier.applyAdjustments({rollOptions})}__name(adjustModifiers,"adjustModifiers"),__name2(adjustModifiers,"adjustModifiers");class CheckModifier extends StatisticModifier{static{__name(this,"CheckModifier")}static{__name2(this,"CheckModifier")}constructor(slug,statistic,modifiers=[],rollOptions=new Set){const baseModifiers=statistic.modifiers.filter(modifier=>modifier instanceof Modifier?!0:(e$3(modifier)&&"slug"in modifier&&typeof modifier.slug=="string"&&ui.notifications.error(`Unsupported modifier object (slug: ${modifier.slug}) passed`),!1)).map(m=>m.clone());super(slug,baseModifiers.concat(modifiers),rollOptions)}}class DamageDicePF2e{static{__name(this,"DamageDicePF2e")}static{__name2(this,"DamageDicePF2e")}selector;slug;label;diceNumber;dieSize;critical;category;damageType;tags;override;ignored;enabled;predicate;alterations;hideIfDisabled;constructor(params){if(params.selector)this.selector=params.selector;else throw ErrorPF2e("`selector` is mandatory");if(this.label=game.i18n.localize(params.label??""),this.slug=sluggify(params.slug??this.label),!this.slug)throw ErrorPF2e("A DiceModifier must have a slug");this.diceNumber=params.diceNumber??0,this.dieSize=params.dieSize??null,this.damageType=params.damageType??null,this.category=params.category??null,this.override=params.override??null,this.alterations=[params.alterations??[]].flat(),this.category=tupleHasValue(["persistent","precision","splash"],params.category)?params.category:this.damageType==="bleed"?"persistent":null,this.critical=this.category==="splash"?!!params.critical:params.critical??null,this.tags=n(foundry.utils.deepClone(params.tags)??[]),this.predicate=params.predicate instanceof Predicate?params.predicate:new Predicate(params.predicate??[]),this.enabled=params.enabled??this.predicate.test([]),this.ignored=params.ignored??!this.enabled,this.hideIfDisabled=params.hideIfDisabled??!1}get faces(){return Number(this.dieSize?.replace("d",""))||null}test(options){this.enabled=this.predicate.test(options),this.ignored=!this.enabled}getRollOptions(){const damageKind=this.selector.endsWith("healing")?"healing":"damage",categoryFromType=DamageCategorization.fromDamageType(this.damageType??"untyped");return[damageKind,`dice:slug:${this.slug}`,`dice:number:${this.diceNumber}`,`dice:faces:${this.dieSize}`,`dice:${damageKind}`,this.category?[`${damageKind}:category:${this.category}`,`dice:${damageKind}:category:${this.category}`]:[],categoryFromType?[`${damageKind}:category:${categoryFromType}`,`dice:${damageKind}:category:${categoryFromType}`]:[],this.damageType?[`${damageKind}:type:${this.damageType}`,`dice:${damageKind}:type:${this.damageType}`]:[],this.tags.flatMap(t2=>[`${damageKind}:tag:${t2}`,`dice:tag:${t2}`])].flat()}applyAlterations(options){for(const alteration of this.alterations)alteration.applyTo(this,options)}clone(){return new DamageDicePF2e(this)}toObject(){return{...n$1(this,["alterations","predicate"]),alterations:[],predicate:this.predicate.toObject()}}}const TRICK_MAGIC_SKILLS=["arcana","nature","occultism","religion"],TrickMagicTradition={arcana:"arcane",nature:"primal",occultism:"occult",religion:"divine"},traditionSkills={arcane:"arcana",divine:"religion",occult:"occultism",primal:"nature"};class TrickMagicItemEntry{static{__name(this,"TrickMagicItemEntry")}static{__name2(this,"TrickMagicItemEntry")}id;actor;skill;statistic;get counteraction(){return createCounteractStatistic(this)}attribute;tradition;constructor(actor,skill){if(!actor.isOfType("character"))throw ErrorPF2e("Trick magic entries may only be constructed with PCs");this.actor=actor,this.skill=skill,this.id=`trick-${this.skill}`;const attributes=actor.abilities,{attribute}=["int","wis","cha"].map(attribute2=>({attribute:attribute2,mod:attributes[attribute2].mod})).reduce((highest,next)=>next.mod>highest.mod?next:highest);this.attribute=attribute;const tradition=this.tradition=TrickMagicTradition[skill],domains=[`${attribute}-based`,"all","spell-attack-dc"],attackSelectors=[`${tradition}-spell-attack`,"spell-attack","spell-attack-roll","attack","attack-roll"],saveSelectors=[`${tradition}-spell-dc`,"spell-dc"],skillRank=actor.skills[skill].rank,trickRank=skillRank===4?2:skillRank===3?1:0,levelProficiencyBonus=trickRank===0&&!game.pf2e.settings.variants.pwol.enabled?createProficiencyModifier({actor,rank:0,domains,addLevel:!0}):null;this.statistic=new Statistic(actor,{slug:`trick-${tradition}`,label:CONFIG.PF2E.magicTraditions[tradition],attribute,rank:trickRank,modifiers:[levelProficiencyBonus,...extractModifiers(actor.synthetics,domains)].filter(e$1),domains,check:{type:"attack-roll",modifiers:extractModifiers(actor.synthetics,attackSelectors),domains:attackSelectors},dc:{modifiers:extractModifiers(actor.synthetics,saveSelectors),domains:saveSelectors}})}get name(){return game.i18n.localize("PF2E.TrickMagicItemPopup.Title")}get sort(){return 0}get category(){return"items"}get spells(){return null}get isFlexible(){return!1}get isFocusPool(){return!1}get isEphemeral(){return!0}canCast(){return!0}async cast(spell,options={}){const{rollMode,message}=options,castRank=spell.computeCastRank(spell.rank);message!==!1&&(spell=spell.loadVariant({entryId:this.id})??spell,await spell.toMessage(null,{rollMode,data:{castRank}}))}async getSheetData(){return{id:this.id,name:this.name,statistic:this.statistic.getChatData(),tradition:this.tradition,category:"items",hasCollection:!1,sort:0,groups:[],usesSpellProficiency:!1,prepList:null,isEphemeral:!0}}}const CANTRIP_DECK_UUID="Compendium.pf2e.equipment-srd.Item.tLa4bewBhyqzi6Ow";function isSpellConsumableUUID(itemId){return itemId===CANTRIP_DECK_UUID||Object.values(CONFIG.PF2E.spellcastingItems).some(c=>Object.values(c.compendiumUuids).includes(itemId))}__name(isSpellConsumableUUID,"isSpellConsumableUUID"),__name2(isSpellConsumableUUID,"isSpellConsumableUUID");async function createConsumableFromSpell(spell,{type:type2,rank=spell.baseRank,mystified=!1}){const data=objectHasKey(CONFIG.PF2E.spellcastingItems,type2)?CONFIG.PF2E.spellcastingItems[type2]:null,uuid=(data?.compendiumUuids??[])?.[rank]??(type2==="cantripDeck5"?CANTRIP_DECK_UUID:null),consumable=uuid?await fromUuid(uuid):null;if(!consumable?.isOfType("consumable"))throw ErrorPF2e("Failed to retrieve consumable item");const consumableSource={...consumable.toObject(),_id:null},traits=consumableSource.system.traits;traits.value=n([...traits.value,...spell.system.traits.value]),traits.rarity=spell.rarity,traits.value.includes("magical")&&traits.value.some(t2=>setHasElement(MAGIC_TRADITIONS,t2))&&traits.value.splice(traits.value.indexOf("magical"),1),traits.value.sort();const nameTemplate=type2==="cantripDeck5"?"PF2E.Item.Physical.FromSpell.CantripDeck5":data?.nameTemplate;consumableSource.name=nameTemplate?game.i18n.format(nameTemplate,{name:spell.name,level:rank}):`${type2} of ${spell.name} (Rank ${rank})`;const description=consumableSource.system.description.value;return consumableSource.system.description.value=(()=>{const paragraphElement=document.createElement("p");paragraphElement.append(spell.sourceId?`@UUID[${spell.sourceId}]{${spell.name}}`:spell.description);const containerElement=document.createElement("div"),hrElement=document.createElement("hr");return containerElement.append(paragraphElement,hrElement),hrElement.insertAdjacentHTML("afterend",description),containerElement.innerHTML})(),type2!=="cantripDeck5"&&(consumableSource.system.spell=foundry.utils.mergeObject(spell._source,{_id:foundry.utils.randomID(),system:{location:{value:null,heightenedLevel:rank}}},{inplace:!1})),mystified&&(consumableSource.system.identification.status="unidentified"),consumableSource}__name(createConsumableFromSpell,"createConsumableFromSpell"),__name2(createConsumableFromSpell,"createConsumableFromSpell");function calculateTrickMagicItemCheckDC(item,options={pwol:!1}){const level=Number(item.level),saveDC=calculateDC(level,options),traditions=item.system.spell?.system.traits.traditions??[],skills=[...item.system.traits.value,...traditions].filter(t2=>setHasElement(MAGIC_TRADITIONS,t2)).map(tradition=>[traditionSkills[tradition],saveDC]);return Object.fromEntries(skills)}__name(calculateTrickMagicItemCheckDC,"calculateTrickMagicItemCheckDC"),__name2(calculateTrickMagicItemCheckDC,"calculateTrickMagicItemCheckDC");const fields$17=foundry.data.fields;class RuleElement extends foundry.abstract.DataModel{static{__name(this,"RuleElement")}static{__name2(this,"RuleElement")}static autogenForms=!1;sourceIndex=null;suppressWarnings=!1;static validActorTypes=["army","character","familiar","hazard","npc","party","vehicle"];static defineSchema(){return{key:new fields$17.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),slug:new SlugField({required:!0,nullable:!0}),label:new fields$17.StringField({required:!1,nullable:!1,blank:!1,initial:void 0}),priority:new fields$17.NumberField({required:!0,nullable:!1,integer:!0,initial:100}),ignored:new fields$17.BooleanField({required:!0,nullable:!1,initial:!1}),predicate:new PredicateField,requiresEquipped:new NullableBooleanField({required:!1,nullable:!0,initial:null}),requiresInvestment:new NullableBooleanField({required:!1,nullable:!0,initial:null}),spinoff:new SlugField({required:!1,nullable:!1,initial:void 0})}}static get schema(){if(this._schema&&Object.hasOwn(this,"_schema"))return this._schema;const schema=new LaxSchemaField(Object.freeze(this.defineSchema()));return Object.defineProperty(this,"_schema",{value:schema,writable:!1}),schema}static LOCALIZATION_PREFIXES=["PF2E.RULES.Common"];constructor(source2,options){if(super(source2,{parent:options.parent,strict:options.strict??!0,fallback:!1}),this.invalid){this.ignored=!0;return}const item=this.parent;if(this.suppressWarnings=options.suppressWarnings??!item.actor.id,this.sourceIndex=options.sourceIndex??null,!tupleHasValue(this.constructor.validActorTypes,item.actor.type)){const actorType=game.i18n.localize(`TYPES.Actor.${item.actor.type}`);this.failValidation(`this rule element type cannot be applied to a ${actorType}`),source2.ignored=!0}this.label=this.label?game.i18n.format(this.resolveInjectedProperties(this.label),{actor:item.actor.name,item:item.name,origin:item.isOfType("effect")?item.origin?.name??null:null}):item.name,item.isOfType("physical")?(this.requiresEquipped??=!0,this.requiresInvestment=item.isInvested===null?null:!!(source2.requiresInvestment??this.requiresEquipped),this.ignored===!1&&(this.ignored=!!this.requiresEquipped&&!item.isEquipped||item.system.equipped.carryType==="dropped"||!!this.requiresInvestment&&!item.isInvested)):(this.requiresEquipped=null,this.requiresInvestment=null),this.spinoff&&(this.ignored=!0)}get item(){return this.parent}get actor(){return this.parent.actor}get token(){const actor=this.actor;if(actor.token)return actor.token;const tokens=actor.getActiveTokens();return tokens.find(token=>token.controlled)?.document??tokens.shift()?.document??null}getReducedLabel(label=this.label){return label===this.parent.name?reduceItemName(label):label}validate(options={}){try{return super.validate(options)}catch(error){if(error instanceof foundry.data.validation.DataModelValidationError){const message=error.message.replace(/validation errors|Joint Validation Error/,`validation errors on item ${this.item.name} (${this.item.uuid})`);return console.warn(message),!1}else throw error}}test(rollOptions){if(this.ignored)return!1;if(this.predicate.length===0)return!0;const optionSet=new Set([...rollOptions??this.actor.getRollOptions(),...this.item.getRollOptions("parent")]);return this.resolveInjectedProperties(this.predicate).test(optionSet)}failValidation(...message){const fullMessage=message.join(" "),{name:name2,uuid}=this.item;if(!this.suppressWarnings){const ruleName=game.i18n.localize(`PF2E.RuleElement.${this.key}`);console.warn(`PF2e System | ${ruleName} rules element on item ${name2} (${uuid}) failed to validate: ${fullMessage}`),this.validationFailures.joint??=new foundry.data.validation.DataModelValidationFailure({message:fullMessage,unresolved:!0})}this.ignored=!0}resolveInjectedProperties(source2,options={}){const{injectables={},warn=!0}=options;if(source2===null||typeof source2=="number"||typeof source2=="string"&&!source2.includes("{"))return source2;if(Array.isArray(source2))for(let i=0;i<source2.length;i++)source2[i]=this.resolveInjectedProperties(source2[i],options);else if(e$2(source2)){for(const[key,value]of Object.entries(source2))(typeof value=="string"||e$3(value))&&(source2[key]=this.resolveInjectedProperties(value,options));return source2}else if(typeof source2=="string"){const injectableKeys=["actor","item","rule",...Object.keys(injectables).filter(i=>/^[a-z][a-z]+$/g.test(i))],pattern=new RegExp(String.raw`{(${injectableKeys.join("|")})\|(.*?)}`,"g"),allInjectables={actor:this.actor,item:this.item,rule:this,...injectables};return source2.replace(pattern,(_match,key,prop2)=>{const data=allInjectables[key],value=(()=>{try{return foundry.utils.getProperty(data,prop2)}catch{return}})();return value===void 0&&(this.ignored=!0,warn&&this.failValidation(`Failed to resolve injected property "${prop2}" in "${source2}"`)),String(value)})}return source2}resolveValue(value,defaultValue=0,{evaluate=!0,resolvables={},warn=!0}={}){if(value??=defaultValue??null,typeof value=="number"||typeof value=="boolean"||value===null||(value=this.resolveInjectedProperties(value,{warn}),Array.isArray(value)))return value;if(e$2(value)){const merged=e$2(defaultValue)?foundry.utils.mergeObject(defaultValue,value,{inplace:!1}):value;return recursiveReplaceString(merged,s=>{const resolved=this.resolveValue(s,s);return typeof resolved=="number"?resolved:String(resolved)})}if(typeof value=="string"){const saferEval=__name2(formula=>{try{const unresolveds=formula.match(/@[a-z0-9.]+/gi)??[];if(unresolveds.length>0){const shouldWarn=warn&&!unresolveds.every(u=>u.startsWith("@target.")||u.startsWith("@actor.conditions."));return this.ignored=!0,shouldWarn&&this.failValidation(`unable to resolve formula, "${formula}"`),Number(defaultValue)}return Roll.safeEval(formula)}catch{return this.failValidation(`unable to evaluate formula, "${formula}"`),0}},"saferEval");this.actor.isOfType("character")&&(resolvables.armor=this.actor.wornArmor);const trimmed=value.trim();return(trimmed.includes("@")||/^-?\d+$/.test(trimmed))&&evaluate?saferEval(Roll.replaceFormulaData(trimmed,{...this.actor.getRollData(),item:this.item,...resolvables})):trimmed}return defaultValue}}const fields$16=foundry.data.fields;class ResolvableValueField extends fields$16.DataField{static{__name(this,"ResolvableValueField")}static{__name2(this,"ResolvableValueField")}_validateType(value){if(!["string","number","object","boolean"].includes(typeof value))return!1}_cast(value){return value}#coerceNumber(value){const trimmed=value.trim();return this.nullable&&trimmed===""?null:/^-?\d+(?:\.\d+)?$/.test(trimmed)?Number(trimmed):trimmed||0}_cleanType(value){if(value===null&&this.nullable||value===void 0&&!this.required||typeof value=="number"||typeof value=="boolean")return value;if(typeof value=="string")return this.#coerceNumber(value);if(e$2(value)&&"brackets"in value){value.field||="actor|level";const brackets=value.brackets=Object.values(value.brackets??{}).filter(e$1);for(const bracket of brackets)bracket.start===null&&delete bracket.start,bracket.end===null&&delete bracket.end,bracket.value=typeof bracket.value=="string"?this.#coerceNumber(bracket.value)??0:bracket.value}return e$3(value)?value:String(value)}_toInput(config){return foundry.applications.fields.createTextInput(config)}}const fields$15=foundry.data.fields;class ActorTraitsRuleElement extends RuleElement{static{__name(this,"ActorTraitsRuleElement")}static{__name2(this,"ActorTraitsRuleElement")}static validActorTypes=["character","npc","familiar","hazard","vehicle"];static defineSchema(){return{...super.defineSchema(),priority:new fields$15.NumberField({required:!0,nullable:!1,integer:!0,initial:51}),add:new fields$15.ArrayField(new fields$15.StringField({required:!0,nullable:!1,blank:!1})),remove:new fields$15.ArrayField(new fields$15.StringField({required:!0,nullable:!1,blank:!1}))}}get#traitsDictionary(){switch(this.actor.type){case"character":case"familiar":case"npc":return CONFIG.PF2E.creatureTraits;case"hazard":return CONFIG.PF2E.hazardTraits;case"vehicle":return CONFIG.PF2E.vehicleTraits;default:throw ErrorPF2e("unexpected actor type")}}onApplyActiveEffects(){if(this.test()&&this.actor.system.traits){const traits=this.actor.system.traits,newTraits=this.resolveInjectedProperties(this.add).filter(t2=>!traits.value.includes(t2)),traitsDictionary=this.#traitsDictionary;for(const trait of newTraits){if(!(trait in traitsDictionary))return this.failValidation(`${trait} is not a recognized trait`);traits.value.push(trait),this.actor.rollOptions.all[`self:trait:${trait}`]=!0,["construct","undead"].includes(trait)&&this.#handleModeAffectingTrait()}const toRemoves=this.resolveInjectedProperties(this.remove);for(const trait of toRemoves)traits.value=traits.value.filter(t2=>t2!==trait),delete this.actor.rollOptions.all[`self:trait:${trait}`],["construct","undead"].includes(trait)&&this.#handleModeAffectingTrait()}}#handleModeAffectingTrait(){const{actor}=this,{rollOptions}=actor;for(const mode of["construct","living","undead"])delete rollOptions.all[`self:mode:${mode}`];rollOptions.all[`self:mode:${actor.modeOfBeing}`]=!0}}const fields$14=foundry.data.fields;class AdjustDegreeOfSuccessRuleElement extends RuleElement{static{__name(this,"AdjustDegreeOfSuccessRuleElement")}static{__name2(this,"AdjustDegreeOfSuccessRuleElement")}static validActorTypes=["character","npc"];static defineSchema(){return{...super.defineSchema(),selector:new fields$14.StringField({required:!0,nullable:!1,blank:!1}),adjustment:new RecordField(new fields$14.StringField({required:!0,nullable:!1,choices:["all",...DEGREE_OF_SUCCESS_STRINGS]}),new fields$14.StringField({required:!0,nullable:!1,choices:degreeAdjustmentAmountString}),{required:!0,nullable:!1})}}beforePrepareData(){if(this.ignored)return;const selector=this.resolveInjectedProperties(this.selector),adjustments=this.adjustment,stringToAdjustment={"two-degrees-better":DEGREE_ADJUSTMENT_AMOUNTS.INCREASE_BY_TWO,"one-degree-better":DEGREE_ADJUSTMENT_AMOUNTS.INCREASE,"one-degree-worse":DEGREE_ADJUSTMENT_AMOUNTS.LOWER,"two-degrees-worse":DEGREE_ADJUSTMENT_AMOUNTS.LOWER_BY_TWO,"to-critical-failure":DEGREE_ADJUSTMENT_AMOUNTS.TO_CRITICAL_FAILURE,"to-failure":DEGREE_ADJUSTMENT_AMOUNTS.TO_FAILURE,"to-success":DEGREE_ADJUSTMENT_AMOUNTS.TO_SUCCESS,"to-critical-success":DEGREE_ADJUSTMENT_AMOUNTS.TO_CRITICAL_SUCCESS},record=["all",...DEGREE_OF_SUCCESS_STRINGS].reduce((accumulated,outcome)=>{const adjustment=adjustments[outcome];return adjustment&&(accumulated[outcome]={label:this.label,amount:stringToAdjustment[adjustment]}),accumulated},{});(this.actor.synthetics.degreeOfSuccessAdjustments[selector]??=[]).push({adjustments:record,predicate:this.resolveInjectedProperties(this.predicate)})}}const degreeAdjustmentAmountString=["one-degree-better","one-degree-worse","two-degrees-better","two-degrees-worse","to-critical-failure","to-failure","to-success","to-critical-success"],fields$13=foundry.data.fields;class AELikeRuleElement extends RuleElement{static{__name(this,"AELikeRuleElement")}static{__name2(this,"AELikeRuleElement")}static defineSchema(){const baseSchema=super.defineSchema(),PRIORITIES=this.CHANGE_MODE_DEFAULT_PRIORITIES;return baseSchema.priority.initial=d=>PRIORITIES[String(d.mode)]??50,{...baseSchema,testDomains:new fields$13.ArrayField(new fields$13.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),{required:!1,nullable:!1,initial:__name2(()=>[],"initial")}),mode:new fields$13.StringField({required:!0,choices:t$4(this.CHANGE_MODE_DEFAULT_PRIORITIES),initial:void 0}),path:new fields$13.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),phase:new fields$13.StringField({required:!1,nullable:!1,choices:foundry.utils.deepClone(this.PHASES),initial:"applyAEs"}),value:new ResolvableValueField({required:!0,nullable:!0,initial:void 0}),merge:new fields$13.BooleanField({required:!1,nullable:!1,initial:void 0})}}static CHANGE_MODE_DEFAULT_PRIORITIES={multiply:10,add:20,subtract:20,remove:20,downgrade:30,upgrade:40,override:50};static PHASES=["applyAEs","beforeDerived","afterDerived","beforeRoll"];static validateJoint(data){if(super.validateJoint(data),data.merge){if(data.mode!=="override")throw new foundry.data.validation.DataModelValidationError('mode must be "override" if merge is true');if(!e$2(data.value))throw new foundry.data.validation.DataModelValidationError("value must be an object if merge is true")}}#pathIsValid(path){const actor=this.item.actor;return!path.startsWith("data.")&&!/\bnull\b/.test(path)&&(path.startsWith("flags.")||[path,path.replace(/\.[-\w]+$/,""),path.replace(/\.?[-\w]+\.[-\w]+$/,"")].some(path2=>foundry.utils.getProperty(actor,path2)!==void 0))}async preCreate(){this.phase==="applyAEs"&&this.#applyAELike()}onApplyActiveEffects(){this.phase==="applyAEs"&&this.#applyAELike()}beforePrepareData(){this.phase==="beforeDerived"&&this.#applyAELike()}afterPrepareData(){this.phase==="afterDerived"&&this.#applyAELike()}beforeRoll(_domains,rollOptions){this.phase==="beforeRoll"&&this.#applyAELike(rollOptions)}#applyAELike(rollOptions){if(this.ignored)return;const path=this.resolveInjectedProperties(this.path);if(this.ignored)return;if(!this.#pathIsValid(path))return this.failValidation(`no data found at or near "${path}"`);if(rollOptions??=this.predicate.length>0?new Set(this.actor.getRollOptions(this.testDomains)):new Set,!this.test(rollOptions))return;const actor=this.actor,current=foundry.utils.getProperty(actor,path),change=this.resolveValue(this.value),newValue=AELikeRuleElement.getNewValue(this.mode,current,change,this.merge);if(newValue instanceof foundry.data.validation.DataModelValidationFailure)return this.failValidation(newValue.asError().message);if(this.mode==="add"&&Array.isArray(current))current.includes(newValue)||current.push(newValue);else if(["subtract","remove"].includes(this.mode)&&Array.isArray(current))current.splice(current.indexOf(newValue),1);else try{foundry.utils.setProperty(actor,path,newValue),this.#logChange(change)}catch(error){error instanceof Error?this.failValidation(error.message):console.warn(error)}}static getNewValue(mode,current,change,merge=!1){const{DataModelValidationFailure}=foundry.data.validation,addOrSubtract=__name2(value=>{const isNumericAdd=typeof value=="number"&&(typeof current=="number"||current===void 0||current===null),isArrayAdd=Array.isArray(current)&&current.every(e2=>typeof e2==typeof value);return isNumericAdd?(current??0)+value:isArrayAdd?value:new DataModelValidationFailure({invalidValue:value,fallback:!1})},"addOrSubtract");switch(mode){case"multiply":return typeof change!="number"?new DataModelValidationFailure({invalidValue:change,fallback:!1}):typeof current=="number"||current===void 0?Math.trunc((current??0)*change):new DataModelValidationFailure({invalidValue:current,fallback:!1});case"add":return addOrSubtract(change);case"subtract":case"remove":{const addedChange=(typeof current=="number"||current===void 0)&&typeof change=="number"?-1*change:change;return addOrSubtract(addedChange)}case"downgrade":return typeof change!="number"?new DataModelValidationFailure({invalidValue:change,fallback:!1}):typeof current=="number"||current===void 0?Math.min(current??0,change):new DataModelValidationFailure({invalidValue:current,fallback:!1});case"upgrade":return typeof change!="number"?new DataModelValidationFailure({invalidValue:change,fallback:!1}):typeof current=="number"||current===void 0?Math.max(current??0,change):new DataModelValidationFailure({invalidValue:current,fallback:!1});case"override":{const isOverridable=e(current)||typeof current==typeof change||["number","boolean"].includes(typeof current)&&["number","boolean"].includes(typeof change);return merge&&e$3(current)&&e$3(change)?foundry.utils.mergeObject(current,change):isOverridable?change:new DataModelValidationFailure({invalidValue:change,message:`${change} cannot override ${current}`,fallback:!1})}default:return null}}#logChange(value){const{item,mode}=this;if(!(typeof value=="boolean"||typeof value=="number"||typeof value=="string"||value===null))return;const level=item.isOfType("feat")?Number(/-(\d+)$/.exec(item.system.location??"")?.[1])||item.level:"level"in item&&typeof item.level=="number"?item.level:null,{autoChanges}=this.actor.system;(autoChanges[this.path]??=[]).push({mode,level,value,source:this.item.name})}}const fields$12=foundry.data.fields;class AdjustModifierRuleElement extends RuleElement{static{__name(this,"AdjustModifierRuleElement")}static{__name2(this,"AdjustModifierRuleElement")}constructor(source2,options){source2.suppress&&(source2.mode="override"),super(source2,options),typeof source2.selector=="string"&&this.selectors.length===0&&(this.selectors=[source2.selector]),this.suppress??=!1,this.maxApplications??=1/0}static defineSchema(){const baseSchema=super.defineSchema(),PRIORITIES=AELikeRuleElement.CHANGE_MODE_DEFAULT_PRIORITIES;return baseSchema.priority.initial=d=>PRIORITIES[String(d.mode)]??50,{...baseSchema,mode:new fields$12.StringField({required:!0,choices:t$4(AELikeRuleElement.CHANGE_MODE_DEFAULT_PRIORITIES),initial:void 0}),selector:new fields$12.StringField({required:!1,blank:!1,initial:void 0}),selectors:new StrictArrayField(new fields$12.StringField({required:!0,blank:!1})),relabel:new fields$12.StringField({required:!1,nullable:!0,blank:!1,initial:null}),damageType:new fields$12.StringField({required:!1,nullable:!0,blank:!1,initial:null}),suppress:new fields$12.BooleanField({required:!1,nullable:!1,initial:!1}),maxApplications:new fields$12.NumberField({required:!1,nullable:!0,initial:null}),value:new ResolvableValueField({required:!1,nullable:!0,initial:null})}}static validateJoint(data){super.validateJoint(data);const{DataModelValidationError}=foundry.data.validation;if(data.suppress===!0){if(typeof data.maxApplications=="number")throw new DataModelValidationError("  use of `maxApplications` in combination with `suppress` is not currently supported")}else if(data.value===null&&!data.damageType)throw new DataModelValidationError("  value: must be provided unless damageType is provided or suppress is true")}beforePrepareData(){if(this.ignored)return;let predicate=null;const adjustment={slug:this.slug,test:__name2(options=>(predicate??=new Predicate(this.resolveInjectedProperties(foundry.utils.deepClone([...this.predicate]))),predicate.test([...options,...this.item.getRollOptions("parent")])),"test"),suppress:this.suppress,getNewValue:__name2(current=>{if(adjustment.applications??=0,this.value===null)return current;const change=this.resolveValue(this.value);return typeof change!="number"||Number.isNaN(change)?(this.failValidation("value: must resolve to a number"),current):this.ignored||adjustment.applications>=this.maxApplications?current:(adjustment.applications+=1,Math.trunc(AELikeRuleElement.getNewValue(this.mode,current,change)))},"getNewValue"),getDamageType:__name2(current=>{if(!this.damageType)return current;const damageType=this.resolveInjectedProperties(this.damageType);return objectHasKey(CONFIG.PF2E.damageTypes,damageType)?damageType:(this.failValidation(`${damageType} is an unrecognized damage type.`),current)},"getDamageType")};this.relabel&&(adjustment.relabel=this.getReducedLabel(this.resolveInjectedProperties(this.relabel)));for(const selector of this.selectors.map(s=>this.resolveInjectedProperties(s))){if(selector==="null")continue;(this.actor.synthetics.modifierAdjustments[selector]??=[]).push(adjustment)}}}const fields$11=foundry.data.fields;class AdjustStrikeRuleElement extends RuleElement{static{__name(this,"AdjustStrikeRuleElement")}static{__name2(this,"AdjustStrikeRuleElement")}static validActorTypes=["character","familiar","npc"];constructor(data,options){super({...data,priority:110},options)}static VALID_PROPERTIES=new Set(["materials","property-runes","range-increment","traits","weapon-traits"]);static defineSchema(){return{...super.defineSchema(),mode:new fields$11.StringField({required:!0,choices:t$4(AELikeRuleElement.CHANGE_MODE_DEFAULT_PRIORITIES),initial:void 0}),property:new fields$11.StringField({required:!0,choices:Array.from(this.VALID_PROPERTIES),initial:void 0}),definition:new PredicateField,value:new ResolvableValueField({required:!0,nullable:!1,initial:void 0})}}beforePrepareData(){if(!this.test())return;const change=this.resolveValue(this.value),adjustment=(()=>{if(!this.property)throw ErrorPF2e("Unexpected error applying adjustment");const definition=this.resolveInjectedProperties(this.definition);switch(this.property){case"materials":return{adjustDamageRoll:__name2((weapon,{materials})=>{if(!["add","subtract","remove"].includes(this.mode))return this.failValidation('A strike adjustment of material effects must be used with the "add", "subtract", or "remove" mode.');if(!definition.test(weapon.getRollOptions("item")))return;if(!objectHasKey(CONFIG.PF2E.materialDamageEffects,change))return this.failValidation(`"${change}" is not a supported weapon material effect.`);const method=this.mode==="add"?"add":"delete";materials?.[method](change)},"adjustDamageRoll")};case"range-increment":return{adjustWeapon:__name2(weapon=>{if(weapon.isOfType("melee"))return;if(typeof change!="number")return this.failValidation("Change value is not a number.");if(!definition.test(weapon.getRollOptions("item")))return;const rangeIncrement=weapon.range?.increment;if(typeof rangeIncrement!="number")return this.failValidation("A weapon that meets the definition lacks a range increment.");const newRangeIncrement=AELikeRuleElement.getNewValue(this.mode,rangeIncrement,change);weapon.system.range=newRangeIncrement},"adjustWeapon")};case"traits":return{adjustTraits:__name2((weapon,traits)=>{if(!["add","subtract","remove"].includes(this.mode))return this.failValidation('A strike adjustment of traits must be used with the "add", "subtract", or "remove" mode.');if(!objectHasKey(CONFIG.PF2E.actionTraits,change))return this.failValidation(`"${change}" is not a recognized action trait.`);definition.test(weapon.getRollOptions("item"))&&(this.mode==="add"&&!traits.includes(change)?traits.push(change):["subtract","remove"].includes(this.mode)&&traits.includes(change)&&traits.splice(traits.indexOf(change),1))},"adjustTraits")};case"weapon-traits":return{adjustWeapon:__name2(weapon=>{if(!["add","subtract","remove"].includes(this.mode))return this.failValidation('A strike adjustment of weapon traits must be used with the "add", "subtract", or "remove" mode.');if(!objectHasKey(CONFIG.PF2E.weaponTraits,change)&&!(weapon.isOfType("melee")&&objectHasKey(CONFIG.PF2E.npcAttackTraits,change)))return this.failValidation(`"${change}" is not a recognized weapon trait.`);if(!definition.test(weapon.getRollOptions("item"))||weapon.slug==="basic-unarmed"&&/^(?:modular|versatile)/.test(change))return;const traits=weapon.system.traits,damageType=weapon.isOfType("weapon")?weapon.system.damage.damageType.at(0):null;this.mode==="add"&&[`modular-${damageType}`,`versatile-${damageType}`].includes(change)||(this.mode==="add"?addOrUpgradeTrait(traits,change):removeTrait(traits,change))},"adjustWeapon")};case"property-runes":return{adjustWeapon:__name2(weapon=>{if(!["add","subtract","remove"].includes(this.mode))return this.failValidation('A strike adjustment of weapon property runes must be used with the "add", "subtract", or "remove" mode.');const runeSlug=sluggify(String(change),{camel:"dromedary"});if(!objectHasKey(RUNE_DATA.weapon.property,runeSlug))return this.failValidation(`"${change}" is not a recognized weapon property rune.`);if(!definition.test(weapon.getRollOptions("item")))return;const propertyRunes=weapon.system.runes.property;this.mode==="add"?propertyRunes.push(runeSlug):propertyRunes.includes(runeSlug)&&propertyRunes.splice(propertyRunes.indexOf(runeSlug),1),weapon.system.runes.property=prunePropertyRunes(propertyRunes,RUNE_DATA.weapon.property),weapon.isOfType("weapon")&&(weapon.name=game.pf2e.system.generateItemName(weapon))},"adjustWeapon")}}})();this.actor.synthetics.strikeAdjustments.push(adjustment)}}const validation$1=foundry.data.validation,itemHasCounterBadge=__name2(item=>{if(!(itemIsOfType(item,"condition")?typeof item.system.value.value=="number":itemIsOfType(item,"effect")?item.system.badge?.type==="counter":!1))return new validation$1.DataModelValidationFailure({message:"effect lacks a badge"})},"itemHasCounterBadge");function adjustCreatureShieldData(item){if("actor"in item&&item.actor?.isOfType("character","npc")&&item.isOfType("shield")){const heldShield=item.actor.heldShield;if(item===heldShield){const shieldData=item.actor.attributes.shield;shieldData.ac=item.system.acBonus,shieldData.hardness=item.system.hardness,shieldData.hp.max=item.system.hp.max,shieldData.brokenThreshold=Math.floor(item.system.hp.max/2)}}}__name(adjustCreatureShieldData,"adjustCreatureShieldData"),__name2(adjustCreatureShieldData,"adjustCreatureShieldData");function getNewInterval(mode,current,newValue){if(!objectHasKey(CONFIG.PF2E.frequencies,newValue))return new validation$1.DataModelValidationFailure({invalidValue:current,fallback:!1});if(mode==="override")return newValue;function getDuration(key){return key==="turn"||key==="round"?Duration.fromISO("PT6S"):key==="day"?Duration.fromISO("PT24H"):Duration.fromISO(key)}__name(getDuration,"getDuration"),__name2(getDuration,"getDuration");const newIsLonger=newValue==="round"&&current==="turn"||newValue==="PT24H"&&current==="day"||getDuration(newValue)>getDuration(current);return mode==="upgrade"&&newIsLonger||mode==="downgrade"&&!newIsLonger?newValue:current}__name(getNewInterval,"getNewInterval"),__name2(getNewInterval,"getNewInterval");const fields$10=foundry.data.fields,validation=foundry.data.validation;class ItemAlterationHandler extends fields$10.SchemaField{static{__name(this,"ItemAlterationHandler")}static{__name2(this,"ItemAlterationHandler")}#validateForItem;operableOnInstances;operableOnSource;handle;constructor(options){super(options.fields,n$1(options,["fields"])),options.validateForItem&&(this.#validateForItem=options.validateForItem),this.handle=options.handle.bind(this),this.operableOnInstances=options.operableOnInstances??!0,this.operableOnSource=options.operableOnSource??!0}isValid(data){const alteration=data.alteration=foundry.utils.mergeObject(this.getInitialValue(),data.alteration),failure=this.validate(alteration);if(failure)throw new validation.DataModelValidationError(failure);const item=data.item;if(item.type!==alteration.itemType)return!1;const forItemFailure=this.#validateForItem?.(item,alteration);if(forItemFailure)throw new validation.DataModelValidationError(forItemFailure);if(!this.operableOnInstances&&item instanceof foundry.abstract.Document)throw new validation.DataModelValidationError("may only be applied to source data");if(!this.operableOnSource&&!(item instanceof foundry.abstract.Document))throw new validation.DataModelValidationError("may only be applied to existing items");return!0}}const ITEM_ALTERATION_HANDLERS={"ac-bonus":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["armor","shield"]}),mode:new fields$10.StringField({required:!0,choices:["add","downgrade","override","remove","subtract","upgrade"]}),value:new fields$10.NumberField({required:!0,nullable:!1,integer:!0,positive:!0,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data))return;const item=data.item,mode=data.alteration.mode,newValue=AELikeRuleElement.getNewValue(mode,item.system.acBonus,data.alteration.value),itemBonus=itemIsOfType(item,"armor")&&mode==="override"?item.system.runes.potency:0;item.system.acBonus=Math.max(newValue,0)+itemBonus,adjustCreatureShieldData(item)},"handle")}),"area-size":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["spell"]}),mode:new fields$10.StringField({required:!0,choices:["add","subtract","upgrade","downgrade","override"]}),value:new fields$10.NumberField({required:!0,nullable:!1,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data)||!data.item.system.area)return;const mode=data.alteration.mode,newValue=AELikeRuleElement.getNewValue(mode,data.item.system.area.value,data.alteration.value),nearestFive=Math.floor(newValue/5)*5;data.item.system.area.value=Math.max(nearestFive,5)},"handle")}),"badge-max":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["effect"]}),mode:new fields$10.StringField({required:!0,choices:["downgrade","override"]}),value:new fields$10.NumberField({required:!0,nullable:!1,integer:!0,positive:!0,initial:void 0})},validateForItem:itemHasCounterBadge,handle:__name2(function(data){if(!this.isValid(data))return;const badge=data.item.system.badge;if(badge?.type!=="counter"||typeof badge.value!="number"||typeof badge.max!="number")return;const mode=data.alteration.mode,newValue=AELikeRuleElement.getNewValue(mode,badge.max,data.alteration.value),hardMax=badge.labels?.length??newValue,min=badge.min??0;badge.max=Math.clamp(newValue,min,hardMax),badge.value=Math.clamp(badge.value,min,badge.max)||0},"handle")}),"badge-value":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["condition","effect"]}),mode:new fields$10.StringField({required:!0,choices:["add","downgrade","override","remove","subtract","upgrade"]}),value:new fields$10.NumberField({required:!0,integer:!0,nullable:!1,positive:!0,initial:void 0})},validateForItem:itemHasCounterBadge,handle:__name2(function(data){if(!this.isValid(data))return;const effect=data.item,badge=itemIsOfType(effect,"condition")?effect.system.value:effect.system.badge??{value:0};if(typeof badge.value!="number")return;const newValue=AELikeRuleElement.getNewValue(data.alteration.mode,badge.value,data.alteration.value),max="max"in badge?badge.max??1/0:1/0,min="min"in badge?badge.min??0:0;badge.value=Math.clamp(newValue,min,max)||0},"handle")}),bulk:new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:Array.from(PHYSICAL_ITEM_TYPES)}),mode:new fields$10.StringField({required:!0,choices:["override"]}),value:new StrictNumberField({required:!0,nullable:!1,choices:[0,.1,...Array.fromRange(100,1)],initial:void 0})},handle:__name2(function(data){data.alteration.value=Number(data.alteration.value)||0,this.isValid(data)&&(data.item.system.bulk.value=data.alteration.value,data.item instanceof ItemPF2e&&(data.item.system.bulk=prepareBulkData(data.item)))},"handle")}),category:new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["armor"]}),mode:new fields$10.StringField({required:!0,choices:["override"]}),value:new fields$10.StringField({required:!0,nullable:!1,choices:["light","heavy","medium"],initial:void 0})},handle:__name2(function(data){this.isValid(data)&&(data.item.system.category=data.alteration.value)},"handle")}),"check-penalty":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:__name2(()=>["armor"],"choices")}),mode:new fields$10.StringField({required:!0,choices:__name2(()=>["add","downgrade","override","remove","subtract","upgrade"],"choices")}),value:new StrictNumberField({required:!0,nullable:!1,integer:!0,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data))return;const newValue=AELikeRuleElement.getNewValue(data.alteration.mode,data.item.system.checkPenalty,data.alteration.value);data.item.system.checkPenalty=Math.min(newValue,0)},"handle")}),"damage-dice-faces":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["weapon"]}),mode:new fields$10.StringField({required:!0,choices:["downgrade","override","upgrade"]}),value:new StrictNumberField({required:!0,nullable:!0,choices:__name2(()=>DAMAGE_DICE_FACES,"choices"),initial:null})},validate:__name2(data=>{if(!(e$2(data)&&"mode"in data&&"value"in data))return!1;const validFaces=DAMAGE_DICE_FACES,valueIsFaceNumber=typeof data.value=="number"&&validFaces.includes(data.value);if(data.mode==="override"&&!valueIsFaceNumber)throw new validation.DataModelValidationError(new validation.DataModelValidationFailure({message:'value: must be 4, 6, 8, 10, or 12 if mode is "override"'}));if(tupleHasValue(["upgrade","downgrade"],data.mode)&&data.value!==null)throw new validation.DataModelValidationError(new validation.DataModelValidationFailure({message:`value: must be null or omitted if mode is "${data.mode}"`}));return!0},"validate"),handle:__name2(function(data){if(!this.isValid(data)||!(data.item instanceof ItemPF2e))return;const item=data.item,mode=data.alteration.mode;item.system.damage.die&&(mode==="upgrade"&&!item.flags.pf2e.damageFacesUpgraded?(item.system.damage.die=nextDamageDieSize({upgrade:item.system.damage.die}),item.flags.pf2e.damageFacesUpgraded=!0):mode==="downgrade"?item.system.damage.die=nextDamageDieSize({downgrade:item.system.damage.die}):mode==="override"&&typeof data.alteration.value=="number"&&(data.alteration.value>Number(item.system.damage.die.replace("d",""))&&(item.flags.pf2e.damageFacesUpgraded=!0),item.system.damage.die=`d${data.alteration.value}`))},"handle")}),"damage-dice-number":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["weapon"]}),mode:new fields$10.StringField({required:!0,choices:["add","downgrade","override","remove","subtract","upgrade"]}),value:new fields$10.NumberField({required:!0,nullable:!1,integer:!0,positive:!0,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data))return;const item=data.item;if(!item.system.damage.dice)return;const newValue=AELikeRuleElement.getNewValue(data.alteration.mode,item.system.damage.dice,data.alteration.value);item.system.damage.dice=newValue},"handle")}),"damage-type":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["weapon"]}),mode:new fields$10.StringField({required:!0,choices:["override"]}),value:new fields$10.StringField({required:!0,nullable:!1,choices:__name2(()=>CONFIG.PF2E.damageTypes,"choices")})},handle:__name2(function(data){this.isValid(data)&&(data.item.system.damage.damageType=data.alteration.value)},"handle")}),"defense-passive":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["spell"]}),mode:new fields$10.StringField({required:!0,choices:["override"]}),value:new fields$10.StringField({required:!0,nullable:!1,choices:["ac","fortitude-dc","reflex-dc","will-dc"]})},handle:__name2(function(data){this.isValid(data)&&data.item instanceof ItemPF2e&&data.item.system.defense?.passive&&(data.item.system.defense.passive.statistic=data.alteration.value)},"handle")}),description:new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,nullable:!1,choices:__name2(()=>t$4(CONFIG.PF2E.Item.documentClasses),"choices"),initial:void 0}),mode:new fields$10.StringField({required:!0,choices:["add","override"]}),value:new fields$10.ArrayField(new fields$10.SchemaField({title:new fields$10.StringField({required:!1,nullable:!0,blank:!1,initial:null}),text:new fields$10.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),divider:new fields$10.BooleanField({required:!1}),predicate:new PredicateField({required:!1,initial:__name2(()=>[],"initial")})}),{required:!0,nullable:!1,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data)||!(data.item instanceof ItemPF2e))return;const contents=this.initialize(this.clean(data.alteration)).value;data.alteration.mode==="override"?data.item.system.description.override=contents:data.item.system.description.addenda.push({label:data.rule.label,contents})},"handle")}),"dex-cap":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["armor"]}),mode:new fields$10.StringField({required:!0,choices:["add","downgrade","override","remove","subtract","upgrade"]}),value:new StrictNumberField({required:!0,nullable:!1,integer:!0,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data))return;const mode=data.alteration.mode,newValue=AELikeRuleElement.getNewValue(mode,data.item.system.dexCap,data.alteration.value);data.item.system.dexCap=Math.max(newValue,0)},"handle")}),"focus-point-cost":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["spell"]}),mode:new fields$10.StringField({required:!0,choices:["add","override","upgrade"]}),value:new StrictNumberField({required:!0,nullable:!1,integer:!0,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data)||!(data.item instanceof ItemPF2e)||data.item.isRitual)return;const newValue=AELikeRuleElement.getNewValue(data.alteration.mode,data.item.system.cast.focusPoints,data.alteration.value);data.item.system.cast.focusPoints=Math.clamp(newValue,0,3)||0},"handle")}),grade:new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["armor","weapon","shield"]}),mode:new fields$10.StringField({required:!0,choices:["override","upgrade"]}),value:new fields$10.StringField({required:!0,nullable:!1,choices:__name2(()=>CONFIG.PF2E.grades,"choices")})},handle:__name2(function(data){if(game.pf2e.variantRules.AutomaticBonusProgression.isEnabled(data.rule.actor)&&data.fromEquipment||!this.isValid(data))return;const item=data.item,previousGrade=item.system.grade;if(!previousGrade)return;const mode=data.alteration.mode,isGradeBetter=CONFIG.PF2E.weaponImprovements[data.alteration.value].level>CONFIG.PF2E.weaponImprovements[previousGrade].level;if(!(mode==="upgrade"&&!isGradeBetter)&&(item.system.grade=data.alteration.value,item instanceof ItemPF2e)){if(item.isOfType("weapon")){const{tracking,dice}=CONFIG.PF2E.weaponImprovements[data.alteration.value];tracking&&addOrUpgradeTrait(item.system.traits,`tracking-${tracking}`,{mode}),item.system.damage.dice=dice}else if(item.isOfType("armor")){const{bonus:previousBonus}=CONFIG.PF2E.armorImprovements[previousGrade],{bonus,resilient}=CONFIG.PF2E.armorImprovements[data.alteration.value];resilient&&addOrUpgradeTrait(item.system.traits,`resilient-${resilient}`,{mode}),item.system.acBonus=Math.max(0,item.system.acBonus+bonus-previousBonus)}else if(item.isOfType("shield")){const{hardness:prevHardness,maxHP:prevMaxHP}=CONFIG.PF2E.shieldImprovements[previousGrade],{hardness,maxHP}=CONFIG.PF2E.shieldImprovements[data.alteration.value];item.system.hardness=Math.max(0,item.system.hardness+hardness-prevHardness),item.system.hp.max=Math.max(1,item.system.hp.max+maxHP-prevMaxHP),item.system.hp.brokenThreshold=Math.floor(item.system.hp.max/2),adjustCreatureShieldData(item)}data.item.name=game.pf2e.system.generateItemName(item)}},"handle")}),group:new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["armor","weapon"]}),mode:new fields$10.StringField({required:!0,choices:["override"]}),value:new fields$10.StringField({required:!0,nullable:!1,initial:void 0})},validateForItem:__name2((item,alteration)=>{const group=alteration.value;if(item.type==="armor"){if(group!==null&&!objectHasKey(CONFIG.PF2E.armorGroups,group))return new validation.DataModelValidationFailure({message:`${group} is not a valid armor group`})}else if(item.type==="weapon"){if(group!==null&&!objectHasKey(CONFIG.PF2E.weaponGroups,group))return new validation.DataModelValidationFailure({message:`${group} is not a valid weapon group`});const weapon=item,hasRangedOnlyTraits=["combination","thrown"].some(trait=>weapon.traits.has(trait))||weapon.traits.some(trait=>/^volley-\d+$/.test(trait)),hasMeleeOnlyTraits=weapon.traits.some(trait=>/^thrown-\d+$/.test(trait)),alterIsMandatoryRanged=setHasElement(MANDATORY_RANGED_GROUPS,group)||hasRangedOnlyTraits,originalIsMandatoryRanged=setHasElement(MANDATORY_RANGED_GROUPS,weapon.system.group)||hasRangedOnlyTraits;if((!alterIsMandatoryRanged&&hasMeleeOnlyTraits)!==(!originalIsMandatoryRanged&&hasMeleeOnlyTraits))return new validation.DataModelValidationFailure({message:`Cannot alter ${weapon.system.group} into ${group} because of melee only traits.`});if(alterIsMandatoryRanged!==originalIsMandatoryRanged)return new validation.DataModelValidationFailure({message:`Cannot alter ${weapon.system.group} into ${group} because one is ranged only.`})}},"validateForItem"),handle:__name2(function(data){if(this.isValid(data)){const system2=data.item.system;system2.group=data.alteration.value}},"handle")}),hardness:new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:Array.from(PHYSICAL_ITEM_TYPES)}),mode:new fields$10.StringField({required:!0,choices:["add","downgrade","multiply","override","remove","subtract","upgrade"]}),value:new fields$10.NumberField({required:!0,nullable:!1,min:-100,max:100})},handle:__name2(function(data){if(this.isValid(data)){const system2=data.item.system,value=data.alteration.value,newValue=AELikeRuleElement.getNewValue(data.alteration.mode,system2.hardness,value);system2.hardness=Math.max(Math.trunc(newValue),0),adjustCreatureShieldData(data.item)}},"handle")}),"hp-max":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:Array.from(PHYSICAL_ITEM_TYPES)}),mode:new fields$10.StringField({required:!0,choices:["add","downgrade","multiply","override","remove","subtract","upgrade"]}),value:new fields$10.NumberField({required:!0,nullable:!1,positive:!0,initial:void 0})},handle:__name2(function(data){if(this.isValid(data)){const hp=data.item.system.hp,value=data.alteration.value,newValue=AELikeRuleElement.getNewValue(data.alteration.mode,hp.max,value);hp.max=Math.max(Math.trunc(newValue),1),"brokenThreshold"in hp&&(hp.brokenThreshold=Math.floor(hp.max/2)),adjustCreatureShieldData(data.item)}},"handle")}),"material-type":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:Array.from(PHYSICAL_ITEM_TYPES)}),mode:new fields$10.StringField({required:!0,choices:["override"]}),value:new fields$10.StringField({required:!0,nullable:!1,choices:Array.from(PRECIOUS_MATERIAL_TYPES),initial:void 0})},handle:__name2(function(data){this.isValid(data)&&(data.item.system.material.type=data.alteration.value,data.item.system.material.grade="standard","_source"in data.item&&(data.item.name=game.pf2e.system.generateItemName(data.item)))},"handle")}),"pd-recovery-dc":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["condition"]}),mode:new fields$10.StringField({required:!0,choices:["add","downgrade","override","remove","subtract","upgrade"]}),value:new fields$10.NumberField({required:!0,integer:!0,nullable:!1,positive:!0,initial:void 0})},validateForItem(item){if(item.system.slug!=="persistent-damage")return new validation.DataModelValidationFailure({message:"item must be a persistent damage condition"})},handle:__name2(function(data){if(this.isValid(data)&&data.item.system.persistent){const persistent=data.item.system.persistent,mode=data.alteration.mode,newValue=AELikeRuleElement.getNewValue(mode,persistent.dc,data.alteration.value);persistent.dc=Math.max(newValue,0)}},"handle")}),"persistent-damage":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["condition"]}),mode:new fields$10.StringField({required:!0,choices:["override"]}),value:new fields$10.SchemaField({formula:new fields$10.StringField({required:!0,blank:!1,validate:__name2(value=>DamageRoll.validate(String(value)),"validate")}),damageType:new fields$10.StringField({required:!0,choices:__name2(()=>CONFIG.PF2E.damageTypes,"choices")}),dc:new fields$10.NumberField({required:!0,integer:!0,positive:!0,nullable:!1,initial:15}),criticalHit:new fields$10.BooleanField({required:!0,nullable:!1,initial:!1})},{nullable:!1})},validateForItem(item){if(item.system.slug!=="persistent-damage")return new validation.DataModelValidationFailure({message:"item must be a persistent damage condition"})},handle:__name2(function(data){const pdObject=e$2(data.alteration.value)?data.alteration.value:{dc:NaN},dc=Math.trunc(Math.abs(Number(pdObject?.dc)||15));data.alteration.value={...pdObject,dc},data.alteration=this.clean(data.alteration),this.isValid(data)&&(data.item.system.persistent=this.initialize(data.alteration).value)},"handle")}),rarity:new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:Array.from(PHYSICAL_ITEM_TYPES)}),mode:new fields$10.StringField({required:!0,choices:["override"]}),value:new fields$10.StringField({required:!0,nullable:!1,choices:RARITIES})},handle:__name2(function(data){this.isValid(data)&&(data.item.system.traits.rarity=data.alteration.value)},"handle")}),"range-increment":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["weapon"]}),mode:new fields$10.StringField({required:!0,choices:["add","multiply","override","remove","subtract"]}),value:new fields$10.NumberField({required:!0,nullable:!1,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data)||!data.item.system.range)return;const rangeIncrement=data.item.system.range,newValue=AELikeRuleElement.getNewValue(data.alteration.mode,rangeIncrement,data.alteration.value);data.item.system.range=newValue},"handle")}),"range-max":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["weapon"]}),mode:new fields$10.StringField({required:!0,choices:["add","multiply","override","remove","subtract"]}),value:new fields$10.NumberField({required:!0,nullable:!1,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data)||!data.item.system.maxRange)return;const maxRange=data.item.system.maxRange,newValue=AELikeRuleElement.getNewValue(data.alteration.mode,maxRange,data.alteration.value);data.item.system.maxRange=newValue},"handle")}),"frequency-max":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["action","feat"]}),mode:new fields$10.StringField({required:!0,choices:["add","downgrade","multiply","override","remove","subtract","upgrade"]}),value:new fields$10.NumberField({required:!0,integer:!0,nullable:!1,positive:!0})},handle:__name2(function(data){if(!this.isValid(data))return;data.item.system.frequency??={value:void 0,max:1,per:"day"};const frequency=data.item.system.frequency,mode=data.alteration.mode,newValue=AELikeRuleElement.getNewValue(mode,frequency.max,data.alteration.value);frequency.max=newValue,frequency.value=Math.clamp(frequency.value??newValue,0,newValue)},"handle")}),"frequency-per":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["action","feat"]}),mode:new fields$10.StringField({required:!0,choices:["downgrade","override","upgrade"]}),value:new fields$10.StringField({required:!0,nullable:!1,choices:__name2(()=>Object.keys(CONFIG.PF2E.frequencies),"choices"),initial:void 0})},handle:__name2(function(data){if(!this.isValid(data))return;data.item.system.frequency??={value:void 0,max:1,per:"day"};const mode=data.alteration.mode,newValue=getNewInterval(mode,data.item.system.frequency.per,data.alteration.value);if(newValue instanceof validation.DataModelValidationFailure)throw newValue.asError();data.item.system.frequency.per=newValue},"handle")}),"other-tags":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:__name2(()=>t$4(CONFIG.PF2E.Item.documentClasses),"choices")}),mode:new fields$10.StringField({required:!0,choices:["add","subtract","remove"]}),value:new SlugField({required:!0,nullable:!1,blank:!1,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data))return;const otherTags=data.item.system.traits.otherTags,newValue=AELikeRuleElement.getNewValue(data.alteration.mode,otherTags,data.alteration.value);if(newValue instanceof validation.DataModelValidationFailure)throw newValue.asError();data.alteration.mode==="add"?otherTags.includes(newValue)||otherTags.push(newValue):["subtract","remove"].includes(data.alteration.mode)&&otherTags.splice(otherTags.indexOf(newValue),1)},"handle")}),name:new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0}),mode:new fields$10.StringField({required:!0,choices:["override"]}),value:new fields$10.StringField({required:!0,nullable:!1,blank:!1})},handle:__name2(function(data){this.isValid(data)&&(data.item.name=game.i18n.localize(data.alteration.value))},"handle")}),"runes-potency":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["weapon","armor"]}),mode:new fields$10.StringField({required:!0,choices:["upgrade","override"]}),value:new fields$10.NumberField({required:!0,nullable:!1,min:0,max:4,integer:!0})},handle:__name2(function(data){if(game.pf2e.variantRules.AutomaticBonusProgression.isEnabled(data.rule.actor)&&data.fromEquipment||!this.isValid(data))return;const mode=data.alteration.mode,previousValue=data.item.system.runes.potency;data.item.system.runes.potency=Math.clamp(AELikeRuleElement.getNewValue(mode,data.item.system.runes.potency,data.alteration.value),0,4),data.item instanceof ItemPF2e&&data.item.system.runes.potency!==previousValue&&(!data.item.isMagical&&data.item.system.runes.potency>previousValue&&data.item.system.traits.value.push("magical"),data.item.isOfType("armor")&&data.item.isInvested!==!1&&(data.item.system.acBonus+=data.item.system.runes.potency-previousValue),data.item.name=game.pf2e.system.generateItemName(data.item))},"handle")}),"runes-resilient":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["armor"]}),mode:new fields$10.StringField({required:!0,choices:["upgrade","override"]}),value:new fields$10.NumberField({required:!0,nullable:!1,min:0,max:4,integer:!0})},handle:__name2(function(data){if(game.pf2e.variantRules.AutomaticBonusProgression.isEnabled(data.rule.actor)&&data.fromEquipment||!this.isValid(data))return;const previousValue=data.item.system.runes.resilient;data.item.system.runes.resilient=Math.clamp(AELikeRuleElement.getNewValue(data.alteration.mode,previousValue,data.alteration.value),0,4),data.item instanceof ItemPF2e&&data.item.system.runes.resilient!==previousValue&&(data.item.name=game.pf2e.system.generateItemName(data.item))},"handle")}),"runes-striking":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["weapon"]}),mode:new fields$10.StringField({required:!0,choices:["upgrade","override"]}),value:new fields$10.NumberField({required:!0,nullable:!1,min:0,max:4,integer:!0})},handle:__name2(function(data){if(game.pf2e.variantRules.AutomaticBonusProgression.isEnabled(data.rule.actor)&&data.fromEquipment||!this.isValid(data))return;const previousValue=data.item.system.runes.striking;data.item.system.runes.striking=Math.clamp(AELikeRuleElement.getNewValue(data.alteration.mode,previousValue,data.alteration.value),0,4),data.item instanceof ItemPF2e&&data.item.system.runes.striking!==previousValue&&(data.item.system.damage.dice=1+data.item.system.runes.striking,data.item.name=game.pf2e.system.generateItemName(data.item))},"handle")}),"speed-penalty":new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["armor","shield"]}),mode:new fields$10.StringField({required:!0,choices:["add","downgrade","override","remove","subtract","upgrade"]}),value:new StrictNumberField({required:!0,nullable:!1,integer:!0,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data))return;const newValue=AELikeRuleElement.getNewValue(data.alteration.mode,data.item.system.speedPenalty,data.alteration.value);data.item.system.speedPenalty=Math.min(newValue,0)},"handle")}),strength:new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:["armor"]}),mode:new fields$10.StringField({required:!0,choices:["add","downgrade","override","remove","subtract","upgrade"]}),value:new StrictNumberField({required:!0,nullable:!1,integer:!0,positive:!0,initial:void 0})},handle:__name2(function(data){if(!this.isValid(data)||data.item.system.strength===null)return;const newValue=AELikeRuleElement.getNewValue(data.alteration.mode,data.item.system.strength,data.alteration.value);data.item.system.strength=Math.max(newValue,-2)},"handle")}),traits:new ItemAlterationHandler({fields:{itemType:new fields$10.StringField({required:!0,choices:__name2(()=>Object.entries(CONFIG.PF2E.Item.documentClasses).filter(([,I])=>!e$4(I.validTraits)).map(([t2])=>t2),"choices")}),mode:new fields$10.StringField({required:!0,choices:["add","remove","subtract"]}),value:new DataUnionField([new fields$10.SchemaField({trait:new fields$10.StringField({required:!0,nullable:!1}),annotation:new ResolvableValueField({required:!0,nullable:!1})}),new StrictStringField({required:!0,nullable:!1,initial:void 0})],{required:!0,nullable:!1})},validateForItem:__name2((_item,alteration)=>{if(alteration.mode!=="add"&&typeof alteration.value=="object")return new validation.DataModelValidationFailure({message:`cannot be an object when mode is ${alteration.mode}`})},"validateForItem"),handle:__name2(function(data){if(!this.isValid(data))return;const resolvedTrait=e$2(data.alteration.value)?`${data.alteration.value.trait}-${data.rule.resolveValue(data.alteration.value.annotation)}`:data.alteration.value,validTraits=CONFIG.PF2E.Item.documentClasses[data.item.type].validTraits;if(!objectHasKey(validTraits,resolvedTrait))throw new validation.DataModelValidationError(`${resolvedTrait} is not a valid choice`);const newValue=AELikeRuleElement.getNewValue(data.alteration.mode,data.item.system.traits.value,resolvedTrait);if(newValue){if(newValue instanceof validation.DataModelValidationFailure)throw newValue.asError();data.item.system.traits.value&&(data.alteration.mode==="add"?addOrUpgradeTrait(data.item.system.traits,newValue):["subtract","remove"].includes(data.alteration.mode)&&removeTrait(data.item.system.traits,newValue))}},"handle")})},fields$$=foundry.data.fields;class ItemAlteration extends foundry.abstract.DataModel{static{__name(this,"ItemAlteration")}static{__name2(this,"ItemAlteration")}static defineSchema(){return{mode:new fields$$.StringField({required:!0,choices:["add","downgrade","multiply","override","remove","subtract","upgrade"],initial:void 0}),property:new fields$$.StringField({required:!0,initial:void 0,choices:t$4(ITEM_ALTERATION_HANDLERS)}),fromEquipment:new fields$$.BooleanField({required:!0,nullable:!1,initial:!0}),value:new ResolvableValueField}}get rule(){return this.parent}get actor(){return this.parent.actor}applyTo(item){const handler=ITEM_ALTERATION_HANDLERS[this.property],fallbackValue=handler.fields.value.getInitialValue();this.parent.ignored||handler.handle({item,rule:this.rule,fromEquipment:this.fromEquipment,alteration:{mode:this.mode,itemType:item.type,value:this.value=this.parent.resolveValue(this.value,fallbackValue)}})}}const fields$_=foundry.data.fields;class AuraRuleElement extends RuleElement{static{__name(this,"AuraRuleElement")}static{__name2(this,"AuraRuleElement")}constructor(source2,options){if(super(source2,options),!this.invalid){this.slug??=this.item.slug??sluggify(this.item.name);for(const effect of this.effects)effect.removeOnExit??=Array.isArray(effect.events)?effect.events.includes("enter"):!1}}static defineSchema(){const auraTraitField=new fields$_.StringField({required:!0,nullable:!1,initial:void 0,choices:CONFIG.PF2E.effectTraits}),effectSchemaField=new fields$_.SchemaField({uuid:new fields$_.DocumentUUIDField({required:!0,type:"Item",nullable:!1,initial:void 0}),affects:new fields$_.StringField({required:!0,nullable:!1,blank:!1,initial:"all",choices:["allies","enemies","all"],label:"PF2E.RuleEditor.Aura.Effects.Affects"}),events:new StrictArrayField(new fields$_.StringField({required:!0,blank:!1,nullable:!1,initial:void 0,choices:["enter","turn-start","turn-end"]}),{required:!0,nullable:!1,initial:["enter"],label:"PF2E.RuleEditor.Aura.Effects.Events"}),save:new fields$_.SchemaField({type:new fields$_.StringField({required:!0,nullable:!1,blank:!1,initial:void 0,choices:SAVE_TYPES,label:"PF2E.RuleEditor.Aura.Effects.Type"}),dc:new ResolvableValueField({required:!0,nullable:!1,initial:void 0,label:"PF2E.Check.DC.Unspecific"})},{required:!0,nullable:!0,initial:null,label:"PF2E.SavesHeader"}),predicate:new PredicateField,removeOnExit:new fields$_.BooleanField({required:!0,nullable:!1,initial:!0,label:"PF2E.RuleEditor.Aura.Effects.RemoveOnExit"}),includesSelf:new fields$_.BooleanField({required:!0,nullable:!1,initial:__name2(d=>d.affects!=="enemies","initial"),label:"PF2E.RuleEditor.Aura.Effects.IncludesSelf"}),alterations:new StrictArrayField(new fields$_.EmbeddedDataField(ItemAlteration))}),xyPairSchema=__name2(({integer})=>({x:new fields$_.NumberField({required:!0,integer,nullable:!1,initial:void 0,label:"PF2E.RuleEditor.Aura.Appearance.Translation.X"}),y:new fields$_.NumberField({required:!0,integer,nullable:!1,initial:void 0,label:"PF2E.RuleEditor.Aura.Appearance.Translation.Y"})}),"xyPairSchema"),appearanceSchema={border:new fields$_.SchemaField({color:new DataUnionField([new fields$_.StringField({required:!0,choices:["user-color"],initial:void 0}),new fields$_.ColorField({required:!0,nullable:!1,initial:void 0})],{required:!0,nullable:!1,initial:"#000000",label:"PF2E.RuleEditor.Aura.Appearance.Color"}),alpha:new fields$_.AlphaField({required:!0,nullable:!1,initial:.75,label:"PF2E.RuleEditor.General.Opacity"})},{required:!1,nullable:!0,initial:__name2(()=>({color:"#000000",alpha:.75}),"initial"),label:"PF2E.RuleEditor.Aura.Appearance.Border"}),highlight:new fields$_.SchemaField({color:new DataUnionField([new fields$_.StringField({required:!0,nullable:!1,choices:["user-color"],initial:void 0}),new fields$_.ColorField({required:!0,nullable:!1,initial:void 0})],{required:!0,nullable:!1,initial:"user-color",label:"PF2E.RuleEditor.Aura.Appearance.Color"}),alpha:new fields$_.AlphaField({required:!1,nullable:!1,initial:.25,label:"PF2E.RuleEditor.General.Opacity"})},{required:!1,nullable:!1,initial:__name2(()=>({color:"user-color",alpha:.25}),"initial"),label:"PF2E.RuleEditor.Aura.Appearance.Highlight"}),texture:new fields$_.SchemaField({src:new fields$_.StringField({required:!0,nullable:!1,initial:void 0,label:"TOKEN.FIELDS.texture.src.label"}),alpha:new fields$_.AlphaField({required:!0,nullable:!1,initial:1,label:"PF2E.RuleEditor.General.Opacity"}),scale:new fields$_.NumberField({required:!0,nullable:!1,positive:!0,initial:1,label:"Scale"}),translation:new fields$_.SchemaField(xyPairSchema({integer:!0}),{required:!1,nullable:!0,initial:null,label:"PF2E.RuleEditor.Aura.Appearance.Translation.Label",hint:"PF2E.RuleEditor.Aura.Appearance.Translation.Hint"}),loop:new fields$_.BooleanField({required:!0,nullable:!1,initial:!0,label:"PF2E.RuleEditor.Aura.Appearance.Loop.Label",hint:"PF2E.RuleEditor.Aura.Appearance.Loop.Hint"}),playbackRate:new fields$_.NumberField({required:!1,nullable:!1,positive:!0,max:4,initial:1,label:"PF2E.RuleEditor.Aura.Appearance.PlaybackRate.Label",hint:"PF2E.RuleEditor.Aura.Appearance.PlaybackRate.Hint"})},{required:!1,nullable:!0,initial:null,label:"PF2E.RuleEditor.Aura.Appearance.Texture"})};return{...super.defineSchema(),radius:new ResolvableValueField({required:!0,nullable:!1,initial:5,label:"PF2E.RuleEditor.Aura.Basics.Radius"}),level:new ResolvableValueField({required:!1,nullable:!0,initial:null,label:"PF2E.RuleEditor.Aura.Basics.Level.Label",hint:"PF2E.RuleEditor.Aura.Basics.Level.Hint"}),traits:new LaxArrayField(auraTraitField,{required:!0,nullable:!1,label:"PF2E.TraitsLabel"}),effects:new StrictArrayField(effectSchemaField,{required:!0,nullable:!1,label:"PF2E.RuleEditor.Aura.Effects.Label"}),appearance:new fields$_.SchemaField(appearanceSchema,{required:!0,nullable:!1,initial:__name2(()=>({border:{color:"#000000",alpha:.75},highlight:{color:"user-color",alpha:.25},texture:null}),"initial"),label:"PF2E.RuleEditor.Aura.Appearance.Label"}),mergeExisting:new fields$_.BooleanField({required:!0,nullable:!1,initial:!0,label:"PF2E.RuleEditor.Aura.Basics.MergeExisting.Label",hint:"PF2E.RuleEditor.Aura.Basics.MergeExisting.Hint"})}}afterPrepareData(){if(!this.test())return;const radius=Math.clamp(Math.ceil(Number(this.resolveValue(this.radius))/5)*5,5,240);if(Number.isInteger(radius)&&radius>0){const level=this.resolveValue(this.level,null),data={slug:this.slug,radius,level:typeof level=="number"?Math.trunc(level):this.item.isOfType("effect")?this.item.level:null,effects:this.#processEffects(),traits:n(this.traits.filter(t2=>t2!=="aura")).sort(),appearance:this.#processAppearanceData()};for(const effect of data.effects){const indexEntry=fromUuidSync(effect.uuid);if(!(indexEntry&&"type"in indexEntry&&typeof indexEntry.type=="string")){this.failValidation(`Unable to resolve effect uuid: ${effect.uuid}`);return}["effect","affliction"].includes(indexEntry.type)||this.failValidation('effects transmitted by auras must be of type "effect" or "affliction"')}const existing=this.actor.auras.get(this.slug);if(existing&&this.mergeExisting){existing.radius=data.radius,existing.traits=n([...existing.traits,...data.traits]).sort(),existing.appearance=data.appearance;for(const effect of data.effects){const existingIndex=existing.effects.findIndex(e2=>e2.uuid===effect.uuid);existingIndex!==-1?existing.effects.splice(existingIndex,1,effect):existing.effects.push(effect)}}else this.actor.auras.set(this.slug,data)}}#processEffects(){return this.effects.map(e2=>({...e2,parent:this.item,uuid:this.resolveInjectedProperties(e2.uuid),predicate:this.resolveInjectedProperties(e2.predicate),save:null}))}#processAppearanceData(){const appearance=foundry.utils.deepClone(this.appearance),{border,highlight,texture}=appearance,textureSrc=(()=>{if(!texture)return null;const maybeTextureSrc=this.resolveInjectedProperties(texture.src);return isImageOrVideoPath(maybeTextureSrc)?maybeTextureSrc:"icons/svg/hazard.svg"})();return border&&(border.color=border.color==="user-color"?Color.fromString(userColorForActor(this.actor)):border.color),highlight.color=highlight.color==="user-color"?Color.fromString(userColorForActor(this.actor)):highlight.color,{border:border&&{color:Number(border.color),alpha:border.alpha},highlight:{color:Number(highlight.color),alpha:highlight.alpha},texture:texture?.alpha&&textureSrc?{...texture,src:textureSrc}:null}}}const fields$Z=foundry.data.fields;class BaseSpeedRuleElement extends RuleElement{static{__name(this,"BaseSpeedRuleElement")}static{__name2(this,"BaseSpeedRuleElement")}static validActorTypes=["character","familiar","npc"];static autogenForms=!0;constructor(data,options){super(data,options),!this.invalid&&(this.selector=this.selector.trim().replace(/-speed$/,""),typeof this.value!="string"&&typeof this.value!="number"&&this.failValidation("A value must be a number or string"))}static defineSchema(){return{...super.defineSchema(),selector:new fields$Z.StringField({required:!0,blank:!1,initial:void 0}),value:new ResolvableValueField({required:!0,nullable:!1,initial:void 0})}}beforePrepareData(){if(this.ignored)return;const speedType=this.resolveInjectedProperties(this.selector);if(!tupleHasValue(MOVEMENT_TYPES,speedType))return this.failValidation("Unrecognized or missing selector");const speed=this.#createMovementType(speedType);(this.actor.synthetics.movementTypes[speedType]??=[]).push(speed)}#createMovementType(type2){return(options={})=>{if(!this.test(options.test??[]))return null;const value=Math.trunc(Number(this.resolveValue(this.value)));if(!(value>0))return Number.isInteger(value)||this.failValidation("Failed to resolve value"),null;const derivedFromLand=type2!=="land"&&typeof this.value=="string"&&this.value.includes("movement.speeds.land.value");return{type:type2,value,source:this.getReducedLabel(),derivedFromLand}}}}const fields$Y=foundry.data.fields;class CreatureSizeRuleElement extends RuleElement{static{__name(this,"CreatureSizeRuleElement")}static{__name2(this,"CreatureSizeRuleElement")}static validActorTypes=["character","npc","familiar"];constructor(data,options){super(data,options),typeof this.value!="string"&&typeof this.value!="number"&&this.failValidation("value must be a number or string")}static defineSchema(){return{...super.defineSchema(),value:new ResolvableValueField({required:!0,nullable:!1}),reach:new RecordField(new fields$Y.StringField({required:!0,nullable:!1,choices:["add","upgrade","override"]}),new ResolvableValueField({required:!0,nullable:!1}),{required:!1,nullable:!0,initial:null}),resizeEquipment:new fields$Y.BooleanField({required:!1,nullable:!1,initial:void 0}),minimumSize:new fields$Y.StringField({required:!1,nullable:!1,choices:SIZES,initial:void 0}),maximumSize:new fields$Y.StringField({required:!1,nullable:!1,choices:SIZES,initial:void 0})}}static#WORD_TO_ABBREVIATION={tiny:"tiny",small:"sm",medium:"med",large:"lg",huge:"huge",gargantuan:"grg"};static#incrementMap={tiny:"sm",sm:"med",med:"lg",lg:"huge",huge:"grg",grg:"grg"};static#decrementMap={tiny:"tiny",sm:"tiny",med:"sm",lg:"med",huge:"lg",grg:"huge"};#incrementSize(size,amount){return amount===0?size:this.#incrementSize(CreatureSizeRuleElement.#incrementMap[size],amount-1)}#decrementSize(size,amount){return amount===0?size:this.#decrementSize(CreatureSizeRuleElement.#decrementMap[size],amount-1)}beforePrepareData(){if(!this.test())return;const value=this.resolveValue(this.value);if(!(typeof value=="string"||typeof value=="number")){this.failValidation(`CreatureSize Rule Element on actor ${this.actor.id} (${this.actor.name})`,"has a non-string, non-numeric value");return}const size=CreatureSizeRuleElement.#WORD_TO_ABBREVIATION[value]??value;if(typeof size=="string"&&!tupleHasValue(SIZES,size)){this.failValidation(`"${size}" is not a recognized size`);return}const actor=this.actor,originalSize=new ActorSizePF2e({value:actor.size});if(value===1){if(this.maximumSize&&!originalSize.isSmallerThan(this.maximumSize))return;actor.system.traits.size.increment()}else if(value===-1){if(this.minimumSize&&!originalSize.isLargerThan(this.minimumSize))return;actor.system.traits.size.decrement()}else if(tupleHasValue(SIZES,size))actor.system.traits.size=new ActorSizePF2e({value:size});else{const validValues=Array.from(new Set(Object.entries(CreatureSizeRuleElement.#WORD_TO_ABBREVIATION).flat())).join('", "');this.failValidation(`CreatureSize Rule Element on actor ${actor.id} (${actor.name})`,`has an invalid value: must be one of "${validValues}", +1, or -1`);return}const reach=actor.system.attributes.reach;if(reach.base=this.#getReach(originalSize),reach.manipulate=Math.max(reach.manipulate,reach.base),this.resizeEquipment){const sizeDifference=originalSize.difference(actor.system.traits.size,{smallIsMedium:!0});for(const item of actor.inventory.filter(i=>!(i instanceof TreasurePF2e&&i.isCoinage)))sizeDifference<0?item.system.size=this.#incrementSize(item.size,Math.abs(sizeDifference)):sizeDifference>0&&(item.system.size=this.#decrementSize(item.size,Math.abs(sizeDifference)));actor.system.traits.naturalSize=actor.system.traits.naturalSize??originalSize.value}}#getReach(originalSize){const current=this.actor.attributes.reach.base;if(this.reach){const changeValue=Math.trunc(Number(this.resolveValue(this.reach.add??this.reach.upgrade??this.reach.override)));if(this.ignored||!Number.isFinite(changeValue))return current;if(!e(this.reach.add))return Math.max(0,current+changeValue);if(!e(this.reach.upgrade))return Math.max(current,changeValue);if(!e(this.reach.override))return Math.max(0,changeValue)}const newSize=this.actor.system.traits.size;return newSize.isLargerThan(originalSize)?Math.max(SIZE_TO_REACH[this.actor.size],current):newSize.isSmallerThan(originalSize)?Math.min(SIZE_TO_REACH[this.actor.size],current):current}}const fields$X=foundry.data.fields;class IWRRuleElement extends RuleElement{static{__name(this,"IWRRuleElement")}static{__name2(this,"IWRRuleElement")}static get dictionary(){return{}}static defineSchema(){return{...super.defineSchema(),mode:new fields$X.StringField({required:!0,choices:["add","remove"],initial:"add"}),type:new fields$X.ArrayField(new fields$X.StringField({required:!0,blank:!1}),{min:1}),definition:new PredicateField({required:!1,initial:void 0}),exceptions:this.createExceptionsField(),override:new fields$X.BooleanField}}static createExceptionsField(types){const customExceptionField=new foundry.data.fields.SchemaField({definition:new PredicateField({initial:void 0}),label:new StrictStringField({required:!0,blank:!1,initial:void 0})},{required:!0,initial:void 0}),exceptionField=new DataUnionField([new StrictStringField({required:!0,blank:!1,initial:void 0,choices:types}),customExceptionField],{required:!0,nullable:!1,initial:void 0});return new StrictArrayField(exceptionField)}static validateJoint(source2){if(super.validateJoint(source2),source2.type.some(t2=>t2==="custom")){if(source2.type.length>1)throw Error('  type: "custom" may not be included among other types');if(!source2.definition)throw Error("  definition: must be present if defining a custom type")}else if(source2.definition)throw Error("  definition: may only be present if defining a custom type");if(source2.mode==="remove"&&source2.exceptions.length>0)throw Error('  exceptions: may not be included with a mode of "remove"')}#isValidValue(value){const dictionary=this.constructor.dictionary,unrecognizedTypes=this.type.filter(t2=>!(t2 in dictionary));if(unrecognizedTypes.length>0){for(const type2 of unrecognizedTypes)this.failValidation(`Type "${type2}" is unrecognized`);return!1}return this.mode==="add"&&dictionary!==CONFIG.PF2E.immunityTypes&&(typeof value!="number"||value<0)?(this.failValidation("A `value` must be a positive number"),!1):!0}afterPrepareData(){if(!this.test())return;this.type=this.resolveInjectedProperties(this.type),this.definition=this.resolveInjectedProperties(this.definition);const value=Math.floor(Number(this.resolveValue(this.value)));if(this.#isValidValue(value))if(this.mode==="add")this.property.push(...this.getIWR(value));else for(const toRemove of this.type)this.property.findSplice(iwr=>iwr.type===toRemove)}}class ImmunityRuleElement extends IWRRuleElement{static{__name(this,"ImmunityRuleElement")}static{__name2(this,"ImmunityRuleElement")}value=null;static defineSchema(){return{...super.defineSchema(),exceptions:this.createExceptionsField(this.dictionary)}}static get dictionary(){return CONFIG.PF2E.immunityTypes}get property(){return this.actor.system.attributes.immunities}getIWR(){const immunities=this.property;return this.type.map(t2=>new Immunity({type:t2,customLabel:t2==="custom"?this.label:null,definition:this.definition,exceptions:this.exceptions,source:this.item.name})).filter(immunity=>!immunities.find(i=>i.type===immunity.type&&(this.exceptions.length===0||t$6(i.exceptions,this.exceptions))&&t$6(i.definition,this.definition??null))||this.mode==="remove")}}class ResistanceRuleElement extends IWRRuleElement{static{__name(this,"ResistanceRuleElement")}static{__name2(this,"ResistanceRuleElement")}static defineSchema(){return{...super.defineSchema(),value:new ResolvableValueField({required:!0,nullable:!1,initial:void 0}),exceptions:this.createExceptionsField(this.dictionary),doubleVs:this.createExceptionsField(this.dictionary)}}static get dictionary(){return CONFIG.PF2E.resistanceTypes}get property(){return this.actor.system.attributes.resistances}getIWR(value){if(value<=0)return[];const resistances=this.property;for(const resistanceType of[...this.type]){const current=resistances.find(r2=>r2.type===resistanceType&&t$6(r2.exceptions,this.exceptions)&&t$6(r2.doubleVs,this.doubleVs)&&t$6(r2.definition,this.definition??null));current&&(this.override?resistances.splice(resistances.indexOf(current),1):this.mode!=="remove"&&(current.value=Math.max(current.value,value),current.source=this.label,this.type.splice(this.type.indexOf(resistanceType),1)))}return this.type.map(t2=>new Resistance({type:t2,value,customLabel:t2==="custom"?this.label:null,definition:this.definition,exceptions:this.exceptions,doubleVs:this.doubleVs,source:this.item.name}))}}const fields$W=foundry.data.fields;class WeaknessRuleElement extends IWRRuleElement{static{__name(this,"WeaknessRuleElement")}static{__name2(this,"WeaknessRuleElement")}static defineSchema(){return{...super.defineSchema(),value:new ResolvableValueField({required:!0,nullable:!1,initial:void 0}),exceptions:this.createExceptionsField(this.dictionary),applyOnce:new fields$W.BooleanField({required:!1,initial:void 0})}}static validateJoint(source2){if(super.validateJoint(source2),typeof source2.applyOnce=="boolean"&&!source2.type.every(t2=>t2==="custom"))throw new foundry.data.validation.DataModelValidationError("applyOnce can only be specified for custom weakness types")}static get dictionary(){return CONFIG.PF2E.weaknessTypes}get property(){return this.actor.system.attributes.weaknesses}getIWR(value){if(value<=0)return[];const weaknesses=this.property;for(const weaknessType of[...this.type]){const current=weaknesses.find(w=>w.type===weaknessType&&t$6(w.exceptions,this.exceptions)&&t$6(w.definition,this.definition??null));current&&(this.override?weaknesses.splice(weaknesses.indexOf(current),1):this.mode!=="remove"&&(current.value=Math.max(current.value,value),current.source=this.label,this.type.splice(this.type.indexOf(weaknessType),1)))}return this.type.map(t2=>new Weakness({type:t2,customLabel:t2==="custom"?this.label:null,definition:this.definition,value,exceptions:this.exceptions,source:this.item.name,applyOnce:this.applyOnce}))}}const fields$V=foundry.data.fields;class SenseRuleElement extends RuleElement{static{__name(this,"SenseRuleElement")}static{__name2(this,"SenseRuleElement")}static validActorTypes=["character","familiar","npc"];static defineSchema(){return{...super.defineSchema(),selector:new fields$V.StringField({required:!0,nullable:!1,choices:[...SENSE_TYPES]}),force:new fields$V.BooleanField({required:!1,nullable:!1,initial:!1}),acuity:new fields$V.StringField({required:!1,nullable:!1,choices:SENSE_ACUITIES,initial:void 0}),range:new ResolvableValueField({required:!1,nullable:!1,initial:void 0})}}beforePrepareData(){const range=tupleHasValue(SENSES_WITH_UNLIMITED_RANGE,this.selector)?1/0:Math.max(0,Math.trunc(Math.floor(Number(this.resolveValue(this.range,1/0))||0)));if(range<=0){range<0&&this.failValidation("range: must resolve to a positive number");return}const sense={type:this.selector,acuity:SENSES_WITH_MANDATORY_ACUITIES[this.selector]??this.acuity,range,source:this.item.name};this.actor.synthetics.senses.push({sense,predicate:this.predicate,force:this.force})}}const fields$U=foundry.data.fields;class StrikeRuleElement extends RuleElement{static{__name(this,"StrikeRuleElement")}static{__name2(this,"StrikeRuleElement")}static validActorTypes=["character","npc"];constructor(source2,options){super(source2,options),!this.invalid&&(this.slug??=sluggify(this.label),this.battleForm??=!1,this.options??=[],this.graspingAppendage=["fist","claw"].includes(this.baseType??"")?this.graspingAppendage??!0:this.category==="unarmed"||this.traits.includes("unarmed")?!!this.graspingAppendage:!1)}static#defaultFistIcon="icons/skills/melee/unarmed-punch-fist.webp";static defineSchema(){const baseTypeChoices=CONFIG.PF2E.baseWeaponTypes;return{...super.defineSchema(),category:new fields$U.StringField({required:!0,blank:!1,choices:CONFIG.PF2E.weaponCategories,initial:"unarmed"}),group:new fields$U.StringField({required:!0,nullable:!0,blank:!1,initial:null}),baseType:new fields$U.StringField({required:!0,nullable:!0,blank:!1,choices:baseTypeChoices,initial:null}),traits:new fields$U.ArrayField(new fields$U.StringField({required:!0,blank:!1,choices:CONFIG.PF2E.npcAttackTraits})),traitToggles:new fields$U.SchemaField({modular:new fields$U.StringField({required:!0,blank:!1,nullable:!0,choices:CONFIG.PF2E.damageTypes,initial:null}),versatile:new fields$U.StringField({required:!0,blank:!1,nullable:!0,choices:CONFIG.PF2E.damageTypes,initial:null})},{required:!0,nullable:!1,initial:{modular:null,versatile:null}}),otherTags:new fields$U.ArrayField(new fields$U.StringField({required:!0,blank:!1,choices:CONFIG.PF2E.otherWeaponTags}),{required:!1,nullable:!1,initial:[]}),range:new fields$U.SchemaField({increment:new fields$U.NumberField({required:!1,integer:!0,min:5,nullable:!0,initial:5}),max:new fields$U.NumberField({required:!1,integer:!0,min:5,nullable:!0,initial:null})},{required:!1,nullable:!0,initial:null}),damage:new fields$U.SchemaField({base:new fields$U.SchemaField({damageType:new fields$U.StringField({required:!0,blank:!1,initial:"bludgeoning"}),dice:new ResolvableValueField({required:!0,nullable:!1,initial:1}),die:new fields$U.StringField({required:!0,choices:CONFIG.PF2E.damageDie,initial:"d4"}),modifier:new fields$U.NumberField({nullable:!1,integer:!0,initial:0})})}),img:new fields$U.FilePathField({categories:["IMAGE"],nullable:!1,initial:__name2(data=>data.fist?StrikeRuleElement.#defaultFistIcon:"systems/pf2e/icons/default-icons/melee.svg","initial")}),attackModifier:new fields$U.NumberField({integer:!0,positive:!0,nullable:!0,initial:null}),replaceAll:new fields$U.BooleanField({required:!1,nullable:!1,initial:void 0}),replaceBasicUnarmed:new fields$U.BooleanField({required:!1,nullable:!1,initial:void 0}),battleForm:new fields$U.BooleanField({required:!1,nullable:!1,initial:void 0}),ability:new fields$U.StringField({required:!1,blank:!1,nullable:!0,initial:null}),options:new fields$U.ArrayField(new fields$U.StringField,{required:!1,initial:void 0}),fist:new fields$U.BooleanField({required:!1,nullable:!1}),graspingAppendage:new fields$U.BooleanField({required:!1,nullable:!1,initial:void 0})}}_initialize(options){super._initialize(options),this.fist?(this.priority=99,this.slug="fist",this.label="PF2E.Weapon.Base.fist",this.category="unarmed",this.group="brawling",this.baseType="fist",this.traits=["agile","finesse","nonlethal"],this.otherTags=[],this.range=null,this.damage={base:{dice:1,die:"d4",damageType:"bludgeoning",modifier:0}},this.battleForm=!1,this.graspingAppendage=!0,this.replaceAll=!1,this.replaceBasicUnarmed=!1):this.img==="systems/pf2e/icons/default-icons/melee.svg"&&(this.img=this.parent.img)}beforePrepareData(){if(!this.test())return;const slug=this.slug??sluggify(this.label);this.actor.synthetics.strikes[slug]=unarmedRunes=>this.#constructWeapon({slug,unarmedRunes})}afterPrepareData(){if(!(this.ignored||!this.actor.isOfType("character")))if(this.replaceAll){const systemData=this.actor.system;systemData.actions=systemData.actions.filter(a=>a.item.id===this.item.id&&a.item.name===this.label&&a.item.group===this.group||a.item.shield).map(action2=>(action2.item.shield&&(action2.canAttack=!1),action2))}else this.replaceBasicUnarmed&&this.actor.system.actions.findSplice(a=>a.item?.slug==="basic-unarmed")}#constructWeapon({slug,unarmedRunes}){const actor=this.actor,attribute=this.resolveInjectedProperties(this.ability)||null;if(attribute!==null&&!objectHasKey(CONFIG.PF2E.abilities,attribute))return this.failValidation(`Unrecognized attribute: ${attribute}`),null;const damageType=this.resolveInjectedProperties(this.damage.base.damageType);if(!objectHasKey(CONFIG.PF2E.damageTypes,damageType))return this.failValidation(`Unrecognized damage type: ${damageType}`),null;const dice=Math.clamp(Math.floor(Number(this.resolveValue(this.damage.base.dice))),0,12);if(Number.isNaN(dice))return this.failValidation("dice does not resolve to a number"),null;const group=this.resolveInjectedProperties(this.group);if(group!==null&&!objectHasKey(CONFIG.PF2E.weaponGroups,group))return this.failValidation(`Unrecognized weapon group: ${group}`),null;const actorIsNPC=actor.isOfType("npc"),source2=foundry.utils.deepClone({_id:this.fist?"xxxxxxFISTxxxxxx":this.item.id,name:this.label,type:"weapon",img:this.img,flags:{pf2e:{battleForm:this.battleForm,fixedAttack:actorIsNPC?this.attackModifier??null:null}},system:{slug,description:{value:""},category:this.category,group,baseItem:this.baseType,attribute,bonus:{value:actorIsNPC?this.attackModifier??0:0},damage:{...this.damage.base,dice,damageType},range:this.range?.increment??null,maxRange:this.range?.max??null,traits:{value:this.traits,otherTags:this.otherTags,rarity:"common",toggles:{modular:{selected:this.traitToggles.modular},versatile:{selected:this.traitToggles.versatile}}},options:{value:this.options},runes:this.category==="unarmed"?unarmedRunes??{}:{},usage:{value:"held-in-one-hand"},equipped:{carryType:"held",handsHeld:1},graspingAppendage:this.graspingAppendage}}),weapon=new WeaponPF2e(source2,{parent:actor});return weapon.rule=this,weapon.name=weapon._source.name,performLatePreparation(weapon),weapon}async toggleTrait({trait,selected}){const ruleSources=foundry.utils.deepClone(this.item._source.system.rules),rule=ruleSources.at(this.sourceIndex??NaN);rule?.key==="Strike"&&(rule.traitToggles={...this.traitToggles,[trait]:selected},await this.item.update({"system.rules":ruleSources}))}}const fields$T=foundry.data.fields;class TempHPRuleElement extends RuleElement{static{__name(this,"TempHPRuleElement")}static{__name2(this,"TempHPRuleElement")}static validActorTypes=["character","npc","familiar"];static defineSchema(){return{...super.defineSchema(),value:new ResolvableValueField({required:!0,nullable:!1}),events:new fields$T.SchemaField({onCreate:new fields$T.BooleanField,onTurnStart:new fields$T.BooleanField},{required:!0,nullable:!1,initial:{onCreate:!0,onTurnStart:!1}})}}onCreate(actorUpdates){if(this.ignored||!this.events.onCreate)return;const updatedActorData=foundry.utils.mergeObject(this.actor._source,actorUpdates,{inplace:!1}),value=Math.trunc(Number(this.resolveValue(this.value))),rollOptions=Array.from(new Set([...this.actor.getRollOptions(),...this.actor.itemTypes.weapon.flatMap(w=>w.isEquipped?w.getRollOptions("self:weapon"):[])]));if(!this.test(rollOptions))return;if(Number.isNaN(value)||value<0)return this.failValidation("value: must resolve to a positive number");const currentTempHP=Number(foundry.utils.getProperty(updatedActorData,"system.attributes.hp.temp"))||0;value>currentTempHP&&(foundry.utils.mergeObject(actorUpdates,{"system.attributes.hp.temp":value,"system.attributes.hp.tempsource":this.item.id}),this.broadcast(value,currentTempHP))}async onUpdateEncounter(data){if(this.ignored||data.event!=="turn-start"||!this.events.onTurnStart)return;const rollOptions=Array.from(new Set([...this.actor.getRollOptions(["all"]),...this.actor.itemTypes.weapon.flatMap(w=>w.isEquipped?w.getRollOptions("self:weapon"):[])]));if(!this.test(rollOptions))return;const value=this.resolveValue(this.value);if(typeof value!="number")return this.failValidation("value: must resolve to a number");const actorUpdates=data.actorUpdates,updatedActorData=foundry.utils.mergeObject(this.actor._source,actorUpdates,{inplace:!1}),currentTempHP=Number(foundry.utils.getProperty(updatedActorData,"system.attributes.hp.temp"))||0;value>currentTempHP&&(actorUpdates["system.attributes.hp.temp"]=value,this.broadcast(value,currentTempHP))}onDelete(actorUpdates){const updatedActorData=foundry.utils.mergeObject(this.actor._source,actorUpdates,{inplace:!1});if(foundry.utils.getProperty(updatedActorData,"system.attributes.hp.tempsource")===this.item.id){foundry.utils.mergeObject(actorUpdates,{"system.attributes.hp.temp":0});const hpData=foundry.utils.getProperty(actorUpdates,"system.attributes.hp");e$2(hpData)&&(hpData["-=tempsource"]=null)}}broadcast(newQuantity,oldQuantity){const singularOrPlural=newQuantity===1?"PF2E.Encounter.Broadcast.TempHP.SingleNew":"PF2E.Encounter.Broadcast.TempHP.PluralNew",wasAt=oldQuantity>0?game.i18n.format("PF2E.Encounter.Broadcast.TempHP.WasAt",{oldQuantity}):"",[actor,item]=[this.actor.name,this.item.name],content=game.i18n.format(singularOrPlural,{actor,newQuantity,wasAt,item}),recipients=game.users.filter(u=>this.actor.testUserPermission(u,"OWNER")).map(u=>u.id),speaker=ChatMessagePF2e.getSpeaker({actor:this.actor,token:this.token});ChatMessagePF2e.create({content,speaker,whisper:recipients})}}const BATTLE_FORM_DEFAULT_ICONS=t$9(["antler","beak","body","bone-shard","branch","claw","cube-face","fangs","fire-mote","fist","foot","foreleg","gust","horn","jaws","lighting-lash","mandibles","piercing-hymn","pincer","pseudopod","rock","spikes","stinger","tail","talon","tendril","tentacle","tongue","trunk","tusk","vine","water-spout","wave","wing"],slug=>{switch(slug){case"fist":return[slug,"icons/skills/melee/unarmed-punch-fist.webp"];case"pincer":return[slug,"icons/commodities/claws/claw-pincer-pink.webp"];default:return[slug,`systems/pf2e/icons/unarmed-attacks/${slug}.webp`]}}),fields$S=foundry.data.fields;class BattleFormRuleElement extends RuleElement{static{__name(this,"BattleFormRuleElement")}static{__name2(this,"BattleFormRuleElement")}static validActorTypes=["character"];modifierLabel="invalid";static defineSchema(){return{...super.defineSchema(),overrides:new fields$S.SchemaField({traits:new fields$S.ArrayField(new fields$S.StringField),armorClass:new fields$S.SchemaField({modifier:new ResolvableValueField({required:!1,nullable:!1,initial:0}),ignoreCheckPenalty:new fields$S.BooleanField({initial:!0}),ignoreSpeedPenalty:new fields$S.BooleanField({initial:!0}),ownIfHigher:new fields$S.BooleanField}),tempHP:new ResolvableValueField({required:!1,nullable:!0,initial:null}),senses:new RecordField(new fields$S.StringField({required:!0,blank:!1,choices:__name2(()=>({...CONFIG.PF2E.senses,...t$i(CONFIG.PF2E.senses,k=>sluggify(k,{camel:"dromedary"}))}),"choices")}),new fields$S.SchemaField({acuity:new fields$S.StringField({choices:__name2(()=>CONFIG.PF2E.senseAcuities,"choices"),required:!1,blank:!1,initial:void 0}),range:new fields$S.NumberField({required:!1,nullable:!0,positive:!0,integer:!0,initial:void 0})}),{required:!1,initial:__name2(()=>({}),"initial")}),size:new fields$S.StringField({required:!1,blank:!1,initial:void 0}),speeds:new fields$S.ObjectField({required:!1,initial:__name2(()=>({}),"initial")}),skills:new fields$S.ObjectField({required:!1,initial:__name2(()=>({}),"initial")}),strikes:new fields$S.ObjectField({required:!1,initial:__name2(()=>({}),"initial")}),immunities:new fields$S.ArrayField(new fields$S.ObjectField),weaknesses:new fields$S.ArrayField(new fields$S.ObjectField),resistances:new fields$S.ArrayField(new fields$S.ObjectField)}),brackets:new fields$S.ArrayField(new fields$S.SchemaField({start:new fields$S.NumberField({required:!0,nullable:!1,integer:!0,min:0,max:30,initial:0}),value:new fields$S.ObjectField})),ownUnarmed:new fields$S.BooleanField({required:!1,nullable:!1,initial:!1}),canCast:new fields$S.BooleanField({required:!1,nullable:!1,initial:!1}),canSpeak:new fields$S.BooleanField({required:!1,nullable:!1,initial:!1}),hasHands:new fields$S.BooleanField({required:!1,nullable:!1,initial:!1})}}async preCreate({itemSource,ruleSource}){if(!this.test()){ruleSource.ignored=!0;return}const rules=itemSource.system?.rules??[];for(const rule of rules)["DamageDice","FlatModifier","ItemAlteration","Note"].includes(String(rule.key))&&(rule.battleForm=!0);await this.#resolveStrikeQueries(ruleSource)}onCreate(actorUpdates){if(this.ignored)return;const tempHP=this.overrides.tempHP;if(tempHP){const source2={key:"TempHP",label:this.label,value:tempHP};new TempHPRuleElement(source2,{parent:this.item}).onCreate(actorUpdates)}}beforePrepareData(){if(this.ignored)return;const actor=this.actor,flags=actor.flags;if(flags.pf2e.polymorphed){this.ignored=!0;return}if(flags.pf2e.polymorphed=!0,flags.pf2e.battleForm=!0,this.#setRollOptions(),this.#prepareSenses(),this.ignored)return;this.modifierLabel=this.getReducedLabel();const bracket=this.brackets.findLast(b=>b.start<=(this.item.system.level?.value??0));bracket&&(this.overrides=foundry.utils.mergeObject(this.overrides,bracket.value));for(const trait of this.overrides.traits){const currentTraits=actor.system.traits;currentTraits.value.includes(trait)||currentTraits.value.push(trait)}this.overrides.armorClass.ignoreCheckPenalty&&(this.actor.synthetics.modifierAdjustments["skill-check"]??=[]).push({slug:"armor-check-penalty",test:__name2(()=>!0,"test"),suppress:!0}),this.overrides.armorClass.ignoreSpeedPenalty&&(this.actor.synthetics.modifierAdjustments["all-speeds"]??=[]).push({slug:"armor-speed-penalty",test:__name2(()=>!0,"test"),suppress:!0})}afterPrepareData(){if(this.ignored)return;this.#prepareAC(),this.#prepareSize(),this.#prepareSkills(),this.#prepareSpeeds(),this.#prepareStrikes(),this.#prepareIWR();const actor=this.actor,initiativeData=actor.system.initiative;actor.initiative=new ActorInitiative(actor,t$3(initiativeData,["statistic","tiebreakPriority"])),actor.system.initiative=actor.initiative.getTraceData()}onDelete(actorUpdates){if(this.ignored)return;const tempHP=this.overrides.tempHP;if(tempHP){const source2={key:"TempHP",label:this.label,value:tempHP};new TempHPRuleElement(source2,{parent:this.item}).onDelete(actorUpdates)}}#setRollOptions(){const{attributes,rollOptions}=this.actor;rollOptions.all.polymorph=!0,rollOptions.all["battle-form"]=!0;for(const key of Object.keys(this.overrides.skills))key in CONFIG.PF2E.skills&&(rollOptions.all[`battle-form:${key}`]=!0);attributes.handsFree=Math.max(Object.values(this.overrides.strikes).reduce((count,s)=>s.category==="unarmed"?count:count-1,2),0);for(const num of[0,1,2])attributes.handsFree===num?rollOptions.all[`hands-free:${num}`]=!0:delete rollOptions.all[`hands-free:${num}`]}#prepareAC(){const{actor,overrides}=this,armorClass=actor.armorClass,acOverride=Number(this.resolveValue(overrides.armorClass.modifier,armorClass.value))||0;if(!acOverride||overrides.armorClass.ownIfHigher&&armorClass.value>acOverride)return;this.#suppressModifiers(armorClass);const newModifier=(Number(this.resolveValue(overrides.armorClass.modifier))||0)-10;armorClass.modifiers.push(new Modifier(this.modifierLabel,newModifier,"untyped")),actor.system.attributes.ac=foundry.utils.mergeObject(actor.system.attributes.ac,armorClass.parent.getTraceData())}#prepareSenses(){for(const[key,data]of Object.entries(this.overrides.senses)){const slug=sluggify(key);if(!setHasElement(SENSE_TYPES,slug)){this.failValidation(`senses: ${slug} is not a valid choice`);return}const ruleData={key:"Sense",selector:slug,force:!0,...data};new SenseRuleElement(ruleData,{parent:this.item}).beforePrepareData()}}#prepareSize(){if(!this.overrides.size)return;const ruleData={key:"CreatureSize",label:this.label,value:this.overrides.size};new CreatureSizeRuleElement(ruleData,{parent:this.item}).beforePrepareData()}#prepareSkills(){const actor=this.actor;for(const[key,newSkill]of Object.entries(this.overrides.skills)){if(!objectHasKey(actor.skills,key))return this.failValidation(`Unrecognized skill: ${key}`);newSkill.ownIfHigher??=!0;const currentSkill=actor.skills[key],newModifier=Number(this.resolveValue(newSkill.modifier))||0;if(currentSkill.mod>newModifier&&newSkill.ownIfHigher)continue;const baseMod=new Modifier({label:this.modifierLabel,slug:"battle-form",modifier:newModifier,type:"untyped"});actor.skills[key]=currentSkill.extend({modifiers:[baseMod],filter:this.#filterModifier}),actor.system.skills[key]=foundry.utils.mergeObject(actor.system.skills[key],actor.skills[key].getTraceData())}}#prepareStrikes(){const actor=this.actor,synthetics=actor.synthetics,strikes=this.overrides.strikes;for(const strike of Object.values(strikes))strike.ownIfHigher??=!0,strike.damage.modifier=Number(this.resolveValue(strike.damage.modifier))||0;const ruleData=Object.entries(strikes).map(([slug,strikeData])=>({key:"Strike",label:game.i18n.localize(strikeData.label)??`PF2E.BattleForm.Attack.${sluggify(slug,{camel:"bactrian"})}`,slug,predicate:strikeData.predicate??[],img:strikeData.img??BATTLE_FORM_DEFAULT_ICONS[slug]??this.item.img,category:strikeData.category,group:strikeData.group,baseItem:strikeData.baseType,options:[slug],damage:{base:strikeData.damage},range:strikeData.range,traits:strikeData.traits??[],ability:strikeData.ability,battleForm:!0})),strikeAndItemAlterationRules=actor.rules.filter(r2=>["ItemAlteration","Strike"].includes(r2.key));if(this.ownUnarmed){const strikeRules=strikeAndItemAlterationRules.filter(r2=>r2.key==="Strike");for(const rule of strikeRules)rule.category!=="unarmed"&&(rule.ignored=!0);actor.rollOptions.all["battle-form:own-attack-modifier"]=!0}else{for(const rule of strikeAndItemAlterationRules)!rule.battleForm&&(rule.key==="Strike"||"type"in rule&&rule.type==="weapon")&&(rule.ignored=!0);for(const striking of Object.values(synthetics.striking).flat())(striking.predicate??=new Predicate).push({not:"battle-form"});for(const datum of ruleData)datum.traits.includes("magical")||datum.traits.push("magical"),new StrikeRuleElement(datum,{parent:this.item}).beforePrepareData()}actor.system.actions=actor.prepareAttacks({includeBasicUnarmed:this.ownUnarmed}).filter(a=>a.item.flags.pf2e.battleForm||this.ownUnarmed&&a.item.category==="unarmed");const strikeActions=actor.system.actions.flatMap(s=>[s,...s.altUsages]);for(const action2 of strikeActions){const strike=strikes[action2.slug??""];if(!strike||action2.type!=="strike")continue;const addend=action2.modifiers.filter(m=>m.enabled&&this.#filterModifier(m)).reduce((sum,m)=>sum+m.modifier,0),formModifier=Number(this.resolveValue(strike.modifier))+addend;if(!this.ownUnarmed&&(formModifier>=action2.totalModifier||!strike.ownIfHigher)){this.#suppressModifiers(action2),this.#suppressNotes(Object.entries(synthetics.rollNotes).flatMap(([key,note])=>/\bdamage\b/.test(key)?note:[]));const baseModifier=Number(this.resolveValue(strike.modifier))||0;action2.unshift(new Modifier(this.modifierLabel,baseModifier,"untyped"))}else{const options=actor.rollOptions["strike-attack-roll"]??={};options["battle-form:own-attack-modifier"]=!0,action2.calculateTotal(new Set(actor.getRollOptions(action2.domains)))}}}#prepareIWR(){for(const immunity of this.overrides.immunities)new ImmunityRuleElement({key:"Immunity",...immunity},{parent:this.item}).afterPrepareData();for(const weakness of this.overrides.weaknesses){const args={key:"Weakness",...weakness,override:!0};new WeaknessRuleElement(args,{parent:this.item}).afterPrepareData()}for(const resistance of this.overrides.resistances){const args={key:"Resistance",...resistance,override:!0};new ResistanceRuleElement(args,{parent:this.item}).afterPrepareData()}}#prepareSpeeds(){const actor=this.actor;for(const type2 of MOVEMENT_TYPES){const speedOverride=this.resolveValue(this.overrides.speeds[type2],null);if(typeof speedOverride!="number")continue;actor.synthetics.movementTypes[type2]=[];const statistic=new SpeedStatistic(actor,{type:type2,base:speedOverride});this.#suppressModifiers(statistic);const traceData=statistic.getTraceData();actor.system.movement.speeds[type2]=traceData}}#suppressModifiers(statistic){for(const modifier of statistic.modifiers)this.#filterModifier(modifier)||(modifier.adjustments.push({slug:null,test:__name2(()=>!0,"test"),suppress:!0}),modifier.ignored=!0,modifier.enabled=!1);statistic instanceof StatisticModifier&&statistic.calculateTotal()}#filterModifier(modifier){return modifier.slug==="battle-form"?!0:modifier.type==="ability"?!1:["status","circumstance"].includes(modifier.type)||modifier.modifier<0}#suppressNotes(notes){for(const note of notes)note.predicate.includes("battle-form")||(note.predicate=note.predicate instanceof Predicate?note.predicate:new Predicate(note.predicate),note.predicate.push({not:"battle-form"}))}applyDamageExclusion(weapon,modifiers){if(!this.ownUnarmed)for(const modifier of modifiers){if(modifier.predicate.some(s=>e$2(s)&&"not"in s&&s.not==="battle-form"))continue;const isNumericBonus=modifier instanceof Modifier&&modifier.modifier>=0,isAbilityModifier=modifier instanceof Modifier&&modifier.type==="ability",isExtraDice=modifier instanceof DamageDicePF2e,isStatusOrCircumstance=isNumericBonus&&["status","circumstance"].includes(modifier.type),isDamageTrait=isExtraDice&&/^(?:deadly|fatal)-\d?d\d{1,2}$/.test(modifier.slug)&&tupleHasValue(this.overrides?.strikes?.[weapon.slug??""]?.traits??[],modifier.slug),isBattleFormModifier=!!(modifier.predicate.includes("battle-form")||modifier.predicate.some(s=>s instanceof Object&&"or"in s&&s.or.includes("battle-form"))||isDamageTrait);(isNumericBonus||isAbilityModifier||isExtraDice)&&!isStatusOrCircumstance&&!isBattleFormModifier&&(modifier.enabled=!1,modifier.ignored=!0,modifier.predicate.push({not:"battle-form"}))}}async#resolveStrikeQueries(ruleSource){const value=ruleSource.overrides?ruleSource.overrides:ruleSource.value??={};if(!__name2(v=>e$2(v)&&e$2(v.strikes),"hasStrikes")(value))return;const isStrikeQuery=__name2(maybeQuery=>e$2(maybeQuery)?typeof maybeQuery.query=="string"&&typeof maybeQuery.modifier=="number":!1,"isStrikeQuery");for(const[slug,strike]of Object.entries(value.strikes)){if(!isStrikeQuery(strike))continue;strike.pack=String(strike.pack??"pf2e.equipment-srd"),strike.ownIfHigher=!!(strike.ownIfHigher??!0);const queryObject=(()=>{try{const parsed=JSON.parse(String(this.resolveInjectedProperties(strike.query)));if(!e$2(parsed)||Array.isArray(parsed))throw Error("A strike query must be an NeDB query object");return parsed}catch(error){return error instanceof Error&&this.failValidation(error.message),ruleSource.ignored=!0,null}})();if(!queryObject){this.failValidation("Malformed query object");break}const weapon=(await game.packs.get(strike.pack)?.getDocuments(queryObject))?.[0];if(!(weapon instanceof WeaponPF2e)){this.failValidation("Failed to retrieve queried weapon");break}const resolved={label:weapon.name,img:weapon.img,ability:weapon.isRanged||weapon.traits.has("finesse")?"dex":"str",category:weapon.category,group:weapon.group,baseType:weapon.baseType,traits:foundry.utils.deepClone(weapon.system.traits.value),modifier:strike.modifier,damage:foundry.utils.deepClone(weapon.system.damage),ownIfHigher:strike.ownIfHigher};value.strikes[slug]=resolved}}}function Svelecte_pf2e($$anchor,$$props){push($$props,!0);let value=prop($$props,"value",15),props=rest_props($$props,["$$slots","$$events","$$legacy","value"]);function popoutPositionResolver(node){const theme=[...node.closest(".themed, body")?.classList??[]].find(c=>c.startsWith("theme-"));node.classList.add("detached","pf2e"),theme&&node.classList.add("themed",theme);let destroyed=!1;const selectElement=node.parentElement;function positionElement(){if(!destroyed){if(selectElement&&node.classList.contains("is-open")){const bounds=selectElement.getBoundingClientRect();node.style.left=`${bounds.left}px`,node.style.top=`${bounds.bottom}px`,node.style.minWidth=`${bounds.width}px`}requestAnimationFrame(positionElement)}}return __name(positionElement,"positionElement"),__name2(positionElement,"positionElement"),document.body.appendChild(node),positionElement(),{destroy:__name2(()=>{destroyed=!1,selectElement?.appendChild(node)},"destroy")}}__name(popoutPositionResolver,"popoutPositionResolver"),__name2(popoutPositionResolver,"popoutPositionResolver");const positionResolver=user_derived(()=>$$props.positionResolver??popoutPositionResolver),className=user_derived(()=>($$props.class??" pf2e").trim());Svelecte($$anchor,spread_props(()=>props,{get class(){return get(className)},get positionResolver(){return get(positionResolver)},get value(){return value()},set value($$value){value($$value)}})),pop()}__name(Svelecte_pf2e,"Svelecte_pf2e"),__name2(Svelecte_pf2e,"Svelecte_pf2e");var on_click$4=__name2((_,$$props,choice)=>$$props.resolve(choice()),"on_click$4"),root_2$7=from_html('<img alt="" class="svelte-d427hg"/>'),on_click_1$3=__name2((__1,viewItem,value)=>viewItem(get(value)),"on_click_1$3"),root_3$6=from_html('<button type="button" class="item-info icon fa-solid fa-info-circle svelte-d427hg" data-tooltip=""></button>'),root_1$8=from_html('<div class="choice svelte-d427hg"><button class="select-button svelte-d427hg" type="button"><!> <span> </span></button> <!></div>'),on_click_2$2=__name2((__2,viewItem,selectedChoice)=>viewItem(get(selectedChoice)?.value),"on_click_2$2"),root_5$4=from_html('<button type="button" class="item-info icon fa-solid fa-info-circle svelte-d427hg" data-tooltip=""></button>'),root_4$2=from_html('<div class="choice choice-select svelte-d427hg"><!> <!></div>'),root_6$3=from_html('<section class="choice-buttons svelte-d427hg"><!> <!></section>'),root_9$1=from_html('<div class="drop-zone with-image svelte-d427hg"><i class="fa-solid fa-fw fa-info-circle svelte-d427hg" inert data-tooltip=""></i> <span class="svelte-d427hg"></span></div>'),on_click_3$1=__name2((__3,$$props,selectedChoice)=>$$props.resolve(get(selectedChoice)),"on_click_3$1"),root_10=from_html('<button type="button"></button>'),root_12=from_html('<button type="button" data-action="close"><span></span></button>'),root$c=from_html('<div class="standard-form svelte-d427hg" role="form"><header class="svelte-d427hg"> </header> <section class="contents svelte-d427hg"><!> <!></section> <!></div>');function App$2($$anchor,$$props){push($$props,!0);const choiceButton=__name2(($$anchor2,choice=noop)=>{const value=user_derived(()=>choice().value);var div=root_1$8(),button=child(div);button.__click=[on_click$4,$$props,choice];var node=child(button);{var consequent=__name2($$anchor3=>{var img2=root_2$7();template_effect(()=>set_attribute(img2,"src",choice().img)),append($$anchor3,img2)},"consequent");if_block(node,$$render=>{choice().img&&$$render(consequent)})}var span=sibling(node,2),text2=child(span),node_1=sibling(button,2);{var consequent_1=__name2($$anchor3=>{var button_1=root_3$6();set_attribute(button_1,"aria-label",game.i18n.localize("PF2E.UI.RuleElements.ChoiceSet.ViewItem.Tooltip")),button_1.__click=[on_click_1$3,viewItem,value],append($$anchor3,button_1)},"consequent_1");if_block(node_1,$$render=>{UUIDUtils.isItemUUID(get(value))&&$$render(consequent_1)})}template_effect(()=>set_text(text2,choice().label)),append($$anchor2,div)},"choiceButton"),containsItems=user_derived(()=>$$props.state.containsItems),selectMenu=user_derived(()=>$$props.state.selectMenu),allowNoSelection=user_derived(()=>$$props.state.allowNoSelection),includeDropZone=user_derived(()=>$$props.state.includeDropZone);let droppedOption=state(null),selectedIndex=state(null);const selectedChoice=user_derived(()=>get(selectedIndex)===null?null:get(selectedIndex)==="bonus"?get(droppedOption):$$props.state.choices[Number(get(selectedIndex))]),selectChoices=user_derived(()=>{if(!get(selectMenu))return[];const allOptions=$$props.state.choices.map((c,index2)=>({value:index2,label:c.label,group:c.group})),groups=t$2(allOptions,c=>c.group??""),options=groups[""]??[];for(const[key,value]of Object.entries(groups))key!==""&&options.push({label:key,options:value});return get(droppedOption)&&options.push({value:"bonus",label:get(droppedOption).label}),options});user_effect(()=>$$props.updateSelection(get(selectedChoice)));async function viewItem(selection){if(!UUIDUtils.isItemUUID(selection))return;(await fromUuid(selection))?.sheet.render(!0)}__name(viewItem,"viewItem"),__name2(viewItem,"viewItem");async function handleDrop(event2){const dataString=event2.dataTransfer?.getData("text/plain"),dropData=JSON.parse(dataString??"");if(dropData?.type!=="Item"){ui.notifications.error("Only an item can be dropped here.");return}const droppedItem=await ItemPF2e.fromDropData(dropData);if(!droppedItem||!$$props.testAllowedDrop(droppedItem))return;const slugsAsValues=get(containsItems)&&$$props.state.choices.length>0&&$$props.state.choices.every(c=>!UUIDUtils.isItemUUID(c.value));set(droppedOption,{value:slugsAsValues?droppedItem.slug??sluggify(droppedItem.id):droppedItem.uuid,label:droppedItem.name},!0)}__name(handleDrop,"handleDrop"),__name2(handleDrop,"handleDrop");var div_1=root$c(),header=child(div_1),text_1=child(header),section=sibling(header,2),node_2=child(section);{var consequent_3=__name2($$anchor2=>{var div_2=root_4$2(),node_3=child(div_2);Svelecte_pf2e(node_3,{get options(){return get(selectChoices)},labelField:"label",get value(){return get(selectedIndex)},set value($$value){set(selectedIndex,$$value,!0)}});var node_4=sibling(node_3,2);{var consequent_2=__name2($$anchor3=>{var button_2=root_5$4();button_2.__click=[on_click_2$2,viewItem,selectedChoice],template_effect($0=>{button_2.disabled=!get(selectedIndex),set_attribute(button_2,"aria-label",$0)},[()=>game.i18n.localize(`PF2E.UI.RuleElements.ChoiceSet.ViewItem.${get(selectedIndex)?"Tooltip":"Disabled"}`)]),append($$anchor3,button_2)},"consequent_2");if_block(node_4,$$render=>{get(containsItems)&&$$render(consequent_2)})}append($$anchor2,div_2)},"consequent_3"),alternate=__name2($$anchor2=>{var section_1=root_6$3(),node_5=child(section_1);each(node_5,17,()=>$$props.state.choices,index,($$anchor3,choice)=>{choiceButton($$anchor3,()=>get(choice))});var node_6=sibling(node_5,2);{var consequent_4=__name2($$anchor3=>{choiceButton($$anchor3,()=>get(droppedOption))},"consequent_4");if_block(node_6,$$render=>{get(droppedOption)&&$$render(consequent_4)})}append($$anchor2,section_1)},"alternate");if_block(node_2,$$render=>{get(selectMenu)?$$render(consequent_3):$$render(alternate,!1)})}var node_7=sibling(node_2,2);{var consequent_5=__name2($$anchor2=>{var div_3=root_9$1(),i=child(div_3);set_attribute(i,"aria-label",game.i18n.localize("PF2E.UI.RuleElements.ChoiceSet.DragHomebrewItem"));var span_1=sibling(i,2);span_1.textContent=game.i18n.localize("PF2E.UI.RuleElements.ChoiceSet.HomebrewItem"),append($$anchor2,div_3)},"consequent_5");if_block(node_7,$$render=>{get(includeDropZone)&&!get(droppedOption)&&$$render(consequent_5)})}var node_8=sibling(section,2);{var consequent_6=__name2($$anchor2=>{var button_3=root_10();button_3.__click=[on_click_3$1,$$props,selectedChoice],button_3.textContent=game.i18n.localize("PF2E.UI.RuleElements.ChoiceSet.SaveLabel"),append($$anchor2,button_3)},"consequent_6"),alternate_1=__name2($$anchor2=>{var fragment_2=comment(),node_9=first_child(fragment_2);{var consequent_7=__name2($$anchor3=>{var button_4=root_12(),span_2=child(button_4);span_2.textContent=game.i18n.localize("PF2E.UI.RuleElements.ChoiceSet.Decline"),append($$anchor3,button_4)},"consequent_7");if_block(node_9,$$render=>{get(allowNoSelection)&&$$render(consequent_7)},!0)}append($$anchor2,fragment_2)},"alternate_1");if_block(node_8,$$render=>{get(selectMenu)?$$render(consequent_6):$$render(alternate_1,!1)})}template_effect(()=>set_text(text_1,$$props.state.prompt)),event$1("drop",div_1,function(...$$args){(get(includeDropZone)?handleDrop:null)?.apply(this,$$args)}),append($$anchor,div_1),pop()}__name(App$2,"App$2"),__name2(App$2,"App$2"),delegate(["click"]);class PickAThingPrompt extends SvelteApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"PickAThingPrompt")}static{__name2(this,"PickAThingPrompt")}constructor(data){super(data),this.item=data.item,this.prompt=data.prompt,this.choices=data.choices??[],this.containsItems=!!data.containsItems,this.allowedDrops=this.containsItems?data.allowedDrops??null:null,this.allowNoSelection=!!data.allowNoSelection,this.options.window.title=data.title}static DEFAULT_OPTIONS={window:{icon:"fa-solid fa-question-circle"}};root=App$2;#resolve;item;prompt;choices;containsItems;allowedDrops;allowNoSelection;selection=null;async _prepareContext(){return{foundryApp:this,updateSelection:__name2(result=>{this.selection=result},"updateSelection"),resolve:__name2(result=>{this.selection=result,this.close()},"resolve"),testAllowedDrop:__name2(droppedItem=>{if(!this.allowedDrops)return!1;const{label,predicate}=this.allowedDrops,isAllowed=!!predicate.test(droppedItem.getRollOptions("item"));return isAllowed||ui.notifications.error(game.i18n.format("PF2E.Item.ABC.InvalidDrop",{badType:droppedItem.name,goodType:game.i18n.localize(label??"")})),isAllowed},"testAllowedDrop"),state:{prompt:this.prompt,includeDropZone:!!this.allowedDrops,allowNoSelection:this.allowNoSelection,selectMenu:this.choices.length>9,containsItems:this.containsItems,choices:this.choices}}}async resolveSelection(){const firstChoice=this.choices.at(0);return!this.allowedDrops&&firstChoice&&this.choices.length===1?firstChoice:(this.render(!0),new Promise(resolve=>{this.#resolve=resolve}))}_onClose(options){this.#resolve?.(this.selection),super._onClose(options)}}const fields$R=foundry.data.fields;class ChoiceSetRuleElement extends RuleElement{static{__name(this,"ChoiceSetRuleElement")}static{__name2(this,"ChoiceSetRuleElement")}containsItems=!1;selection=null;constructor(data,options){if(super(data,options),this.allowedDrops??=null,this.allowNoSelection??=!1,this.rollOption??=this.slug,!this.invalid)if(this.flag=this.#setDefaultFlag(this),this.selection=typeof data.selection=="string"||typeof data.selection=="number"||e$2(data.selection)?data.selection:null,e$3(this.choices)&&!Array.isArray(this.choices)&&!("filter"in this.choices)&&(this.choices.predicate=new Predicate(this.choices.predicate??[]),this.choices.unarmedAttacks&&this.choices.predicate.push("item:category:unarmed")),!this.ignored&&this.selection===null&&!this.allowNoSelection&&this.test()&&(this.ignored=!0),this.ignored&&!this.allowNoSelection)for(const ruleData of this.item.system.rules)ruleData.ignored=!0;else this.selection!==void 0&&(this.#setRollOption(this.selection),this.item.flags.pf2e.rulesSelections[this.flag]=this.selection,this.actorFlag&&(this.actor.flags.pf2e[this.flag]=this.selection))}static defineSchema(){return{...super.defineSchema(),choices:new DataUnionField([new StrictArrayField(new StrictObjectField({required:!0,nullable:!1,initial:void 0}),{required:!0,nullable:!1,initial:void 0}),new StrictObjectField({required:!0,nullable:!1,initial:void 0}),new StrictStringField({required:!0,nullable:!1,initial:void 0})],{required:!0,nullable:!1,initial:void 0}),selection:new DataUnionField([new StrictStringField({required:!0,nullable:!1,initial:void 0}),new StrictNumberField({required:!0,nullable:!1,initial:void 0}),new StrictBooleanField({required:!0,nullable:!1,initial:void 0}),new StrictObjectField({required:!0,nullable:!1,initial:void 0})],{required:!1,nullable:!0,initial:void 0}),prompt:new fields$R.StringField({required:!1,blank:!1,nullable:!1,initial:"PF2E.UI.RuleElements.ChoiceSet.Prompt"}),adjustName:new DataUnionField([new StrictBooleanField({required:!0,nullable:!1,initial:void 0}),new StrictStringField({required:!0,nullable:!1,initial:void 0})],{required:!0,nullable:!1,initial:!0}),allowedDrops:new fields$R.SchemaField({label:new fields$R.StringField({required:!0,blank:!1,nullable:!0,initial:null}),predicate:new PredicateField},{required:!1,nullable:!0,initial:void 0}),flag:new fields$R.StringField({required:!1,blank:!1,nullable:!1,initial:void 0}),actorFlag:new fields$R.BooleanField({required:!1}),rollOption:new fields$R.StringField({required:!1,blank:!1,nullable:!0,initial:null}),allowNoSelection:new StrictBooleanField({required:!1,nullable:!1,initial:void 0})}}async preCreate({itemSource,ruleSource,tempItems}){if(this.selection===null&&e$3(this.choices)&&"query"in this.choices){this.failValidation("As of FVTT version 11, choice set queries are no longer supported.");for(const ruleData of this.item.system.rules)ruleData.ignored=!0;return}if(this.item.isOfType("feat")&&this.item.suppressed)return;const rollOptions=new Set([this.actor.getRollOptions(),this.item.getRollOptions("parent")].flat());if(!this.resolveInjectedProperties(this.predicate).test(rollOptions))return;if(e$3(this.choices)){const choices=this.choices;if("ownedItems"in choices&&choices.ownedItems&&!choices.types?.length){console.warn("PF2E System | Failure during ChoiceSet preCreate: `types` is required if `ownedItems` is set"),ruleSource.ignored=!0;return}}this.#setDefaultFlag(ruleSource),this.choices=await this.inflateChoices(rollOptions,tempItems);const selection=this.#getPreselection(this.choices)??await new PickAThingPrompt({prompt:game.i18n.localize(this.prompt),item:this.item,title:this.label,choices:this.choices,containsItems:this.containsItems,allowedDrops:this.allowedDrops,allowNoSelection:this.allowNoSelection}).resolveSelection();if(selection){if(this.selection=ruleSource.selection=selection.value,itemSource.name=this.#adjustName(itemSource.name,selection),this.item.flags.pf2e.rulesSelections[this.flag]=selection.value,this.actorFlag&&(this.actor.flags.pf2e[this.flag]=selection.value),typeof ruleSource.rollOption=="string"&&UUIDUtils.isItemUUID(selection.value)){const item=await fromUuid(selection.value);if(item instanceof ItemPF2e){const slug=item.slug??sluggify(item.name);this.rollOption=ruleSource.rollOption=`${ruleSource.rollOption}:${slug}`}}this.#setRollOption(ruleSource.selection);for(const rule of this.item.rules)rule.ignored=!1}else this.choices.length>0&&!this.allowNoSelection&&ui.notifications.warn("PF2E.UI.RuleElements.Prompt.NoSelectionMade",{format:{item:this.item.name}}),ruleSource.ignored=!0}#setDefaultFlag(source2){return source2.flag=typeof source2.flag=="string"&&source2.flag.length>0?source2.flag.replace(/[^-a-z0-9]/gi,""):sluggify(this.slug??this.item.slug??this.item.name,{camel:"dromedary"})}async inflateChoices(rollOptions,tempItems){const validate=e(this.selection),choices=await(async()=>Array.isArray(this.choices)?this.#choicesFromArray(this.choices,rollOptions,validate):typeof this.choices=="string"||e$3(this.choices)&&this.choices.config?this.#choicesFromPath(this.choices,rollOptions,validate):e$3(this.choices)?this.choices.ownedItems?this.#choicesFromOwnedItems(this.choices,rollOptions,tempItems):this.choices.attacks||this.choices.unarmedAttacks?this.#choicesFromAttacks(new Predicate(this.resolveInjectedProperties(this.choices.predicate)),rollOptions):"filter"in this.choices&&Array.isArray(this.choices.filter)?await this.queryCompendium(this.choices,rollOptions,tempItems):[]:[])(),choicesAreUUIDs=choices.every(c=>UUIDUtils.isItemUUID(c.value));if(choicesAreUUIDs){const items=await UUIDUtils.fromUUIDs(choices.map(c=>c.value));for(const choice of choices){const item=items.find(i=>i.uuid===choice.value);item instanceof ItemPF2e?(choice.label??=item.name,choice.img??=item.img):(choice.label="???",choice.img="broken.jpeg")}}(choicesAreUUIDs||this.allowedDrops||e$3(this.choices)&&"query"in this.choices)&&(this.containsItems=!0);try{const choiceData=choices.map(c=>({value:c.value,label:game.i18n.localize(c.label),img:c.img}));return Array.isArray(this.choices)||choiceData.sort((a,b)=>a.label.localeCompare(b.label)),choiceData}catch{return[]}}#choicesFromArray(choices,actorRollOptions,validate){return validate?choices.filter(c=>this.resolveInjectedProperties(new Predicate(c.predicate??[])).test(actorRollOptions)):choices}#choicesFromPath(pathOrConfig,actorRollOptions,validate){const data=typeof pathOrConfig=="string"?foundry.utils.getProperty(CONFIG.PF2E,pathOrConfig)??foundry.utils.getProperty(this.actor,pathOrConfig)??{}:foundry.utils.getProperty(CONFIG.PF2E,pathOrConfig.config)??{},choices=processChoicesFromData(data),predicate=!validate||typeof pathOrConfig=="string"?null:pathOrConfig.predicate;return validate?choices.filter(choice=>this.resolveInjectedProperties(new Predicate(choice.predicate??foundry.utils.deepClone(predicate??[])),{injectables:{choice}}).test(actorRollOptions)):choices}#choicesFromOwnedItems(options,actorRollOptions,tempItems){const{includeHandwraps,types}=options,predicate=new Predicate(this.resolveInjectedProperties(options.predicate)),choices=[...iterateAllItems(this.actor)].filter(i=>i.isOfType(...types)&&predicate.test([...actorRollOptions,...i.getRollOptions("item")])).filter(i=>!i.isOfType("weapon")||i.category!=="unarmed").map(i=>({img:i.img,label:i.name,value:i.id}));return includeHandwraps&&choices.push(...this.actor.itemTypes.weapon.filter(i=>i.system.traits.otherTags.includes("handwraps-of-mighty-blows")&&predicate.test([...actorRollOptions,...i.getRollOptions("item")])).map(h=>({img:h.img,label:h.name,value:"unarmed"}))),choices.push(...tempItems.filter(i=>i.isOfType(...types)&&predicate.test([...actorRollOptions,...i.getRollOptions("item")])).filter(i=>!i.isOfType("weapon")||i.category!=="unarmed").map(i=>({img:i.img,label:i.name,value:i.id}))),choices}#choicesFromAttacks(predicate,actorRollOptions){return this.actor.isOfType("character","npc")?this.actor.system.actions.filter(a=>a.item.isOfType("melee","weapon")&&predicate.test([...actorRollOptions,...a.item.getRollOptions("item")])).map(a=>({img:a.item.img,label:a.item.name,value:a.item.slug??sluggify(a.item.name)})):[]}async queryCompendium(choices,actorRollOptions,tempItems){const filter=Array.isArray(choices.filter)?new Predicate(this.resolveInjectedProperties(choices.filter)):new Predicate;if(!filter.isValid||filter.length===0)return this.failValidation("`filter` must be an array with at least one statement"),[];const itemType=objectHasKey(CONFIG.PF2E.Item.documentClasses,choices.itemType)?choices.itemType:"feat",packs=typeof choices.pack=="string"?[game.packs.get(choices.pack)].filter(e$1):game.packs.filter(p=>p.metadata.type==="Item"&&p.index.some(e2=>e2.type===itemType)),progress=ui.notifications.info("",{progress:!0}),increment2=1/packs.length,localize=localizer("PF2E.ProgressBar"),indexData=[];for(const pack of packs)progress.update({message:localize("LoadingPack",{pack:pack.metadata.label}),pct:progress.pct+increment2}),indexData.push(await pack.getIndex({fields:["flags","system.ancestry","system.baseItem","system.category","system.damage.damageType","system.group","system.level","system.maxTakable","system.range","system.runes","system.sanctification","system.slug","system.traits","system.usage"]}));progress.update({message:localize("LoadingComplete"),pct:1});const parentRollOptions=this.item.getRollOptions("parent"),filteredItems=indexData.flatMap(d=>d.contents).filter(s=>s.type===itemType).map(source2=>{const parsedUUID=foundry.utils.parseUuid(source2.uuid),pack=parsedUUID?.collection instanceof foundry.documents.collections.CompendiumCollection?parsedUUID.collection.metadata.id:null;return new ItemProxyPF2e(foundry.utils.deepClone(source2),{pack})}).concat(game.items.filter(i=>i.type===itemType)).filter(i=>filter.test([...i.getRollOptions("item"),...parentRollOptions,...actorRollOptions])),existing=new Map,actor=this.actor;for(const feat of actor.itemTypes.feat){const slug=feat.slug??sluggify(feat.name);existing.set(slug,(existing.get(slug)??0)+1)}for(const feat of tempItems.filter(i=>i.type==="feat")){const slug=feat.slug??sluggify(feat.name);existing.set(slug,(existing.get(slug)??0)+1)}return filteredItems.filter(item=>{const slug=item.slug??sluggify(item.name);return item.isOfType("feat")?(existing.get(slug)??0)<item.maxTakable:item.isOfType("heritage")?!actor.itemTypes.heritage.some(h=>(h.slug??sluggify(h.name))===slug):!0}).map(f=>({value:choices.slugsAsValues?f.slug??sluggify(f.name):f.uuid,label:f.name,img:f.img}))}#getPreselection(inflatedChoices){return this.selection===null?null:inflatedChoices.find(c=>t$6(this.selection,c.value))??null}#setRollOption(selection){if(!(this.rollOption&&(typeof selection=="string"||typeof selection=="number")))return;const suffix=UUIDUtils.isItemUUID(selection)?"":`:${selection}`;this.actor.rollOptions.all[`${this.rollOption}${suffix}`]=!0,this.parent.specialOptions.push(`${this.rollOption}${suffix}`)}#adjustName(original,selection){if(this.adjustName===!0){const label=game.i18n.localize(selection.label),newName=`${original} (${label})`,pattern=(()=>{const escaped=RegExp.escape(label);return new RegExp(`\\(${escaped}\\) \\(${escaped}\\)$`)})();return newName.replace(pattern,`(${label})`)}else if(typeof this.adjustName=="string"){const priorChoiceSets=t$9(this.item.rules.filter(r2=>r2 instanceof ChoiceSetRuleElement&&r2!==this&&Array.isArray(r2.choices)&&r2.selection!==null),cs=>[cs.flag,game.i18n.localize(Array.from(cs.choices).find(c=>c.value===cs.selection)?.label??"")]);return game.i18n.format(this.adjustName,{[this.flag]:game.i18n.localize(selection.label),...priorChoiceSets})}return original}}const fields$Q=foundry.data.fields;class CraftingAbilityRuleElement extends RuleElement{static{__name(this,"CraftingAbilityRuleElement")}static{__name2(this,"CraftingAbilityRuleElement")}static validActorTypes=["character"];constructor(data,options){super({priority:19,...data},options),!this.slug&&!this.resource?this.failValidation("Either a resource or a slug is required"):this.resource&&(this.slug??=this.resource),this.maxSlots&&this.resource&&this.failValidation("Only one of resource or maxSlots is allowed"),(this.isAlchemical||this.isDailyPrep)&&(this.isPrepared=!0)}static defineSchema(){return{...super.defineSchema(),resource:new fields$Q.StringField({required:!1,nullable:!0,blank:!1,initial:null}),isAlchemical:new fields$Q.BooleanField,isDailyPrep:new fields$Q.BooleanField,isPrepared:new fields$Q.BooleanField,batchSizes:new fields$Q.SchemaField({default:new fields$Q.NumberField({required:!1,min:1,max:99}),other:new fields$Q.ArrayField(new fields$Q.SchemaField({quantity:new fields$Q.NumberField({required:!0,nullable:!1,positive:!0,integer:!0,initial:2,min:1,max:99}),definition:new PredicateField}))},{initial:__name2(d=>({default:d.isAlchemical?2:1,other:[]}),"initial")}),maxItemLevel:new ResolvableValueField({required:!1,nullable:!1}),maxSlots:new ResolvableValueField({required:!1,nullable:!1}),craftableItems:new PredicateField,prepared:new fields$Q.ArrayField(new fields$Q.SchemaField({uuid:new fields$Q.DocumentUUIDField({required:!0,blank:!1}),quantity:new fields$Q.NumberField({required:!1,nullable:!1,initial:void 0}),expended:new fields$Q.BooleanField({required:!1,initial:void 0}),isSignatureItem:new fields$Q.BooleanField({required:!1,initial:void 0})},{required:!0,nullable:!1}),{initial:[]})}}onApplyActiveEffects(){if(this.ignored)return;const slug=this.resolveInjectedProperties(this.slug),key=sluggify(slug,{camel:"dromedary"}),maxSlots=this.maxSlots!==void 0?Math.floor(Number(this.resolveValue(this.maxSlots))):null,maxItemLevel=Number(this.resolveValue(this.maxItemLevel)),existing=this.actor.system.crafting.entries[key];if(existing){this.label!==this.item.name&&(existing.label=this.label),existing.craftableItems??=[],this.craftableItems.length>0&&existing.craftableItems.push({predicate:this.craftableItems});for(const other of this.batchSizes.other)existing.craftableItems.push({predicate:other.definition,batchSize:other.quantity});existing.batchSize=Math.max(existing.batchSize,this.batchSizes?.default||1),existing.maxItemLevel=Math.max(maxItemLevel,existing.maxItemLevel),existing.maxSlots=(existing.maxSlots??maxSlots)===null?null:Math.max(existing.maxSlots??0,maxSlots??0),existing.preparedFormulaData??=this.prepared}else this.actor.system.crafting.entries[key]={slug,resource:this.resource,label:this.label,isAlchemical:this.isAlchemical,isDailyPrep:this.isDailyPrep,isPrepared:this.isPrepared,batchSize:this.batchSizes.default??(this.isAlchemical?2:1),craftableItems:[{predicate:this.craftableItems},...this.batchSizes.other.map(o=>({predicate:o.definition,batchSize:o.quantity}))].filter(i=>i.predicate.length),maxItemLevel:maxItemLevel||this.actor.level,maxSlots,preparedFormulaData:this.prepared},this.actor.rollOptions.all[`crafting:entry:${slug}`]=!0}afterPrepareData(){if(!this.ignored&&!this.isPrepared&&this.item.isOfType("feat","action")&&this.item.actionCost){const ability=this.actor.crafting.abilities.get(this.slug);ability&&ability.craftableItems.length&&(this.item.crafting=ability)}}}const fields$P=foundry.data.fields;class CritSpecRuleElement extends RuleElement{static{__name(this,"CritSpecRuleElement")}static{__name2(this,"CritSpecRuleElement")}static validActorTypes=["character","npc"];static defineSchema(){return{...super.defineSchema(),alternate:new fields$P.BooleanField,text:new fields$P.StringField({blank:!1,nullable:!0,initial:null}),damageDice:new fields$P.SchemaField({number:new ResolvableValueField({required:!0,nullable:!1,initial:void 0}),faces:new fields$P.NumberField({required:!0,nullable:!1,choices:[4,6,8,10,12],initial:void 0}),damageType:new fields$P.StringField({required:!1,nullable:!0,choices:__name2(()=>CONFIG.PF2E.damageTypes,"choices"),initial:null}),category:new fields$P.StringField({required:!1,nullable:!0,choices:DAMAGE_CATEGORIES_UNIQUE,initial:null})},{required:!1,nullable:!0,initial:null}),modifier:new fields$P.SchemaField({type:new fields$P.StringField({required:!0,nullable:!1,choices:Array.from(MODIFIER_TYPES),initial:"untyped"}),damageType:new fields$P.StringField({required:!1,nullable:!0,choices:__name2(()=>CONFIG.PF2E.damageTypes,"choices"),initial:null}),category:new fields$P.StringField({required:!1,nullable:!0,choices:Array.from(DAMAGE_CATEGORIES_UNIQUE),initial:null}),value:new ResolvableValueField({required:!0,nullable:!1,initial:void 0})},{required:!1,nullable:!0,initial:null})}}static validateJoint(data){if(super.validateJoint(data),data.alternate&&!data.text&&!data.damageDice&&!data.modifier)throw Error("alternate: must also include at least one of text, damage dice, or modifier");if(!data.alternate&&(data.text||data.damageDice||data.modifier)){const badProperty=["text","damageDice","modifier"].find(k=>data[k]);throw Error(`${badProperty}: may only be used if alternate is true`)}}beforePrepareData(){if(this.ignored)return;const synthetic=__name2((weapon,options)=>this.resolveInjectedProperties(this.predicate).test(options)?this.#getEffect(weapon):null,"synthetic");this.ignored||this.actor.synthetics.criticalSpecializations[this.alternate?"alternate":"standard"].push(synthetic)}#getEffect(weapon){const text2=this.text?this.resolveInjectedProperties(this.text.trim()):null,slug="critical-specialization",label="PF2E.Actor.Creature.CriticalSpecialization",note=__name2(()=>this.alternate&&!this.text?null:new RollNotePF2e({selector:"strike-damage",title:label,text:text2??`PF2E.Item.Weapon.CriticalSpecialization.${weapon.group}`,outcome:["criticalSuccess"]}),"note"),resolveInteger=__name2((value,fallback)=>{const resolved=this.resolveValue(value,0,{resolvables:{weapon}});return Math.clamp(Math.trunc(Math.abs(Number(resolved))),1,10)||fallback},"resolveInteger"),damageDice=__name2(()=>this.alternate&&this.damageDice?new DamageDicePF2e({slug,label,selector:"strike-damage",diceNumber:resolveInteger(this.damageDice.number,1),dieSize:`d${this.damageDice.faces}`,damageType:this.damageDice.damageType,category:this.damageDice.category,critical:!0}):null,"damageDice"),modifier=__name2(()=>this.alternate&&this.modifier?new Modifier({slug,label,type:this.modifier.type,modifier:resolveInteger(this.modifier.value,0),damageType:this.modifier.damageType,damageCategory:this.modifier.category,critical:!0}):null,"modifier");if(this.alternate)return[note(),damageDice(),modifier()].filter(e$1);switch(weapon.group){case"crossbow":case"dart":case"knife":{const dice=new DamageDicePF2e({slug,selector:"strike-damage",label,damageType:"bleed",diceNumber:1,dieSize:weapon.group==="crossbow"?"d8":"d6",critical:!0}),bonusValue=weapon.isOfType("melee")?weapon.linkedWeapon?.system.runes.potency??0:weapon.flags.pf2e.attackItemBonus,bonus=bonusValue>0?new Modifier({slug,label,type:"item",damageType:"bleed",modifier:bonusValue,critical:!0}):null;return[dice,bonus??[]].flat()}case"pick":return weapon.baseDamage.die?[new Modifier({slug,label,type:"untyped",modifier:2*weapon.baseDamage.dice,critical:!0})]:[];default:return weapon.group?[note()].filter(e$1):[]}}}class DamageAlteration{static{__name(this,"DamageAlteration")}static{__name2(this,"DamageAlteration")}#rule;slug;property;value;constructor(rule){this.#rule=rule,this.slug=rule.slug,this.property=rule.property,this.value=rule.value}getNewValue(damage,item){const rule=this.#rule,resolvables=item?{[item.type==="action"?"ability":item.type]:item}:{},change=rule.resolveValue?.(rule.value,null,{resolvables})??rule.value;if(rule.ignored)return null;switch(rule.property){case"damage-type":return setHasElement(DAMAGE_TYPES,change)?change:null;case"dice-number":return"diceNumber"in damage&&typeof change=="number"?Math.clamp(Math.floor(AELikeRuleElement.getNewValue(rule.mode,damage.diceNumber??0,change)),0,99):null;case"dice-faces":{if(!("dieSize"in damage)||!damage.dieSize)return null;const currentFaces=damageDieSizeToFaces(damage.dieSize);return rule.mode==="downgrade"?tupleHasValue(DAMAGE_DICE_FACES,change)&&change<=currentFaces?change:Number(nextDamageDieSize({downgrade:damage.dieSize}).replace("d","")):rule.mode==="upgrade"?tupleHasValue(DAMAGE_DICE_FACES,change)&&change>=currentFaces?change:Number(nextDamageDieSize({upgrade:damage.dieSize}).replace("d","")):rule.mode==="override"&&tupleHasValue(DAMAGE_DICE_FACES,change)?change:null}case"tags":{const changes=Array.isArray(change)?change:[change],tags=damage.tags??[];switch(rule.mode){case"add":return tags.push(...changes),tags;case"remove":case"subtract":{for(const tag of changes){const index2=tags.indexOf(tag);index2>-1&&tags.splice(index2,1)}return tags}case"override":return changes;default:return null}}}}applyTo(damage,options){const rule=this.#rule;if(rule.ignored)return damage;const isModifier="value"in damage&&["dice-faces","dice-number"].includes(this.property),isOverrideDice=!("value"in damage)&&!damage.damageType&&!damage.diceNumber&&!damage.dieSize&&damage.override;if(isModifier||isOverrideDice)return damage;const parent=rule.parent??{getRollOptions:__name2(()=>[],"getRollOptions")},predicate=rule.predicate??new Predicate;if(!(predicate.length===0||predicate.test([...options.test,...damage.getRollOptions(),...parent.getRollOptions("parent")])))return damage;const value=this.value=this.getNewValue(damage,options.item);if(rule.property==="tags"&&Array.isArray(value))damage.tags=value;else if(typeof value=="string")damage.damageType=value;else if(this.property==="dice-faces"&&"dieSize"in damage&&tupleHasValue(DAMAGE_DICE_FACES,value)){const stringValue=`d${value}`;if(this.#rule.slug==="base"&&this.#rule.mode==="upgrade"&&damage.dieSize!==stringValue&&options.item.isOfType("weapon")){if(options.item.flags.pf2e.damageFacesUpgraded)return damage;options.item.flags.pf2e.damageFacesUpgraded=!0}damage.dieSize=stringValue}else this.property==="dice-number"&&"diceNumber"in damage&&typeof value=="number"&&(damage.diceNumber=value);return damage}}const fields$O=foundry.data.fields;class DamageAlterationRuleElement extends RuleElement{static{__name(this,"DamageAlterationRuleElement")}static{__name2(this,"DamageAlterationRuleElement")}static autogenForms=!0;static defineSchema(){return{...super.defineSchema(),selectors:new fields$O.SetField(new fields$O.StringField({required:!0,blank:!1}),{min:1}),mode:new fields$O.StringField({required:!0,choices:t$4(AELikeRuleElement.CHANGE_MODE_DEFAULT_PRIORITIES),initial:"add"}),property:new fields$O.StringField({required:!0,nullable:!1,choices:["damage-type","dice-faces","dice-number","tags"]}),value:new ResolvableValueField({required:!0,nullable:!0,initial:null,validate:__name2((value,options)=>{if(typeof value=="string"&&/^\{\w+\|.+\}$/.test(value))return!0;switch(options.source?.property){case"damage-type":if(!setHasElement(DAMAGE_TYPES,value))throw Error("must be a damage type or resolvable to one");break;case"dice-faces":{if(typeof value=="string"&&/|@.+\..+/.test(value))return!0;const faces=Number(value);if(!Number.isInteger(faces))throw Error("must be an integer or resolvable to one");if(options.source?.mode==="override"&&!tupleHasValue(DAMAGE_DICE_FACES,faces)){const list=game.i18n.getListFormatter({type:"disjunction"}).format(DAMAGE_DICE_FACES.map(f=>f.toString()));throw Error(`must override dice faces to ${list}`)}break}case"dice-number":{if(typeof value=="string"&&/|@.+\..+/.test(value))return!0;const number=Number(value);if(!Number.isInteger(number))throw Error("must be an integer or resolvable to one")}}return!0},"validate")}),relabel:new fields$O.StringField({required:!1,blank:!1,nullable:!0,initial:null})}}static LOCALIZATION_PREFIXES=["PF2E.RULES.Common","PF2E.RULES.DamageAlteration"];resolveValue(value,defaultValue,options){const resolved=super.resolveValue(value,defaultValue,options);if(this.ignored||!(typeof resolved=="number"||typeof resolved=="string"||Array.isArray(resolved)||resolved===null))return null;if(!{"damage-type":typeof resolved=="string"&&DAMAGE_TYPES.has(resolved),"dice-faces":resolved===null||tupleHasValue(DAMAGE_DICE_FACES,resolved),"dice-number":typeof resolved=="number"&&Number.isInteger(resolved)&&resolved.between(0,99),tags:typeof resolved=="string"&&resolved===sluggify(resolved)||Array.isArray(resolved)&&resolved.every(t2=>typeof t2=="string"&&t2===sluggify(t2))}[this.property]){const message={"damage-type":`value: must be a damage type (resolved to ${resolved})`,"dice-faces":`value: must be one of 4, 6, 8, 10, and 12 (resolved to ${resolved})`,"dice-number":`value: must be a positive integer less than 100 (resolved to ${resolved})`,tags:`value: must be a slug or array of slugs (resolved to ${resolved})`};return this.failValidation(message[this.property]),null}return resolved}beforePrepareData(){if(this.ignored)return;const alteration=new DamageAlteration(this),selectors=this.selectors.values().toArray();for(const selector of this.resolveInjectedProperties(selectors))(this.actor.synthetics.damageAlterations[selector]??=[]).push(alteration)}}const fields$N=foundry.data.fields;class DamageDiceRuleElement extends RuleElement{static{__name(this,"DamageDiceRuleElement")}static{__name2(this,"DamageDiceRuleElement")}constructor(data,options){super(data,options),!this.invalid&&data.override&&!this.#isValidOverride(data.override)&&(this.failValidation("The override property must be an object with one property of 'upgrade' (boolean),","'downgrade (boolean)', 'diceNumber' (integer between 0 and 10), 'dieSize' (d6-d12), or 'damageType'","(recognized damage type)"),this.override=null)}static defineSchema(){return{...super.defineSchema(),selector:new fields$N.ArrayField(new fields$N.StringField({required:!0,blank:!1})),diceNumber:new ResolvableValueField({required:!0,nullable:!0,initial:null}),dieSize:new fields$N.StringField({required:!0,blank:!1,nullable:!0,initial:null}),damageType:new fields$N.StringField({required:!0,nullable:!0,blank:!1,initial:null}),critical:new NullableBooleanField({required:!0,nullable:!0,initial:null}),category:new fields$N.StringField({choices:["persistent","precision","splash"],required:!0,nullable:!0,blank:!1,initial:null}),tags:new fields$N.ArrayField(new SlugField({required:!0,blank:!1}),{required:!0}),override:new fields$N.ObjectField({required:!1,nullable:!0,initial:void 0}),hideIfDisabled:new fields$N.BooleanField,battleForm:new fields$N.BooleanField}}beforePrepareData(){if(!this.ignored)for(const selector of this.resolveInjectedProperties(this.selector)){if(selector==="null")continue;const{actor,parent}=this,deferredDice=__name2(options=>{const label=this.getReducedLabel();this.battleForm&&!this.predicate.includes("battle-form")&&this.predicate.push("battle-form");const testPassed=this.predicate.length===0||this.resolveInjectedProperties(this.predicate).test([...options.test??actor.getRollOptions(options.selectors),...parent.getRollOptions("parent")]),resolveOptions={...options,warn:testPassed},diceNumber=Number(this.resolveValue(this.diceNumber,0,resolveOptions))||0;if(this.ignored)return null;const damageType=this.resolveInjectedProperties(this.damageType,resolveOptions);if(damageType!==null&&!objectHasKey(CONFIG.PF2E.damageTypes,damageType))return testPassed&&this.failValidation(`Unrecognized damage type: ${damageType}`),null;if(this.override){const override=this.override;if(override.damageType&&=this.resolveInjectedProperties(override.damageType,resolveOptions),"damageType"in override&&!objectHasKey(CONFIG.PF2E.damageTypes,override.damageType))return testPassed&&this.failValidation("Unrecognized damage type in override"),null;if(override.diceNumber&&=Math.floor(Number(this.resolveValue(override.diceNumber,NaN,resolveOptions))),Number.isNaN(override.diceNumber))return null;if(typeof override.diceNumber=="number"&&override.diceNumber<0)return testPassed&&this.failValidation("A dice number must resolve to at least zero"),null;if(override.dieSize&&=this.resolveInjectedProperties(override.dieSize,resolveOptions),"dieSize"in override&&!tupleHasValue(DAMAGE_DIE_SIZES,override.dieSize))return testPassed&&this.failValidation("Unrecognized die size in override"),null}const dieSize=this.resolveInjectedProperties(this.dieSize,resolveOptions);if(dieSize!==null&&!tupleHasValue(DAMAGE_DIE_SIZES,dieSize))return testPassed&&this.failValidation("Die size must be a recognized damage die size, null, or omitted"),null;const slug=this.slug??sluggify(parent.name),alterationsRecord=actor.synthetics.damageAlterations,alterations=extractDamageAlterations(alterationsRecord,options.selectors,slug);return new DamageDicePF2e({selector,slug,label,diceNumber,dieSize,critical:this.critical,category:this.category,damageType,predicate:this.predicate,tags:this.tags,override:foundry.utils.deepClone(this.override),enabled:testPassed,hideIfDisabled:this.hideIfDisabled,alterations})},"deferredDice");(actor.synthetics.damageDice[selector]??=[]).push(deferredDice)}}#isValidOverride(override){return override===void 0?!0:e$2(override)&&(typeof override.upgrade=="boolean"&&!("downgrade"in override)||typeof override.downgrade=="boolean"&&!("upgrade"in override)||typeof override.damageType=="string"||typeof override.dieSize=="string"||typeof override.diceNumber=="string"||typeof override.diceNumber=="number"&&Number.isInteger(override.diceNumber)&&override.diceNumber>=0&&override.diceNumber<=256)}}class DexterityModifierCapRuleElement extends RuleElement{static{__name(this,"DexterityModifierCapRuleElement")}static{__name2(this,"DexterityModifierCapRuleElement")}static validActorTypes=["character","npc"];static autogenForms=!0;static defineSchema(){return{...super.defineSchema(),value:new ResolvableValueField({required:!0,nullable:!1})}}beforePrepareData(){if(!this.test())return;const value=this.resolveValue(this.value);if(typeof value!="number")return this.failValidation("value must be a number");this.actor.synthetics.dexterityModifierCaps.push({value,source:this.label})}}const fields$M=foundry.data.fields;class EphemeralEffectRuleElement extends RuleElement{static{__name(this,"EphemeralEffectRuleElement")}static{__name2(this,"EphemeralEffectRuleElement")}static defineSchema(){const alterationField=new fields$M.EmbeddedDataField(ItemAlteration);return{...super.defineSchema(),affects:new fields$M.StringField({required:!0,choices:["target","origin"],initial:"target"}),selectors:new fields$M.ArrayField(new fields$M.StringField({required:!0,blank:!1,nullable:!1,initial:void 0})),uuid:new fields$M.StringField({required:!0,blank:!1,nullable:!1,initial:void 0}),adjustName:new fields$M.BooleanField({required:!0,nullable:!1,initial:!0}),alterations:new fields$M.ArrayField(alterationField,{required:!1,nullable:!1,initial:[]})}}static validateJoint(data){if(super.validateJoint(data),data.selectors.length===0)throw Error("must have at least one selector")}afterPrepareData(){for(const selector of this.resolveInjectedProperties(this.selectors)){const deferredEffect=this.#createDeferredEffect();(this.actor.synthetics.ephemeralEffects[selector]??={target:[],origin:[]})[this.affects].push(deferredEffect)}}#createDeferredEffect(){return async(params={})=>{if(!this.test(params.test??this.actor.getRollOptions()))return null;const uuid=this.resolveInjectedProperties(this.uuid);if(!UUIDUtils.isItemUUID(uuid))return this.failValidation(`"${uuid}" does not look like a UUID`),null;const effect=game.pf2e.ConditionManager.conditions.get(uuid)??await fromUuid(uuid);if(!(effect instanceof ItemPF2e&&effect.isOfType("condition","effect")))return this.failValidation(`unable to find effect or condition item with uuid "${uuid}"`),null;const source2=effect.toObject();if(source2.system.rules.some(r2=>typeof r2.key=="string"&&(r2.key==="ChoiceSet"||r2.key==="GrantItem"&&!("inMemoryOnly"in r2&&r2.inMemoryOnly===!0)))&&this.failValidation("an ephemeral effect may not include a choice set or grant"),this.adjustName){const label=this.getReducedLabel();source2.name=`${source2.name} (${label})`}try{for(const alteration of this.alterations)alteration.applyTo(source2)}catch(error){return error instanceof Error&&this.failValidation(error.message),null}return source2}}}const fields$L=foundry.data.fields;class FastHealingRuleElement extends RuleElement{static{__name(this,"FastHealingRuleElement")}static{__name2(this,"FastHealingRuleElement")}static validActorTypes=["army","character","npc","familiar"];static defineSchema(){return{...super.defineSchema(),value:new ResolvableValueField({required:!0,nullable:!1}),type:new fields$L.StringField({required:!1,nullable:!1,choices:["fast-healing","regeneration"],initial:"fast-healing"}),details:new fields$L.StringField({required:!1,nullable:!0,blank:!1,initial:null}),deactivatedBy:new fields$L.ArrayField(new fields$L.StringField({required:!0,nullable:!1,blank:!1}),{required:!1,initial:void 0})}}static validateJoint(data){if(super.validateJoint(data),data.type==="fast-healing"){if(data.deactivatedBy)throw data.ignored=!0,Error("deactivatedBy is only valid for type regeneration");data.details&&(data.details=game.i18n.localize(data.details))}else if(data.type==="regeneration"){if(data.details)throw data.ignored=!0,Error("details is only valid for type fast-healing");if(data.deactivatedBy?.length){const typesArr=data.deactivatedBy.map(type2=>objectHasKey(CONFIG.PF2E.weaknessTypes,type2)?game.i18n.localize(CONFIG.PF2E.weaknessTypes[type2]):type2),types=localizeList(typesArr);data.details=game.i18n.format("PF2E.Encounter.Broadcast.FastHealing.DeactivatedBy",{types})}}}async onUpdateEncounter({event:event2}){if(this.ignored||event2!=="turn-start"||!this.test())return;const value=this.resolveValue(this.value);if(typeof value!="number"&&typeof value!="string")return this.failValidation("value must be a number or a roll formula");const receivedMessage=game.i18n.localize(`PF2E.Encounter.Broadcast.FastHealing.${this.type}.ReceivedMessage`),postFlavor=`<div data-visibility="owner">${this.details??this.getReducedLabel()}</div>`,flavor=`<div>${receivedMessage}</div>${postFlavor}`,roll=(await new DamageRoll(`{(${value})[healing]}`).evaluate()).toJSON(),rollMode=this.actor.hasPlayerOwner?"publicroll":"gmroll",speaker=ChatMessagePF2e.getSpeaker({actor:this.actor,token:this.token});ChatMessagePF2e.create({flavor,speaker,rolls:[roll]},{rollMode})}}const fields$K=foundry.data.fields;class FlatModifierRuleElement extends RuleElement{static{__name(this,"FlatModifierRuleElement")}static{__name2(this,"FlatModifierRuleElement")}constructor(source2,options){super(source2,options),!this.invalid&&(!this.item.isOfType("physical")&&this.type!=="item"&&(this.fromEquipment=!1),this.type==="ability"&&this.ability&&(this.slug=this.ability,this.label=CONFIG.PF2E.abilities[this.ability],this.value=`@actor.abilities.${source2.ability}.mod`),this.critical=typeof source2.critical=="boolean"&&this.selectors.some(s=>s.includes("damage"))?source2.critical:null,this.force&&this.type==="untyped"&&this.failValidation("type: may not be undefined"),this.removeAfterRoll&&!this.item.isOfType("effect")&&this.failValidation("removeAfterRoll: may only be used with effects"))}static validateJoint(data){if(super.validateJoint(data),data.selector.length===0)throw Error("selector: must have at least 1");if(data.type==="ability"&&!data.ability)throw Error("ability: must be defined");if(data.type!=="ability"&&data.value===void 0)throw Error("value: may not be undefined")}static defineSchema(){return{...super.defineSchema(),selector:new fields$K.ArrayField(new fields$K.StringField({required:!0,blank:!1,initial:void 0}),{required:!0,initial:void 0}),type:new fields$K.StringField({required:!0,choices:Array.from(MODIFIER_TYPES),initial:"untyped"}),ability:new fields$K.StringField({required:!1,choices:CONFIG.PF2E.abilities,initial:void 0}),min:new fields$K.NumberField({required:!1,nullable:!1,initial:void 0}),max:new fields$K.NumberField({required:!1,nullable:!1,initial:void 0}),force:new fields$K.BooleanField,hideIfDisabled:new fields$K.BooleanField,fromEquipment:new fields$K.BooleanField({required:!0,nullable:!1,initial:!0}),damageType:new fields$K.StringField({required:!1,nullable:!0,blank:!1,initial:void 0}),damageCategory:new fields$K.StringField({required:!1,blank:!1,choices:damageCategoriesUnique,initial:void 0}),critical:new fields$K.BooleanField({required:!1,nullable:!0,initial:null}),value:new ResolvableValueField({required:!1,nullable:!1,initial:void 0}),tags:new fields$K.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0}),{required:!1,nullable:!1}),removeAfterRoll:new DataUnionField([new StrictStringField({required:!1,nullable:!1,choices:["if-enabled"]}),new StrictBooleanField({required:!1,nullable:!1,initial:void 0}),new PredicateField({required:!1,nullable:!1,initial:void 0})],{required:!1,nullable:!1,initial:!1}),battleForm:new fields$K.BooleanField}}get selectors(){return this.selector}beforePrepareData(){if(this.ignored)return;const label=this.getReducedLabel(),slug=this.slug??sluggify(label),selectors=this.selectors.map(s=>this.resolveInjectedProperties(s)).filter(s=>!!s);for(const selector of selectors){if(selector==="null")continue;const construct=__name2((options={})=>{const resolvedValue=Number(this.resolveValue(this.value,0,options))||0;if(this.ignored)return null;const finalValue=Math.clamp(resolvedValue,this.min??resolvedValue,this.max??resolvedValue);if(game.pf2e.variantRules.AutomaticBonusProgression.suppressRuleElement(this,finalValue))return null;const damageType=this.damageType&&this.resolveInjectedProperties(this.damageType,{warn:!1})||null;if(damageType!==null&&!objectHasKey(CONFIG.PF2E.damageTypes,damageType))return this.test(options.test??[])&&this.failValidation(`damageType: "${damageType}" is unrecognized`),null;this.battleForm&&!this.predicate.includes("battle-form")&&this.predicate.push("battle-form");const modifier=new Modifier({slug,label,modifier:finalValue,type:this.type,ability:this.type==="ability"?this.ability:null,predicate:this.resolveInjectedProperties(this.predicate),rule:this,force:this.force,damageType,damageCategory:this.damageCategory,critical:this.critical,tags:this.tags,hideIfDisabled:this.hideIfDisabled,source:this.item.uuid});return options.test&&modifier.test(options.test),modifier},"construct");(this.actor.synthetics.modifiers[selector]??=[]).push(construct)}}async afterRoll({check,rollOptions}){if(this.ignored||!this.removeAfterRoll||!this.item.isOfType("effect"))return;(this.removeAfterRoll===!0||this.removeAfterRoll==="if-enabled"&&check.modifiers.some(m=>m.rule===this&&m.enabled)||Array.isArray(this.removeAfterRoll)&&this.removeAfterRoll.test(rollOptions))&&await this.item.delete()}}class GrantItemRuleElement extends RuleElement{static{__name(this,"GrantItemRuleElement")}static{__name2(this,"GrantItemRuleElement")}static validActorTypes=["army","character","npc","familiar"];grantedId=null;preselectChoices={};onDeleteActions=null;constructor(data,options){if(data.inMemoryOnly&&(data.priority??=99),super(data,options),this.invalid)return;this.inMemoryOnly?(this.reevaluateOnUpdate=!0,this.allowDuplicate=!0):(this.reevaluateOnUpdate&&(this.allowDuplicate=!1),this.parent.isOfType("physical")&&this.failValidation("parent item must not be physical")),this.onDeleteActions=this.#getOnDeleteActions(data);const isValidPreselect=__name2(p=>Object.values(p).every(v=>["string","number"].includes(typeof v)),"isValidPreselect");if(this.preselectChoices=e$2(data.preselectChoices)&&isValidPreselect(data.preselectChoices)?foundry.utils.deepClone(data.preselectChoices):{},this.grantedId=this.parent.flags.pf2e.itemGrants[this.flag??""]?.id??null,this.track){const grantedItem=this.actor.inventory.get(this.grantedId??"")??this.actor.inventory.flatMap(i=>i.subitems.contents).find(i=>i.id===this.grantedId)??null;this.#trackItem(grantedItem)}}static defineSchema(){const fields2=foundry.data.fields;return{...super.defineSchema(),uuid:new fields2.StringField({required:!0,nullable:!1,blank:!1,initial:void 0,label:"PF2E.UUID.Label"}),flag:new SlugField({required:!0,nullable:!0,initial:null,camel:"dromedary"}),reevaluateOnUpdate:new fields2.BooleanField({label:"PF2E.RuleEditor.GrantItem.ReevaluateOnUpdate"}),inMemoryOnly:new fields2.BooleanField,allowDuplicate:new fields2.BooleanField({initial:!0,label:"PF2E.RuleEditor.GrantItem.AllowDuplicate"}),nestUnderGranter:new fields2.BooleanField({required:!1,nullable:!1,initial:void 0}),alterations:new StrictArrayField(new fields2.EmbeddedDataField(ItemAlteration)),track:new fields2.BooleanField}}static ON_DELETE_ACTIONS=["cascade","detach","restrict"];static validateJoint(data){if(super.validateJoint(data),data.track&&!data.flag)throw Error("must have explicit flag set if granted item is tracked");if(data.reevaluateOnUpdate&&data.predicate.length===0)throw Error("reevaluateOnUpdate: must have non-empty predicate")}async preCreate(args){if(this.inMemoryOnly||this.invalid)return;const{itemSource,pendingItems,itemUpdates,operation}=args,ruleSource=args.ruleSource,uuid=this.resolveInjectedProperties(this.uuid);if(!UUIDUtils.isItemUUID(uuid,{embedded:!1}))return;const grantedItem=await(async()=>{try{return(await fromUuid(uuid))?.clone()??null}catch(error){return console.error(error),null}})();if(!(grantedItem instanceof ItemPF2e)||(ruleSource.flag=typeof ruleSource.flag=="string"&&ruleSource.flag.length>0?sluggify(ruleSource.flag,{camel:"dromedary"}):(()=>{const defaultFlag=sluggify(grantedItem.slug??grantedItem.name,{camel:"dromedary"}),flagPattern=new RegExp(`^${defaultFlag}\\d*$`),itemGrants=itemSource.flags?.pf2e?.itemGrants??{},nthGrant=Object.keys(itemGrants).filter(g=>flagPattern.test(g)).length;return nthGrant>0?`${defaultFlag}${nthGrant+1}`:defaultFlag})(),this.flag=String(ruleSource.flag),!this.test()))return;const existingItem=this.actor.items.find(i=>i.sourceId===uuid);if(!this.allowDuplicate&&existingItem){this.#setGrantFlags(itemSource,existingItem,itemUpdates),ui.notifications.info(game.i18n.format("PF2E.UI.RuleElements.GrantItem.AlreadyHasItem",{actor:this.actor.name,item:grantedItem.name}));return}itemSource._id??=foundry.utils.randomID();const grantedSource=grantedItem.toObject();grantedSource._id=foundry.utils.randomID(),this.item.sourceId===(grantedSource._stats.compendiumSource??"")&&(grantedSource.system.rules=grantedSource.system.rules.filter(r2=>r2.key!=="GrantItem")),itemSource.type==="effect"&&grantedSource.type==="effect"&&(grantedSource.system.level.value=itemSource.system?.level?.value??grantedSource.system.level.value),grantedSource._stats.compendiumSource=uuid;try{for(const alteration of this.alterations)alteration.applyTo(grantedSource)}catch(error){error instanceof Error&&this.failValidation(error.message)}const tempGranted=new ItemProxyPF2e(foundry.utils.deepClone(grantedSource),{parent:this.actor});if(tempGranted.grantedBy=this.item,tempGranted.isOfType("affliction","condition","effect")&&this.actor.isImmuneTo(tempGranted)){ruleSource.ignored=!0;return}tempGranted.prepareActorData?.();for(const rule of tempGranted.prepareRuleElements({suppressWarnings:!0}))rule.onApplyActiveEffects?.();if(this.#applyChoicePreselections(tempGranted),!this.ignored){args.tempItems.push(tempGranted);for(const item of[this.item,tempGranted])if(item.isOfType("class","feat")){const prefix=item.isOfType("class")||!item.isFeature?item.type:"feature",slug=item.slug??sluggify(item.name);this.actor.rollOptions.all[`self:${prefix}:${slug}`]=!0}this.grantedId=grantedSource._id,operation.keepId=!0,this.#setGrantFlags(itemSource,grantedSource,itemUpdates),this.#trackItem(tempGranted),pendingItems.push(grantedSource),args.reevaluation||await this.#runGrantedItemPreCreates(args,tempGranted,grantedSource,operation)}}async preUpdateActor(){const noAction={create:[],delete:[]};if(this.ignored||!this.reevaluateOnUpdate||this.inMemoryOnly)return noAction;if(this.grantedId&&this.actor.items.has(this.grantedId))return this.test()?noAction:{create:[],delete:[this.grantedId]};const itemSource=this.item.toObject(),ruleSource=itemSource.system.rules[this.sourceIndex??-1];if(!ruleSource)return noAction;const pendingItems=[],operation={parent:this.actor,render:!1},itemUpdates=[];if(await this.preCreate({itemSource,pendingItems,ruleSource,tempItems:[],itemUpdates,operation,reevaluation:!0}),itemUpdates.length&&await this.actor.updateEmbeddedDocuments("Item",itemUpdates,{render:!1}),pendingItems.length>0){const updatedGrants=itemSource.flags.pf2e?.itemGrants??{};return await this.item.update({"flags.pf2e.itemGrants":updatedGrants},{render:!1}),{create:pendingItems,delete:[]}}return noAction}onApplyActiveEffects(){this.invalid||this.#createInMemoryCondition()}#getOnDeleteActions(data){const actions=data.onDeleteActions;if(!e$2(actions))return null;const ACTIONS=GrantItemRuleElement.ON_DELETE_ACTIONS,{granter,grantee}=actions;return granter||grantee?{granter:tupleHasValue(ACTIONS,granter)?granter:null,grantee:tupleHasValue(ACTIONS,grantee)?grantee:null}:null}#applyChoicePreselections(grantedItem){const source2=grantedItem._source;for(const[flag,selection]of Object.entries(this.preselectChoices??{})){const rule=grantedItem.rules.find(rule2=>rule2 instanceof ChoiceSetRuleElement&&rule2.flag===flag);if(rule){const ruleSource=source2.system.rules[grantedItem.rules.indexOf(rule)],resolvedSelection=this.resolveInjectedProperties(selection);rule.selection=ruleSource.selection=resolvedSelection}}}#setGrantFlags(granter,grantee,itemUpdates){if(!this.flag)throw ErrorPF2e("Unexpected failure looking up RE flag key");const newFlagData={id:grantee instanceof ItemPF2e?grantee.id:grantee._id,onDelete:this.onDeleteActions?.grantee??"detach"};granter.type==="feat"&&grantee.type==="feat"&&this.nestUnderGranter===!1&&(newFlagData.nested=this.nestUnderGranter);const flags=foundry.utils.mergeObject(granter.flags??{},{pf2e:{itemGrants:{}}});flags.pf2e.itemGrants[this.flag]=newFlagData,this.item.flags.pf2e.itemGrants[this.flag]={...newFlagData,onDelete:newFlagData.onDelete??"detach",nested:newFlagData.nested??null};const grantedBy={id:granter._id,onDelete:this.onDeleteActions?.granter??(setHasElement(PHYSICAL_ITEM_TYPES,grantee.type)?"detach":"cascade")};grantee.flags=foundry.utils.mergeObject(grantee.flags??{},{pf2e:{grantedBy}}),grantee instanceof ItemPF2e&&grantee._id&&this.actor.items.has(grantee._id)&&itemUpdates.push({_id:grantee._id,"flags.pf2e.grantedBy":grantedBy})}async#runGrantedItemPreCreates(originalArgs,grantedItem,grantedSource,operation){for(const rule of grantedItem.rules){const ruleSource=grantedSource.system.rules[grantedItem.rules.indexOf(rule)];await rule.preCreate?.({...originalArgs,itemSource:grantedSource,ruleSource,operation})}}#createInMemoryCondition(){if(!this.inMemoryOnly||!this.test())return;const validationFailure="an in-memory-only grant must be a condition",uuid=this.resolveInjectedProperties(this.uuid);if(!UUIDUtils.isItemUUID(uuid))return this.failValidation(validationFailure);const conditionSource=game.pf2e.ConditionManager.conditions.get(uuid)?.toObject();if(!conditionSource)return this.failValidation(validationFailure);const actor=this.actor;if(actor.isImmuneTo(conditionSource.system.slug))return;for(const alteration of this.alterations)alteration.applyTo(conditionSource);const flags={pf2e:{grantedBy:{id:this.item.id,onDelete:"cascade"}}},condition=new ConditionPF2e(foundry.utils.mergeObject(conditionSource,{_id:foundry.utils.randomID(),flags,system:{references:{parent:{id:this.item.id}}}}),{parent:this.actor});actor.conditions.set(condition.id,condition),condition.prepareSiblingData(),condition.prepareActorData(),condition.rules=condition.prepareRuleElements(),actor.rules.push(...condition.rules)}#trackItem(grantedItem){if(!(this.track&&this.flag&&this.grantedId&&grantedItem?.isOfType("physical")))return;this.actor.flags.pf2e.trackedItems[this.flag]=this.grantedId;const slug=sluggify(this.flag),rollOptionsAll=this.actor.rollOptions.all;for(const statement of grantedItem.getRollOptions(slug))rollOptionsAll[statement]=!0}}const fields$J=foundry.data.fields;class ItemAlterationRuleElement extends RuleElement{static{__name(this,"ItemAlterationRuleElement")}static{__name2(this,"ItemAlterationRuleElement")}constructor(data,options){super(data,options);const abpRelevantProperties=["runes-potency","runes-resilient","runes-striking"];!this.item.isOfType("physical")&&!abpRelevantProperties.includes(this.property)&&(this.fromEquipment=!1)}static defineSchema(){const baseSchema=super.defineSchema(),PRIORITIES=AELikeRuleElement.CHANGE_MODE_DEFAULT_PRIORITIES;baseSchema.priority.initial=d=>(PRIORITIES[String(d.mode)]??50)+100;const itemTypeChoices=t$5(CONFIG.PF2E.Item.documentClasses,key=>`TYPES.Item.${key}`);return{...baseSchema,itemId:new fields$J.StringField({required:!1,nullable:!1,blank:!1,initial:void 0}),itemType:new fields$J.StringField({required:!1,nullable:!1,choices:itemTypeChoices,initial:void 0}),battleForm:new fields$J.BooleanField,...ItemAlteration.defineSchema()}}static validateJoint(data){if(super.validateJoint(data),!data.itemId&&!data.itemType)throw Error("one of itemId and itemType must be defined")}static#DELAYED_PROPERTIES=["pd-recovery-dc"];static#LAZY_PROPERTIES=["description"];get isLazy(){return this.constructor.#LAZY_PROPERTIES.includes(this.property)}async preCreate({tempItems}){if(this.ignored||(this.itemType==="feat"&&this.applyAlteration({additionalItems:tempItems}),this.property!=="hp-max"))return;const itemsOfType=this.itemType?this.actor.itemTypes[this.itemType]:[],actorRollOptions=this.actor.getRollOptions(),parentRollOptions=this.parent.getRollOptions("parent"),predicate=this.resolveInjectedProperties(this.predicate),updates=itemsOfType.filter(i=>predicate.test([actorRollOptions,parentRollOptions,i.getRollOptions("item")].flat())).flatMap(item=>{const source2=item.toObject(),alterationData=t$3(this,["mode","property","value","fromEquipment"]),alteration=new ItemAlteration(alterationData,{parent:this});alteration.applyTo(source2),alteration.applyTo(item);const newHP=source2.system.hp,oldHP=item._source.system.hp,newHPValue=Math.floor(oldHP.value*(newHP.max/oldHP.max));return newHPValue===oldHP.value?[]:{_id:item.id,"system.hp.value":newHPValue}});updates.length>0&&await this.actor.updateEmbeddedDocuments("Item",updates,{render:!1,checkHP:!1})}onApplyActiveEffects(){const actor=this.actor;if(this.ignored)return;this.battleForm&&!this.predicate.includes("battle-form")&&this.predicate.push("battle-form"),actor.synthetics.itemAlterations.push(this);const isDelayed=this.constructor.#DELAYED_PROPERTIES.includes(this.property);!this.isLazy&&!isDelayed&&this.applyAlteration()}afterPrepareData(){if(this.ignored)return;const isDelayed=this.constructor.#DELAYED_PROPERTIES.includes(this.property);!this.isLazy&&isDelayed&&this.applyAlteration()}applyAlteration({singleItem=null,additionalItems=[]}={}){if(!this.ignored)try{const itemId=this.itemId?this.resolveInjectedProperties(this.itemId):null,items=singleItem?singleItem.id===itemId||singleItem.type===this.itemType?[singleItem]:[]:this.#getItemsOfType();if(items.push(...additionalItems.filter(i=>itemId&&i.id===itemId||this.itemType===i.type)),items.length===0)return;const predicate=this.resolveInjectedProperties(this.predicate),[actorRollOptions,parentRollOptions]=predicate.length>0?[this.actor.getRollOptions(),this.parent.getRollOptions("parent")]:[[],[]];for(const item of items){const itemRollOptions=predicate.length>0?item.getRollOptions("item"):[],rollOptions=[actorRollOptions,parentRollOptions,itemRollOptions].flat();if(predicate.test(rollOptions)){const data=t$3(this,["mode","property","value","fromEquipment"]);new ItemAlteration(data,{parent:this}).applyTo(item)}}}catch(error){error instanceof Error&&this.failValidation(error.message)}}#getItemsOfType(){if(this.itemId){const itemId=this.resolveInjectedProperties(this.itemId);return[this.actor.items.get(itemId)??this.actor.inventory.flatMap(i=>i.subitems.contents).find(i=>i.id===itemId)].filter(e$1)}return this.itemType==="condition"?this.actor.conditions.contents:this.itemType?PHYSICAL_ITEM_TYPES.has(this.itemType)?[this.actor.itemTypes[this.itemType],this.actor.inventory.map(i=>i.subitems.filter(s=>s.type===this.itemType))].flat(2):this.actor.itemTypes[this.itemType]:[]}}const fields$I=foundry.data.fields;class LoseHitPointsRuleElement extends RuleElement{static{__name(this,"LoseHitPointsRuleElement")}static{__name2(this,"LoseHitPointsRuleElement")}static validActorTypes=["character","familiar","npc"];static defineSchema(){return{...super.defineSchema(),value:new ResolvableValueField({required:!0,initial:void 0}),reevaluateOnUpdate:new fields$I.BooleanField({required:!1,initial:!1}),recoverable:new fields$I.BooleanField({required:!1,initial:!0})}}onCreate(actorUpdates){if(this.ignored)return;const value=Math.trunc(Math.abs(Number(this.resolveValue(this.value))||0)),currentHP=this.actor._source.system.attributes.hp.value;actorUpdates["system.attributes.hp.value"]=Math.max(currentHP-value,0)}beforePrepareData(){if(this.ignored)return;const{actor}=this;if(!this.recoverable){const value=Math.trunc(Math.abs(Number(this.resolveValue(this.value))||0));actor.system.attributes.hp.unrecoverable+=value}}async preUpdate(changes){if(!this.reevaluateOnUpdate||this.ignored)return;const previousValue=Math.trunc(Math.abs(Number(this.resolveValue(this.value))||0)),newItem=this.item.clone(changes),rule=newItem.system.rules.find(r2=>r2.key===this.key),valueChange=Math.trunc(Math.abs(Number(this.resolveValue(String(rule?.value),0,{resolvables:{item:newItem}}))))-previousValue;if(valueChange>0){const currentHP=this.actor._source.system.attributes.hp.value;await this.actor.update({"system.attributes.hp.value":Math.max(currentHP-valueChange,0)},{render:!1})}}}const fields$H=foundry.data.fields;class MartialProficiencyRuleElement extends RuleElement{static{__name(this,"MartialProficiencyRuleElement")}static{__name2(this,"MartialProficiencyRuleElement")}static validActorTypes=["character"];constructor(data,options){super({priority:9,...data},options),!this.invalid&&(this.slug??=sluggify(this.label))}static defineSchema(){return{...super.defineSchema(),kind:new fields$H.StringField({required:!0,nullable:!1,choices:["attack","defense"],initial:"attack"}),definition:new PredicateField({required:!0,nullable:!1}),sameAs:new fields$H.StringField({required:!1,nullable:!1,choices:[...WEAPON_CATEGORIES,...ARMOR_CATEGORIES]}),maxRank:new fields$H.StringField({required:!1,nullable:!1,choices:["trained","expert","master","legendary"]}),value:new ResolvableValueField({required:!1,initial:void 0}),visible:new fields$H.BooleanField({required:!1,nullable:!1,initial:!0})}}onApplyActiveEffects(){if(!this.test())return;const rank=Math.clamp(Number(this.resolveValue(this.value))||1,1,4),key=this.kind==="attack"?"attacks":"defenses";this.actor.system.proficiencies[key][this.slug]={definition:this.resolveInjectedProperties(this.definition),label:this.label,sameAs:this.sameAs,rank,maxRank:this.maxRank,value:0,breakdown:"",visible:this.visible}}}const fields$G=foundry.data.fields;class MultipleAttackPenaltyRuleElement extends RuleElement{static{__name(this,"MultipleAttackPenaltyRuleElement")}static{__name2(this,"MultipleAttackPenaltyRuleElement")}static autogenForms=!0;static defineSchema(){return Object.assign(super.defineSchema(),{selector:new fields$G.StringField({required:!0,blank:!1}),value:new ResolvableValueField({required:!0,nullable:!1,initial:void 0})})}beforePrepareData(){if(this.ignored)return;const selector=this.resolveInjectedProperties(this.selector);if(this.ignored||selector.length===0)return;const value=Number(this.resolveValue(this.value))||0;if(value<0){const map={label:game.i18n.format("PF2E.UI.RuleElements.MultipleAttackPenalty.Breakdown",{label:this.label}),penalty:value,predicate:this.predicate};(this.actor.synthetics.multipleAttackPenalties[selector]??=[]).push(map)}else value!==0&&this.failValidation("value: must resolve to less than or equal to zero")}}const fields$F=foundry.data.fields;class RollNoteRuleElement extends RuleElement{static{__name(this,"RollNoteRuleElement")}static{__name2(this,"RollNoteRuleElement")}static autogenForms=!0;static LOCALIZATION_PREFIXES=super.LOCALIZATION_PREFIXES.concat("PF2E.RULES.Note");static defineSchema(){return{...super.defineSchema(),selector:new fields$F.SetField(new fields$F.StringField({required:!0,blank:!1}),{min:1}),title:new fields$F.StringField({required:!1,nullable:!0,blank:!1,initial:null}),visibility:new fields$F.StringField({required:!0,nullable:!0,choices:["gm","owner"],initial:null}),outcome:new fields$F.SetField(new fields$F.StringField({required:!0,choices:DEGREE_OF_SUCCESS_STRINGS})),text:new fields$F.HTMLField({required:!0,blank:!1}),battleForm:new fields$F.BooleanField({required:!1})}}beforePrepareData(){if(!this.ignored){this.battleForm&&!this.predicate.includes("battle-form")&&this.predicate.push("battle-form");for(const selector of this.resolveInjectedProperties(this.selector.values().toArray())){if(selector==="null")continue;const title=this.resolveInjectedProperties(this.title)?.trim()??null,text2=this.resolveInjectedProperties(String(this.resolveValue(this.text,"",{evaluate:!1}))).trim();if(!text2)return this.failValidation("text field resolved empty");const note=new RollNotePF2e({selector,title:title?this.getReducedLabel(title):null,text:text2,predicate:this.resolveInjectedProperties(this.predicate),outcome:this.outcome.values().toArray(),visibility:this.visibility,rule:this});(this.actor.synthetics.rollNotes[selector]??=[]).push(note)}}}}const fields$E=foundry.data.fields;class Suboption extends foundry.abstract.DataModel{static{__name(this,"Suboption")}static{__name2(this,"Suboption")}static defineSchema(){return{label:new fields$E.StringField({required:!0,nullable:!1,blank:!1}),value:new StrictStringField({required:!0,nullable:!1,blank:!1}),predicate:new PredicateField}}get rule(){return this.parent}get selected(){return this.rule.selection===this.value}}const fields$D=foundry.data.fields;class RollOptionRuleElement extends RuleElement{static{__name(this,"RollOptionRuleElement")}static{__name2(this,"RollOptionRuleElement")}hasSubOptions;constructor(source2,options){if(super(source2,options),this.hasSubOptions=!Array.isArray(this.suboptions)||!!this.suboptions.length,!this.invalid){if(source2.removeAfterRoll&&!this.item.isOfType("effect")){this.failValidation("removeAfterRoll may only be used on rule elements from effect items");return}if(this.toggleable==="totm"&&!game.pf2e.settings.totm){this.ignored=!0;return}if(this.option=this.#resolveOption(),Array.isArray(this.suboptions)){const firstSuboption=this.suboptions.at(0);firstSuboption&&!this.suboptions.some(s=>s.value===this.selection)&&(this.selection=firstSuboption.value)}}}static defineSchema(){const baseSchema=super.defineSchema();return baseSchema.priority.initial=AELikeRuleElement.CHANGE_MODE_DEFAULT_PRIORITIES.override,{...baseSchema,domain:new fields$D.StringField({required:!0,nullable:!1,initial:"all",blank:!1}),option:new fields$D.StringField({required:!0,nullable:!1,blank:!1}),phase:new fields$D.StringField({required:!1,nullable:!1,choices:foundry.utils.deepClone(AELikeRuleElement.PHASES),initial:"applyAEs"}),suboptions:new DataUnionField([new StrictArrayField(new fields$D.EmbeddedDataField(Suboption)),new fields$D.SchemaField({config:new fields$D.StringField({required:!0,blank:!1}),predicate:new PredicateField})],{required:!1,nullable:!1,initial:__name2(()=>[],"initial")}),mergeable:new fields$D.BooleanField({required:!1}),value:new ResolvableValueField({required:!1,initial:__name2(d=>!d.toggleable,"initial"),validate:__name2(v=>["boolean","string"].includes(typeof v),"validate"),validationError:"must be a boolean, string, or otherwise omitted"}),selection:new fields$D.StringField({required:!1,blank:!1,nullable:!1,initial:void 0}),toggleable:new DataUnionField([new fields$D.StringField({required:!1,nullable:!1,choices:["totm"]}),new StrictBooleanField({required:!1,nullable:!1,initial:!1})],{required:!1,nullable:!1,initial:void 0}),placement:new fields$D.StringField({required:!1,nullable:!1,initial:void 0}),disabledIf:new PredicateField({required:!1,initial:void 0}),disabledValue:new fields$D.BooleanField({required:!1,initial:void 0}),alwaysActive:new fields$D.BooleanField({required:!1,initial:void 0}),count:new fields$D.BooleanField({required:!1,initial:void 0}),removeAfterRoll:new fields$D.BooleanField({required:!1,initial:void 0})}}static validateJoint(source2){super.validateJoint(source2);const subOptionsIsEmpty=Array.isArray(source2.suboptions)&&source2.suboptions.length===0;if(!subOptionsIsEmpty&&!source2.toggleable)throw Error("suboptions: must be omitted if not toggleable");if(source2.disabledIf&&!source2.toggleable)throw Error("disabledIf: must be false if not toggleable");if(source2.count&&source2.toggleable)throw Error("count: must be false if toggleable");if(typeof source2.disabledValue=="boolean"&&(!source2.toggleable||!source2.disabledIf))throw Error("disabledValue: may only be included if toggeable and there is a disabledIf predicate.");if(source2.alwaysActive&&(!source2.toggleable||subOptionsIsEmpty))throw Error("alwaysActive: must be false unless toggleable and containing suboptions");if(source2.placement&&!source2.toggleable)throw Error("placement: may only be present if toggleable")}async preCreate(){this.phase==="applyAEs"&&this.#setOptionAndFlag()}onApplyActiveEffects(){this.phase==="applyAEs"&&this.#setOptionAndFlag()}beforePrepareData(){this.phase==="beforeDerived"&&this.#setOptionAndFlag()}afterPrepareData(){this.phase==="afterDerived"&&this.#setOptionAndFlag()}resolveValue(){return this.toggleable==="totm"&&!game.settings.get("pf2e","totmToggles")?!1:this.alwaysActive?!0:!!super.resolveValue(this.value)}getSelfSuboptions(){const suboptions=this.suboptions;if(Array.isArray(suboptions))return suboptions;const data=foundry.utils.getProperty(CONFIG.PF2E,suboptions.config);return processChoicesFromData(data).map(choice=>new Suboption({label:choice.label,value:choice.value,predicate:choice.predicate||suboptions.predicate.length?this.resolveInjectedProperties(new Predicate(choice.predicate??foundry.utils.deepClone(suboptions.predicate)),{injectables:{choice}}):null},{parent:this}))}#resolveSuboptions(test){const localSuboptions=this.getSelfSuboptions().filter(s=>!test||s.predicate.test(test));if(this.hasSubOptions&&localSuboptions.length===0)return[];const foreignSuboptions=this.#resolveSuboptionRules().flatMap(r2=>r2!==this&&!r2.ignored&&(!test||r2.test(test))?r2.getSelfSuboptions():[]),suboptions=n$2([...localSuboptions,...foreignSuboptions],s=>s.value).filter(s=>!test||s.predicate.test(test)).map(suboption=>(suboption.label=suboption.rule.resolveInjectedProperties(suboption.label),suboption));if(suboptions.length>0&&suboptions.filter(s=>s.selected).length>1){const suboptionValues=n(suboptions.map(s=>s.value)),rules=n(suboptions.map(s=>s.rule)),selection=n(suboptions.map(s=>s.rule._source.selection??s.rule.selection).filter(s=>!!s&&suboptionValues.includes(s))).at(0)??suboptionValues[0];for(const rule of rules)rule.selection=selection}return suboptions}#resolveSuboptionRules(){return this.mergeable?this.actor.rules.filter(r2=>r2 instanceof RollOptionRuleElement&&r2.toggleable&&r2.mergeable&&r2.domain===this.domain&&r2.option===this.option):[]}#resolveOption({withSuboption=!1}={}){const baseOption=this.resolveInjectedProperties(this._source.option).replace(/[^-:\w]/g,"").replace(/:+/g,":").replace(/-+/g,"-").trim();return withSuboption&&this.selection?`${baseOption}:${this.selection}`:baseOption}#setOptionAndFlag(){this.domain=this.resolveInjectedProperties(this.domain);const isStandardDomain=/^[-a-z0-9]+$/.test(this.domain)&&/[a-z]/.test(this.domain),isIdDomain=/^[a-zA-Z0-9]{16}-[-a-z0-9]+[a-z0-9]$/.test(this.domain);if(!isStandardDomain&&!isIdDomain)return this.failValidation("domain must be a string consisting of only lowercase letters, numbers, and hyphens.");const test=new Set([this.actor.getRollOptions([this.domain]),this.parent.getRollOptions("parent")].flat());if(!this.test(test))return this.#setFlag(!1);const baseOption=this.option=this.#resolveOption();if(!baseOption){this.failValidation("option: must be a string consisting of only letters, numbers, colons, and hyphens");return}if(this.toggleable){const enabled=this.disabledIf?!this.disabledIf.test(test):!0;!enabled&&!this.alwaysActive&&typeof this.disabledValue=="boolean"&&(this.value=this.disabledValue);const toggleDomain=this.actor.synthetics.toggles[this.domain]??={};if(this.mergeable&&toggleDomain[this.option])return;const suboptions=this.#resolveSuboptions(test);if(this.hasSubOptions&&suboptions.length===0){this.ignored=!0;return}if(suboptions.length>0&&!suboptions.some(s=>s.value===this.selection))this.selection=suboptions[0].value;else if(this.mergeable&&this.actor.synthetics.toggles[this.domain]?.[this.option])return;const toggle={itemId:(suboptions.find(s=>s.selected)?.parent.item??this.item).id,label:this.getReducedLabel(),placement:this.placement??"actions",domain:this.domain,option:baseOption,suboptions,alwaysActive:!!this.alwaysActive,checked:!1,enabled},value=toggle.checked=this.resolveValue();this.#setOption(baseOption,value),this.#setFlag(value),toggleDomain[this.option]=toggle}else this.count?this.#setCount(baseOption):this.#setOption(baseOption,this.resolveValue())}#setOption(baseOption,value){const rollOptions=this.actor.rollOptions,domainRecord=rollOptions[this.domain]??={},fullOption=this.#resolveOption({withSuboption:!0});value?(domainRecord[fullOption]=!0,domainRecord[baseOption]=!0):(delete domainRecord[fullOption],delete domainRecord[baseOption])}#setFlag(value){if(this.selection){const flagKey=sluggify(this.#resolveOption(),{camel:"dromedary"});if(value){const flagValue=/^\d+$/.test(this.selection)?Number(this.selection):this.selection;this.item.flags.pf2e.rulesSelections[flagKey]=flagValue}else this.item.flags.pf2e.rulesSelections[flagKey]??=null}}#setCount(option){const rollOptions=this.actor.rollOptions,domainRecord=rollOptions[this.domain]??={},existing=Object.keys(domainRecord).flatMap(key=>({key,count:Number(new RegExp(`^${option}:(\\d+)$`).exec(key)?.[1])||0})).find(kc=>!!kc.count);existing?(delete domainRecord[existing.key],domainRecord[`${option}:${existing.count+1}`]=!0):domainRecord[`${option}:1`]=!0}async toggle(value=!this.resolveValue(),selection=null){if(!this.toggleable)throw ErrorPF2e("Attempted to toggle non-toggleable roll option");if(this.mergeable&&selection){const rules=this.#resolveSuboptionRules(),updates=createBatchRuleElementUpdate(rules,{value,selection});return(await this.actor.updateEmbeddedDocuments("Item",updates)).length>0?value:null}else{const ruleSources=this.item.toObject().system.rules,thisSource=typeof this.sourceIndex=="number"?ruleSources.at(this.sourceIndex):null;return thisSource?(thisSource.value=value,selection&&(thisSource.selection=selection),await this.item.update({"system.rules":ruleSources})?value:null):null}}beforeRoll(domains,rollOptions){if(!(this.test(rollOptions)&&domains.includes(this.domain)))return;this.value=this.resolveValue();const option=this.#resolveOption({withSuboption:!0});this.value?rollOptions.add(option):rollOptions.delete(option)}async afterRoll({domains,rollOptions}){const option=this.#resolveOption({withSuboption:!0});!this.ignored&&this.removeAfterRoll&&this.value&&this.actor.items.has(this.item.id)&&domains.includes(this.domain)&&rollOptions.has(option)&&game.pf2e.settings.automation.removeEffects&&await this.item.delete()}}const fields$C=foundry.data.fields;class RollTwiceRuleElement extends RuleElement{static{__name(this,"RollTwiceRuleElement")}static{__name2(this,"RollTwiceRuleElement")}static defineSchema(){return{...super.defineSchema(),selector:new fields$C.ArrayField(new fields$C.StringField({required:!0,blank:!1}),{required:!0,nullable:!1,min:1}),keep:new fields$C.StringField({required:!0,choices:["lower","higher"]}),removeAfterRoll:new fields$C.BooleanField({required:!1,initial:void 0})}}beforePrepareData(){if(this.ignored)return;const predicate=this.resolveInjectedProperties(this.predicate);for(const selector of this.resolveInjectedProperties(this.selector)){const synthetic={keep:this.keep,predicate};(this.actor.synthetics.rollTwice[selector]??=[]).push(synthetic)}}async afterRoll({domains,roll,rollOptions}){if(!this.actor.items.has(this.item.id))return;const removeExpired=game.pf2e.settings.automation.removeEffects,removeAfterRoll=this.removeAfterRoll??(removeExpired&&this.item.isOfType("effect"));if((roll?.dice.some(d=>["kh","kl"].some(m=>d.modifiers.includes(m)))??!1)&&removeAfterRoll&&this.selector.some(s=>domains.includes(s))&&this.test(rollOptions)){for(const rule of this.item.rules)rule.ignored=!0;removeExpired&&await this.item.delete()}}}const fields$B=foundry.data.fields,INVALID_RESOURCES=[...CORE_RESOURCES,"crafting","infusedReagents"];class SpecialResourceRuleElement extends RuleElement{static{__name(this,"SpecialResourceRuleElement")}static{__name2(this,"SpecialResourceRuleElement")}static validActorTypes=["character","npc"];constructor(source2,options){super({priority:18,...source2},options),!this.invalid&&(this.slug??=this.item.slug??sluggify(this.item.name),INVALID_RESOURCES.includes(this.slug)&&this.failValidation("slug: invalid value"),this.level!==null&&!this.itemUUID&&this.failValidation("level can only be set if itemUUID is set"),this.value??=0)}static defineSchema(){return{...super.defineSchema(),value:new fields$B.NumberField({required:!0,nullable:!0,initial:null}),max:new ResolvableValueField({required:!0,nullable:!1}),itemUUID:new fields$B.DocumentUUIDField({required:!1,nullable:!1,blank:!1,initial:void 0,type:"Item",label:"PF2E.UUID.Label"}),level:new ResolvableValueField({required:!1,nullable:!0,initial:null}),renew:new AnyChoiceField({required:!1,nullable:!1,choices:["daily",!1],initial:"daily"})}}async update(value,{save=!0,render=!0,checkLevel=!1}={}){const data=createActorGroupUpdate();if(this.itemUUID){const existing=this.actor.items.find(i=>i.sourceId===this.itemUUID),level=this.level!==null?Number(this.resolveValue(this.level)):null;if(existing?.isOfType("physical")&&(existing.quantity!==value||checkLevel&&level!==existing.level)){const update={_id:existing.id,system:{quantity:value}};checkLevel&&level!==null&&(update.system=foundry.utils.mergeObject(update.system,{level:{value:level}})),data.itemUpdates.push(update)}else if(!existing){const source2=await this.#createItem(this.itemUUID,level);source2&&(source2.system.quantity=value,data.itemCreates.push(source2))}}else{const allRules=this.actor.rules.filter(r2=>r2.key==="SpecialResource"&&r2.slug===this.slug);data.itemUpdates.push(...createBatchRuleElementUpdate(allRules,{value}))}if(save)await applyActorGroupUpdate(this.actor,data,{render});else return data}async renewUses(duration){return duration==="day"&&this.renew!==!1?this.update(this.max,{save:!1,checkLevel:!0}):createActorGroupUpdate()}async preCreate({tempItems,pendingItems}){if(this.test()&&this.itemUUID){const key=sluggify(this.slug,{camel:"dromedary"}),thisMax=Number(this.resolveValue(this.max));this.max=Math.floor(Math.max(thisMax,this.actor.system.resources[key]?.max??0));const uuid=this.resolveInjectedProperties(this.itemUUID),level=this.level===null?null:Number(this.resolveValue(this.level)),existingItem=this.actor.items.find(i=>i.sourceId===uuid),existingTempItem=tempItems.find(i=>i.sourceId===uuid);if(existingTempItem){const existingTempSource=pendingItems.find(i=>i._id===existingTempItem.id);existingTempSource&&typeof level=="number"&&(existingTempSource.system.level={value:level})}else if(!existingItem&&uuid){const source2=await this.#createItem(uuid,level);if(source2){const item=new ItemProxyPF2e(foundry.utils.deepClone(source2),{parent:this.actor});tempItems.push(item),pendingItems.push(source2)}}else typeof level=="number"&&await existingItem?.update({"system.level.value":level})}}onApplyActiveEffects(){if(!this.test()){this.ignored=!0;return}const key=sluggify(this.slug,{camel:"dromedary"});if(this.max=Number(this.resolveValue(this.max)),!(key in this.actor.synthetics.resources))this.actor.synthetics.resources[key]=this,this.actor.system.resources[key]=foundry.utils.mergeObject(this.actor.system.resources[key]??{},{value:0,max:this.max});else{const existing=this.actor.system.resources[key];existing&&(this.max=existing.max=Math.floor(Math.max(this.max,existing.max??0)))}}beforePrepareData(){if(this.ignored)return;const existing=this.actor.system.resources[sluggify(this.slug,{camel:"dromedary"})];if(existing){const max=Math.floor(existing.max??0);this.max=existing.max=max;const rawValue=this.itemUUID?this.actor.inventory.find(i=>i.sourceId===this.itemUUID)?.quantity??0:this._source.value??max;this.value=existing.value=Math.min(rawValue,max)}else this.failValidation(`Missing resource system data for resource ${this.slug}`)}async#createItem(uuid,level){const grantedItem=await(async()=>{try{return(await fromUuid(uuid))?.clone()??null}catch(error){return console.error(error),null}})();if(grantedItem instanceof PhysicalItemPF2e){const grantedSource=grantedItem.toObject();return grantedSource._id=foundry.utils.randomID(),grantedSource.system.quantity=this.max,typeof level=="number"&&(grantedSource.system.level.value=level),grantedSource}else return this.failValidation("itemUUID must refer to a physical item"),null}}const fields$A=foundry.data.fields;class SpecialStatisticRuleElement extends RuleElement{static{__name(this,"SpecialStatisticRuleElement")}static{__name2(this,"SpecialStatisticRuleElement")}static validActorTypes=["character","npc"];static defineSchema(){return{...super.defineSchema(),slug:new SlugField({required:!0,nullable:!1,initial:void 0,validate:__name2(v=>typeof v=="string"&&!(v in CONFIG.PF2E.magicTraditions||v in CONFIG.PF2E.classTraits||v in CONFIG.PF2E.skills||tupleHasValue(SAVE_TYPES,v)||["perception","initiative"].includes(v)),"validate")}),type:new fields$A.StringField({required:!0,choices:["simple","check","attack-roll"],initial:"check"}),extends:new fields$A.StringField({required:!0,nullable:!0,initial:null}),attribute:new fields$A.StringField({required:!1,choices:Array.from(ATTRIBUTE_ABBREVIATIONS),nullable:!0,initial:null}),baseModifier:new fields$A.SchemaField({mod:new fields$A.NumberField({required:!1,nullable:!0,integer:!0,initial:null}),check:new fields$A.NumberField({required:!1,nullable:!0,integer:!0,initial:null}),dc:new fields$A.NumberField({required:!1,nullable:!0,integer:!0,initial:null})},{required:!1,nullable:!0,initial:null}),itemCasting:new fields$A.SchemaField({predicate:new PredicateField({required:!0,nullable:!1}),tradition:new fields$A.StringField({required:!1,nullable:!0,choices:__name2(()=>CONFIG.PF2E.magicTraditions,"choices"),initial:null})},{required:!1,nullable:!0,initial:null})}}afterPrepareData(){if(this.type==="simple")return;const actor=this.actor,checkDomains=this.type==="check"?[`${this.slug}-check`]:[`${this.slug}-attack-roll`],extendedFrom=this.extends?actor.getStatistic(this.extends)??actor.synthetics.statistics.get(this.extends)??null:null;if(this.extends&&!extendedFrom)return this.failValidation(`extends: unable to resolve statistic "${this.extends}"`);const label=this.itemCasting?extendedFrom?.label??this.label:this.label,checkType=this.type==="check"?"check":"attack-roll",modCheckDC=this.baseModifier&&actor.type==="npc"?t$5(this.baseModifier,(value,key)=>{const slug=typeof this.baseModifier?.mod=="number"&&key!=="mod"?`base-${key}`:"base",label2="PF2E.ModifierTitle",modifier=typeof value=="number"&&key==="dc"?value-10:value;return typeof modifier=="number"?[new Modifier({slug,label:label2,modifier})]:[]}):{mod:[],check:[],dc:[]},data={slug:this.slug,label,attribute:this.attribute??extendedFrom?.attribute??null,domains:[this.slug],modifiers:modCheckDC.mod,check:{type:checkType,domains:checkDomains,modifiers:modCheckDC.check},dc:{domains:[`${this.slug}-dc`],modifiers:modCheckDC.dc}},statistic=extendedFrom?.extend(data)??new Statistic(actor,data);statistic?(actor.synthetics.statistics.set(this.slug,statistic),this.itemCasting&&actor.spellcasting.set(this.slug,new ItemSpellcasting({id:this.slug,name:this.label,actor,statistic,castPredicate:this.itemCasting.predicate,tradition:this.itemCasting.tradition}))):this.failValidation(`Unable to find statistic ${this.extends} to extend from`)}}const fields$z=foundry.data.fields;class SubstituteRollRuleElement extends RuleElement{static{__name(this,"SubstituteRollRuleElement")}static{__name2(this,"SubstituteRollRuleElement")}constructor(source2,options){super(source2,options),this.removeAfterRoll&&!this.item.isOfType("effect")&&this.failValidation("removeAfterRoll: may only be used with effects")}static defineSchema(){return{...super.defineSchema(),selector:new fields$z.StringField({required:!0,blank:!1,initial:"check"}),value:new ResolvableValueField({required:!0,nullable:!1}),required:new fields$z.BooleanField({required:!1,nullable:!1,initial:!1}),effectType:new fields$z.StringField({required:!0,nullable:!1,choices:["fortune","misfortune"],initial:"fortune"}),removeAfterRoll:new DataUnionField([new fields$z.StringField({required:!1,nullable:!1,choices:["if-enabled"]}),new StrictBooleanField({required:!1,nullable:!1,initial:void 0}),new PredicateField({required:!1,nullable:!1,initial:void 0})],{required:!1,nullable:!1,initial:!1})}}beforePrepareData(){const value=Math.clamp(Math.trunc(Number(this.resolveValue(this.value))),1,20);if(Number.isNaN(value))return this.failValidation("value must resolve to a number");const selector=this.resolveInjectedProperties(this.selector);(this.actor.synthetics.rollSubstitutions[selector]??=[]).push({slug:this.slug??sluggify(this.item.name),label:this.label,value,predicate:this.predicate,required:this.required,selected:this.required,effectType:this.effectType})}async afterRoll(params){if(!this.removeAfterRoll||this.ignored)return;if(this.removeAfterRoll===!0){await this.item.delete();return}if(Array.isArray(this.removeAfterRoll)&&this.removeAfterRoll.test(params.rollOptions)){await this.item.delete();return}const rollSubstituted=params.roll.dice.length===0,substitutionIncluded=!!params.context.substitutions?.some(s=>s.slug===this.slug&&s.selected);this.removeAfterRoll==="if-enabled"&&rollSubstituted&&substitutionIncluded&&await this.item.delete()}}const fields$y=foundry.data.fields;class TokenEffectIconRuleElement extends RuleElement{static{__name(this,"TokenEffectIconRuleElement")}static{__name2(this,"TokenEffectIconRuleElement")}static defineSchema(){return{...super.defineSchema(),value:new fields$y.StringField({required:!1,blank:!1,initial:void 0})}}afterPrepareData(){if(!this.test())return;const path=this.value?this.resolveInjectedProperties(this.value).trim():this.item.img;if(!isImageFilePath(path))return this.failValidation("value: must resolve to an image file path");this.actor.synthetics.tokenEffectIcons.push(ActiveEffectPF2e.fromEffect(new EffectPF2e({type:"effect",name:this.label,img:path,system:{description:{value:this.item.description}}},{parent:this.actor})))}}const fields$x=foundry.data.fields;class TokenImageRuleElement extends RuleElement{static{__name(this,"TokenImageRuleElement")}static{__name2(this,"TokenImageRuleElement")}static defineSchema(){return{...super.defineSchema(),value:new fields$x.StringField({required:!0,nullable:!1,initial:void 0,label:"TOKEN.FIELDS.texture.src.label"}),tint:new fields$x.ColorField({label:"TOKEN.FIELDS.texture.tint.label"}),alpha:new fields$x.AlphaField({label:"PF2E.RuleEditor.General.Opacity",required:!1,nullable:!0,initial:null}),scale:new fields$x.NumberField({required:!1,nullable:!0,positive:!0,initial:null,label:"Scale"}),ring:new fields$x.SchemaField({subject:new fields$x.SchemaField({texture:new fields$x.StringField({required:!0,nullable:!1,blank:!1,initial:void 0,label:"TOKEN.FIELDS.ring.subject.texture.label"}),scale:new fields$x.NumberField({required:!0,nullable:!1,min:.8,initial:1,label:"PF2E.RuleEditor.TokenImage.Ring.ScaleCorrection"})},{required:!0,nullable:!1,initial:void 0}),colors:new fields$x.SchemaField({background:new fields$x.ColorField({required:!1,nullable:!0,initial:null,label:"TOKEN.FIELDS.ring.colors.background.label"}),ring:new fields$x.ColorField({required:!1,nullable:!0,initial:null,label:"TOKEN.FIELDS.ring.colors.ring.label"})},{required:!0,nullable:!1,initial:__name2(()=>({background:null,ring:null}),"initial")}),effects:new fields$x.NumberField({required:!1,nullable:!1,integer:!0,initial:1,min:0,max:8388607})},{required:!1,nullable:!1,initial:void 0}),animation:new fields$x.SchemaField({duration:new fields$x.NumberField({required:!1,nullable:!1,integer:!0,positive:!0,initial:void 0}),transition:new fields$x.StringField({required:!1,blank:!1,nullable:!1,choices:Object.values(foundry.canvas.rendering.filters.TextureTransitionFilter.TYPES),initial:void 0}),easing:new fields$x.StringField({required:!1,blank:!1,nullable:!1,choices:["easeInOutCosine","easeOutCircle","easeInCircle"],initial:void 0}),name:new fields$x.StringField({required:!1,blank:!1,nullable:!1,initial:void 0})},{required:!1,nullable:!0,initial:null})}}afterPrepareData(){const src=this.resolveInjectedProperties(this.value);if(!isImageOrVideoPath(src))return this.failValidation("Missing or invalid value field");if(!this.test())return;const texture={src};this.scale&&(texture.scaleX=this.scale,texture.scaleY=this.scale),texture.tint=this.tint,this.actor.synthetics.tokenOverrides.texture=texture;const subjectTexture=this.resolveInjectedProperties(this.ring?.subject.texture??"");this.ring&&foundry.helpers.media.ImageHelper.hasImageExtension(subjectTexture)&&(this.actor.synthetics.tokenOverrides.ring={subject:{scale:this.ring.subject.scale,texture:subjectTexture},colors:{...this.ring.colors},effects:this.ring.effects}),this.actor.synthetics.tokenOverrides.alpha=this.alpha,this.actor.synthetics.tokenOverrides.animation=this.animation??{}}}const fields$w=foundry.data.fields;class TokenLightRuleElement extends RuleElement{static{__name(this,"TokenLightRuleElement")}static{__name2(this,"TokenLightRuleElement")}static defineSchema(){return{...super.defineSchema(),value:new fields$w.SchemaField({...foundry.data.LightData.defineSchema(),bright:new ResolvableValueField({required:!1,nullable:!1,initial:void 0}),color:new fields$w.StringField({required:!1,nullable:!0,blank:!1,initial:null}),dim:new ResolvableValueField({required:!1,nullable:!1,initial:void 0})})}}getLightData(){const light=this.value;light.color&&=this.resolveInjectedProperties(light.color);for(const key of["bright","dim"])if(light[key]!==void 0){const resolvedValue=this.resolveValue(light[key]);if(typeof resolvedValue=="number")light[key]=resolvedValue;else return this.failValidation(`${key}: must resolve to a number`),null}try{return new foundry.data.LightData(light).toObject()}catch(error){return error instanceof Error&&this.failValidation(error.message),null}}afterPrepareData(){if(!this.test())return;const data=this.getLightData();data&&(this.actor.synthetics.tokenOverrides.light=data)}}class MarkTargetPrompt{static{__name(this,"MarkTargetPrompt")}static{__name2(this,"MarkTargetPrompt")}prompt;requirements;#target;#resolve;constructor(params){this.prompt=params.prompt??"PF2E.UI.RuleElements.TokenMark.TargetToken",this.requirements=params.requirements}async resolveTarget(){return canvas.tokens.setTargets([]),this.activateListeners(),ui.notifications.info(this.prompt,{localize:!0}),new Promise(resolve=>{this.#resolve=resolve})}activateListeners(){document.activeElement instanceof HTMLElement&&document.activeElement.blur();const hookParams=["targetToken",(_user,token,targeted)=>{this.#target=targeted&&token instanceof TokenPF2e?token.document:null,this.#resolve?.(this.#target)}];Hooks.once(...hookParams);const cancelHandler=this.#cancelHandler(hookParams);document.addEventListener("keyup",cancelHandler),window.setTimeout(()=>{Hooks.off(...hookParams),document.removeEventListener("keyup",cancelHandler),this.#target===void 0&&this.#resolve?.(null)},15e3)}#cancelHandler(hookParams){const handler=__name2(event2=>{event2.key==="Escape"&&(event2.stopPropagation(),ui.notifications.info("PF2E.UI.RuleElements.TokenMark.Timeout",{localize:!0}),Hooks.off(...hookParams),document.removeEventListener("keyup",handler))},"handler");return handler}}const fields$v=foundry.data.fields;class TokenMarkRuleElement extends RuleElement{static{__name(this,"TokenMarkRuleElement")}static{__name2(this,"TokenMarkRuleElement")}static autogenForms=!0;static defineSchema(){return{...super.defineSchema(),slug:new SlugField({required:!0,nullable:!1,initial:void 0}),uuid:new fields$v.StringField({required:!1,nullable:!0,initial:null})}}static LOCALIZATION_PREFIXES=super.LOCALIZATION_PREFIXES.concat("PF2E.RULES.TokenMark");async preCreate({ruleSource,itemSource,pendingItems}){if(this.ignored)return;if(this.uuid&&=this.resolveInjectedProperties(this.uuid),this.actor.getActiveTokens().length===0){this.ignored=ruleSource.ignored=!0;return}const loneTarget=game.user.targets.size===1?game.user.targets.first():null,token=fromUuidSync(this.uuid??"")??(loneTarget?.actor&&loneTarget.actor.uuid!==this.actor.uuid?loneTarget.document:await new MarkTargetPrompt({prompt:null,requirements:null}).resolveTarget());if(!(token instanceof TokenDocumentPF2e)){pendingItems.splice(pendingItems.indexOf(itemSource),1);return}this.#checkRuleSource(ruleSource),this.uuid=ruleSource.uuid=token.uuid}beforePrepareData(){if(UUIDUtils.isTokenUUID(this.uuid)&&this.test()){const tokenMarks=this.actor.synthetics.tokenMarks,slugs=tokenMarks.get(this.uuid)??[];slugs.push(this.slug),tokenMarks.set(this.uuid,slugs)}}#checkRuleSource(source2){if(!(source2.key==="TokenMark"&&source2.slug===this.slug))throw ErrorPF2e("Unexpected rule element passed")}}const fields$u=foundry.data.fields;class TokenNameRuleElement extends RuleElement{static{__name(this,"TokenNameRuleElement")}static{__name2(this,"TokenNameRuleElement")}static autogenForms=!0;static defineSchema(){return{...super.defineSchema(),value:new fields$u.StringField({required:!0,nullable:!1,blank:!1})}}afterPrepareData(){this.test()&&(this.actor.synthetics.tokenOverrides.name=this.resolveInjectedProperties(this.value))}}class RuleElements{static{__name(this,"RuleElements")}static{__name2(this,"RuleElements")}static builtin={ActiveEffectLike:AELikeRuleElement,ActorTraits:ActorTraitsRuleElement,AdjustDegreeOfSuccess:AdjustDegreeOfSuccessRuleElement,AdjustModifier:AdjustModifierRuleElement,AdjustStrike:AdjustStrikeRuleElement,Aura:AuraRuleElement,BaseSpeed:BaseSpeedRuleElement,BattleForm:BattleFormRuleElement,ChoiceSet:ChoiceSetRuleElement,CraftingAbility:CraftingAbilityRuleElement,CreatureSize:CreatureSizeRuleElement,CriticalSpecialization:CritSpecRuleElement,DamageAlteration:DamageAlterationRuleElement,DamageDice:DamageDiceRuleElement,DexterityModifierCap:DexterityModifierCapRuleElement,EphemeralEffect:EphemeralEffectRuleElement,FastHealing:FastHealingRuleElement,FlatModifier:FlatModifierRuleElement,GrantItem:GrantItemRuleElement,Immunity:ImmunityRuleElement,ItemAlteration:ItemAlterationRuleElement,LoseHitPoints:LoseHitPointsRuleElement,MartialProficiency:MartialProficiencyRuleElement,MultipleAttackPenalty:MultipleAttackPenaltyRuleElement,Note:RollNoteRuleElement,Resistance:ResistanceRuleElement,RollOption:RollOptionRuleElement,RollTwice:RollTwiceRuleElement,Sense:SenseRuleElement,SpecialResource:SpecialResourceRuleElement,SpecialStatistic:SpecialStatisticRuleElement,Strike:StrikeRuleElement,SubstituteRoll:SubstituteRollRuleElement,TempHP:TempHPRuleElement,TokenEffectIcon:TokenEffectIconRuleElement,TokenImage:TokenImageRuleElement,TokenLight:TokenLightRuleElement,TokenMark:TokenMarkRuleElement,TokenName:TokenNameRuleElement,Weakness:WeaknessRuleElement};static custom={};static get all(){return{...this.builtin,...this.custom}}static fromOwnedItem(options){const rules=[],item=options.parent;for(const[sourceIndex,source2]of item.system.rules.entries()){if(typeof source2.key!="string"){console.error(`PF2e System | Missing key in rule element ${source2.key} on item ${item.name} (${item.uuid})`);continue}const REConstructor=this.custom[source2.key]??this.custom[source2.key]??this.builtin[source2.key];if(REConstructor)try{rules.push(new REConstructor(source2,{...options,sourceIndex}))}catch(error){options?.suppressWarnings||(console.warn(`PF2e System | Failed to construct rule element ${source2.key} on item ${item.name}`,`(${item.uuid})`),console.warn(error))}else{const{name:name2,uuid}=item;console.warn(`PF2e System | Unrecognized rule element ${source2.key} on item ${name2} (${uuid})`)}}return rules}}async function processGrantDeletions(item,pendingItems){const actor=item.actor,granter=actor.items.get(item.flags.pf2e.grantedBy?.id??""),parentGrant=Object.values(granter?.flags.pf2e.itemGrants??{}).find(g=>g.id===item.id),grants=Object.values(item.flags.pf2e.itemGrants);if(granter&&parentGrant?.onDelete==="restrict"&&!pendingItems.includes(granter)){ui.notifications.warn(game.i18n.format("PF2E.Item.RemovalPrevented",{item:item.name,preventer:granter.name})),pendingItems.splice(pendingItems.indexOf(item),1);return}for(const grant of grants){const grantee=actor.items.get(grant.id);if(grantee?.flags.pf2e.grantedBy?.id===item.id&&grantee.flags.pf2e.grantedBy.onDelete==="restrict"&&!pendingItems.includes(grantee)){ui.notifications.warn(game.i18n.format("PF2E.Item.RemovalPrevented",{item:item.name,preventer:grantee.name})),pendingItems.splice(pendingItems.indexOf(item),1);return}}granter&&parentGrant?.onDelete==="cascade"&&!pendingItems.includes(granter)&&(pendingItems.push(granter),await processGrantDeletions(granter,pendingItems));for(const grant of grants){const grantee=actor.items.get(grant.id);grantee?.flags.pf2e.grantedBy?.id===item.id&&grantee.flags.pf2e.grantedBy.onDelete==="cascade"&&!pendingItems.includes(grantee)&&(pendingItems.push(grantee),await processGrantDeletions(grantee,pendingItems))}for(const grant of grants){const grantee=actor.items.get(grant.id);grantee?.flags.pf2e.grantedBy?.id===item.id&&grantee.flags.pf2e.grantedBy.onDelete==="detach"&&!pendingItems.includes(grantee)&&await grantee.update({"flags.pf2e.-=grantedBy":null},{render:!1})}}__name(processGrantDeletions,"processGrantDeletions"),__name2(processGrantDeletions,"processGrantDeletions");class ItemPF2e extends Item{static{__name(this,"ItemPF2e")}static{__name2(this,"ItemPF2e")}static getDefaultArtwork(itemData){return{img:`systems/pf2e/icons/default-icons/${itemData.type}.svg`}}static get validTraits(){return{}}get slug(){return this.system.slug}get sourceId(){return this._id&&this.pack&&!this.isEmbedded?this.uuid:this._stats.duplicateSource??this._stats.compendiumSource}get schemaVersion(){const legacyValue=e$2(this._source.system.schema)&&Number(this._source.system.schema.version)||null;return Number(this._source.system._migration?.version)||legacyValue}get description(){return this.system.description.value.trim()}get inMemoryOnly(){return!this.collection?.has(this.id)}static async fromDropData(data,options){if("uuid"in data&&UUIDUtils.isItemUUID(data.uuid)){const item=await fromUuid(data.uuid);item instanceof ItemPF2e&&item.parent&&!item.sourceId&&(item._source._stats.duplicateSource=item.uuid,item._stats.duplicateSource=item._source._stats.duplicateSource,item._source._stats.compendiumSource??=item.uuid.startsWith("Compendium.")?item.uuid:null,item._stats.compendiumSource=item._source._stats.compendiumSource)}return super.fromDropData(data,options)}isOfType(...types){return types.some(t2=>t2==="physical"?setHasElement(PHYSICAL_ITEM_TYPES,this.type):this.type===t2)}async delete(operation={}){return this.actor?(await this.actor.deleteEmbeddedDocuments("Item",[this.id],operation),this):super.delete(operation)}getRollOptions(prefix=this.type,{includeGranter=!0}={}){if(prefix.length===0)throw ErrorPF2e("`prefix` must be at least one character long");const{value:traits=[],rarity=null,otherTags,config={}}=this.system.traits,slug=this.slug??sluggify(this.name),granterOptions=includeGranter?this.grantedBy?.getRollOptions("granter",{includeGranter:!1}).map(o=>`${prefix}:${o}`)??[]:[],rollOptions=[`${prefix}:id:${this.id}`,`${prefix}:${slug}`,`${prefix}:slug:${slug}`,...granterOptions,...Array.from(this.specialOptions).map(o=>`${prefix}:${o}`),...otherTags.map(t2=>`${prefix}:tag:${t2}`),...traits.map(t2=>`${prefix}:trait:${t2}`),...Object.keys(config).map(k=>`${prefix}:trait:${k}`)];rarity&&rollOptions.push(`${prefix}:rarity:${rarity}`),(this.isOfType("spell")||traits.some(t2=>["magical",...MAGIC_TRADITIONS].includes(t2)))&&rollOptions.push(`${prefix}:magical`);const level=this.isOfType("spell")?this.rank:this.system.level?.value??null;typeof level=="number"&&rollOptions.push(`${prefix}:level:${level}`);const itemType=this.isOfType("feat")&&this.isFeature?"feature":this.type;return prefix!==itemType&&rollOptions.unshift(`${prefix}:type:${itemType}`),rollOptions}getRollData(){return{...this.actor?.getRollData()??{actor:null},item:this}}async toMessage(event2,options={}){if(!this.actor)throw ErrorPF2e(`Cannot create message for unowned item ${this.name}`);const sluggifiedType=sluggify(this.type),template=`systems/pf2e/templates/chat/${this.isOfType("weapon","ammo","armor","backpack")?"equipment":sluggifiedType}-card.hbs`,token=this.actor.token,nearestItem=htmlClosest(event2?.target,".item"),rollOptions=options.data??{...nearestItem?.dataset??{}},templateData={actor:this.actor,tokenId:token?`${token.parent?.id}.${token.id}`:null,item:this,data:await this.getChatData(void 0,rollOptions)},rollMode=options.rollMode??eventToRollMode(event2),chatData=ChatMessagePF2e.applyRollMode({style:CONST.CHAT_MESSAGE_STYLES.OTHER,speaker:ChatMessagePF2e.getSpeaker({actor:this.actor,token:this.actor.getActiveTokens(!1,!0).at(0)}),content:await foundry.applications.handlebars.renderTemplate(template,templateData),flags:{pf2e:{origin:this.getOriginData()}}},rollMode),operation={rollMode,renderSheet:!1};return options.create??!0?ChatMessagePF2e.create(chatData,operation):new ChatMessagePF2e(chatData,{rollMode})}async toChat(event2){return this.toMessage(event2,{create:!0})}_initialize(options){this.rules=[],this.specialOptions=[],super._initialize(options)}prepareBaseData(){if(super.prepareBaseData(),this.system.slug||=null,this.system.description.addenda=[],this.system.description.override=null,this.system.description.initialized=!1,this.system.traits.value){const validTraits=this.constructor.validTraits,original=this.system.traits.value;this.system.traits.value=[],this.system.traits.config={};for(const trait of original)trait in validTraits&&addOrUpgradeTrait(this.system.traits,trait)}const flags=this.flags;flags.pf2e=foundry.utils.mergeObject(flags.pf2e??{},{rulesSelections:{}}),e$2(flags.pf2e.grantedBy)&&(flags.pf2e.grantedBy.onDelete??=this.isOfType("physical")?"detach":"cascade");const grants=flags.pf2e.itemGrants??={};for(const grant of Object.values(grants))e$2(grant)&&(grant.onDelete??="detach");const actor=this.actor,grantedById=this.flags.pf2e.grantedBy?.id;this.grantedBy=grantedById?actor?.items.get(grantedById)??actor?.conditions.get(grantedById)??null:null}prepareRuleElements(options={}){if(!this.actor)throw ErrorPF2e("Rule elements may only be prepared from embedded items");return this.rules=this.actor.canHostRuleElements?RuleElements.fromOwnedItem({...options,parent:this}):[]}async refreshFromCompendium(options={}){if(this.uuid===this.sourceId)throw ErrorPF2e(`Item "${this.name}" (${this.uuid}) is its own source.`);if(!this.sourceId?.startsWith("Compendium."))throw ErrorPF2e(`Item "${this.name}" (${this.uuid}) has no compendium source.`);options.name??=!0,options.update??=!0,options.notify??=options.update;const currentSource=this.toObject(),localize=localizer("PF2E.Item.RefreshFromCompendium");if(currentSource.system.rules.some(r2=>typeof r2.key=="string"&&["ChoiceSet","GrantItem"].includes(r2.key)))return ui.notifications.warn(localize("Tooltip.Disabled")),null;const latestSource=(await fromUuid(this.sourceId))?.toObject();if(latestSource){if(latestSource.type!==this.type)return ui.notifications.error(localize("DifferentItemType",{item:this.name,uuid:this.uuid})),null}else return ui.notifications.warn(localize("SourceNotFound",{item:this.name,sourceId:this.sourceId})),null;const updates={name:options.name?latestSource.name:currentSource.name,img:latestSource.img,system:foundry.utils.deepClone(latestSource.system)};if(updates.system.level&&currentSource.type==="feat"&&(updates.system.level={value:updates.system.level.value,taken:currentSource.system.level.taken}),this.isOfType("physical")&&itemIsOfType(currentSource,"physical")){foundry.utils.mergeObject(updates,{"system.containerId":currentSource.system.containerId,"system.equipped":currentSource.system.equipped,"system.material":currentSource.system.material,"system.quantity":currentSource.system.quantity,"system.size":currentSource.system.size}),itemIsOfType(currentSource,"armor","shield","weapon")&&foundry.utils.mergeObject(updates,{"system.runes":currentSource.system.runes,"system.grade":currentSource.system.grade});const updatedSubitems=(await Promise.all(this.subitems.map(i=>i.refreshFromCompendium({...options,update:!1})))).filter(e$1);if(updatedSubitems.length<this.subitems.size)return ui.notifications.error(localize("SubitemFailure",{item:this.name,uuid:this.uuid})),null;if(foundry.utils.mergeObject(updates,{"system.subitems":updatedSubitems.map(i=>i.toObject())}),currentSource.type==="consumable"&&currentSource.system.spell?.system?.traits&&tupleHasValue(["scroll","wand"],currentSource.system.category)&&latestSource.type==="consumable"&&!latestSource.system.spell){const spellSourceId=currentSource._stats.compendiumSource??currentSource._stats.duplicateSource,refreshedSpell=spellSourceId?await fromUuid(spellSourceId):null;if(refreshedSpell instanceof ItemPF2e&&refreshedSpell.isOfType("spell")){const spellConsumableData=await createConsumableFromSpell(refreshedSpell,{type:currentSource.system.category,rank:currentSource.system.spell.system.location.heightenedLevel});foundry.utils.mergeObject(updates,{name:spellConsumableData.name,system:{spell:spellConsumableData.system.spell}})}else{const formatArgs={item:currentSource.system.spell.name,sourceId:spellSourceId};return ui.notifications.warn(localize("SourceNotFound",formatArgs)),null}}}else itemIsOfType(currentSource,"campaignFeature","feat","spell")&&foundry.utils.mergeObject(updates,{"system.location":currentSource.system.location});return currentSource.type==="feat"&&currentSource.system.level.taken&&foundry.utils.mergeObject(updates,{"system.level.taken":currentSource.system.level.taken}),options.update?await this.update(updates,{diff:!1,recursive:!1}):this.updateSource(updates,{recursive:!1}),options.notify&&ui.notifications.info(localize("Success",{item:this.name})),this}exportToJSON(options={}){options.clearSource??=!1,super.exportToJSON(options)}getOriginData(){return{actor:this.actor?.uuid,uuid:this.uuid,type:this.type,rollOptions:[this.actor?.getSelfRollOptions("origin"),this.getRollOptions("origin:item")].flat().filter(e$1)}}async getDescriptionData(){const actor=this.actor;if(!this.system.description.initialized&&actor){for(const alteration of actor.synthetics.itemAlterations.filter(i=>i.property==="description"))alteration.applyAlteration({singleItem:this});this.system.description.initialized=!0}return{...this.system.description}}async getDescription(htmlOptions={}){const actor=this.actor,rollOptions=new Set([actor?.getRollOptions(),this.getRollOptions("item")].flat().filter(e$1)),description=await this.getDescriptionData(),includeAddendum=htmlOptions.includeAddendum??!0,baseText=await(async()=>{const override=description?.override;return override?override.flatMap(line=>{if(!line.predicate.test(rollOptions))return[];const hr=line.divider?document.createElement("hr"):null,paragraph=createHTMLElement("p");line.title&&(paragraph.appendChild(createHTMLElement("strong",{children:[game.i18n.localize(line.title)]})),paragraph.appendChild(new Text(" ")));const text2=markdownToHTML(line.text);return text2&&paragraph.insertAdjacentHTML("beforeend",text2),[hr,paragraph].map(e2=>e2?.outerHTML).filter(e$1)}).join(`
`):description.value})(),addenda=await(async()=>{if(!includeAddendum||this.system.description.addenda.length===0)return[];const templatePath="systems/pf2e/templates/items/partials/addendum.hbs";return Promise.all(description.addenda.flatMap(unfiltered=>{const addendum={label:game.i18n.localize(unfiltered.label),contents:unfiltered.contents.filter(c=>c.predicate.test(rollOptions)).map(line=>(line.processed||(line.title&&=game.i18n.localize(line.title).trim(),line.text=markdownToHTML(line.text),line.processed=!0),line))};return addendum.contents.length>0?foundry.applications.handlebars.renderTemplate(templatePath,{addendum}):[]}))})(),assembled=[baseText,addenda.length>0?`
<hr />
`:null,...addenda].filter(e$1).join(`
`),rollData=foundry.utils.mergeObject(this.getRollData(),htmlOptions.rollData);return{value:await TextEditorPF2e.enrichHTML(assembled,{...htmlOptions,rollData}),gm:game.user.isGM?await TextEditorPF2e.enrichHTML(description.gm,{...htmlOptions,rollData}):""}}async processChatData(htmlOptions={},chatData){const description={...chatData.description,...await this.getDescription(htmlOptions)};return foundry.utils.mergeObject(chatData,{description},{inplace:!1})}async getChatData(htmlOptions={},_rollOptions={}){if(!this.actor)throw ErrorPF2e(`Cannot retrieve chat data for unowned item ${this.name}`);const data=foundry.utils.deepClone({...this.system,traits:this.traitChatData()});return this.processChatData(htmlOptions,data)}traitChatData(dictionary=this.constructor.validTraits,traits=this.system.traits.value??[]){return traits.map(trait=>{const label=game.i18n.localize(dictionary[trait]??trait),traitDescriptions2=CONFIG.PF2E.traitsDescriptions;return{value:trait,label,description:traitDescriptions2[trait]}}).sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang))}static async createDialog(data={},createOptions,options={}){options.classes=[options.classes??[],"item-create"].flat(),options.types=n([options.types??ITEM_TYPES].flat());const excludedTypes=["condition","spellcastingEntry","lore"];excludedTypes.push("affliction","book"),game.settings.get("pf2e","campaignType")!=="kingmaker"&&excludedTypes.push("campaignFeature");for(const type2 of excludedTypes)options.types.findSplice(t2=>t2===type2);return super.createDialog(data,createOptions,options)}async importFromJSON(json2){const processed=await preImportJSON(json2);return processed?super.importFromJSON(processed):this}toDragData(){return{...super.toDragData(),itemType:this.type}}static async createDocuments(data=[],operation={}){const sources=data.map(d=>d instanceof ItemPF2e?d.toObject():d);for(const source2 of[...sources]){if(source2.effects=[],source2.type==="spellcastingEntry"||e$4(t$3(source2,["flags","system"]))){const migrationSource={_migration:{version:MigrationRunnerBase.LATEST_SCHEMA_VERSION}};source2.system=foundry.utils.mergeObject(source2.system??{},migrationSource);continue}const item=new CONFIG.Item.documentClass(source2);await MigrationRunner.ensureSchemaVersion(item,MigrationList.constructFromVersion(item.schemaVersion)),data.splice(data.indexOf(source2),1,item.toObject())}const actor=operation.parent;if(!actor)return super.createDocuments(sources,operation);if(sources.some(s=>!actor.checkItemValidity(s)))return[];const effectSources=sources.filter(s=>["affliction","condition","effect"].includes(s.type));for(const source2 of effectSources){const effect=new CONFIG.PF2E.Item.documentClasses[source2.type](foundry.utils.deepClone(source2),{parent:actor}),isUnaffected=effect.isOfType("condition")&&!actor.isAffectedBy(effect),isImmune=actor.isImmuneTo(effect);if((isUnaffected||isImmune)&&(sources.splice(sources.indexOf(source2),1),!(effect.isOfType("effect")&&effect.fromAura))){const locKey=isUnaffected?"PF2E.Damage.IWR.ActorIsUnaffected":"PF2E.Damage.IWR.ActorIsImmune",message=game.i18n.format(locKey,{actor:actor.name,effect:effect.name});ui.notifications.info(message)}}const preCreateDeletions=["ancestry","background","class","heritage","deity"].filter(type2=>sources.some(s=>s.type===type2)).flatMap(type2=>actor.itemTypes[type2]),expiredDuplicateEffects=sources.filter(s=>s.type==="effect").map(s=>s._stats?.duplicateSource??s._stats?.compendiumSource).flatMap(uuid=>actor.itemTypes.effect.filter(e2=>e2.sourceId===uuid&&e2.isExpired)),idsToDelete=n([...expiredDuplicateEffects.map(i=>i.id),...preCreateDeletions.map(i=>i.id)]);idsToDelete.length>0&&await actor.deleteEmbeddedDocuments("Item",idsToDelete,{render:!1});const actorClone=actor.clone({},{keepId:!0}),items=await(async()=>{async function getSimpleGrants(item){const granted=await item.createGrantedItems?.({size:operation.parent?.size})??[];if(granted.length===0)return[];const reparented=granted.map(i=>i.parent?i:new CONFIG.Item.documentClass(i._source,{parent:actorClone}));return[...reparented,...(await Promise.all(reparented.map(getSimpleGrants))).flat()]}__name(getSimpleGrants,"getSimpleGrants"),__name2(getSimpleGrants,"getSimpleGrants");const items2=sources.map(source2=>(operation.keepId||operation.keepEmbeddedIds||(source2._id=foundry.utils.randomID()),new CONFIG.Item.documentClass(source2,{parent:actorClone})));for(const item of[...items2]){const grants=await getSimpleGrants(item);grants.length&&(operation.keepId=!0,items2.push(...grants))}return items2})(),outputSources=items.map(i=>i._source),itemUpdates=[];for(const item of[...items]){item.prepareActorData?.();const rules=item.prepareRuleElements({suppressWarnings:!0}),sourceId=item.sourceId;sourceId&&item.isOfType("feat")&&(item.suppressed||=items.some(i=>i.isOfType("feat")&&i.system.subfeatures.suppressedFeatures.includes(sourceId))||actor.itemTypes.feat.some(f=>f.system.subfeatures.suppressedFeatures.includes(sourceId)));const itemSource=item._source;for(const rule of rules){const ruleSource=itemSource.system.rules[rules.indexOf(rule)];await rule.preCreate?.({itemSource,ruleSource,pendingItems:outputSources,tempItems:items,itemUpdates,operation})}}if(outputSources.some(i=>i.type==="class")){const classFeatures=outputSources.filter(i=>i.type==="feat"&&typeof i.system?.level?.value=="number"&&i.system.category==="classfeature"&&!i.flags?.pf2e?.grantedBy);for(const feature of classFeatures)feature.sort=classFeatures.indexOf(feature)*100*(feature.system.level?.value??1)}itemUpdates.length&&await actor.updateEmbeddedDocuments("Item",itemUpdates,{render:!1});const nonKits=outputSources.filter(source2=>source2.type!=="kit");return super.createDocuments(nonKits,operation)}static async deleteDocuments(ids=[],operation={}){ids=Array.from(new Set(ids));const actor=operation.parent;if(actor){const items=ids.flatMap(id=>actor.items.get(id)??[]),containers=items.filter(i=>i.isOfType("backpack"));for(const container of containers)await container.ejectContents();for(const item of[...items]){for(const rule of item.rules)await rule.preDelete?.({pendingItems:items,operation});await processGrantDeletions(item,items)}ids=Array.from(new Set(items.map(i=>i.id))).filter(id=>actor.items.has(id))}return super.deleteDocuments(ids,operation)}async _preCreate(data,options,user){if(this.actor?.isOfType("character")&&this.isOfType("ancestry","background","class","feat","heritage")){const hpMaxDifference=this.actor.clone({items:[...this.actor.items.toObject(),data]}).hitPoints.max-this.actor.hitPoints.max;if(hpMaxDifference!==0){const newHitPoints=this.actor.hitPoints.value+hpMaxDifference;await this.actor.update({"system.attributes.hp.value":newHitPoints},{render:!1,allowHPOverage:!0})}}return this._source.system.traits.value?.sort(),this._source.system.rules=this._source.system.rules.filter(r2=>!("removeUponCreate"in r2)||!r2.removeUponCreate),super._preCreate(data,options,user)}async _preUpdate(changed,options,user){if(changed.system?.description?.value===null&&(changed.system.description.value=""),changed.system?.level&&"value"in changed.system.level&&(changed.system.level.value=Math.max(0,Math.trunc(Number(changed.system.level.value)||0))),typeof changed.system?.slug=="string"&&(changed.system.slug=sluggify(changed.system.slug)||null),changed.system?.traits){const traits=changed.system.traits;if(traits.value&&Array.isArray(traits.value)){const validTraits=[];for(const trait of traits.value)objectHasKey(this.constructor.validTraits,trait)&&addOrUpgradeTrait(validTraits,trait);traits.value=validTraits.sort()}Array.isArray(traits.otherTags)&&(traits.otherTags=traits.otherTags.map(t2=>sluggify(t2)).sort())}for(const rule of this.rules)await rule.preUpdate?.(changed);return super._preUpdate(changed,options,user)}_onCreate(data,options,userId){if(super._onCreate(data,options,userId),!(this.actor&&game.user.id===userId))return;this.actor.reset();const actorUpdates={};for(const rule of this.rules)rule.onCreate?.(actorUpdates);const updateKeys=Object.keys(actorUpdates);updateKeys.length>0&&!updateKeys.every(k=>k==="_id")&&this.actor.update(actorUpdates)}_onUpdate(data,options,userId){super._onUpdate(data,options,userId),game.ready&&game.items.get(this.id)===this&&ui.items.render()}_onDelete(options,userId){if(super._onDelete(options,userId),!(this.actor&&game.user.id===userId)||!(this.actor.isOfType("creature")&&this.canUserModify(game.user,"update")))return;const actorUpdates={};for(const rule of this.rules)rule.onDelete?.(actorUpdates);if(this.actor.isOfType("npc")&&["action","consumable"].includes(this.type)){const slug=this.slug??sluggify(this.name);if(this.actor.isToken){const promises=[];for(const item of this.actor.itemTypes.melee){const attackEffects=item.system.attackEffects.value;if(attackEffects.includes(slug)){const updatedEffects=attackEffects.filter(effect=>effect!==slug);promises.push(item.update({"system.attackEffects.value":updatedEffects}))}}promises.length>0&&Promise.allSettled(promises)}else{const itemUpdates=[];for(const attack of this.actor.itemTypes.melee){const attackEffects=attack.system.attackEffects.value;if(attackEffects.includes(slug)){const updatedEffects=attackEffects.filter(effect=>effect!==slug);itemUpdates.push({_id:attack.id,system:{attackEffects:{value:updatedEffects}}})}}itemUpdates.length>0&&foundry.utils.mergeObject(actorUpdates,{items:itemUpdates})}}const updateKeys=Object.keys(actorUpdates);updateKeys.length>0&&!updateKeys.every(k=>k==="_id")&&this.actor.update(actorUpdates)}embedHTMLString(_config,_options){return this.description}async _buildEmbedHTML(config,options={}){options.relativeTo=this;const container=document.createElement("div");return container.innerHTML=await TextEditorPF2e.enrichHTML(this.embedHTMLString(config,options),options),container.children}}const ItemProxyPF2e=new Proxy(ItemPF2e,{construct(_target,args){const source2=args[0],type2=source2?.type==="armor"&&source2.system?.category==="shield"?"shield":source2?.type==="consumable"&&source2.system?.category==="ammo"?"ammo":source2?.type,ItemClass=CONFIG.PF2E.Item.documentClasses[type2];if(!ItemClass)throw ErrorPF2e(`Item type ${type2} does not exist and item module sub-types are not supported`);return new ItemClass(...args)}});class ABCItemPF2e extends ItemPF2e{static{__name(this,"ABCItemPF2e")}static{__name2(this,"ABCItemPF2e")}get rarity(){return this.system.traits.rarity}getLinkedItems(){if(!this.actor||!objectHasKey(this.actor.itemTypes,this.type))return[];const existingABCIds=this.actor.itemTypes[this.type].map(i=>i.id);return this.actor.itemTypes.feat.filter(f=>existingABCIds.includes(f.system.location??""))}async createGrantedItems(options={}){const entries=Object.values(this.system.items);if(entries.filter(entry=>!!entry.uuid).length===0)return[];const items=(await UUIDUtils.fromUUIDs(entries.map(e2=>e2.uuid))).map(i=>i.clone()),level=options.level??this.parent?.level;return items.flatMap(item=>{if(item instanceof FeatPF2e){if(item.category==="classfeature"){const level2=entries.find(e2=>item.sourceId===e2.uuid)?.level??item.level;item.updateSource({"system.level.value":level2})}return typeof level=="number"&&level<item.level?[]:(item.updateSource({system:{location:this.id}}),item)}else return console.error(ErrorPF2e("Missing or invalid ABC item")),[]})}logAutoChange(path,value){value===0||!this.actor||(this.actor.system.autoChanges[path]=[{mode:"upgrade",level:1,value,source:this.name}])}}const DURATION_UNITS={rounds:6,minutes:60,hours:3600,days:86400},EFFECT_TIME_UNITS=["rounds","minutes","hours","days"];function calculateRemainingDuration(effect,durationData){if(durationData.unit==="encounter"){const isExpired=effect.system.expired;return{expired:!!isExpired,remaining:isExpired?0:1/0}}else if(durationData.unit==="unlimited"||!effect.system.start)return{expired:!1,remaining:1/0};const start=effect.system.start.value,{combatant}=game.combat??{},{unit,expiry}=durationData,duration=durationData.value*(DURATION_UNITS[durationData.unit]??0),addend=!combatant&&duration===0&&unit==="rounds"&&["turn-end","round-end"].includes(expiry??"")?1:0,remaining=start+duration+addend-game.time.worldTime,result={remaining,expired:remaining<=0};if(remaining===0&&combatant?.actor){const startInitiative=effect.system.start.initiative??0,currentInitiative=combatant.initiative??0,fightyActor=effect.actor?.isOfType("familiar")?effect.actor.master??effect.actor:effect.actor,atTurnStart=__name2(()=>startInitiative===currentInitiative&&combatant.actor===(effect.origin??fightyActor),"atTurnStart");result.expired=expiry==="turn-start"?atTurnStart():expiry==="turn-end"?currentInitiative<startInitiative:expiry==="round-end"?remaining<=0&&game.time.worldTime>start:!1}return result}__name(calculateRemainingDuration,"calculateRemainingDuration"),__name2(calculateRemainingDuration,"calculateRemainingDuration");class AbstractEffectPF2e extends ItemPF2e{static{__name(this,"AbstractEffectPF2e")}static{__name2(this,"AbstractEffectPF2e")}static get validTraits(){return CONFIG.PF2E.effectTraits}get origin(){const originUUID=this.system.context?.origin.actor;if(!originUUID||originUUID===this.actor?.uuid)return this.actor;if(originUUID.startsWith("Compendium."))return null;if(originUUID.startsWith("Scene.")){const tokenUUID=originUUID.replace(/\.Actor\..+$/,""),tokenDoc=fromUuidSync(tokenUUID);if(!(tokenDoc instanceof TokenDocumentPF2e))return null;const descriptor=Object.getOwnPropertyDescriptor(tokenDoc,"delta");return descriptor?.value instanceof ActorDelta?descriptor.value.syntheticActor??null:null}return fromUuidSync(originUUID)}get traits(){return new Set(this.system.traits.value)}get isIdentified(){return!0}get isLocked(){return!1}get fromSpell(){return this.system.fromSpell}get totalDuration(){const{duration}=this.system;return["unlimited","encounter"].includes(duration.unit)?1/0:duration.value*(DURATION_UNITS[duration.unit]??0)}get remainingDuration(){return calculateRemainingDuration(this,this.system.duration)}getRollOptions(prefix,options){const context=this.system.context,originRollOptions=(()=>{const existingOptions=context?.origin.rollOptions.map(o=>`${prefix}:${o}`);if(existingOptions?.length)return existingOptions;const origin=this.origin;return!!origin?.flags?.pf2e?.rollOptions?origin.getSelfRollOptions("origin").map(o=>`${prefix}:${o}`)??[]:[]})();originRollOptions.length>0&&(originRollOptions.push(`${prefix}:origin`),originRollOptions.some(o=>o.startsWith(`${prefix}:origin:item:`))&&originRollOptions.push(`${prefix}:origin:item`));const grantingItem=this.grantedBy?.getRollOptions(`${prefix}:granter`)??[],badge=this.badge,rollContext={degree:context?.roll?.degreeOfSuccess,total:context?.roll?.total};return[...super.getRollOptions(prefix,options),...grantingItem,...Object.entries({[`badge:type:${badge?.type}`]:!!badge,[`badge:value:${badge?.value}`]:!!badge,[`context:check:outcome:${rollContext.degree}`]:typeof rollContext.degree=="number",[`context:check:total:${rollContext.total}`]:typeof rollContext.total=="number","from-spell":this.fromSpell}).filter(([,isTrue])=>isTrue).map(([key])=>`${prefix}:${key}`),...originRollOptions]}prepareBaseData(){super.prepareBaseData();const slug=this.slug??sluggify(this.name);this.rollOptionSlug=slug.replace(/^(?:[a-z]+-)?(?:effect|stance)-/,""),this.system.fromSpell??=!1}prepareActorData(){const actor=this.actor;if(!actor)throw ErrorPF2e("prepareActorData called from unembedded item");actor.rollOptions.all[`self:${this.type}:${this.rollOptionSlug}`]=!0;const badge=this.badge;if(typeof badge?.value=="number"){const values=actor.items.filter(i=>i instanceof AbstractEffectPF2e&&i.rollOptionSlug===this.rollOptionSlug).map(effect=>effect.badge?.value).filter(value=>typeof value=="number");badge.value>=Math.max(...values)&&(actor.rollOptions.all[`self:${this.type}:${this.rollOptionSlug}:${badge.value}`]=!0)}}_preCreate(data,options,user){return data.system??={},data.system.fromSpell??=(()=>{if((this.slug??sluggify(this.name)).startsWith("spell-effect-"))return!0;const originItem=fromUuidSync(this.system.context?.origin.item??"");return originItem instanceof ItemPF2e&&(originItem.isOfType("spell")||originItem.isOfType("affliction","condition","effect")&&originItem.fromSpell)})(),super._preCreate(data,options,user)}_onCreate(data,options,userId){super._onCreate(data,options,userId),this.handleChange({create:this})}_onDelete(options,userId){super._onDelete(options,userId),this.handleChange({delete:{name:this._source.name}})}handleChange(change){const skipFloatyText=this.isOfType("condition")&&!game.user.isGM&&!this.actor?.hasPlayerOwner&&game.settings.get("pf2e","metagame_secretCondition"),auraNotInCombat=this.flags.pf2e.aura&&!game.combat?.started,identified=game.user.isGM||this.isIdentified;if(!(skipFloatyText||!identified||auraNotInCombat)){if(this.isLocked||this.actor?.getActiveTokens().shift()?.showFloatyText(change),this.isOfType("condition"))for(const token of this.actor?.getActiveTokens()??[])token._onApplyStatusEffect(this.rollOptionSlug,!1);game.pf2e.StatusEffects.refresh()}}}class PhysicalItemPF2e extends ItemPF2e{static{__name(this,"PhysicalItemPF2e")}static{__name2(this,"PhysicalItemPF2e")}parentItem;effectSpinoffs;constructor(data,context={}){super(data,context),this.parentItem=context.parentItem??null,this.effectSpinoffs=new Map,Object.defineProperty(this,"effectSpinoffs",{enumerable:!1})}get level(){return this.system.level.value}get rarity(){return this.system.traits.rarity}get traits(){return new Set(this.system.traits.value)}get quantity(){return Number(this.system.quantity??1)}get size(){return this.system.size}get hitPoints(){return foundry.utils.deepClone(this.system.hp)}get hardness(){return this.system.hardness}get isEquipped(){return this.system.usage.type==="installed"?!!this.parentItem?.isEquipped:isEquipped(this.system.usage,this.system.equipped)}get carryType(){return this.system.equipped.carryType}get isHeld(){return this.handsHeld>0}get handsHeld(){return this.system.equipped.carryType==="held"?this.system.equipped.handsHeld??1:0}get isWorn(){return this.system.equipped.carryType==="worn"}get isAttachable(){return!1}get price(){return this.system.price}get assetValue(){const baseValue=Coins.fromPrice(this.price,this.quantity);return this.isSpecific?baseValue:this.subitems.reduce((total,i)=>total.plus(Coins.fromPrice(i.price,i.quantity)),baseValue)}get identificationStatus(){return this.system.identification.status}get isIdentified(){return this.system.identification.status==="identified"}get isAlchemical(){return this.system.traits.value.includes("alchemical")}get isMagical(){return this.system.traits.value.some(t2=>t2==="magical"||setHasElement(MAGIC_TRADITIONS,t2))}get isInvested(){return this.system.traits.value.includes("invested")?(this.isEquipped||!["implanted","worn"].includes(this.system.usage.type))&&!this.isStowed&&this.isIdentified&&this.system.equipped.invested===!0:null}get isCursed(){return this.system.traits.value.includes("cursed")}get isTemporary(){return this.system.temporary}get isShoddy(){return this.system.traits.otherTags.includes("shoddy")}get isDamaged(){return this.system.hp.value>0&&this.system.hp.value<this.system.hp.max}get isBroken(){const{hitPoints}=this;return hitPoints.max>0&&!this.isDestroyed&&hitPoints.value<=hitPoints.brokenThreshold}get isDestroyed(){const{hitPoints}=this;return hitPoints.max>0&&hitPoints.value===0}get material(){return foundry.utils.deepClone(this.system.material)}get isSpecific(){return!1}get isInContainer(){return!!this.container}get isStowed(){const container=this.container;return!!container&&(container.system.stowing||container.isStowed)}get container(){return this.updateContainerCache(),this._container??null}get bulk(){const per=this.system.bulk.per,bulkRelevantQuantity=Math.floor(this.quantity/per),actorSize=this.actor?.isOfType("creature")?this.actor.size:null;return new Bulk(this.system.bulk.value).convertToSize(this.size,actorSize??this.size).times(bulkRelevantQuantity)}get uuid(){return this.parentItem?`${this.parentItem.uuid}.${this.documentName}.${this.id}`:super.uuid}acceptsSubitem(){return!1}getRollOptions(prefix,options){const rollOptions=super.getRollOptions(prefix,options),{material}=this.system;return rollOptions.push(...Object.entries({equipped:this.isEquipped,[`hands-held:${this.handsHeld}`]:this.handsHeld>0,uninvested:this.isInvested===!1,[`material:${material.type}`]:!!material.type}).filter(e2=>!!e2[1]).map(e2=>`${prefix}:${e2[0]}`)),rollOptions}_initialize(options){delete this._container,this.subitems??=new Collection,super._initialize(options)}prepareBaseData(){super.prepareBaseData(),this.system.containerId||=null,this.system.material.type||=null,this.system.material.grade||=null,this.system.material.effects??=[],this.type!=="treasure"&&(this.system.stackGroup??=null),this.system.hp.brokenThreshold=Math.floor(this.system.hp.max/2),this.system.traits.value.includes("infused")&&(this.system.temporary=!0),this.system.price.value=new Coins(this.system.temporary?{}:this.system.price.value),this.system.price.per=Math.max(1,this.system.price.per??1),this.system.price.sizeSensitive??=!0,this.system.usage=getUsageDetails(this.system.usage?.value??"carried");const{equipped,usage}=this.system;equipped.handsHeld??=0,equipped.carryType??="worn",usage.type==="worn"&&usage.where&&(equipped.inSlot??=!1),this.actor?.isOfType("loot")&&(equipped.carryType="worn",equipped.inSlot=!1),this._container?.id!==this.system.containerId&&delete this._container;for(const subitemSource of this.system.subitems??[]){subitemSource.system.equipped=t$3(this.system.equipped,["carryType","handsHeld"]);const preExisting=this.subitems.get(subitemSource._id??""),item=preExisting??new ItemProxyPF2e(subitemSource,{parent:this.parent,parentItem:this}),diff=item.updateSource(subitemSource);preExisting&&e$4(diff)&&item._initialize(),this.subitems.set(item.id,item)}const subitemIds=this.system.subitems?.flatMap(i=>i._id??[])??[];for(const subitem of this.subitems)subitemIds.includes(subitem.id)||this.subitems.delete(subitem.id);this.system.bulk=prepareBulkData(this),this.system.temporary??=!1,this.system.apex&&(this.traits.has("apex")?this.isInvested||(this.system.apex.selected=!1):delete this.system.apex),this.effectSpinoffs?.clear()}prepareDerivedData(){super.prepareDerivedData(),this.name=game.pf2e.system.generateItemName(this),this.system.identification.identified??={name:this.name,img:this.img,data:{description:{value:this.description}}},this.isMagical&&(this.system.price.sizeSensitive=!1);const{level,rarity,price}=computeLevelRarityPrice(this);this.system.level.value=level,this.system.traits.rarity=rarity,this.system.price.value=price;const mystifiedData=this.getMystifiedData(this.identificationStatus);this.name=mystifiedData.name,this.img=mystifiedData.img,this.system.description.value=mystifiedData.data.description.value,this.system.identification.unidentified=this.getMystifiedData("unidentified"),this.isEmbedded||(this.system.hp.value=Math.clamp(this.system.hp.value,0,this.system.hp.max))}prepareSiblingData(){if(this.actor){if(this.isStowed&&(this.system.equipped.carryType="stowed",delete this.system.equipped.inSlot),this._container&&!this.actor.items.has(this._container.id)&&(this.system.containerId=null,delete this._container),this.system.apex){const otherApexData=this.actor.inventory.contents.flatMap(e2=>e2===this?[]:e2.system.apex??[]);if(this.system.apex.selected||this.isInvested&&otherApexData.every(d=>!d.selected)){this.system.apex.selected=!0;for(const data of otherApexData)data.selected=!1}}for(const subitem of this.subitems)subitem.prepareSiblingData()}}prepareRuleElements(options){const rules=super.prepareRuleElements(options);if(this.actor?.canHostRuleElements)for(const subitem of this.subitems)rules.push(...subitem.prepareRuleElements());return rules}onPrepareSynthetics(){this.system.hp.value=Math.clamp(this.system.hp.value,0,this.system.hp.max);for(const subitem of this.subitems)subitem.onPrepareSynthetics()}prepareActorData(){const actor=this.actor;if(actor?.isOfType("character")){this.system.apex?.selected&&(actor.system.build.attributes.apex?this.system.apex.selected=!1:actor.system.build.attributes.apex=this.system.apex.attribute);for(const subitem of this.subitems)subitem.prepareActorData()}}getEmbeddedDocument(embeddedName,id,options){return embeddedName==="Item"?this.subitems.get(id,options):super.getEmbeddedDocument(embeddedName,id,options)}async attach(item,{quantity=1,stack=!1}={}){if(!this._source.system.subitems)throw ErrorPF2e("This item does not accept attachments");const actor=this.actor,purgedItems=this.isOfType("weapon")?this.subitems.filter(i=>i.isOfType("ammo","weapon")&&i.isAmmoFor(this)&&(!i.quantity||i.isOfType("ammo")&&i.isMagazine&&!i.system.uses.value)):[],purgedItemIds=purgedItems.map(i=>i.id),subitems=foundry.utils.deepClone(this._source.system.subitems).filter(i=>i._id&&!purgedItemIds.includes(i._id)),ejected=purgedItems.filter(i=>i.isOfType("ammo")&&i.isMagazine&&!i.system.uses.autoDestroy);if(actor&&ejected.length){const items=ejected.map(e2=>{const source2=e2.toObject();return source2.system.equipped=getDefaultEquipStatus(e2),e2.system.traits.value.includes("consumable")&&(source2.system=foundry.utils.mergeObject(source2.system,{uses:{value:e2.system.uses.max}})),source2});await actor.inventory.add(items,{stack:!0,render:!1})}const validCarryTypes=["attached","installed"],attachmentSource=item.toObject();attachmentSource.system.quantity=quantity,attachmentSource.system.equipped={carryType:validCarryTypes.find(c=>c===item.system.usage.type)??"attached",handsHeld:0},item.isOfType("ammo")&&this.isOfType("weapon")&&!item.system.baseItem&&item.system.craftableAs&&(attachmentSource.system.baseItem=this.system.ammo?.baseType??"arrows");const matchingId=stack?this.subitems.contents.find(s=>s.isStackableWith(item))?.id:null,matching=matchingId?subitems.find(s=>s._id===matchingId):null;matching?matching.system.quantity+=quantity:(subitems.some(s=>s._id===attachmentSource._id)&&(attachmentSource._id=foundry.utils.randomID()),subitems.push(attachmentSource));const newQuantity=item.quantity-quantity,existingItemUpdate={"system.quantity":newQuantity};if(item.isOfType("ammo")&&(existingItemUpdate["system.uses.value"]=item.system.uses.max),actor&&actor.uuid===item.actor?.uuid&&this.id&&!this.parentItem){const updates=createActorGroupUpdate({itemUpdates:[{_id:this.id,"system.subitems":subitems}],itemDeletes:newQuantity<=0?[item.id]:[]});return newQuantity>0&&updates.itemUpdates.push({_id:item.id,...existingItemUpdate}),await applyActorGroupUpdate(actor,updates),!0}else return(await Promise.all([newQuantity<=0?item.delete():item.update(existingItemUpdate),this.update({"system.subitems":subitems})])).every(u=>!!u)}async detach({skipConfirm,quantity=this.quantity,keepZero=!1}={}){const parentItem=this.parentItem;if(quantity=Math.clamp(quantity,0,this.quantity),!parentItem)throw ErrorPF2e("Subitem has no parent item");const localize=localizer("PF2E.Item.Physical.Attach.Detach");if(skipConfirm||await foundry.applications.api.DialogV2.confirm({window:{title:localize("Label")},content:createHTMLElement("p",{children:[localize("Prompt",{attachable:this.name})]}).outerHTML,yes:{default:!0}})){const updateDeletePromise=quantity>=this.quantity&&!keepZero?this.delete():this.update({"system.quantity":Math.max(0,this.quantity-quantity)}),createPromise=(async()=>{const subitemData=this.toObject();subitemData.system.equipped.carryType="worn";const isWeaponAmmo=this.isOfType("weapon")&&parentItem.isOfType("weapon")&&this.isAmmoFor(parentItem),stack=this.isOfType("consumable","ammo")||isWeaponAmmo?parentItem.actor?.inventory.findStackableItem(subitemData):null,keepId=!!parentItem.actor&&!parentItem.actor.items.has(this.id);return stack?.update({"system.quantity":stack.quantity+quantity})??Item.implementation.create(foundry.utils.mergeObject(subitemData,{"system.containerId":parentItem.system.containerId}),{parent:parentItem.actor,keepId})})();await Promise.all([updateDeletePromise,createPromise])}}isStackableWith(item){if(!(this!==item&&this.type===item.type&&this.name===item.name&&this.isIdentified===item.isIdentified)||item.isOfType("ammo","consumable")&&item.system.uses.value<item.system.uses.max||!this.parentItem&&!this.container&&!(this.isHeld===item.isHeld&&(!this.isHeld||this.quantity===0||item.quantity===0)))return!1;const thisData=this.toObject().system,otherData=item.toObject().system;return thisData.price.value={cp:new Coins(thisData.price.value).copperValue},otherData.price.value={cp:new Coins(otherData.price.value).copperValue},thisData.quantity=otherData.quantity,thisData.equipped=otherData.equipped,thisData.containerId=otherData.containerId,thisData._migration=otherData._migration,thisData.identification=otherData.identification,thisData.publication=otherData.publication,t$6(thisData,otherData)}async stackWith(targetItem){if(this.isStackableWith(targetItem)){const stackQuantity=this.quantity+targetItem.quantity;await this.delete({render:!1})&&await targetItem.update({"system.quantity":stackQuantity})}}async move({relativeTo,sortBefore,toContainer,toStack,render=!0}){if(!this.actor)throw ErrorPF2e("Tried to move an unonwned item!");if(toStack)return this.stackWith(toStack);const containerResolved=toContainer??relativeTo?.container,mainContainerUpdate=(()=>{if(containerResolved&&!isContainerCycle(this,containerResolved)){const equipped={carryType:containerResolved.stowsItems?"stowed":"worn",handsHeld:0,inSlot:!1};return{system:{containerId:containerResolved.id,equipped}}}return!containerResolved&&this.isInContainer?{system:{containerId:null,equipped:{carryType:"worn",handsHeld:0,inSlot:!1}}}:null})(),inventory=this.actor.inventory,siblings=(containerResolved?.contents.contents??inventory.contents).sort((a,b)=>a.sort-b.sort);if(!sortBefore&&siblings.length===0&&mainContainerUpdate){await this.update(mainContainerUpdate);return}const updates=foundry.utils.performIntegerSort(this,{target:relativeTo,siblings,sortBefore}).map(s=>{const baseUpdate={_id:s.target.id,...s.update};return mainContainerUpdate&&s.target.id===this.id?foundry.utils.mergeObject(baseUpdate,mainContainerUpdate):baseUpdate}),stowedOrUnstowed=!this.container&&!!containerResolved||this.container&&!containerResolved;await this.actor.updateEmbeddedDocuments("Item",updates,{render:stowedOrUnstowed||render})}getMystifiedData(status,_options){const mystifiedData=this.system.identification?.[status],name2=mystifiedData?.name||this.generateUnidentifiedName(),img2=mystifiedData?.img||getUnidentifiedPlaceholderImage(this),description=mystifiedData?.data.description.value||(()=>{if(status==="identified")return this.description;const itemType=this.generateUnidentifiedName({typeOnly:!0}),caseCorrect=__name2(noun=>game.i18n.lang.toLowerCase()==="de"?noun:noun.toLowerCase(),"caseCorrect");return game.i18n.format("PF2E.identification.UnidentifiedDescription",{item:caseCorrect(itemType)})})();return{name:name2,img:img2,data:{description:{value:description}}}}async getChatData(){const{type:type2,grade}=this.system.material,material=type2&&grade?game.i18n.format("PF2E.Item.Weapon.MaterialAndRunes.MaterialOption",{type:game.i18n.localize(CONFIG.PF2E.preciousMaterials[type2]),grade:game.i18n.localize(CONFIG.PF2E.preciousMaterialGrades[grade])}):null;return{rarity:this.rarity==="common"?null:{slug:this.rarity,label:CONFIG.PF2E.rarityTraits[this.rarity],description:CONFIG.PF2E.traitsDescriptions[this.rarity]},description:this.system.description,price:this.system.price.value.toString(),material}}async setIdentificationStatus(status){this.identificationStatus!==status&&await this.update({"system.identification.status":status,"system.identification.unidentified":this.getMystifiedData("unidentified")})}generateUnidentifiedName({typeOnly=!1}={}){const itemType=game.i18n.localize(`TYPES.Item.${this.type}`);return typeOnly?itemType:game.i18n.format("PF2E.identification.UnidentifiedItem",{item:itemType})}updateContainerCache(seen=[]){if("_container"in this)return;const container=this.actor?.items.get(this.system.containerId??"")??null;!container?.isOfType("backpack")||this.id===container.id||seen.includes(container.id)?this._container=null:(seen.push(this.id),this._container=container,container.updateContainerCache(seen))}traitChatData(dictionary){const traitData=super.traitChatData(dictionary);for(const trait of traitData)if(trait.mystified=!this.isIdentified&&MystifiedTraits.has(trait.value),trait.excluded=trait.mystified&&!game.user.isGM,trait.excluded)delete trait.description;else if(trait.mystified){const gmNote=game.i18n.localize("PF2E.identification.TraitGMNote");trait.description=trait.description?`${gmNote}

${game.i18n.localize(trait.description)}`:gmNote}return traitData}async update(data,operation={}){if(this.parentItem){const parentItem=this.parentItem,newSubitems=parentItem._source.system.subitems?.map(i=>i._id===this.id?foundry.utils.mergeObject(i,data,{...operation,inplace:!1}):i),parentContext={...operation,diff:!0,recursive:!0};return await parentItem.update({system:{subitems:newSubitems}},parentContext)?(this._onUpdate(data,{action:"update",broadcast:!1,updates:[],...operation},game.user.id),this):void 0}return super.update(data,operation)}async delete(operation={}){if(this.parentItem){const parentItem=this.parentItem,newSubitems=parentItem._source.system.subitems?.filter(i=>i._id!==this.id)??[];return await parentItem.update({"system.subitems":newSubitems},n$1(operation,["action"]))?(this._onDelete(operation,game.user.id),this):void 0}return super.delete(operation)}async _preCreate(data,options,user){return(!this.actor||this._source.system.containerId?.length!==16)&&(this._source.system.containerId=null),delete this._source.system.apex?.selected,this.actor||(this._source.system.equipped=getDefaultEquipStatus(this)),super._preCreate(data,options,user)}async _preUpdate(changed,operation,user){if(!changed.system)return super._preUpdate(changed,operation,user);for(const property of["quantity","hardness"])if(changed.system[property]!==void 0){const max=property==="quantity"?999999:999;changed.system[property]=Math.clamp(Math.trunc(Number(changed.system[property])),0,max)||0}if((operation.checkHP??!0)&&handleHPChange(this,changed),e$2(changed.system.price)){const price=changed.system.price;if(e$2(price.value)){const coins=price.value;for(const denomination of COIN_DENOMINATIONS)coins[denomination]===0&&(coins[`-=${denomination}`]=null)}"per"in price&&(price.per=Math.max(1,Math.floor(Number(price.per)||1)))}const equipped=changed.system.equipped??{};equipped.carryType==="dropped"&&this.system.equipped.invested&&(equipped.invested=!1),String(equipped.carryType??this.system.equipped.carryType).startsWith("held")||(equipped.handsHeld=0);const newUsage=getUsageDetails(String(changed.system.usage?.value??this.system.usage.value)),hasSlot=newUsage.type==="worn"&&newUsage.where,isSlotted=!!(equipped.inSlot??this.system.equipped.inSlot);hasSlot?equipped.inSlot=isSlotted:"inSlot"in(this._source.system.equipped??{})&&(equipped["-=inSlot"]=null);const changedTraits=changed.system?.traits?.value;return!(tupleHasValue(this._source.system.traits.value,"apex")&&(!Array.isArray(changedTraits)||tupleHasValue(changedTraits,"apex")))&&this._source.system.apex&&(delete changed.system?.apex,changed.system??={},changed.system=foundry.utils.mergeObject(changed.system,{"-=apex":null})),super._preUpdate(changed,operation,user)}}const fields$t=foundry.data.fields;class EffectContextField extends fields$t.SchemaField{static{__name(this,"EffectContextField")}static{__name2(this,"EffectContextField")}constructor(){super({origin:new fields$t.SchemaField({actor:new fields$t.DocumentUUIDField({required:!0,nullable:!1}),token:new fields$t.DocumentUUIDField({required:!1,nullable:!0,initial:null}),item:new fields$t.DocumentUUIDField({required:!1,nullable:!0,initial:null}),spellcasting:new fields$t.SchemaField({attribute:new fields$t.SchemaField({type:new fields$t.StringField({choices:[...ATTRIBUTE_ABBREVIATIONS],required:!0,nullable:!1}),mod:new fields$t.NumberField({required:!0,nullable:!1})}),tradition:new fields$t.StringField},{required:!1,nullable:!0,initial:null}),rollOptions:new fields$t.ArrayField(new fields$t.StringField({required:!0,blank:!1}))}),target:new fields$t.SchemaField({actor:new fields$t.DocumentUUIDField({required:!0,nullable:!1}),token:new fields$t.DocumentUUIDField({required:!1,nullable:!0,initial:null})},{required:!1,nullable:!0,initial:null}),roll:new fields$t.SchemaField({total:new fields$t.NumberField({required:!0,nullable:!1}),degreeOfSuccess:new fields$t.NumberField({required:!1,nullable:!0,initial:null,min:0,max:3})},{required:!0,nullable:!0,initial:null})},{required:!1,nullable:!0,initial:null})}}var define_CONDITION_SOURCES_default=[{_id:"1wQY3JYyhMYeeV2G",img:"systems/pf2e/icons/conditions/observed.webp",name:"Observed",system:{description:{value:"<p>Anything in plain view is observed by you. If a creature takes measures to avoid detection, such as by using Stealth to @UUID[Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa]{Hide}, it can become @UUID[Compendium.pf2e.conditionitems.Item.iU0fEDdBp3rXpTMC]{Hidden} or @UUID[Compendium.pf2e.conditionitems.Item.VRSef5y1LmL2Hkjf]{Undetected} instead of observed. If you have another precise sense besides sight, you might be able to observe a creature or object using that sense instead. You can observe a creature with only your precise senses. When @UUID[Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ]{Seeking} a creature using only imprecise senses, it remains hidden, rather than observed.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:"detection",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"observed",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.1wQY3JYyhMYeeV2G"},effects:[]},{_id:"3uh1r86TzbQvosxv",img:"systems/pf2e/icons/conditions/doomed.webp",name:"Doomed",system:{description:{value:`<p>Your soul has been gripped by a powerful force that calls you closer to death. Doomed always includes a value. The @UUID[Compendium.pf2e.conditionitems.Item.yZRUzMqrMmfLu0V1]{Dying} value at which you die is reduced by your doomed value. If your maximum dying value is reduced to 0, you instantly die. When you die, you're no longer doomed.</p>
<p>Your doomed value decreases by 1 each time you get a full night's rest.</p>`},duration:{expiry:null,unit:"unlimited",value:0},group:"death",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!0,value:1},slug:"doomed",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.3uh1r86TzbQvosxv"},effects:[]},{_id:"4D2KBtexWXa6oUMR",img:"systems/pf2e/icons/conditions/drained.webp",name:"Drained",system:{active:!1,description:{value:`<p>Your health and vitality have been depleted as you've lost blood, life force, or some other essence. Drained always includes a value. You take a status penalty equal to your drained value on Constitution-based rolls and DCs, such as Fortitude saves. You also lose a number of Hit Points equal to your level (minimum 1) times the drained value, and your maximum Hit Points are reduced by the same amount. For example, if you become drained 3 and you're a 3rd-level character, you lose 9 Hit Points and reduce your maximum Hit Points by 9. Losing these Hit Points doesn't count as taking damage.</p>
<p>Each time you get a full night's rest, your drained value decreases by 1. This increases your maximum Hit Points, but you don't immediately recover the lost Hit Points.</p>`},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:"abilities",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[{key:"FlatModifier",selector:"con-based",slug:"drained",type:"status",value:"-1 * @item.badge.value"},{key:"FlatModifier",selector:"hp",slug:"drained",type:"status",value:"min(-1 * @actor.level,-1) * @item.badge.value"},{key:"LoseHitPoints",reevaluateOnUpdate:!0,value:"max(1,@actor.level) * @item.badge.value"}],traits:{value:[]},value:{immutable:!1,isValued:!0,value:1},slug:"drained",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.4D2KBtexWXa6oUMR"},effects:[]},{_id:"6dNUvdb1dhToNDj3",img:"systems/pf2e/icons/conditions/broken.webp",name:"Broken",system:{description:{value:`<p>Broken is a condition that affects only objects. An object is broken when damage has reduced its Hit Points to equal or less than its Broken Threshold. A broken object can't be used for its normal function, nor does it grant bonuses\u2014with the exception of armor. Broken armor still grants its item bonus to AC, but it also imparts a status penalty to AC depending on its category: \u20131 for broken light armor, \u20132 for broken medium armor, or \u20133 for broken heavy armor.</p>
<p>A broken item still imposes penalties and limitations normally incurred by carrying, holding, or wearing it. For example, broken armor would still impose its Dexterity modifier cap, check penalty, and so forth. If an effect makes an item broken automatically and the item has more HP than its Broken Threshold, that effect also reduces the item's current HP to the Broken Threshold.</p>`},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"broken",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.6dNUvdb1dhToNDj3"},effects:[]},{_id:"6uEgoh53GbXuHpTF",img:"systems/pf2e/icons/conditions/paralyzed.webp",name:"Paralyzed",system:{description:{value:"<p>You're frozen in place. You have the @UUID[Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg]{Off-Guard} condition and can't act except to @UUID[Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo]{Recall Knowledge} and use actions that require only your mind (as determined by the GM). Your senses still function, but only in the areas you can perceive without moving, so you can't @UUID[Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ]{Seek}.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"ActiveEffectLike",mode:"override",path:"system.attributes.flanking.canFlank",value:!1},{inMemoryOnly:!0,key:"GrantItem",uuid:"Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg"}],traits:{value:[]},value:{isValued:!1,value:null},slug:"paralyzed",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.6uEgoh53GbXuHpTF"},effects:[]},{_id:"9evPzg9E6muFcoSk",img:"systems/pf2e/icons/conditions/unnoticed.webp",name:"Unnoticed",system:{description:{value:"<p>If you're unnoticed by a creature, that creature has no idea you're present. When you're unnoticed, you're also @UUID[Compendium.pf2e.conditionitems.Item.VRSef5y1LmL2Hkjf]{Undetected}. This matters for abilities that can be used only against targets totally unaware of your presence.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:"detection",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"unnoticed",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.9evPzg9E6muFcoSk"},effects:[]},{_id:"9PR9y0bi4JPKnHPR",img:"systems/pf2e/icons/conditions/deafened.webp",name:"Deafened",system:{description:{value:"<p>You can't hear. You automatically critically fail Perception checks that require you to be able to hear. You take a \u20132 status penalty to Perception checks for initiative and checks that involve sound but also rely on other senses. If you perform an action that has the auditory trait, you must succeed at a @Check[flat|showDC:all|dc:5] or the action is lost; attempt the check after spending the action but before any effects are applied. You are immune to auditory effects while deafened.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:"senses",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"FlatModifier",predicate:[{or:[{and:["check:type:skill","item:trait:auditory"]},{and:["check:statistic:base:perception","check:statistic:initiative"]}]}],selector:["perception","skill-check"],slug:"deafened",type:"status",value:-2},{key:"Immunity",type:"auditory"},{itemType:"action",key:"ItemAlteration",mode:"add",predicate:["item:trait:auditory"],property:"description",value:[{text:"PF2E.condition.deafened.note"}]},{itemType:"feat",key:"ItemAlteration",mode:"add",predicate:["item:trait:auditory"],property:"description",value:[{text:"PF2E.condition.deafened.note"}]},{itemType:"spell",key:"ItemAlteration",mode:"add",predicate:[{not:"item:trait:subtle"}],property:"description",value:[{text:"PF2E.condition.deafened.note"}]},{adjustment:{all:"to-critical-failure"},key:"AdjustDegreeOfSuccess",predicate:["item:trait:auditory"],selector:"perception"}],traits:{value:[]},value:{isValued:!1,value:null},slug:"deafened",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.9PR9y0bi4JPKnHPR"},effects:[]},{_id:"9qGBRpbX9NEwtAAr",img:"systems/pf2e/icons/conditions/controlled.webp",name:"Controlled",system:{description:{value:"<p>You have been commanded, magically dominated, or otherwise had your will subverted. The controller dictates how you act and can make you use any of your actions, including attacks, reactions, or even @UUID[Compendium.pf2e.actionspf2e.Item.A72nHGUtNXgY5Ey9]{Delay}. The controller usually doesn't have to spend their own actions when controlling you.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"controlled",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.9qGBRpbX9NEwtAAr"},effects:[]},{_id:"AdPVz7rbaVSRxHFg",img:"systems/pf2e/icons/conditions/fascinated.webp",name:"Fascinated",system:{active:!1,description:{value:"<p>You're compelled to focus your attention on something, distracting you from whatever else is going on around you. You take a \u20132 status penalty to Perception and skill checks, and you can't use concentrate actions unless they (or their intended consequences) are related to the subject of your fascination, as determined by the GM. For instance, you might be able to @UUID[Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ]{Seek} and @UUID[Compendium.pf2e.actionspf2e.Item.1OagaWtBpVXExToo]{Recall Knowledge} about the subject, but you likely couldn't cast a spell targeting a different creature. This condition ends if a creature uses hostile actions against you or any of your allies.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[{key:"FlatModifier",selector:["perception","skill-check"],slug:"fascinated",type:"status",value:-2}],traits:{value:[]},value:{isValued:!1,value:null},slug:"fascinated",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.AdPVz7rbaVSRxHFg"},effects:[]},{_id:"AJh5ex99aV6VTggg",img:"systems/pf2e/icons/conditions/off-guard.webp",name:"Off-Guard",system:{active:!1,description:{value:`<p>You're distracted or otherwise unable to focus your full attention on defense. You take a \u20132 circumstance penalty to AC. Some effects give you the off-guard condition only to certain creatures or against certain attacks. Others\u2014especially conditions\u2014can make you off-guard against everything. If a rule doesn't specify that the condition applies only to certain circumstances, it applies to all of them, such as "The target is off-guard."</p>`},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[{key:"FlatModifier",selector:"ac",slug:"off-guard",type:"circumstance",value:-2}],traits:{value:[]},value:{isValued:!1,value:null},slug:"off-guard",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg"},effects:[]},{_id:"D5mg6Tc7Jzrj6ro7",img:"systems/pf2e/icons/conditions/encumbered.webp",name:"Encumbered",system:{description:{value:"<p>You are carrying more weight than you can manage. While you're encumbered, you're @UUID[Compendium.pf2e.conditionitems.Item.i3OJZU2nk64Df3xm]{Clumsy 1} and take a 10-foot penalty to all your Speeds. As with all penalties to your Speed, this can't reduce your Speed below 5 feet.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"FlatModifier",selector:"all-speeds",slug:"encumbered",value:-10},{inMemoryOnly:!0,key:"GrantItem",uuid:"Compendium.pf2e.conditionitems.Item.i3OJZU2nk64Df3xm"}],traits:{value:[]},value:{isValued:!1,value:null},slug:"encumbered",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.D5mg6Tc7Jzrj6ro7"},effects:[]},{_id:"dfCMdR4wnpbYNTix",img:"systems/pf2e/icons/conditions/stunned.webp",name:"Stunned",system:{description:{value:`<p>You've become senseless. You can't act. Stunned usually includes a value, which indicates how many total actions you lose, possibly over multiple turns, from being stunned. Each time you regain actions, reduce the number you regain by your stunned value, then reduce your stunned value by the number of actions you lost. For example, if you were stunned 4, you would lose all 3 of your actions on your turn, reducing you to stunned 1; on your next turn, you would lose 1 more action, and then be able to use your remaining 2 actions normally. Stunned might also have a duration instead, such as "stunned for 1 minute," causing you to lose all your actions for the duration.</p>
<p>Stunned overrides @UUID[Compendium.pf2e.conditionitems.Item.xYTAsEpcJE1Ccni3]{Slowed}. If the duration of your stunned condition ends while you are slowed, you count the actions lost to the stunned condition toward those lost to being slowed. So, if you were stunned 1 and slowed 2 at the beginning of your turn, you would lose 1 action from stunned, and then lose only 1 additional action by being slowed, so you would still have 1 action remaining to use that turn.</p>`},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:["slowed"],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!0,value:1},slug:"stunned",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.dfCMdR4wnpbYNTix"},effects:[]},{_id:"DmAIPqOBomZ7H95W",img:"systems/pf2e/icons/conditions/concealed.webp",name:"Concealed",system:{active:!1,description:{value:"<p>You are difficult for one or more creatures to see due to thick fog or some other obscuring feature. You can be concealed to some creatures but not others. While concealed, you can still be @UUID[Compendium.pf2e.conditionitems.Item.1wQY3JYyhMYeeV2G]{Observed}, but you're tougher to target. A creature that you're concealed from must succeed at a @Check[flat|showDC:all|dc:5] when targeting you with an attack, spell, or other effect. If the check fails, you aren't affected. Area effects aren't subject to this flat check.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:"senses",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"concealed",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.DmAIPqOBomZ7H95W"},effects:[]},{_id:"dTwPJuKgBQCMxixg",img:"systems/pf2e/icons/conditions/petrified.webp",name:"Petrified",system:{description:{value:"<p>You have been turned to stone. You can't act, nor can you sense anything. You become an object with a Bulk double your normal Bulk (typically 12 for a petrified Medium creature or 6 for a petrified Small creature), AC 9, Hardness 8, and the same current Hit Points you had when alive. You don't have a Broken Threshold. When the petrified condition ends, you have the same number of Hit Points you had as a statue. If the statue is destroyed, you immediately die. While petrified, your mind and body are in stasis, so you don't age or notice the passing of time.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"petrified",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.dTwPJuKgBQCMxixg"},effects:[]},{_id:"e1XGnhKNSQIm5IXg",img:"systems/pf2e/icons/conditions/stupefied.webp",name:"Stupefied",system:{active:!1,description:{value:"<p>Your thoughts and instincts are clouded. Stupefied always includes a value. You take a status penalty equal to this value on Intelligence-, Wisdom-, and Charisma-based rolls and DCs, including Will saving throws, spell attack modifiers, spell DCs, and skill checks that use these attribute modifiers. Any time you attempt to @UUID[Compendium.pf2e.actionspf2e.Item.aBQ8ajvEBByv45yz]{Cast a Spell} while stupefied, the spell is disrupted unless you succeed at a @Check[flat|showDC:all|dc:resolve(5+@item.badge.value)] with a DC equal to 5 + your stupefied value.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:"abilities",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[{key:"FlatModifier",selector:["cha-based","int-based","wis-based"],slug:"stupefied",type:"status",value:"-@item.badge.value"},{itemType:"spell",key:"ItemAlteration",mode:"add",property:"description",value:[{text:"PF2E.condition.stupefied.note"}]}],traits:{value:[]},value:{immutable:!1,isValued:!0,value:1},slug:"stupefied",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.e1XGnhKNSQIm5IXg"},effects:[]},{_id:"eIcWbB5o3pP6OIMe",img:"systems/pf2e/icons/conditions/immobilized.webp",name:"Immobilized",system:{active:!1,description:{value:"<p>You are incapable of movement. You can't use any actions that have the move trait. If you're immobilized by something holding you in place and an external force would move you out of your space, the force must succeed at a check against either the DC of the effect holding you in place or the relevant defense (usually Fortitude DC) of the monster holding you in place.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"immobilized",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.eIcWbB5o3pP6OIMe"},effects:[]},{_id:"fBnFDH2MTzgFijKf",img:"systems/pf2e/icons/conditions/unconscious.webp",name:"Unconscious",system:{description:{value:`<p>You're sleeping or have been knocked out. You can't act. You take a \u20134 status penalty to AC, Perception, and Reflex saves, and you have the @UUID[Compendium.pf2e.conditionitems.Item.XgEqL1kFApUbl5Z2]{Blinded} and @UUID[Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg]{Off-Guard} conditions. When you gain this condition, you fall @UUID[Compendium.pf2e.conditionitems.Item.j91X7x0XSomq8d60]{Prone} and drop items you're holding unless the effect states otherwise or the GM determines you're positioned so you wouldn't.</p>
<p>If you're unconscious because you're @UUID[Compendium.pf2e.conditionitems.Item.yZRUzMqrMmfLu0V1]{Dying}, you can't wake up while you have 0 Hit Points. If you are restored to 1 Hit Point or more, you lose the dying and unconscious conditions and can act normally on your next turn.</p>
<p>If you are unconscious and at 0 Hit Points, but not dying, you return to 1 Hit Point and awaken after sufficient time passes. The GM determines how long you remain unconscious, from a minimum of 10 minutes to several hours. If you are healed, you lose the unconscious condition and can act normally on your next turn.</p>
<p>If you're unconscious and have more than 1 Hit Point (typically because you are asleep or unconscious due to an effect), you wake up in one of the following ways.</p>
<ul>
<li>You take damage, though if the damage reduces you to 0 Hit Points, you remain unconscious and gain the dying condition as normal.</li>
<li>You receive healing, other than the natural healing you get from resting.</li>
<li>Someone shakes you awake with an @UUID[Compendium.pf2e.actionspf2e.Item.pvQ5rY2zrtPI614F]{Interact} action.</li>
<li>Loud noise around you might wake you. At the start of your turn, you automatically attempt a Perception check against the noise's DC (or the lowest DC if there is more than one noise), waking up if you succeed. If creatures are attempting to stay quiet around you, this Perception check uses their Stealth DCs. Some effects make you sleep so deeply that they don't allow you this Perception check.</li>
<li>If you are simply asleep, the GM decides you wake up either because you have had a restful night's sleep or something disrupted that rest.</li>
</ul>`},duration:{expiry:null,unit:"unlimited",value:0},group:"death",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"FlatModifier",selector:["ac","perception","reflex"],slug:"unconscious",type:"status",value:-4},{key:"GrantItem",onDeleteActions:{grantee:"restrict"},uuid:"Compendium.pf2e.conditionitems.Item.XgEqL1kFApUbl5Z2"},{inMemoryOnly:!0,key:"GrantItem",uuid:"Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg"},{allowDuplicate:!1,key:"GrantItem",onDeleteActions:{grantee:"restrict",granter:"detach"},uuid:"Compendium.pf2e.conditionitems.Item.j91X7x0XSomq8d60"}],traits:{value:[]},value:{isValued:!1,value:null},slug:"unconscious",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.fBnFDH2MTzgFijKf"},effects:[]},{_id:"fesd1n5eVhpCSS18",img:"systems/pf2e/icons/conditions/sickened.webp",name:"Sickened",system:{description:{value:`<p>You feel ill. Sickened always includes a value. You take a status penalty equal to this value on all your checks and DCs. You can't willingly ingest anything\u2014including elixirs and potions\u2014while sickened.</p>
<p>You can spend a single action retching in an attempt to recover, which lets you immediately attempt a @Check[fortitude] save against the DC of the effect that made you sickened. On a success, you reduce your sickened value by 1 (or by 2 on a critical success).</p>`},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"FlatModifier",selector:"all",slug:"sickened",type:"status",value:"-@item.badge.value"},{itemType:"consumable",key:"ItemAlteration",label:"PF2E.condition.sickened.name",mode:"add",predicate:[{or:["item:tag:alchemical-food","item:trait:elixir","item:trait:ingested","item:trait:potion"]}],property:"description",value:[{text:"PF2E.condition.sickened.note"}]}],traits:{value:[]},value:{isValued:!0,value:1},slug:"sickened",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.fesd1n5eVhpCSS18"},effects:[]},{_id:"fuG8dgthlDWfWjIA",img:"systems/pf2e/icons/conditions/indifferent.webp",name:"Indifferent",system:{description:{value:"<p>This condition reflects a creature's disposition toward a particular character, and only supernatural effects (like a spell) can impose this condition on a PC. A creature that is indifferent to a character doesn't really care one way or the other about that character. Assume a creature's attitude to a given character is indifferent unless specified otherwise.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:"attitudes",overrides:["helpful","friendly","unfriendly","hostile"],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"indifferent",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.fuG8dgthlDWfWjIA"},effects:[]},{_id:"HL2l2VRSaQHu9lUw",img:"systems/pf2e/icons/conditions/fatigued.webp",name:"Fatigued",system:{description:{value:`<p>You're tired and can't summon much energy. You take a \u20131 status penalty to AC and saving throws. You can't use exploration activities performed while traveling.</p>
<p>You recover from fatigue after a full night's rest.</p>`},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"FlatModifier",selector:["ac","saving-throw"],slug:"fatigued",type:"status",value:-1}],traits:{value:[]},value:{isValued:!1,value:null},slug:"fatigued",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.HL2l2VRSaQHu9lUw"},effects:[]},{_id:"I1ffBVISxLr2gC4u",img:"systems/pf2e/icons/conditions/unfriendly.webp",name:"Unfriendly",system:{description:{value:"<p>This condition reflects a creature's disposition toward a particular character, and only supernatural effects (like a spell) can impose this condition on a PC. A creature that is unfriendly to a character dislikes and distrusts that character. The unfriendly creature won't accept @UUID[Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6]{Requests} from the character.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:"attitudes",overrides:["helpful","friendly","indifferent","hostile"],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"unfriendly",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.I1ffBVISxLr2gC4u"},effects:[]},{_id:"i3OJZU2nk64Df3xm",img:"systems/pf2e/icons/conditions/clumsy.webp",name:"Clumsy",system:{active:!1,description:{value:"<p>Your movements become clumsy and inexact. Clumsy always includes a value. You take a status penalty equal to the condition value to Dexterity-based rolls and DCs, including AC, Reflex saves, ranged attack rolls, and skill checks using Acrobatics, Stealth, and Thievery.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:"abilities",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[{key:"FlatModifier",selector:"dex-based",slug:"clumsy",type:"status",value:"-@item.badge.value"}],traits:{value:[]},value:{immutable:!1,isValued:!0,value:1},slug:"clumsy",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.i3OJZU2nk64Df3xm"},effects:[]},{_id:"iU0fEDdBp3rXpTMC",img:"systems/pf2e/icons/conditions/hidden.webp",name:"Hidden",system:{description:{value:`<p>While you're hidden from a creature, that creature knows the space you're in but can't tell precisely where you are. You typically become hidden by using Stealth to @UUID[Compendium.pf2e.actionspf2e.Item.XMcnh4cSI32tljXa]{Hide}. When @UUID[Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ]{Seeking} a creature using only imprecise senses, it remains hidden, rather than @UUID[Compendium.pf2e.conditionitems.Item.1wQY3JYyhMYeeV2G]{Observed}. A creature you're hidden from is @UUID[Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg]{Off-Guard} to you, and it must succeed at a @Check[flat|showDC:all|dc:11] when targeting you with an attack, spell, or other effect or it fails to affect you. Area effects aren't subject to this flat check.</p>
<p>A creature might be able to use the seek action to try to observe you.</p>`},duration:{expiry:null,unit:"unlimited",value:0},group:"detection",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"hidden",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.iU0fEDdBp3rXpTMC"},effects:[]},{_id:"j91X7x0XSomq8d60",img:"systems/pf2e/icons/conditions/prone.webp",name:"Prone",system:{description:{value:`<p>You're lying on the ground. You are @UUID[Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg]{Off-Guard} and take a \u20132 circumstance penalty to attack rolls. The only move actions you can use while you're prone are @UUID[Compendium.pf2e.actionspf2e.Item.Tj055UcNm6UEgtCg]{Crawl} and @UUID[Compendium.pf2e.actionspf2e.Item.OdIUybJ3ddfL7wzj]{Stand}. Standing up ends the prone condition. You can @UUID[Compendium.pf2e.actionspf2e.Item.ust1jJSCZQUhBZIz]{Take Cover} while prone to hunker down and gain greater cover against ranged attacks, even if you don't have an object to get behind, which grants you a +4 circumstance bonus to AC against ranged attacks (but you remain off-guard).</p>
<p>If you would be knocked prone while you're @UUID[Compendium.pf2e.actionspf2e.Item.pprgrYQ1QnIDGZiy]{Climbing} or @UUID[Compendium.pf2e.actionspf2e.Item.cS9nfDRGD83bNU1p]{Flying}, you fall. You can't be knocked prone when @UUID[Compendium.pf2e.actionspf2e.Item.c8TGiZ48ygoSPofx]{Swimming}.</p>`},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"FlatModifier",selector:"attack-roll",slug:"prone",type:"circumstance",value:-2},{inMemoryOnly:!0,key:"GrantItem",uuid:"Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg"}],traits:{value:[]},value:{isValued:!1,value:null},slug:"prone",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.j91X7x0XSomq8d60"},effects:[]},{_id:"kWc1fhmv9LBiTuei",img:"systems/pf2e/icons/conditions/grabbed.webp",name:"Grabbed",system:{description:{value:"<p>You're held in place by another creature, giving you the @UUID[Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg]{Off-Guard} and @UUID[Compendium.pf2e.conditionitems.Item.eIcWbB5o3pP6OIMe]{Immobilized} conditions. If you attempt a manipulate action while grabbed, you must succeed at a @Check[flat|showDC:all|dc:5] or it is lost; roll the check after spending the action, but before any effects are applied.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{inMemoryOnly:!0,key:"GrantItem",uuid:"Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg"},{inMemoryOnly:!0,key:"GrantItem",uuid:"Compendium.pf2e.conditionitems.Item.eIcWbB5o3pP6OIMe"},{itemType:"action",key:"ItemAlteration",mode:"add",predicate:["item:trait:manipulate"],property:"description",value:[{text:"PF2E.condition.grabbed.note"}]},{itemType:"feat",key:"ItemAlteration",mode:"add",predicate:["item:trait:manipulate"],property:"description",value:[{text:"PF2E.condition.grabbed.note"}]},{itemType:"spell",key:"ItemAlteration",mode:"add",predicate:["item:trait:manipulate"],property:"description",value:[{text:"PF2E.condition.grabbed.note"}]}],traits:{value:[]},value:{isValued:!1,value:null},slug:"grabbed",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.kWc1fhmv9LBiTuei"},effects:[]},{_id:"lDVqvLKA6eF3Df60",img:"systems/pf2e/icons/conditions/persistent-damage.webp",name:"Persistent Damage",system:{active:!1,description:{value:'<p>You are taking damage from an ongoing effect, such as from being lit on fire. This appears as "X persistent [type] damage," where "X" is the amount of damage dealt and "[type]" is the damage type. Like normal damage, it can be doubled or halved based on the results of an attack roll or saving throw. Instead of taking persistent damage immediately, you take it at the end of each of your turns as long as you have the condition, rolling any damage dice anew each time. After you take persistent damage, roll a @Check[flat|showDC:all|dc:15] to see if you recover from the persistent damage. If you succeed, the condition ends.</p>'},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"persistent-damage",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.lDVqvLKA6eF3Df60"},effects:[]},{_id:"MIRkyAjyBeXivMa7",img:"systems/pf2e/icons/conditions/enfeebled.webp",name:"Enfeebled",system:{active:!1,description:{value:"<p>You're physically weakened. Enfeebled always includes a value. When you are enfeebled, you take a status penalty equal to the condition value to Strength-based rolls and DCs, including Strength-based melee attack rolls, Strength-based damage rolls, and Athletics checks.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:"abilities",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[{key:"FlatModifier",selector:["str-based","str-damage"],slug:"enfeebled",type:"status",value:"-@item.badge.value"}],traits:{value:[]},value:{immutable:!1,isValued:!0,value:1},slug:"enfeebled",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.MIRkyAjyBeXivMa7"},effects:[]},{_id:"nlCjDvLMf2EkV2dl",img:"systems/pf2e/icons/conditions/quickened.webp",name:"Quickened",system:{active:!1,description:{value:"<p>You're able to act more quickly. You gain 1 additional action at the start of your turn each round. Many effects that make you quickened require you use this extra action only in certain ways. If you become quickened from multiple sources, you can use the extra action you've been granted for any single action allowed by any of the effects that made you quickened. Because quickened has its effect at the start of your turn, you don't immediately gain actions if you become quickened during your turn.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"quickened",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.nlCjDvLMf2EkV2dl"},effects:[]},{_id:"sDPxOjQ9kx2RZE8D",img:"systems/pf2e/icons/conditions/fleeing.webp",name:"Fleeing",system:{active:!1,description:{value:"<p>You're forced to run away due to fear or some other compulsion. On your turn, you must spend each of your actions trying to escape the source of the fleeing condition as expediently as possible (such as by using move actions to flee, or opening doors barring your escape). The source is usually the effect or creature that gave you the condition, though some effects might define something else as the source. You can't @UUID[Compendium.pf2e.actionspf2e.Item.A72nHGUtNXgY5Ey9]{Delay} or @UUID[Compendium.pf2e.actionspf2e.Item.dLgAMt3TbkmLkUqE]{Ready} while fleeing.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"fleeing",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.sDPxOjQ9kx2RZE8D"},effects:[]},{_id:"TBSHQspnbcqxsmjL",img:"systems/pf2e/icons/conditions/frightened.webp",name:"Frightened",system:{active:!1,description:{value:"<p>You're gripped by fear and struggle to control your nerves. The frightened condition always includes a value. You take a status penalty equal to this value to all your checks and DCs. Unless specified otherwise, at the end of each of your turns, the value of your frightened condition decreases by 1.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[{key:"FlatModifier",selector:"all",slug:"frightened",type:"status",value:"-@item.badge.value"}],traits:{value:[]},value:{immutable:!1,isValued:!0,value:1},slug:"frightened",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.TBSHQspnbcqxsmjL"},effects:[]},{_id:"TkIyaNPgTZFBCCuh",img:"systems/pf2e/icons/conditions/dazzled.webp",name:"Dazzled",system:{active:!1,description:{value:"<p>Your eyes are overstimulated or your vision is swimming. If vision is your only precise sense, all creatures and objects are @UUID[Compendium.pf2e.conditionitems.Item.DmAIPqOBomZ7H95W]{Concealed} from you.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:"senses",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"dazzled",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.TkIyaNPgTZFBCCuh"},effects:[]},{_id:"ud7gTLwPeklzYSXG",img:"systems/pf2e/icons/conditions/hostile.webp",name:"Hostile",system:{description:{value:"<p>This condition reflects a creature's disposition toward a particular character, and only supernatural effects (like a spell) can impose on a PC. A creature hostile to a character actively seeks to harm that character. It doesn't necessarily attack, but it won't accept @UUID[Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6]{Requests} from the character.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:"attitudes",overrides:["helpful","friendly","indifferent","unfriendly"],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"hostile",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.ud7gTLwPeklzYSXG"},effects:[]},{_id:"v44P3WUcU1j0115l",img:"systems/pf2e/icons/conditions/helpful.webp",name:"Helpful",system:{description:{value:"<p>This condition reflects a creature's disposition toward a particular character, and only supernatural effects (like a spell) can impose this condition on a PC. A creature that is helpful to a character wishes to actively aid that character. It will accept reasonable @UUID[Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6]{Requests} from that character, as long as such requests aren't at the expense of the helpful creature's goals or quality of life. If the character (or one of their allies) uses a hostile action against the creature, the creature gains a worse attitude condition depending on the severity of the hostile action, as determined by the GM.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:"attitudes",overrides:["friendly","indifferent","unfriendly","hostile"],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"helpful",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.v44P3WUcU1j0115l"},effects:[]},{_id:"v66R7FdOf11l94im",img:"systems/pf2e/icons/conditions/friendly.webp",name:"Friendly",system:{description:{value:"<p>This condition reflects a creature's disposition toward a particular character, and only supernatural effects (like a spell) can impose this condition on a PC. A creature that is friendly to a character likes that character. It is likely to agree to @UUID[Compendium.pf2e.actionspf2e.Item.DCb62iCBrJXy0Ik6]{Requests} from that character as long as they are simple, safe, and don't cost too much to fulfill. If the character (or one of their allies) uses hostile actions against the creature, the creature gains a worse attitude condition depending on the severity of the hostile action, as determined by the GM.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:"attitudes",overrides:["helpful","indifferent","unfriendly","hostile"],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"friendly",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.v66R7FdOf11l94im"},effects:[]},{_id:"VcDeM8A5oI6VqhbM",img:"systems/pf2e/icons/conditions/restrained.webp",name:"Restrained",system:{description:{value:"<p>You're tied up and can barely move, or a creature has you pinned. You have the @UUID[Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg]{Off-Guard} and @UUID[Compendium.pf2e.conditionitems.Item.eIcWbB5o3pP6OIMe]{Immobilized} conditions, and you can't use any attack or manipulate actions except to attempt to @UUID[Compendium.pf2e.actionspf2e.Item.SkZAQRkLLkmBQNB9]{Escape} or @UUID[Compendium.pf2e.actionspf2e.Item.SjmKHgI7a5Z9JzBx]{Force Open} your bonds. Restrained overrides @UUID[Compendium.pf2e.conditionitems.Item.kWc1fhmv9LBiTuei]{Grabbed}.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:["grabbed"],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"ActiveEffectLike",mode:"override",path:"system.attributes.flanking.canFlank",value:!1},{inMemoryOnly:!0,key:"GrantItem",uuid:"Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg"},{inMemoryOnly:!0,key:"GrantItem",uuid:"Compendium.pf2e.conditionitems.Item.eIcWbB5o3pP6OIMe"},{itemType:"action",key:"ItemAlteration",mode:"add",predicate:["item:trait:manipulate"],property:"description",value:[{text:"PF2E.condition.restrained.note"}]},{itemType:"feat",key:"ItemAlteration",mode:"add",predicate:["item:trait:manipulate"],property:"description",value:[{text:"PF2E.condition.restrained.note"}]},{itemType:"spell",key:"ItemAlteration",mode:"add",predicate:["item:trait:manipulate"],property:"description",value:[{text:"PF2E.condition.restrained.note"}]},{key:"Note",predicate:[{nor:["action:escape","action:force-open"]}],selector:["attack","skill-check"],text:"PF2E.condition.restrained.note",title:"{item|name}"}],traits:{value:[]},value:{isValued:!1,value:null},slug:"restrained",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.VcDeM8A5oI6VqhbM"},effects:[]},{_id:"VRSef5y1LmL2Hkjf",img:"systems/pf2e/icons/conditions/undetected.webp",name:"Undetected",system:{description:{value:`<p>When you are undetected by a creature, that creature can't see you at all, has no idea what space you occupy, and can't target you, though you still can be affected by abilities that target an area. When you're undetected by a creature, that creature is @UUID[Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg]{Off-Guard} to you.</p>
<p>A creature you're undetected by can guess which square you're in to try targeting you. It must pick a square and attempt an attack. This works like targeting a @UUID[Compendium.pf2e.conditionitems.Item.iU0fEDdBp3rXpTMC]{Hidden} creature (requiring a @Check[flat|showDC:all|dc:11|traits:secret]), but the flat check and attack roll are rolled in secret by the GM, who doesn't reveal whether the attack missed due to failing the flat check, failing the attack roll, or choosing the wrong square. They can @UUID[Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ]{Seek} to try to find you.</p>`},duration:{expiry:null,unit:"unlimited",value:0},group:"detection",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"undetected",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.VRSef5y1LmL2Hkjf"},effects:[]},{_id:"XgEqL1kFApUbl5Z2",img:"systems/pf2e/icons/conditions/blinded.webp",name:"Blinded",system:{description:{value:"<p>You can't see. All normal terrain is difficult terrain to you. You can't detect anything using vision. You automatically critically fail Perception checks that require you to be able to see, and if vision is your only precise sense, you take a \u20134 status penalty to Perception checks. You are immune to visual effects. Blinded overrides @UUID[Compendium.pf2e.conditionitems.Item.TkIyaNPgTZFBCCuh]{Dazzled}.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:"senses",overrides:["dazzled"],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"FlatModifier",selector:"perception",slug:"blinded",type:"status",value:-4},{key:"Immunity",type:"visual"}],traits:{value:[]},value:{isValued:!1,value:null},slug:"blinded",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.XgEqL1kFApUbl5Z2"},effects:[]},{_id:"xYTAsEpcJE1Ccni3",img:"systems/pf2e/icons/conditions/slowed.webp",name:"Slowed",system:{description:{value:"<p>You have fewer actions. Slowed always includes a value. When you regain your actions, reduce the number of actions regained by your slowed value. Because you regain actions at the start of your turn, you don't immediately lose actions if you become slowed during your turn.</p>"},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[],traits:{value:[]},value:{isValued:!0,value:1},slug:"slowed",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.xYTAsEpcJE1Ccni3"},effects:[]},{_id:"yblD8fOR1J8rDwEQ",img:"systems/pf2e/icons/conditions/confused.webp",name:"Confused",system:{description:{value:`<p>You don't have your wits about you, and you attack wildly. You are @UUID[Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg]{Off-Guard}, you don't treat anyone as your ally (though they might still treat you as theirs), and you can't Delay, Ready, or use reactions.</p>
<p>You use all your actions to Strike or cast offensive cantrips, though the GM can have you use other actions to facilitate attack, such as draw a weapon, move so target is in reach, and so forth. Your targets are determined randomly by the GM. If you have no other viable targets, you target yourself, automatically hitting but not scoring a critical hit. If it's impossible for you to attack or cast spells, you babble incoherently, wasting your actions.</p>
<p>Each time you take damage from an attack or spell, you can attempt a @Check[flat|showDC:all|dc:11] to recover from your confusion and end the condition.</p>`},duration:{expiry:null,unit:"unlimited",value:0},group:null,overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"ActiveEffectLike",mode:"override",path:"system.attributes.flanking.canFlank",value:!1},{key:"RollOption",option:"target:ally",value:!1},{key:"RollOption",option:"origin:ally",value:!1},{inMemoryOnly:!0,key:"GrantItem",uuid:"Compendium.pf2e.conditionitems.Item.AJh5ex99aV6VTggg"},{key:"Note",predicate:[{or:["item:type:spell","origin:action:trait:attack"]}],selector:"damage-received",text:"PF2E.condition.confused.note",title:"{item|name}"}],traits:{value:[]},value:{isValued:!1,value:null},slug:"confused",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.yblD8fOR1J8rDwEQ"},effects:[]},{_id:"Yl48xTdMh3aeQYL2",img:"systems/pf2e/icons/conditions/wounded.webp",name:"Wounded",system:{active:!1,description:{value:`<p>You have been seriously injured. If you lose the @UUID[Compendium.pf2e.conditionitems.Item.yZRUzMqrMmfLu0V1]{Dying} condition and do not already have the wounded condition, you become wounded 1. If you already have the wounded condition when you lose the dying condition, your wounded condition value increases by 1. If you gain the dying condition while wounded, increase your dying condition value by your wounded value.</p>
<p>The wounded condition ends if someone successfully restores Hit Points to you using @UUID[Compendium.pf2e.actionspf2e.Item.1kGNdIIhuglAjIp9]{Treat Wounds}, or if you are restored to full Hit Points by any means and rest for 10 minutes.</p>`},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:"death",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[],traits:{value:[]},value:{immutable:!1,isValued:!0,value:1},slug:"wounded",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.Yl48xTdMh3aeQYL2"},effects:[]},{_id:"yZRUzMqrMmfLu0V1",img:"systems/pf2e/icons/conditions/dying.webp",name:"Dying",system:{description:{value:`<p>You are bleeding out or otherwise at death's door. While you have this condition, you are @UUID[Compendium.pf2e.conditionitems.Item.fBnFDH2MTzgFijKf]{Unconscious}. Dying always includes a value, and if it ever reaches dying 4, you die. When you're dying, you must attempt a recovery check at the start of your turn each round to determine whether you get better or worse. Your dying condition increases by 1 if you take damage while dying, or by 2 if you take damage from an enemy's critical hit or a critical failure on your save.</p>
<p>If you lose the dying condition by succeeding at a recovery check and are still at 0 Hit Points, you remain unconscious, but you can wake up as described in that condition. You lose the dying condition automatically and wake up if you ever have 1 Hit Point or more. Any time you lose the dying condition, you gain the @UUID[Compendium.pf2e.conditionitems.Item.Yl48xTdMh3aeQYL2]{Wounded 1} condition, or increase your wounded condition value by 1 if you already have that condition.</p>`},duration:{expiry:null,unit:"unlimited",value:0},group:"death",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},rules:[{key:"GrantItem",onDeleteActions:{grantee:"restrict"},uuid:"Compendium.pf2e.conditionitems.Item.fBnFDH2MTzgFijKf"}],traits:{value:[]},value:{isValued:!0,value:1},slug:"dying",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.yZRUzMqrMmfLu0V1"},effects:[]},{_id:"zJxUflt9np0q4yML",img:"systems/pf2e/icons/conditions/invisible.webp",name:"Invisible",system:{active:!1,description:{value:"<p>You can't be seen. You're @UUID[Compendium.pf2e.conditionitems.Item.VRSef5y1LmL2Hkjf]{Undetected} to everyone. Creatures can @UUID[Compendium.pf2e.actionspf2e.Item.BlAOM2X92SI6HMtJ]{Seek} to detect you; if a creature succeeds at its Perception check against your Stealth DC, you become @UUID[Compendium.pf2e.conditionitems.Item.iU0fEDdBp3rXpTMC]{Hidden} to that creature until you @UUID[Compendium.pf2e.actionspf2e.Item.VMozDqMMuK5kpoX4]{Sneak} to become undetected again. If you become invisible while someone can already see you, you start out hidden to them (instead of undetected) until you successfully Sneak. You can't become @UUID[Compendium.pf2e.conditionitems.Item.1wQY3JYyhMYeeV2G]{Observed} while invisible except via special abilities or magic.</p>"},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:"senses",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[],traits:{value:[]},value:{isValued:!1,value:null},slug:"invisible",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.zJxUflt9np0q4yML"},effects:[]},{_id:"zXZjC8HLaRoLR17U",img:"systems/pf2e/icons/conditions/cursebound.webp",name:"Cursebound",system:{active:!1,description:{value:"<p>Your oracular curse is constricting around you as you receive divine punishment after drawing too deeply on your mystery's powers. Cursebound is a condition that affects only creatures with an oracular curse, and cursebound always includes a value. Your specific oracular curse imposes unique negative effects depending on your cursebound value. You can remove the cursebound condition only by Refocusing.</p>"},duration:{expiry:null,perpetual:!0,text:"",unit:"unlimited",value:-1},group:"abilities",overrides:[],publication:{license:"ORC",remaster:!0,title:"Pathfinder Player Core 2"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[],traits:{value:[]},value:{immutable:!1,isValued:!0,value:1},slug:"cursebound",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.conditionitems.Item.zXZjC8HLaRoLR17U"},effects:[]},{_id:"axtAzam8kiKbTD2c",folder:"KDzP1XoF2noQvPNI",img:"systems/pf2e/icons/conditions/malevolence.webp",name:"Malevolence",system:{active:!1,description:{value:`<p>As the malevolence begins to take its hold on creatures, their body, minds, and souls become increasingly haunted by the supernatural force infesting Xarwin Manor. Malevolence is a special condition that can affect PCs who play in this adventure. The malevolence condition always includes a value. You take a status penalty equal to this value to all saving throws against effects generated by haunts and against all curse and possession effects. The malevolence condition can be reduced by restoration.</p>
<p>The malevolence can never increase above a value of 4. If an effect would increase a creature's malevolence value higher than 4, the creature is instead @UUID[Compendium.pf2e.conditionitems.Item.e1XGnhKNSQIm5IXg]{Stupefied 1} for 24 hours as the malevolence consumes a few of their random, short-term memories. A creature that has a malevolence 4 won't voluntarily leave the Xarwin Manor grounds.</p>
<p>Each time you get a full night's rest in a region not influenced by the malevolence condition, the value of your malevolence decreases by 1.</p>`},duration:{expiry:null,perpetual:!1,text:"",unit:"unlimited",value:-1},group:null,overrides:[],publication:{license:"OGL",remaster:!1,title:"Pathfinder Adventure: Malevolence"},references:{children:[],immunityFrom:[],overriddenBy:[],overrides:[]},removable:!1,rules:[{key:"FlatModifier",predicate:[{or:["origin:trait:haunt","item:trait:curse","item:trait:possession"]}],selector:"saving-throw",slug:"malevolence",type:"status",value:"-@item.badge.value"}],traits:{value:[]},value:{immutable:!1,isValued:!0,value:1},slug:"malevolence",_migration:{version:.953,previous:null}},type:"condition",_stats:{coreVersion:"13.348",systemId:"pf2e",systemVersion:"7.8.0",compendiumSource:"Compendium.pf2e.campaign-effects.Item.axtAzam8kiKbTD2c"},effects:[]}];class ConditionManager{static{__name(this,"ConditionManager")}static{__name2(this,"ConditionManager")}static#initialized=!1;static conditions=new Map;static get conditionsSlugs(){return[...this.conditions.keys()].filter(k=>!k.startsWith("Compendium."))}static initialize(){if(!this.#initialized){if(this.conditions=new Map(define_CONDITION_SOURCES_default.flatMap(source2=>{const condition=new ConditionPF2e(source2,{pack:"pf2e.conditionitems"});return[[condition.slug,condition],[condition.uuid,condition]]})??[]),game.i18n.lang!=="en"){const localize=localizer("PF2E.condition");for(const condition of this.conditions.values())condition.name=condition._source.name=localize(`${condition.slug}.name`),condition.system.description.value=condition._source.system.description.value=localize(`${condition.slug}.rules`)}this.#initialized=!0}}static getCondition(slug,modifications={}){if(slug=sluggify(slug),!setHasElement(CONDITION_SLUGS,slug))return null;const condition=ConditionManager.conditions.get(slug)?.clone(modifications);if(!condition)throw ErrorPF2e("Unexpected failure looking up condition");return condition}static async updateConditionValue(itemId,actorOrToken,value){const actor="prototypeToken"in actorOrToken?actorOrToken:actorOrToken.actor,condition=actor?.items.get(itemId);condition?.isOfType("condition")&&(value===0?await condition.delete():actor?.isOfType("creature")&&(tupleHasValue(["dying","wounded","doomed"],condition.slug)&&(value=Math.min(value,actor.attributes[condition.slug].max)),await condition.update({"system.value.value":value})))}}const EXPIRING_CONDITIONS=new Set(["frightened","sickened","drained","doomed","stunned","unconscious"]);class AfflictionPF2e extends AbstractEffectPF2e{static{__name(this,"AfflictionPF2e")}static{__name2(this,"AfflictionPF2e")}constructor(source2,context){throw super(source2,context),ErrorPF2e("Affliction items are not available in production builds")}get badge(){return{type:"counter",value:this.stage,min:1,max:this.maxStage,labels:null,label:this.system.status.onset?game.i18n.localize("PF2E.Item.Affliction.OnsetLabel"):game.i18n.format("PF2E.Item.Affliction.Stage",{stage:this.stage})}}get stage(){return this.system.status.stage}get maxStage(){return this.system.stages.length||1}async increase(){if(this.system.status.onset)await this.update({system:{"-=onset":null}});else if(this.stage!==this.maxStage){const stage=Math.min(this.maxStage,this.stage+1);await this.update({system:{stage}})}}async decrease(){const stage=this.stage-1;if(stage===0){await this.delete();return}await this.update({system:{stage}})}get onsetDuration(){const onset=this.system.onset;return onset?onset.value*(DURATION_UNITS[onset.unit]??0):0}get remainingStageDuration(){const stageDuration={...this.system.stages.at(this.stage-1)?.duration??{unit:"unlimited",value:-1},expiry:"turn-end"};return calculateRemainingDuration(this,stageDuration)}getStageDamage(stage){const stageData=Object.values(this.system.stages).at(stage-1),base=[];for(const data of Object.values(stageData?.damage??{})){const{formula,damageType,category}=data,terms2=parseTermsFromSimpleFormula(formula);base.push({terms:terms2,damageType,category:category??null})}if(!base.length)return null;try{const{formula,breakdown}=createDamageFormula({base,modifiers:[],dice:[]}),roll=new DamageRoll(formula),stageLabel=game.i18n.format("PF2E.Item.Affliction.Stage",{stage:this.stage}),template={name:`${this.name} - ${stageLabel}`,damage:{roll,breakdown},materials:[],modifiers:[]},context={type:"damage-roll",sourceType:"save",outcome:"failure",domains:[],options:new Set,self:null,traits:this.system.traits.value};return{template,context}}catch(err){console.error(err)}return null}async handleStageChange(){const actor=this.actor;if(!actor)return;const itemsToDelete=this.getLinkedItems().map(i=>i.id);await actor.deleteEmbeddedDocuments("Item",itemsToDelete);const currentStage=Object.values(this.system.stages).at(this.stage-1);if(!currentStage)return;const conditionsToAdd=[],conditionsToUpdate={};for(const data of currentStage.conditions){const value=data.value??1,existing=(()=>{const allExisting=actor.conditions.bySlug(data.slug,{temporary:!1}),byAffliction=allExisting.find(i=>i.appliedBy===this);return byAffliction||(data.linked?null:n$4(allExisting.filter(i=>!i.appliedBy&&!i.isLocked),[c=>c.active?1/0:c.value??0,"desc"]))})();if(existing){existing.system.value.isValued&&(conditionsToUpdate[existing.id]={value,linked:!!data.linked});continue}const condition=ConditionManager.getCondition(data.slug);condition.updateSource({"flags.pf2e.grantedBy.id":this.id}),data.linked&&condition.updateSource({"system.references.parent.id":this.id}),condition.system.value.isValued&&value>1&&condition.updateSource({"system.value.value":data.value}),conditionsToAdd.push(condition)}const additions=conditionsToAdd.map(c=>c.toObject());await actor.createEmbeddedDocuments("Item",additions),await actor.updateEmbeddedDocuments("Item",Object.entries(conditionsToUpdate).map(([_id2,data])=>({_id:_id2,"system.value.value":data.value,"flags.pf2e.grantedBy.id":this.id,...data.linked?{"system.references.parent.id":this.id}:{}}))),this.system.onset||await this.createStageMessage()}getLinkedItems(){return this.actor?this.actor.items.filter(i=>i.isOfType("condition")&&!EXPIRING_CONDITIONS.has(i.slug)&&i.flags.pf2e.grantedBy?.id===this.id&&i.system.references.parent?.id===this.id):[]}async createStageMessage(){if(!this.actor)return;const damage=this.getStageDamage(this.stage);if(damage){const{template,context}=damage;await DamagePF2e.roll(template,context)}}async _preCreate(data,options,user){const system2=data.system??={};if(this.isOwned){const initiative=this.origin?.combatant?.initiative??game.combat?.combatant?.initiative??null;system2.start={value:game.time.worldTime+this.onsetDuration,initiative}}else delete system2.status;return super._preCreate(data,options,user)}async _preUpdate(changed,options,user){const duration=changed.system?.duration;return typeof duration?.unit=="string"&&!["unlimited","encounter"].includes(duration.unit)&&duration.value===-1&&(duration.value=1),super._preUpdate(changed,options,user)}_onCreate(data,options,userId){super._onCreate(data,options,userId),game.user===this.actor?.primaryUpdater&&this.handleStageChange()}_onUpdate(changed,options,userId){super._onUpdate(changed,options,userId),changed.system?.status?.stage&&game.user===this.actor?.primaryUpdater&&this.handleStageChange()}async rollRecovery(){if(!this.actor)return;const save=this.actor.saves?.[this.system.save.type];save&&(((await save.roll({dc:{value:this.system.save.value},extraRollOptions:this.getRollOptions("item")}))?.degreeOfSuccess??0)>=DegreeOfSuccess.SUCCESS?this.decrease():this.increase())}prepareActorData(){super.prepareActorData();const actor=this.actor;if(!actor)throw ErrorPF2e("prepareActorData called from unembedded item");this.system.status.onset&&(actor.rollOptions.all[`self:${this.type}:${this.rollOptionSlug}:onset`]=!0)}}class ConditionPF2e extends AbstractEffectPF2e{static{__name(this,"ConditionPF2e")}static{__name2(this,"ConditionPF2e")}get badge(){return this.system.persistent?{type:"formula",value:this.system.persistent.formula,label:null,reevaluate:null}:typeof this.system.value.value=="number"?{type:"counter",min:0,max:1/0,label:null,value:this.system.value.value}:null}get origin(){const grantingItem=this.actor?.items.get(this.flags.pf2e.grantedBy?.id??"");return grantingItem?.isOfType("affliction","effect")?grantingItem.origin:super.origin}get key(){return this.system.persistent?`persistent-damage-${this.system.persistent.damageType}`:this.slug}get appliedBy(){const appliedById=this.system.references.parent?.id??this.flags.pf2e.grantedBy?.id??"";return this.actor?.items.get(appliedById)??this.actor?.conditions.get(appliedById)??null}get value(){return this.system.value.value}get isLocked(){const parentId=this.system.references.parent?.id??"";if(this.actor?.items.has(parentId)||this.actor?.conditions.has(parentId)||super.isLocked)return!0;const granterId=this.flags.pf2e.grantedBy?.id??"",granter=this.actor?.items.get(granterId)??this.actor?.conditions.get(granterId);return Object.values(granter?.flags.pf2e.itemGrants??{}).find(g=>g.id===this.id)?.onDelete==="restrict"}get isInHUD(){return this.slug in CONFIG.PF2E.statusEffects.conditions}get breakdown(){const actor=this.actor;if(!this.active||!actor)return null;const list=(this.appliedBy?n(actor.conditions.bySlug(this.slug).map(condition=>{const appliedBy=condition.appliedBy;return!appliedBy?.isOfType("condition")||appliedBy?.active?appliedBy:null}).filter(e$6)):[]).map(p=>reduceItemName(p.name)).sort((a,b)=>a.localeCompare(b,game.i18n.lang)).join(", ");return list?game.i18n.format("PF2E.EffectPanel.AppliedBy",{"condition-list":list}):null}get readonly(){return this.actor&&this.id?!this.actor.items.has(this.id):!1}getRollOptions(prefix=this.type,options){const rollOptions=super.getRollOptions(prefix,options);if(this.system.persistent){const{damageType}=this.system.persistent;rollOptions.push(`damage:type:${damageType}`,`${prefix}:damage:type:${damageType}`);const category=DamageCategorization.fromDamageType(damageType);category&&rollOptions.push(`damage:category:${category}`,`${prefix}:damage:category:${category}`)}return rollOptions}async increase(){await this.actor?.increaseCondition(this)}async decrease(){await this.actor?.decreaseCondition(this)}async onEndTurn(options={}){const actor=this.actor,token=options?.token??actor?.token;if(!(!this.active||!actor)&&this.system.persistent){const roll=this.system.persistent.damage.clone(),flavor=await(async()=>{const traits=this.system.traits.value;return traits.length===0?createHTMLElement("strong",{children:[this.name]}).outerHTML:foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{title:this.name},traits:traits.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.effectTraits))})})();await roll.toMessage({flags:{pf2e:{origin:{uuid:this.uuid}}},flavor,speaker:ChatMessagePF2e.getSpeaker({actor,token})},{rollMode:"roll"})}}async rollRecovery(){if(this.actor&&this.system.persistent){const{dc,damageType}=this.system.persistent;((await new Statistic(this.actor,{slug:"pd-recovery",label:game.i18n.format("PF2E.Item.Condition.PersistentDamage.Chat.RecoverLabel",{name:this.name}),check:{type:"flat-check"},domains:[]}).roll({dc:{value:dc},extraRollOptions:this.getRollOptions("item"),skipDialog:!0}))?.degreeOfSuccess??0)>=DegreeOfSuccess.SUCCESS&&this.actor.decreaseCondition(`persistent-damage-${damageType}`)}}prepareBaseData(){super.prepareBaseData(),this.active=!0;const systemData=this.system;systemData.value.value=systemData.value.isValued?Number(systemData.value.value)||1:null,this.isEmbedded&&typeof this.badge?.value=="number"&&(this.name=`${this.name} ${this.badge.value}`);const folder=CONFIG.PF2E.statusEffects.iconDir;if(this.img=`${folder}${this.slug}.webp`,systemData.persistent){const{formula,damageType}=systemData.persistent,fullFormula=`(${formula})[persistent,${damageType}]`,critRule=game.settings.get("pf2e","critRule")==="doubledamage"?"double-damage":"double-dice",degreeOfSuccess=systemData.persistent.criticalHit?3:null,roll=new DamageRoll(fullFormula,{},{evaluatePersistent:!0,critRule,degreeOfSuccess}),dc=game.user.isGM&&systemData.persistent.dc!==15?systemData.persistent.dc:null,localizationKey=`PF2E.Item.Condition.PersistentDamage.${dc!==null?"NameWithDC":"Name"}`,headTerm=roll.instances.at(0)?.head,shortFormula=headTerm instanceof Grouping?headTerm.term.expression:headTerm?.expression;this.name=shortFormula?game.i18n.format(localizationKey,{formula:shortFormula,damageType:game.i18n.localize(CONFIG.PF2E.damageRollFlavors[damageType]??damageType),dc}):this.name,systemData.persistent.damage=roll,systemData.persistent.expectedValue=roll.expectedValue,this.img=PERSISTENT_DAMAGE_IMAGES[damageType]??this.img}}prepareSiblingData(){if(!this.actor)throw ErrorPF2e("prepareSiblingData may only be called from an embedded item");if(!this.active)return;const deactivate=__name2(condition=>{condition.active=!1,condition.system.references.overriddenBy.push({id:this.id,type:"condition"});for(const rule of condition.rules)rule.ignored=!0},"deactivate"),conditions=this.actor.conditions.active,ofSameType=conditions.filter(c=>c!==this&&c.key===this.key);for(const other of ofSameType){const otherIsGTE=other.value===this.value||other.value&&this.value&&other.value>=this.value;if(other.slug==="persistent-damage"){const thisValue=this.system.persistent?.expectedValue??0,otherValue=other.system.persistent?.expectedValue??0;thisValue>=otherValue&&deactivate(other)}else{if(otherIsGTE&&this.inMemoryOnly)return deactivate(this);this.value===other.value&&(!this.isLocked||other.isLocked)?deactivate(other):otherIsGTE||deactivate(other)}}if(this.system.overrides.length>0){const overridden=conditions.filter(c=>c.active&&this.system.overrides.includes(c.key));for(const condition of overridden)deactivate(condition)}}prepareActorData(){if(super.prepareActorData(),!!this.actor&&this.active&&this.system.persistent){const{damageType}=this.system.persistent;this.actor.rollOptions.all[`self:condition:persistent-damage:${damageType}`]=!0}}prepareRuleElements(options){return this.active?super.prepareRuleElements(options):[]}async _preUpdate(changed,operation,user){return operation.conditionValue=this.value,super._preUpdate(changed,operation,user)}_onUpdate(changed,operation,userId){if(super._onUpdate(changed,operation,userId),!game.user.isGM&&!this.actor?.hasPlayerOwner&&game.settings.get("pf2e","metagame_secretCondition"))return;const[priorValue,newValue]=[operation.conditionValue,this.value];if(!!priorValue&&!!newValue&&priorValue!==newValue&&!this.system.references.parent?.id){const change=newValue>priorValue?{create:this}:{delete:this};this.actor?.getActiveTokens().shift()?.showFloatyText(change)}game.pf2e.StatusEffects.refresh()}}class EffectPF2e extends AbstractEffectPF2e{static{__name(this,"EffectPF2e")}static{__name2(this,"EffectPF2e")}get badge(){return this.system.badge}get level(){return this.system.level.value}get isExpired(){return this.system.expired}get isAura(){return this.rules.some(r2=>r2.key==="Aura"&&!r2.ignored)}get isIdentified(){return!this.system.unidentified}get fromAura(){return!!this.flags.pf2e.aura}prepareBaseData(){super.prepareBaseData(),this.system.expired=this.remainingDuration.expired}prepareRuleElements(options){if(this.isExpired&&this.actor?.items.has(this.id))for(const rule of this.system.rules)rule.ignored=!0;return super.prepareRuleElements(options)}async increase(){const badge=this.system.badge;if(badge?.type==="counter"&&!this.isExpired){const value=badge.loop&&badge.value>=badge.max?badge.min:badge.value+1;await this.update({system:{badge:{value}}})}}async decrease(){if(this.system.badge?.type!=="counter"||this.isExpired){await this.delete();return}const value=this.system.badge.value-1;await this.update({system:{badge:{value}}})}getRollOptions(prefix=this.type,options){const slug=this.slug??sluggify(this.name),trimmedSlug=slug.replace(/^(?:spell-)?(?:effect|stance)-/,""),rollOptions=super.getRollOptions(prefix,options);return rollOptions.findSplice(o=>o===`${prefix}:${slug}`,`${prefix}:${trimmedSlug}`),rollOptions}async#evaluateFormulaBadge(badge,initialValue){const actor=this.actor;if(!actor)throw ErrorPF2e("A formula badge can only be evaluated if part of an embedded effect");const roll=await new Roll(badge.value,this.getRollData()).evaluate(),initial=initialValue??roll.total,reevaluate=badge.reevaluate?{event:badge.reevaluate,formula:badge.value,initial}:null,token=actor.getActiveTokens(!1,!0).shift(),label=badge.labels?badge.labels?.at(roll.total-1)?.trim():null;return roll.toMessage({flavor:[reduceItemName(this.name),label?`(${label})`:null].filter(e$1).join(" "),speaker:ChatMessagePF2e.getSpeaker({actor,token})}),{type:"value",value:roll.total,labels:badge.labels,reevaluate}}async _preCreate(data,options,user){if(this.isOwned){const initiative=this.origin?.combatant?.initiative??game.combat?.combatant?.initiative??null;this._source.system.start={value:game.time.worldTime,initiative}}const badge=data.system?.badge;return this.actor&&badge?.type==="formula"&&badge.evaluate&&badge.value!==void 0&&(this._source.system.badge=await this.#evaluateFormulaBadge(badge)),super._preCreate(data,options,user)}async _preUpdate(changed,options,user){const duration=changed.system?.duration;if(duration?.unit==="unlimited"?(duration.expiry=null,duration.value=-1):typeof duration?.unit=="string"&&!["unlimited","encounter"].includes(duration.unit)&&(duration.expiry||="turn-start",duration.value===-1&&(duration.value=1)),changed.system?.badge){const badgeSource=this._source.system.badge,badgeChange=foundry.utils.mergeObject(changed.system.badge,badgeSource??{},{overwrite:!1});if(badgeChange.type==="counter"){badgeChange.labels??=null;const[minValue,maxValue]=badgeChange.labels?[1,Math.min(badgeChange.labels.length,badgeChange.max??1/0)]:[badgeChange.min??1,badgeChange.max??1/0];if(typeof badgeChange.value=="number"&&badgeChange.value<minValue&&this.actor)return await this.actor.deleteEmbeddedDocuments("Item",[this.id]),!1;badgeChange.value=Math.clamp(badgeChange.value??0,minValue,maxValue)}badgeChange.type==="counter"&&(badgeChange.labels?(badgeChange.min=null,badgeChange.max=null):badgeChange.loop=!1)}return super._preUpdate(changed,options,user)}_onDelete(options,userId){this.actor&&game.pf2e.effectTracker.unregister(this),super._onDelete(options,userId)}async onEncounterEvent(event2){const badge=this.badge;if(badge?.type==="value"&&badge.reevaluate?.event===event2){const newBadge=await this.#evaluateFormulaBadge({type:"formula",value:badge.reevaluate.formula,reevaluate:badge.reevaluate.event,labels:badge.labels},badge.reevaluate.initial??badge.value);await this.update({"system.badge":newBadge})}}}const fields$s=foundry.data.fields;class RarityField extends fields$s.StringField{static{__name(this,"RarityField")}static{__name2(this,"RarityField")}constructor(){super({required:!0,nullable:!1,choices:RARITIES,initial:"common"})}}class ProficiencyRankField extends fields$s.NumberField{static{__name(this,"ProficiencyRankField")}static{__name2(this,"ProficiencyRankField")}constructor(){super({min:0,max:4,integer:!0,required:!0,nullable:!1,initial:0})}}class PublicationField extends fields$s.SchemaField{static{__name(this,"PublicationField")}static{__name2(this,"PublicationField")}constructor(){super({title:new fields$s.StringField({required:!0,nullable:!1,initial:""}),authors:new fields$s.StringField({required:!0,nullable:!1,initial:""}),license:new fields$s.StringField({required:!0,nullable:!1,choices:["OGL","ORC"],initial:"OGL"}),remaster:new fields$s.BooleanField({required:!0,nullable:!1,initial:!1})})}}const SKILL_ABBREVIATIONS=["acr","arc","ath","cra","dec","dip","itm","med","nat","occ","prf","rel","soc","ste","sur","thi"];function getCompatSkills(){return[...SKILL_ABBREVIATIONS,...Object.keys(CONFIG.PF2E.skills)]}__name(getCompatSkills,"getCompatSkills"),__name2(getCompatSkills,"getCompatSkills");const fields$r=foundry.data.fields;class ItemSystemModel extends foundry.abstract.TypeDataModel{static{__name(this,"ItemSystemModel")}static{__name2(this,"ItemSystemModel")}static LOCALIZATION_PREFIXES=["PF2E.Item"];static defineSchema(){const anyStringField=__name2(()=>new fields$r.StringField({required:!0,nullable:!1,initial:""}),"anyStringField");return{description:new fields$r.SchemaField({value:anyStringField(),gm:anyStringField()}),publication:new PublicationField,rules:new fields$r.ArrayField(new fields$r.ObjectField({required:!0,nullable:!1})),slug:new SlugField({required:!0,nullable:!0,initial:null}),traits:new fields$r.SchemaField({otherTags:new fields$r.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0}))}),_migration:new fields$r.SchemaField({version:new fields$r.NumberField({required:!0,nullable:!0,positive:!0,initial:null}),previous:new fields$r.SchemaField({foundry:new fields$r.StringField({required:!0,nullable:!0,initial:null}),system:new fields$r.StringField({required:!0,nullable:!0,initial:null}),schema:new fields$r.NumberField({required:!0,nullable:!0,positive:!0,initial:null})},{required:!0,nullable:!0,initial:null})})}}get actor(){return this.parent.actor}}const CodeMirror={EditorView,basicSetup,json,jsonLinter:__name2(()=>linter(jsonParseLinter()),"jsonLinter"),keybindings:keymap.of([indentWithTab]),ruleElementExtensions:__name2(options=>[json(),CodeMirror.jsonLinter(),autocompletion({override:[ruleElementAutocomplete(options)]})],"ruleElementExtensions")};function ruleElementAutocomplete(options){const validKeysByPath=options.schema?{"":Object.keys(options.schema)}:{"":["key"]};return context=>{const node=syntaxTree(context.state).resolveInner(context.pos,-1),isProperty=node.name==="Object"||node.type.name==="PropertyName",isValue=!isProperty&&(node.name==="Property"||node.parent?.name==="Property");if(isProperty){const basePath=resolveNodePath(context,node),keys=basePath!==null?validKeysByPath[basePath]:[];return keys?.length?{from:node.from,to:node.to,options:keys.map(o=>({label:`"${o}"`}))}:null}else if(isValue&&resolveNodePath(context,node)==="key"){const options2=Object.keys(RuleElements.all);return{from:node.from,to:node.to,options:options2.map(o=>({label:`"${o}"`}))}}return null}}__name(ruleElementAutocomplete,"ruleElementAutocomplete"),__name2(ruleElementAutocomplete,"ruleElementAutocomplete");function resolveNodePath(context,node){node=node.type.name==="PropertyName"&&node.parent?node.parent:node;const parent=node.parent;if(!parent||parent.type.name==="JsonText")return"";const parentType=parent.type.name;if(parentType==="\u26A0")return null;const name2=parentType==="Object"?!parent.parent||parent.parent.type.name==="JsonText"?"":".":parentType==="Property"?context.state.sliceDoc(parent.from,parent.to).match(/^"([^"]*)"/)?.[1]:parentType==="Array"?"[]":null;if(name2===null)return null;const basePath=resolveNodePath(context,parent);return basePath===null?null:basePath+name2}__name(resolveNodePath,"resolveNodePath"),__name2(resolveNodePath,"resolveNodePath");const fields$q=foundry.data.fields;class RuleElementForm{static{__name(this,"RuleElementForm")}static{__name2(this,"RuleElementForm")}template="systems/pf2e/templates/items/rules/default.hbs";tabs=null;#activeTab=null;get basePath(){return`system.rules.${this.index}`}constructor(options){this.initialize(options)}initialize(options){this.sheet=options.sheet,this.index=options.index,this.rule=options.rule,this.object=options.object??(()=>{const RuleElementClass=RuleElements.all[String(this.rule.key)];if(!RuleElementClass)return null;const actor=new ActorProxyPF2e({_id:foundry.utils.randomID(),name:"temp",type:"character"}),item=new ItemProxyPF2e(this.item.toObject(),{parent:actor});return new RuleElementClass(foundry.utils.deepClone(this.rule),{parent:item,strict:!1,suppressWarnings:!0})})(),this.schema=this.object?.schema??RuleElements.all[String(this.rule.key)]?.schema??null}get item(){return this.sheet.item}get fieldIdPrefix(){return`field-${this.sheet.appId}-${this.index}-`}getInitialValue({autogenerate=!1}={}){if(this.constructor.name==="RuleElementForm"&&!autogenerate)return{};const initial=this.schema?.getInitialValue();if(!initial)return{};for(const property of["priority","slug"])delete initial[property];if(!autogenerate){const removeArrays=__name2(object=>{for(const[key,value]of Object.entries(object))["predicate","definition"].includes(key)||(Array.isArray(value)?delete object[key]:e$2(value)&&removeArrays(value))},"removeArrays");removeArrays(initial)}return initial}async getData(){const[label,recognized]=(()=>{const locPath=`PF2E.RuleElement.${this.rule.key}`,localized=game.i18n.localize(locPath);return localized===locPath?[game.i18n.localize("PF2E.RuleElement.Unrecognized"),!1]:[localized,!0]})(),autogenerate=this.object?.constructor?.autogenForms??!1,mergedRule=foundry.utils.mergeObject(this.getInitialValue({autogenerate}),this.rule),validationFailures=(()=>{const fieldFailures=this.object?.validationFailures.fields?.asError().getAllFailures()??{},jointFailures=this.object?.validationFailures.joint?{joint:this.object.validationFailures.joint}:{};return Object.entries({...fieldFailures,...jointFailures}).map(([key,failure])=>key==="joint"?failure.message.replace(/^.*Joint Validation Error:\s*/,""):`${key}: ${failure.message}`)})();return{...t$3(this,["index","rule","object"]),item:this.item,label,fieldIdPrefix:this.fieldIdPrefix,recognized,basePath:this.basePath,rule:mergedRule,fields:this.schema?.fields,form:await this.#getFormHelpers(mergedRule),autogenerate,rootId:this.sheet.id,hiddenFields:["ignored","requiresEquipped","requiresInvestment","removeUponCreate","battleForm"],omittedFields:["key","priority","spinoff"],validationFailures}}async#getFormHelpers(rule){const partialsPath="systems/pf2e/templates/items/rules/partials",valueTemplate=await foundry.applications.handlebars.getTemplate(`${partialsPath}/resolvable-value.hbs`),dropZoneTemplate=await foundry.applications.handlebars.getTemplate(`${partialsPath}/drop-zone.hbs`),getResolvableData=__name2(property=>({value:foundry.utils.getProperty(rule,property),property,path:`${this.basePath}.${property}`}),"getResolvableData");return{resolvableValue:__name2((property,options={})=>valueTemplate({...getResolvableData(property),inputId:`${this.sheet.id}-${property}`,fileInput:options.hash?.fileInput??!1}),"resolvableValue"),dropZone:__name2((dropId,dropText,dropTooltip)=>dropZoneTemplate({dropId,dropText,dropTooltip}),"dropZone"),elementType:__name2(field=>{if(field instanceof fields$q.StringField)return field instanceof fields$q.FilePathField?"file-picker":field instanceof fields$q.HTMLField?"code-mirror":"input"},"elementType")}}async render(){const data=await this.getData();return foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/items/rules/partials/outer.hbs",{...data,template:await foundry.applications.handlebars.renderTemplate(this.template,data)})}async updateItem(updates){const rules=this.item.toObject().system.rules,result=foundry.utils.mergeObject(this.rule,updates,{performDeletions:!0});this.schema&&cleanDataUsingSchema(this.schema.fields,result),rules[this.index]=result,await this.item.update({"system.rules":rules})}activateListeners(html2){this.element=html2;const selectorElement=htmlQuery(html2,"tagify-tags.selector-list");tagify(selectorElement);const priorityInput=htmlQuery(html2,"header input[data-priority]");if(priorityInput?.addEventListener("change",event2=>{event2.stopPropagation();const value=priorityInput.value;value===""||Number.isNaN(Number(value))?this.updateItem({"-=priority":null}):this.updateItem({priority:Number(value)})}),this.tabs){for(const anchor of htmlQueryAll(html2,"a[data-rule-tab]"))anchor.addEventListener("click",()=>this.activateTab(html2,anchor.dataset.ruleTab));this.activateTab(html2,this.#activeTab)}for(const dropZone of htmlQueryAll(html2,"div.rules-drop-zone"))dropZone.addEventListener("drop",event2=>{this.onDrop(event2,dropZone)})}async onDrop(event2,_element){const data=event2.dataTransfer?.getData("text/plain");return data?await ItemPF2e.fromDropData(JSON.parse(data))??null:null}activateTab(html2,tabName){if(!this.tabs)return;const activeTab=tabName??this.tabs.names.at(0);if(!(!activeTab||!this.tabs.names.includes(activeTab))){this.#activeTab=activeTab;for(const element of htmlQueryAll(html2,"[data-rule-tab]"))element.dataset.ruleTab===activeTab?(element.classList.add("active"),element.tagName!=="A"&&(element.style.display=this.tabs.displayStyle)):(element.classList.remove("active"),element.tagName!=="A"&&(element.style.display="none"))}}updateObject(source2){if(typeof source2=="string"){try{this.rule=JSON.parse(source2)}catch(error){if(error instanceof Error)throw ui.notifications.error("PF2E.ErrorMessage.RuleElementSyntax",{console:!1,format:{message:error.message}}),error}return}source2=foundry.utils.mergeObject(this.rule,source2,{inplace:!1});for(const slider of htmlQueryAll(this.element,"input[type=range"))slider.style.pointerEvents="none";cleanPredicate(source2),this.schema&&cleanDataUsingSchema(this.schema.fields,source2),this.rule=source2}}function cleanDataUsingSchema(schema,data){const deleteIfInitial=__name2((key,field)=>{if(data[key]===void 0)return!0;const initialValue=field.getInitialValue(data),valueRaw=data[key],value=e$2(valueRaw)&&e$2(initialValue)?{...initialValue,...valueRaw}:valueRaw;return t$6(initialValue,value)&&delete data[key],!(key in data)},"deleteIfInitial");for(const[key,field]of Object.entries(schema))if(typeof data[key]=="string"&&!(field instanceof fields$q.StringField)&&(data[key]=field.clean(data[key]),Array.isArray(data[key])&&(data[key]=data[key].filter(e2=>e2!==void 0))),!deleteIfInitial(key,field)){if("fields"in field){const value=data[key];if(e$2(value)){cleanDataUsingSchema(field.fields,value),deleteIfInitial(key,field);continue}}if(field instanceof fields$q.ArrayField&&field.element instanceof fields$q.SchemaField){const value=data[key];if(Array.isArray(value)){for(const data2 of value)e$2(data2)&&(data2.predicate&&cleanPredicate(data2),cleanDataUsingSchema(field.element.fields,data2));continue}}field instanceof fields$q.StringField&&(data[key]=field.clean(data[key],{}),deleteIfInitial(key,field))}}__name(cleanDataUsingSchema,"cleanDataUsingSchema"),__name2(cleanDataUsingSchema,"cleanDataUsingSchema");function cleanPredicate(source2){const predicateValue=source2.predicate;if(typeof predicateValue=="string")if(predicateValue.trim()==="")delete source2.predicate;else try{source2.predicate=JSON.parse(predicateValue)}catch(error){throw error instanceof Error&&ui.notifications.error("PF2E.ErrorMessage.RuleElementSyntax",{console:!1,format:{message:error.message}}),error}}__name(cleanPredicate,"cleanPredicate"),__name2(cleanPredicate,"cleanPredicate");class ActorTraitsForm extends RuleElementForm{static{__name(this,"ActorTraitsForm")}static{__name2(this,"ActorTraitsForm")}template="systems/pf2e/templates/items/rules/actor-traits.hbs";activateListeners(html2){super.activateListeners(html2);for(const input of htmlQueryAll(html2,"input.pf2e-tagify"))tagify(input,{whitelist:CONFIG.PF2E.creatureTraits,enforceWhitelist:!1})}}class AuraForm extends RuleElementForm{static{__name(this,"AuraForm")}static{__name2(this,"AuraForm")}template="systems/pf2e/templates/items/rules/aura.hbs";tabs={names:["basics","effects","appearance"],displayStyle:"grid"};#effectsMap=new Map;get effectsArray(){return[...this.#effectsMap.values()]}getInitialValue(){return this.#effectsMap.clear(),this.#effectsMap=new Map(this.object.effects.map((e2,index2)=>[index2,foundry.utils.deepClone(e2)])),super.getInitialValue()}activateListeners(html2){super.activateListeners(html2);const traitsElement=htmlQuery(html2,"tagify-tags.tagify-traits");if(traitsElement){const whitelist={...CONFIG.PF2E.spellTraits,...CONFIG.PF2E.actionTraits};tagify(traitsElement,{whitelist,enforceWhitelist:!1})}for(const eventsElement of htmlQueryAll(html2,"tagify-tags.tagify-events")){const whitelist=[["enter",game.i18n.localize("PF2E.RuleEditor.Aura.Effects.EventsOptions.Enter")],["turn-start",game.i18n.localize("PF2E.RuleEditor.Aura.Effects.EventsOptions.TurnStart")],["turn-end",game.i18n.localize("PF2E.RuleEditor.Aura.Effects.EventsOptions.TurnEnd")]].sort((a,b)=>a[1].localeCompare(b[1],game.i18n.lang));tagify(eventsElement,{whitelist:t$9(whitelist,w=>[w[0],w[1]]),enforceWhitelist:!0})}for(const element of htmlQueryAll(html2,"a[data-action=remove-effect]"))element.addEventListener("click",()=>{this.#deleteEffect(element.dataset.effectId)});for(const button of htmlQueryAll(html2,"div[data-rule-tab=effects] button[data-action=toggle-brackets]")){const fieldset=htmlClosest(button,"fieldset"),select=htmlQuery(fieldset,"select"),input=htmlQuery(fieldset,"input");select&&input&&!select.value&&(button.disabled=!0,input.disabled=!0)}for(const key of["border","highlight"]){const inputName=`system.rules.${this.index}.appearance.${key}.color`,colorPicker=htmlQuery(html2,`color-picker[name="${inputName}"]`),textInput=htmlQuery(colorPicker,"input[type=text]"),checkbox=htmlQuery(html2,`input[type=checkbox][name="${inputName}"]`);colorPicker&&textInput&&checkbox&&(this.object.appearance[key]?.color==="user-color"?(colorPicker.removeAttribute("name"),colorPicker.disabled=!0,textInput.disabled=!0):checkbox.removeAttribute("name"),checkbox.addEventListener("change",event2=>{event2.stopPropagation(),checkbox.checked?(checkbox.name=inputName,colorPicker.removeAttribute("name"),colorPicker.disabled=!0,textInput.disabled=!0,textInput.value=colorPicker.value=userColorForActor(this.object.actor)):(colorPicker.name=inputName,checkbox.removeAttribute("name"),colorPicker.disabled=!1,textInput.disabled=!1,textInput.value=colorPicker.value="#000000")}))}const translationX=htmlQuery(html2,"input[data-translation=x]"),translationY=htmlQuery(html2,"input[data-translation=y]");translationX&&translationY&&(translationX.addEventListener("change",()=>{translationX.value!==""&&translationY.value===""&&(translationY.value=translationX.value)}),translationY.addEventListener("change",()=>{translationY.value!==""&&translationX.value===""&&(translationX.value=translationY.value)}))}async getData(){const data=await super.getData(),{border,highlight}=this.object.appearance,userColor=userColorForActor(this.object.actor);return Object.assign(data,{affectsOptions:{all:"PF2E.RuleEditor.Aura.Effects.AffectsOptions.All",allies:"PF2E.RuleEditor.Aura.Effects.AffectsOptions.Allies",enemies:"PF2E.RuleEditor.Aura.Effects.AffectsOptions.Enemies"},effects:this.effectsArray.map(e2=>({...e2,item:fromUuidSync(e2.uuid)})),borderColor:border?.color==="user-color"?userColor:border?.color?.toString()??null,highlightColor:highlight.color==="user-color"?userColor:highlight?.color?.toString(),saveTypes:CONFIG.PF2E.saves,isImageFile:isImageFilePath(this.rule.appearance?.texture?.src)})}async onDrop(event2,element){const{id}=element.dataset;if(id!=="aura-effect-drop")return null;const item=await super.onDrop(event2,element);return!item?.isOfType("effect")||!this.schema?null:(this.#addEffect(item.uuid),item)}async updateItem(updates){const expanded=foundry.utils.expandObject(updates);return expanded.effects&&(expanded.effects=this.#updateEffectsMap(expanded)),super.updateItem(expanded)}updateObject(source2){source2.effects=this.#updateEffectsMap(source2);for(const key of["level","radius"]){if(key in source2&&!source2[key]){delete source2[key];continue}const stringValue=source2[key],maybeIntegerValue=typeof stringValue=="string"&&/^\d+$/.test(stringValue)?Number(stringValue):NaN;Number.isInteger(maybeIntegerValue)&&(source2[key]=maybeIntegerValue)}const appearance=source2.appearance;if(appearance.texture){const texture=appearance.texture;if(texture.translation){const{x,y}=texture.translation;!x&&!y&&(texture.translation=null)}texture.src?isImageFilePath(texture.src)&&(texture.loop=!0,texture.playbackRate=1):appearance.texture=null}super.updateObject(source2)}#addEffect(uuid){const index2=this.#effectsMap.size+1;this.#effectsMap.set(index2,{uuid}),this.updateItem({effects:this.effectsArray})}#updateEffectsMap(source2){return this.#effectsMap=new Map(Object.values(source2.effects??{}).map((data,index2)=>{const updatedData=foundry.utils.deepClone(data),deletions={};if(updatedData.save&&(updatedData.save.type??data.save?.type?updatedData.save.dc||=10:deletions["-=save"]=null),updatedData.affects!=="enemies"&&updatedData.includesSelf&&(deletions["-=includesSelf"]=null),updatedData.removeOnExit&&(deletions["-=removeOnExit"]=null),updatedData.predicate)try{const parsed=JSON.parse(String(updatedData.predicate));updatedData.predicate=Array.isArray(parsed)?parsed:[]}catch{deletions["-=predicate"]=null}else deletions["-=predicate"]=null;return[index2,foundry.utils.mergeObject(updatedData,deletions,{performDeletions:!0})]})),this.effectsArray}#deleteEffect(id){const index2=Number(id);Number.isNaN(index2)||this.#effectsMap.delete(index2)&&this.updateItem({effects:this.effectsArray})}}class DamageAlterationForm extends RuleElementForm{static{__name(this,"DamageAlterationForm")}static{__name2(this,"DamageAlterationForm")}async getData(){const data=await super.getData();return typeof data.rule.selectors=="string"&&(data.rule.selectors=[data.rule.selectors]),data.hiddenFields.push("label","slug"),data}}class FastHealingForm extends RuleElementForm{static{__name(this,"FastHealingForm")}static{__name2(this,"FastHealingForm")}template="systems/pf2e/templates/items/rules/fast-healing.hbs";activateListeners(html2){super.activateListeners(html2);const selectorElement=htmlQuery(html2,"tagify-tags.deactivated-by");if(selectorElement){const whitelist=CONFIG.PF2E.weaknessTypes;tagify(selectorElement,{whitelist,enforceWhitelist:!1})}}async getData(){const data=await super.getData();return Object.assign(data,{types:{"fast-healing":"PF2E.Encounter.Broadcast.FastHealing.fast-healing.Name",regeneration:"PF2E.Encounter.Broadcast.FastHealing.regeneration.Name"}})}updateObject(source2){delete source2[source2.type==="regeneration"?"details":"deactivatedBy"],super.updateObject(source2)}}class FlatModifierForm extends RuleElementForm{static{__name(this,"FlatModifierForm")}static{__name2(this,"FlatModifierForm")}template="systems/pf2e/templates/items/rules/flat-modifier.hbs";get isDamage(){return[this.rule.selector??[]].flat().some(s=>s==="damage"||String(s).endsWith("-damage"))}activateListeners(html2){super.activateListeners(html2),htmlQuery(html2,"[data-action=toggle-selector]")?.addEventListener("click",()=>{const selector=this.rule.selector,newValue=Array.isArray(selector)?selector.at(0)??"":[selector??""].filter(s=>!!s);this.updateItem({selector:newValue})})}async getData(){const data=await super.getData(),abpEnabled=AutomaticBonusProgression$1.isEnabled(null),types=t$9(Array.from(MODIFIER_TYPES).filter(t2=>abpEnabled||t2!=="potency").sort((a,b)=>a[0]==="untyped"?-1:b[0]==="untyped"?1:a[1].localeCompare(b[1])),t2=>[t2,game.i18n.localize(`PF2E.ModifierType.${t2}`)]);return typeof data.rule.selector=="string"&&(data.rule.selector=[data.rule.selector]),Object.assign(data,{abilities:CONFIG.PF2E.abilities,types,damageCategories:t$3(CONFIG.PF2E.damageCategories,DAMAGE_CATEGORIES_UNIQUE),isDamage:this.isDamage,criticalOptions:[{value:"false",label:"PF2E.RuleEditor.General.CriticalBehavior.false"},{value:"true",label:"PF2E.RuleEditor.General.CriticalBehavior.true"}]})}updateObject(formData){delete formData[formData.type==="ability"?"value":"ability"],formData.critical=tupleHasValue([!1,"false"],formData.critical)?!1:!!formData.critical||null,this.isDamage||(delete formData.damageCategory,delete formData.damageType,delete formData.critical),super.updateObject(formData)}}class GrantItemForm extends RuleElementForm{static{__name(this,"GrantItemForm")}static{__name2(this,"GrantItemForm")}template="systems/pf2e/templates/items/rules/grant-item.hbs";async getData(){const data=await super.getData(),uuid=this.rule.uuid?String(this.rule.uuid):null,granted=UUIDUtils.isItemUUID(uuid)?await fromUuid(uuid):null;return Object.assign(data,{granted})}updateObject(ruleData){super.updateObject(ruleData),typeof ruleData.uuid=="string"&&(ruleData.uuid=ruleData.uuid.trim())}}class RollNoteForm extends RuleElementForm{static{__name(this,"RollNoteForm")}static{__name2(this,"RollNoteForm")}async getData(){const data=await super.getData();return typeof data.rule.selector=="string"&&(data.rule.selector=[data.rule.selector]),data.hiddenFields.push("label","slug"),data}}class TokenImageForm extends RuleElementForm{static{__name(this,"TokenImageForm")}static{__name2(this,"TokenImageForm")}template="systems/pf2e/templates/items/rules/token-image.hbs";tabs={names:["basics","ring"],displayStyle:"grid"};async getData(){return Object.assign(await super.getData(),{alphaEnabled:this.object.alpha!==null,scaleEnabled:this.object.scale!==null})}activateListeners(html2){super.activateListeners(html2);const tintInput=html2.querySelector(`input[name="system.rules.${this.index}.tint"]`);tintInput&&(tintInput.id=`${this.fieldIdPrefix}-tint`);for(const fieldName of["alpha","scale"]){const checkbox=html2.querySelector(`input[data-action=toggle-${fieldName}]`),input=html2.querySelector(`range-picker[name="system.rules.${this.index}.${fieldName}"]`);checkbox&&input&&(input.id=`${this.fieldIdPrefix}-${fieldName}`,input.disabled=this.object[fieldName]===null,checkbox.addEventListener("change",event2=>{event2.stopPropagation();const newValue=this.object[fieldName]===null?1:null;this.updateItem({[fieldName]:newValue})}))}}updateObject(source2){return e$2(source2.ring)&&e$2(source2.ring.subject)&&typeof source2.ring.subject.texture=="string"&&!source2.ring.subject.texture.trim()&&(source2.ring=null),super.updateObject(source2)}}class TokenLightForm extends RuleElementForm{static{__name(this,"TokenLightForm")}static{__name2(this,"TokenLightForm")}template="systems/pf2e/templates/items/rules/token-light.hbs";tabs={names:["basic","animation","advanced"],displayStyle:"grid"};async getData(){const data=await super.getData();return Object.assign(data,{colorationTechniques:foundry.canvas.rendering.shaders.AdaptiveLightingShader.SHADER_TECHNIQUES,light:data.rule.value,lightAnimations:t$5(CONFIG.Canvas.lightAnimations,value=>value.label)})}}const RULE_ELEMENT_FORMS={ActorTraits:ActorTraitsForm,Aura:AuraForm,DamageAlteration:DamageAlterationForm,FastHealing:FastHealingForm,FlatModifier:FlatModifierForm,GrantItem:GrantItemForm,Note:RollNoteForm,TokenImage:TokenImageForm,TokenLight:TokenLightForm};class ItemSheetPF2e extends foundry.appv1.sheets.ItemSheet{static{__name(this,"ItemSheetPF2e")}static{__name2(this,"ItemSheetPF2e")}constructor(item,options={}){super(item,options),this.options.classes.push(this.item.type)}static _warnedAppV1=!0;static get defaultOptions(){const options=super.defaultOptions;return options.classes.push("pf2e","item"),{...options,width:700,height:460,template:"systems/pf2e/templates/items/sheet.hbs",scrollY:[".tab.active",".inventory-details","div[data-rule-tab]"],tabs:[{navSelector:".tabs",contentSelector:".sheet-body",initial:"description"},{navSelector:".mystify-nav",contentSelector:".mystify-sheet",initial:"unidentified"}],hasSidebar:!1}}#selectedRuleElementType=Object.keys(RuleElements.all).at(0)??null;#editingRuleElementIndex=null;#rulesLastScrollTop=null;#ruleElementForms=[];get editingRuleElement(){return this.#editingRuleElementIndex===null?null:this.item.toObject().system.rules[this.#editingRuleElementIndex]??null}get validTraits(){return this.item.constructor.validTraits}async getData(options={}){options.id=this.id,options.editable=this.isEditable,options.sheetConfig&&=Object.values(CONFIG.Item.sheetClasses[this.item.type]).filter(c=>c.canConfigure).length>1,this.#createRuleElementForms();const enrichedContent={},item=this.item,description=await item.getDescription({includeAddendum:!1,secrets:item.isOwner});enrichedContent.description=description.value,enrichedContent.gmNotes=description.gm;const validTraits=this.validTraits,hasRarity=!item.isOfType("action","condition","deity","effect","lore","melee"),itemTraits=item.system.traits?.value??[],sourceTraits=item._source.system.traits?.value??[],traits=validTraits?createSheetTags(validTraits,itemTraits):null,traitTagifyData=validTraits?createTagifyTraits(itemTraits,{sourceTraits,record:validTraits}):null,otherTagsTagifyData=createTagifyTraits(item.system.traits.otherTags,{sourceTraits:item._source.system.traits.otherTags});return{itemType:null,showTraits:!e$4(this.validTraits),sidebarTitle:game.i18n.format("PF2E.Item.SidebarSummary",{type:game.i18n.localize(`TYPES.Item.${item.type}`)}),sidebarTemplate:options.hasSidebar?`systems/pf2e/templates/items/${sluggify(item.type)}-sidebar.hbs`:null,detailsTemplate:`systems/pf2e/templates/items/${sluggify(item.type)}-details.hbs`,cssClass:this.isEditable?"editable":"locked",editable:this.isEditable,document:item,item,isPhysical:!1,data:item.system,systemFields:item.system instanceof ItemSystemModel?item.system.schema.fields:{},fieldRootId:item.collection?.has(item.id)?this.id:foundry.utils.randomID(),fieldIdPrefix:`field-${this.appId}-`,enrichedContent,limited:item.limited,options:this.options,owner:item.isOwner,title:this.title,user:{isGM:game.user.isGM},rarity:hasRarity?item.system.traits?.rarity??"common":null,rarities:CONFIG.PF2E.rarityTraits,traits,traitTagifyData,otherTagsTagifyData,enabledRulesUI:game.user.hasRole(game.settings.get("pf2e","minimumRulesUI")),ruleEditing:!!this.editingRuleElement,rules:{selection:{selected:this.#selectedRuleElementType,types:sortStringRecord(Object.keys(RuleElements.all).reduce((result,key)=>Object.assign(result,{[key]:`PF2E.RuleElement.${key}`}),{}))},elements:await Promise.all(this.#ruleElementForms.map(async form=>({template:await form.render()})))},proficiencyRanks:CONFIG.PF2E.proficiencyLevels,publicationLicenses:[{label:"PF2E.Publication.License.OGL",value:"OGL"},{label:"PF2E.Publication.License.ORC",value:"ORC"}],rootId:this.id}}#createRuleElementForms(){const rules=this.item.toObject().system.rules,previousForms=[...this.#ruleElementForms],processedRules=rules.map((rule,index2)=>{const options={sheet:this,index:index2,rule,object:this.item.rules.find(r2=>r2.sourceIndex===index2)??null},FormClass=RULE_ELEMENT_FORMS[String(rule.key)]??RuleElementForm,existing=previousForms.find(f=>t$6(f.rule,rule)&&f.constructor.name===FormClass.name)??null;return existing&&previousForms.splice(previousForms.indexOf(existing),1),{options,FormClass,existing}});for(const rule of processedRules.filter(r2=>!r2.existing)){const existing=this.#ruleElementForms.at(rule.options.index),alreadyMatched=processedRules.some(r2=>r2.existing===existing);existing?.constructor.name===rule.FormClass.name&&!alreadyMatched&&(rule.existing=existing)}this.#ruleElementForms=processedRules.map(processed=>processed.existing?(processed.existing.initialize(processed.options),processed.existing):new processed.FormClass(processed.options))}onTagSelector(anchor){const selectorType=anchor.dataset.tagSelector??"";if(!["basic","languages"].includes(selectorType))throw ErrorPF2e("Item sheets can only use the basic tag selector");const objectProperty=anchor.dataset.property??"",configTypes=(anchor.dataset.configTypes??"").split(",").map(type2=>type2.trim()).filter(tag=>tupleHasValue(SELECTABLE_TAG_FIELDS,tag)),options={objectProperty,configTypes,title:anchor.dataset.title,flat:anchor.dataset.flat==="true"};this.actor&&configTypes.includes("attackEffects")&&(options.customChoices=this.getAttackEffectOptions());const SelectorClass=selectorType==="languages"?LanguageSelector:TagSelectorBasic;new SelectorClass(this.item,options).render(!0)}getAttackEffectOptions(){return(this.actor?.items.contents??[]).filter(i=>i.isOfType("action","consumable")).reduce((options,item)=>{const key=item.slug??sluggify(item.name);return{...options,[key]:item.name}},foundry.utils.deepClone(CONFIG.PF2E.attackEffects))}async activateEditor(name2,options={},initialContent=""){const sourceContent=name2==="system.description.value"?this.item._source.system.description.value:initialContent,mutuallyExclusive=["system.description.gm","system.description.value"];if(mutuallyExclusive.includes(name2)){const html2=this.element[0];for(const elementName of mutuallyExclusive.filter(n2=>n2!==name2)){const section=html2.querySelector(`[data-edit="${elementName}"]`)?.closest(".editor-container");section&&(section.style.display="none")}name2==="system.description.value"?html2.querySelector("a[data-action=add-gm-notes]")?.remove():name2==="system.description.gm"&&html2.querySelector("a.editor-edit")?.remove(),html2.querySelector(".tab.description")?.classList.add("editing")}return super.activateEditor(name2,options,sourceContent)}async close(options){return this.#editingRuleElementIndex=null,super.close(options)}_configureProseMirrorPlugins(name2,options){const plugins=super._configureProseMirrorPlugins(name2,options);return plugins.menu=foundry.prosemirror.ProseMirrorMenu.build(foundry.prosemirror.defaultSchema,{destroyOnSave:options.remove,onSave:__name2(()=>this.saveEditor(name2,options),"onSave"),compact:this.options.hasSidebar}),plugins}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const anchor of htmlQueryAll(html2,"a.tag-selector"))anchor.addEventListener("click",()=>this.onTagSelector(anchor));const rulesPanel=html2.querySelector(".tab[data-tab=rules]"),slugInput=rulesPanel?.querySelector('input[name="system.slug"]');slugInput&&slugInput.addEventListener("change",()=>{slugInput.value=sluggify(slugInput.value)});const ruleElementSelect=rulesPanel?.querySelector("select[data-action=select-rule-element]");ruleElementSelect?.addEventListener("change",()=>{this.#selectedRuleElementType=ruleElementSelect.value});for(const button of rulesPanel?.querySelectorAll("button")??[])switch(button.dataset.action){case"copy-to-clipboard":{button.disabled=!1,button.addEventListener("click",()=>{const clipText=button.dataset.clipboard;clipText&&(game.clipboard.copyPlainText(clipText),ui.notifications.info(game.i18n.format("PF2E.ClipboardNotification",{clipText})))});break}case"regenerate-slug":button.addEventListener("click",()=>{if(!slugInput||this._submitting)return;slugInput.value=sluggify(this.item._source.name);const event2=new Event("change");slugInput.dispatchEvent(event2)});break;case"view-roll-options":button.disabled=!1,button.addEventListener("click",async()=>{const content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/system/roll-options-tooltip.hbs",{description:game.i18n.localize("PF2E.Item.Rules.Hint.RollOptions"),rollOptions:t(this.item.getRollOptions("item").sort(),o=>o.includes(":"))});game.tooltip.dismissLockedTooltips(),game.tooltip.activate(button,{html:createHTMLElement("div",{innerHTML:content}),locked:!0})});break;case"add-rule-element":button.addEventListener("click",async()=>{const rulesData=this.item.toObject().system.rules,key=this.#selectedRuleElementType??"NewRuleElement";await this.item.update({"system.rules":rulesData.concat({key})})});break;case"edit-rule-element":button.addEventListener("click",async()=>{if(this._submitting)return;const index2=Number(button.dataset.ruleIndex??"NaN");this.#editingRuleElementIndex=Number.isInteger(index2)?index2:null,this.#rulesLastScrollTop=rulesPanel?.scrollTop??null,this.render()});break;case"remove-rule-element":button.addEventListener("click",async()=>{const rules2=this.item.toObject().system.rules,index2=Number(button.dataset.ruleIndex??"NaN");rules2&&Number.isInteger(index2)&&rules2.length>index2&&(rules2.splice(index2,1),this.item.update({"system.rules":rules2}))});break}const editingRuleElement=this.editingRuleElement;if(editingRuleElement){const ruleText=JSON.stringify(editingRuleElement,null,2),schema=RuleElements.all[String(editingRuleElement.key)]?.schema.fields,view=new CodeMirror.EditorView({doc:ruleText,extensions:[CodeMirror.basicSetup,CodeMirror.keybindings,...CodeMirror.ruleElementExtensions({schema})]});html2.querySelector(".rule-editing .editor-placeholder")?.replaceWith(view.dom);const closeBtn=html2.querySelector(".rule-editing button[data-action=close]");closeBtn?.addEventListener("click",()=>{this.#editingRuleElementIndex=null,this.render()}),closeBtn?.removeAttribute("disabled"),html2.querySelector(".rule-editing button[data-action=apply]")?.addEventListener("click",()=>{const value=view.state.doc.toString();if(this.#editingRuleElementIndex===null){this.#editingRuleElementIndex=null,this.render();return}try{const rules2=this.item.toObject().system.rules;rules2[this.#editingRuleElementIndex]=JSON.parse(value),this.#editingRuleElementIndex=null,this.item.update({"system.rules":rules2})}catch(error){if(error instanceof Error)throw ui.notifications.error(game.i18n.format("PF2E.ErrorMessage.RuleElementSyntax",{message:error.message})),console.warn("Syntax error in rule element definition.",error.message,value),error}})}for(const ruleSection of html2.querySelectorAll(".rules .rule-form")){const idx=ruleSection.dataset.idx?Number(ruleSection.dataset.idx):NaN;this.#ruleElementForms.at(idx)?.activateListeners(ruleSection)}const validTraits=this.validTraits,tagElement=this.form.querySelector(":scope > header tagify-tags"),traitsPrepend=html2.querySelector(".traits-extra");if(validTraits!==null&&tagElement){const tags=tagify(tagElement,{whitelist:validTraits});traitsPrepend&&tags.DOM.scope.prepend(traitsPrepend.content)}else traitsPrepend&&html2.querySelector("div.paizo-style.tags")?.append(traitsPrepend.content);tagify(html2.querySelector('tagify-tags[name="system.traits.otherTags"]'),{maxTags:6});const modifiedPropertyFields=html2.querySelectorAll("input[data-property], select[data-property]");for(const input of modifiedPropertyFields){const propertyPath=input.dataset.property??"",baseValue=input.dataset.valueBase??String(foundry.utils.getProperty(this.item._source,propertyPath)??"").trim();input.addEventListener("focus",()=>{input.dataset.value=input.value,input.value=baseValue,input.name=propertyPath}),input.addEventListener("blur",()=>{input.removeAttribute("name"),input.value===baseValue&&(input.value=input.dataset.value??"")})}if(this.isEditable&&game.user.isGM&&!this.item.system.description.gm&&!(this.item.isOfType("spell")&&this.item.isVariant)){const descriptionEditors=html2.querySelector(".tab[data-tab=description]"),mainEditor=descriptionEditors?.querySelector(".main .editor");if(!mainEditor)throw ErrorPF2e("Unexpected error retrieving description editor");const addGMNotesLink=document.createElement("a");addGMNotesLink.className=addGMNotesLink.dataset.action="add-gm-notes",addGMNotesLink.innerHTML=fontAwesomeIcon("fa-note-medical",{style:"regular"}).outerHTML,addGMNotesLink.dataset.tooltip="PF2E.Item.GMNotes.Add",mainEditor.prepend(addGMNotesLink),addGMNotesLink.addEventListener("click",()=>{descriptionEditors?.querySelector(".gm-notes")?.classList.add("has-content"),this.activateEditor("system.description.gm")})}const rules=html2.querySelector(".rule-element-forms");rules&&createSortable(rules,{...SORTABLE_BASE_OPTIONS,handle:".drag-handle",onEnd:__name2(async event2=>{const currentIndex=event2.oldDraggableIndex,newIndex=event2.newDraggableIndex;if(currentIndex===void 0||newIndex===void 0){this.render();return}const rules2=this.item.toObject().system.rules,movingRule=rules2.at(currentIndex);movingRule&&newIndex<=rules2.length?(rules2.splice(currentIndex,1),rules2.splice(newIndex,0,movingRule),await this.item.update({"system.rules":rules2})||this.render()):this.render()},"onEnd")});const refreshAnchor=html2.closest("div.item.sheet")?.querySelector("a.refresh-from-compendium");refreshAnchor&&(this.item.system.rules.some(r2=>typeof r2.key=="string"&&["ChoiceSet","GrantItem"].includes(r2.key))?(refreshAnchor.classList.add("disabled"),refreshAnchor.dataset.tooltip="PF2E.Item.RefreshFromCompendium.Tooltip.Disabled"):refreshAnchor.dataset.tooltip="PF2E.Item.RefreshFromCompendium.Tooltip.Enabled");for(const link of htmlQueryAll(html2,"a[data-action=view-item]"))link.addEventListener("click",async()=>{const uuid=link.closest("li")?.dataset.uuid??"",item=await fromUuid(uuid);if(!(item instanceof ItemPF2e)){this.render(!1),ui.notifications.error(`An item with the UUID "${uuid}" no longer exists`);return}item.sheet.render(!0)})}_getHeaderButtons(){const buttons=super._getHeaderButtons();return this.isEditable&&this.item.sourceId?.startsWith("Compendium.")&&(this.actor||!this.item.uuid.startsWith("Compendium."))&&buttons.unshift({label:"PF2E.Item.RefreshFromCompendium.Label",class:"refresh-from-compendium",icon:"fa-solid fa-rotate",onclick:__name2(()=>{!this.item.system.rules.some(r2=>typeof r2.key=="string"&&["ChoiceSet","GrantItem"].includes(r2.key))&&this.item.refreshFromCompendium()},"onclick")}),buttons}_canDragDrop(){return this.isEditable}async _updateObject(event2,formData){const expanded=foundry.utils.expandObject(formData),ruleSection=htmlClosest(event2.target,".rule-form[data-idx]");if(ruleSection){const idx=Number(ruleSection.dataset.idx),ruleForm=this.#ruleElementForms[idx],itemRules=this.item.toObject().system.rules;if(idx>=itemRules.length||!ruleForm)throw ErrorPF2e(`Invalid rule form update, no rule form available at index ${idx}`);const incomingData=expanded.system?.rules?.[idx];incomingData&&(ruleForm.updateObject(incomingData),itemRules[idx]=ruleForm.rule,this.item.update({"system.rules":itemRules}))}return delete expanded.system?.rules,super._updateObject(event2,foundry.utils.flattenObject(expanded))}async _render(force,options){if(await maintainFocusInRender(this,()=>super._render(force,options)),this.#editingRuleElementIndex===null&&this.#rulesLastScrollTop){const rulesTab=this.element[0].querySelector(".tab[data-tab=rules]");rulesTab&&(rulesTab.scrollTop=this.#rulesLastScrollTop),this.#rulesLastScrollTop=null}}}class PhysicalItemSheetPF2e extends ItemSheetPF2e{static{__name(this,"PhysicalItemSheetPF2e")}static{__name2(this,"PhysicalItemSheetPF2e")}static get defaultOptions(){const options=super.defaultOptions;return options.classes.push("physical"),{...options,hasSidebar:!0}}async getData(options){const sheetData=await super.getData(options),{item}=this,bulkAdjustment=getAdjustment(item.system.bulk.value,item._source.system.bulk.value,{better:"lower"}),basePrice=new Coins(item._source.system.price.value),priceAdjustment=getAdjustment(item.system.price.value.copperValue,basePrice.copperValue),rollData={...item.getRollData(),...this.actor?.getRollData()};sheetData.enrichedContent.unidentifiedDescription=await TextEditorPF2e.enrichHTML(sheetData.item.system.identification.unidentified?.data.description.value??"",{rollData});const adjustedLevelHint=(()=>{const hintText=AutomaticBonusProgression$1.isEnabled(this.actor)?"PF2E.Item.Weapon.FromABP":"PF2E.Item.Weapon.FromMaterialAndRunes",levelLabel=game.i18n.lang==="de"?game.i18n.localize("PF2E.LevelLabel"):game.i18n.localize("PF2E.LevelLabel").toLocaleLowerCase(game.i18n.lang);return item.level!==item._source.system.level.value?game.i18n.format(hintText,{property:levelLabel,value:item.level}):null})(),adjustedPriceHint=(()=>{if(!priceAdjustment)return null;const baseData=item._source,basePrice2=new Coins(baseData.system.price.value).scale(baseData.system.quantity).copperValue,derivedPrice=item.assetValue.copperValue,priceLabel=game.i18n.lang==="de"?game.i18n.localize("PF2E.PriceLabel"):game.i18n.localize("PF2E.PriceLabel").toLocaleLowerCase(game.i18n.lang);return basePrice2!==derivedPrice?game.i18n.format(game.i18n.localize("PF2E.Item.Weapon.FromMaterialAndRunes"),{property:priceLabel,value:item.price.value.toString()}):null})(),localizeBulk=localizer("PF2E.Item.Physical.Bulk"),bulks=[0,.1,...Array.fromRange(50,1)].map(value=>value===0?{value,label:localizeBulk("Negligible.Label")}:value===.1?{value,label:localizeBulk("Light.Label")}:{value,label:value.toString()});return{...sheetData,itemType:game.i18n.localize("PF2E.ItemTitle"),sidebarTemplate:"systems/pf2e/templates/items/physical-sidebar.hbs",bulkAdjustment,adjustedLevelHint,price:{base:new Coins(item._source.system.price.value).toString({short:!0}),label:item.system.price.value.toString({short:!0}),adjustment:priceAdjustment,adjustmentHint:adjustedPriceHint,per:item.system.price.per},attributes:CONFIG.PF2E.abilities,actionTypes:CONFIG.PF2E.actionTypes,bulks,actionsNumber:CONFIG.PF2E.actionsNumber,frequencies:CONFIG.PF2E.frequencies,sizes:n$1(CONFIG.PF2E.actorSizes,["sm"]),usages:sortStringRecord(CONFIG.PF2E.usages),usageOptions:[{label:"0",value:"worngloves"},{label:"1",value:"held-in-one-hand"},{label:"1+",value:"held-in-one-plus-hands"},{label:"2",value:"held-in-two-hands"}],identificationStatusOptions:[{label:"PF2E.identification.Identified",value:"identified"},{label:"PF2E.identification.Unidentified",value:"unidentified"}],isApex:tupleHasValue(item._source.system.traits.value,"apex"),isPhysical:!0,bulkDisabled:!!sheetData.data?.stackGroup?.trim()}}render(force,options){return!this.item.isIdentified&&!game.user.isGM?(ui.notifications.warn(this.item.description),this):super.render(force,options)}getMaterialSheetData(item,valuationData){const preciousMaterials2=CONFIG.PF2E.preciousMaterials,isSpecificMagicItem=item.isSpecific,materials=[{value:JSON.stringify({type:null,grade:null}),label:"",group:""}];for(const[materialKey,materialData]of Object.entries(valuationData)){const validGrades=[...PRECIOUS_MATERIAL_GRADES].filter(grade=>!!materialData[grade]&&(!isSpecificMagicItem||item.system.material.type===materialKey));if(validGrades.length){const group=game.i18n.localize(preciousMaterials2[materialKey]);for(const grade of validGrades){const gradeLabel=game.i18n.localize(CONFIG.PF2E.preciousMaterialGrades[grade]),label=game.i18n.format("PF2E.Item.Weapon.MaterialAndRunes.MaterialOption",{type:group,grade:gradeLabel});materials.push({value:JSON.stringify({type:materialKey,grade}),label,group})}}}return materials.sort((a,b)=>a.group.localeCompare(b.group,game.i18n.lang)),{value:JSON.stringify(t$3(this.item.material,["type","grade"])),materials}}activateListeners($html){super.activateListeners($html);const html2=$html[0];htmlQuery(html2,"ul[data-subitems]")?.addEventListener("click",async event2=>{const anchor=htmlClosest(event2.target,"a[data-action]");if(!anchor)return;const item=this.item,subitemId=htmlClosest(anchor,"[data-subitem-id]")?.dataset.subitemId,subitem=item.subitems.get(subitemId,{strict:!0});switch(anchor.dataset.action){case"edit-subitem":return subitem.sheet.render(!0);case"detach-subitem":return subitem.detach({skipConfirm:isControlDown(event2)});case"delete-subitem":return event2.ctrlKey?subitem.delete():subitem.deleteDialog();default:throw ErrorPF2e("Unexpected control options")}})}async _updateObject(event2,formData){const[materialType,materialGrade]=[formData["system.material.type"],formData["system.material.grade"]],typeIsValid=materialType===void 0||typeof materialType=="string"&&materialType in CONFIG.PF2E.preciousMaterials,gradeIsValid=materialGrade===void 0||typeof materialGrade=="string"&&materialGrade in CONFIG.PF2E.preciousMaterialGrades;return(!typeIsValid||!gradeIsValid)&&(formData["system.material.type"]=null,formData["system.material.grade"]=null),formData["system.baseItem"]===""&&(formData["system.baseItem"]=null),"system.price.value"in formData&&(formData["system.price.==value"]=Coins.fromString(String(formData["system.price.value"])).toObject(),delete formData["system.price.value"]),super._updateObject(event2,formData)}}class AmmoPF2e extends PhysicalItemPF2e{static{__name(this,"AmmoPF2e")}static{__name2(this,"AmmoPF2e")}static get validTraits(){return CONFIG.PF2E.consumableTraits}get isMagazine(){return this.system.uses.max>1||!!CONFIG.PF2E.ammoTypes[this.system.baseItem??"arrows"]?.magazine}get uses(){return t$3(this.system.uses,["value","max"])}prepareBaseData(){const ammoTypeData=this.system.baseItem?CONFIG.PF2E.ammoTypes[this.system.baseItem]:null;this.system.stackGroup=ammoTypeData?.stackGroup??null,super.prepareBaseData(),this.system.uses.max||=1,this.system.traits.value.includes("consumable")||(this.system.uses.autoDestroy=!1);for(const rule of this.system.rules)if(rule.key==="RollOption"&&"toggleable"in rule&&rule.toggleable){console.warn("Toggleable RollOption rule elements may not be added to ammunition"),this.system.rules=[];break}else if(["GrantItem","ChoiceSet"].includes(String(rule.key))){console.warn(`${rule.key} rule elements may not be added to ammunition`),this.system.rules=[];break}}isAmmoFor(weapon){if(!weapon.isOfType("weapon"))return console.warn("Cannot load a consumable into a non-weapon"),!1;const weaponData=weapon.system.ammo;if(!weaponData||weaponData.builtIn)return!1;const thisAmmoTypeData=this.system.baseItem?CONFIG.PF2E.ammoTypes[this.system.baseItem]:null,weaponAmmoTypeData=objectHasKey(CONFIG.PF2E.ammoTypes,weaponData.baseType)?CONFIG.PF2E.ammoTypes[weaponData.baseType]:null,basicAmmoType=thisAmmoTypeData?.parent??this.system.baseItem,basicWeaponAmmoType=weaponAmmoTypeData?.parent??weaponData.baseType,isMagazine=thisAmmoTypeData?.magazine||this.system.uses.max>1;return!this.system.baseItem&&this.system.craftableAs&&!isMagazine&&!!weaponAmmoTypeData&&(this.system.craftableAs.length===0||!basicWeaponAmmoType||tupleHasValue(this.system.craftableAs,basicWeaponAmmoType))||this.system.baseItem===weaponData.baseType||!isMagazine&&weaponData.baseType===null||basicAmmoType===basicWeaponAmmoType&&(!thisAmmoTypeData?.weapon||!weaponAmmoTypeData?.weapon)}async consume(thisMany=1){const actor=this.actor;if(!actor)return;const uses=this.uses;if(this.system.craftableAs){const key=uses.max>=thisMany&&uses.value===thisMany&&uses.max>1?"UseExhausted":uses.max>thisMany?"UseMulti":"UseSingle",content=game.i18n.format(`PF2E.ConsumableMessage.${key}`,{name:this.name,current:uses.value-thisMany}),flags={pf2e:{origin:{sourceId:this.sourceId,uuid:this.uuid,type:this.type}}},speaker=ChatMessage.getSpeaker({actor});ChatMessage.create({speaker,content,flags})}if(uses.value>thisMany){await this.update({"system.uses.value":Math.max(uses.value-thisMany,0)});return}const autoDestroy=this.system.uses.autoDestroy,newQuantity=Math.max(this.quantity-(uses.max>1?1:thisMany),0),loadedAmmo=this.parentItem?.isOfType("weapon")?getLoadedAmmo(this.parentItem).filter(a=>a.quantity>0):null,isPreservedAmmo=this.system.rules.length>0||(loadedAmmo?.length??0)>1;if(autoDestroy&&newQuantity<=0&&!isPreservedAmmo)await this.delete();else if(this.parentItem&&!this.isMagazine&&!autoDestroy){const numDetach=this.quantity-newQuantity;await this.detach({quantity:numDetach,keepZero:isPreservedAmmo,skipConfirm:!0})}else this.parentItem&&this.isMagazine?await this.update({"system.quantity":1,"system.uses.value":0}):await this.update({"system.quantity":newQuantity,"system.uses.value":uses.max})}async getChatData(htmlOptions={}){const traits=this.traitChatData(AmmoPF2e.validTraits);return this.processChatData(htmlOptions,{...await super.getChatData(),traits})}async _preCreate(data,options,user){const system2=this._source.system,craftableAs=system2.craftableAs;if(this.parent&&craftableAs&&!system2.baseItem){const allAmmoTypes=t$f(CONFIG.PF2E.ammoTypes).filter(([_,data2])=>!data2.magazine).map(([slug,data2])=>({slug,...data2,option:{value:slug,label:game.i18n.localize(data2.label)}})),compatibleTypes=craftableAs.length?allAmmoTypes.filter(t2=>craftableAs.includes(t2.slug)||tupleHasValue(craftableAs,t2.parent)):allAmmoTypes,supported=n(this.parent.itemTypes.weapon.map(w=>w.system.ammo?.baseType).filter(t2=>!!t2)),result=await new PickAThingPrompt({title:this.name,prompt:game.i18n.localize("PF2E.Item.Ammo.SpecialAmmoPicker.Prompt"),item:this,choices:t(compatibleTypes,t2=>supported.includes(t2.slug)?0:t2.weapon?2:1).map(t2=>({value:t2.slug,label:game.i18n.localize(t2.label),group:game.i18n.localize(`PF2E.Item.Ammo.Groups.${supported.includes(t2.slug)?"OwnWeapons":t2.weapon?"WeaponSpecific":"General"}`)}))}).resolveSelection();system2.baseItem=result?.value??null;const stackableItem=this.actor?.inventory.findStackableItem(this._source);if(stackableItem)return stackableItem.update({"system.quantity":stackableItem.quantity+1}),!1}return super._preCreate(data,options,user)}_preUpdate(changed,operation,user){if(!changed.system)return super._preUpdate(changed,operation,user);const craftableAs="craftableAs"in changed.system?changed.system.craftableAs:this._source.system.craftableAs,baseItem="baseItem"in changed.system?changed.system.baseItem:this._source.system.baseItem;if(!(baseItem?CONFIG.PF2E.ammoTypes[baseItem]:null)?.magazine||craftableAs?.length){const autoDestroy=changed.system.uses?.autoDestroy??this._source.system.uses.autoDestroy;changed.system.uses={value:1,max:1,autoDestroy}}if(changed.system.uses){if("value"in changed.system.uses){const minimum=this.system.uses.autoDestroy?1:0;changed.system.uses.value=Math.clamp(Math.floor(Number(changed.system.uses.value))||minimum,minimum,9999)}"max"in changed.system.uses&&(changed.system.uses.max=Math.clamp(Math.floor(Number(changed.system.uses.max))||1,1,9999)),typeof changed.system.uses.value=="number"&&typeof changed.system.uses.max=="number"&&(changed.system.uses.value=Math.min(changed.system.uses.value,changed.system.uses.max))}return changed.system.price?.per!==void 0&&(changed.system.price.per=Math.clamp(Math.floor(Number(changed.system.price.per))||1,1,999)),super._preUpdate(changed,operation,user)}}const WEAPON_UPGRADES={"installed-in-a-grenade-launcher-or-two-handed-weapon-with-an-undermounted-grenade-launcher":"PF2E.TraitInstalledInAGrenadeLauncherOrTwoHandedWeaponWithAnUndermoundedGrenadeLauncher","installed-in-a-weapon-sight":"PF2E.TraitInstalledInAWeaponSight","installed-in-a-weapon-with-the-kickback-trait":"PF2E.TraitInstalledInAWeaponWithTheKickbackTrait","installed-in-a-weapon":"PF2E.TraitInstalledInAWeapon","installed-in-one-handed-weapon-grip":"PF2E.TraitInstalledInOneHandedWeaponGrip","installed-in-ranged-weapon-without-a-loudener":"PF2E.TraitInstalledInRangedWeaponWithoutALoudener","installed-in-two-handed-weapon":"PF2E.TraitInstalledInTwoHandedWeapon","installed-on-a-weapon-without-a-silencer":"PF2E.TraitInstalledOnAWeaponWithoutASilencer"},ARMOR_UPGRADES={"installed-in-armor-with-the-energy-shielding-upgrade":"PF2E.TraitInstalledInArmorWithTheEnergyShieldingUpgrade","installed-in-armor-with-the-exposed-trait":"PF2E.TraitInstalledInArmorWithTheExposedTrait","installed-in-armor":"PF2E.TraitInstalledInArmor"},USAGES={...WEAPON_UPGRADES,...ARMOR_UPGRADES,"affixed-or-held-in-one-hand":"PF2E.TraitAffixedOrHeldInOneHand","affixed-to-a-creature":"PF2E.TraitAffixedToCreature","affixed-to-a-magical-staff":"PF2E.TraitAffixedToMagicalStaff","affixed-to-a-metal-weapon":"PF2E.TraitAffixedToAMetalWeapon","affixed-to-a-one-handed-firearm-or-hand-crossbow":"PF2E.TraitAffixedToAOneHandedFirearmOrHandCrossbow","affixed-to-a-ranged-weapon":"PF2E.TraitAffixedToARangedWeapon","affixed-to-a-shield":"PF2E.TraitAffixedToAShield","affixed-to-a-shield-or-weapon":"PF2E.TraitAffixedToAShieldOrWeapon","affixed-to-a-thrown-weapon":"PF2E.TraitAffixedToThrownWeapon","affixed-to-a-two-handed-firearm-or-crossbow":"PF2E.TraitAffixedToATwoHandedFirearmOrCrossbow","affixed-to-an-innovation":"PF2E.TraitAffixedToInnovation","affixed-to-an-object-or-structure":"PF2E.TraitAffixedToObjectOrStructure","affixed-to-armor":"PF2E.TraitAffixedToArmor","affixed-to-medium-heavy-armor":"PF2E.TraitAffixedToMediumHeavyArmor","affixed-to-medium-heavy-metal-armor":"PF2E.TraitAffixedToMediumHeavyMetalArmor","affixed-to-metal-armor-or-a-weapon":"PF2E.TraitAffixedToMetalArmorOrAWeapon","affixed-to-non-metal-armor-or-a-weapon":"PF2E.TraitAffixedToNMArmorOrAWeapon","affixed-to-armor-shield-or-weapon":"PF2E.TraitAffixedToArmorShieldOrWeapon","affixed-to-armor-or-a-weapon":"PF2E.TraitAffixedToArmorOrAWeapon","affixed-to-armor-or-travelers-clothing":"PF2E.TraitAffixedToArmorOrTravelersClothing","affixed-to-crossbow-or-firearm":"PF2E.TraitAffixedToCrossbowOrFirearm","affixed-to-firearm":"PF2E.TraitAffixedToFirearm","affixed-to-firearm-with-a-reload-of-1":"PF2E.TraitAffixedToFirearmWithAReloadOf1","affixed-to-firearm-with-the-kickback-trait":"PF2E.TraitAffixedToFirearmWithTheKickbackTrait","affixed-to-ground-in-10-foot-radius":"PF2E.TraitAffixedToGroundIn10FtRadius","affixed-to-ground-in-20-foot-radius":"PF2E.TraitAffixedToGroundIn20FtRadius","affixed-to-harness":"PF2E.TraitAffixedToHarness","affixed-to-headgear":"PF2E.TraitAffixedToHeadgear","affixed-to-instrument":"PF2E.TraitAffixedToInstrument","affixed-to-load-bearing-wall-or-pillar":"PF2E.TraitAffixedToLoadBearingWallOrPillar","affixed-to-melee-weapon":"PF2E.TraitAffixedToMeleeWeapon","affixed-to-metal-weapon":"PF2E.TraitAffixedToMetalWeapon","affixed-to-object-structure-or-creature":"PF2E.TraitAffixedToStructureObjectOrCreature","affixed-to-the-ground":"PF2E.TraitAffixedToGround","affixed-to-unarmored-defense-item":"PF2E.TraitAffixedToUnarmoredItem","affixed-to-wall":"PF2E.TraitAffixedToWall","affixed-to-weapon":"PF2E.TraitAffixedToWeapon","applied-to-a-basket-bag-or-other-container":"PF2E.TraitAppliedToBasketBagOrContainer","applied-to-a-weapon":"PF2E.TraitAppliedToAWeapon","applied-to-a-wind-powered-vehicle":"PF2E.TraitAppliedToAWindPoweredVehicle","applied-to-a-non-injection-melee-weapon-piercing-damage":"PF2E.TraitAppliedToANoninjectionMeleePiercingWeapon","applied-to-any-item-of-light-or-negligible-bulk":"PF2E.TraitAppliedToAnyItemOfLightOrNegligibleBulk","applied-to-any-visible-article-of-clothing":"PF2E.TraitAppliedToAnyVisibleArticleOfClothing","applied-to-armor":"PF2E.TraitAppliedToArmor","applied-to-armor-or-unarmored-defense-clothing":"PF2E.TraitAppliedToArmorOrUnarmored","applied-to-belt-cape-cloak-or-scarf":"PF2E.TraitAppliedToBeltCapeCloakOrScarf","applied-to-boots-cape-cloak-or-umbrella":"PF2E.TraitAppliedToBootsCapeCloakOrUmbrella","applied-to-buckler-shield":"PF2E.TraitAppliedToBucklerShield","applied-to-dueling-cape-or-shield":"PF2E.TraitAppliedToDuelingCapeOrShield","applied-to-footwear":"PF2E.TraitAppliedToFootwear","applied-to-medium-heavy-armor":"PF2E.TraitAppliedToMediumHeavyArmor","applied-to-shield":"PF2E.TraitAppliedToShield","attached-to-a-thrown-weapon":"PF2E.TraitAttachedToAThrownWeapon","attached-to-crossbow-or-firearm":"PF2E.TraitAttachedToCrossbowOrFirearm","attached-to-crossbow-or-firearm-firing-mechanism":"PF2E.TraitAttachedToCrossbowOrFirearmFiringMechanism","attached-to-crossbow-or-firearm-scope":"PF2E.TraitAttachedToCrossbowOrFirearmScope","attached-to-firearm":"PF2E.TraitAttachedToFirearm","attached-to-firearm-scope":"PF2E.TraitAttachedToFirearmScope","attached-to-melee-weapon":"PF2E.TraitAttachedToMeleeWeapon","attached-to-ships-bow":"PF2E.TraitAttachedToShipsBow",bonded:"PF2E.TraitBonded",carried:"PF2E.TraitCarried","each-rune-applied-to-a-separate-item-that-has-pockets":"PF2E.TraitEachRuneAppliedToASeparateItemThatHasPockets","etched-onto-a-weapon":"PF2E.TraitEtchedOntoAWeapon","etched-onto-a-shield":"PF2E.TraitEtchedOntoAShield","etched-onto-armor":"PF2E.TraitEtchedOntoArmor","etched-onto-heavy-armor":"PF2E.TraitEtchedOntoHeavyArmor","etched-onto-light-armor":"PF2E.TraitEtchedOntoLightArmor","etched-onto-metal-armor":"PF2E.TraitEtchedOntoMetalArmor","etched-onto-clan-dagger":"PF2E.TraitEtchedOntoAClanDagger","etched-onto-lm-nonmetal-armor":"PF2E.TraitEtchedOntoLightMedNMArmor","etched-onto-med-heavy-armor":"PF2E.TraitEtchedOntoMedHeavyArmor","etched-onto-medium-heavy-metal-armor":"PF2E.TraitEtchedOntoMediumHeavyMetalArmor","etched-onto-bludgeoning-weapon":"PF2E.TraitEtchedOntoABludgeoningWeapon","etched-onto-melee-weapon":"PF2E.TraitEtchedOntoAMeleeWeapon","etched-onto-slashing-melee-weapon":"PF2E.TraitEtchedOntoASlashingMeleeWeapon","etched-onto-piercing-or-slashing-melee-weapon":"PF2E.TraitEtchedOntoAPiercingOrSlashingMeleeWeapon","etched-onto-piercing-or-slashing-weapon":"PF2E.TraitEtchedOntoAPiercingOrSlashingWeapon","etched-onto-weapon-wo-anarchic-rune":"PF2E.TraitEtchedOntoAWeaponWOAxiomaticRune","etched-onto-weapon-wo-axiomatic-rune":"PF2E.TraitEtchedOntoAWeaponWOAnarchicRune","etched-onto-weapon-wo-unholy-rune":"PF2E.TraitEtchedOntoAWeaponWOHolyRune","etched-onto-weapon-wo-holy-rune":"PF2E.TraitEtchedOntoAWeaponWOUnholyRune","etched-onto-melee-weapon-monk":"PF2E.TraitEtchedOntoAMeleeWeaponMonk","etched-onto-thrown-weapon":"PF2E.TraitEtchedOntoAThrownWeapon","held-in-one-hand":"PF2E.TraitHeldOneHand","held-in-one-hand-or-free-standing":"PF2E.TraitHeldOneHandFreeStanding","held-in-1-hand-hung-on-a-cord-or-attached-to-clothing":"PF2E.HeldInOneHandHungOnACordOrAttachedToClothing","held-in-one-or-two-hands":"PF2E.TraitHeldOneTwoHands","held-in-two-hands":"PF2E.TraitHeldTwoHands",implanted:"PF2E.TraitImplanted","mounted-on-a-tripod-or-bracket":"PF2E.TraitMountedOnATripodOrBracket",other:"PF2E.TraitOther","sewn-into-clothing":"PF2E.TraitSewnIntoClothing","tattooed-on-the-body":"PF2E.TraitTattooedOnTheBody",touched:"PF2E.TraitTouched",worn:"PF2E.TraitWorn",wornamulet:"PF2E.TraitWornAmulet",wornanklets:"PF2E.TraitWornAnklets",wornarmbands:"PF2E.TraitWornArmbands",wornbackpack:"PF2E.TraitWornBackpack",wornbarding:"PF2E.TraitWornBarding",wornbelt:"PF2E.TraitWornBelt",wornbeltpouch:"PF2E.TraitWornBeltPouch",wornboots:"PF2E.TraitWornBoots",wornbracelet:"PF2E.TraitWornBracelet",wornbracers:"PF2E.TraitWornBracers",worncap:"PF2E.TraitWornCap",worncape:"PF2E.TraitWornCape",worncirclet:"PF2E.TraitWornCirclet",worncloak:"PF2E.TraitWornCloak",wornclothing:"PF2E.TraitWornClothing",worncollar:"PF2E.TraitWornCollar",worncrown:"PF2E.TraitWornCrown",wornepaulet:"PF2E.TraitWornEpaulet",worneyeglasses:"PF2E.TraitWornEyeglasses",worneyepiece:"PF2E.TraitWornEyepiece",wornfootwear:"PF2E.TraitWornFootwear",worngarment:"PF2E.TraitWornGarment",worngloves:"PF2E.TraitWornGloves",wornheadwear:"PF2E.TraitWornHeadwear",wornhorseshoes:"PF2E.TraitWornHorseshoes",wornmask:"PF2E.TraitWornMask",wornnecklace:"PF2E.TraitWornNecklace",wornonbelt:"PF2E.TraitWornOnBelt",wornoronehand:"PF2E.TraitWornOrOneHand",wornring:"PF2E.TraitWornRing",wornsaddle:"PF2E.TraitWornSaddle",wornsandles:"PF2E.TraitWornSandles",wornshoes:"PF2E.TraitWornShoes",wornwrist:"PF2E.TraitWornOnWrists","worn-and-attached-to-two-weapons":"PF2E.TraitWornAndAttachedToTwoWeapons","worn-under-armor":"PF2E.TraitWornUnderArmor"};class ArmorPF2e extends PhysicalItemPF2e{static{__name(this,"ArmorPF2e")}static{__name2(this,"ArmorPF2e")}static get validTraits(){return CONFIG.PF2E.armorTraits}get isBarding(){return["light-barding","heavy-barding"].includes(this.category)}get baseType(){return this.system.baseItem??null}get group(){return this.system.group||null}get category(){return this.system.category}get dexCap(){return this.system.dexCap}get strength(){return this.system.strength}get checkPenalty(){return this.system.checkPenalty||0}get speedPenalty(){return this.system.speedPenalty||0}get acBonus(){return this.system.acBonus}get isSpecific(){return!!this.system.specific}getRollOptions(prefix=this.type,options){const rollOptions=super.getRollOptions(prefix,options);return rollOptions.push(...Object.entries({[`category:${this.category}`]:!0,[`group:${this.group??"none"}`]:!0,[`base:${this.baseType}`]:!!this.baseType,[`strength:${this.system.strength}`]:typeof this.system.strength=="number","rune:potency":this.system.runes.potency>0,"rune:resilient":this.system.runes.resilient>0}).filter(e2=>!!e2[1]).map(e2=>`${prefix}:${e2[0]}`),...this.system.runes.property.map(r2=>`${prefix}:rune:property:${sluggify(r2)}`)),rollOptions}acceptsSubitem(candidate){if(candidate===this)return!1;const usage=candidate.system.usage;return!!(this.system.grade&&usage.type==="installed"&&usage.value in ARMOR_UPGRADES)}isStackableWith(item){return this.isEquipped||item.isEquipped?!1:super.isStackableWith(item)}prepareBaseData(){const systemUsage=this.system;systemUsage.usage={value:"wornarmor"},super.prepareBaseData(),AutomaticBonusProgression$1.cleanupRunes(this);const maxPropertySlots=getPropertyRuneSlots(this);this.system.runes.property.length=Math.min(this.system.runes.property.length,maxPropertySlots);const abpEnabled=AutomaticBonusProgression$1.isEnabled(this.actor),baseTraits=this.system.traits.value,isSF2e=baseTraits.some(v=>["tech","analog"].includes(v));this.system.grade=isSF2e?this.system.grade??"commercial":null,isSF2e&&(this.system.runes.potency=0,this.system.runes.resilient=0);const investedTrait=this.system.runes.potency||this.system.runes.resilient||abpEnabled&&this.system.runes.property.length>0?"invested":null,hasTraditionTraits=baseTraits.some(t2=>setHasElement(MAGIC_TRADITIONS,t2)),magicTrait=investedTrait&&!hasTraditionTraits?"magical":null;this.system.traits.value=n([...baseTraits,investedTrait,magicTrait]).filter(e$1).sort();const gradeData=CONFIG.PF2E.armorImprovements[this.system.grade??"commercial"];gradeData.resilient&&addOrUpgradeTrait(this.system.traits,`resilient-${gradeData.resilient}`)}prepareDerivedData(){if(super.prepareDerivedData(),!AutomaticBonusProgression$1.isEnabled(this.actor))if(this.system.acBonus=Number(this.system.acBonus),this.system.grade){const improvements=CONFIG.PF2E.armorImprovements,gradeData=improvements[this.system.grade??"commercial"]??improvements.commercial;this.system.acBonus+=gradeData.bonus}else this.system.acBonus+=this.isInvested?this.system.runes.potency:0}prepareActorData(){super.prepareActorData();const actor=this.actor;if(!actor)throw ErrorPF2e("This method may only be called from embedded items");if(this.isEquipped)for(const option of this.getRollOptions("armor"))actor.rollOptions.all[option]=!0}onPrepareSynthetics(){if(super.onPrepareSynthetics(),!this.actor)throw ErrorPF2e("This method may only be called from embedded items");if(!this.isEquipped)return;const rollOptionsAll=this.actor.flags.pf2e.rollOptions.all;for(const option of Object.keys(rollOptionsAll))option.startsWith("armor:")&&delete rollOptionsAll[option];for(const option of this.getRollOptions("armor"))rollOptionsAll[option]=!0}async getChatData(htmlOptions={}){const properties=[CONFIG.PF2E.armorCategories[this.category],`${signedInteger(this.acBonus)} ${game.i18n.localize("PF2E.ArmorArmorLabel")}`,`${this.system.dexCap||0} ${game.i18n.localize("PF2E.ArmorDexLabel")}`,`${this.system.checkPenalty||0} ${game.i18n.localize("PF2E.ArmorCheckLabel")}`,this.speedPenalty?`${this.system.speedPenalty} ${game.i18n.localize("PF2E.ArmorSpeedLabel")}`:null].filter(e$1);return this.processChatData(htmlOptions,{...await super.getChatData(),traits:this.traitChatData(CONFIG.PF2E.armorTraits),properties})}generateUnidentifiedName({typeOnly=!1}={typeOnly:!1}){const base=this.baseType?CONFIG.PF2E.baseArmorTypes[this.baseType]:null,group=this.group?CONFIG.PF2E.armorGroups[this.group]:null,itemType=game.i18n.localize(base??group??"TYPES.Item.armor");return typeOnly?itemType:game.i18n.format("PF2E.identification.UnidentifiedItem",{item:itemType})}async _preUpdate(changed,options,user){if(!changed.system)return super._preUpdate(changed,options,user);try{const result=await checkPhysicalItemSystemChange(this,changed);result==="sf2e"?(changed.system.runes={potency:0,resilient:0,property:[]},changed.system.grade??=this._source.system.grade??"commercial"):result==="pf2e"&&(changed.system.grade=null)}catch{return!1}if(changed.system.acBonus!==void 0){const integerValue=Math.floor(Number(changed.system.acBonus))||0;changed.system.acBonus=Math.max(0,integerValue)}if(changed.system.group!==void 0&&(changed.system.group||=null),changed.system.dexCap!==void 0){const integerValue=Math.floor(Number(changed.system.dexCap))||0;changed.system.dexCap=Math.max(0,integerValue)}if(changed.system.checkPenalty!==void 0){const integerValue=Math.floor(Number(changed.system.checkPenalty))||0;changed.system.checkPenalty=Math.min(0,integerValue)}if(changed.system.speedPenalty!==void 0){const integerValue=Math.floor(Number(changed.system.speedPenalty))||0;changed.system.speedPenalty=Math.min(0,integerValue)}return super._preUpdate(changed,options,user)}}class BookPF2e extends PhysicalItemPF2e{static{__name(this,"BookPF2e")}static{__name2(this,"BookPF2e")}static get validTraits(){return CONFIG.PF2E.equipmentTraits}}const appv1$8=foundry.appv1;class TrickMagicItemPopup{static{__name(this,"TrickMagicItemPopup")}static{__name2(this,"TrickMagicItemPopup")}item;checkDC;#localize=localizer("PF2E.TrickMagicItemPopup");constructor(item){if(!item.isOfType("consumable"))throw ErrorPF2e("Unexpected item used for Trick Magic Item");if(!item.actor?.isOfType("character"))throw ErrorPF2e(this.#localize("InvalidActor"));this.item=item,this.actor=item.actor,this.checkDC=calculateTrickMagicItemCheckDC(item),this.#initialize()}async#initialize(){const buttons=TRICK_MAGIC_SKILLS.filter(skill=>skill in this.checkDC).map(value=>({value,label:game.i18n.localize(CONFIG.PF2E.skills[value].label),modifier:this.actor.skills[value].check.mod})).reduce((accumulated,skill)=>{const button={icon:fontAwesomeIcon("dice-d20").outerHTML,label:`${skill.label} (${skill.modifier<0?"":"+"}${skill.modifier})`,callback:__name2(()=>this.#handleTrickItem(skill.value),"callback")};return{...accumulated,[skill.value]:button}},{});new appv1$8.api.Dialog({title:this.#localize("Title"),content:`<p>${this.#localize("Label")}</p>`,buttons},{classes:["dialog","trick-magic-item"],width:"auto"}).render(!0)}#handleTrickItem(skill){this.actor.skills[skill].check.roll({extraRollOptions:["action:trick-magic-item"],dc:{value:this.checkDC[skill]??0},item:this.item});const trick=new TrickMagicItemEntry(this.actor,skill);this.item.castEmbeddedSpell(trick)}}class ConsumablePF2e extends PhysicalItemPF2e{static{__name(this,"ConsumablePF2e")}static{__name2(this,"ConsumablePF2e")}static get validTraits(){return CONFIG.PF2E.consumableTraits}get otherTags(){return new Set(this.system.traits.otherTags)}get category(){return this.system.category}get uses(){return t$3(this.system.uses,["value","max"])}get embeddedSpell(){if(!this.actor)throw ErrorPF2e(`No owning actor found for "${this.name}" (${this.id})`);if(this._embeddedSpell!==void 0)return this._embeddedSpell;if(!this.system.spell)return this._embeddedSpell=null,null;try{const spellSource=foundry.utils.mergeObject(this.system.spell,{"system.location.value":null},{inplace:!1}),context={parent:this.actor,parentItem:this},spell=new ItemProxyPF2e(spellSource,context);return performLatePreparation(spell),this._embeddedSpell=spell,spell}catch(ex){return this._embeddedSpell=null,console.error(ex),null}}prepareBaseData(){super.prepareBaseData(),this._embeddedSpell=void 0,this.system.uses.max||=1}async getChatData(htmlOptions={},rollOptions={}){const traits=this.traitChatData(CONFIG.PF2E.consumableTraits),[category,isUsableItemType]=this.isIdentified?[game.i18n.localize(CONFIG.PF2E.consumableCategories[this.category]),!0]:[this.generateUnidentifiedName({typeOnly:!0}),!["other","scroll","talisman","toolkit","wand"].includes(this.category)],usesLabel=game.i18n.localize("PF2E.Item.Consumable.Uses.Label"),fromFormula=!!rollOptions.fromFormula;return this.processChatData(htmlOptions,{...await super.getChatData(),traits,properties:this.isIdentified&&this.uses.max>1?[`${this.uses.value}/${this.uses.max} ${usesLabel}`]:[],category,isUsable:isUsableItemType&&!fromFormula&&this.parent&&this.parent.items.get(this.id)})}generateUnidentifiedName({typeOnly=!1}={typeOnly:!1}){const liquidOrSubstance=__name2(()=>this.traits.has("inhaled")||this.traits.has("contact")?"PF2E.identification.UnidentifiedType.Substance":"PF2E.identification.UnidentifiedType.Liquid","liquidOrSubstance"),itemType=game.i18n.localize(["drug","elixir","mutagen","oil","poison","potion"].includes(this.category)?liquidOrSubstance():["scroll","snare"].includes(this.category)?CONFIG.PF2E.consumableCategories[this.category]:"PF2E.identification.UnidentifiedType.Object");return typeOnly?itemType:game.i18n.format("PF2E.identification.UnidentifiedItem",{item:itemType})}getRollOptions(prefix=this.type,options){return[...super.getRollOptions(prefix,options),...Object.entries({[`category:${this.category}`]:!0}).filter(([,isTrue])=>isTrue).map(([key])=>`${prefix}:${key}`)]}async consume(thisMany=1){const actor=this.actor;if(!actor)return;const uses=this.uses;if(["scroll","wand"].includes(this.category)&&this.system.spell)if(actor.spellcasting?.canCastConsumable(this))this.castEmbeddedSpell();else if(actor.itemTypes.feat.some(feat=>feat.slug==="trick-magic-item"))new TrickMagicItemPopup(this);else{const formatParams={actor:actor.name,spell:this.name},message=game.i18n.format("PF2E.LackCastConsumableCapability",formatParams);ui.notifications.warn(message);return}else{const key=uses.max>=thisMany&&uses.value===thisMany&&uses.max>1?"UseExhausted":uses.max>thisMany?"UseMulti":"UseSingle",content=game.i18n.format(`PF2E.ConsumableMessage.${key}`,{name:this.name,current:uses.value-thisMany}),flags={pf2e:{origin:{sourceId:this.sourceId,uuid:this.uuid,type:this.type}}},speaker=ChatMessage.getSpeaker({actor});if(this.system.damage){const{formula,type:type2,kind}=this.system.damage;new DamageRoll(`(${formula})[${type2},${kind}]`,this.getRollData()).toMessage({speaker,flavor:content,flags})}else ChatMessage.create({speaker,content,flags})}if(this.system.uses.autoDestroy&&uses.value<=thisMany){const newQuantity=Math.max(this.quantity-(uses.max>1?1:thisMany),0);newQuantity<=0?await this.delete():await this.update({"system.quantity":newQuantity,"system.uses.value":uses.max})}else await this.update({"system.uses.value":Math.max(uses.value-thisMany,0)})}async castEmbeddedSpell(trickMagicItemData){const actor=this.actor,spell=this.embeddedSpell;return!actor||!spell?void 0:(trickMagicItemData||(actor.spellcasting?.filter(e2=>!!e2.statistic&&e2.canCast(spell,{origin:this})).reduce((best,e2)=>e2.statistic.dc.value>best.statistic.dc.value?e2:best)??null))?.cast(spell,{consume:!1})}_preUpdate(changed,options,user){if(!changed.system)return super._preUpdate(changed,options,user);if(typeof changed.system.damage?.type=="string"){const category=changed.system.category??this.system.category;setHasElement(DAMAGE_OR_HEALING_CONSUMABLE_CATEGORIES,category)?(setHasElement(DAMAGE_ONLY_CONSUMABLE_CATEGORIES,category)||!["vitality","void","untyped"].includes(changed.system.damage.type))&&(changed.system.damage.kind="damage"):changed.system.damage=null}if(changed.system.uses){if("value"in changed.system.uses){const minimum=this.system.uses.autoDestroy?1:0;changed.system.uses.value=Math.clamp(Math.floor(Number(changed.system.uses.value))||minimum,minimum,9999)}"max"in changed.system.uses&&(changed.system.uses.max=Math.clamp(Math.floor(Number(changed.system.uses.max))||1,1,9999)),typeof changed.system.uses.value=="number"&&typeof changed.system.uses.max=="number"&&(changed.system.uses.value=Math.min(changed.system.uses.value,changed.system.uses.max))}return changed.system.price?.per!==void 0&&(changed.system.price.per=Math.clamp(Math.floor(Number(changed.system.price.per))||1,1,999)),super._preUpdate(changed,options,user)}}class ContainerPF2e extends PhysicalItemPF2e{static{__name(this,"ContainerPF2e")}static{__name2(this,"ContainerPF2e")}static get validTraits(){return CONFIG.PF2E.equipmentTraits}contents=new Collection;get stowsItems(){return this.system.stowing}get isCollapsed(){return this.system.collapsed}get capacity(){return{value:InventoryBulk.computeTotalBulk(this.contents.contents,this.actor??null),max:new Bulk(this.system.bulk.capacity)}}get percentFull(){const{value,max}=this.capacity,realPercent=Math.floor(value.toLightUnits()/max.toLightUnits()*100);return realPercent>100?Math.floor(value.normal/max.normal*100):realPercent}get bulkIgnored(){const isOverfilled=this.percentFull>100,extradimensionalParadox=this.traits.has("extradimensional")&&hasExtraDimensionalParent(this);return!isOverfilled&&!extradimensionalParadox?new Bulk(this.system.bulk.ignored):new Bulk}get bulk(){return super.bulk.plus(this.capacity.value.minus(this.bulkIgnored))}prepareBaseData(){super.prepareBaseData(),this.system.containerId===this.id&&(this.system.containerId=null)}prepareSiblingData(){super.prepareSiblingData(),this.contents=new Collection(this.actor.inventory.filter(i=>i.container?.id===this.id).map(item=>[item.id,item]))}async ejectContents(){if(!this.actor)return;const updates=this.contents.map(i=>({_id:i.id,"system.containerId":this.container?.id??null}));await this.actor.updateEmbeddedDocuments("Item",updates,{render:!1})}isStackableWith(_item){return!1}async getChatData(htmlOptions={}){return this.processChatData(htmlOptions,{...await super.getChatData(),traits:this.traitChatData(CONFIG.PF2E.equipmentTraits)})}_preUpdate(changed,options,user){if(!changed.system?.bulk)return super._preUpdate(changed,options,user);changed.system.bulk.heldOrStowed!==void 0&&(changed.system.bulk.heldOrStowed=Math.clamp(Number(changed.system.bulk.heldOrStowed),0,999)||0,Number.isInteger(changed.system.bulk.heldOrStowed)||(changed.system.bulk.heldOrStowed=.1));for(const property of["capacity","ignored"])changed.system.stowing||(changed.system.bulk[property]=0),changed.system.bulk[property]!==void 0&&(changed.system.bulk[property]=Math.clamp(Math.trunc(Number(changed.system.bulk[property])),0,999)||0);return super._preUpdate(changed,options,user)}}class EquipmentPF2e extends PhysicalItemPF2e{static{__name(this,"EquipmentPF2e")}static{__name2(this,"EquipmentPF2e")}static get validTraits(){return CONFIG.PF2E.equipmentTraits}get isAttachable(){return this.system.usage.type==="installed"}async getChatData(htmlOptions={}){return this.processChatData(htmlOptions,{...await super.getChatData(),traits:this.traitChatData(CONFIG.PF2E.equipmentTraits)})}generateUnidentifiedName({typeOnly=!1}={typeOnly:!1}){const identificationConfig=CONFIG.PF2E.identification,slotType=/book\b/.test(this.slug??"")?"Book":/\bring\b/.test(this.slug??"")?"Ring":this.system.usage.value?.replace(/^worn/,"").capitalize()??"",itemType=objectHasKey(identificationConfig.UnidentifiedType,slotType)?game.i18n.localize(identificationConfig.UnidentifiedType[slotType]):game.i18n.localize(identificationConfig.UnidentifiedType.Object);return typeOnly?itemType:game.i18n.format(identificationConfig.UnidentifiedItem,{item:itemType})}}function setActorShieldData(shield){const actor=shield.actor;if(!(shield.isEquipped&&actor.heldShield===shield)||!actor.isOfType("character","npc"))return;const{attributes}=actor.system;if(![shield.id,null].includes(attributes.shield.itemId))return;const hitPoints=shield.hitPoints;attributes.shield={itemId:shield.id,name:shield.name,ac:shield.acBonus,hp:hitPoints,hardness:shield.hardness,brokenThreshold:hitPoints.brokenThreshold,raised:shield.isRaised,broken:shield.isBroken,destroyed:shield.isDestroyed,icon:shield.img},actor.rollOptions.all["self:shield:equipped"]=!0,shield.isDestroyed?actor.rollOptions.all["self:shield:destroyed"]=!0:shield.isBroken&&(actor.rollOptions.all["self:shield:broken"]=!0)}__name(setActorShieldData,"setActorShieldData"),__name2(setActorShieldData,"setActorShieldData");class ShieldPF2e extends PhysicalItemPF2e{static{__name(this,"ShieldPF2e")}static{__name2(this,"ShieldPF2e")}static get validTraits(){return CONFIG.PF2E.shieldTraits}get baseType(){return this.system.baseItem??null}get isBuckler(){return["buckler","casters-targe","dart-shield","gauntlet-buckler","heavy-rondache","klar"].includes(this.system.baseItem??"")}get isTowerShield(){return["fortress-shield","tower-shield"].includes(this.system.baseItem??"")}get speedPenalty(){return this.system.speedPenalty||0}get acBonus(){return this.system.acBonus}get isSpecific(){return!!this.system.specific}get isRaised(){return!!this.actor?.isOfType("character","npc")&&this.id===this.actor.attributes.shield.itemId&&this.actor.attributes.shield.raised}isStackableWith(item){return this.isEquipped||item.isEquipped?!1:super.isStackableWith(item)}acceptsSubitem(candidate){return candidate.isOfType("weapon")&&candidate.system.traits.value.some(t2=>t2==="attached-to-shield")&&!this.system.traits.integrated&&!this.subitems.some(i=>i.isOfType("weapon"))}getRollOptions(prefix=this.type,options){const reinforcingRune=this.system.runes.reinforcing,reinforcingSlug=[null,"minor","lesser","moderate","greater","major","supreme"][reinforcingRune],reinforcingOptions={[`rune:reinforcing:${reinforcingRune}`]:!!reinforcingRune,[`rune:reinforcing:${reinforcingSlug}`]:!!reinforcingRune},rollOptions=super.getRollOptions(prefix,options);return rollOptions.push(...Object.entries({[`base:${this.baseType}`]:!!this.baseType,...reinforcingOptions}).filter(e2=>!!e2[1]).map(e2=>`${prefix}:${e2[0]}`)),rollOptions}prepareBaseData(){const systemUsage=this.system;systemUsage.usage={value:"held-in-one-hand"},super.prepareBaseData(),"category"in this.system&&(this.type="shield",this.system.runes={reinforcing:0}),this.system.traits.integrated&&(this.system.traits.integrated.runes=foundry.utils.mergeObject({potency:0,striking:0,property:[]},this.system.traits.integrated.runes));const isSF2e=this.system.traits.value.some(v=>["tech","analog"].includes(v));this.system.grade=isSF2e?this.system.grade??"commercial":null,this.system.runes.reinforcing=isSF2e?0:this.system.runes.reinforcing;const materialData=getMaterialValuationData(this),reinforcingRune=this.system.runes.reinforcing,adjustFromUpgrades=__name2((property,base)=>{const fromMaterial=this.isSpecific?Math.max(base,materialData?.[property]??base):materialData?.[property]??base,additionalFromRuneOrGrade=this.system.grade?{increase:CONFIG.PF2E.shieldImprovements[this.system.grade][property],max:1/0}:reinforcingRune?RUNE_DATA.shield.reinforcing[reinforcingRune]?.[property]:null,sumFromRune=fromMaterial+(additionalFromRuneOrGrade?.increase??0);return additionalFromRuneOrGrade&&sumFromRune>additionalFromRuneOrGrade.max?Math.max(fromMaterial,additionalFromRuneOrGrade.max):sumFromRune},"adjustFromUpgrades");this.system.hardness=adjustFromUpgrades("hardness",this.system.hardness),this.system.hp.max=adjustFromUpgrades("maxHP",this.system.hp.max),this.system.hp.brokenThreshold=Math.floor(this.system.hp.max/2);const baseTraits=this.system.traits.value,hasTraditionTraits=baseTraits.some(t2=>setHasElement(MAGIC_TRADITIONS,t2)),magicTrait=this.system.runes.reinforcing>0&&!hasTraditionTraits?"magical":null;this.system.traits.value=n([...baseTraits,magicTrait]).filter(e$1).sort();const integratedTrait=this.system.traits.value.find(t2=>t2.startsWith("integrated"));if(integratedTrait){const isVersatileWeapon=integratedTrait.includes("versatile"),traitParts=integratedTrait.split("-"),damageTypeMap={b:"bludgeoning",p:"piercing",s:"slashing"},mainDamageType=damageTypeMap[traitParts.at(2)??""]??"slashing",versatileDamageType=isVersatileWeapon?damageTypeMap[traitParts.at(-1)??""]:null;this.system.traits.integrated&&versatileDamageType?this.system.traits.integrated.versatile=foundry.utils.mergeObject({options:[mainDamageType,versatileDamageType],selected:mainDamageType},this.system.traits.integrated.versatile??{}):this.system.traits.integrated&&(this.system.traits.integrated.versatile=null),this.system.traits.integrated=foundry.utils.mergeObject({damageType:mainDamageType,runes:{potency:0,striking:0,property:[]},versatile:null},this.system.traits.integrated??{})}else this.system.traits.integrated=null}prepareDerivedData(){super.prepareDerivedData(),this.system.acBonus=this.isBroken||this.isDestroyed?0:this.acBonus}prepareActorData(){super.prepareActorData();const{actor}=this;if(!actor)throw ErrorPF2e("This method may only be called from embedded items");setActorShieldData(this)}onPrepareSynthetics(){super.onPrepareSynthetics(),setActorShieldData(this)}async getChatData(htmlOptions={}){const properties=[`${signedInteger(this.acBonus)} ${game.i18n.localize("PF2E.ArmorArmorLabel")}`,this.speedPenalty?`${this.system.speedPenalty} ${game.i18n.localize("PF2E.ArmorSpeedLabel")}`:null].filter(e$1);return this.processChatData(htmlOptions,{...await super.getChatData(),traits:this.traitChatData(CONFIG.PF2E.shieldTraits),properties})}generateUnidentifiedName({typeOnly=!1}={typeOnly:!1}){const base=this.baseType?CONFIG.PF2E.baseShieldTypes[this.baseType]:null,itemType=game.i18n.localize(base??"TYPES.Item.shield");return typeOnly?itemType:game.i18n.format("PF2E.identification.UnidentifiedItem",{item:itemType})}generateWeapon(){if(this.isStowed)return null;const weaponTraits2=this.system.traits.value.filter(t2=>t2 in CONFIG.PF2E.weaponTraits),shieldThrowTrait=this.system.traits.value.find(t2=>t2.startsWith("shield-throw-"));shieldThrowTrait&&weaponTraits2.push(`thrown-${shieldThrowTrait.slice(-2)}`);const baseData=foundry.utils.deepClone({...t$3(this,["_id","name","img"]),type:"weapon",system:{category:"martial",group:"shield",baseItem:this.baseType,equipped:{...this._source.system.equipped,invested:null},hp:t$3(this.system.hp,["value","max"]),material:n$1(this.material,["effects"]),traits:{rarity:this.rarity,value:weaponTraits2.sort(),otherTags:[]},damage:{dice:1,die:"d4",damageType:"bludgeoning",modifier:0,persistent:null}}});if(this.system.traits.integrated){const damageType=this.system.traits.integrated.damageType,versatileTrait=this.system.traits.value.find(t2=>t2.includes("versatile")),versatileWeaponTrait=versatileTrait?.slice(versatileTrait.indexOf("versatile"))??null;objectHasKey(CONFIG.PF2E.weaponTraits,versatileWeaponTrait)&&(baseData.system.traits.value.push(versatileWeaponTrait),baseData.system.traits.toggles={versatile:{selected:this.system.traits.integrated.versatile?.selected??damageType}});const integratedWeaponRunes=this.system.traits.integrated?.runes,additionalData={system:{damage:{dice:1,die:"d6",damageType,modifier:0,persistent:null},runes:integratedWeaponRunes}};(integratedWeaponRunes?.potency||integratedWeaponRunes?.striking)&&(additionalData.name=this._source.name);const combinedData=foundry.utils.mergeObject(baseData,additionalData);return new ItemProxyPF2e(combinedData,{parent:this.parent,shield:this})}return new ItemProxyPF2e(baseData,{parent:this.parent,shield:this})}async _preUpdate(changed,options,user){if(!changed.system)return super._preUpdate(changed,options,user);try{const result=await checkPhysicalItemSystemChange(this,changed);result==="sf2e"?(changed.system.runes={reinforcing:0},changed.system.grade??=this._source.system.grade??"commercial"):result==="pf2e"&&(changed.system.grade=null)}catch{return!1}if(changed.system.acBonus!==void 0){const integerValue=Math.floor(Number(changed.system.acBonus))||0;changed.system.acBonus=Math.max(0,integerValue)}if(changed.system.speedPenalty!==void 0){const integerValue=Math.floor(Number(changed.system.speedPenalty))||0;changed.system.speedPenalty=Math.min(0,integerValue)}return this._source.system.traits.value.some(t2=>t2.startsWith("integrated-"))&&!!changed.system.traits?.value&&Array.isArray(changed.system.traits.value)&&!changed.system.traits.value.some(t2=>t2.startsWith("integrated-"))&&changed.system?.traits&&(changed.system.traits.integrated=null),super._preUpdate(changed,options,user)}}class TreasurePF2e extends PhysicalItemPF2e{static{__name(this,"TreasurePF2e")}static{__name2(this,"TreasurePF2e")}get isCoinage(){return this.system.category==="coin"}get isCurrency(){return this.isCoinage||this.system.slug==="upb"||this.system.category==="credstick"}get unit(){if(this.system.slug==="upb")return"upb";if(this.system.category==="credstick")return"credits";if(this.isCoinage){const options=COIN_DENOMINATIONS.filter(denomination=>!!this.price.value[denomination]);return options.length===1?options[0]:null}return null}prepareBaseData(){super.prepareBaseData();const unit=this.unit;(unit==="credits"||unit==="upb")&&(this.system.price.value=new Coins({[unit]:Math.ceil(this.price.value.copperValue/10)}))}async getChatData(htmlOptions={}){const traits=this.traitChatData({});return this.processChatData(htmlOptions,{...await super.getChatData(),traits})}_preUpdate(changed,operation,user){if(!changed.system)return super._preUpdate(changed,operation,user);const updatedCategory=changed.system.category??this.system.category,updatedPrice=changed.system.price?.value??this.system.price.value;return updatedCategory==="credstick"&&this.system.category!=="credstick"&&(changed.system.price??={},changed.system.price.value={cp:0,gp:0,pp:0,sp:Math.floor(new Coins(updatedPrice).scale(this.quantity).copperValue/10)}),updatedCategory==="credstick"&&(changed.system.quantity=1),super._preUpdate(changed,operation,user)}}class WeaponTraitToggles{static{__name(this,"WeaponTraitToggles")}static{__name2(this,"WeaponTraitToggles")}parent;constructor(weapon){this.parent=weapon,Object.defineProperty(this,"parent",{enumerable:!1})}get actor(){return this.parent.actor}get doubleBarrel(){const weapon=this.parent,hasTrait=weapon.system.traits.value.includes("double-barrel"),sourceToggles=weapon._source.system.traits.toggles;return{selected:hasTrait&&weapon.isRanged&&!weapon.isThrown&&!!sourceToggles?.doubleBarrel?.selected}}get modular(){const weapon=this.parent,options=this.#resolveOptions("modular"),sourceSelection=weapon._source.system.traits.toggles?.modular?.selected,selected=tupleHasValue(options,sourceSelection)?sourceSelection:options.includes(weapon.system.damage.damageType)?weapon.system.damage.damageType:null;return{options,selected}}get versatile(){const options=this.#resolveOptions("versatile"),sourceSelection=this.parent._source.system.traits.toggles?.versatile?.selected??null,selected=tupleHasValue(options,sourceSelection)?sourceSelection:null;return{options,selected}}#resolveOptions(toggle){const weapon=this.parent,types=weapon.system.traits.value.filter(t2=>t2.startsWith(toggle)).flatMap(trait=>{if(trait==="modular")return["bludgeoning","piercing","slashing"];const damageType=/^versatile-(\w+)$/.exec(trait)?.at(1);switch(damageType){case"b":return"bludgeoning";case"p":return"piercing";case"s":return"slashing";default:return objectHasKey(CONFIG.PF2E.damageTypes,damageType)?damageType:[]}}),allOptions=Array.from(new Set(types));return toggle==="modular"?allOptions:allOptions.filter(t2=>weapon.system.damage.damageType!==t2)}applyChanges(){const weapon=this.parent;if(this.doubleBarrel.selected&&!weapon.flags.pf2e.damageFacesUpgraded){weapon.system.damage.die&&=nextDamageDieSize({upgrade:weapon.system.damage.die});const traits=weapon.system.traits,fatalTrait=traits.value.find(t2=>/^fatal-d\d{1,2}$/.test(t2));if(fatalTrait){const index2=traits.value.indexOf(fatalTrait);traits.value.splice(index2,1,upgradeWeaponTrait(fatalTrait))}}}async update({trait,selected}){const weapon=this.parent,actor=weapon.actor;if(!actor?.isOfType("character"))return!1;const property=trait==="double-barrel"?"doubleBarrel":trait;if(this[property].selected===selected)return!1;const item=actor.items.get(weapon.id);if(item?.isOfType("weapon")&&item===weapon){const value=property==="doubleBarrel"?!!selected:selected;await item.update({[`system.traits.toggles.${property}.selected`]:value})}else item?.isOfType("weapon")&&weapon.altUsageType==="melee"?item.update({[`system.meleeUsage.traitToggles.${trait}`]:selected}):trait==="versatile"&&item?.isOfType("shield")?item.update({"system.traits.integrated.versatile.selected":selected}):trait!=="double-barrel"&&weapon.rule?.toggleTrait({trait,selected});return!0}}class WeaponPF2e extends PhysicalItemPF2e{static{__name(this,"WeaponPF2e")}static{__name2(this,"WeaponPF2e")}static get validTraits(){return CONFIG.PF2E.npcAttackTraits}constructor(data,context={}){super(data,context),context.shield&&(this.shield=context.shield)}altUsageType=null;get isEquipped(){const{category,traits}=this.system;return category==="unarmed"&&!traits.otherTags.includes("handwraps-of-mighty-blows")?!0:super.isEquipped||this.handsHeld===1&&traits.value.some(t2=>/^jousting-d\d{1,2}$/.test(t2))}get isAttachable(){return this.system.quantity>0&&this.system.traits.value.some(t2=>t2.startsWith("attached"))}get baseType(){return this.system.baseItem}get group(){return this.system.group}get category(){return this.system.category}get defaultAttribute(){return this.system.attribute??(this.isRanged?"dex":"str")}get hands(){return{worngloves:"0","held-in-one-hand":"1","held-in-one-plus-hands":"1+","held-in-two-hands":"2"}[this.system.usage.value]??"1"}get maxRange(){return this.system.maxRange??(this.system.range?this.system.range*6:null)}get range(){const rangeIncrement=this.system.range,maxRange=this.system.maxRange;return maxRange?{increment:null,max:maxRange}:rangeIncrement?{increment:rangeIncrement,max:rangeIncrement*6}:null}get reload(){return this.system.reload.value||null}get isSpecific(){return!!this.system.specific}get isMelee(){return!this.isRanged}get isRanged(){return!!this.system.range}get isThrown(){const isThrownBaseType=tupleHasValue(CONFIG.PF2E.thrownBaseWeapons,this.baseType);return this.isRanged&&(isThrownBaseType||this.system.traits.value.includes("thrown"))}get isThrowable(){return this.isThrown||this.system.traits.value.some(t2=>t2.startsWith("thrown"))||!!this.system.meleeUsage?.traits.some(t2=>t2.startsWith("thrown"))}get isOversized(){return this.category!=="unarmed"&&!!this.parent?.system.traits?.size?.isSmallerThan(this.size,{smallIsMedium:!0})}get baseDamage(){return{...foundry.utils.deepClone(this.system.damage),damageType:this.system.traits.toggles.versatile.selected??this.system.traits.toggles.modular.selected??this.system.damage.damageType}}get dealsDamage(){const baseDamage=this.baseDamage;return baseDamage.dice>0||baseDamage.modifier>0||this.system.splashDamage.value>0||!!baseDamage.persistent?.number}get ammo(){if(!this.system.ammo)return null;if(!(this.reload!=="0"||this.system.traits.value.includes("repeating"))){const ammo=this.actor?.items.get(this.system.selectedAmmoId??"");return ammo?.isOfType("ammo","weapon")?ammo:null}const ammoItems=this.subitems.filter(i=>i.isOfType("ammo","weapon")&&i.isAmmoFor(this));return t(ammoItems,i=>i.sort).at(0)??null}get otherTags(){return new Set(this.system.traits.otherTags)}acceptsSubitem(candidate){if(candidate===this)return!1;if(candidate.isOfType("ammo","weapon")&&candidate.isAmmoFor(this)&&this.system.ammo?.capacity)return!0;if(candidate.isOfType("weapon"))return candidate.system.traits.value.some(t2=>t2==="attached-to-crossbow-or-firearm")&&["crossbow","firearm"].includes(this.group??"")&&!this.isAttachable&&!this.system.traits.value.includes("combination")&&!this.subitems.some(i=>i.isOfType("weapon"));const usage=candidate.system.usage;return!!(this.system.grade&&usage.type==="installed"&&usage.value in WEAPON_UPGRADES)}isStackableWith(item){if(this.category==="unarmed"||!item.isOfType("weapon")||item.category==="unarmed")return!1;const equippedButStackable=["bomb","dart"].includes(this.group??"");return(this.isEquipped||item.isEquipped)&&!equippedButStackable?!1:super.isStackableWith(item)}isAmmoFor(weapon){return this.system.usage.canBeAmmo&&!!weapon.system.ammo&&weapon.system.ammo?.baseType===this.baseType}getRollOptions(prefix=this.type,options){const{actor,baseDamage}=this,damage={category:DamageCategorization.fromDamageType(baseDamage.damageType),type:baseDamage.damageType,dice:{number:baseDamage.die?baseDamage.dice:0,faces:Number(baseDamage.die?.replace(/^d/,""))}},isDeityFavored=!!(this.baseType&&actor?.isOfType("character")&&actor.deity?.favoredWeapons.includes(this.baseType)),thrownMelee=this.isThrown&&this.altUsageType==="thrown",baseTypeRollOptions=(()=>{const equivalentBases=CONFIG.PF2E.equivalentWeapons;return[this.baseType??[],equivalentBases[this.baseType??""]??[]].flat().reduce((types,t2)=>({...types,[`base:${t2}`]:!0}),{})})(),{persistent}=this.system.damage,propertyRunes=t$9(this.system.runes.property,p=>[`rune:property:${sluggify(p)}`,!0]),ammunitionRollOptions=(ammunition=>{const rollOptions2={};if(ammunition){rollOptions2[`ammo:id:${ammunition.id}`]=!0,rollOptions2[`ammo:slug:${ammunition.slug}`]=!0,rollOptions2[`ammo:level:${ammunition.level}`]=!0,rollOptions2[`ammo:material:type:${ammunition.material.type}`]=!!ammunition.material.type,rollOptions2[`ammo:material:grade:${ammunition.material.grade}`]=!!ammunition.material.grade;for(const trait of ammunition.traits)rollOptions2[`ammo:trait:${trait}`]=!0}return rollOptions2})(this.ammo),bulk=(()=>{const unitBulk=this.bulk.times(1/this.quantity);return unitBulk.isNegligible?"negligible":unitBulk.isLight?"light":unitBulk.toString()})(),rangeIncrement=this.range?.increment,rollOptions=super.getRollOptions(prefix,options);if(rollOptions.push(...Object.entries({[`category:${this.category}`]:!0,[`group:${this.group??"none"}`]:!0,...baseTypeRollOptions,[`base:${this.baseType}`]:!!this.baseType,[`bulk:${bulk}`]:!0,[`usage:hands:${this.hands}`]:this.hands!=="0",[`range-increment:${rangeIncrement}`]:!!rangeIncrement,[`reload:${this.reload}`]:!!this.reload,[`damage:type:${damage.type}`]:!0,[`damage:category:${damage.category}`]:!!damage.category,[`damage:die:number:${damage.dice.number}`]:!!damage.dice.faces,[`damage:die:faces:${damage.dice.faces}`]:!!damage.dice.faces,[`damage-dice:${damage.dice.number}`]:!!damage.dice.faces,[`damage:persistent:${persistent?.type}`]:!!persistent,"deity-favored":isDeityFavored,oversized:this.isOversized,melee:this.isMelee,ranged:this.isRanged,thrown:this.isThrown,"thrown-melee":thrownMelee,...propertyRunes,...ammunitionRollOptions}).filter(e2=>!!e2[1]).map(e2=>`${prefix}:${e2[0]}`)),this.comboSibling){const usagePrefix=this.comboSibling.isRanged?"ranged-usage":"melee-usage";rollOptions.push(...this.comboSibling.getRollOptions(`${prefix}:${usagePrefix}`))}return rollOptions}prepareBaseData(){super.prepareBaseData(),this.system.category||="simple",this.system.group||=null,this.system.baseItem||=null,this.system.splashDamage.value||=0,this.system.graspingAppendage=["fist","claw"].includes(this.baseType??"")?!0:this.category==="unarmed"?!!this.system.graspingAppendage:!1,this.system.attribute&&!ATTRIBUTE_ABBREVIATIONS.has(this.system.attribute)&&(this.system.attribute=null);const reloadValue=this.system.reload.value||=null;this.system.reload.label=reloadValue?game.i18n.format("PF2E.Item.Weapon.Reload.LabelN",{value:CONFIG.PF2E.weaponReload[reloadValue]}):null,this.system.selectedAmmoId||=null,this.system.damage.die||=null,this.system.damage.modifier??=0,!this.system.damage.die&&this.system.damage.dice>0&&(this.system.damage.modifier||=this.system.damage.dice),this.isThrown&&!tupleHasValue(["-","0"],this.system.reload.value)&&(this.system.reload.value="-");const traits=this.system.traits;this.system.category==="unarmed"&&!traits.value.includes("unarmed")&&traits.value.push("unarmed"),this.system.slug==="handwraps-of-mighty-blows"&&!traits.otherTags.includes("handwraps-of-mighty-blows")&&traits.otherTags.push("handwraps-of-mighty-blows");const mandatoryRanged=this.system.group&&MANDATORY_RANGED_GROUPS.has(this.system.group)||["combination","thrown"].some(t2=>traits.value.includes(t2));mandatoryRanged&&(this.system.range??=10),this.system.meleeUsage&&(this.system.meleeUsage.traits??=[],this.system.meleeUsage.traitToggles??={modular:null,versatile:null}),this.system.traits.toggles=new WeaponTraitToggles(this),!mandatoryRanged&&traits.value.some(t2=>/^thrown-{1,3}$/.test(t2))&&(this.system.range=null),this.isMelee?traits.value=traits.value.filter(t2=>!RANGED_ONLY_TRAITS.has(t2)&&!t2.startsWith("volley")):traits.value=traits.value.filter(t2=>!MELEE_ONLY_TRAITS.has(t2)&&!t2.startsWith("thrown-")),this.system.usage.canBeAmmo=this._source.system.usage.canBeAmmo??!1,this.flags.pf2e.comboMeleeUsage??=!1,this.flags.pf2e.damageFacesUpgraded=!1,AutomaticBonusProgression$1.cleanupRunes(this);const runes=this.system.runes;runes.effects=[],Array.isArray(runes.property)||(runes.property=[],this._source.system.runes.property=[]),runes.property.length=Math.min(runes.property.length,getPropertyRuneSlots(this)),this.prepareTraits();const actor=this.actor,inherentDiceNumber=this.system.damage.die?this._source.system.damage.dice:0,strikingDice=AutomaticBonusProgression$1.isEnabled(actor)?AutomaticBonusProgression$1.getStrikingDice(actor?.level??0):this.system.runes.striking,gradeData=CONFIG.PF2E.weaponImprovements[this.system.grade??"commercial"];if(this.system.damage.dice=inherentDiceNumber===1&&!this.flags.pf2e.battleForm?Math.max(gradeData.dice,inherentDiceNumber+strikingDice):this.system.damage.dice,this.system.usage.canBeAmmo&&!this.isThrowable&&(this.system.usage.canBeAmmo=!1),this.isRanged&&!this.isThrown&&this.reload!==null){const isRepeating=this.system.traits.value.includes("repeating"),minExpend=this.system.traits.toggles.doubleBarrel.selected?2:1;this.system.expend=Math.max(minExpend,this.system.expend??1);const existingBaseType=this.system.ammo?.baseType,existingTypeData=objectHasKey(CONFIG.PF2E.ammoTypes,existingBaseType)?CONFIG.PF2E.ammoTypes[existingBaseType]:null;if(isRepeating?this.system.ammo={builtIn:!1,baseType:existingBaseType&&existingTypeData?.parent==="magazine"?existingBaseType:"magazine",capacity:1}:this.system.ammo={builtIn:!1,capacity:null,...this.system.ammo??{},baseType:existingBaseType??null},!existingTypeData?.magazine){const capacityTrait=this.system.traits.value.find(t2=>/^capacity-\d+$/.test(t2)),capacityFromTrait=capacityTrait?Number(capacityTrait.replace("capacity-","")):null,capacityFromDoubleBarrel=this.system.traits.value.includes("double-barrel")?2:null,requiresReload=this.reload!=="0"||isRepeating;this.system.ammo.capacity=capacityFromTrait??capacityFromDoubleBarrel??(requiresReload?this.system.ammo.capacity??1:null)}}else this.system.ammo=null,this.system.expend=null}prepareTraits(){const{traits,runes}=this.system,gradeData=CONFIG.PF2E.weaponImprovements[this.system.grade??"commercial"],isSF2e=traits.value.some(v=>["tech","analog"].includes(v));isSF2e||(this.system.grade=null),this.system.grade=isSF2e?this.system.grade??"commercial":null,(traits.value.includes("tech")||traits.value.includes("consumable"))&&(runes.potency=runes.striking=0);const magicTrait=(runes.potency>0||runes.striking>0||runes.property.length>0)&&!traits.value.some(t2=>t2==="magical"||setHasElement(MAGIC_TRADITIONS,t2))?"magical":null;magicTrait&&traits.value.push(magicTrait),gradeData.tracking&&addOrUpgradeTrait(traits,`tracking-${gradeData.tracking}`);const highestTracking=traits.config.tracking||0;traits.value=n(traits.value).sort(),this.flags.pf2e.attackItemBonus=Math.max(runes.potency,highestTracking,this.system.bonus.value,0)}prepareSiblingData(){super.prepareSiblingData();const ammoRules=this.ammo?.system.rules.map(r2=>({label:this.ammo?.name,...foundry.utils.deepClone(r2)}))??[];this.system.rules.push(...ammoRules)}onPrepareSynthetics(){super.onPrepareSynthetics(),this.system.traits.toggles.applyChanges(),processTwoHandTrait(this)}async getChatData(htmlOptions={}){const traits=this.traitChatData(CONFIG.PF2E.weaponTraits),chatData=await super.getChatData(),rangeLabel=createActionRangeLabel(this.range),properties=[CONFIG.PF2E.weaponCategories[this.category],this.system.reload.label,rangeLabel].filter(e$1);return this.processChatData(htmlOptions,{...chatData,traits,properties})}getMystifiedData(status,{source:source2=!1}={}){const mystifiedData=super.getMystifiedData(status);return source2&&(mystifiedData.name=this._source.name),mystifiedData}generateUnidentifiedName({typeOnly=!1}={typeOnly:!1}){const baseWeaponTypes2=CONFIG.PF2E.baseWeaponTypes,baseShieldTypes2=CONFIG.PF2E.baseShieldTypes,base=this.baseType?baseWeaponTypes2[this.baseType]??baseShieldTypes2[this.baseType]??null:null,group=this.group?CONFIG.PF2E.weaponGroups[this.group]:null,itemType=game.i18n.localize(base??group??"TYPES.Item.weapon");return typeOnly?itemType:game.i18n.format("PF2E.identification.UnidentifiedItem",{item:itemType})}getAltUsages({recurse=!0}={}){const meleeUsage=this.toMeleeUsage(),altUsages=[this.toThrownUsage()??[],meleeUsage??[],recurse?meleeUsage?.toThrownUsage()??[]:[]].flat();for(const weapon of altUsages)performLatePreparation(weapon);return altUsages}clone(data,context){const clone=super.clone(data,context);if(context?.altUsage&&clone instanceof WeaponPF2e){clone.altUsageType=context.altUsage;const comboSibling=this.system.traits.value.includes("combination")?this:this.comboSibling;comboSibling&&(clone.comboSibling=comboSibling)}return clone}toThrownUsage(){const traits=this._source.system.traits.value,thrownTrait=traits.find(t2=>/^thrown-\d{1,3}$/.test(t2));if(this.isRanged||!thrownTrait)return null;const range=Number(/(\d{1,3})$/.exec(thrownTrait)?.at(1)),newTraits=foundry.utils.deepClone(traits);newTraits.splice(newTraits.indexOf(thrownTrait),1,"thrown");const overlay={system:{range,traits:{value:newTraits}}};return this.clone(overlay,{keepId:!0,altUsage:"thrown"})}toMeleeUsage(){const meleeUsage=this.system.meleeUsage;if(!meleeUsage||this.flags.pf2e.comboMeleeUsage)return null;const traitToggles={module:{selected:meleeUsage.traitToggles.modular},versatile:{selected:meleeUsage.traitToggles.versatile}},overlay={system:{damage:{damageType:meleeUsage.damage.type,dice:1,die:meleeUsage.damage.die},group:meleeUsage.group,range:null,reload:{value:null},traits:{value:[...meleeUsage.traits],toggles:traitToggles},selectedAmmoId:null},flags:{pf2e:{comboMeleeUsage:!0}}};return this.clone(overlay,{keepId:!0,altUsage:"melee"})}toNPCAttacks({keepId=!1}={}){const actor=this.actor;if(!actor.isOfType("npc"))throw ErrorPF2e("Melee items can only be generated for NPCs");const baseDamage=(()=>{const weaponDamage=this.baseDamage,ability=this.range?.increment&&!this.isThrown?"dex":"str",actorLevel=actor.system.details.level.base,dice=this.flags.pf2e.fixedAttack?weaponDamage.dice:[1,2,3,4].reduce((closest,dice2)=>Math.abs(dice2-Math.round((actorLevel+2)/4))<Math.abs(closest-Math.round((actorLevel+2)/4))?dice2:closest),constant=(()=>{const fromAbility=actor.abilities[ability].mod,totalModifier=this.flags.pf2e.fixedAttack?weaponDamage.modifier:fromAbility+(actor.level>1?dice:0),sign=totalModifier<0?"-":"+";return totalModifier===0?"":[sign,Math.abs(totalModifier)].join("")})();return{damage:weaponDamage.die?`${dice}${weaponDamage.die}${constant}`:dice.toString(),damageType:weaponDamage.damageType,category:null}})(),fromPropertyRunes=this.system.runes.property.flatMap(r2=>RUNE_DATA.weapon.property[r2].damage?.additional??[]).map(additional=>{const[category=null,damage]="diceNumber"in additional?[additional.category,`${additional.diceNumber}${additional.dieSize}`]:[additional.damageCategory,additional.modifier.toString()],damageType=additional.damageType??baseDamage.damageType;return{damage,damageType,category}}),reachTraitToNPCReach={tiny:null,sm:"reach-10",med:"reach-10",lg:"reach-15",huge:"reach-20",grg:"reach-25"},toAttackTraits=__name2(traits=>{const range=this.range,newTraits2=traits.flatMap(t2=>t2==="reach"?reachTraitToNPCReach[this.size]??[]:t2==="thrown"&&setHasElement(THROWN_RANGES,range?.increment)?`thrown-${range.increment}`:t2).filter(t2=>(["holy","unholy","tech"].includes(t2)||!!this.rule||!(t2 in CONFIG.PF2E.creatureTraits))&&!(t2.startsWith("thrown")&&!this.isThrown)&&!(["grapple","finesse","shove","trip"].includes(t2)&&this.isRanged)&&!(t2==="brutal"&&this.isMelee)&&!(t2==="combination"&&(this.isMelee||this.isThrown))&&!(t2==="critical-fusion"&&this.isThrown)&&!["artifact","cursed"].includes(t2));traits.some(t2=>setHasElement(MAGIC_TRADITIONS,t2))&&newTraits2.push("magical");const sizeToReach=SIZE_TO_REACH[actor.size];this.isMelee&&sizeToReach!==5&&!newTraits2.some(t2=>t2.startsWith("reach"))&&newTraits2.push(`reach-${sizeToReach}`);const reloadTrait=`reload-${this.reload}`;return objectHasKey(CONFIG.PF2E.npcAttackTraits,reloadTrait)&&newTraits2.push(reloadTrait),n(newTraits2).sort()},"toAttackTraits"),persistentDamage=(()=>{const{persistent}=this.system.damage;return persistent?{damage:persistent.faces?`${persistent.number}d${persistent.faces}`:persistent.number.toString(),damageType:persistent.type,category:"persistent"}:[]})(),splashDamage=this.system.splashDamage.value?{damage:this.system.splashDamage.value.toString(),damageType:this.system.damage.damageType,category:"splash"}:[],newTraits=toAttackTraits(this.system.traits.value),isThrown=newTraits.some(t2=>t2.startsWith("thrown-")),rangeData={increment:this._source.system.range,max:this._source.system.maxRange},source2={_id:keepId?this.id:null,name:this._source.name,type:"melee",system:{slug:this.slug??sluggify(this._source.name),bonus:{value:this.flags.pf2e.fixedAttack||Math.round(1.5*this.actor.level+7)},damageRolls:[baseDamage,splashDamage,fromPropertyRunes,persistentDamage].flat().reduce((rolls,roll)=>foundry.utils.mergeObject(rolls,{[foundry.utils.randomID()]:roll}),{}),traits:{value:newTraits},rules:foundry.utils.deepClone(this._source.system.rules),range:!isThrown&&(rangeData.increment||rangeData.max)?rangeData:null},flags:{pf2e:{linkedWeapon:this.id}}},attack=new ItemProxyPF2e(source2,{parent:this.actor});return attack.category=this.category,attack.group=this.group,attack.baseType=this.baseType,[attack,...this.getAltUsages({recurse:!1}).flatMap(u=>u.toNPCAttacks())]}async consumeAmmo(){const ammo=this.ammo;if(this.system.expend&&ammo?.isOfType("ammo"))return ammo.consume(this.system.expend);if(ammo?.isOfType("weapon")){if(!ammo.system.usage.canBeAmmo)throw ErrorPF2e("attempted to consume weapon not usable as ammunition");await ammo.update({"system.quantity":Math.max(ammo.quantity-1,0)})}}async _preUpdate(changed,options,user){if(!changed.system)return super._preUpdate(changed,options,user);const traits=changed.system.traits??{};Array.isArray(traits.value)&&(traits.value=traits.value.filter(t2=>t2 in CONFIG.PF2E.weaponTraits));try{const result=await checkPhysicalItemSystemChange(this,changed);result==="sf2e"?(changed.system.runes={potency:0,striking:0,property:[]},changed.system.grade??=this._source.system.grade??"commercial"):result==="pf2e"&&(changed.system.grade=null)}catch{return!1}for(const key of["group","range","selectedAmmoId"])changed.system[key]!==void 0&&(changed.system[key]||=null);changed.system.damage&&(changed.system.damage.dice!==void 0&&(changed.system.damage.dice=Math.clamp(Number(changed.system.damage.dice)||0,0,14)),changed.system.damage.die!==void 0&&(changed.system.damage.die||=null));const reload=changed.system.reload?.value??this._source.system.reload.value,isThrown=(traits?.value??this._source.system.traits.value)?.includes("thrown");return(setHasElement(MANDATORY_RANGED_GROUPS,changed.system.group??this.system.group)||!!("range"in changed.system?changed.system.range:this._source.system.range))&&!isThrown&&reload!==null?(changed.system.ammo={builtIn:!1,baseType:t$f(CONFIG.PF2E.ammoTypes).find(([_,v])=>v.weapon===this.baseType)?.[0]??null,...this._source.system.ammo??{},...changed.system.ammo},changed.system.ammo.builtIn&&(changed.system.ammo.baseType=null),changed.system.expend=Math.max(1,changed.system.expend??this._source.system.expend??1)):(changed.system.ammo=null,changed.system.expend=null),super._preUpdate(changed,options,user)}_onDelete(options,userId){if(super._onDelete(options,userId),game.user.id===userId){const updates=this.actor?.itemTypes.melee.filter(a=>a.flags.pf2e.linkedWeapon===this.id).map(a=>({_id:a.id,"flags.pf2e.-=linkedWeapon":null}))??[];this.actor?.updateEmbeddedDocuments("Item",updates)}}}class AncestryPF2e extends ABCItemPF2e{static{__name(this,"AncestryPF2e")}static{__name2(this,"AncestryPF2e")}static get validTraits(){return CONFIG.PF2E.creatureTraits}get traits(){return new Set(this.system.traits.value)}get hitPoints(){return this.system.hp}get speed(){return this.system.speed}get size(){return this.system.size}get lockedBoosts(){return Object.values(this.system.boosts).filter(b=>b.value.length===1).flatMap(b=>b.selected??[])}get lockedFlaws(){return Object.values(this.system.flaws).flatMap(f=>f.selected??[])}getLinkedItems(){return this.actor?Array.from(new Set([...super.getLinkedItems(),...this.actor.itemTypes.feat.filter(f=>f.category==="ancestryfeature")])):[]}prepareBaseData(){super.prepareBaseData();for(const boost of Object.values(this.system.boosts))boost.value.length===1&&(boost.selected=boost.value[0]);for(const flaw of Object.values(this.system.flaws))flaw.value.length===1&&(flaw.selected=flaw.value[0])}prepareActorData(){const actor=this.actor;if(!actor.isOfType("character")){console.error("PF2e System | Only a character can have an ancestry");return}actor.ancestry=this,actor.system.attributes.ancestryhp=this.hitPoints,this.logAutoChange("system.attributes.ancestryhp",this.hitPoints),actor.system.traits.size=new ActorSizePF2e({value:this.size}),this.logAutoChange("system.traits.size.value",this.size),actor.system.hands.max.value=this.system.hands;const reach=SIZE_TO_REACH[this.size];actor.system.attributes.reach={base:reach,manipulate:reach};const speed=actor.system.movement.speeds.land;speed.base=speed.value=this.speed,speed.source=this.name;const actorLevelSpeeds=actor.movement.speeds;actorLevelSpeeds.land={value:speed.base,base:speed.base};const build=actor.system.build;if(this.system.alternateAncestryBoosts)build.attributes.boosts.ancestry.push(...this.system.alternateAncestryBoosts);else for(const target of["boosts","flaws"])for(const ability of Object.values(this.system[target]))ability.selected&&build.attributes[target].ancestry.push(ability.selected);if(this.system.voluntary){const{boost,flaws}=this.system.voluntary;boost&&build.attributes.boosts.ancestry.push(boost),build.attributes.flaws.ancestry.push(...flaws)}build.languages.max+=this.system.additionalLanguages.count;const freeLanguages=this.system.languages.value;for(const language of freeLanguages){const alreadyHasLanguage=build.languages.granted.some(l=>l.slug===language);language in CONFIG.PF2E.languages&&!alreadyHasLanguage&&build.languages.granted.push({slug:language,source:this.name})}const senseData=actor.system.perception.senses,vision=this.system.vision;if(vision!=="normal"&&!senseData.some(s=>s.type===vision)){senseData.push({type:vision,acuity:"precise",range:1/0,source:this.name});const senseRollOptions=actor.rollOptions.sense??={};senseRollOptions[`self:${sluggify(vision)}:from-ancestry`]=!0}actor.system.traits.value.push(...this.traits);const slug=this.slug??sluggify(this.name);actor.system.details.ancestry={name:this.name,trait:slug,adopted:null,versatile:null,countsAs:[slug]},actor.rollOptions.all[`self:ancestry:${slug}`]=!0;for(const trait of this.traits)actor.rollOptions.all[`self:trait:${trait}`]=!0}_preUpdate(changed,options,user){if(!changed.system)return super._preUpdate(changed,options,user);const additionalLanguages=changed.system.additionalLanguages;additionalLanguages?.count!==void 0&&(additionalLanguages.count=Math.floor(Math.clamp(Number(additionalLanguages.count)||0,0,99))),changed.system.hands!==void 0&&(changed.system.hands=Math.floor(Math.clamp(changed.system.hands||0,0,12)/2)*2),changed.system.hp!==void 0&&(changed.system.hp=Math.clamp(Math.floor(changed.system.hp/2)*2,4,12));for(const fieldName of["speed","reach"])changed.system[fieldName]!==void 0&&(changed.system[fieldName]=Math.clamp(Math.ceil(changed.system[fieldName]/5)*5,0,100));return super._preUpdate(changed,options,user)}}class BackgroundPF2e extends ABCItemPF2e{static{__name(this,"BackgroundPF2e")}static{__name2(this,"BackgroundPF2e")}get traits(){return new Set(this.system.traits.value)}prepareSiblingData(){if(Object.keys(this.system.items).length>0)return;const grantedSkillFeat=Object.values(this.flags.pf2e.itemGrants).flatMap(g=>this.actor.items.get(g.id)??[]).find(i=>i.isOfType("feat")&&i.category==="skill");grantedSkillFeat&&(this.system.items.GRANT={uuid:grantedSkillFeat.sourceId??grantedSkillFeat.uuid,img:grantedSkillFeat.img,name:grantedSkillFeat.name,level:1},grantedSkillFeat.system.level.taken=1,grantedSkillFeat.system.location=this.id)}prepareActorData(){if(!this.actor.isOfType("character")){console.error("Only a character can have a background");return}this.actor.background=this;const{build}=this.actor.system,boosts=Object.values(this.system.boosts);for(const boost of boosts)boost.selected&&build.attributes.boosts.background.push(boost.selected);const{trainedSkills}=this.system;for(const key of trainedSkills.value){const skill=this.actor.system.skills[key];skill&&(skill.rank=Math.max(skill.rank,1))}}}class ClassPF2e extends ABCItemPF2e{static{__name(this,"ClassPF2e")}static{__name2(this,"ClassPF2e")}get attacks(){return this.system.attacks}get defenses(){return this.system.defenses}get hpPerLevel(){return this.system.hp}get perception(){return this.system.perception}get savingThrows(){return this.system.savingThrows}get grantedFeatSlots(){const system2=this.system;return{ancestry:n(system2.ancestryFeatLevels.value).sort((a,b)=>a-b),class:n(system2.classFeatLevels.value).sort((a,b)=>a-b),skill:n(system2.skillFeatLevels.value).sort((a,b)=>a-b),general:n(system2.generalFeatLevels.value).sort((a,b)=>a-b)}}getLinkedItems(){const{actor}=this;return actor?Array.from(new Set([...super.getLinkedItems(),...actor.itemTypes.feat.filter(f=>f.category==="classfeature"&&!(f.flags.pf2e.grantedBy&&actor.items.has(f.flags.pf2e.grantedBy.id)))])):[]}async createGrantedItems(options={}){return(await super.createGrantedItems(options)).sort((a,b)=>a.system.level.value-b.system.level.value)}prepareBaseData(){super.prepareBaseData();const{keyAbility}=this.system;keyAbility.selected??=keyAbility.value.length===1?keyAbility.value[0]:null}prepareActorData(){const actor=this.actor;if(!actor.isOfType("character")){console.error("Only a character can have a class");return}actor.class=this;const{attributes,build,details,proficiencies,saves,skills}=actor.system,slug=this.slug??sluggify(this.name);build.attributes.keyOptions=[...this.system.keyAbility.value],build.attributes.boosts.class=this.system.keyAbility.selected,attributes.classhp=this.hpPerLevel,actor.system.perception.rank=Math.max(actor.system.perception.rank,this.perception),this.logAutoChange("system.perception.rank",this.perception),details.keyability.value=(build.attributes.manual?details.keyability.value:build.attributes.boosts.class)??"str";const classDCs=proficiencies.classDCs;classDCs[slug]={label:this.name,rank:1,attribute:details.keyability.value,primary:!0},this.logAutoChange(`system.proficiencies.classDCs.${slug}.rank`,1);const{attacks,defenses}=proficiencies;for(const category of WEAPON_CATEGORIES)attacks[category].rank=Math.max(attacks[category].rank,this.attacks[category]),this.logAutoChange(`system.proficiencies.attacks.${category}.rank`,this.attacks[category]);const nonBarding=Array.from(ARMOR_CATEGORIES).filter(c=>!["light-barding","heavy-barding"].includes(c));for(const category of nonBarding)defenses[category].rank=Math.max(defenses[category].rank,this.defenses[category]),this.logAutoChange(`system.proficiencies.defenses.${category}.rank`,this.defenses[category]);for(const saveType of SAVE_TYPES)saves[saveType].rank=Math.max(saves[saveType].rank,this.savingThrows[saveType]),this.logAutoChange(`system.saves.${saveType}.rank`,this.savingThrows[saveType]);for(const trainedSkill of this.system.trainedSkills.value)objectHasKey(skills,trainedSkill)&&(skills[trainedSkill].rank=Math.max(skills[trainedSkill].rank,1));proficiencies.spellcasting.rank=Math.max(proficiencies.spellcasting.rank,this.system.spellcasting),this.logAutoChange("system.proficiencies.spellcasting.rank",this.system.spellcasting),details.class={name:this.name,trait:slug},this.actor.rollOptions.all[`class:${slug}`]=!0}}class AbilityItemPF2e extends ItemPF2e{static{__name(this,"AbilityItemPF2e")}static{__name2(this,"AbilityItemPF2e")}static get validTraits(){return CONFIG.PF2E.actionTraits}get traits(){return new Set(this.system.traits.value)}get actionCost(){const actionType=this.system.actionType.value||"passive";return actionType==="passive"?null:{type:actionType,value:this.system.actions.value}}get frequency(){return this.system.frequency}prepareBaseData(){super.prepareBaseData(),this.crafting=null}prepareActorData(){if(this.suppressed)return;const actor=this.actor;if(actor?.isOfType("familiar")&&this.system.category==="familiar"){const slug=this.slug??sluggify(this.name);actor.rollOptions.all[`self:ability:${slug}`]=!0}}onPrepareSynthetics(){processSanctification(this)}getRollOptions(prefix=this.type,options){const rollOptions=super.getRollOptions(prefix,options);return(this.frequency||this.system.deathNote)&&rollOptions.push(`${prefix}:frequency:limited`),rollOptions.push(...getActionCostRollOptions(prefix,this)),rollOptions}prepareRuleElements(options){return this.suppressed?[]:super.prepareRuleElements(options)}async getChatData(htmlOptions={}){return this.processChatData(htmlOptions,{...this.system,traits:this.traitChatData()})}async _preCreate(data,options,user){return this.parent||this._source.system.frequency&&this.updateSource({"system.frequency.-=value":null}),super._preCreate(data,options,user)}async _preUpdate(changed,options,user){return normalizeActionChangeData(this,changed),super._preUpdate(changed,options,user)}}const KINGDOM_CATEGORY_DATA={"army-tactic":{behavior:"feat",levelLabel:"PF2E.Kingmaker.Feature.Tactic"},"army-war-action":{behavior:"activity"},"kingdom-feat":{behavior:"feat"},"kingdom-feature":{behavior:"feature"},"kingdom-activity":{behavior:"activity"}},KINGMAKER_CATEGORY_TYPES=Object.keys(KINGDOM_CATEGORY_DATA),KINGMAKER_CATEGORIES=t$9(KINGMAKER_CATEGORY_TYPES,type2=>[type2,`PF2E.Kingmaker.Feature.Categories.${type2}`]);class CampaignFeaturePF2e extends ItemPF2e{static{__name(this,"CampaignFeaturePF2e")}static{__name2(this,"CampaignFeaturePF2e")}granter=null;static get validTraits(){return CONFIG.PF2E.kingmakerTraits}get category(){return this.system.category}get level(){return this.behavior!=="activity"?this.system.level?.value??0:null}get traits(){return new Set(this.system.traits.value)}get actionCost(){const actionType=this.system.actionType.value||"passive";return actionType==="passive"?null:{type:actionType,value:this.system.actions.value}}get frequency(){return this.system.frequency??null}get isAction(){return this.behavior==="activity"}get isFeature(){return this.behavior==="feature"}get isFeat(){return this.behavior==="feat"}prepareBaseData(){super.prepareBaseData();const categoryData=KINGDOM_CATEGORY_DATA[this.category]??Object.values(KINGDOM_CATEGORY_DATA)[0];this.behavior=categoryData.behavior,this.group=null,this.levelLabel=categoryData.levelLabel??(this.isFeat?"PF2E.Item.Feat.LevelLabel":"PF2E.LevelLabel")}prepareActorData(){const prefix=this.isFeature?"feature":this.isFeat?"feat":null;if(prefix){const slug=this.slug??sluggify(this.name);this.actor.rollOptions.all[`${prefix}:${slug}`]=!0}}prepareSiblingData(){const itemGrants=this.flags.pf2e.itemGrants;this.grants=Object.values(itemGrants).flatMap(grant=>{const item=this.actor?.items.get(grant.id);return item?.isOfType("campaignFeature")?(item.granter=this,[item]):[]})}getRollOptions(prefix,options){return prefix??=this.isFeature?"feature":this.isFeat?"feat":"action",[...super.getRollOptions(prefix,options).filter(o=>!o.endsWith("level:0")),`${prefix}:category:${this.category}`,this.isAction?`action:${this.slug}`:null].filter(e$1)}async _preCreate(data,options,user){return this.parent||(this.updateSource({"system.location":null}),this._source.system.frequency&&this.updateSource({"system.frequency.-=value":null})),super._preCreate(data,options,user)}async _preUpdate(changed,options,user){if(typeof changed.system?.location=="string"&&(changed.system.location||=null),normalizeActionChangeData(this,changed),changed.system&&changed.system.category){const system2=changed.system,category=tupleHasValue(KINGMAKER_CATEGORY_TYPES,changed.system.category)?changed.system.category:KINGMAKER_CATEGORY_TYPES[0],level=KINGDOM_CATEGORY_DATA[category].behavior==="activity"?1:system2.level?.value??this.system.level?.value??0;system2.level={value:level}}await super._preUpdate(changed,options,user)}embedHTMLString(config){const list=this.system.prerequisites?.value?.map(item=>item.value).join(", ")??"";return(list?`<p><strong>${game.i18n.localize("PF2E.FeatPrereqLabel")}</strong> ${list}</p>`+(config.hr===!1?"":"<hr>"):"")+this.description}}class DeityPF2e extends ItemPF2e{static{__name(this,"DeityPF2e")}static{__name2(this,"DeityPF2e")}get category(){return this.system.category}get favoredWeapons(){return[...this.system.weapons]}prepareBaseData(){super.prepareBaseData(),this.system.skill??=[],this.system.sanctification?.modal||(this.system.sanctification=null)}prepareActorData(){if(!this.actor.isOfType("character")){this.delete({render:!1});return}this.actor.deity=this;const deities=this.actor.system.details.deities,systemData=this.system;deities.primary={skill:foundry.utils.deepClone(systemData.skill),weapons:foundry.utils.deepClone(systemData.weapons)};for(const domain of this.system.domains.primary){const label=CONFIG.PF2E.deityDomains[domain]?.label;deities.domains[domain]=label??domain;const apocryphaKey=`${domain}-apocryphal`;if(objectHasKey(CONFIG.PF2E.deityDomains,apocryphaKey)){const apocrypha=CONFIG.PF2E.deityDomains[apocryphaKey];deities.domains[apocryphaKey]=apocrypha.label}}const slug=this.slug??sluggify(this.name),prefix="deity:primary",actorRollOptions=this.actor.rollOptions;actorRollOptions.all.deity=!0,actorRollOptions.all[`${prefix}:${slug}`]=!0;const sanctifications=this.getSanctificationRollOptions().map(o=>`${prefix}:${o}`);for(const option of sanctifications)actorRollOptions.all[option]=!0;for(const baseType of this.favoredWeapons)actorRollOptions.all[`${prefix}:favored-weapon:${baseType}`]=!0;for(const font of systemData.font)actorRollOptions.all[`${prefix}:font:${font}`]=!0;actorRollOptions.all[`self:deity:slug:${slug}`]=!0}setFavoredWeaponRank(){if(!this.actor.isOfType("character"))return;const favoredWeaponRank=this.actor.flags.pf2e.favoredWeaponRank;if(favoredWeaponRank>0){const attacks=this.actor.system.proficiencies.attacks,baseWeaponTypes2=CONFIG.PF2E.baseWeaponTypes,baseShieldTypes2=CONFIG.PF2E.baseShieldTypes;for(const baseType of this.favoredWeapons)attacks[`weapon-base-${baseType}`]={label:baseWeaponTypes2[baseType]??baseShieldTypes2[baseType]??baseType,visible:!0,rank:Math.max(Number(attacks[`weapon-base-${baseType}`]?.rank)||0,favoredWeaponRank)}}}getRollOptions(prefix=this.type,options){const sanctifications=this.getSanctificationRollOptions().map(o=>`${prefix}:${o}`);return[...super.getRollOptions(prefix,options),`${prefix}:category:${this.category}`,...sanctifications].sort()}getSanctificationRollOptions(){const{sanctification}=this.system,modal=sanctification?.modal;return sanctification?.modal&&sanctification.what.length>0?sanctification.what.map(s=>`sanctification:${modal}:${s}`):["sanctification:none"]}}function featCanHaveKeyOptions(feat){if(feat.category!=="classfeature"||feat.level!==1||feat.traits.size>1)return!1;const{grantedBy}=feat;return!grantedBy||grantedBy.isOfType("feat")&&grantedBy.category==="classfeature"}__name(featCanHaveKeyOptions,"featCanHaveKeyOptions"),__name2(featCanHaveKeyOptions,"featCanHaveKeyOptions");function suppressFeats(feats){for(const featOrAbility of feats){featOrAbility.suppressed=!0;const allGrants=Object.values(featOrAbility.flags.pf2e.itemGrants).map(g=>featOrAbility.actor?.items.get(g.id)).filter(i=>!!i?.isOfType("action","feat"));suppressFeats(allGrants)}}__name(suppressFeats,"suppressFeats"),__name2(suppressFeats,"suppressFeats");class FeatPF2e extends ItemPF2e{static{__name(this,"FeatPF2e")}static{__name2(this,"FeatPF2e")}static get validTraits(){return CONFIG.PF2E.featTraits}get category(){return this.system.category}get level(){return this.system.level.value}get traits(){return new Set(this.system.traits.value)}get rarity(){return this.system.traits.rarity}get actionCost(){const actionType=this.system.actionType.value||"passive";return actionType==="passive"?null:{type:actionType,value:this.system.actions.value}}get frequency(){return this.system.frequency??null}get isFeature(){return setHasElement(FEATURE_CATEGORIES,this.category)}get isFeat(){return setHasElement(FEAT_CATEGORIES,this.category)}get onlyLevel1(){return this.system.onlyLevel1}get maxTakable(){return this.system.maxTakable}get timesTaken(){const slug=this.slug??sluggify(this.name),matchingFeats=this.actor?.itemTypes.feat.filter(f=>f.category===this.category&&f.slug===slug);return Math.min(matchingFeats?.length??0,this.maxTakable)}prepareBaseData(){super.prepareBaseData(),this.group=null,this.system.level.taken??=null,this.suppressed=!1,this.crafting=null;const traits=this.system.traits.value;this.category==="general"&&!traits.includes("general")&&traits.push("general"),this.category==="skill"&&(traits.includes("skill")||traits.push("skill"),!traits.includes("general")&&!traits.includes("archetype")&&traits.push("general")),traits.includes("dedication")&&(this.system.category="class",traits.includes("archetype")||traits.push("archetype")),this.system.traits.value.includes("lineage")&&(this.system.onlyLevel1=!0),this.system.onlyLevel1&&(this.system.maxTakable=1),this.system.actionType.value==="passive"&&(this.system.selfEffect=null)}prepareActorData(){const actor=this.actor;if(!actor?.isOfType("character"))throw ErrorPF2e("Feats much be embedded in PC-type actors");if(this.suppressed)return;const prefix=this.isFeature?"feature":"feat",slug=this.slug??sluggify(this.name);actor.rollOptions.all[`${prefix}:${slug}`]=!0;const subfeatures=this.system.subfeatures;featCanHaveKeyOptions(this)||(subfeatures.keyOptions=[]),subfeatures.keyOptions.length>0&&(actor.system.build.attributes.keyOptions=n([...actor.system.build.attributes.keyOptions,...subfeatures.keyOptions]));const{build,proficiencies,saves}=actor.system;build.languages.max+=subfeatures.languages.slots,build.languages.granted.push(...subfeatures.languages.granted.map(slug2=>({slug:slug2,source:this.name})));for(const[slug2,increase]of Object.entries(subfeatures.proficiencies)){const proficiency=(()=>{if(slug2==="perception")return actor.system.perception;if(slug2==="spellcasting")return proficiencies.spellcasting;if(objectHasKey(CONFIG.PF2E.saves,slug2))return saves[slug2];if(objectHasKey(CONFIG.PF2E.weaponCategories,slug2))return proficiencies.attacks[slug2];if(objectHasKey(CONFIG.PF2E.armorCategories,slug2))return proficiencies.defenses[slug2];if(objectHasKey(CONFIG.PF2E.classTraits,slug2)){const classDCs=proficiencies.classDCs,attribute=increase.attribute??"str";return classDCs[slug2]??={attribute,label:CONFIG.PF2E.classTraits[slug2],rank:0}}return null})();proficiency&&increase?.rank&&(proficiency.rank=Math.max(proficiency.rank,increase.rank))}const senseData=actor.system.perception.senses,acuityValues={precise:2,imprecise:1,vague:0};for(const[type2,data]of t$f(subfeatures.senses)){if(senseData.some(s=>s.type===type2))continue;if(type2==="darkvision"&&data.special&&Object.values(data.special).includes(!0)){const ancestry=actor.ancestry;if(ancestry?.system.vision==="darkvision")continue;const special=data.special,llvFeats=actor.itemTypes.feat.filter(f=>f!==this&&f.system.subfeatures.senses["low-light-vision"]),ancestryFeatures=__name2(()=>ancestry?llvFeats.filter(f=>f.category==="ancestryfeature"&&f.system.subfeatures.senses["low-light-vision"]&&f.flags.pf2e.grantedBy?.id===ancestry.id):[],"ancestryFeatures"),ancestryHasLLV=ancestry?.system.vision==="low-light-vision"||ancestryFeatures().length>0,hasLLVRule=__name2(rules=>rules.some(r2=>r2.key==="Sense"&&!r2.ignored&&"selector"in r2&&r2.selector==="low-light-vision"),"hasLLVRule"),heritageHasLLV=__name2(()=>hasLLVRule(actor.heritage?.system.rules??[]),"heritageHasLLV"),backgroundHasLLV=__name2(()=>hasLLVRule(actor.background?.system.rules??[]),"backgroundHasLLV"),levelTaken=this.system.level.taken??1,ancestryLLVSatisfied=ancestryHasLLV,takenTwiceSatisfied=__name2(()=>actor.itemTypes.feat.some(f=>f.sourceId===this.sourceId&&f!==this&&(f.system.level.taken??1)<=levelTaken),"takenTwiceSatisfied"),llvAnywhereSatisfied=__name2(()=>ancestryHasLLV||heritageHasLLV()||backgroundHasLLV()||llvFeats.some(f=>(f.system.level.taken??1)<=levelTaken&&(f.system.subfeatures.senses["low-light-vision"]||hasLLVRule(f.system.rules))),"llvAnywhereSatisfied");if(!(special.ancestry&&ancestryLLVSatisfied||special.second&&takenTwiceSatisfied()||special.llv&&llvAnywhereSatisfied()))continue}const newSense={type:type2,acuity:data.acuity??"precise",range:data.range??1/0,source:this.name},existing=senseData.find(s=>s.type===type2);existing?((data.range??1/0)>(existing.range??1/0)||acuityValues[data.acuity??"vague"]>acuityValues[existing.acuity??"precise"])&&senseData.splice(senseData.indexOf(existing),1,newSense):senseData.push(newSense)}}establishHierarchy(){this.grants=Object.values(this.flags.pf2e.itemGrants).flatMap(grant=>{const item=this.actor?.items.get(grant.id);return item?.isOfType("feat")&&!item.system.location||item?.isOfType("heritage")?[item]:[]});for(const grant of this.grants.filter(g=>g.isOfType("feat")))grant.system.level.taken=this.system.level.taken}prepareSiblingData(){if(!this.actor)return;const subfeatures=this.system.subfeatures;if(!featCanHaveKeyOptions(this))subfeatures.suppressedFeatures=[];else if(subfeatures.suppressedFeatures.length){const uuids=subfeatures.suppressedFeatures,feats=this.actor.itemTypes.feat.filter(f=>uuids.includes(f.sourceId??""));suppressFeats(feats)}}onPrepareSynthetics(){processSanctification(this)}prepareRuleElements(options){return this.suppressed?[]:super.prepareRuleElements(options)}async getChatData(htmlOptions={}){const actor=this.actor,classSlug=actor.isOfType("character")&&actor.class?.slug,traitSlugs=["class","classfeature"].includes(this.category)&&actor.isOfType("character")&&classSlug&&this.system.traits.value.includes(classSlug)?this.system.traits.value.filter(t2=>t2===classSlug||!(t2 in CONFIG.PF2E.classTraits)):this.system.traits.value,traits=this.traitChatData(CONFIG.PF2E.featTraits,traitSlugs),levelLabel=this.isFeat&&this.level>0?game.i18n.format("PF2E.Item.Feat.LevelN",{level:this.level}):null,rarity=this.rarity==="common"?null:{slug:this.rarity,label:CONFIG.PF2E.rarityTraits[this.rarity],description:CONFIG.PF2E.traitsDescriptions[this.rarity]};return this.processChatData(htmlOptions,{...this.system,levelLabel,traits,rarity})}getRollOptions(prefix=this.type,options){prefix=prefix==="feat"&&this.isFeature?"feature":prefix;const rollOptions=super.getRollOptions(prefix,options);return rollOptions.push(`${prefix}:category:${this.category}`),rollOptions.findSplice(o=>o===`${prefix}:level:0`),this.isFeat||rollOptions.findSplice(o=>o===`${prefix}:rarity:${this.rarity}`),this.frequency&&rollOptions.findSplice(o=>o===`${prefix}:frequency:limited`),rollOptions.push(...getActionCostRollOptions(prefix,this)),rollOptions}embedHTMLString(config){const list=this.system.prerequisites?.value?.map(item=>item.value).join(", ")??"";return(list?`<p><strong>${game.i18n.localize("PF2E.FeatPrereqLabel")}</strong> ${list}</p>`+(config.hr===!1?"":"<hr>"):"")+this.description}async _preCreate(data,options,user){return this.parent||(this._source.system.location=null,delete this._source.system.level.taken,this._source.system.frequency&&(this._source.system.frequency.value=void 0)),super._preCreate(data,options,user)}async _preUpdate(changed,options,user){if(!changed.system)return super._preUpdate(changed,options,user);"location"in changed.system&&(changed.system.location||=null),typeof changed.system.level?.value=="number"&&changed.system.level.value!==1&&(changed.system.onlyLevel1=!1),normalizeActionChangeData(this,changed);const category=changed.system.category??this._source.system.category,traits=changed.system.traits?.value;return setHasElement(FEATURE_CATEGORIES,category)?(changed.system.onlyLevel1=!1,changed.system.maxTakable=1,changed.system.category==="calling"&&Array.isArray(traits)&&(traits.includes("calling")||traits.push("calling"),traits.includes("mythic")||traits.push("mythic"),traits.sort())):setHasElement(FEAT_CATEGORIES,category)&&Array.isArray(traits)&&(traits.includes("calling")&&traits.splice(traits.indexOf("calling"),1),category!=="ancestry"&&traits.includes("lineage")?traits.splice(traits.indexOf("lineage"),1):(traits.includes("lineage")||changed.system?.onlyLevel1)&&foundry.utils.mergeObject(changed,{system:{maxTakable:1}})),super._preUpdate(changed,options,user)}_onCreate(data,options,userId){if(super._onCreate(data,options,userId),!(this.isOwner&&this.actor?.isOfType("character")&&this.isFeat))return;const actorItemNames={actor:this.actor.name,item:this.name};if(this.onlyLevel1&&this.actor.level>1){const formatParams={...actorItemNames,actorLevel:this.actor.level},warning=game.i18n.format("PF2E.Item.Feat.Warning.TakenAfterLevel1",formatParams);ui.notifications.warn(warning)}if(this.flags.pf2e.grantedBy)return;const slug=this.slug??sluggify(this.name),timesTaken=this.actor.itemTypes.feat.filter(f=>f.slug===slug).length,{maxTakable}=this;if(maxTakable===1&&timesTaken>1)ui.notifications.warn(game.i18n.format("PF2E.Item.Feat.Warning.TakenMoreThanOnce",actorItemNames));else if(timesTaken>maxTakable){const formatParams={...actorItemNames,maxTakable,timesTaken};ui.notifications.warn(game.i18n.format("PF2E.Item.Feat.Warning.TakenMoreThanMax",formatParams))}}}class HeritagePF2e extends ItemPF2e{static{__name(this,"HeritagePF2e")}static{__name2(this,"HeritagePF2e")}static get validTraits(){return CONFIG.PF2E.creatureTraits}get traits(){return new Set(this.system.traits.value)}get rarity(){return this.system.traits.rarity}get isVersatile(){return!this.system.ancestry}prepareActorData(){if(!this.actor.isOfType("character"))throw ErrorPF2e("heritage embedded on non-character");const slug=this.slug??sluggify(this.name);(this.actor.itemTypes.heritage.length===1||!this.grantedBy)&&(this.actor.heritage=this,this.actor.system.details.heritage={name:this.name,trait:slug in CONFIG.PF2E.ancestryTraits?slug:null}),this.actor.system.traits.value.push(...this.traits),this.isVersatile&&this.actor.system.details.ancestry?.countsAs.push(slug),this.actor.rollOptions.all[`heritage:${slug}`]=!0,this.actor.rollOptions.all[`self:heritage:${slug}`]=!0}getRollOptions(prefix=this.type,options){const ancestryOrVersatile=this.system.ancestry?`ancestry:${this.system.ancestry.slug}`:"versatile";return[...super.getRollOptions(prefix,options),`${prefix}:${ancestryOrVersatile}`]}}class KitPF2e extends ItemPF2e{static{__name(this,"KitPF2e")}static{__name2(this,"KitPF2e")}static get validTraits(){return CONFIG.PF2E.classTraits}get entries(){return Object.values(this.system.items)}get price(){return this.system.price}async createGrantedItems(options={}){const size=new ActorSizePF2e({value:options.size??"med",smallIsMedium:!0}).value,entries=options.entries??this.entries,itemUUIDs=entries.map(e2=>e2.uuid),items=await UUIDUtils.fromUUIDs(itemUUIDs);if(entries.length!==items.length)throw ErrorPF2e(`Some items from ${this.name} were not found`);return items.every(i=>i instanceof ItemPF2e&&!i.parent)?items.reduce(async(promise,item,index2)=>{const prepared=await promise,clone=item.clone({_id:foundry.utils.randomID(),system:{size}},{keepId:!0}),entry=entries[index2];if(clone.isOfType("physical")&&clone.updateSource({"system.quantity":entry.quantity,"system.containerId":options.containerId}),clone.isOfType("backpack")&&entry.items){const contents=await this.createGrantedItems({entries:Object.values(entry.items),containerId:clone.id,size});prepared.push(clone,...contents)}else if(clone.isOfType("kit")){const inflatedKit=await clone.createGrantedItems({containerId:options.containerId,size});prepared.push(...inflatedKit)}else clone.isOfType("physical")&&prepared.push(clone);return prepared},[]):[]}}class LorePF2e extends ItemPF2e{static{__name(this,"LorePF2e")}static{__name2(this,"LorePF2e")}get slug(){const rawLoreSlug=super.slug??sluggify(this.name);return/\blore\b/.test(rawLoreSlug)?rawLoreSlug:`${rawLoreSlug}-lore`}}class LoreSheetPF2e extends ItemSheetPF2e{static{__name(this,"LoreSheetPF2e")}static{__name2(this,"LoreSheetPF2e")}}class DicePF2e{static{__name(this,"DicePF2e")}static{__name2(this,"DicePF2e")}_rolled;terms;static async d20Roll({event:event2,item=null,parts,data,template,title,speaker,flavor,onClose,dialogOptions,rollMode=game.settings.get("core","rollMode"),rollType=""}){const userSettingQuickD20Roll=!game.user.settings.showCheckDialogs,_roll=__name2(async(rollParts,adv,$form)=>{let flav=flavor instanceof Function?flavor(rollParts,data):title;adv===1?(rollParts[0]=["2d20kh"],flav=game.i18n.format("PF2E.Roll.FortuneTitle",{title})):adv===-1&&(rollParts[0]=["2d20kl"],flav=game.i18n.format("PF2E.Roll.MisfortuneTitle",{title})),$form&&(data.itemBonus=$form.find("[name=itemBonus]").val()),(!data.itemBonus||data.itemBonus===0)&&rollParts.indexOf("@itemBonus")!==-1&&rollParts.splice(rollParts.indexOf("@itemBonus"),1),$form&&(data.statusBonus=$form.find("[name=statusBonus]").val()),(!data.statusBonus||data.statusBonus===0)&&rollParts.indexOf("@statusBonus")!==-1&&rollParts.splice(rollParts.indexOf("@statusBonus"),1),$form&&(data.circumstanceBonus=$form.find("[name=circumstanceBonus]").val()),(!data.circumstanceBonus||data.circumstanceBonus===0)&&rollParts.indexOf("@circumstanceBonus")!==-1&&rollParts.splice(rollParts.indexOf("@circumstanceBonus"),1);const roll=await new Roll(rollParts.join("+"),data).roll(),origin=item?{uuid:item.uuid,type:item.type}:null;return roll.toMessage({speaker,flavor:flav,flags:{pf2e:{context:{type:rollType},origin}}},{rollMode:$form?$form.find("[name=rollMode]").val():rollMode}),roll},"_roll");if(parts.unshift("1d20"),userSettingQuickD20Roll&&!event2.altKey&&!(event2.ctrlKey||event2.metaKey)&&!event2.shiftKey||!userSettingQuickD20Roll&&event2.shiftKey)return _roll(parts,0);if(event2.ctrlKey||event2.metaKey)return rollMode="blindroll",_roll(parts,0);if(event2.shiftKey||!userSettingQuickD20Roll){parts.indexOf("@circumstanceBonus")===-1&&(parts=parts.concat(["@circumstanceBonus"])),parts.indexOf("@itemBonus")===-1&&(parts=parts.concat(["@itemBonus"])),parts.indexOf("@statusBonus")===-1&&(parts=parts.concat(["@statusBonus"])),template=template||"systems/pf2e/templates/chat/roll-dialog.hbs";const dialogData={data,rollMode,formula:parts.join(" + "),rollModes:CONFIG.Dice.rollModes},content=await foundry.applications.handlebars.renderTemplate(template,dialogData);let roll;return new Promise(resolve=>{new foundry.appv1.api.Dialog({title,content,buttons:{advantage:{label:game.i18n.localize("PF2E.Roll.Fortune"),callback:__name2(async html2=>{roll=await _roll(parts,1,html2)},"callback")},normal:{label:game.i18n.localize("PF2E.Roll.Normal"),callback:__name2(async html2=>{roll=await _roll(parts,0,html2)},"callback")},disadvantage:{label:game.i18n.localize("PF2E.Roll.Misfortune"),callback:__name2(async html2=>{roll=await _roll(parts,-1,html2)},"callback")}},default:game.i18n.localize("PF2E.Roll.Normal"),close:__name2(html2=>{onClose&&onClose(html2,parts,data),resolve(roll)},"close")},dialogOptions).render(!0)})}else return _roll(parts,0)}alter(add2,multiply){const rgx=new RegExp(foundry.dice.terms.DiceTerm.REGEXP,"g");if(this._rolled)throw ErrorPF2e("You may not alter a Roll which has already been rolled");return this.terms=this.terms?.map(t2=>t2.replace(rgx,(_match,nd,d,mods)=>(nd=nd*(multiply||1)+(add2||0),mods=mods||"",`${nd}d${d}${mods}`))),this}}function simplifyFormula(formula){if(formula==="0")return formula;const fixedFormula=formula.replace(/^\s*-\s+/,"-").replace(/\s*\+\s*-\s*/g," - "),roll=new Roll(fixedFormula);if(!roll.terms.every(t2=>[" - "," + "].includes(t2.expression)||t2 instanceof foundry.dice.terms.Die||t2 instanceof foundry.dice.terms.NumericTerm))return fixedFormula;const terms2=parseTermsFromSimpleFormula(roll);return createSimpleFormula(terms2)}__name(simplifyFormula,"simplifyFormula"),__name2(simplifyFormula,"simplifyFormula");class MeleePF2e extends ItemPF2e{static{__name(this,"MeleePF2e")}static{__name2(this,"MeleePF2e")}static get validTraits(){return CONFIG.PF2E.npcAttackTraits}get traits(){return new Set(this.system.traits.value)}get isMelee(){return!this.isRanged}get isRanged(){return!!this.system.range}get isThrown(){return this.isRanged&&this.system.traits.value.some(t2=>t2.startsWith("thrown-"))}get defaultAttribute(){const{traits}=this;return this.isMelee?traits.has("finesse")?"dex":"str":traits.has("brutal")?"str":"dex"}get attackModifier(){return Number(this.system.bonus.value)||0}get reach(){if(this.isRanged)return null;const reachTrait=this.system.traits.value.find(t2=>/^reach-\d+$/.test(t2));return reachTrait?Number(reachTrait.replace("reach-","")):SIZE_TO_REACH[this.actor?.size??"med"]}get range(){const data=this.system.range;return data?.max?data:data?.increment?{increment:data.increment,max:data.increment*6}:null}get baseDamage(){const partials=Object.values(this.system.damageRolls),instance=partials.find(p=>!p.category)??partials.at(0);return instance?WeaponDamagePF2e.npcDamageToWeaponDamage(instance):{dice:0,die:null,modifier:0,damageType:"untyped",persistent:null,category:null}}get dealsDamage(){const baseDamage=this.baseDamage;return baseDamage.dice>0||baseDamage.modifier>0||!!baseDamage.persistent?.number||Object.values(this.system.damageRolls).some(d=>d.category==="splash")}get attackEffects(){return this.system.attackEffects.value}get isMagical(){const{traits}=this;return["magical","arcane","primal","divine","occult"].some(t2=>traits.has(t2))}get linkedWeapon(){const item=this.actor?.items.get(this.flags.pf2e.linkedWeapon??"");return item?.isOfType("weapon")?item:null}_initialize(options){this.category=this.group=this.baseType=null,super._initialize(options)}prepareBaseData(){if(super.prepareBaseData(),this.system.traits.config?.thrown){const increment2=this.system.traits.config.thrown;this.system.range={increment:increment2,max:null}}}prepareSiblingData(){const linkedWeapon=this.linkedWeapon,isUnarmed=this.system.traits.value.includes("unarmed");this.category=isUnarmed?"unarmed":linkedWeapon?.category??null,this.group=isUnarmed?"brawling":linkedWeapon?.group??null,this.baseType=tupleHasValue(["claw","fist","jaws"],this.slug)?this.slug:linkedWeapon?.baseType??null}prepareActorData(){const actor=this.actor;if(!actor?.isOfType("npc"))return;const damageInstances=Object.values(this.system.damageRolls);for(const instance of Object.values(this.system.damageRolls)){try{instance.damage=new Roll(instance.damage)._formula}catch{const message=`Unable to parse damage formula on NPC attack ${this.name}`;console.warn(`PF2e System | ${message}`),instance.damage="1d4"}const{isElite,isWeak}=actor;if((isElite||isWeak)&&damageInstances.indexOf(instance)===0){const adjustment=isElite?2:-2;instance.damage=simplifyFormula(`${instance.damage} + ${adjustment}`)}else instance.damage=new Roll(instance.damage)._formula}const reachTrait=this.system.traits.value.find(t2=>/^reach-\d+$/.test(t2)),attackReach=Number(reachTrait?.replace(/^reach-/,"")??NaN);if(Number.isInteger(attackReach)){const reach=actor.system.attributes.reach;reach.base=attackReach>0?Math.max(attackReach,reach.base):0,reach.manipulate=reach.base}}getRollOptions(prefix=this.type,options){const baseOptions=super.getRollOptions(prefix,options),damageType=this.baseDamage.damageType,damageCategory=DamageCategorization.fromDamageType(damageType),rangeIncrement=this.range?.increment,propertyRunes=t$9(this.system.runes.property,p=>[`rune:property:${sluggify(p)}`,!0]),otherOptions=Object.entries({equipped:!0,melee:this.isMelee,ranged:this.isRanged,thrown:this.isThrown,[`category:${this.category}`]:!!this.category,[`group:${this.group}`]:!!this.group,[`base:${this.baseType}`]:!!this.baseType,[`range-increment:${rangeIncrement}`]:!!rangeIncrement,[`damage:type:${damageType}`]:!0,[`damage:category:${damageCategory}`]:!!damageCategory,...propertyRunes}).filter(([,isTrue])=>isTrue).map(([key])=>`${prefix}:${key}`);return[baseOptions,otherOptions].flat().sort()}async toMessage(_event,{create=!0}={}){if(!create)return;const strike=this.actor?.system.actions?.find(s=>s.item===this);return strike?game.pf2e.rollActionMacro({itemId:this.id,slug:strike.slug}):void 0}async _preUpdate(changed,options,user){return changed.system?((changed.system.traits?.value??this._source.system.traits.value).some(t2=>t2.startsWith("thrown-"))||changed.system.range?.increment===null&&changed.system.range.max===null?changed.system.range=null:changed.system.range?.max&&(changed.system.range.increment=null),super._preUpdate(changed,options,user)):super._preUpdate(changed,options,user)}}function createSpellRankLabel(spell,castRank){const typeLabel=spell.isCantrip?game.i18n.localize("PF2E.TraitCantrip"):spell.isFocusSpell?game.i18n.localize("PF2E.TraitFocus"):spell.isRitual?game.i18n.localize("PF2E.Item.Spell.Ritual.Label"):game.i18n.localize("TYPES.Item.spell");return castRank?game.i18n.format("PF2E.ItemLevel",{type:typeLabel,level:castRank}):typeLabel}__name(createSpellRankLabel,"createSpellRankLabel"),__name2(createSpellRankLabel,"createSpellRankLabel");async function createDescriptionPrepend(spell,{includeTraditions}){const traditions=includeTraditions?spell.system.traits.traditions.map(t2=>game.i18n.localize(CONFIG.PF2E.magicTraditions[t2]).toLocaleLowerCase(game.i18n.lang)).sort((a,b)=>a.localeCompare(b,game.i18n.lang)).join(", "):null,defenseLabel=(()=>{const defense=spell.system.defense;if(!defense)return null;const passive=defense.passive?getPassiveDefenseLabel(defense.passive.statistic,{localize:!0}):null,partialSaveLabel=defense.save?game.i18n.localize(CONFIG.PF2E.saves[defense.save.statistic]):null,save=partialSaveLabel&&defense.save?.basic?game.i18n.format("PF2E.Item.Spell.Defense.BasicDefense",{save:partialSaveLabel}):partialSaveLabel;return passive&&save?game.i18n.format("PF2E.ListPartsAnd.two",{first:passive,second:save}):passive??save})(),durationLabel=(()=>{const duration=spell.system.duration,textDuration=duration.value.trim();if(duration.sustained){const localize=localizer("PF2E.Item.Spell.Sustained"),label=textDuration===""?localize("Label"):localize("Duration",{maximum:textDuration});return game.i18n.lang==="de"?label:label.toLocaleLowerCase(game.i18n.lang)}return textDuration||null})(),areaLabel=(()=>{const label=spell.area?.label;if(!label)return null;const baseLabel=spell._source.system.area?createEffectAreaLabel(spell._source.system.area):label;return{label,baseLabel}})(),templatePath="systems/pf2e/templates/items/partials/spell-description-prepend.hbs",formatArgs={traditions,cast:spell.actionGlyph?null:spell.system.time.value||null,cost:spell.system.cost.value?.trim()||null,secondaryCasters:spell.system.ritual?.secondary.casters||null,primaryCheck:spell.system.ritual?.primary.check?.trim()||null,secondaryChecks:spell.system.ritual?.secondary.checks.trim()||null,range:spell.system.range.value.trim()||null,targets:spell.system.target.value.trim()||null,area:areaLabel,defense:defenseLabel,duration:durationLabel};return(await foundry.applications.handlebars.renderTemplate(templatePath,formatArgs)).trim()}__name(createDescriptionPrepend,"createDescriptionPrepend"),__name2(createDescriptionPrepend,"createDescriptionPrepend");function getPassiveDefenseLabel(statistic,{localize=!1}={}){const label=(()=>{switch(statistic){case"ac":return"PF2E.Check.DC.Specific.armor";case"fortitude-dc":return"PF2E.Check.DC.Specific.fortitude";case"reflex-dc":return"PF2E.Check.DC.Specific.reflex";case"will-dc":return"PF2E.Check.DC.Specific.will";default:return null}})();return label&&localize?game.i18n.localize(label):label}__name(getPassiveDefenseLabel,"getPassiveDefenseLabel"),__name2(getPassiveDefenseLabel,"getPassiveDefenseLabel");class SpellOverlayCollection extends Collection{static{__name(this,"SpellOverlayCollection")}static{__name2(this,"SpellOverlayCollection")}spell;constructor(spell,entries){super(Object.entries(entries??{})),this.spell=spell}get overrideVariants(){return[...this.entries()].reduce((result,[overlayId,data])=>{if(data.overlayType==="override"){const spell=this.spell.loadVariant({overlayIds:[overlayId]});if(spell)return[...result,spell]}return result},[])}getType(overlayId){return this.get(overlayId,{strict:!0}).overlayType}async create(overlayType,options={renderSheet:!1}){const id=foundry.utils.randomID();switch(overlayType){case"override":if(await this.spell.update({[`system.overlays.${id}`]:{sort:this.overrideVariants.length+1,overlayType:"override",system:{}}}),options.renderSheet){const variantSpell=this.spell.loadVariant({overlayIds:[id]});variantSpell&&variantSpell.sheet.render(!0)}break}}async updateOverride(variantSpell,data,operation){const variantId=variantSpell.variantId;if(!variantId)return null;variantSpell.updateSource(data,operation);const variantSource=n$1(variantSpell.toObject(),["_stats"]),originSource=n$1(this.spell.toObject(),["_stats"]),difference=foundry.utils.diffObject(originSource,variantSource);return Object.keys(difference).length===0||(delete difference.system?.description,difference.overlayType="override",await this.spell.update({[`system.overlays.-=${variantId}`]:null},{render:!1}),await this.spell.update({[`system.overlays.${variantId}`]:difference}),variantSpell.sheet.rendered&&variantSpell.sheet.render(!0)),variantSpell}async deleteOverlay(overlayId){this.verifyOverlayId(overlayId),await this.spell.update({[`system.overlays.-=${overlayId}`]:null}),this.delete(overlayId)}verifyOverlayId(overlayId){if(!this.has(overlayId))throw ErrorPF2e(`Spell ${this.spell.name} (${this.spell.uuid}) does not have an overlay with id: ${overlayId}`)}}class SpellPF2e extends ItemPF2e{static{__name(this,"SpellPF2e")}static{__name2(this,"SpellPF2e")}parentItem;constructor(data,context={}){super(data,context),this.parentItem=context.parentItem??null}static get validTraits(){return CONFIG.PF2E.spellTraits}get variantId(){return this.original?this.appliedOverlays?.get("override")??null:null}get baseRank(){return this.system.level.value}get baseLevel(){return this.baseRank}get rank(){if(!this.actor)return this.baseRank;const isAutoHeightened=this.isCantrip||this.isFocusSpell,fixedHeightenedRank=this.system.location.autoHeightenLevel||this.spellcasting?.system?.autoHeightenLevel.value||null,heightenedRank=isAutoHeightened?fixedHeightenedRank||Math.ceil(this.actor.level/2)||null:this.system.location.heightenedLevel||null;return Math.clamp(heightenedRank||this.baseRank,1,10)}get level(){return this.rank}get traits(){return new Set(this.system.traits.value)}get rarity(){return this.system.traits.rarity}get traditions(){return new Set(this.system.traits.traditions)}get actionGlyph(){return this.isRitual?null:getActionGlyph(this.system.time.value)||null}get defense(){const defense=this.system.defense;if(defense?.passive){const label=getPassiveDefenseLabel(defense.passive.statistic);if(label)return{slug:defense.passive.statistic,label:game.i18n.localize(label)}}else if(defense?.save){const saveLabel=game.i18n.localize(CONFIG.PF2E.saves[defense.save.statistic]),label=defense.save.basic?game.i18n.format("PF2E.Item.Spell.Defense.BasicDefense",{save:saveLabel}):saveLabel;return{slug:defense.save.statistic,label}}return null}get spellcasting(){const actor=this.actor,spellcastingId=this.system.location.value;return actor?.spellcasting?.get(spellcastingId??"")??null}get isAttack(){return this.traits.has("attack")}get isCantrip(){return this.system.traits.value.includes("cantrip")}get isFocusSpell(){const traits=this._source.system.traits;return traits.traditions.length===0&&this.isCantrip||traits.value.includes("focus")}get isRitual(){return!!this.system.ritual}get attribute(){return this.spellcasting?.attribute??"cha"}get atWill(){return this.system.cast.focusPoints===0&&(this.isCantrip||this.isRitual)}get isVariant(){return!!this.original}get hasVariants(){return this.overlays.size>0}get range(){const actor=this.actor;if(this.isMelee)return{increment:null,max:actor?.isOfType("creature")?actor.system.attributes.reach.base:5};const text2=sluggify(this.system.range.value),rangeFeet=Math.floor(Math.abs(Number(/^(\d+)-f(?:t|eet)\b/.exec(text2)?.at(1))));return Number.isInteger(rangeFeet)?{increment:null,max:rangeFeet}:null}get isMelee(){return sluggify(this.system.range.value)==="touch"}get isRanged(){return!this.isMelee&&!!this.range?.max}get area(){const areaData=this.system.area;return areaData?{...areaData,label:createEffectAreaLabel(areaData)}:null}get damageKinds(){return new Set(Object.values(this.system.damage).flatMap(d=>Array.from(d.kinds)))}get uuid(){return this.isVariant?this.original?.uuid??super.uuid:super.uuid}computeCastRank(slotNumber){return(this.isCantrip||this.isFocusSpell)&&this.actor?this.rank:Math.max(this.baseRank,slotNumber??this.rank)}getRollData(rollOptions={}){const spellRank=Number(rollOptions?.castRank)||null,castRank=Math.max(this.baseRank,spellRank||this.rank);if(spellRank&&castRank!==this.rank)return this.clone({"system.location.heightenedLevel":castRank}).getRollData();const rollData=super.getRollData();return this.actor?.isOfType("character","npc")&&(rollData.mod=this.actor.abilities[this.attribute].mod),rollData.castRank=castRank,rollData.heighten=Math.max(0,castRank-this.baseRank),rollData}async getDamage(params={skipDialog:!0}){const{actor,spellcasting}=this;if(Object.keys(this.system.damage).length===0||!actor||!spellcasting?.statistic)return null;const castRank=this.rank,rollData=this.getRollData({castRank}),base=Object.entries(this.system.damage??{}).map(([id,damage],index2)=>{if(!DamageRoll.validate(damage.formula))return console.error(`Failed to parse damage formula "${damage.formula}"`),null;const terms2=parseTermsFromSimpleFormula(damage.formula,{rollData}),heightening=this.system.heightening;if(heightening?.type==="interval"&&heightening.interval){const scalingFormula=heightening.damage[id],timesHeightened=Math.floor((castRank-this.baseRank)/heightening.interval);if(scalingFormula&&timesHeightened>0){const scalingTerms=parseTermsFromSimpleFormula(scalingFormula,{rollData});for(let i=0;i<timesHeightened;i++)terms2.push(...foundry.utils.deepClone(scalingTerms))}}const adjustment=actor.isOfType("npc")&&actor.system.attributes.adjustment;if(terms2.length>0&&index2===0&&adjustment){const value=this.atWill?2:4;terms2.push({dice:null,modifier:actor.isElite?value:-value})}const damageType=damage.type,category=damage.category||null,materials=damage.materials;return{terms:combinePartialTerms(terms2),damageType,category,materials}}).filter(e$6);if(base.length===0)return null;const{attribute,isAttack}=this,checkStatistic=spellcasting.statistic,damageKinds=Array.from(this.damageKinds),domains=[damageKinds,damageKinds.map(k=>`spell-${k}`),damageKinds.map(k=>`${this.id}-${k}`),isAttack?["attack-damage","attack-spell-damage"]:null,this.isMelee?"melee-damage":null,checkStatistic.base?damageKinds.map(k=>`${checkStatistic.base?.slug}-${k}`):null].flat().filter(e$6),spellTraits2=n([...this.system.traits.value,spellcasting.tradition]).filter(e$6).sort(),actionAndTraitOptions=new Set(["action:cast-a-spell","self:action:slug:cast-a-spell",...spellTraits2]),contextData=await new DamageContext({origin:{actor,item:this,statistic:checkStatistic},target:isAttack?{token:params.target}:null,domains,options:actionAndTraitOptions,checkContext:null,outcome:null,traits:spellTraits2,viewOnly:!isAttack||!params.target}).resolve();if(!contextData.origin)return null;const context={type:"damage-roll",sourceType:isAttack?"attack":"save",outcome:isAttack?"success":null,domains,options:contextData.options,self:contextData.origin,target:contextData.target,rollMode:params.rollMode,traits:contextData.traits},modifiers=[],damageDice=[],originClone=contextData.origin.actor,{damageAlterations,modifierAdjustments}=actor.synthetics;if(originClone.system.abilities){const attributes=originClone.system.abilities,attributeModifiers=Object.entries(this.system.damage).filter(([,d])=>d.applyMod).map(([k,d])=>new Modifier({label:CONFIG.PF2E.abilities[attribute],slug:`ability-${k}`,type:"untyped",modifier:attributes[attribute].mod,damageType:d.type,damageCategory:d.category||null,alterations:extractDamageAlterations(damageAlterations,domains,`ability-${k}`),adjustments:extractModifierAdjustments(modifierAdjustments,domains,`ability-${k}`)})),extractOptions={selectors:domains,resolvables:{spell:this,target:contextData.target?.actor??null},test:contextData.options},extracted=processDamageCategoryStacking(base,{modifiers:[attributeModifiers,extractModifiers(actor.synthetics,domains,extractOptions)].flat(),dice:extractDamageDice(actor.synthetics.damageDice,extractOptions),test:contextData.options});actor&&applyBaseDamageAlterations({actor,item:this,base,domains,rollOptions:context.options});for(const dice of extracted.dice)dice.applyAlterations({item:this,test:contextData.options});for(const modifier of extracted.modifiers)modifier.applyDamageAlterations({item:this,test:contextData.options});modifiers.push(...extracted.modifiers),damageDice.push(...extracted.dice)}const formulaData={base,modifiers,dice:damageDice,kinds:this.damageKinds};if(!params.skipDialog&&!await new DamageModifierDialog({formulaData,context}).resolve())return null;const{formula,breakdown}=createDamageFormula(formulaData),showBreakdown=game.pf2e.settings.metagame.breakdowns||!!context.self?.actor?.hasPlayerOwner,roll=new DamageRoll(formula,{},{showBreakdown});return{template:{name:this.name,damage:{roll,breakdown},materials:Array.from(roll.materials),modifiers},context}}loadBaseVariant(){const entryId=this.spellcasting?.id,castRank=this.system.location.heightenedLevel;return this.original?.loadVariant({entryId,castRank})??this.original??this}loadVariant(options={}){if(this.original){const entryId=this.system.location.value,overlayIds2=this.appliedOverlays?.values().toArray()??[];return this.original.loadVariant({entryId,overlayIds:overlayIds2,...options})}const{castRank,overlayIds}=options,appliedOverlays=new Map,heightenOverlays=this.getHeightenLayers(castRank??this.rank),overlays=overlayIds?.map(id=>({id,data:this.overlays.get(id,{strict:!0})}))??[],overrides=(()=>{const isEntryChange=options.entryId&&options.entryId!==this.system.location.value;if(overlays.length===0&&heightenOverlays.length===0){if(castRank!==this.rank)return foundry.utils.mergeObject(this.toObject(),{system:{location:{heightenedLevel:castRank}}});if(!isEntryChange)return null}if(overlays.map(overlay=>overlay.data.overlayType).filter(type2=>type2==="override").length>1)throw ErrorPF2e(`Error loading variant of Spell ${this.name} (${this.uuid}). Cannot apply multiple override overlays.`);let source2=this.toObject();for(const{id,data}of overlays){switch(data.overlayType){case"override":{delete source2.system.overlays,source2.system.rules=[],source2=foundry.utils.mergeObject(source2,data,{overwrite:!0});break}}appliedOverlays.set(data.overlayType,id)}for(const overlay of heightenOverlays)source2.system=foundry.utils.mergeObject(source2.system,overlay.system);const currentRank=source2.system.location.heightenedLevel??source2.system.level.value;return castRank&&castRank!==currentRank&&(source2.system.location.heightenedLevel=castRank),source2._id=this.id,source2})();if(!overrides)return null;options.entryId&&(overrides.system.location.value=options.entryId),overrides.system.location.value=options.entryId??this.system.location.value;const variant=new SpellPF2e(overrides,{parent:this.parent,parentItem:this.parentItem});return variant.original=this,variant.appliedOverlays=appliedOverlays,variant.system.traits.value=Array.from(variant.traits),performLatePreparation(variant),variant}getHeightenLayers(rank){const heightening=this.system.heightening;return heightening?.type!=="fixed"?[]:Object.entries(heightening.levels).map(([rank2,system2])=>({level:Number(rank2),system:system2})).filter(system2=>!rank||rank>=system2.level).sort((first,second)=>first.level-second.level)}placeTemplate(message){const area=this.system.area;if(!area)throw ErrorPF2e("Attempted to create template with non-area spell");return placeItemTemplate(area,{item:this,message})}prepareBaseData(){super.prepareBaseData(),this.system.location.value||=null,this.system.level.value=Math.clamp(this.system.level.value,1,10)||1,this.system.area?.value?(this.system.area.value=Math.max(5,Math.ceil(this.system.area.value/5)*5||5),this.system.area.type||="burst"):this.system.area=null;const traits=this.system.traits;if(this.isRitual&&(this.system.damage={},this.system.defense=null,traits.value=traits.value.filter(t2=>!["attack","cantrip","focus"].includes(t2)),traits.traditions=[],this.system.location.value="rituals"),traits.value.includes("attack")){const passive={statistic:this.system.defense?.passive?.statistic??"ac"},save=this.system.defense?.save??null;this.system.defense=foundry.utils.mergeObject(this.system.defense??{},{passive,save})}this.system.cast={focusPoints:Number(this.isFocusSpell&&!this.isCantrip)};const castTime=this.system.time.value=this.system.time.value.trim();!["","2 to 2 rounds"].includes(castTime)&&!this.isRitual&&!getActionGlyph(castTime)&&(traits.value.push("exploration"),traits.value.sort());for(const damage of Object.values(this.system.damage)){if(!e$3(damage)||typeof damage.formula!="string"){this.system.damage={},delete this.system.heightening,delete this.system.overlays;break}damage.formula=damage.formula?.trim()||"0",damage.kinds=new Set(damage.kinds??["damage"]),(damage.kinds.size===0||this.system.defense?.save?.statistic)&&damage.kinds.add("damage")}const heightening=this.system.heightening;if(heightening?.type==="fixed")for(const heighten of Object.values(heightening.levels))for(const partial of Object.values(heighten.damage??{}).filter(e$1))partial.formula=partial.formula?.trim()||"0";else if(heightening?.type==="interval"){heightening.area??=0;for(const key of Object.keys(heightening.damage??{}))heightening.damage[key]=heightening.damage[key]?.trim()||"0";const castRank=this.rank,timesHeightened=Math.floor((castRank-this.baseRank)/heightening.interval);timesHeightened>0&&this.system.area&&heightening.area&&(this.system.area.value+=heightening.area*timesHeightened)}this.overlays=new SpellOverlayCollection(this,this.system.overlays)}prepareSiblingData(){this.spellcasting?.category==="innate"&&foundry.utils.mergeObject(this.system.location,{uses:{value:1,max:1}},{overwrite:!1})}prepareActorData(){if(!this.actor?.isOfType("character"))return;const{traits}=this;traits.has("focus")&&!traits.has("cantrip")&&(this.actor.system.resources.focus.max+=1)}onPrepareSynthetics(){this.system.cast.focusPoints=Math.clamp(this.system.cast.focusPoints,0,3),processSanctification(this)}getRollOptions(prefix=this.type,options={}){const spellcasting=this.spellcasting,spellOptions=["magical",`${prefix}:rank:${this.rank}`,...this.system.traits.value];spellcasting?.tradition&&spellOptions.push(`${prefix}:trait:${spellcasting.tradition}`),["prepared","spontaneous"].includes(spellcasting?.category??"")&&!this.isCantrip&&!this.parentItem&&spellOptions.push(`${prefix}:spell-slot`),this.isMelee?spellOptions.push(`${prefix}:melee`):this.isRanged&&spellOptions.push(`${prefix}:ranged`),this.system.duration.value||spellOptions.push(`${prefix}:duration:0`),this.atWill||spellOptions.push(`${prefix}:frequency:limited`),spellcasting?.category==="spontaneous"&&this.system.location.signature&&spellOptions.push(`${prefix}:signature`);for(const damage of Object.values(this.system.damage)){damage.type&&(spellOptions.push(`${prefix}:damage:${damage.type}`),spellOptions.push(`${prefix}:damage:type:${damage.type}`));const category=DamageCategorization.fromDamageType(damage.type);category&&spellOptions.push(`${prefix}:damage:category:${category}`),damage.category==="persistent"&&spellOptions.push(`${prefix}:damage:persistent:${damage.type}`)}const area=this.system.area;area&&(spellOptions.push(`${prefix}:area`),spellOptions.push(`${prefix}:area:type:${area.type}`),spellOptions.push(`${prefix}:area:size:${area.value}`),spellOptions.push("area-effect")),this.damageKinds.has("damage")&&(spellOptions.push("damaging-effect"),area&&spellOptions.push("area-damage"));const defense=this.system.defense;defense?.passive?.statistic&&spellOptions.push(`${prefix}:defense:${defense.passive.statistic}`),defense?.save?.statistic&&spellOptions.push(`${prefix}:defense:${defense.save.statistic}`),defense?.save?.basic&&spellOptions.push(`${prefix}:defense:basic`);for(const option of spellcasting?.getRollOptions?.("spellcasting")??[])spellOptions.push(option);const actionCost=this.actionGlyph;if(["1","2","3"].includes(actionCost??"")&&spellOptions.push(`${prefix}:cast:actions:${actionCost}`),options.includeVariants)for(const variant of this.overlays.contents){const additionalTraits=variant.system?.traits?.value??[];for(const trait of additionalTraits)spellOptions.push(`${prefix}:trait:${trait}`)}return[...super.getRollOptions(prefix,options),...spellOptions]}async toMessage(event2,{create=!0,data,rollMode}={}){const domData=htmlClosest(event2?.currentTarget,".item")?.dataset,castData=foundry.utils.mergeObject(data??{},domData??{}),castRank=Number(castData.castRank??"");if(castRank&&castRank!==this.rank)return this.loadVariant({castRank})?.toMessage(event2,{create,data,rollMode});const message=await super.toMessage(event2,{create:!1,data:castData,rollMode});if(!message)return;const messageSource=message.toObject(),flags=messageSource.flags.pf2e,spellcasting=this.spellcasting;if(spellcasting?.statistic){const tradition=spellcasting.tradition??this.traditions.first()??"arcane";if(flags.casting={id:spellcasting.original?.id??spellcasting.id,tradition},this.parentItem&&(flags.casting.embeddedSpell=this.toObject()),this.system.defense){const dc=spellcasting.statistic.withRollOptions({item:this}).dc;flags.context={type:"spell-cast",domains:dc.domains,options:[...dc.options],rollMode}}}return create?ChatMessagePF2e.create(messageSource,{renderSheet:!1}):(message.updateSource(messageSource),message)}async getDescriptionData(){const description=await super.getDescriptionData(),prepend=await createDescriptionPrepend(this,{includeTraditions:!this.actor});return description.value=`${prepend}
${description.value}`,description}async getChatData(htmlOptions={},rollOptions={}){if(!this.actor)throw ErrorPF2e(`Cannot retrieve chat data for unowned spell ${this.name}`);const groupNumber=spellSlotGroupIdToNumber(rollOptions.groupId)||this.rank,castRank=Number(rollOptions.castRank)||this.computeCastRank(groupNumber);if(!this.isVariant){const variant=this.loadVariant({castRank});if(variant)return variant.getChatData(htmlOptions,rollOptions)}const variants=this.overlays.overrideVariants.map(variant=>({...t$3(variant,["name","actionGlyph","sort"]),overlayIds:[...variant.appliedOverlays.values()]})).sort((a,b)=>a.sort-b.sort),rollData=(htmlOptions.rollData instanceof Function?htmlOptions.rollData():htmlOptions.rollData)??this.getRollData({castRank});rollData.item??=this;const systemData=this.system,spellcasting=this.spellcasting;if(!spellcasting)return console.warn(`PF2e System | Orphaned spell ${this.name} (${this.id}) on actor ${this.actor.name} (${this.actor.id})`),{...systemData,traits:this.traitChatData()};const statistic=spellcasting?.statistic;if(!statistic&&!this.isRitual)return console.warn(`PF2e System | Spell ${this.name} is missing a statistic to cast with (${this.id}) on actor ${this.actor.name} (${this.actor.id})`),{...systemData,traits:this.traitChatData()};const statisticChatData=statistic?.getChatData({item:this}),spellDC=statisticChatData?.dc.value,damage=await this.getDamage(),hasDamage=!!damage,saveType=systemData.defense?.save&&tupleHasValue(SAVE_TYPES,systemData.defense.save.statistic)?systemData.defense.save.statistic:null,isSave=!!saveType,saveKey=systemData.defense?.save?.basic?"PF2E.SaveDCLabelBasic":"PF2E.SaveDCLabel",saveLabel=(()=>{if(!(spellDC&&saveType))return null;const localized=game.i18n.format(saveKey,{dc:spellDC,type:game.i18n.localize(CONFIG.PF2E.saves[saveType])}),tempElement=createHTMLElement("div",{innerHTML:localized}),visibility=game.pf2e.settings.metagame.dcs?"all":"owner";return TextEditorPF2e.convertXMLNode(tempElement,"dc",{visibility,whose:null}),tempElement.innerHTML})(),damageKinds=this.damageKinds,damageLabel=damageKinds.has("damage")?damageKinds.has("healing")?"PF2E.Damage.Kind.Both.Roll.Verb":"PF2E.Damage.Kind.Damage.Roll.Verb":"PF2E.Damage.Kind.Healing.Roll.Verb",{baseRank}=this,heightened=castRank-baseRank,rankLabel=createSpellRankLabel(this,castRank),area=this.area,properties=[heightened?game.i18n.format("PF2E.SpellLevelBase",{level:ordinalString(baseRank)}):null,heightened?game.i18n.format("PF2E.SpellLevelHeightened",{heightened}):null].filter(e$1),spellTraits2=this.traitChatData(CONFIG.PF2E.spellTraits,n([...this.system.traits.value,spellcasting.tradition]).filter(e$1)),rarity=this.rarity==="common"?null:{slug:this.rarity,label:CONFIG.PF2E.rarityTraits[this.rarity],description:CONFIG.PF2E.traitsDescriptions[this.rarity]};return this.processChatData(htmlOptions,{...systemData,isAttack:this.isAttack,isSave,check:this.isAttack&&statisticChatData?statisticChatData.check:void 0,save:{...statisticChatData?.dc??{},type:saveType,label:saveLabel},hasDamage,castRank,rankLabel,damageLabel,formula:damage?.template.damage.roll.formula,properties,traits:spellTraits2,rarity,area,variants,isAura:this.system.traits.value.includes("aura")})}async rollAttack(event2,attackNumber=1,context={}){const{statistic,tradition}=this.spellcasting??{};if(!statistic)throw ErrorPF2e("Spell points to location that is not a spellcasting type");return context.extraRollOptions=n(["action:cast-a-spell",...context.extraRollOptions??[]]),statistic.check.roll({...eventToRollParams(event2,{type:"check"}),...context,action:"cast-a-spell",item:this,traits:n([...this.system.traits.value,tradition]).filter(e$5),attackNumber,dc:{slug:this.system.defense?.passive?.statistic??"ac"}})}async rollDamage(event2,mapIncreases){const element=htmlClosest(event2.target,"[data-cast-rank]"),castRank=Number(element?.dataset.castRank)||this.rank;if(!this.isVariant){const variant=this.loadVariant({castRank});if(variant)return variant.rollDamage(event2,mapIncreases)}const targetToken=Array.from(game.user.targets).find(t2=>t2.actor?.isOfType("creature","hazard","vehicle"))?.document??null,spellDamage=await this.getDamage({target:targetToken,...eventToRollParams(event2,{type:"damage"})});if(!spellDamage)return null;const{template,context}=spellDamage;return typeof mapIncreases=="number"&&(context.mapIncreases=mapIncreases,context.options.add(`map:increases:${mapIncreases}`)),DamagePF2e.roll(template,context)}async rollCounteract(event2){if(!this.actor?.isOfType("character","npc"))return null;const spellcasting=this.spellcasting;if(!spellcasting?.statistic?.attribute)return console.warn(ErrorPF2e(`Spell ${this.name} (${this.uuid}) is missing a statistic with which to counteract.`).message),null;const statistic=spellcasting.counteraction;if(!statistic)return null;const domain="counteract-check",localize=localizer("PF2E.Item.Spell.Counteract"),notes=[new RollNotePF2e({selector:domain,text:localize("Hint")}),...DEGREE_OF_SUCCESS_STRINGS.map(degreeString=>{const counteractRank={criticalFailure:0,failure:this.rank,success:this.rank+1,criticalSuccess:this.rank+3}[degreeString];return new RollNotePF2e({selector:domain,title:`PF2E.Check.Result.Degree.Check.${degreeString}`,text:localize(degreeString,{rank:counteractRank}),outcome:[degreeString]})})],traits=n([...this.system.traits.value,spellcasting.tradition]).filter(e$5);return statistic.check.roll({...eventToRollParams(event2,{type:"check"}),label:game.i18n.localize("PF2E.Check.Specific.Counteract"),extraRollNotes:notes,traits})}getOriginData(){const flag=super.getOriginData();return flag.castRank=this.rank,flag.variant=this.isVariant&&this.appliedOverlays?{overlays:[...this.appliedOverlays.values()]}:null,flag}async update(data,operation={}){return this.original&&this.appliedOverlays?.has("override")&&this.sheet.rendered?this.original.overlays.updateOverride(this,data,operation):super.update(data,operation)}async _preCreate(data,options,user){return this.actor||(this._source.system.location={value:null}),this._source.system.ritual&&(this._source.system.damage={},this._source.system.defense=null,this._source.system.location.value=null,this._source.system.traits.value=this._source.system.traits.value.filter(t2=>!["attack","cantrip","focus"].includes(t2)),this._source.system.traits.traditions=[]),super._preCreate(data,options,user)}async _preUpdate(changed,options,user){if(!changed.system)return super._preUpdate(changed,options,user);const newLocation=changed.system.location?.value??this._source.system.location.value;if(this.actor&&changed.system.location&&newLocation!==this._source.system.location.value){const locationUpdates=changed.system.location,keys=Object.keys(this._source.system.location).filter(k=>k!=="value"&&!(k in locationUpdates));for(const key of keys)locationUpdates[`-=${key}`]=null}if(changed.system.level){const level=changed.system.level.value??this._source.system.level.value;changed.system.level.value=Math.clamp(Math.trunc(Number(level)||1),1,10)}const systemChanges=[changed.system,...Object.values(changed.system.overlays??{}).map(o=>o?.system)].filter(e$1);for(const system2 of systemChanges){const areaData=changed.system.area;areaData&&(typeof areaData.value=="number"?(areaData.value=Math.max(5,Math.ceil(areaData.value/5)*5||5),areaData.type||="burst"):(areaData.value===null||!areaData.type)&&(changed.system.area=null));for(const defenseType of["passive","save"]){const newValue=system2.defense?.[defenseType];system2.defense&&newValue?.statistic!==void 0&&!newValue.statistic&&(system2.defense[defenseType]=null)}const newDefenses=foundry.utils.mergeObject(this._source.system.defense??{passive:null,save:null},system2.defense??{},{inplace:!1});!newDefenses.passive&&!newDefenses.save&&(system2.defense=null);for(const partial of Object.values(system2.damage??{}).filter(e$1))typeof partial.category=="string"&&(partial.category||=null),(partial.category||partial?.type&&!["vitality","void","untyped"].includes(partial.type))&&(partial.kinds=["damage"]);if(system2.heightening&&"levels"in system2.heightening)for(const rank of Object.values(system2.heightening.levels??{}).filter(e$1))for(const partial of Object.values(rank.damage??{}))typeof partial?.category=="string"&&(partial.category||=null);const uses=system2.location?.uses;if(uses){const currentUses=uses.value??this.system.location.uses?.value??1,currentMax=uses.max??this.system.location.uses?.max??1;uses.value=Math.clamp(Number(currentUses),0,Number(currentMax))}const traits=system2.traits;traits?.value?.includes("focus")&&(traits.value.includes("cantrip")&&traits.value.splice(traits.value.indexOf("focus"),1),traits.traditions=[])}return super._preUpdate(changed,options,user)}}class SpellcastingEntryPF2e extends ItemPF2e{static{__name(this,"SpellcastingEntryPF2e")}static{__name2(this,"SpellcastingEntryPF2e")}get attribute(){return this.system.ability.value||"cha"}get counteraction(){if(!this.actor)throw ErrorPF2e("Unexpected missing actor");return createCounteractStatistic(this)}get tradition(){const defaultTradition=this.system.prepared.value==="items"?null:"arcane",tradition=this.system.tradition.value;return setHasElement(MAGIC_TRADITIONS,tradition)?tradition:defaultTradition}get category(){return this.system.prepared.value}get rank(){return this.system.proficiency.value??0}get isPrepared(){return this.system.prepared.value==="prepared"}get isFlexible(){return this.isPrepared&&!!this.system.prepared.flexible}get isSpontaneous(){return this.system.prepared.value==="spontaneous"}get isInnate(){return this.system.prepared.value==="innate"}get isFocusPool(){return this.system.prepared.value==="focus"}get isRitual(){return!1}get isEphemeral(){return!1}get highestRank(){return this.spells?.highestRank??0}get showSlotlessRanks(){return this.system.showSlotlessLevels.value}prepareBaseData(){if(super.prepareBaseData(),this.spells=null,this.system.prepared.flexible??=!1,this.system.prepared.validItems||=null,this.isPrepared){const isFlexible=this.isFlexible;for(const[key,group]of Object.entries(this.system.slots)){const emptyList=isFlexible&&key!=="slot0";group.prepared=emptyList?[]:t(Object.values(group.prepared).filter(e$1),s=>s.id===null),group.prepared.length=emptyList?0:group.max;for(const index2 of Array.fromRange(group.prepared.length)){const slot=group.prepared[index2]??={id:null,expended:!1};slot.expended??=!1}}}const actor=this.actor;actor&&(this.statistic=new Statistic(actor,{slug:this.slug??sluggify(this.name),label:"PF2E.Actor.Creature.Spellcasting.InvalidProficiency",check:{type:"check"}}))}prepareSiblingData(){const actor=this.actor;this.spells=new SpellCollection(this);const spells=actor.itemTypes.spell.filter(s=>s.system.location.value===this.id);for(const spell of spells)this.spells.set(spell.id,spell);actor.spellcasting?.collections.set(this.spells.id,this.spells)}prepareActorData(){if((this.spells?.size??0)>0){const rollOptions=this.actor.flags.pf2e.rollOptions;rollOptions.all["self:caster"]=!0,rollOptions.all[`self:caster:tradition:${this.tradition}`]=!0}}prepareStatistic(){const actor=this.actor;if(!actor)return;const{attribute,tradition}=this,slug=this.slug??sluggify(`${this.name}-spellcasting`),baseDomains=["all",`${attribute}-based`,"spell-attack-dc"],checkDomains=[`${tradition}-spell-attack`,"spell-attack","spell-attack-roll","attack","attack-roll"],dcDomains=[`${tradition}-spell-dc`,"spell-dc"];if(actor.isOfType("character")){const baseStat=actor.getStatistic(this.system.proficiency.slug||"base-spellcasting");if(!baseStat)return;this.system.ability.value=baseStat.attribute??this.system.ability.value,this.system.proficiency.value=Math.max(this.rank,baseStat.rank??0),this.statistic=baseStat.extend({slug,label:baseStat.slug==="base-spellcasting"&&tradition?CONFIG.PF2E.magicTraditions[tradition]:baseStat.label,attribute:this.attribute,rank:this.rank,rollOptions:this.getRollOptions("spellcasting"),domains:baseDomains,check:{type:"attack-roll",domains:checkDomains},dc:{domains:dcDomains}})}else if(actor.isOfType("npc")){const adjustment=actor.isElite?2:actor.isWeak?-2:0,baseMod=Number(this.system?.spelldc?.value??0)+adjustment,baseDC=Number(this.system?.spelldc?.dc??0)+adjustment;this.statistic=new Statistic(actor,{slug,attribute:this.attribute,label:CONFIG.PF2E.magicTraditions[tradition??"arcane"],domains:baseDomains,rollOptions:this.getRollOptions("spellcasting"),check:{type:"attack-roll",domains:checkDomains,modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:baseMod})]},dc:{domains:dcDomains,modifiers:[new Modifier({slug:"base",label:"PF2E.ModifierTitle",modifier:baseDC-10})]}})}else throw ErrorPF2e(`Actor type ${actor.type} does not support spellcasting entries`);const stat=actor.isOfType("npc")?{value:this.statistic.dc.value}:{value:this.statistic.dc.value,rank:this.statistic.rank??0},attributes=actor.system.attributes;stat.value>attributes.classOrSpellDC.value&&(attributes.classOrSpellDC=stat),(!attributes.spellDC||stat.value>attributes.spellDC.value)&&(attributes.spellDC=stat)}getLinkedItems(){return this.actor?.itemTypes.spell.filter(i=>i.system.location.value===this.id)??[]}canCast(spell,{origin}={}){if(this.system.prepared.value==="items")return origin?this.system.prepared.validItems==="scroll"?origin.traits.has("scroll"):!0:!1;const isSpellcastingFeature=this.isPrepared||this.isSpontaneous;if(origin&&!isSpellcastingFeature||!this.spells)return!1;const matchesTradition=this.tradition&&spell.traditions.has(this.tradition),isInSpellList=this.spells.some(s=>s.slug===spell.slug);return matchesTradition||isInSpellList}async cast(spell,options={}){const consume=options.consume??!0,message=options.message??!0,rank=options.rank??spell.rank,valid=!consume||spell.atWill||await this.consume(spell,rank,options.slotId);if(message&&valid){spell.system.location.value??=this.id;const castRank=spell.computeCastRank(rank);await spell.toMessage(null,{rollMode:options.rollMode,data:{castRank}})}}async consume(spell,rank,slotIndex){const actor=this.actor;if(!actor?.isOfType("character","npc"))throw ErrorPF2e("Spellcasting entries require an actor");const fpCost=spell.system.cast.focusPoints;if(this.isRitual||(spell.isFocusSpell||spell.isCantrip)&&fpCost===0)return!0;if(spell=spell.original?spell.original:spell,actor.isOfType("character","npc")&&fpCost>0){const currentPoints=actor.system.resources.focus?.value??0;return currentPoints>=fpCost?(await actor.update({"system.resources.focus.value":currentPoints-fpCost}),!0):(ui.notifications.warn(game.i18n.localize("PF2E.Focus.NotEnoughFocusPointsError")),!1)}const rankLabel=game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ordinalString(rank)}),slotKey=rank.between(1,10)?`slot${rank}`:"slot0";if(this.system.slots===null||!this.spells)return!1;if(this.isPrepared&&!this.isFlexible){const slots2=this.system.slots[slotKey].prepared,resolvedIndex=(()=>{if(typeof slotIndex=="number"&&slotIndex>=0&&slots2[slotIndex])return slotIndex;const unexpendedIndex=slots2.findIndex(s=>s.id===spell.id&&!s.expended);if(unexpendedIndex>-1)return unexpendedIndex;const expendedIndex=slots2.findIndex(s=>s.id===spell.id);return expendedIndex>-1?expendedIndex:null})();if(resolvedIndex===null)throw ErrorPF2e("Slot not given for prepared spell, and no alternative slot was found");if(slots2[resolvedIndex].expended)return ui.notifications.warn(game.i18n.format("PF2E.SpellSlotExpendedError",{spell:spell.name})),!1;if(rank.between(1,10)){const groupId=rank;return!!await this.spells.setSlotExpendedState(groupId,resolvedIndex,!0)}}if(this.isInnate){const remainingUses=spell.system.location.uses?.value||0;return remainingUses<=0?(ui.notifications.warn(game.i18n.format("PF2E.SpellSlotExpendedError",{spell:spell.name})),!1):(await spell.update({"system.location.uses.value":remainingUses-1}),!0)}const slots=this.system.slots[slotKey];if(slots.value>0)return await this.update({[`system.slots.${slotKey}.value`]:slots.value-1}),!0;{const rank2=game.i18n.lang==="de"?rankLabel:rankLabel.toLocaleLowerCase(game.i18n.lang);return ui.notifications.warn(game.i18n.format("PF2E.SpellSlotNotEnoughError",{spell:spell.name,rank:rank2})),!1}}async addSpell(spell,{groupId}){return this.spells?.addSpell(spell,{groupId})?spell:null}async prepareSpell(spell,groupId,spellSlot){return this.spells?.prepareSpell(spell,groupId,spellSlot)?this:null}async setSlotExpendedState(groupId,slotId,value){return this.spells?.setSlotExpendedState(groupId,slotId,value)?this:null}async getSheetData({prepList=!1}={}){if(!this.actor?.isOfType("character","npc"))throw ErrorPF2e("Spellcasting entries can only exist on characters and npcs");const defaultData={groups:[],prepList:null},collectionData=this.category==="items"?defaultData:await this.spells?.getSpellData({prepList})??defaultData;return foundry.utils.mergeObject(collectionData,{id:this.id,name:this.name,sort:this.sort,attribute:this.attribute,statistic:this.statistic.getChatData(),tradition:this.tradition,category:this.system.prepared.value,isPrepared:this.isPrepared,isSpontaneous:this.isSpontaneous,isFlexible:this.isFlexible,isInnate:this.isInnate,isFocusPool:this.isFocusPool,isRitual:!1,isEphemeral:!1,hasCollection:!0,usesSpellProficiency:!this.system.proficiency.slug,showSlotlessRanks:this.showSlotlessRanks})}getRollOptions(prefix=this.type){return[`${prefix}:${this.attribute}`,`${prefix}:attribute:${this.attribute}`,`${prefix}:${this.category}`,`${prefix}:category:${this.category}`,`${prefix}:${this.tradition}`,`${prefix}:tradition:${this.tradition}`]}async _preUpdate(changed,options,user){if(changed.system?.slots)for(const key of[0,1,2,3,4,5,6,7,8,9,10]){const slotKey=`slot${key}`,slotData=changed.system.slots[slotKey];if(slotData&&("max"in slotData&&(slotData.max=Math.max(Number(slotData.max)||0,0)),"value"in slotData)){const max="max"in slotData?Number(slotData?.max)||0:this.system.slots[slotKey].max;slotData.value=Math.clamp(Number(slotData.value),0,max)}}return super._preUpdate(changed,options,user)}}function cubic_out(t2){const f=t2-1;return f*f*f+1}__name(cubic_out,"cubic_out"),__name2(cubic_out,"cubic_out");function slide(node,{delay:delay2=0,duration=400,easing=cubic_out,axis="y"}={}){const style=getComputedStyle(node),opacity=+style.opacity,primary_property=axis==="y"?"height":"width",primary_property_value=parseFloat(style[primary_property]),secondary_properties=axis==="y"?["top","bottom"]:["left","right"],capitalized_secondary_properties=secondary_properties.map(e2=>`${e2[0].toUpperCase()}${e2.slice(1)}`),padding_start_value=parseFloat(style[`padding${capitalized_secondary_properties[0]}`]),padding_end_value=parseFloat(style[`padding${capitalized_secondary_properties[1]}`]),margin_start_value=parseFloat(style[`margin${capitalized_secondary_properties[0]}`]),margin_end_value=parseFloat(style[`margin${capitalized_secondary_properties[1]}`]),border_width_start_value=parseFloat(style[`border${capitalized_secondary_properties[0]}Width`]),border_width_end_value=parseFloat(style[`border${capitalized_secondary_properties[1]}Width`]);return{delay:delay2,duration,easing,css:__name2(t2=>`overflow: hidden;opacity: ${Math.min(t2*20,1)*opacity};${primary_property}: ${t2*primary_property_value}px;padding-${secondary_properties[0]}: ${t2*padding_start_value}px;padding-${secondary_properties[1]}: ${t2*padding_end_value}px;margin-${secondary_properties[0]}: ${t2*margin_start_value}px;margin-${secondary_properties[1]}: ${t2*margin_end_value}px;border-${secondary_properties[0]}-width: ${t2*border_width_start_value}px;border-${secondary_properties[1]}-width: ${t2*border_width_end_value}px;min-${primary_property}: 0`,"css")}}__name(slide,"slide"),__name2(slide,"slide");var root_6$2=from_html('<span class="tag light property"> </span>'),root_5$3=from_html('<div class="tags"></div>'),root_7$1=from_html('<div class="level"> </div>'),root_8=from_html("<section><div> </div> <div> </div></section>"),root_2$6=from_html("<!> <!> <!>",1),root_9=from_html('<section class="description gm-notes svelte-nyo51b"><!></section>'),root_1$7=from_html('<div class="item-summary svelte-nyo51b"><!> <!> <div class="description"><!></div></div>');function Item_summary($$anchor,$$props){push($$props,!0);const exclude=prop($$props,"exclude",19,()=>[]);let chatData=state(null),identified=state(!1),itemLevel=state(null),priceString=state("");async function loadItemData(){const document2=await fromUuid($$props.uuid),isEffect=document2 instanceof AbstractEffectPF2e,price=document2?.isOfType("physical")?document2.price:null;set(chatData,await document2?.getChatData()??null,!0),get(chatData)&&document2&&(set(identified,game.user.isGM||!(document2.isOfType("physical")||isEffect)||document2.isIdentified,!0),set(itemLevel,"level"in document2&&typeof document2.level=="number"?document2.level:null,!0),set(priceString,price?.value.toString()??"",!0))}__name(loadItemData,"loadItemData"),__name2(loadItemData,"loadItemData"),user_effect(()=>{$$props.open&&loadItemData()});var fragment=comment(),node=first_child(fragment);{var consequent_6=__name2($$anchor2=>{var div=root_1$7(),node_1=child(div);{var consequent_4=__name2($$anchor3=>{var fragment_1=root_2$6(),node_2=first_child(fragment_1);{var consequent=__name2($$anchor4=>{{let $0=user_derived(()=>get(chatData).rarity?.slug),$1=user_derived(()=>get(chatData).traits??[]);Item_traits($$anchor4,{get rarity(){return get($0)},get traits(){return get($1)},get properties(){return get(chatData).properties}})}},"consequent"),alternate=__name2($$anchor4=>{var fragment_3=comment(),node_3=first_child(fragment_3);{var consequent_1=__name2($$anchor5=>{var div_1=root_5$3();each(div_1,20,()=>get(chatData).properties,property=>property,($$anchor6,property)=>{var span=root_6$2(),text2=child(span);template_effect($0=>set_text(text2,$0),[()=>game.i18n.localize(property)]),append($$anchor6,span)}),append($$anchor5,div_1)},"consequent_1");if_block(node_3,$$render=>{get(chatData).properties?.length&&$$render(consequent_1)},!0)}append($$anchor4,fragment_3)},"alternate");if_block(node_2,$$render=>{exclude().includes("traits")?$$render(alternate,!1):$$render(consequent)})}var node_4=sibling(node_2,2);{var consequent_2=__name2($$anchor4=>{var div_2=root_7$1(),text_1=child(div_2);template_effect(()=>set_text(text_1,get(chatData).levelLabel)),append($$anchor4,div_2)},"consequent_2");if_block(node_4,$$render=>{get(chatData).levelLabel&&$$render(consequent_2)})}var node_5=sibling(node_4,2);{var consequent_3=__name2($$anchor4=>{var section=root_8(),div_3=child(section),text_2=child(div_3),div_4=sibling(div_3,2),text_3=child(div_4);template_effect(($0,$1)=>{set_text(text_2,$0),set_text(text_3,$1)},[()=>game.i18n.format("PF2E.Item.Physical.LevelLabel",{level:get(itemLevel)}),()=>game.i18n.format("PF2E.Item.Physical.PriceLabel",{price:get(priceString)})]),append($$anchor4,section)},"consequent_3");if_block(node_5,$$render=>{get(priceString)&&!exclude().includes("price")&&$$render(consequent_3)})}append($$anchor3,fragment_1)},"consequent_4");if_block(node_1,$$render=>{get(identified)&&$$render(consequent_4)})}var node_6=sibling(node_1,2);{var consequent_5=__name2($$anchor3=>{var section_1=root_9(),node_7=child(section_1);html(node_7,()=>get(chatData).description.gm),append($$anchor3,section_1)},"consequent_5");if_block(node_6,$$render=>{get(chatData).description.gm&&$$render(consequent_5)})}var div_5=sibling(node_6,2),node_8=child(div_5);html(node_8,()=>get(chatData).description.value),transition(3,div,()=>slide,()=>({duration:500})),append($$anchor2,div)},"consequent_6");if_block(node,$$render=>{$$props.open&&get(chatData)&&$$render(consequent_6)})}append($$anchor,fragment),pop()}__name(Item_summary,"Item_summary"),__name2(Item_summary,"Item_summary");var root$b=from_html('<button><img alt="" class="svelte-cip8r4"/> <i></i></button>');function Hover_icon_button($$anchor,$$props){push($$props,!0);const args=rest_props($$props,["$$slots","$$events","$$legacy","src","icon"]);var button=root$b();attribute_effect(button,()=>({...args,class:`flat ${$$props.class??""}`}),void 0,void 0,"svelte-cip8r4");var img2=child(button),i=sibling(img2,2);template_effect(()=>{set_attribute(img2,"src",$$props.src),set_class(i,1,clsx($$props.icon),"svelte-cip8r4")}),append($$anchor,button),pop()}__name(Hover_icon_button,"Hover_icon_button"),__name2(Hover_icon_button,"Hover_icon_button");var root_1$6=from_html('<p class="notification warning"></p>'),on_click$3=__name2((_,openStates,formula)=>openStates[get(formula).item.uuid]=!openStates[get(formula).item.uuid],"on_click$3"),on_click_1$2=__name2((__1,$$props,formula)=>$$props.ability.setFormulaQuantity(get(formula).item.uuid,"decrease"),"on_click_1$2"),on_click_2$1=__name2((__2,$$props,formula)=>$$props.ability.setFormulaQuantity(get(formula).item.uuid,"increase"),"on_click_2$1"),root_4$1=from_html('<div class="quantity svelte-17fwdag"><button type="button" class="subtract svelte-17fwdag" data-tooltip="PF2E.Actor.Character.Crafting.DecreaseQuantity" aria-labelledby="tooltip"><i class="fa-solid fa-minus svelte-17fwdag"></i></button> <input type="number" placeholder="0"/> <button type="button" class="plus svelte-17fwdag" data-tooltip="PF2E.Actor.Character.Crafting.IncreaseQuantity" aria-labelledby="tooltip"><i class="fa-solid fa-plus svelte-17fwdag"></i></button></div>'),on_click_3=__name2((__3,formula,$$props)=>get(formula).selected?$$props.onDeselect(get(formula).item.uuid):$$props.onSelect(get(formula).item.uuid),"on_click_3"),root_5$2=from_html('<button type="button" aria-labelledby="tooltip"><i class="fa-solid fa-fw fa-check svelte-17fwdag"></i></button>'),root_3$5=from_html('<li><!> <button class="name flat svelte-17fwdag"><span> </span> <!></button> <!> <!></li>'),root_2$5=from_html('<header class="svelte-17fwdag"> </header> <ol class="items-list svelte-17fwdag"></ol>',1),root$a=from_html('<header class="sheet-header svelte-17fwdag"><p class="hint"> </p> <div class="search svelte-17fwdag"><input type="search" spellcheck="false"/></div> <!></header> <section class="content svelte-17fwdag"></section>',1);function App$1($$anchor,$$props){push($$props,!0);const openStates=proxy({});let queryText=state("");const filteredSections=user_derived(()=>{if(get(queryText).trim().length<=1)return $$props.state.sections;const results=new Set($$props.searchEngine.search(get(queryText)).map(r2=>r2.id));return $$props.state.sections.map(s=>({...s,formulas:s.formulas.filter(f=>results.has(f.item.id))})).filter(s=>s.formulas.length)});var fragment=root$a(),header=first_child(fragment),p=child(header),text2=child(p),div=sibling(p,2),input=child(div);set_attribute(input,"placeholder",game.i18n.localize("PF2E.Actor.Character.Crafting.Search"));var node=sibling(div,2);{var consequent=__name2($$anchor2=>{var p_1=root_1$6();p_1.textContent=game.i18n.localize("PF2E.Actor.Character.Crafting.MissingResource"),append($$anchor2,p_1)},"consequent");if_block(node,$$render=>{!$$props.ability.isPrepared&&!$$props.state.resource?.value&&$$render(consequent)})}var section_1=sibling(header,2);each(section_1,21,()=>get(filteredSections),section=>section.level,($$anchor2,section)=>{var fragment_1=root_2$5(),header_1=first_child(fragment_1),text_1=child(header_1),ol=sibling(header_1,2);each(ol,21,()=>get(section).formulas,formula=>formula.item.id,($$anchor3,formula)=>{var li=root_3$5();let classes;var node_1=child(li);Hover_icon_button(node_1,{class:"item-image",get src(){return get(formula).item.img},icon:"fa-solid fa-message",onclick:__name2(event2=>sendItemToChat(get(formula).item.uuid,{event:event2,actor:$$props.actor}),"onclick")});var button=sibling(node_1,2);button.__click=[on_click$3,openStates,formula];var span=child(button),text_2=child(span),node_2=sibling(span,2);Item_traits(node_2,{get traits(){return get(formula).item.traits},get rarity(){return get(formula).item.rarity}});var node_3=sibling(button,2);{var consequent_1=__name2($$anchor4=>{var div_1=root_4$1(),button_1=child(div_1);button_1.__click=[on_click_1$2,$$props,formula];var input_1=sibling(button_1,2);let classes_1;var button_2=sibling(input_1,2);button_2.__click=[on_click_2$1,$$props,formula],template_effect($0=>{button_1.disabled=get(formula).quantity===0,set_value(input_1,get(formula).quantity||null),classes_1=set_class(input_1,1,"svelte-17fwdag",null,classes_1,$0)},[()=>({selected:get(formula).selected})]),event$1("blur",input_1,event2=>{$$props.ability.setFormulaQuantity(get(formula).item.uuid,Number(event2.currentTarget.value||0)),event2.currentTarget.value=String(get(formula).quantity||"")}),append($$anchor4,div_1)},"consequent_1"),alternate=__name2($$anchor4=>{var button_3=root_5$2();let classes_2;button_3.__click=[on_click_3,formula,$$props],template_effect($0=>{classes_2=set_class(button_3,1,"select svelte-17fwdag",null,classes_2,$0),set_attribute(button_3,"data-tooltip",get(formula).selected?"Cancel":"Confirm")},[()=>({selected:get(formula).selected})]),append($$anchor4,button_3)},"alternate");if_block(node_3,$$render=>{$$props.mode==="prepare"?$$render(consequent_1):$$render(alternate,!1)})}var node_4=sibling(node_3,2);{let $0=user_derived(()=>!!openStates[get(formula).item.uuid]);Item_summary(node_4,{get uuid(){return get(formula).item.uuid},get open(){return get($0)},exclude:["traits","price"]})}template_effect($0=>{classes=set_class(li,1,"item svelte-17fwdag",null,classes,$0),set_attribute(button,"data-rarity",get(formula).item.rarity),set_text(text_2,get(formula).item.name)},[()=>({selected:get(formula).selected,faded:$$props.mode==="prepare"&&!get(formula).selected})]),append($$anchor3,li)}),template_effect($0=>set_text(text_1,$0),[()=>game.i18n.format("PF2E.LevelN",{level:get(section).level})]),append($$anchor2,fragment_1)}),template_effect(()=>set_text(text2,$$props.state.prompt)),bind_value(input,()=>get(queryText),$$value=>set(queryText,$$value)),append($$anchor,fragment),pop()}__name(App$1,"App$1"),__name2(App$1,"App$1"),delegate(["click"]);class FormulaPicker extends SvelteApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"FormulaPicker")}static{__name2(this,"FormulaPicker")}static DEFAULT_OPTIONS={id:"{id}-formula-picker",position:{width:480,height:600},window:{icon:"fa-solid fa-toolbox",contentClasses:["standard-form","compact"],resizable:!0},onSelect:__name2(()=>{},"onSelect"),onDeselect:__name2(()=>{},"onDeselect")};root=App$1;#resolve;#searchEngine=new MiniSearch({fields:["name"],idField:"id",processTerm:__name2(t2=>t2.length>1?t2.toLocaleLowerCase(game.i18n.lang):null,"processTerm"),searchOptions:{combineWith:"AND",prefix:!0}});selection=null;constructor(options){super(options)}get title(){return this.options.item?.name??this.options.ability.label}async _onFirstRender(context,options){await super._onFirstRender(context,options),this.options.actor.apps[this.id]=this}_onClose(options){delete this.options.actor.apps[this.id],super._onClose(options),this.#resolve?.(this.selection)}async resolveSelection(){return this.render({force:!0}),new Promise(resolve=>{this.#resolve=resolve})}async _prepareContext(){const{actor,ability,mode}=this.options,formulas=await ability.getValidFormulas(),sheetData=await ability.getSheetData(),resource=sheetData.resource;this.#searchEngine.removeAll(),this.#searchEngine.addAll(formulas.map(f=>t$3(f.item,["id","name"])));const prompt=mode==="prepare"?game.i18n.format("PF2E.Actor.Character.Crafting.PrepareHint",{remaining:sheetData.remainingSlots}):resource?game.i18n.format("PF2E.Actor.Character.Crafting.Action.Hint",{resource:resource.label,value:resource.value,max:resource.max}):game.i18n.localize("PF2E.Actor.Character.Crafting.Action.HintResourceless");return{foundryApp:this,actor,ability,mode:this.options.mode,onSelect:__name2(uuid=>{if(this.#resolve){const item=formulas.find(f=>f.item.uuid===uuid)?.item;this.selection=item??null,this.close()}else mode==="prepare"&&ability.prepareFormula(uuid)},"onSelect"),onDeselect:__name2(uuid=>{mode==="prepare"&&ability.unprepareFormula(uuid)},"onDeselect"),searchEngine:this.#searchEngine,state:{name:this.options.item?.name??ability.label,resource,prompt,sections:t$a(formulas.map(f=>{const preparedQuantity=mode==="prepare"?ability.preparedFormulaData.filter(d=>d.uuid===f.item.uuid).reduce((sum,v)=>sum+(v.quantity??1),0):0;return{item:{...t$3(f.item,["id","uuid","img","name"]),type:f.item.type,level:f.item.level,rarity:f.item.rarity,traits:f.item.traitChatData()},quantity:mode==="prepare"?preparedQuantity:f.batchSize,selected:preparedQuantity>0}}),t$2(f=>f.item.level||0),t$f(),t$b(([level,formulas2])=>({level:Number(level),formulas:formulas2})),t(s=>-s.level))}}}}function isCheckContextFlag(flag){return!!flag&&!tupleHasValue(["damage-roll","spell-cast"],flag.type)}__name(isCheckContextFlag,"isCheckContextFlag"),__name2(isCheckContextFlag,"isCheckContextFlag");async function createUseActionMessage(item,rollMode="roll"){const{actor,actionCost}=item,token=actor.getActiveTokens(!0,!0).shift()??null;if(item.system.frequency&&item.system.frequency.value>0){const newValue=item.system.frequency.value-1;await item.update({"system.frequency.value":newValue})}const craftingAbility=item.crafting,resource=craftingAbility?.resource?actor.getResource(craftingAbility.resource):null,isCraftingAction=!!craftingAbility&&!!resource&&actor.isOfType("character"),consumeResources=!!resource?.value,craftedItem=await(async()=>{if(!isCraftingAction)return null;const selection=await new FormulaPicker({actor,item,ability:craftingAbility,mode:"craft"}).resolveSelection();return selection?craftingAbility.craft(selection,{consume:consumeResources,destination:"hand"}):null})();if(!craftedItem&&isCraftingAction)return null;if(!item.system.selfEffect&&!craftedItem)return await item.toMessage(null,{rollMode})??null;const speaker=ChatMessagePF2e.getSpeaker({actor,token}),flavor=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{title:item.name,glyph:getActionGlyph(actionCost)},item,traits:item.system.traits.value.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.actionTraits))}),content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/action/collapsed.hbs",{actor:item.actor,description:item.description,selfEffect:!!item.system.selfEffect,craftedItem:craftedItem?.toAnchor({attrs:{draggable:"true"}}).outerHTML,withoutResources:craftedItem&&!consumeResources,activate:craftedItem?.type==="consumable"&&craftedItem.system.usage.type==="held"?craftedItem:null}),flags={pf2e:{}};item.system.selfEffect?flags.pf2e.context={type:"self-effect",item:item.id}:flags.pf2e.origin=item.getOriginData();const messageData=ChatMessagePF2e.applyRollMode({speaker,flavor,content,flags},rollMode);return await ChatMessagePF2e.create(messageData)??null}__name(createUseActionMessage,"createUseActionMessage"),__name2(createUseActionMessage,"createUseActionMessage");async function applyDamageFromMessage({message,multiplier=1,addend=0,promptModifier=!1,rollIndex=0}){if(promptModifier)return shiftAdjustDamage(message,multiplier,rollIndex);const tokens=htmlQuery(ui.chat.element,`li.chat-message[data-message-id="${message.id}"]`)?.dataset.actorIsTarget&&message.token?[message.token]:game.user.getActiveTokens();if(tokens.length===0){ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected",{localize:!0});return}const shieldBlockRequest=CONFIG.PF2E.chatDamageButtonShieldToggle,roll=message.rolls.at(rollIndex);if(!(roll instanceof DamageRoll))throw ErrorPF2e("Unexpected error retrieving damage roll");const damage=multiplier<0?multiplier*roll.total+addend:roll.alter(multiplier,addend),messageRollOptions=[...message.flags.pf2e.context?.options??[]],originRollOptions=messageRollOptions.filter(o=>o.startsWith("self:")).map(o=>o.replace(/^self\b/,"origin")),messageItem=message.item,effectRollOptions=messageItem?.isOfType("affliction","condition","effect")?messageItem.getRollOptions("item"):[];for(const token of tokens){if(!token.actor)continue;if(token.actor.alliance&&message.actor){const allyOrEnemy=token.actor.alliance===message.actor.alliance?"ally":"enemy";messageRollOptions.push(`origin:${allyOrEnemy}`)}messageRollOptions.some(o=>o.startsWith("target"))||messageRollOptions.push(...token.actor.getSelfRollOptions("target"));const domain=multiplier>0?"damage-received":"healing-received",ephemeralEffects=multiplier>0?await extractEphemeralEffects({affects:"target",origin:message.actor,target:token.actor,item:messageItem,domains:[domain],options:messageRollOptions}):[],contextClone=token.actor.getContextualClone(originRollOptions,ephemeralEffects),rollOptions=new Set([...messageRollOptions.filter(o=>!/^(?:self|target)(?::|$)/.test(o)),...effectRollOptions,...originRollOptions,...contextClone.getSelfRollOptions()]);await contextClone.applyDamage({damage,token,item:messageItem,skipIWR:multiplier<=0,rollOptions,shieldBlockRequest,outcome:message.flags.pf2e.context?.outcome})}toggleOffShieldBlock(message.id)}__name(applyDamageFromMessage,"applyDamageFromMessage"),__name2(applyDamageFromMessage,"applyDamageFromMessage");async function shiftAdjustDamage(message,multiplier,rollIndex){const content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/damage/adjustment-dialog.hbs"),AdjustmentDialog=class extends foundry.appv1.api.Dialog{static{__name(this,"AdjustmentDialog")}static{__name2(this,"AdjustmentDialog")}activateListeners($html){super.activateListeners($html),$html[0].querySelector("input")?.focus()}},isHealing=multiplier<0;new AdjustmentDialog({title:game.i18n.localize(isHealing?"PF2E.UI.shiftModifyHealingTitle":"PF2E.UI.shiftModifyDamageTitle"),content,buttons:{ok:{label:game.i18n.localize("PF2E.OK"),callback:__name2(async $dialog=>{const adjustment=(Number($dialog[0].querySelector("input")?.value)||0)*Math.sign(multiplier);applyDamageFromMessage({message,multiplier,addend:adjustment,promptModifier:!1,rollIndex})},"callback")},cancel:{label:"Cancel"}},default:"ok",close:__name2(()=>{toggleOffShieldBlock(message.id)},"close")}).render(!0)}__name(shiftAdjustDamage,"shiftAdjustDamage"),__name2(shiftAdjustDamage,"shiftAdjustDamage");function toggleOffShieldBlock(messageId){for(const app of["#chat-log","#chat-popout"]){const selector=`${app} > li.chat-message[data-message-id="${messageId}"] button[data-action=shield-block]`;htmlQuery(document.body,selector)?.classList.remove("shield-activated")}CONFIG.PF2E.chatDamageButtonShieldToggle=!1}__name(toggleOffShieldBlock,"toggleOffShieldBlock"),__name2(toggleOffShieldBlock,"toggleOffShieldBlock");function toggleClearTemplatesButton(message){if(!message||!canvas.ready)return;const selector=`li[data-message-id="${message.id}"] button[data-action=spell-template-clear]`;for(const chatLogDOM of htmlQueryAll(document.body,"#chat, #chat-popout")){const clearTemplatesButton=htmlQuery(chatLogDOM,selector);if(!clearTemplatesButton)continue;const hasMeasuredTemplates=!!canvas.scene?.templates.some(t2=>t2.message===message&&t2.isOwner);clearTemplatesButton.classList.toggle("hidden",!hasMeasuredTemplates)}}__name(toggleClearTemplatesButton,"toggleClearTemplatesButton"),__name2(toggleClearTemplatesButton,"toggleClearTemplatesButton");const CanvasReady={listen:__name2(()=>{Hooks.once("canvasReady",()=>{const tokenActors=canvas.scene?.tokens.contents.flatMap(t2=>t2.actor??[])??[];for(const actor of tokenActors)for(const effect of actor.itemTypes.effect.filter(e2=>e2.fromAura))game.pf2e.effectTracker.register(effect)}),Hooks.on("canvasReady",()=>{if(game.pf2e.effectPanel.render({force:!0}),!!canvas.scene){game.ready&&canvas.scene.reset(),CONFIG.MeasuredTemplate.defaults.angle=canvas.grid.isHexagonal?60:90;for(const token of canvas.tokens.placeables)token.visible&&token.renderFlags.set({redrawEffects:!0});for(const message of game.messages.contents.slice(-1*CONFIG.ChatMessage.batchSize/2))toggleClearTemplatesButton(message)}})},"listen")},CloseWorldClockSettings={listen:__name2(()=>{Hooks.on("closeWorldClockSettings",()=>{game.user.isGM&&game.socket.emit("system.pf2e",{request:"refreshSceneControls",data:{layer:"TokenLayer"}})})},"listen")},isDice3D=__name2(obj=>obj instanceof Object&&["addSystem","addDicePreset","addTexture","addColorset"].every(m=>m in obj),"isDice3D"),DiceSoNiceReady={listen:__name2(()=>{Hooks.once("diceSoNiceReady",dice3d=>{if(isDice3D(dice3d)){dice3d.addSystem({id:"basic",name:"Dicefinder Basic",colorset:"basic"});for(const faces of[4,6,8,10,12])dice3d.addDicePreset({type:`d${faces}`,labels:[...Array(faces)].map((_value,idx)=>String(idx+1)),system:"basic",colorset:"basic"});dice3d.addDicePreset({type:"d20",labels:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","systems/pf2e/dice/basic/nat20.webp"],system:"basic",colorset:"basic"}),dice3d.addDicePreset({type:"dc",labels:["systems/pf2e/dice/basic/tail.webp","systems/pf2e/dice/basic/heads.webp"],system:"basic",colorset:"basic"}),dice3d.addDicePreset({type:"d2",labels:["systems/pf2e/dice/basic/tail_bump.webp","systems/pf2e/dice/basic/heads_bump.webp"],system:"basic",colorset:"basic"}),dice3d.addDicePreset({type:"d100",labels:[...Array(10)].map((_value,idx)=>String((idx+1)*10)),system:"basic",colorset:"basic"}),dice3d.addDicePreset({type:"df",labels:["-","","+"],system:"basic",colorset:"basic"}),dice3d.addTexture("PFred",{name:"Pathfinder Red",composite:"source-over",source:"systems/pf2e/dice/texture/texture.webp"}).then(()=>{dice3d.addColorset({name:"basic",description:"Dicefinder Basic",category:"Pathfinder 2e",texture:"PFred",material:"metal",foreground:"#f9b96e",outline:"none",edge:"#f9b96e",visibility:"hidden"})}),dice3d.addSystem({id:"campaign",name:"Dicefinder Campaign",colorset:"campaign"}),dice3d.addDicePreset({type:"dc",labels:["systems/pf2e/dice/basic/tail.webp","systems/pf2e/dice/basic/heads.webp"],system:"campaign",colorset:"campaign"}),dice3d.addDicePreset({type:"d2",labels:["systems/pf2e/dice/basic/tail_bump.webp","systems/pf2e/dice/basic/heads_bump.webp"],system:"campaign",colorset:"campaign"}),dice3d.addDicePreset({type:"d4",labels:["systems/pf2e/dice/campaign/d4/d4-1.webp","systems/pf2e/dice/campaign/d4/d4-2.webp","systems/pf2e/dice/campaign/d4/d4-3.webp","systems/pf2e/dice/campaign/d4/d4-4.webp"],system:"campaign",colorset:"campaign"}),dice3d.addDicePreset({type:"d6",labels:["systems/pf2e/dice/campaign/d6/d6-1.webp","systems/pf2e/dice/campaign/d6/d6-2.webp","systems/pf2e/dice/campaign/d6/d6-3.webp","systems/pf2e/dice/campaign/d6/d6-4.webp","systems/pf2e/dice/campaign/d6/d6-5.webp","systems/pf2e/dice/campaign/d6/d6-6.webp"],system:"campaign",colorset:"campaign"}),dice3d.addDicePreset({type:"df",labels:["systems/pf2e/dice/campaign/df/dfm.webp","systems/pf2e/dice/campaign/df/df.webp","systems/pf2e/dice/campaign/df/dfp.webp"],system:"campaign",colorset:"campaign"}),dice3d.addDicePreset({type:"d8",labels:["systems/pf2e/dice/campaign/d8/d8-1.webp","systems/pf2e/dice/campaign/d8/d8-2.webp","systems/pf2e/dice/campaign/d8/d8-3.webp","systems/pf2e/dice/campaign/d8/d8-4.webp","systems/pf2e/dice/campaign/d8/d8-5.webp","systems/pf2e/dice/campaign/d8/d8-6.webp","systems/pf2e/dice/campaign/d8/d8-7.webp","systems/pf2e/dice/campaign/d8/d8-P.webp"],system:"campaign",colorset:"campaign"}),dice3d.addDicePreset({type:"d10",labels:["systems/pf2e/dice/campaign/d10/d10-1.webp","systems/pf2e/dice/campaign/d10/d10-2.webp","systems/pf2e/dice/campaign/d10/d10-3.webp","systems/pf2e/dice/campaign/d10/d10-4.webp","systems/pf2e/dice/campaign/d10/d10-5.webp","systems/pf2e/dice/campaign/d10/d10-6.webp","systems/pf2e/dice/campaign/d10/d10-7.webp","systems/pf2e/dice/campaign/d10/d10-8.webp","systems/pf2e/dice/campaign/d10/d10-9.webp","systems/pf2e/dice/campaign/d10/d10-10.webp"],system:"campaign",colorset:"campaign"}),dice3d.addDicePreset({type:"d12",labels:["systems/pf2e/dice/campaign/d12/d12-1.webp","systems/pf2e/dice/campaign/d12/d12-2.webp","systems/pf2e/dice/campaign/d12/d12-3.webp","systems/pf2e/dice/campaign/d12/d12-4.webp","systems/pf2e/dice/campaign/d12/d12-5.webp","systems/pf2e/dice/campaign/d12/d12-6.webp","systems/pf2e/dice/campaign/d12/d12-7.webp","systems/pf2e/dice/campaign/d12/d12-8.webp","systems/pf2e/dice/campaign/d12/d12-9.webp","systems/pf2e/dice/campaign/d12/d12-10.webp","systems/pf2e/dice/campaign/d12/d12-11.webp","systems/pf2e/dice/campaign/d12/d12-12.webp"],system:"campaign",colorset:"campaign"}),dice3d.addDicePreset({type:"d100",labels:["systems/pf2e/dice/campaign/d100/d100-10.webp","systems/pf2e/dice/campaign/d100/d100-20.webp","systems/pf2e/dice/campaign/d100/d100-30.webp","systems/pf2e/dice/campaign/d100/d100-40.webp","systems/pf2e/dice/campaign/d100/d100-50.webp","systems/pf2e/dice/campaign/d100/d100-60.webp","systems/pf2e/dice/campaign/d100/d100-70.webp","systems/pf2e/dice/campaign/d100/d100-80.webp","systems/pf2e/dice/campaign/d100/d100-90.webp","systems/pf2e/dice/campaign/d100/d100-100.webp"],system:"campaign",colorset:"campaign"}),dice3d.addDicePreset({type:"d20",labels:["systems/pf2e/dice/campaign/d20/d20-1.webp","systems/pf2e/dice/campaign/d20/d20-2.webp","systems/pf2e/dice/campaign/d20/d20-3.webp","systems/pf2e/dice/campaign/d20/d20-4.webp","systems/pf2e/dice/campaign/d20/d20-5.webp","systems/pf2e/dice/campaign/d20/d20-6.webp","systems/pf2e/dice/campaign/d20/d20-7.webp","systems/pf2e/dice/campaign/d20/d20-8.webp","systems/pf2e/dice/campaign/d20/d20-9.webp","systems/pf2e/dice/campaign/d20/d20-10.webp","systems/pf2e/dice/campaign/d20/d20-11.webp","systems/pf2e/dice/campaign/d20/d20-12.webp","systems/pf2e/dice/campaign/d20/d20-13.webp","systems/pf2e/dice/campaign/d20/d20-14.webp","systems/pf2e/dice/campaign/d20/d20-15.webp","systems/pf2e/dice/campaign/d20/d20-16.webp","systems/pf2e/dice/campaign/d20/d20-17.webp","systems/pf2e/dice/campaign/d20/d20-18.webp","systems/pf2e/dice/campaign/d20/d20-19.webp","systems/pf2e/dice/campaign/d20/d20-20.webp"],system:"campaign",colorset:"campaign"}),dice3d.addTexture("stoneD4",{name:"Pathfinder Stone (D4)",composite:"source-over",source:"systems/pf2e/dice/texture/d4.webp"}).then(()=>{dice3d.addColorset({name:"campaign",description:"Dicefinder Campaign",category:"Pathfinder 2e",texture:"stoneD4",material:"stone",foreground:"#5c2f00",outline:"none",edge:"#f9b96e",visibility:"hidden"})}),dice3d.addSystem({id:"darkmode",name:"Dicefinder Dark Mode",colorset:"darkmode"});for(const faces of[4,6,8,10,12])dice3d.addDicePreset({type:`d${faces}`,labels:[...Array(faces)].map((_value,idx)=>String(idx+1)),system:"darkmode",colorset:"darkmode"});dice3d.addDicePreset({type:"d100",labels:[...Array(10)].map((_value,idx)=>String((idx+1)*10)),system:"darkmode",colorset:"darkmode"}),dice3d.addDicePreset({type:"df",labels:["-","","+"],system:"darkmode",colorset:"darkmode"}),dice3d.addDicePreset({type:"d20",labels:["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","systems/pf2e/dice/basic/nat20.webp"],system:"darkmode",colorset:"darkmode"}),dice3d.addDicePreset({type:"dc",labels:["systems/pf2e/dice/basic/tail.webp","systems/pf2e/dice/basic/heads.webp"],system:"darkmode",colorset:"darkmode"}),dice3d.addDicePreset({type:"d2",labels:["systems/pf2e/dice/basic/tail_bump.webp","systems/pf2e/dice/basic/heads_bump.webp"],system:"darkmode",colorset:"darkmode"}),dice3d.addTexture("darkModeBlack",{name:"Dark Mode Black",composite:"source-over",source:"systems/pf2e/dice/texture/transparent.webp"}).then(()=>{dice3d.addColorset({name:"darkmode",description:"Dicefinder Dark Mode",category:"Pathfinder 2e",texture:"darkModeBlack",material:"metal",foreground:"#f9b96e",outline:"none",edge:"#f9b96e",visibility:"hidden"})})}})},"listen")},DiceSoNiceRollStart={listen:__name2(()=>{Hooks.on("diceSoNiceRollStart",(...[messageId,context])=>{if(!game.user.isGM&&typeof messageId=="string"&&e$3(context)){const messageRolls=game.messages.get(messageId)?.rolls;"roll"in context&&e$3(context.roll)&&messageRolls?.every(r2=>r2.options.showBreakdown===!1)&&(context.roll.ghost=!0)}})},"listen")},DropCanvasData={listen:__name2(()=>{Hooks.on("dropCanvasData",(_canvas,data,event2)=>{if(!(data.type==="Item"||data.type==="PersistentDamage"))return!0;const dropTarget=canvas.tokens.quadtree.getObjects(new PIXI.Rectangle(data.x,data.y)).values().toArray().sort((a,b)=>b.document.elevation-a.document.elevation||b.document.sort-a.document.sort).find(t2=>t2.visible);if(dropTarget?.actor){const dataTransfer=new DataTransfer;dataTransfer.setData("text/plain",JSON.stringify(data));const newEvent=new DragEvent("drop",{altKey:event2.altKey,shiftKey:event2.shiftKey,dataTransfer});return dropTarget.actor.sheet._onDrop(newEvent),!1}return!0})},"listen")},GetProseMirrorMenuDropDowns={listen:__name2(()=>{Hooks.on("getProseMirrorMenuDropDowns",(menu,dropdowns)=>{const toggleMark=foundry.prosemirror.commands.toggleMark,wrapIn=foundry.prosemirror.commands.wrapIn;"format"in dropdowns&&dropdowns.format.entries.push({action:"pf2e",title:"PF2e",children:[{action:"pf2e-action-glyph",title:"Icons 1 2 3 F R",mark:menu.schema.marks.span,attrs:{_preserve:{class:"action-glyph"}},priority:1,cmd:toggleMark(menu.schema.marks.span,{_preserve:{class:"action-glyph"}})},{action:"pf2e-inline-header",class:"inline-header",title:"Inline Header",node:menu.schema.nodes.heading,attrs:{_preserve:{class:"inline-header"},level:4},priority:0,cmd:__name2(()=>(menu._toggleTextBlock(menu.schema.nodes.heading,{attrs:{_preserve:{class:"inline-header"},level:4}}),!0),"cmd")},{action:"pf2e-info-block",class:"info",title:"Info Block",node:menu.schema.nodes.section,attrs:{_preserve:{class:"info"}},priority:1,cmd:__name2(()=>(menu._toggleBlock(menu.schema.nodes.section,wrapIn,{attrs:{_preserve:{class:"info"}}}),!0),"cmd")},{action:"pf2e-stat-block",class:"statblock",title:"Stat Block",node:menu.schema.nodes.section,attrs:{_preserve:{class:"statblock"}},priority:1,cmd:__name2(()=>(menu._toggleBlock(menu.schema.nodes.section,wrapIn,{attrs:{_preserve:{class:"statblock"}}}),!0),"cmd")},{action:"pf2e-traits",class:"traits",title:"Trait",node:menu.schema.nodes.section,attrs:{_preserve:{class:"traits"}},priority:1,cmd:__name2(()=>(menu._toggleBlock(menu.schema.nodes.section,wrapIn,{attrs:{_preserve:{class:"traits"}}}),!0),"cmd")},{action:"pf2e-written-note",class:"message",title:"Written Note",node:menu.schema.nodes.paragraph,attrs:{_preserve:{class:"message"}},priority:1,cmd:__name2(()=>(menu._toggleTextBlock(menu.schema.nodes.paragraph,{attrs:{_preserve:{class:"message"}}}),!0),"cmd")},{action:"pf2e-gm-text-block",class:"visibility-gm",title:"GM Text Block",node:menu.schema.nodes.div,attrs:{_preserve:{"data-visibility":"gm"}},priority:1,cmd:__name2(()=>(menu._toggleBlock(menu.schema.nodes.div,wrapIn,{attrs:{_preserve:{"data-visibility":"gm"}}}),!0),"cmd")},{action:"pf2e-gm-text-inline",class:"visibility-gm",title:"GM Text Inline",mark:menu.schema.marks.span,attrs:{_preserve:{"data-visibility":"gm"}},priority:1,cmd:toggleMark(menu.schema.marks.span,{_preserve:{"data-visibility":"gm"}})}]})})},"listen")},applications=foundry.applications,GetSceneControlButtons={listen:__name2(()=>{Hooks.on("getSceneControlButtons",controls=>{const tokenTools=controls.tokens?.tools;if(tokenTools){const settings=game.pf2e.settings.worldClock;tokenTools.worldClock={name:"worldClock",title:"CONTROLS.WorldClock",icon:"fa-solid fa-clock",order:Object.keys(tokenTools).length,button:!0,visible:settings.showClockButton&&(game.user.isGM||settings.playersCanView),onChange:__name2(()=>{game.pf2e.worldClock.rendered?game.pf2e.worldClock.close():game.pf2e.worldClock.render({force:!0})},"onChange")}}const lightingControls=controls.lighting,lightingTools=lightingControls?.tools,dayTool=lightingTools?.day;if(!(lightingControls&&lightingTools&&dayTool))return;lightingControls.icon=game.pf2e.settings.gmVision&&game.user.isGM?"fa-solid fa-lightbulb-cfl-on gm-vision":"fa-solid fa-lightbulb";const adjusterTool={name:"darknessAdjuster",title:"CONTROLS.AdjustSceneDarkness",icon:"fa-solid fa-circle-half-stroke",order:dayTool.order,visible:game.user.isGM&&game.pf2e.settings.rbv,toggle:!0,active:!1,onChange:__name2(()=>{const adjuster=SceneDarknessAdjuster.instance;adjuster.rendered?adjuster.close():adjuster.render({force:!0})},"onChange")},gmVisionTool=(()=>{const binding=game.keybindings.actions.get("pf2e.gmVision")?.editable?.[0],gmVisionLabel=game.i18n.localize("PF2E.Keybinding.GMVision.Label"),bindingLabel=binding?applications.sidebar.apps.ControlsConfig.humanizeBinding(binding):"",gmVisionIcon=__name2((active=game.pf2e.settings.gmVision)=>active?"fa-solid fa-lightbulb-cfl-on":"fa-solid fa-lightbulb-cfl","gmVisionIcon");return{name:"gmVision",title:`${gmVisionLabel} [${bindingLabel}]`,icon:gmVisionIcon(),order:dayTool.order+1,visible:!!binding&&game.user.isGM,toggle:!0,active:game.pf2e.settings.gmVision,onChange:__name2(()=>{const newStatus=!game.pf2e.settings.gmVision;game.settings.set("pf2e","gmVision",newStatus);const toggle=ui.controls.control?.tools.gmVision;toggle&&(toggle.active=newStatus,toggle.icon=gmVisionIcon(newStatus),ui.controls.render())},"onChange")}})(),newTools=[adjusterTool,gmVisionTool??[]].flat();for(const tool of Object.values(lightingTools).filter(t2=>t2.order>=dayTool.order))tool.order+=newTools.length;for(const tool of newTools)lightingTools[tool.name]=tool})},"listen")};class HotbarDrop{static{__name(this,"HotbarDrop")}static{__name2(this,"HotbarDrop")}static listen(){Hooks.on("hotbarDrop",(_hotbar,data,slot)=>{if(data.type==="Item"&&data.itemType==="melee"&&typeof data.index=="number"&&(data.type="Action"),typeof data.type=="string"&&["Action","Item","RollOption"].includes(data.type))return HotbarDrop.#processHotbarDrop(data,Number(slot)),!1})}static async#processHotbarDrop(data,slot){switch(data.type){case"Item":{const itemId=data.id??(e$2(data.data)?data.data._id:null),uuid=data.uuid,prefix=typeof data.pack=="string"?`Compendium.${data.pack}`:typeof data.actorId=="string"?`Actor.${data.actorId}.Item`:"Item",item=await fromUuid(uuid??`${prefix}.${itemId}`);if(!(item instanceof ItemPF2e))return;if(item.isOfType("condition","effect"))return createToggleEffectMacro(item,slot);if(uuid?.startsWith("Compendium.")){ui.notifications.error("PF2E.Macro.NoCompendiumItem",{localize:!0});return}else return HotbarDrop.#createItemMacro(item,slot)}case"RollOption":{const item=fromUuidSync(data.uuid??"");if(!(item instanceof ItemPF2e&&item.isEmbedded))throw ErrorPF2e("Unexpected error during macro creation");return this.#hasRollOptionData(data)?HotbarDrop.#createRollOptionToggleMacro({...data,item},slot):void 0}case"Action":return typeof data.index!="number"&&!data.elementTrait?void 0:createActionMacro({actorUUID:data.actorUUID,actionIndex:data.index,slot,elementTrait:data.elementTrait})}}static#hasRollOptionData(data){const{label,domain,option}=data;return typeof label=="string"&&label.length>0&&typeof domain=="string"&&domain.length>0&&typeof option=="string"&&option.length>0}static async#createItemMacro(item,slot){const command=`game.pf2e.rollItemMacro("${!!item.actor?.prototypeToken.actorLink?item.uuid:item.id}", event);`,macro=game.macros.find(m=>m.name===item.name&&m.command===command)??await MacroPF2e.create({command,name:item.name,type:"script",img:item.img,flags:{pf2e:{itemMacro:!0}}},{renderSheet:!1});game.user.assignHotbarMacro(macro??null,slot)}static async#createRollOptionToggleMacro(data,slot){const name2=game.i18n.format("PF2E.ToggleWithName",{property:data.label}),escapedName=new Handlebars.SafeString(data.label),{item,domain,option}=data,command=`const item = fromUuidSync("${item.uuid}");
if (!(item instanceof Item && item.isEmbedded && item.isOwner)) {
ui.notifications.error("PF2E.MacroActionNoActorError", { localize: true });
}
const result = await item.actor.toggleRollOption("${domain}", "${option}", "${item.id}");
const state = game.i18n.localize(result ? "PF2E.Macro.OptionToggle.On" : "PF2E.Macro.OptionToggle.Off");
const message = game.i18n.format("PF2E.Macro.OptionToggle.Notification", { toggle: "${escapedName}", state });
if (typeof result === "boolean") {
ui.notifications.info(message);
}`,toggleMacro=game.macros.find(m=>m.name===name2&&m.command===command)??await MacroPF2e.create({type:"script",name:name2,img:item.img,command},{renderSheet:!1})??null;await game.user.assignHotbarMacro(toggleMacro,slot)}}class SettingsMenuPF2e extends foundry.appv1.api.FormApplication{static{__name(this,"SettingsMenuPF2e")}static{__name2(this,"SettingsMenuPF2e")}static namespace;cache=(()=>{const data={clear(){for(const key of Object.keys(this))delete this[key]}};return Object.defineProperty(data,"clear",{enumerable:!1}),data})();static get defaultOptions(){const options=super.defaultOptions;return options.classes.push("settings-menu","sheet"),{...options,title:`PF2E.SETTINGS.${this.namespace.titleCase()}.Name`,id:`${this.namespace}-settings`,template:"systems/pf2e/templates/system/settings/menu.hbs",width:550,height:"auto",tabs:[{navSelector:".sheet-tabs",contentSelector:"form"}],closeOnSubmit:!1,submitOnChange:!0}}static SETTINGS;static get settings(){return{}}static registerSettings(){const settings=this.settings;for(const key of this.SETTINGS){const setting=settings[key];game.settings.register("pf2e",`${setting.prefix??""}${key}`,{...n$1(setting,["prefix"]),scope:"world",config:!1})}}get namespace(){return this.constructor.namespace}async getData(){const settings=this.constructor.settings,templateData=settingsToSheetData(settings,this.cache);for(const[key,value]of Object.entries(settings))key in this.cache||(this.cache[key]=game.settings.get("pf2e",`${value.prefix??""}${key}`));return foundry.utils.mergeObject(await super.getData(),{settings:templateData,instructions:`PF2E.SETTINGS.${this.namespace.titleCase()}.Hint`})}close(options){return this.cache.clear(),super.close(options)}activateListeners($html){super.activateListeners($html);const html2=$html[0];htmlQuery(html2,"button[type=reset]")?.addEventListener("click",()=>{this.cache.clear(),this.render()});const{highlightSetting}=this.options;if(highlightSetting){const formGroup=htmlClosest(htmlQuery(html2,`label[for="${highlightSetting}"]`),".form-group");formGroup&&(formGroup.style.animation="glow 0.75s infinite alternate")}}async _updateObject(event2,data){for(const key of this.constructor.SETTINGS){const settingKey=`${this.constructor.settings[key].prefix??""}${key}`,value=data[key]instanceof Set?data[key].values().toArray():data[key];this.cache[key]=value,event2.type==="submit"&&await game.settings.set("pf2e",settingKey,value)}event2.type==="submit"?this.close():this.render()}_injectHTML($html){super._injectHTML($html);for(const key of this.constructor.SETTINGS){const settingKey=`${this.constructor.settings[key].prefix??""}${key}`,value=game.settings.get("pf2e",settingKey);this.cache[key]=value instanceof foundry.abstract.DataModel?value.clone():value}}}function settingsToSheetData(settings,cache={}){return t$5(settings,(setting,key)=>{const lookupKey=`${setting.prefix??""}${key}`,value=key in cache?cache[key]:game.settings.get("pf2e",lookupKey);return{...setting,key,value,isDataField:setting.type instanceof foundry.data.fields.DataField,isSelect:!!setting.choices,isCheckbox:setting.type===Boolean}})}__name(settingsToSheetData,"settingsToSheetData"),__name2(settingsToSheetData,"settingsToSheetData");class DamageTypeManager{static{__name(this,"DamageTypeManager")}static{__name2(this,"DamageTypeManager")}collections={physicalConfig:CONFIG.PF2E.physicalDamageTypes,energyConfig:CONFIG.PF2E.energyDamageTypes,physical:PHYSICAL_DAMAGE_TYPES,energy:ENERGY_DAMAGE_TYPES,DAMAGE_TYPES,BASE_DAMAGE_TYPES_TO_CATEGORIES,DAMAGE_TYPE_ICONS,damageTypesLocalization:CONFIG.PF2E.damageTypes,damageRollFlavorsLocalization:CONFIG.PF2E.damageRollFlavors,immunityTypes,weaknessTypes,resistanceTypes};addCustomDamage(data,options={}){const collections=this.collections,slug=options.slug??sluggify(data.label);collections.DAMAGE_TYPES.add(slug),tupleHasValue(["physical","energy"],data.category)&&(collections[data.category].push(slug),collections[`${data.category}Config`][slug]=data.label),collections.BASE_DAMAGE_TYPES_TO_CATEGORIES[slug]=data.category??null,collections.DAMAGE_TYPE_ICONS[slug]=data.icon?.substring(3)??null,collections.damageTypesLocalization[slug]=data.label;const versatileLabel=game.i18n.format("PF2E.TraitVersatileX",{x:data.label});CONFIG.PF2E.weaponTraits[`versatile-${slug}`]=versatileLabel,CONFIG.PF2E.npcAttackTraits[`versatile-${slug}`]=versatileLabel;const damageFlavor=game.i18n.localize(data.label).toLocaleLowerCase(game.i18n.lang);collections.damageRollFlavorsLocalization[slug]=damageFlavor,collections.immunityTypes[slug]=damageFlavor,collections.weaknessTypes[slug]=damageFlavor,collections.resistanceTypes[slug]=damageFlavor}updateSettings(){const reservedTerms=HomebrewElements.reservedTerms,typesToDelete=DAMAGE_TYPES.filter(t2=>!reservedTerms.damageTypes.has(t2));for(const collection of Object.values(this.collections))if(collection instanceof Set){const types=[...collection].filter(t2=>typesToDelete.has(t2));for(const damageType of types)collection.delete(damageType)}else{const types=Object.keys(collection).filter(t2=>typesToDelete.has(t2));for(const damageType of types)delete collection[damageType]}for(const type2 of typesToDelete){const weaponTraits2=CONFIG.PF2E.weaponTraits,npcAttackTraits2=CONFIG.PF2E.npcAttackTraits;delete weaponTraits2[`versatile-${type2}`],delete npcAttackTraits2[`versatile-${type2}`]}for(const[slug,data]of Object.entries(HomebrewElements.moduleData.damageTypes))reservedTerms.damageTypes.has(slug)||this.addCustomDamage(data,{slug});const customTypes=game.settings.get("pf2e","homebrew.damageTypes").filter(t2=>!reservedTerms.damageTypes.has(sluggify(t2.label)));for(const data of customTypes)this.addCustomDamage(data)}}function isHomebrewFlagCategory(value){return e$2(value)&&Object.entries(value).every(([_hbKey,hbLabel])=>typeof hbLabel=="string"||e$2(hbLabel)&&isLabelAndDescription(hbLabel))}__name(isHomebrewFlagCategory,"isHomebrewFlagCategory"),__name2(isHomebrewFlagCategory,"isHomebrewFlagCategory");function isHomebrewCustomDamage(value){return Object.values(value).every(value2=>e$2(value2)&&typeof value2.label=="string"&&(!value2.category||tupleHasValue(["physical","energy"],value2.category)))}__name(isHomebrewCustomDamage,"isHomebrewCustomDamage"),__name2(isHomebrewCustomDamage,"isHomebrewCustomDamage");function isLabelAndDescription(obj){return typeof obj.label=="string"&&typeof obj.description=="string"}__name(isLabelAndDescription,"isLabelAndDescription"),__name2(isLabelAndDescription,"isLabelAndDescription");function isSkillData(obj){return e$2(obj)&&e$2(obj.additional)&&Object.values(obj.additional).every(d=>e$2(d)&&typeof d.label=="string"&&setHasElement(ATTRIBUTE_ABBREVIATIONS,d.attribute))}__name(isSkillData,"isSkillData"),__name2(isSkillData,"isSkillData");function prepareReservedTerms(){const universalReservedTerms=new Set([...Object.keys(CONFIG.PF2E.classTraits),...Object.keys(CONFIG.PF2E.damageCategories),...Object.keys(CONFIG.PF2E.damageTypes),...Object.keys(CONFIG.PF2E.immunityTypes),...Object.keys(CONFIG.PF2E.resistanceTypes),...Object.keys(CONFIG.PF2E.saves),...Object.keys(CONFIG.PF2E.skills),...Object.keys(CONFIG.PF2E.weaknessTypes),...Object.keys(CONFIG.PF2E.environmentTypes),"damage","healing","perception","spellcasting","none","null","undefined"]);return{armorGroups:new Set([...Object.keys(CONFIG.PF2E.armorGroups),...universalReservedTerms]),baseArmors:new Set([...Object.keys(CONFIG.PF2E.baseArmorTypes),...universalReservedTerms]),weaponCategories:new Set([...Object.keys(CONFIG.PF2E.weaponCategories),...universalReservedTerms]),weaponGroups:new Set([...Object.keys(CONFIG.PF2E.weaponGroups),...universalReservedTerms]),baseWeapons:new Set([...Object.keys(CONFIG.PF2E.baseWeaponTypes),...universalReservedTerms]),classTraits:new Set(universalReservedTerms),creatureTraits:new Set([...Object.keys(CONFIG.PF2E.creatureTraits),...universalReservedTerms]),damageTypes:universalReservedTerms,equipmentTraits:new Set([...Object.keys(CONFIG.PF2E.equipmentTraits),...TRAIT_PROPAGATIONS.equipmentTraits.flatMap(t2=>Object.keys(CONFIG.PF2E[t2])),...universalReservedTerms]),featTraits:new Set([...Object.keys(CONFIG.PF2E.actionTraits),...universalReservedTerms]),languages:new Set([...Object.keys(CONFIG.PF2E.languages),...universalReservedTerms]),shieldTraits:new Set([...Object.keys(CONFIG.PF2E.shieldTraits),...universalReservedTerms]),spellTraits:new Set([...Object.keys(CONFIG.PF2E.spellTraits),...universalReservedTerms]),skills:universalReservedTerms,weaponTraits:new Set([...Object.keys(CONFIG.PF2E.weaponTraits),...universalReservedTerms])}}__name(prepareReservedTerms,"prepareReservedTerms"),__name2(prepareReservedTerms,"prepareReservedTerms");function readModuleHomebrewSettings(){const results={skills:{},damageTypes:{},traits:t$9(HOMEBREW_ELEMENT_KEYS,k=>[k,[]]),traitDescriptions:{}},activeModules=[...game.modules.entries()].filter(([_key,foundryModule])=>foundryModule.active);for(const[key,foundryModule]of activeModules){const flags=foundryModule.flags[key];if(!e$2(flags))continue;const homebrew=flags["pf2e-homebrew"];if(e$2(homebrew))for(const[recordKey,elements]of Object.entries(homebrew))if(recordKey==="skills"){if(!isSkillData(elements)){console.warn(ErrorPF2e(`Homebrew record skills is malformed in module ${key}`).message);continue}for(const[slug,data]of Object.entries(elements.additional))HomebrewElements.reservedTerms.skills.has(slug)?console.warn(ErrorPF2e(`Homebrew skill "${slug}" from module ${foundryModule.title} is a reserved term.`).message):results.skills[slug]=data}else if(recordKey==="damageTypes"){if(!e$2(elements)||!isHomebrewCustomDamage(elements)){console.warn(ErrorPF2e(`Homebrew record damageTypes is malformed in module ${key}`).message);continue}for(const[slug,value]of Object.entries(elements))HomebrewElements.reservedTerms.damageTypes.has(slug)?console.warn(ErrorPF2e(`Homebrew damage type "${slug}" from module ${foundryModule.title} is a reserved term.`).message):results.damageTypes[slug]=value}else if(tupleHasValue(HOMEBREW_ELEMENT_KEYS,recordKey)){if(!e$2(elements)||!isHomebrewFlagCategory(elements)){console.warn(ErrorPF2e(`Homebrew record ${recordKey} is malformed in module ${key}`).message);continue}const elementEntries=Object.entries(elements);results.traits[recordKey].push(...elementEntries.map(([id,value])=>({id,value:typeof value=="string"?value:value.label})));for(const[key2,value]of elementEntries)typeof value=="object"&&(results.traitDescriptions[key2]=value.description)}else{console.warn(ErrorPF2e(`Invalid homebrew record "${recordKey}" in module ${key}`).message);continue}}return results}__name(readModuleHomebrewSettings,"readModuleHomebrewSettings"),__name2(readModuleHomebrewSettings,"readModuleHomebrewSettings");function prepareCleanup(listKey,deletions){const Migration=class extends MigrationBase{static{__name(this,"Migration")}static{__name2(this,"Migration")}static version=MigrationRunnerBase.LATEST_SCHEMA_VERSION;async updateActor(source2){if(source2.type==="character"||source2.type==="npc")switch(listKey){case"creatureTraits":{const traits=source2.system.traits;if(!traits)break;traits.value=traits.value.filter(t2=>HomebrewElements.reservedTerms.creatureTraits.has(t2)||!deletions.includes(t2));break}case"languages":{const languages=source2.system.details.languages;languages.value=languages.value.filter(l=>HomebrewElements.reservedTerms.languages.has(l)||!deletions.includes(l));break}case"weaponCategories":{if(source2.type==="character"){const attacks=source2.system.proficiencies?.attacks??{};for(const category of deletions)attacks[category]&&!HomebrewElements.reservedTerms.weaponCategories.has(category)&&(attacks[`-=${category}`]=null)}break}case"weaponGroups":{if(source2.type==="character"){const attacks=source2.system.proficiencies?.attacks??{};for(const group of deletions){const key=`weapon-group-${group}`;attacks[key]&&!HomebrewElements.reservedTerms.weaponGroups.has(group)&&(attacks[`-=${key}`]=null)}}break}case"baseWeapons":{if(source2.type==="character"){const attacks=source2.system.proficiencies?.attacks??{};for(const base of deletions){const key=`weapon-base-${base}`;attacks[key]&&!HomebrewElements.reservedTerms.baseWeapons.has(base)&&(attacks[`-=${key}`]=null)}}break}}}async updateItem(source2){switch(listKey){case"creatureTraits":{if(source2.system.traits?.value){const traits=source2.system.traits;traits.value=traits.value.filter(t2=>HomebrewElements.reservedTerms.creatureTraits.has(t2)||!deletions.includes(t2))}break}case"featTraits":{if(itemIsOfType(source2,"action","feat")){const traits=source2.system.traits;traits.value=traits.value.filter(t2=>HomebrewElements.reservedTerms.featTraits.has(t2)||!deletions.includes(t2))}break}case"spellTraits":{if(source2.type==="spell"){const traits=source2.system.traits;traits.value=traits.value.filter(t2=>HomebrewElements.reservedTerms.spellTraits.has(t2)||!deletions.includes(t2))}break}case"languages":{if(source2.type==="ancestry"){const{languages}=source2.system;languages.value=languages.value.filter(l=>HomebrewElements.reservedTerms.languages.has(l)||!deletions.includes(l))}break}case"weaponCategories":{if(source2.type==="weapon"){const systemData=source2.system;systemData.category=deletions.includes(systemData.category??"")?"simple":systemData.category}break}case"weaponGroups":{if(source2.type==="weapon"){const systemData=source2.system;systemData.group=deletions.includes(systemData.group??"")?null:systemData.group}break}case"baseWeapons":{if(source2.type==="weapon"){const base=source2.system.baseItem;source2.system.baseItem=deletions.includes(base??"")?null:base}break}case"weaponTraits":{const traits=itemIsOfType(source2,"melee","weapon")?source2.system.traits:{value:[]};traits.value=traits.value.filter(t2=>HomebrewElements.reservedTerms.weaponTraits.has(t2)||!deletions.includes(t2));break}}}};return new Migration}__name(prepareCleanup,"prepareCleanup"),__name2(prepareCleanup,"prepareCleanup");class LanguagesManager{static{__name(this,"LanguagesManager")}static{__name2(this,"LanguagesManager")}menu;moduleLanguages;constructor(menu){this.menu=menu;const languagesFromSetting=game.settings.get("pf2e","homebrew.languages").map(l=>l.id);this.moduleLanguages=t$4(CONFIG.PF2E.languages).filter(l=>l!=="common"&&!LANGUAGES.includes(l)&&!languagesFromSetting.includes(l)),this.data.reset()}get data(){return this.menu.cache.languageRarities}getSheetData(){const data=this.data.toObject(!1),homebrewLanguages=this.menu.cache.languages;return{commonLanguage:data.commonLanguage,...t$9([...LANGUAGE_RARITIES,"unavailable"],r2=>[r2,data[r2].map(slug=>{const locKey=CONFIG.PF2E.languages[slug]??homebrewLanguages.find(l=>l.id===slug)?.value??slug;return{slug,label:game.i18n.localize(locKey)}}).sort((a,b)=>a.label.localeCompare(b.label))])}}activateListeners(html2){const commonLanguageSelect=htmlQuery(html2,"select[data-common-language");commonLanguageSelect?.addEventListener("change",async event2=>{event2.stopPropagation();const data=this.data,newCommon=commonLanguageSelect.value||null;(newCommon===null||setHasElement(data.common,newCommon))&&data.updateSource({commonLanguage:newCommon})});for(const list of htmlQueryAll(html2,"ul[data-languages]"))createSortable(list,{...SORTABLE_BASE_OPTIONS,group:"languages",sort:!1,swapThreshold:1,onEnd:this.#onDropLanguage.bind(this)});const rarities=LANGUAGE_RARITIES,localize=localizer("PF2E.SETTINGS.Homebrew.Languages.Rarities");for(const raritySection of htmlQueryAll(html2,".form-group.language-rarity")){const rarity=Array.from(raritySection.classList).find(c=>rarities.includes(c))??"unavailable";if(rarity==="unavailable")continue;const labelEl=raritySection.querySelector("label");if(!labelEl)throw ErrorPF2e("");labelEl.innerHTML=localize(sluggify(rarity,{camel:"bactrian"})),game.pf2e.TextEditor.convertXMLNode(labelEl,"rarity",{classes:["tag","rarity",rarity]})}}#isValidLanguage(language){return!!language&&language!=="common"&&(objectHasKey(CONFIG.PF2E.languages,language)||this.menu.cache.languages.some(l=>l.id===language))}async#onDropLanguage(event2){const droppedEl=event2.item,dropTarget=htmlClosest(droppedEl,"ul[data-languages]"),oldRarity=droppedEl.dataset.rarity,newRarity=dropTarget?.dataset.rarity;if(!(oldRarity&&newRarity))throw ErrorPF2e("Unexpected update to language rarities");if(oldRarity===newRarity)return;const language=droppedEl.dataset.slug;if(!this.#isValidLanguage(language))throw ErrorPF2e("Unexpected update to language rarities");const data=this.data,source2=data.toObject(),commonLanguageSelect=htmlQuery(this.menu.form,"select[data-common-language]");if(!commonLanguageSelect)throw ErrorPF2e("Unexpected error updating menu");const rarities=["uncommon","rare","secret","unavailable"];if(newRarity==="common"){for(const rarity of rarities)source2[rarity].findSplice(l=>l===language);const newOption=document.createElement("option");newOption.value=language,newOption.textContent=droppedEl.textContent,commonLanguageSelect.append(newOption)}else{if(!tupleHasValue(rarities,newRarity))throw ErrorPF2e("Unexpected update to language rarities");for(const rarity of rarities)source2[rarity].findSplice(l=>l===language);source2[newRarity].push(language),source2[newRarity].sort(),source2.commonLanguage=source2.commonLanguage===language?null:source2.commonLanguage,commonLanguageSelect.value===language&&(commonLanguageSelect.value=""),htmlQuery(commonLanguageSelect,`option[value=${language}]`)?.remove()}droppedEl.dataset.rarity=newRarity,data.updateSource(source2)}onChangeHomebrewLanguages(languages){const data=this.data,source2=data.toObject(),languageSet=new Set(LANGUAGES),updatedLanguages=[...this.moduleLanguages,...languages.map(l=>l.id)];source2.commonLanguage&&!languageSet.has(source2.commonLanguage)&&!updatedLanguages.includes(source2.commonLanguage)&&(source2.commonLanguage=null);for(const rarity of["uncommon","rare","secret","unavailable"])for(const language of source2[rarity])!languageSet.has(language)&&!updatedLanguages.includes(language)&&source2[rarity].findSplice(l=>l===language);data.updateSource(source2);for(const language of data.common)!languageSet.has(language)&&!updatedLanguages.includes(language)&&data.common.delete(language);for(const language of updatedLanguages)LANGUAGE_RARITIES.some(r2=>data[r2].has(language))||data.common.add(language)}}const appv1$7=foundry.appv1;class HomebrewElements extends SettingsMenuPF2e{static{__name(this,"HomebrewElements")}static{__name2(this,"HomebrewElements")}static namespace="homebrew";#initialRefresh=!0;static#reservedTerms=null;static#moduleData=null;static get reservedTerms(){return this.#reservedTerms??=prepareReservedTerms()}static get moduleData(){return this.#moduleData??=readModuleHomebrewSettings()}static get SETTINGS(){return Object.keys(this.settings)}static get defaultOptions(){return{...super.defaultOptions,template:"systems/pf2e/templates/system/settings/homebrew.hbs",width:625}}static#campaignSettings={campaignFeats:{name:"PF2E.SETTINGS.CampaignFeats.Name",hint:"PF2E.SETTINGS.CampaignFeats.Hint",default:!1,type:Boolean,tab:"campaign",onChange:__name2(value=>{game.pf2e.settings.campaign.feats.enabled=!!value,resetActors(game.actors.filter(a=>a.isOfType("character")))},"onChange")},campaignType:{name:"PF2E.SETTINGS.CampaignType.Name",hint:"PF2E.SETTINGS.CampaignType.Hint",default:"none",choices:t$9(["none","kingmaker"],key=>[key,`PF2E.SETTINGS.CampaignType.Choices.${key}`]),type:String,tab:"campaign",onChange:__name2(async value=>{game.pf2e.settings.campaign.type=value==="none"?null:String(value),await resetActors(game.actors.filter(a=>a.isOfType("party"))),ui.sidebar.render()},"onChange")}};static get#otherSettings(){return HOMEBREW_ELEMENT_KEYS.reduce((result,key)=>{const sluggified=sluggify(key),tab=sluggified.endsWith("traits")?"traits":sluggified.includes("languages")?"languages":"taxonomies";return result[key]={prefix:"homebrew.",tab,name:`PF2E.SETTINGS.Homebrew.${key.capitalize()}.Name`,hint:`PF2E.SETTINGS.Homebrew.${key.capitalize()}.Hint`,default:[],type:Array},result},{})}static get settings(){return{...this.#campaignSettings,...this.#otherSettings,damageTypes:{prefix:"homebrew.",tab:"damage",name:"PF2E.SETTINGS.Homebrew.DamageTypes.Name",default:[],type:Array,onChange:__name2(()=>{new DamageTypeManager().updateSettings()},"onChange")},languageRarities:{prefix:"homebrew.",tab:"languages",name:"PF2E.Settings.Homebrew.Languages.Rarities.Name",type:LanguageSettings,default:{common:"taldane",uncommon:[...LANGUAGES_BY_RARITY.uncommon],rare:[...LANGUAGES_BY_RARITY.rare],secret:[...LANGUAGES_BY_RARITY.secret],unavailable:[]},onChange:__name2(value=>{value instanceof LanguageSettings&&(game.pf2e.settings.campaign.languages=value),Object.values(ui.windows).find(a=>a instanceof LanguageSelector)?.render()},"onChange")}}}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const key of HOMEBREW_ELEMENT_KEYS){const reservedTerms=HomebrewElements.reservedTerms[key],input=htmlQuery(html2,`input[name="${key}"]`);if(!input)throw ErrorPF2e("Unexpected error preparing form");const localize=localizer("PF2E.SETTINGS.Homebrew"),tagify2=new Tagify(input,{editTags:1,hooks:{beforeRemoveTag:__name2(tags=>{if(tags.some(t2=>reservedTerms.has(sluggify(t2.data.value))))return Promise.resolve();const response=(async()=>{const content=localize("ConfirmDelete.Message",{element:tags[0].data.value});return await foundry.applications.api.DialogV2.confirm({window:{title:localize("ConfirmDelete.Title")},content:`<p>${content}</p>`})})();return(async()=>await response?Promise.resolve():Promise.reject())()},"beforeRemoveTag")},validate:__name2(data=>!reservedTerms.has(sluggify(data.value)),"validate"),transformTag:__name2(data=>{reservedTerms.has(sluggify(data.value))&&ui.notifications.error(localize("ReservedTerm",{term:data.value}))},"transformTag")});DestroyableManager.instance.observe(tagify2)}htmlQuery(html2,"[data-action=damage-add]")?.addEventListener("click",async()=>{this.cache.damageTypes.push({label:"Ouch",category:null,icon:"fa-question"}),this.render()});for(const element of htmlQueryAll(html2,"[data-action=damage-delete]"))element.addEventListener("click",async event2=>{const idx=htmlClosest(event2.target,"[data-idx]")?.dataset.idx;idx&&this.cache.damageTypes.splice(Number(idx),1),this.render()});this.languagesManager.activateListeners(html2)}async getData(){const data=await super.getData();this.languagesManager??=new LanguagesManager(this);const damageCategories2=t$3(CONFIG.PF2E.damageCategories,["physical","energy"]),languageRarities=this.languagesManager.getSheetData();return{...data,languageRarities,damageCategories:damageCategories2,customDamageTypes:(this.cache.damageTypes??[]).map(customType=>({...customType,slug:sluggify(customType.label)}))}}async _onSubmit(event2,options){event2.preventDefault();for(const input of htmlQueryAll(this.form,"tags ~ input"))input.value===""&&(input.value="[]"),!("__tagify"in input)||input.__tagify instanceof Tagify;return super._onSubmit(event2,options)}_getSubmitData(updateData){const original=super._getSubmitData(updateData),data=foundry.utils.expandObject(original);if("damageTypes"in data&&data.damageTypes&&typeof data.damageTypes=="object"){data.damageTypes=Object.values(data.damageTypes);for(const type2 of data.damageTypes){type2.category||=null;const sanitized=sluggify(type2.icon??"");type2.icon=sanitized.startsWith("fa-")?sanitized:null}}return data.languageRarities=this.cache.languageRarities,data}async _updateObject(event2,data){for(const key of HOMEBREW_ELEMENT_KEYS)for(const tag of data[key])tag.id??=sluggify(tag.value);if(event2.type==="submit"){const cleanupTasks=HOMEBREW_ELEMENT_KEYS.map(key=>this.#processDeletions(key,data[key])).filter(task=>!!task);new MigrationRunner().runMigrations(cleanupTasks),await super._updateObject(event2,data),this.#refreshSettings()}else return this.languagesManager.onChangeHomebrewLanguages(data.languages??[]),super._updateObject(event2,data)}#getAllTraitPropagations(listKey){return objectHasKey(TRAIT_PROPAGATIONS,listKey)?TRAIT_PROPAGATIONS[listKey].flatMap(p=>[p,...this.#getAllTraitPropagations(p)]):[]}#processDeletions(listKey,newTagList){const oldTagList=game.settings.get("pf2e",`homebrew.${listKey}`),newIDList=newTagList.map(tag=>tag.id),deletions=oldTagList.flatMap(oldTag=>newIDList.includes(oldTag.id)?[]:oldTag.id),coreElements=this.#getConfigRecord(listKey);for(const id of deletions){delete coreElements[id];for(const recordKey of this.#getAllTraitPropagations(listKey)){const secondaryRecord=CONFIG.PF2E[recordKey];delete secondaryRecord[id]}}return game.user.isGM&&deletions.length>0?prepareCleanup(listKey,deletions):null}onInit(){this.#refreshSettings(),this.#registerModuleTags(),new DamageTypeManager().updateSettings();const moduleData=HomebrewElements.moduleData;Object.keys(moduleData.skills).length>0&&(CONFIG.PF2E.skills=Object.freeze({...CONFIG.PF2E.skills,...t$5(moduleData.skills,data=>({label:data.label,attribute:data.attribute}))}))}#refreshSettings(){const reservedTerms=HomebrewElements.reservedTerms;for(const listKey of HOMEBREW_ELEMENT_KEYS){const settingsKey=`homebrew.${listKey}`,validElements=game.settings.get("pf2e",settingsKey).filter(e2=>!reservedTerms[listKey].has(e2.id));this.#updateConfigRecords(validElements,listKey)}if(this.#initialRefresh)this.#initialRefresh=!1;else{const sheets=Object.values(ui.windows).filter(app=>app instanceof appv1$7.sheets.ActorSheet||app instanceof ItemSheetPF2e);for(const sheet of sheets)sheet.render()}}#registerModuleTags(){const settings=HomebrewElements.moduleData;for(const[recordKey,tags]of t$f(settings.traits))tags.length>0&&this.#updateConfigRecords(tags,recordKey);for(const[trait,description]of Object.entries(settings.traitDescriptions)){const hbKey=trait;CONFIG.PF2E.traitsDescriptions[hbKey]=description}}#getConfigRecord(key){return key==="baseArmors"?CONFIG.PF2E.baseArmorTypes:key==="baseWeapons"?CONFIG.PF2E.baseWeaponTypes:CONFIG.PF2E[key]}#updateConfigRecords(elements,listKey){const coreElements=this.#getConfigRecord(listKey);for(const element of elements){coreElements[element.id]=element.value;for(const recordKey of this.#getAllTraitPropagations(listKey)){const record=CONFIG.PF2E[recordKey];record[element.id]=element.value}}}}const fields$p=foundry.data.fields;class WorldClockSettings extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"WorldClockSettings")}static{__name2(this,"WorldClockSettings")}constructor(options){super(options)}static DEFAULT_OPTIONS={id:"world-clock-settings",tag:"form",window:{title:"PF2E.SETTINGS.WorldClock.Name",icon:"fa-solid fa-clock",contentClasses:["standard-form"]},position:{width:560},actions:{resetWorldTime:WorldClockSettings.#onClickResetWorldTime},form:{closeOnSubmit:!0,handler:WorldClockSettings.#onSubmit}};static PARTS={settings:{template:"systems/pf2e/templates/system/settings/world-clock/settings.hbs",root:!0},footer:{template:"templates/generic/form-footer.hbs"}};static#SCHEMA=new fields$p.SchemaField({dateTheme:new fields$p.StringField({required:!0,choices:["AR","IC","AD","CE"],initial:"AR"}),playersCanView:new fields$p.BooleanField,showClockButton:new fields$p.BooleanField({initial:!0}),syncDarkness:new fields$p.BooleanField,timeConvention:new fields$p.NumberField({required:!0,nullable:!1,choices:[12,24],initial:24}),worldCreatedOn:new fields$p.StringField({required:!0,nullable:!0,blank:!1,initial:null})});static register(){game.settings.register("pf2e","worldClock",{name:"PF2E.SETTINGS.WorldClock.Name",scope:"world",config:!1,type:WorldClockSettings.#SCHEMA,onChange:__name2(data=>{game.pf2e.settings.worldClock={...data}},"onChange")}),game.settings.registerMenu("pf2e","worldClock",{name:"PF2E.SETTINGS.WorldClock.Name",label:"PF2E.SETTINGS.WorldClock.Label",hint:"PF2E.SETTINGS.WorldClock.Hint",icon:"fa-solid fa-clock",type:WorldClockSettings,restricted:!0})}static localizeSchema(){foundry.helpers.Localization.localizeSchema(WorldClockSettings.#SCHEMA,["PF2E.SETTINGS.WorldClock"],{prefixPath:"pf2e.worldClock."})}async _prepareContext(){const buttons=[{type:"submit",icon:"fa-solid fa-floppy-disk",label:"SETTINGS.Save"},{type:"button",icon:"fa-solid fa-clock-rotate-left",label:"PF2E.SETTINGS.WorldClock.ResetWorldTime.Label",tooltip:"PF2E.SETTINGS.WorldClock.ResetWorldTime.Hint",action:"resetWorldTime"}];return{rootId:this.id,fields:WorldClockSettings.#SCHEMA.fields,settings:game.pf2e.settings.worldClock,dateThemes:t$9(["AR","IC","AD","CE"],k=>[k,game.i18n.localize(`PF2E.SETTINGS.WorldClock.DateThemes.${k}`)]),timeConventions:{12:game.i18n.localize("PF2E.SETTINGS.WorldClock.TimeConventions.12"),24:game.i18n.localize("PF2E.SETTINGS.WorldClock.TimeConventions.24")},buttons}}static async#onClickResetWorldTime(){const content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/system/settings/world-clock/confirm-reset.hbs");foundry.applications.api.DialogV2.confirm({window:{title:"PF2E.SETTINGS.WorldClock.ResetWorldTime.Label"},content,yes:{callback:__name2(()=>{game.time.advance(-1*game.time.worldTime),this.close()},"callback")},no:{default:!0}})}static async#onSubmit(_event,_form,formData){const update={...foundry.utils.expandObject(formData.object).pf2e.worldClock,worldCreatedOn:game.pf2e.settings.worldClock.worldCreatedOn};await game.settings.set("pf2e","worldClock",update),game.pf2e.worldClock.render()}}const I18nInit={listen:__name2(()=>{Hooks.once("i18nInit",()=>{game.pf2e.ConditionManager.initialize(),new HomebrewElements().onInit(),WorldClockSettings.localizeSchema(),foundry.helpers.Localization.localizeDataModel(RuleElement);for(const RuleClass of Object.values(RuleElements.all)){foundry.helpers.Localization.localizeDataModel(RuleClass);for(const[key,field]of Object.entries(RuleClass.schema.fields)){const fieldWithChoices="choices"in field&&field.choices?field:"element"in field&&e$3(field.element)&&"choices"in field.element?field.element:null;if(!fieldWithChoices?.choices)continue;const choices=fieldWithChoices.choices;Array.isArray(choices)&&choices.every(c=>typeof c=="string"||typeof c=="number")&&(fieldWithChoices.choices=t$9(choices,choice=>{if(!RuleClass.LOCALIZATION_PREFIXES[1])return[String(choice),choice];const locPath=RuleClass.LOCALIZATION_PREFIXES.map(p=>`${p}.FIELDS.${key}.choices.${choice}`).find(t2=>game.i18n.has(t2));return locPath?[choice,game.i18n.localize(locPath)]:[choice,choice]}))}}})},"listen")};class ActorDirectoryPF2e extends foundry.applications.sidebar.tabs.ActorDirectory{static{__name(this,"ActorDirectoryPF2e")}static{__name2(this,"ActorDirectoryPF2e")}static DEFAULT_OPTIONS={actions:{togglePartyFolder:ActorDirectoryPF2e.#togglePartyFolder,openPartySheet:ActorDirectoryPF2e.#openPartySheet,activateParty:ActorDirectoryPF2e.#activateParty,createParty:ActorDirectoryPF2e.#createParty,createMember:ActorDirectoryPF2e.#createPartyMember,openCompendiumBrowser:__name2(()=>game.pf2e.compendiumBrowser.openTab("bestiary"),"openCompendiumBrowser")},renderUpdateKeys:["system.details.level.value","system.attributes.adjustment","system.details.members","system.campaign.type"]};static PARTS=(()=>{const parts={...super.PARTS};return parts.parties={template:"systems/pf2e/templates/sidebar/party-document-partial.hbs"},parts})();static _entryPartial="systems/pf2e/templates/sidebar/actor-document-partial.hbs";#extraFolders={};#draggingParty=!1;async _preparePartContext(partId,context,options){const partContext=await super._preparePartContext(partId,context,options);if(partId!=="parties")return partContext;const activeParty=game.actors.party;options.isFirstRender&&activeParty&&game.settings.get("pf2e","activePartyFolderState")&&(this.#extraFolders[activeParty.id]=!0);const parties=t(this.collection.filter(a=>a.isOfType("party")&&a!==activeParty),p=>p.sort);return Object.assign(partContext,{activeParty:this.#createPartyContext(activeParty),parties:parties.map(p=>this.#createPartyContext(p)),extraFolders:this.#extraFolders})}#createPartyContext(party){return party?{...t$3(party,["id","name","img","active"]),members:party.members.filter(m=>game.actors.has(m.id))}:null}async _prepareFooterContext(context,options){await super._prepareFooterContext(context,options),game.user.isGM&&(context.buttons??=[],context.buttons.push({type:"button",icon:"fa-solid fa-magnifying-glass",label:"PF2E.CompendiumBrowser.BestiaryBrowser",action:"openCompendiumBrowser"}))}async saveActivePartyFolderState(){game.settings.set("pf2e","activePartyFolderState",this.#extraFolders[game.actors.party?.id??""]??!0)}render(options={}){return options.parts&&options.parts.includes("parties")&&!options.parts.includes("directory")&&options.parts.push("directory"),super.render(options)}async _onRender(context,options){if(options.parts.includes("directory")){const partiesPart=this.parts.parties;partiesPart.remove(),this.parts.directory.prepend(partiesPart)}if(await super._onRender(context,options),options.parts.includes("directory")){for(const party of game.actors.filter(a=>a.isOfType("party"))){const sidebarButtons=party.campaign?.createSidebarButtons?.()??[];sidebarButtons.length&&this.element.querySelector(`li[data-party][data-entry-id="${party.id}"] header .folder-name`)?.after(...sidebarButtons)}for(const element of htmlQueryAll(this.element,"li.directory-item.actor"))game.actors.get(element.dataset.entryId,{strict:!0}).testUserPermission(game.user,"OBSERVER")||element.querySelector("span.actor-level")?.remove()}}collapseAll(){super.collapseAll();for(const el of htmlQueryAll(this.element,".directory-item.folder[data-party]"))el.classList.remove("expanded"),delete this.#extraFolders[el.dataset.entryId??""]}_onSearchFilter(event2,query,rgx,html2){super._onSearchFilter(event2,query,rgx,html2);const folderLikes=htmlQueryAll(html2,".parties .folder");for(const folderLike of folderLikes)if(query!==""&&htmlQueryAll(folderLike,".actor").some(li=>li.style.display!=="none"))folderLike.style.display="flex",folderLike.classList.add("expanded");else{const entryId=folderLike.dataset.entryId??"";folderLike.classList.toggle("expanded",!!this.#extraFolders[entryId])}}_onDragStart(event2){if(!(event2.target instanceof HTMLElement&&event2.dataTransfer))return super._onDragStart(event2);if(event2.target.dataset.entryId==="otherParties"){event2.preventDefault();return}super._onDragStart(event2);const fromParty=htmlClosest(event2.target,"[data-party]")?.dataset.entryId;if(fromParty){const data=JSON.parse(event2.dataTransfer.getData("text/plain"));data.fromParty=fromParty,this.#draggingParty=fromUuidSync(data.uuid)instanceof PartyPF2e,event2.dataTransfer.setData("text/plain",JSON.stringify(data))}else this.#draggingParty=!1}_onDragHighlight(event2){if(event2.type==="dragenter"&&this.#draggingParty)return event2.stopPropagation();super._onDragHighlight(event2)}async _handleDroppedEntry(target,data){if(!data.uuid)return super._handleDroppedEntry(target,data);const toPartyId=htmlClosest(target,"[data-party]")?.dataset.entryId,toParty=game.actors.get(toPartyId??""),droppedEntry=await this._getDroppedEntryFromData(data);if(toParty?.isOfType("party")&&!this._entryAlreadyExists(droppedEntry)&&droppedEntry.isOfType("creature")){const entry=await ActorPF2e.create(droppedEntry.toObject(),{render:!1});await toParty.addMembers(entry);return}if(toPartyId!==data.fromParty&&data.uuid){const fromParty=game.actors.get(data.fromParty??"");fromParty?.isOfType("party")&&await fromParty.removeMembers(data.uuid),toParty?.isOfType("party")&&droppedEntry.isOfType("creature")&&await toParty.addMembers(droppedEntry)}await super._handleDroppedEntry(target,data)}_createContextMenus(){this._createContextMenu(this._getFolderContextOptions,".folder:not([data-party]) > .folder-header",{fixed:!0,hookName:"getFolderContextOptions",parentClassHooks:!1}),this._createContextMenu(this._getEntryContextOptions,".directory-item[data-entry-id]",{fixed:!0,hookName:`get${this.documentName}ContextOptions`,parentClassHooks:!1})}_getEntryContextOptions(){const entries=super._getEntryContextOptions(),createTradeArgs=__name2((traderActor,selfActor=null,checkReach=!1)=>{const token=canvas.tokens.controlled.length===1?canvas.tokens.controlled[0]:null;if(selfActor??=token?.actor??game.user.character,!selfActor)return null;const owners=game.users.filter(u=>u.active&&!u.isSelf&&traderActor.testUserPermission(u,"OWNER")).sort((a,b)=>Number(a.isGM)-Number(b.isGM)),traderUser=owners.find(u=>u.character===traderActor)??owners[0];if(!traderUser)return null;const args={self:{actor:selfActor},trader:{user:traderUser,actor:traderActor}};return TradeDialog.canTrade(args,{checkReach})?args:null},"createTradeArgs");return entries.push({name:TradeDialog.localize("Request.MenuLabel"),icon:foundry.applications.fields.createFontAwesomeIcon("money-bill-transfer",{style:"regular"}).outerHTML,condition:__name2(li=>{if(foundry.applications.instances.has("trade-dialog"))return!1;const actor=game.actors.get(li.dataset.entryId,{strict:!0});if(canvas.tokens.controlled.some(t2=>t2.actor===actor))return!1;const selfActor=(canvas.tokens.controlled.length===1?canvas.tokens.controlled[0]:null)?.actor??game.user.character??game.actors.find(a=>a.isOwner&&a.isOfType("character","npc")&&a.isAllyOf(actor));return!!createTradeArgs(actor,selfActor)},"condition"),callback:__name2(li=>{const selfActor=(canvas.tokens.controlled.length===1?canvas.tokens.controlled[0]:null)?.actor??game.user.character;if(!selfActor?.isOfType("character","npc")){ui.notifications.warn(TradeDialog.localize("Error.SelectToken"));return}const traderActor=game.actors.get(li.dataset.entryId,{strict:!0}),checkReach=game.pf2e.settings.automation.reachEnforcement.has("merchants"),args=createTradeArgs(traderActor,selfActor,checkReach);args&&TradeDialog.requestTrade(args)},"callback")},{name:"PF2E.Actor.Party.Sidebar.RemoveMember",icon:foundry.applications.fields.createFontAwesomeIcon("eject").outerHTML,condition:__name2(li=>game.user.isGM&&!!li.closest("[data-party]")&&!li.closest(".folder-header"),"condition"),callback:__name2(li=>{const actorId=li.dataset.entryId,partyId=li.closest("[data-party]")?.dataset.entryId,actor=game.actors.get(actorId??""),party=game.actors.get(partyId??"");actor&&party instanceof PartyPF2e&&party.removeMembers(actor.uuid)},"callback")}),entries}static async#togglePartyFolder(event2){const folderEl=htmlClosest(event2.target,"header"),entryEl=htmlClosest(folderEl,"li"),partyId=entryEl?.dataset.entryId??"";entryEl&&partyId&&(this.#extraFolders[partyId]=!entryEl.classList.contains("expanded"),entryEl.classList.toggle("expanded",this.#extraFolders[partyId]),this.isPopout&&this.setPosition(),await this.saveActivePartyFolderState())}static async#openPartySheet(event2){const documentId=htmlClosest(event2.target,"[data-entry-id]")?.dataset.entryId;game.actors.get(documentId??"")?.sheet.render(!0)}static async#activateParty(event2){const documentId=htmlClosest(event2.target,"[data-entry-id]")?.dataset.entryId??"";game.actors.has(documentId)&&(game.settings.set("pf2e","activeParty",documentId),this.saveActivePartyFolderState())}static async#createParty(event2){await ActorPF2e.createDialog({type:"party"});const partyId=htmlClosest(event2.target,"[data-entry-id]")?.dataset.entryId;partyId&&(this.#extraFolders[partyId]=!0,this.render())}static async#createPartyMember(event2,button){const documentId=htmlClosest(event2.target,"[data-entry-id]")?.dataset.entryId,party=game.actors.get(documentId??"");if(!party?.isOfType("party"))return;const options={types:[...CREATURE_ACTOR_TYPES],position:{width:320,left:window.innerWidth-630,top:button.offsetTop??0}},actor=await ActorPF2e.createDialog({prototypeToken:{actorLink:!0}},{},options);actor?.isOfType("creature")&&(this.#extraFolders[party.id]=!0,await party.addMembers(actor))}}class ChatLogPF2e extends foundry.applications.sidebar.tabs.ChatLog{static{__name(this,"ChatLogPF2e")}static{__name2(this,"ChatLogPF2e")}static DEFAULT_OPTIONS={actions:{activate:ChatLogPF2e.#onClickActivate,applyDamage:ChatLogPF2e.#onClickApplyDamage,applyEffect:ChatLogPF2e.#onClickApplyEffect,findToken:ChatLogPF2e.#onClickFindToken,kingdomCollect:ChatLogPF2e.#onClickKingdomAction,revertDamage:ChatLogPF2e.#onClickRevertDamage,recoverPersistentDamage:ChatLogPF2e.#onClickRecoverPersistent,setAsInitiative:ChatLogPF2e.#onClickSetAsInitiative,shieldBlock:ChatLogPF2e.#onClickShieldBlock}};async _onRender(context,options){if(await super._onRender(context,options),!options.parts.includes("log"))return;const log=htmlQuery(this.element,"ol.chat-log");if(!log)throw ErrorPF2e("Unexpected failure to find ChatLog element");log.dataset.tooltipDirection="UP",log.addEventListener("dblclick",async event2=>{const{message}=ChatLogPF2e.#messageFromEvent(event2);if((message?htmlClosest(event2.target,".message-sender"):null)&&message)return ChatLogPF2e.#onClickFindToken.call(this,event2)})}async processMessage(message,options={}){const[command,matches]=ChatLogPF2e.parse(message)??[];if(!["roll","publicroll","gmroll","blindroll","selfroll"].includes(command)||!Array.isArray(matches))return super.processMessage(message,options);const speaker=options.speaker??=ChatMessagePF2e.getSpeaker(),chatData={speaker,author:game.user.id,flavor:""},rollData=(ChatMessagePF2e.getSpeakerActor(speaker)??game.user.character)?.getRollData()??{},rolls=[];for(const match of matches.filter(m=>!!m)){const[formula,flavor]=match.slice(2,4);flavor&&!chatData.flavor&&(chatData.flavor=flavor);const roll=await(()=>{try{const damageRoll=new DamageRoll(formula,rollData),allowInteractive=(command==="roll"?game.settings.get("core","rollMode"):command)!=="blindroll";return looksLikeDamageRoll(damageRoll)?damageRoll.evaluate({allowInteractive}):null}catch{return null}})();if(roll)rolls.push(roll);else return super.processMessage(message,options)}if(Hooks.call("chatMessage",this,message,chatData)===!1)return;chatData.rolls=rolls.map(r2=>JSON.stringify(r2.toJSON())),chatData.sound??=CONFIG.sounds.dice,chatData.content=rolls.reduce((t2,r2)=>t2+r2.total,0).toString();const operation={rollMode:objectHasKey(CONFIG.Dice.rollModes,command)?command:game.settings.get("core","rollMode")};return ChatMessagePF2e.create(chatData,operation)}static#messageFromEvent(event2){const element=htmlClosest(event2?.target,"li[data-message-id]"),messageId=element?.dataset.messageId??"",message=game.messages.get(messageId);return element&&message?{element,message}:{element:null,message:null}}static async onRenderChatPopout(popout,options){options.isFirstRender&&Object.assign(popout.options.actions,t$3(this.DEFAULT_OPTIONS.actions,["activate","applyDamage","applyEffect","findToken","revertDamage","recoverPersistentDamage","setAsInitiative","shieldBlock"]))}static async#onClickActivate(event2,button){const{message}=ChatLogPF2e.#messageFromEvent(event2);if(!message)throw ErrorPF2e("Unexpected failure to acquire message");const uuid=button.dataset.uuid??"",item=await fromUuid(uuid);if(!item?.isOfType("physical")||item.quantity===0){ui.notifications.warn("PF2E.Item.Activation.Warning.ItemDoesNotExist",{localize:!0});return}await item.toMessage()}static async#onClickApplyDamage(event2,button){const{message}=ChatLogPF2e.#messageFromEvent(event2);if(!message)throw ErrorPF2e("Unexpected failure to acquire message");const multiplier=Number(button.dataset.multiplier),rollIndex=Number(htmlClosest(button,"[data-roll-index]")?.dataset.rollIndex)||0;return applyDamageFromMessage({message,multiplier,rollIndex,addend:0,promptModifier:event2.shiftKey})}static async#onClickApplyEffect(event2,button){if(!(button instanceof HTMLButtonElement))return;button.disabled=!0;const target=fromUuidSync(button.dataset.targets??""),message=ChatLogPF2e.#messageFromEvent(event2).message,{actor,item}=message??{};if(!message||!actor||!item)return;const effect=item.isOfType("action","feat")&&item.system.selfEffect?await fromUuid(item.system.selfEffect.uuid):null;if(!(target instanceof ActorPF2e)||!(effect instanceof EffectPF2e))return;const traits=item.system.traits.value?.filter(t2=>t2 in EffectPF2e.validTraits)??[],effectSource=foundry.utils.mergeObject(effect.toObject(),{_id:null,system:{context:{origin:{actor:actor.uuid,token:message.token?.uuid??null,item:item.uuid,spellcasting:null,rollOptions:item.getOriginData().rollOptions},target:{actor:target.uuid,token:target.getActiveTokens(!0,!0).at(0)?.uuid??null},roll:null},traits:{value:traits}}});await target.createEmbeddedDocuments("Item",[effectSource]);const parsedMessageContent=(()=>{const container=document.createElement("div");return container.innerHTML=message.content,container})(),buttons=htmlQuery(parsedMessageContent,".message-buttons");if(buttons){const span=createHTMLElement("span",{classes:["effect-applied"]}),anchor=effect.toAnchor({attrs:{draggable:"true"}}),statement=game.i18n.format("PF2E.Item.Ability.SelfAppliedEffect.Applied",{effect:anchor.outerHTML});span.innerHTML=statement,htmlQuery(buttons,"button[data-action=applyEffect]")?.replaceWith(span),await message.update({content:parsedMessageContent.innerHTML})}}static async#onClickSetAsInitiative(event2){const{message}=ChatLogPF2e.#messageFromEvent(event2);if(!message)return;const{speakerActor:actor,token}=message??{};if(!token){ui.notifications.error("PF2E.Encounter.NoTokenInScene",{format:{actor:message.actor?.name??message.author?.name??""}});return}if(!actor?.isOwner)return;const combatant=await CombatantPF2e.fromActor(actor);if(!combatant)return;const value=message.rolls.at(0)?.total??0,statistic=message.flags.pf2e.modifierName?String(message.flags.pf2e.modifierName):void 0;await combatant.encounter.setInitiative(combatant.id,value,statistic),ui.notifications.info("PF2E.Encounter.InitiativeSet",{format:{actor:token.name,initiative:value}})}static async#onClickKingdomAction(event2){const{message,element:messageEl}=ChatLogPF2e.#messageFromEvent(event2);if(!message||!messageEl)return;const party=message.actor??game.actors.party;if(!party?.isOfType("party")||!party?.isOwner||!(party?.campaign instanceof Kingdom))return;await party.campaign.collect();const content=createHTMLElement("div",{innerHTML:message.content});htmlQuery(content,"[data-action=kingdomCollect]")?.replaceWith(createHTMLElement("div",{classes:["confirmation"],children:[fontAwesomeIcon("fa-check"),"Resources Collected"]})),await message.update({content:content.innerHTML})}static async#onClickRevertDamage(event2,button){const{message,element}=ChatLogPF2e.#messageFromEvent(event2),appliedDamage=message?.flags.pf2e.appliedDamage;if(!appliedDamage)return;const actor=fromUuidSync(appliedDamage.uuid);actor instanceof ActorPF2e&&(await actor.undoDamage(appliedDamage),ui.notifications.info(game.i18n.format(`PF2E.RevertDamage.${appliedDamage.isHealing?"Healing":"Damage"}Message`,{actor:actor.name})),htmlQuery(element,"span.statements")?.classList.add("reverted"),button.remove(),await message.update({"flags.pf2e.appliedDamage.isReverted":!0,content:htmlQuery(element,".message-content")?.innerHTML??message.content}))}static async#onClickRecoverPersistent(event2){const message=ChatLogPF2e.#messageFromEvent(event2).message,actor=message?.speakerActor,roll=message?.rolls.find(r2=>r2 instanceof DamageRoll);if(!actor||!roll)return;const damageType=roll.instances.find(i=>i.persistent)?.type;if(!damageType)return;const condition=actor.getCondition(`persistent-damage-${damageType}`);if(!condition?.system.persistent){const damageTypeLocalized=game.i18n.localize(CONFIG.PF2E.damageTypes[damageType]??damageType),message2=game.i18n.format("PF2E.Item.Condition.PersistentDamage.Error.DoesNotExist",{damageType:damageTypeLocalized});ui.notifications.warn(message2);return}await condition.rollRecovery()}static async#onClickShieldBlock(event2,button){const{element:messageEl}=ChatLogPF2e.#messageFromEvent(event2),getTokens=__name2(()=>{const tokens=game.user.getActiveTokens();return tokens.length===0&&ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected",{localize:!0}),tokens},"getTokens"),getNonBrokenShields=__name2(tokens=>tokens.find(t2=>!!t2.actor)?.actor?.itemTypes.shield.filter(s=>s.isEquipped&&!s.isBroken&&!s.isDestroyed)??[],"getNonBrokenShields");button.classList.contains("tooltipstered")||$(button).tooltipster({animation:"fade",trigger:"click",arrow:!1,content:htmlQuery(messageEl,"div.hover-content"),contentAsHTML:!0,contentCloning:!0,debug:!1,interactive:!0,side:["top"],theme:"crb-hover",functionBefore:__name2(()=>{const tokens=getTokens();if(tokens.length===0)return!1;const nonBrokenShields=getNonBrokenShields(tokens),hasMultipleShields=tokens.length===1&&nonBrokenShields.length>1,shieldActivated=button.classList.contains("shield-activated");return hasMultipleShields&&!shieldActivated?!0:hasMultipleShields&&button.dataset.shieldId?(button.attributes.removeNamedItem("data-shield-id"),button.classList.remove("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!1,!0):(button.classList.toggle("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!CONFIG.PF2E.chatDamageButtonShieldToggle,!1)},"functionBefore"),functionFormat:__name2((instance,_helper,contentEl)=>{const tokens=getTokens(),nonBrokenShields=getNonBrokenShields(tokens),multipleShields=tokens.length===1&&nonBrokenShields.length>1,shieldActivated=button.classList.contains("shield-activated");if(multipleShields&&!shieldActivated){const listEl=htmlQuery(contentEl,"ul.shield-options");if(!listEl)return $(contentEl);const shieldList=nonBrokenShields.map(shield=>{const input=document.createElement("input");input.classList.add("data"),input.type="radio",input.name="shield-id",input.value=shield.id,input.addEventListener("click",()=>{button.dataset.shieldId=input.value,button.classList.add("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!0,instance.close()});const shieldName=document.createElement("span");shieldName.classList.add("label"),shieldName.innerHTML=shield.name;const hardness=document.createElement("span");hardness.classList.add("tag");const hardnessLabel=game.i18n.localize("PF2E.HardnessLabel");hardness.innerHTML=`${hardnessLabel}: ${shield.hardness}`;const itemLi=document.createElement("li");return itemLi.classList.add("item"),itemLi.append(input,shieldName,hardness),itemLi});listEl.replaceChildren(...shieldList)}return $(contentEl)},"functionFormat")}).tooltipster("open")}static async#onClickFindToken(event2){if(!canvas.ready)return;const{message}=ChatLogPF2e.#messageFromEvent(event2),token=message?.token?.object;if(!(!token?.isVisible||!token.isOwner)&&(token.controlled?token.release():token.control({releaseOthers:!event2.shiftKey}),event2.type==="dblclick")){const scale=Math.max(1,canvas.stage.scale.x);canvas.animatePan({...token.center,scale,duration:1e3})}}_getEntryContextOptions(){const canApplyDamage=__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});return canvas.tokens.controlled.length>0&&message.rolls.some(r2=>r2 instanceof DamageRoll)},"canApplyDamage"),canApplyTripleDamage=__name2(li=>canApplyDamage(li)&&game.pf2e.settings.critFumble.buttons,"canApplyTripleDamage"),canReroll=__name2(li=>game.messages.get(li.dataset.messageId,{strict:!0}).isRerollable,"canReroll"),canHeroPointReroll=__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0}),messageActor=message.actor,actor=messageActor?.isOfType("familiar")?messageActor.master:messageActor;return message.isRerollable&&!!actor?.isOfType("character")&&actor.heroPoints.value>0},"canHeroPointReroll"),canMythicPointReroll=__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0}),actor=message.actor;return message.isRerollable&&!!actor?.isOfType("character")&&actor.system.resources.mythicPoints.value>0},"canMythicPointReroll"),canShowRollDetails=__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});return game.user.isGM&&!!message.flags.pf2e.context},"canShowRollDetails"),options=super._getEntryContextOptions();return options.push({name:"PF2E.ChatRollDetails.Select",icon:foundry.applications.fields.createFontAwesomeIcon("face-monocle").outerHTML,condition:canShowRollDetails,callback:__name2(li=>{game.messages.get(li.dataset.messageId,{strict:!0}).showDetails()},"callback")},{name:"PF2E.DamageButton.FullContext",icon:foundry.applications.fields.createFontAwesomeIcon("heart-broken").outerHTML,condition:canApplyDamage,callback:__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});applyDamageFromMessage({message})},"callback")},{name:"PF2E.DamageButton.HalfContext",icon:foundry.applications.fields.createFontAwesomeIcon("heart-broken").outerHTML,condition:canApplyDamage,callback:__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});applyDamageFromMessage({message,multiplier:.5})},"callback")},{name:"PF2E.DamageButton.DoubleContext",icon:foundry.applications.fields.createFontAwesomeIcon("heart-broken").outerHTML,condition:canApplyDamage,callback:__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});applyDamageFromMessage({message,multiplier:2})},"callback")},{name:"PF2E.DamageButton.TripleContext",icon:foundry.applications.fields.createFontAwesomeIcon("heart-broken").outerHTML,condition:canApplyTripleDamage,callback:__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});applyDamageFromMessage({message,multiplier:3})},"callback")},{name:"PF2E.DamageButton.HealingContext",icon:foundry.applications.fields.createFontAwesomeIcon("heart").outerHTML,condition:canApplyDamage,callback:__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});applyDamageFromMessage({message,multiplier:-1})},"callback")},{name:"PF2E.RerollMenu.HeroPoint",icon:foundry.applications.fields.createFontAwesomeIcon("hospital-symbol").outerHTML,condition:canHeroPointReroll,callback:__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});Check.rerollFromMessage(message,{resource:"hero-points"})},"callback")},{name:"PF2E.RerollMenu.MythicPoint",icon:foundry.applications.fields.createFontAwesomeIcon("circle-m").outerHTML,condition:canMythicPointReroll,callback:__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});Check.rerollFromMessage(message,{resource:"mythic-points"})},"callback")},{name:"PF2E.RerollMenu.KeepNew",icon:foundry.applications.fields.createFontAwesomeIcon("dice").outerHTML,condition:canReroll,callback:__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});Check.rerollFromMessage(message)},"callback")},{name:"PF2E.RerollMenu.KeepLower",icon:foundry.applications.fields.createFontAwesomeIcon("dice-one").outerHTML,condition:canReroll,callback:__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});Check.rerollFromMessage(message,{keep:"lower"})},"callback")},{name:"PF2E.RerollMenu.KeepHigher",icon:foundry.applications.fields.createFontAwesomeIcon("dice-six").outerHTML,condition:canReroll,callback:__name2(li=>{const message=game.messages.get(li.dataset.messageId,{strict:!0});Check.rerollFromMessage(message,{keep:"higher"})},"callback")}),options}}const tabs=foundry.applications.sidebar.tabs;class EncounterTracker extends tabs.CombatTracker{static{__name(this,"EncounterTracker")}static{__name2(this,"EncounterTracker")}static DEFAULT_OPTIONS={actions:{toggleTarget:EncounterTracker.#onClickToggleTarget,toggleNameVisibility:EncounterTracker.#onClickToggleNameVisibility}};static PARTS={...super.PARTS,metrics:{template:"systems/pf2e/templates/sidebar/encounter-tracker/metrics.hbs"}};#sortable=null;_configureRenderOptions(options){const parts=options.parts??[];parts.includes("tracker")&&!parts.includes("metrics")&&parts.push("metrics"),super._configureRenderOptions(options)}async _preparePartContext(partId,context,options){const partContext=await super._preparePartContext(partId,context,options);return partId==="metrics"&&Object.assign(partContext,{metrics:this.#prepareMetrics()}),partContext}#prepareMetrics(){const notVisible={visible:!1,threat:{label:"",tooltip:""},award:{label:"",tooltip:""}};if(!game.user.isGM)return notVisible;const metrics=this.viewed?.metrics;if(!metrics)return notVisible;const localize=localizer("PF2E.Encounter.Metrics"),threat=(()=>{const label=game.i18n.localize(`PF2E.Encounter.Budget.Threats.${metrics.threat}`),tempContainer=createHTMLElement("div",{innerHTML:localize("Threat",{threat:label})});TextEditorPF2e.convertXMLNode(tempContainer,"threat",{classes:["value",metrics.threat]});const tooltip=localize("Budget",metrics.budget);return{label:tempContainer.innerHTML,tooltip}})(),award=(()=>{const tempContainer=createHTMLElement("div",{innerHTML:localize("Award.Label",{xp:metrics.award.xp})});TextEditorPF2e.convertXMLNode(tempContainer,"award",{classes:["value"]});const numRecipients=metrics.award.recipients.length,tooltip=localize(numRecipients===1?"Award.Tooltip.Singular":numRecipients===4?"Award.Tooltip.Four":"Award.Tooltip.Plural",{xpPerFour:metrics.budget.spent,recipients:numRecipients});return{label:tempContainer.innerHTML,tooltip}})();return{visible:!0,threat,award}}async _renderHTML(context,options){const result=await super._renderHTML(context,options);return result.tracker&&this.#onRenderTracker(result.tracker),result}async _onRender(context,options){if(await super._onRender(context,options),options.parts.includes("header")){const metricsPart=this.parts.metrics;metricsPart.remove(),this.parts.header.querySelector("nav")?.after(metricsPart)}game.user.isGM&&this.#createSortable()}#onRenderTracker(tracker){const encounter=this.viewed;if(!encounter||!tracker)return;const tokenSetsNameVisibility=game.pf2e.settings.tokens.nameVisibility,nameVisibilityButton=tokenSetsNameVisibility?createHTMLElement("button",{classes:["inline-control","combatant-control","icon","fa-solid","fa-signature"],dataset:{action:"toggleNameVisibility",tooltip:!0}}):null;nameVisibilityButton&&(nameVisibilityButton.type="button");const allyColor=__name2(c=>c.actor?.hasPlayerOwner?CONFIG.Canvas.dispositionColors.PARTY:CONFIG.Canvas.dispositionColors.FRIENDLY,"allyColor"),combatantRows=tracker.querySelectorAll("li");for(const row of combatantRows){const combatantId=row.dataset.combatantId??"",combatant=encounter.combatants.get(combatantId,{strict:!0});if(typeof combatant.initiative=="number"&&(row.dataset.initiative=String(combatant.initiative)),combatant?.actor&&this.viewed?.combatant===combatant){const alliance=combatant.actor.alliance,dispositionColor=new Color(alliance==="party"?allyColor(combatant):alliance==="opposition"?CONFIG.Canvas.dispositionColors.HOSTILE:CONFIG.Canvas.dispositionColors.NEUTRAL);row.style.cssText=[`--color-border-disposition: ${dispositionColor.toString()}`,`--entry-active-bg: ${dispositionColor.toRGBA(.1)}`].join(`;
`)}const nameHeader=htmlQuery(row,".token-name > strong");if(nameHeader){nameHeader.innerHTML=[createHTMLElement("span",{classes:["name"],children:[nameHeader.innerText]}).outerHTML,createHTMLElement("span",{classes:["users-targeting"]}).outerHTML].join("");for(const button of htmlQueryAll(row,".combatant-controls button"))if(button.dataset.action==="pingCombatant"&&(button.classList.remove("fa-bullseye-arrow"),button.classList.add("fa-signal-stream"),game.scenes.viewed?.tokens.has(combatant.token?.id??""))){const targetButton=button.cloneNode(!0);targetButton.classList.replace("fa-solid","fa-duotone"),targetButton.classList.replace("fa-signal-stream","fa-location-crosshairs"),targetButton.dataset.action="toggleTarget",targetButton.ariaLabel=game.i18n.localize("COMBAT.ToggleTargeting"),button.before(targetButton)}if(this.refreshTargetDisplay(combatant,[tracker]),tokenSetsNameVisibility&&nameVisibilityButton){const nameElement=htmlQuery(nameHeader,"span.name");if(nameElement&&!game.user.isGM&&!combatant.playersCanSeeName&&(nameElement.innerText="",row.querySelector("img.token-image")?.removeAttribute("title")),game.user.isGM&&combatant.actor&&combatant.actor.alliance!=="party"){const isActive=combatant.playersCanSeeName,controlButton=nameVisibilityButton.cloneNode(!0);controlButton.ariaLabel=game.i18n.localize(`PF2E.Encounter.${isActive?"Hide":"Reveal"}Name`),controlButton.classList.toggle("active",isActive),row.querySelector(".combatant-controls button[data-action=toggleHidden]")?.after(controlButton),row.classList.toggle("hidden-name",!isActive)}}}}}refreshTargetDisplay(combatantOrToken,trackers){if(!this.viewed||!canvas.ready)return;const{combatant,tokenDoc}=combatantAndTokenDoc(combatantOrToken);if(!(combatant?.encounter!==this.viewed||tokenDoc?.combatant!==combatant)){trackers??=htmlQueryAll(document,"#combat, #combat-popout");for(const tracker of trackers){const combatantRow=htmlQuery(tracker,`li.combatant[data-combatant-id="${combatant?.id??null}"]`);if(!combatantRow)return;const usersTargetting=game.users.filter(u=>Array.from(u.targets).some(t2=>t2.document===tokenDoc)),userIndicators=usersTargetting.map(user=>{const icon=fontAwesomeIcon("location-crosshairs",{style:"duotone",fixedWidth:!0});return icon.style.color=user.color.toString(),icon}),targetingSection=htmlQuery(combatantRow,".users-targeting");targetingSection&&(targetingSection.innerHTML=userIndicators.map(i=>i.outerHTML).join(""),targetingSection.dataset.tooltip=game.i18n.format("COMBAT.TargetedBy",{list:localizeList(usersTargetting.map(u=>u.name),{conjunction:"and"})}));const targetControlIcon=htmlQuery(combatantRow,"a.combatant-control[data-control=toggleTarget]");usersTargetting.includes(game.user)?targetControlIcon?.classList.add("active"):targetControlIcon?.classList.remove("active")}}}async _onClickAction(event2,target){const action2=target.dataset.action;if((action2==="rollNPC"||action2==="rollAll")&&this.viewed){event2.stopPropagation();const args=eventToRollParams(event2,{type:"check"});await this.viewed[action2]({...args,messageOptions:{rollMode:args.rollMode}});return}return super._onClickAction(event2,target)}async _onCombatantControl(event2,target){if(!this.viewed)return;const action2=target.dataset.action,li=target.closest("li"),combatant=this.viewed.combatants.get(li?.dataset.combatantId??"",{strict:!0});if(action2==="rollInitiative"){await this.viewed.rollInitiative([combatant.id],eventToRollParams(event2,{type:"check"}));return}return super._onCombatantControl(event2,target)}_onToggleDefeatedStatus(combatant){return combatant.toggleDefeated()}static async#onClickToggleTarget(event2,target){const combatantId=target.closest("li")?.dataset.combatantId,tokenDoc=this.viewed.combatants.get(combatantId,{strict:!0}).token;if(!tokenDoc)return;const isTargeted=game.user.targets.values().some(t2=>t2.document===tokenDoc);if(!tokenDoc.object?.visible){ui.notifications.warn("COMBAT.PingInvisibleToken",{localize:!0});return}tokenDoc.object.setTarget(!isTargeted,{releaseOthers:!event2?.shiftKey})}static async#onClickToggleNameVisibility(_event,target){const combatantId=target?.closest("li")?.dataset.combatantId;return this.viewed.combatants.get(combatantId,{strict:!0}).toggleNameVisibility()}#createSortable(){this.#sortable?.destroy();const listEl=this.element.querySelector("ol.combat-tracker");listEl&&(this.#sortable=Sortable.create(listEl,{animation:200,dataIdAttr:"data-combatant-id",direction:"vertical",dragClass:"drag-preview",dragoverBubble:!0,easing:"cubic-bezier(1, 0, 0, 1)",ghostClass:"drag-gap",onEnd:this.#adjustFinalOrder.bind(this),onUpdate:this.#onDropCombatant.bind(this)}))}async#onDropCombatant(event2){this.#validateDrop(event2);const encounter=this.viewed;if(!encounter)return;const droppedId=event2.item.getAttribute("data-combatant-id")??"",dropped=encounter.combatants.get(droppedId,{strict:!0});if(typeof dropped.initiative!="number"){ui.notifications.error("PF2E.Encounter.HasNoInitiativeScore",{format:{actor:dropped.name}});return}const newOrder=this.#getCombatantsFromDOM(),oldOrder=encounter.turns.filter(c=>c.initiative!==null);newOrder.every(c=>newOrder.indexOf(c)===oldOrder.indexOf(c))||(this.#setInitiativeFromDrop(newOrder,dropped),await this.#saveNewOrder(newOrder))}#setInitiativeFromDrop(newOrder,dropped){const aboveDropped=newOrder.find(c=>newOrder.indexOf(c)===newOrder.indexOf(dropped)-1),belowDropped=newOrder.find(c=>newOrder.indexOf(c)===newOrder.indexOf(dropped)+1),hasAboveAndBelow=!!aboveDropped&&!!belowDropped,hasAboveAndNoBelow=!!aboveDropped&&!belowDropped,hasBelowAndNoAbove=!aboveDropped&&!!belowDropped,aboveIsHigherThanBelow=hasAboveAndBelow&&belowDropped.initiative<aboveDropped.initiative,belowIsHigherThanAbove=hasAboveAndBelow&&belowDropped.initiative<aboveDropped.initiative,wasDraggedUp=!!belowDropped&&this.viewed?.getCombatantWithHigherInit(dropped,belowDropped)===belowDropped,wasDraggedDown=!!aboveDropped&&!wasDraggedUp;dropped.initiative=hasBelowAndNoAbove||aboveIsHigherThanBelow&&wasDraggedUp?belowDropped.initiative+1:hasAboveAndNoBelow||belowIsHigherThanAbove&&wasDraggedDown?aboveDropped.initiative-1:hasAboveAndBelow?belowDropped.initiative:dropped.initiative;const withSameInitiative=newOrder.filter(c=>c.initiative===dropped.initiative);if(withSameInitiative.length>1)for(let priority=0;priority<withSameInitiative.length;priority++)withSameInitiative[priority].flags.pf2e.overridePriority[dropped.initiative]=priority}async#saveNewOrder(newOrder){await this.viewed?.setMultipleInitiatives(newOrder.map(c=>({id:c.id,value:c.initiative,overridePriority:c.overridePriority(c.initiative)})))}#adjustFinalOrder(event2){const row=event2.item,tracker=this.element.querySelector("ol.combat-tracker");if(!tracker)throw ErrorPF2e("Unexpected failure to retriever tracker DOM element");const rows=tracker.querySelectorAll("li"),[oldIndex,newIndex]=[event2.oldIndex??0,event2.newIndex??0],firstRowWithNoRoll=rows.values().find(r2=>Number.isNaN(Number(r2.dataset.initiative)));Number.isNaN(Number(row.dataset.initiative))?newIndex>oldIndex?tracker.insertBefore(row,rows[oldIndex]):tracker.insertBefore(row,rows[oldIndex+1]):firstRowWithNoRoll&&Array.from(rows).indexOf(firstRowWithNoRoll)<newIndex&&tracker.insertBefore(row,firstRowWithNoRoll)}#validateDrop(event2){if(!this.viewed)throw ErrorPF2e("Unexpected error retrieving combat");const{oldIndex,newIndex}=event2;if(!(typeof oldIndex=="number"&&typeof newIndex=="number"))throw ErrorPF2e("Unexpected error retrieving new index")}#getCombatantsFromDOM(){const encounter=this.viewed;if(!encounter)throw ErrorPF2e("Unexpected error retrieving combat");return this.element.querySelectorAll("ol.combat-tracker > li").values().map(row=>encounter.combatants.get(row.dataset.combatantId,{strict:!0})).filter(c=>typeof c.initiative=="number").toArray()}}class ItemDirectoryPF2e extends foundry.applications.sidebar.tabs.ItemDirectory{static{__name(this,"ItemDirectoryPF2e")}static{__name2(this,"ItemDirectoryPF2e")}static _entryPartial="systems/pf2e/templates/sidebar/item-document-partial.hbs";static DEFAULT_OPTIONS={renderUpdateKeys:["system.level.value"]};async _onRender(context,options){await super._onRender(context,options);for(const element of htmlQueryAll(this.element,"li.directory-item.item"))game.items.get(element.dataset.documentId??"")?.testUserPermission(game.user,"OBSERVER")||element.querySelector("span.item-level")?.remove();this.#appendBrowseButton()}_getEntryContextOptions(){const options=super._getEntryContextOptions();return options.push({name:"PF2E.Item.Physical.Attach.SidebarContextMenuOption",icon:fontAwesomeIcon("paperclip").outerHTML,condition:__name2(li=>{const item=game.items.get(li.dataset.entryId,{strict:!0});return item.isOwner&&item.isOfType("physical")&&game.items.some(i=>i!==item&&i.isOwner&&i.isOfType("physical")&&i.acceptsSubitem(item))},"condition"),callback:__name2(li=>{const item=game.items.get(li.dataset.entryId,{strict:!0});item.isOwner&&item.isOfType("physical")&&game.items.some(i=>i!==item&&i.isOwner&&i.isOfType("physical")&&i.acceptsSubitem(item))&&new ItemAttacher({item}).render(!0)},"callback")}),options}#appendBrowseButton(){const browseButton=document.createElement("button");browseButton.type="button",browseButton.append(fontAwesomeIcon("search",{fixedWidth:!0})," ",game.i18n.localize("PF2E.CompendiumBrowser.Title")),browseButton.addEventListener("click",()=>{game.pf2e.compendiumBrowser.render({force:!0})}),htmlQuery(this.element,"footer.directory-footer")?.append(browseButton)}}const darkvision=new foundry.canvas.perception.VisionMode({id:"darkvision",label:"VISION.ModeDarkvision",canvas:{shader:foundry.canvas.rendering.shaders.ColorAdjustmentsSamplerShader,uniforms:{enable:!0,contrast:0,saturation:-1,brightness:0}},lighting:{levels:{},background:{visibility:foundry.canvas.perception.VisionMode.LIGHTING_VISIBILITY.REQUIRED}},vision:{darkness:{adaptive:!0},defaults:{attenuation:0,contrast:0,saturation:-1,brightness:0}}});class LightPerceptionMode extends foundry.canvas.perception.DetectionModeLightPerception{static{__name(this,"LightPerceptionMode")}static{__name2(this,"LightPerceptionMode")}constructor(){super({id:"lightPerception",label:"DETECTION.LightPerception",type:foundry.canvas.perception.DetectionMode.DETECTION_TYPES.SIGHT,angle:!1})}_canDetect(visionSource,target){return target instanceof foundry.canvas.placeables.PlaceableObject&&target.document.hidden||target instanceof TokenPF2e&&target.actor?.hasCondition("hidden","undetected","unnoticed")?!1:super._canDetect(visionSource,target)}}class VisionDetectionMode extends foundry.canvas.perception.DetectionModeDarkvision{static{__name(this,"VisionDetectionMode")}static{__name2(this,"VisionDetectionMode")}constructor(){super({id:"basicSight",label:"DETECTION.BasicSight",type:foundry.canvas.perception.DetectionMode.DETECTION_TYPES.SIGHT,angle:!1})}_canDetect(visionSource,target){return target instanceof foundry.canvas.placeables.PlaceableObject&&target.document.hidden||target instanceof TokenPF2e&&target.actor?.hasCondition("hidden","undetected","unnoticed")?!1:super._canDetect(visionSource,target)}}class HearingDetectionMode extends foundry.canvas.perception.DetectionMode{static{__name(this,"HearingDetectionMode")}static{__name2(this,"HearingDetectionMode")}constructor(){super({id:"hearing",label:"PF2E.Actor.Creature.Sense.Type.Hearing",type:foundry.canvas.perception.DetectionMode.DETECTION_TYPES.SOUND,angle:!1})}static getDetectionFilter(){const filter=this._detectionFilter??=foundry.canvas.rendering.filters.OutlineOverlayFilter.create({wave:!0});return filter.thickness=1,filter}_canDetect(visionSource,target){return!(target instanceof TokenPF2e)||target.document.hidden||!target.actor?.emitsSound?!1:game.pf2e.settings.rbv?target.actor?.hasCondition("undetected","unnoticed")?!1:!visionSource.object?.actor?.hasCondition("deafened"):!0}_testLOS(visionSource,_mode,_target,test){test.loh??=new Map;const hasLOH=test.loh.get(visionSource)??!CONFIG.Canvas.polygonBackends.sound.testCollision(visionSource.origin,test.point,{type:"sound",mode:"any",source:visionSource,wallDirectionMode:foundry.canvas.geometry.PointSourcePolygon.WALL_DIRECTION_MODES.REVERSED,useThreshold:!0});return test.loh.set(visionSource,hasLOH),hasLOH}}class DetectionModeTremorPF2e extends foundry.canvas.perception.DetectionModeTremor{static{__name(this,"DetectionModeTremorPF2e")}static{__name2(this,"DetectionModeTremorPF2e")}constructor(){super({id:"feelTremor",label:"DETECTION.FeelTremor",walls:!1,type:foundry.canvas.perception.DetectionMode.DETECTION_TYPES.MOVE})}static getDetectionFilter(){const filter=super.getDetectionFilter();return filter.thickness=1,filter}_canDetect(visionSource,target){return super._canDetect(visionSource,target)&&target instanceof TokenPF2e&&!target.document.hidden&&!target.actor?.isOfType("loot")&&!target.actor?.hasCondition("undetected","unnoticed")}}function setPerceptionModes(){CONFIG.Canvas.visionModes.darkvision=darkvision,CONFIG.Canvas.detectionModes.basicSight=new VisionDetectionMode,CONFIG.Canvas.detectionModes.lightPerception=new LightPerceptionMode,CONFIG.Canvas.detectionModes.hearing=new HearingDetectionMode,CONFIG.Canvas.detectionModes.feelTremor=new DetectionModeTremorPF2e}__name(setPerceptionModes,"setPerceptionModes"),__name2(setPerceptionModes,"setPerceptionModes");const appv1$6=foundry.appv1;class JournalSheetPF2e extends appv1$6.sheets.JournalSheet{static{__name(this,"JournalSheetPF2e")}static{__name2(this,"JournalSheetPF2e")}async getData(options){const sheetData=await super.getData(options);for(const entry of sheetData.toc)entry.number+=1;return sheetData}}var define_EN_JSON_default={PF2E:{Check:{DC:{Label:{AdjustedTarget:"<opposer>Target: {opposer}</opposer> <dc>({dcType} <preadjusted>{preadjusted}</preadjusted> <adjusted>{adjusted}</adjusted>)</dc>",NoChangeTarget:"<opposer>Target: {opposer}</opposer> <dc>({dcType} <adjusted>{adjusted}</adjusted>)</dc>",NoTarget:"<dc>{dcType} {dc}</dc>",WithTarget:"<opposer>Target: {opposer}</opposer> <dc>({dcType} {dc})</dc>",WithOrigin:"<opposer>Origin: {opposer}</opposer> <dc>({dcType} {dc})</dc>"},Specific:{armor:"AC",athletics:"Athletics DC",deception:"Deception DC",fortitude:"Fortitude DC",perception:"Perception DC",reflex:"Reflex DC",stealth:"Stealth DC",will:"Will DC"},Unspecific:"DC"}},Item:{Armor:{Base:{"armored-cloak":"Armored Cloak","armored-coat":"Armored Coat","bastion-plate":"Bastion Plate",breastplate:"Breastplate","buckle-armor":"Buckle Armor","ceramic-plate":"Ceramic Plate","chain-mail":"Chain Mail","chain-shirt":"Chain Shirt","coral-armor":"Coral Armor","explorers-clothing":"Explorer's Clothing","fortress-plate":"Fortress Plate","full-plate":"Full Plate",gi:"Gi","half-plate":"Half Plate","hellknight-breastplate":"Hellknight Breastplate","hellknight-half-plate":"Hellknight Half Plate","hellknight-plate":"Hellknight Plate","hide-armor":"Hide Armor","kilted-breastplate":"Kilted Breastplate","lamellar-breastplate":"Lamellar Breastplate","lattice-armor":"Lattice Armor","leaf-weave":"Leaf Weave","leather-armor":"Leather Armor","leather-lamellar":"Leather Lamellar","mantis-shell":"Mantis Shell",niyahaat:"Niyah\xE1at","o-yoroi":"O-Yoroi","padded-armor":"Padded Armor","power-suit":"Power Suit","quilted-armor":"Quilted Armor","rattan-armor":"Rattan Armor",sankeit:"Sankeit","scale-mail":"Scale Mail","scroll-robes":"Scroll Robes","splint-mail":"Splint Mail","studded-leather-armor":"Studded Leather Armor","subterfuge-suit":"Subterfuge Suit","wooden-breastplate":"Wooden Breastplate"}},Deity:{Domain:{Abomination:{Description:"You seek to instill abhorrence and horror in those around you.",Label:"Abomination"},Air:{Description:"You can control winds and the weather.",Label:"Air"},AirApocryphal:{Description:"You can control winds and the weather. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Air (apocryphal)"},Ambition:{Description:"You strive to keep up with and outpace the competition.",Label:"Ambition"},AmbitionApocryphal:{Description:"You strive to keep up with and outpace the competition. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Ambition (apocryphal)"},Change:{Description:"You can restructure the physical and metaphysical.",Label:"Change"},Cities:{Description:"You have powers over urban environments and denizens.",Label:"Cities"},Cold:{Description:"You control ice, snow, and freezing temperatures.",Label:"Cold"},Confidence:{Description:"You overcome your fear and project pride.",Label:"Confidence"},ConfidenceApocryphal:{Description:"You overcome your fear and project pride. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Confidence (apocryphal)"},Creation:{Description:"You have divine abilities related to crafting and art.",Label:"Creation"},Darkness:{Description:"You operate in the darkness and take away the light.",Label:"Darkness"},DarknessApocryphal:{Description:"You operate in the darkness and take away the light. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Darkness (apocryphal)"},Death:{Description:"You have the power to end lives and destroy undead.",Label:"Death"},DeathApocryphal:{Description:"You have the power to end lives and destroy undead. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Death (apocryphal)"},Decay:{Description:"You have the power to spoil and deteriorate matter.",Label:"Decay"},Delirium:{Description:"You can bring about hallucinations and restlessness.",Label:"Disorientation"},Destruction:{Description:"You are a conduit for divine devastation.",Label:"Destruction"},Dreams:{Description:"You have the power to enter and manipulate dreams.",Label:"Dreams"},Dust:{Description:"You have the power to dry and crumble what opposes you.",Label:"Dust"},Duty:{Description:"You defend oaths and carry out your divine missions with great dedication.",Label:"Duty"},Earth:{Description:"You control soil and stone.",Label:"Earth"},Family:{Description:"You aid and protect your family and community more effectively.",Label:"Family"},Fate:{Description:"You see and understand hidden inevitabilities.",Label:"Fate"},FateApocryphal:{Description:"You see and understand hidden inevitabilities. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Fate (apocryphal)"},Fire:{Description:"You control flame.",Label:"Fire"},FireApocryphal:{Description:"You control flame. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Fire (apocryphal)"},Freedom:{Description:"You liberate yourself and others from shackles and constraints.",Label:"Freedom"},Glyph:{Description:"You wield power over written words and symbols.",Label:"Glyph"},Healing:{Description:"Your healing magic is particularly potent.",Label:"Healing"},Indulgence:{Description:"You feast mightily and can shake off the effects of overindulging.",Label:"Indulgence"},IndulgenceApocryphal:{Description:"You feast mightily and can shake off the effects of overindulging. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Indulgence (apocryphal)"},Introspection:{Description:"You guide others in examining their lives, emotions, and motivations to ultimately become a truer version of themselves\u2014a difficult and often painful process.",Label:"Introspection"},Knowledge:{Description:"You receive divine insights.",Label:"Knowledge"},KnowledgeApocryphal:{Description:"You receive divine insights. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Knowledge (apocryphal)"},Lightning:{Description:"You control electricity, thunder, and storms.",Label:"Lightning"},Luck:{Description:"You're unnaturally lucky and keep out of harm's way.",Label:"Luck"},Magic:{Description:"You perform the unexpected and inexplicable.",Label:"Magic"},Metal:{Description:"You manipulate flexible, mutable metal.",Label:"Metal"},Might:{Description:"Your physical power is bolstered by divine strength.",Label:"Might"},MightApocryphal:{Description:"Your physical power is bolstered by divine strength. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Might (apocryphal)"},Moon:{Description:"You command powers associated with the moon.",Label:"Moon"},Naga:{Description:"Like the serpentine nagas, you're in tune with cosmic forces that Ravithra once controlled.",Label:"Naga"},Nature:{Description:"You hold power over animals and plants.",Label:"Nature"},Nightmares:{Description:"You fill minds with horror and dread.",Label:"Nightmares"},Pain:{Description:"You punish those who displease you with the sharp sting of pain.",Label:"Pain"},Passion:{Description:"You evoke passion, whether as love or lust.",Label:"Passion"},Perfection:{Description:"You strive to perfect your mind, body, and spirit.",Label:"Perfection"},Plague:{Description:"You wield disease and pestilence like a weapon.",Label:"Plague"},Protection:{Description:"You ward yourself and others.",Label:"Protection"},Repose:{Description:"You ease mental burdens.",Label:"Repose"},Secrecy:{Description:"You protect secrets and keep them hidden.",Label:"Secrecy"},SecrecyApocryphal:{Description:"You protect secrets and keep them hidden. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Secrecy (apocryphal)"},Sorrow:{Description:"You have a painful connection to melancholy and sadness.",Label:"Sorrow"},Soul:{Description:"You wield power over the spiritual.",Label:"Soul"},Star:{Description:"You command the power of the stars.",Label:"Star"},Sun:{Description:"You harness the power of the sun and other light sources, and punish undead.",Label:"Sun"},Swarm:{Description:"You exert control over masses of creatures.",Label:"Swarm"},Time:{Description:"You reign over the flow of time.",Label:"Time"},Toil:{Description:"You work constantly and refuse to let anything stand in your way.",Label:"Toil"},Travel:{Description:"You have power over movement and journeys.",Label:"Travel"},TravelApocryphal:{Description:"You have power over movement and journeys. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Travel (apocryphal)"},Trickery:{Description:"You deceive others and cause mischief.",Label:"Trickery"},Truth:{Description:"You pierce lies and discover the truth.",Label:"Truth"},Tyranny:{Description:"You wield power to rule and enslave others.",Label:"Tyranny"},Undeath:{Description:"Your magic carries close ties to the undead.",Label:"Undeath"},Vigil:{Description:"You watch over those long passed and guard their secrets.",Label:"Vigil"},Void:{Description:"You draw power from emptiness.",Label:"Nothingness"},Water:{Description:"You control water and bodies of water.",Label:"Water"},WaterApocryphal:{Description:"You control water and bodies of water. Not all clerical traditions are taught among the orthodoxy. Some are whispered in secret, passed down from a priest to trusted acolytes or scribed in tomes left behind by splinter factions.",Label:"Water (apocryphal)"},Wealth:{Description:"You hold power over wealth, trade, and treasure.",Label:"Wealth"},Wood:{Description:"You command the indomitable power of wood.",Label:"Wood"},Wyrmkin:{Description:"You draw on the power of dragons, linnorms, and other powerful reptilian creatures.",Label:"Dragon"},Zeal:{Description:"Your inner fire increases your combat prowess.",Label:"Zeal"}}},Shield:{Base:{buckler:"Buckler","casters-targe":"Caster's Targe","dart-shield":"Dart Shield","fortress-shield":"Fortress Shield","gauntlet-buckler":"Gauntlet Buckler","harnessed-shield":"Harnessed Shield","heavy-rondache":"Heavy Rondache","hide-shield":"Hide Shield",klar:"Klar","meteor-shield":"Meteor Shield","razor-disc":"Razor Disc","salvo-shield":"Salvo Shield","steel-shield":"Steel Shield","swordstealer-shield":"Swordstealer Shield","tower-shield":"Tower Shield","wooden-shield":"Wooden Shield"}}},Weapon:{Base:{adze:"Adze","air-repeater":"Air Repeater",aklys:"Aklys","alchemical-bomb":"Alchemical Bomb","alchemical-crossbow":"Alchemical Crossbow","aldori-dueling-sword":"Aldori Dueling Sword",arbalest:"Arbalest",arquebus:"Arquebus","asp-coil":"Asp Coil",atlatl:"Atlatl","axe-musket":"Axe Musket","backpack-ballista":"Backpack Ballista","backpack-catapult":"Backpack Catapult","barricade-buster":"Barricade Buster","bastard-sword":"Bastard Sword","battle-axe":"Battle Axe","battle-lute":"Battle Lute","battle-saddle":"Battle Saddle","bec-de-corbin":"Bec de Corbin","big-boom-gun":"Big Boom Gun","black-powder-knuckle-dusters":"Black Powder Knuckle Dusters","bladed-diabolo":"Bladed Diabolo","bladed-gauntlet":"Bladed Gauntlet","bladed-hoop":"Bladed Hoop","bladed-scarf":"Bladed Scarf",bladesweeper:"Bladesweeper",blowgun:"Blowgun","blowgun-darts":"Blowgun Darts",blunderbuss:"Blunderbuss","bo-staff":"Bo Staff","boarding-axe":"Boarding Axe","boarding-pike":"Boarding Pike",bola:"Bola",boomerang:"Boomerang","bow-staff":"Bow Staff","breaching-pike":"Breaching Pike",broadspear:"Broadspear","butchering-axe":"Butchering Axe","butterfly-sword":"Butterfly Sword",buugeng:"Buugeng","cane-pistol":"Cane Pistol","capturing-spetum":"Capturing Spetum","chain-sword":"Chain Sword",chakram:"Chakram",chakri:"Chakri","clan-dagger":"Clan Dagger","clan-pistol":"Clan Pistol",claw:"Claw","claw-blade":"Claw Blade",club:"Club","coat-pistol":"Coat Pistol","combat-fishing-pole":"Combat Fishing Pole","combat-grapnel":"Combat Grapnel","combat-lure":"Combat Lure","composite-longbow":"Composite Longbow","composite-shortbow":"Composite Shortbow","corset-knife":"Corset Knife","crescent-cross":"Crescent Cross",crossbow:"Crossbow",dagger:"Dagger","dagger-pistol":"Dagger Pistol",daikyu:"Daikyu","dancers-spear":"Dancer's Spear",dandpatta:"Dandpatta",dart:"Dart",dogslicer:"Dogslicer",donchak:"Donchak","double-barreled-musket":"Double-Barreled Musket","double-barreled-pistol":"Double-Barreled Pistol","dragon-mouth-pistol":"Dragon Mouth Pistol","dueling-pistol":"Dueling Pistol","dueling-spear":"Dueling Spear","dwarven-dorn-dergar":"Dwarven Dorn-Dergar","dwarven-scattergun":"Dwarven Scattergun","dwarven-war-axe":"Dwarven War Axe",earthbreaker:"Earthbreaker","elven-branched-spear":"Elven Branched Spear","elven-curve-blade":"Elven Curve Blade","explosive-dogslicer":"Explosive Dogslicer","exquisite-sword-cane":"Exquisite Sword Cane","exquisite-sword-cane-sheath":"Exquisite Sword Cane Sheath",falcata:"Falcata",falchion:"Falchion",fangs:"Fangs",fangwire:"Fangwire",fauchard:"Fauchard","feng-huo-lun":"Feng Huo Lun","fighting-fan":"Fighting Fan","fighting-oar":"Fighting Oar","fighting-stick":"Fighting Stick","filchers-fork":"Filcher's Fork","fire-lance":"Fire Lance","fire-poi":"Fire Poi",fist:"Fist",flail:"Flail",flingflenser:"Flingflenser","flintlock-musket":"Flintlock Musket","flintlock-pistol":"Flintlock Pistol","flying-talon":"Flying Talon",flyssa:"Flyssa","forked-bipod":"Forked Bipod","frying-pan":"Frying Pan",gada:"Gada",gaff:"Gaff",gakgung:"Gakgung",gauntlet:"Gauntlet","gauntlet-bow":"Gauntlet Bow","gill-hook":"Gill Hook",gladius:"Gladius",glaive:"Glaive","gnome-amalgam-musket":"Gnome Amalgam Musket","gnome-flickmace":"Gnome Flickmace","gnome-hooked-hammer":"Gnome Hooked Hammer",greataxe:"Greataxe",greatclub:"Greatclub",greatpick:"Greatpick",greatsword:"Greatsword",grenade:"Grenade","griffon-cane":"Griffon Cane",guisarme:"Guisarme","gun-sword":"Gun Sword",halberd:"Halberd","halfling-sling-staff":"Halfling Sling Staff","hammer-gun":"Hammer Gun","hand-adze":"Hand Adze","hand-cannon":"Hand Cannon","hand-crossbow":"Hand Crossbow","harmona-gun":"Harmona Gun",harpoon:"Harpoon",hatchet:"Hatchet","heavy-crossbow":"Heavy Crossbow","hongali-hornbow":"Hongali Hornbow","hook-sword":"Hook Sword",horsechopper:"Horsechopper","injection-spear":"Injection Spear",javelin:"Javelin",jaws:"Jaws",jezail:"Jezail","jiu-huan-dao":"Jiu Huan Dao","juggling-club":"Juggling Club",kalis:"Kalis",kama:"Kama",karambit:"Karambit",katana:"Katana",katar:"Katar",kestros:"Kestros",khakkhara:"Khakkhara",khopesh:"Khopesh","knuckle-duster":"Knuckle Duster",kris:"Kris",kukri:"Kukri",kusarigama:"Kusarigama",lance:"Lance",lancer:"Lancer",leiomano:"Leiomano","light-hammer":"Light Hammer","light-mace":"Light Mace","light-pick":"Light Pick","lion-scythe":"Lion Scythe",liuyedao:"Liuyedao","long-air-repeater":"Long Air Repeater","long-hammer":"Long Hammer",longbow:"Longbow",longspear:"Longspear",longsword:"Longsword",mace:"Mace","mace-multipistol":"Mace Multipistol",machete:"Machete",macuahuitl:"Macuahuitl","main-gauche":"Main-Gauche",mambele:"Mambele",maul:"Maul","maul-spade":"Maul-Spade","meteor-hammer":"Meteor Hammer",mikazuki:"Mikazuki","mithral-tree":"Dawnsilver Tree","monkeys-fist":"Monkey's Fist",morningstar:"Morningstar",nails:"Nails",naginata:"Naginata",nightstick:"Nightstick",nodachi:"Nodachi",nunchaku:"Nunchaku","ogre-hook":"Ogre Hook","orc-knuckle-dagger":"Orc Knuckle Dagger","orc-necksplitter":"Orc Necksplitter","orc-skewermaul":"Orc Skewermaul",palstave:"Palstave",panabas:"Panabas",pepperbox:"Pepperbox","phalanx-piercer":"Phalanx Piercer",pick:"Pick","piercing-wind":"Piercing Wind","piranha-kiss":"Piranha Kiss",poi:"Poi",polytool:"Polytool","probing-cane":"Probing Cane",ranseur:"Ranseur",rapier:"Rapier","rapier-pistol":"Rapier Pistol","reinforced-wheels":"Reinforced Wheels","reinforced-stock":"Reinforced Stock","repeating-crossbow":"Repeating Crossbow","repeating-hand-crossbow":"Repeating Hand Crossbow","repeating-heavy-crossbow":"Repeating Heavy Crossbow","rhoka-sword":"Rhoka Sword","rope-dart":"Rope Dart","rotary-bow":"Rotary Bow",rungu:"Cruuk",sai:"Sai",sansetsukon:"Sansetsukon",sap:"Sap","sawtooth-saber":"Sawtooth Saber",scimitar:"Scimitar",scizore:"Scizore","scorpion-whip":"Scorpion Whip",scourge:"Scourge",scythe:"Scythe","shauth-lash":"Shauth Lash",shears:"Shears","shield-bash":"Shield Bash","shield-boss":"Shield Boss","shield-bow":"Shield Bow","shield-pistol":"Shield Pistol","shield-spikes":"Shield Spikes","shobhad-longrifle":"Shobhad Longrifle",shortbow:"Shortbow",shortsword:"Shortsword","shuan-ji":"Shuan Ji",shuriken:"Shuriken",sickle:"Sickle","sickle-saber":"Sickle-saber","slide-pistol":"Slide Pistol",sling:"Sling","sling-bullets":"Sling Bullets",spear:"Spear","spiked-chain":"Spiked Chain","spiked-gauntlet":"Spiked Gauntlet","spiral-rapier":"Spiral Rapier","spirit-thresher":"Spirit Thresher","spoon-gun":"Spoon Gun",spraysling:"Spraysling",staff:"Staff",starknife:"Starknife","stiletto-pen":"Stiletto Pen",sukgung:"Sukgung","sun-sling":"Sun Sling",switchscythe:"Switchscythe","sword-cane":"Sword Cane",talwar:"Talwar","tamchal-chakram":"Tamchal Chakram","taw-launcher":"Taw Launcher","tekko-kagi":"Tekko-Kagi","temple-sword":"Temple Sword","tengu-gale-blade":"Tengu Gale Blade",tetsubo:"Tetsubo","thorn-whip":"Thorn whip","three-peaked-tree":"Three Peaked Tree","three-section-naginata":"Three-Section Naginata","throwing-knife":"Throwing Knife","thunder-sling":"Thunder Sling",thundermace:"Thundermace",tonfa:"Tonfa","tri-bladed-katar":"Tri-bladed Katar","tricky-pick":"Tricky Pick",trident:"Trident",triggerbrand:"Triggerbrand",urumi:"Urumi",visap:"Visap",wakizashi:"Wakizashi","war-flail":"War Flail","war-gavel":"War Gavel","war-javelin":"War Javelin","war-lance":"War Lance","war-razor":"War Razor",warhammer:"Warhammer","wheel-blades":"Wheel Blades","wheel-spikes":"Wheel Spikes",whip:"Whip","whip-claw":"Whip Claw","whip-staff":"Whip Staff","wish-blade":"Wish Blade","wish-knife":"Wish Knife","wooden-taws":"Wooden Taws",wrecker:"Wrecker","wrist-launcher":"Wrist Launcher","zhuazhi-bang":"Zhuazhi Bang",zulfikar:"Zulfikar"}},WorldClock:{AD:{Era:"AD"},AR:{Era:"AR",Months:{April:"Gozran",August:"Arodus",December:"Kuthona",February:"Calistril",January:"Abadius",July:"Erastus",June:"Sarenith",March:"Pharast",May:"Desnus",November:"Neth",October:"Lamashan",September:"Rova"},Weekdays:{Friday:"Fireday",Monday:"Moonday",Saturday:"Starday",Sunday:"Sunday",Thursday:"Oathday",Tuesday:"Toilday",Wednesday:"Wealday"}},Button:{AddOneDay:"1 Day",AddOneHour:"1 Hour",AddOneMinute:"1 Minute",AddOneRound:"1 Round",AddOneWeek:"1 Week",AddTenMinutes:"10 Minutes",Advance:"Advance",Retract:"Retract",TimeOfDay:{Advance:{Dawn:"Advance to Dawn",Dusk:"Advance to Dusk",Midnight:"Advance to Midnight",Noon:"Advance to Noon"},Retract:{Dawn:"Retract to Dawn",Dusk:"Retract to Dusk",Midnight:"Retract to Midnight",Noon:"Retract to Noon"}}},CE:{Era:"CE"},Date:"{weekday}, {day} of {month}, {year} {era}",IC:{Era:"IC"},Placeholder:"Number",Title:"World Clock"},identification:{DisplayDetails:"Display Details",Identified:"Identified",Identify:"Identify Item",IdentifyAlchemyDCs:"Identify Alchemy DCs",IdentifyGenericDCs:"Identify Generic DCs",IdentifyMagicDCs:"Identify Magic DCs",IsIdentified:"Identified?",MisidentifiedItem:"Misidentified {item}",Misidentify:"Misidentify Item",MystificationStatus:"Mystification status",Mystify:"Mystify Item",PostSkillsToChat:"Post skill checks to chat",PostSkillsToChatText:"Identify item: Skill checks",TraitGMNote:"Note: this trait is hidden from players.",Unidentified:"Unidentified",UnidentifiedDescription:"The nature of this {item} is unclear.",UnidentifiedHint:"Change the basic details seen by players when this item is unidentified.",UnidentifiedItem:"Unusual {item}",UnidentifiedType:{Amulet:"Amulet",Anklets:"Anklets",Armbands:"Armbands",Backpack:"Backpack",Belt:"Belt",Book:"Book",Bracers:"Bracers",Circlet:"Circlet",Cloak:"Cloak",Collar:"Collar",Epaulets:"Epaulets",Eyepiece:"Eyepiece",Garment:"Garment",Gloves:"Gloves",Headwear:"Headwear",Horseshoes:"Horseshoes",Liquid:"Liquid",Mask:"Mask",Necklace:"Necklace",Object:"Object",Ring:"Ring",Saddle:"Saddle",Shoes:"Shoes",Substance:"Substance",Tool:"Tool"}}}};const actorTypes={army:"TYPES.Actor.army",character:"TYPES.Actor.character",familiar:"TYPES.Actor.familiar",hazard:"TYPES.Actor.hazard",loot:"TYPES.Actor.loot",npc:"TYPES.Actor.npc",party:"TYPES.Actor.party",vehicle:"TYPES.Actor.vehicle"},abilities={str:"PF2E.AbilityStr",dex:"PF2E.AbilityDex",con:"PF2E.AbilityCon",int:"PF2E.AbilityInt",wis:"PF2E.AbilityWis",cha:"PF2E.AbilityCha"},senses=t$9(Array.from(SENSE_TYPES),t2=>[t2,`PF2E.Actor.Creature.Sense.Type.${sluggify(t2,{camel:"bactrian"})}`]),senseAcuities={imprecise:"PF2E.Actor.Creature.Sense.Acuity.Imprecise",precise:"PF2E.Actor.Creature.Sense.Acuity.Precise",vague:"PF2E.Actor.Creature.Sense.Acuity.Vague"},tokenHUDConditions={blinded:"PF2E.ConditionTypeBlinded",broken:"PF2E.ConditionTypeBroken",clumsy:"PF2E.ConditionTypeClumsy",concealed:"PF2E.ConditionTypeConcealed",confused:"PF2E.ConditionTypeConfused",controlled:"PF2E.ConditionTypeControlled",dazzled:"PF2E.ConditionTypeDazzled",deafened:"PF2E.ConditionTypeDeafened",doomed:"PF2E.ConditionTypeDoomed",drained:"PF2E.ConditionTypeDrained",dying:"PF2E.ConditionTypeDying",encumbered:"PF2E.ConditionTypeEncumbered",enfeebled:"PF2E.ConditionTypeEnfeebled",fascinated:"PF2E.ConditionTypeFascinated",fatigued:"PF2E.ConditionTypeFatigued",fleeing:"PF2E.ConditionTypeFleeing",frightened:"PF2E.ConditionTypeFrightened",grabbed:"PF2E.ConditionTypeGrabbed",hidden:"PF2E.ConditionTypeHidden",immobilized:"PF2E.ConditionTypeImmobilized",invisible:"PF2E.ConditionTypeInvisible","off-guard":"PF2E.ConditionTypeOffGuard",paralyzed:"PF2E.ConditionTypeParalyzed","persistent-damage":"PF2E.ConditionTypePersistent",petrified:"PF2E.ConditionTypePetrified",prone:"PF2E.ConditionTypeProne",quickened:"PF2E.ConditionTypeQuickened",restrained:"PF2E.ConditionTypeRestrained",sickened:"PF2E.ConditionTypeSickened",slowed:"PF2E.ConditionTypeSlowed",stunned:"PF2E.ConditionTypeStunned",stupefied:"PF2E.ConditionTypeStupefied",unconscious:"PF2E.ConditionTypeUnconscious",undetected:"PF2E.ConditionTypeUndetected",wounded:"PF2E.ConditionTypeWounded"},conditionTypes={...tokenHUDConditions,cursebound:"PF2E.ConditionTypeCursebound",friendly:"PF2E.ConditionTypeFriendly",helpful:"PF2E.ConditionTypeHelpful",hostile:"PF2E.ConditionTypeHostile",indifferent:"PF2E.ConditionTypeIndifferent",malevolence:"PF2E.ConditionTypeMalevolence",observed:"PF2E.ConditionTypeObserved",unfriendly:"PF2E.ConditionTypeUnfriendly",unnoticed:"PF2E.ConditionTypeUnnoticed"},armorCategories={unarmored:"PF2E.ArmorTypeUnarmored",light:"PF2E.ArmorTypeLight",medium:"PF2E.ArmorTypeMedium",heavy:"PF2E.ArmorTypeHeavy","light-barding":"PF2E.Item.Armor.Category.light-barding","heavy-barding":"PF2E.Item.Armor.Category.heavy-barding"},armorGroups={composite:"PF2E.ArmorGroupComposite",chain:"PF2E.ArmorGroupChain",cloth:"PF2E.ArmorGroupCloth",leather:"PF2E.ArmorGroupLeather",plate:"PF2E.ArmorGroupPlate",skeletal:"PF2E.ArmorGroupSkeletal",wood:"PF2E.ArmorGroupWood"},weaponCategories={simple:"PF2E.WeaponTypeSimple",martial:"PF2E.WeaponTypeMartial",advanced:"PF2E.WeaponTypeAdvanced",unarmed:"PF2E.WeaponTypeUnarmed"},baseArmorTypes=t$5(define_EN_JSON_default.PF2E.Item.Armor.Base,(_v,slug)=>`PF2E.Item.Armor.Base.${slug}`),baseShieldTypes=t$5(define_EN_JSON_default.PF2E.Item.Shield.Base,(_v,slug)=>`PF2E.Item.Shield.Base.${slug}`),baseWeaponTypes=t$5(define_EN_JSON_default.PF2E.Weapon.Base,(_v,slug)=>`PF2E.Weapon.Base.${slug}`),equivalentWeapons={"composite-longbow":"longbow","composite-shortbow":"shortbow","big-boom-gun":"hand-cannon","spoon-gun":"hand-cannon"},preciousMaterialGrades={low:"PF2E.PreciousMaterialLowGrade",standard:"PF2E.PreciousMaterialStandardGrade",high:"PF2E.PreciousMaterialHighGrade"},meleeWeaponGroups={axe:"PF2E.WeaponGroupAxe",brawling:"PF2E.WeaponGroupBrawling",club:"PF2E.WeaponGroupClub",dart:"PF2E.WeaponGroupDart",flail:"PF2E.WeaponGroupFlail",hammer:"PF2E.WeaponGroupHammer",knife:"PF2E.WeaponGroupKnife",pick:"PF2E.WeaponGroupPick",polearm:"PF2E.WeaponGroupPolearm",shield:"PF2E.WeaponGroupShield",spear:"PF2E.WeaponGroupSpear",sword:"PF2E.WeaponGroupSword"},weaponGroups={...meleeWeaponGroups,bomb:"PF2E.WeaponGroupBomb",bow:"PF2E.WeaponGroupBow",crossbow:"PF2E.WeaponGroupCrossbow",firearm:"PF2E.WeaponGroupFirearm",sling:"PF2E.WeaponGroupSling"},sizeTypes={tiny:"PF2E.ActorSizeTiny",sm:"PF2E.ActorSizeSmall",med:"PF2E.ActorSizeMedium",lg:"PF2E.ActorSizeLarge",huge:"PF2E.ActorSizeHuge",grg:"PF2E.ActorSizeGargantuan"},featCategories={ancestry:"PF2E.Item.Feat.Category.Ancestry",ancestryfeature:"PF2E.Item.Feat.Category.AncestryFeature",calling:"PF2E.Item.Feat.Category.Calling",class:"PF2E.Item.Feat.Category.Class",classfeature:"PF2E.Item.Feat.Category.ClassFeature",skill:"PF2E.Item.Feat.Category.Skill",general:"PF2E.Item.Feat.Category.General",bonus:"PF2E.Item.Feat.Category.Bonus",pfsboon:"PF2E.Item.Feat.Category.PfsBoon",deityboon:"PF2E.Item.Feat.Category.DeityBoon",curse:"PF2E.Item.Feat.Category.Curse"},creatureTypes=t$3(creatureTraits,["aberration","animal","astral","beast","celestial","construct","dragon","dream","elemental","ethereal","fey","fiend","fungus","giant","humanoid","monitor","ooze","petitioner","plant","shadow","spirit","time","vitality","void","undead"]),consumableCategories=t$9(Array.from(CONSUMABLE_CATEGORIES),c=>[c,`PF2E.Item.Consumable.Category.${c}`]),deityDomains=t$9(Object.keys(define_EN_JSON_default.PF2E.Item.Deity.Domain),key=>{const label=`PF2E.Item.Deity.Domain.${key}.Label`,description=`PF2E.Item.Deity.Domain.${key}.Description`;return[sluggify(key),{label,description}]}),weaponReload={"-":"\u2014",0:"0",1:"1",2:"2",3:"3",10:"PF2E.Item.Weapon.Reload.OneMinute"},grades={commercial:"PF2E.Item.Physical.Grade.commercial",tactical:"PF2E.Item.Physical.Grade.tactical",advanced:"PF2E.Item.Physical.Grade.advanced",superior:"PF2E.Item.Physical.Grade.superior",elite:"PF2E.Item.Physical.Grade.elite",ultimate:"PF2E.Item.Physical.Grade.ultimate",paragon:"PF2E.Item.Physical.Grade.paragon"},round5Firearms=["dwarven-scattergun","explosive-dogslicer","flingflenser","harmona-gun"],round10Firearms=["arquebus","axe-musket","black-powder-knuckle-dusters","blunderbuss","cane-pistol","clan-pistol","coat-pistol","dagger-pistol","double-barreled-musket","double-barreled-pistol","dragon-mouth-pistol","dueling-pistol","fire-lance","flintlock-musket","flintlock-pistol","gnome-amalgam-musket","gun-sword","hammer-gun","hand-cannon","jezail","mace-multipistol","mithral-tree","pepperbox","piercing-wind","rapier-pistol","shield-pistol","shobhad-longrifle","slide-pistol","three-peaked-tree","triggerbrand"],repeatingCrossbows=["repeating-crossbow","repeating-hand-crossbow","repeating-heavy-crossbow"],beastGuns=["alicorn-trigger","breath-blaster","drake-rifle","fulmination-fang","howler-pistol","leydroth-spellbreaker","nightmares-lament","petrification-cannon","screech-shooter","spider-gun","spike-launcher","tentacle-cannon"],DEFAULT_AMMO_STACK_GROUPS={arrows:"arrows",rounds:"rounds10",bolts:"bolts","sling-bullets":"slingBullets","blowgun-darts":"blowgunDarts","wooden-taws":"woodenTaws"},ammoTypes={...t$9(["arrows","blowgun-darts","bolts","rounds","sling-bullets","spray-pellets","wooden-taws","projectile-ammo"],slug=>[slug,{parent:null,label:`PF2E.Item.Ammo.Base.${slug}`,magazine:!1,stackGroup:DEFAULT_AMMO_STACK_GROUPS[slug]??null,weapon:null}]),...t$9(["magazine","battery","chem-tank"],slug=>[slug,{parent:null,label:`PF2E.Item.Ammo.Base.${slug}`,magazine:!0,stackGroup:null,weapon:null}]),...t$9(round5Firearms,baseWeapon=>[`rounds-${baseWeapon}`,{parent:"rounds",label:`PF2E.Item.Ammo.Base.rounds-${baseWeapon}`,magazine:!1,stackGroup:"rounds5",weapon:baseWeapon}]),...t$9([...round10Firearms,...beastGuns],baseWeapon=>[`rounds-${baseWeapon}`,{parent:"rounds",label:`PF2E.Item.Ammo.Base.rounds-${baseWeapon}`,magazine:!1,stackGroup:"rounds10",weapon:baseWeapon}]),cutlery:{parent:"rounds",label:"PF2E.Item.Ammo.Base.cutlery",magazine:!1,stackGroup:"rounds10",weapon:"spoon-gun"},...t$9(repeatingCrossbows,baseWeapon=>[`${baseWeapon}-magazine`,{parent:"magazine",label:`PF2E.Item.Ammo.Base.${baseWeapon}-magazine`,magazine:!0,stackGroup:null,weapon:baseWeapon}]),"8-round-magazine":{parent:"magazine",label:"PF2E.Item.Ammo.Base.8-round-magazine",magazine:!0,stackGroup:null,weapon:"barricade-buster"},"magazine-with-6-pellets":{parent:"magazine",label:"PF2E.Item.Ammo.Base.magazine-with-6-pellets",magazine:!0,stackGroup:null,weapon:"air-repeater"},"magazine-with-8-pellets":{parent:"magazine",label:"PF2E.Item.Ammo.Base.magazine-with-8-pellets",magazine:!0,stackGroup:null,weapon:"long-air-repeater"},"backpack-ballista-bolts":{parent:null,label:"PF2E.Item.Ammo.Base.backpack-ballista-bolts",magazine:!1,stackGroup:null,weapon:"backpack-ballista"},"backpack-catapult-stones":{parent:null,label:"PF2E.Item.Ammo.Base.backpack-catapult-stones",magazine:!1,stackGroup:null,weapon:"backpack-catapult"}},PF2ECONFIG={defaultPartyId:"xxxPF2ExPARTYxxx",chatDamageButtonShieldToggle:!1,statusEffects:{lastIconTheme:"default",iconDir:"systems/pf2e/icons/conditions/",conditions:tokenHUDConditions},levels:{1:"PF2E.Level1",2:"PF2E.Level2",3:"PF2E.Level3",4:"PF2E.Level4",5:"PF2E.Level5",6:"PF2E.Level6",7:"PF2E.Level7",8:"PF2E.Level8",9:"PF2E.Level9",10:"PF2E.Level10",11:"PF2E.Level11",12:"PF2E.Level12",13:"PF2E.Level13",14:"PF2E.Level14",15:"PF2E.Level15",16:"PF2E.Level16",17:"PF2E.Level17",18:"PF2E.Level18",19:"PF2E.Level19",20:"PF2E.Level20"},abilities,dcAdjustments:{"incredibly-easy":"PF2E.DCAdjustmentIncrediblyEasy","very-easy":"PF2E.DCAdjustmentVeryEasy",easy:"PF2E.DCAdjustmentEasy",normal:"PF2E.DCAdjustmentNormal",hard:"PF2E.DCAdjustmentHard","very-hard":"PF2E.DCAdjustmentVeryHard","incredibly-hard":"PF2E.DCAdjustmentIncrediblyHard"},checkDCs:configFromLocalization(define_EN_JSON_default.PF2E.Check.DC,"PF2E.Check.DC"),saves:{fortitude:"PF2E.SavesFortitude",reflex:"PF2E.SavesReflex",will:"PF2E.SavesWill"},savingThrowDefaultAttributes:{fortitude:"con",reflex:"dex",will:"wis"},currencies:{pp:"PF2E.Currency.pp",gp:"PF2E.Currency.gp",sp:"PF2E.Currency.sp",cp:"PF2E.Currency.cp",credits:"PF2E.Currency.credits",upb:"PF2E.Currency.upb"},preciousMaterialGrades,preciousMaterials,accessoryPropertyRunes:{called:"PF2E.AccessoryPropertyRuneCalled",dragonsBreath:"PF2E.AccessoryPropertyRuneDragonsBreath",paired:"PF2E.AccessoryPropertyRunePaired",greaterPaired:"PF2E.AccessoryPropertyRuneGreaterPaired",majorPaired:"PF2E.AccessoryPropertyRuneMajorPaired",presentable:"PF2E.AccessoryPropertyRunePresentable",snagging:"PF2E.AccessoryPropertyRuneSnagging",softLanding:"PF2E.AccessoryPropertyRuneSoftLanding",spellBastion:"PF2E.AccessoryPropertyRuneSpellBastion",windCatcher:"PF2E.AccessoryPropertyRuneWindCatcher",greaterWindCatcher:"PF2E.AccessoryPropertyRuneGreaterWindCatcher"},damageTraits,damageTypes,damageRollFlavors,damageCategories,energyDamageTypes,materialDamageEffects,physicalDamageTypes,resistanceTypes,stackGroups:{coins:"PF2E.StackGroupCoins",gems:"PF2E.StackGroupGems"},weaknessTypes,weaponCategories,weaponGroups,meleeWeaponGroups,baseArmorTypes,baseShieldTypes,baseWeaponTypes,equivalentWeapons,weaponDescriptions:{club:"PF2E.WeaponDescriptionClub",knife:"PF2E.WeaponDescriptionKnife",brawling:"PF2E.WeaponDescriptionBrawling",spear:"PF2E.WeaponDescriptionSpear",sword:"PF2E.WeaponDescriptionSword",axe:"PF2E.WeaponDescriptionAxe",flail:"PF2E.WeaponDescriptionFlail",polearm:"PF2E.WeaponDescriptionPolearm",pick:"PF2E.WeaponDescriptionPick",hammer:"PF2E.WeaponDescriptionHammer",shield:"PF2E.WeaponDescriptionShield",dart:"PF2E.WeaponDescriptionDart",bow:"PF2E.WeaponDescriptionBow",sling:"PF2E.WeaponDescriptionSling",bomb:"PF2E.WeaponDescriptionBomb"},usages:USAGES,magicTraditions,deityDomains,otherArmorTags,otherConsumableTags,otherWeaponTags,actionTraits,ancestryTraits,armorTraits,classTraits,consumableTraits,creatureTraits,effectTraits,elementTraits,equipmentTraits,featTraits,hazardTraits,kingmakerTraits,npcAttackTraits,shieldTraits,spellTraits,vehicleTraits,weaponTraits,rarityTraits:{common:"PF2E.TraitCommon",uncommon:"PF2E.TraitUncommon",rare:"PF2E.TraitRare",unique:"PF2E.TraitUnique"},traitsDescriptions:traitDescriptions,creatureTypes,weaponHands:{1:"PF2E.WeaponHands1","1+":"PF2E.WeaponHands1Plus",2:"PF2E.WeaponHands2"},itemBonuses:{"-2":"PF2E.ItemBonusMinus2",0:"PF2E.ItemBonus0",1:"PF2E.ItemBonus1",2:"PF2E.ItemBonus2",3:"PF2E.ItemBonus3"},damageDice:{0:"0",1:"1",2:"2",3:"3",4:"4"},damageDie:{d4:"PF2E.DamageDieD4",d6:"PF2E.DamageDieD6",d8:"PF2E.DamageDieD8",d10:"PF2E.DamageDieD10",d12:"PF2E.DamageDieD12"},weaponMAP:{1:"-1/-2",2:"-2/-4",3:"-3/-6",4:"-4/-8",5:"-5/-10"},grades,weaponImprovements:{commercial:{level:0,tracking:0,dice:1,credits:0},tactical:{level:2,tracking:1,dice:1,credits:350},advanced:{level:4,tracking:1,dice:2,credits:1e3},superior:{level:10,tracking:2,dice:2,credits:1e4},elite:{level:12,tracking:2,dice:3,credits:2e4},ultimate:{level:16,tracking:3,dice:3,credits:1e5},paragon:{level:19,tracking:3,dice:4,credits:4e5}},armorImprovements:{commercial:{level:0,bonus:0,resilient:0,credits:0},tactical:{level:5,bonus:1,resilient:0,credits:1600},advanced:{level:8,bonus:1,resilient:1,credits:5e3},superior:{level:11,bonus:2,resilient:1,credits:14e3},elite:{level:14,bonus:2,resilient:2,credits:45e3},ultimate:{level:18,bonus:3,resilient:2,credits:24e4},paragon:{level:20,bonus:3,resilient:3,credits:7e5}},shieldImprovements:{commercial:{level:0,hardness:0,maxHP:0,credits:0},tactical:{level:5,hardness:3,maxHP:46,credits:750},advanced:{level:8,hardness:3,maxHP:56,credits:3e3},superior:{level:11,hardness:3,maxHP:68,credits:9e3},elite:{level:14,hardness:5,maxHP:80,credits:25e3},ultimate:{level:18,hardness:6,maxHP:100,credits:8e5},paragon:{level:20,hardness:7,maxHP:120,credits:32e4}},weaponReload,armorCategories,armorGroups,consumableCategories,identification:configFromLocalization(define_EN_JSON_default.PF2E.identification,"PF2E.identification"),thrownBaseWeapons:["alchemical-bomb","grenade"],preparationType:{prepared:"PF2E.PreparationTypePrepared",spontaneous:"PF2E.PreparationTypeSpontaneous",innate:"PF2E.PreparationTypeInnate",focus:"PF2E.PreparationTypeFocus",items:"PF2E.PreparationTypeItems",ritual:"PF2E.PreparationTypeRitual"},spellcastingItems:{scroll:{name:"PF2E.Item.Consumable.Category.scroll",nameTemplate:"PF2E.Item.Physical.FromSpell.Scroll",compendiumUuids:{1:"Compendium.pf2e.equipment-srd.Item.RjuupS9xyXDLgyIr",2:"Compendium.pf2e.equipment-srd.Item.Y7UD64foDbDMV9sx",3:"Compendium.pf2e.equipment-srd.Item.ZmefGBXGJF3CFDbn",4:"Compendium.pf2e.equipment-srd.Item.QSQZJ5BC3DeHv153",5:"Compendium.pf2e.equipment-srd.Item.tjLvRWklAylFhBHQ",6:"Compendium.pf2e.equipment-srd.Item.4sGIy77COooxhQuC",7:"Compendium.pf2e.equipment-srd.Item.fomEZZ4MxVVK3uVu",8:"Compendium.pf2e.equipment-srd.Item.iPki3yuoucnj7bIt",9:"Compendium.pf2e.equipment-srd.Item.cFHomF3tty8Wi1e5",10:"Compendium.pf2e.equipment-srd.Item.o1XIHJ4MJyroAHfF"}},wand:{name:"PF2E.Item.Consumable.Category.wand",nameTemplate:"PF2E.Item.Physical.FromSpell.Wand",compendiumUuids:{1:"Compendium.pf2e.equipment-srd.Item.UJWiN0K3jqVjxvKk",2:"Compendium.pf2e.equipment-srd.Item.vJZ49cgi8szuQXAD",3:"Compendium.pf2e.equipment-srd.Item.wrDmWkGxmwzYtfiA",4:"Compendium.pf2e.equipment-srd.Item.Sn7v9SsbEDMUIwrO",5:"Compendium.pf2e.equipment-srd.Item.5BF7zMnrPYzyigCs",6:"Compendium.pf2e.equipment-srd.Item.kiXh4SUWKr166ZeM",7:"Compendium.pf2e.equipment-srd.Item.nmXPj9zuMRQBNT60",8:"Compendium.pf2e.equipment-srd.Item.Qs8RgNH6thRPv2jt",9:"Compendium.pf2e.equipment-srd.Item.Fgv722039TVM5JTc",10:null}}},attitude:{hostile:"PF2E.Attitudes.Hostile",unfriendly:"PF2E.Attitudes.Unfriendly",indifferent:"PF2E.Attitudes.Indifferent",friendly:"PF2E.Attitudes.Friendly",helpful:"PF2E.Attitudes.Helpful"},ammoTypes,skills:Object.freeze({acrobatics:{label:"PF2E.Skill.Acrobatics",attribute:"dex"},arcana:{label:"PF2E.Skill.Arcana",attribute:"int"},athletics:{label:"PF2E.Skill.Athletics",attribute:"str"},crafting:{label:"PF2E.Skill.Crafting",attribute:"int"},deception:{label:"PF2E.Skill.Deception",attribute:"cha"},diplomacy:{label:"PF2E.Skill.Diplomacy",attribute:"cha"},intimidation:{label:"PF2E.Skill.Intimidation",attribute:"cha"},medicine:{label:"PF2E.Skill.Medicine",attribute:"wis"},nature:{label:"PF2E.Skill.Nature",attribute:"wis"},occultism:{label:"PF2E.Skill.Occultism",attribute:"int"},performance:{label:"PF2E.Skill.Performance",attribute:"cha"},religion:{label:"PF2E.Skill.Religion",attribute:"wis"},society:{label:"PF2E.Skill.Society",attribute:"int"},stealth:{label:"PF2E.Skill.Stealth",attribute:"dex"},survival:{label:"PF2E.Skill.Survival",attribute:"wis"},thievery:{label:"PF2E.Skill.Thievery",attribute:"dex"}}),featCategories,actionTypes:{action:"PF2E.ActionTypeAction",reaction:"PF2E.ActionTypeReaction",free:"PF2E.ActionTypeFree",passive:"PF2E.ActionTypePassive"},actionsNumber:{1:"PF2E.ActionNumber1",2:"PF2E.ActionNumber2",3:"PF2E.ActionNumber3"},actionCategories:{interaction:"PF2E.Item.Ability.Category.Interaction",defensive:"PF2E.Item.Ability.Category.Defensive",offensive:"PF2E.Item.Ability.Category.Offensive",familiar:"PF2E.Item.Ability.Category.Familiar"},frequencies:{turn:"PF2E.Duration.turn",round:"PF2E.Duration.round",PT1M:"PF2E.Duration.PT1M",PT10M:"PF2E.Duration.PT10M",PT1H:"PF2E.Duration.PT1H",PT24H:"PF2E.Duration.PT24H",day:"PF2E.Duration.day",P1W:"PF2E.Duration.P1W",P1M:"PF2E.Duration.P1M",P1Y:"PF2E.Duration.P1Y"},timeUnits:{rounds:"PF2E.Time.Unit.Rounds",minutes:"PF2E.Time.Unit.Minutes",hours:"PF2E.Time.Unit.Hours",days:"PF2E.Time.Unit.Days",unlimited:"PF2E.Time.Unit.Unlimited",encounter:"PF2E.Time.Unit.UntilEncounterEnds"},proficiencyLevels:["PF2E.ProficiencyLevel0","PF2E.ProficiencyLevel1","PF2E.ProficiencyLevel2","PF2E.ProficiencyLevel3","PF2E.ProficiencyLevel4"],proficiencyRanks:{untrained:"PF2E.ProficiencyLevel0",trained:"PF2E.ProficiencyLevel1",expert:"PF2E.ProficiencyLevel2",master:"PF2E.ProficiencyLevel3",legendary:"PF2E.ProficiencyLevel4"},actorSizes:sizeTypes,actorTypes,prerequisitePlaceholders:{prerequisite1:"PF2E.Prerequisite1",prerequisite2:"PF2E.Prerequisite2",prerequisite3:"PF2E.Prerequisite3",prerequisite4:"PF2E.Prerequisite4",prerequisite5:"PF2E.Prerequisite5"},senses,senseAcuities,conditionTypes,pfsFactions:{EA:"PF2E.PFS.Factions.EA",GA:"PF2E.PFS.Factions.GA",HH:"PF2E.PFS.Factions.HH",VS:"PF2E.PFS.Factions.VS",RO:"PF2E.PFS.Factions.RO",VW:"PF2E.PFS.Factions.VW"},pfsSchools:{none:"PF2E.PFS.School.None",scrolls:"PF2E.PFS.School.Scrolls",spells:"PF2E.PFS.School.Spells",swords:"PF2E.PFS.School.Swords"},immunityTypes,languages:t$9(LANGUAGES,l=>[l,`PF2E.Actor.Creature.Language.${l}`]),attackEffects:{grab:"PF2E.AttackEffectGrab","improved-grab":"PF2E.AttackEffectImprovedGrab",constrict:"PF2E.AttackEffectConstrict","greater-constrict":"PF2E.AttackEffectGreaterConstrict",knockdown:"PF2E.AttackEffectKnockdown","improved-knockdown":"PF2E.AttackEffectImprovedKnockdown",push:"PF2E.AttackEffectPush","improved-push":"PF2E.AttackEffectImprovedPush",trip:"PF2E.AttackEffectTrip"},worldClock:foundry.utils.mergeObject(configFromLocalization(define_EN_JSON_default.PF2E.WorldClock,"PF2E.WorldClock"),{AR:{yearOffset:2700},IC:{yearOffset:5200},AD:{yearOffset:-95},CE:{yearOffset:0}}),hexplorationActivities:{10:.5,25:1,40:2,55:3,Infinity:4},environmentFeatures:{crowd:"PF2E.Environment.Feature.Crowd",ice:"PF2E.Environment.Feature.Ice",lava:"PF2E.Environment.Feature.Lava",rubble:"PF2E.Environment.Feature.Rubble",sand:"PF2E.Environment.Feature.Sand",sewer:"PF2E.Environment.Feature.Sewer",snow:"PF2E.Environment.Feature.Snow"},environmentTypes:{aquatic:"PF2E.Environment.Type.Aquatic",arctic:"PF2E.Environment.Type.Arctic",desert:"PF2E.Environment.Type.Desert",forest:"PF2E.Environment.Type.Forest",mountain:"PF2E.Environment.Type.Mountain",plains:"PF2E.Environment.Type.Plains",swamp:"PF2E.Environment.Type.Swamp",underground:"PF2E.Environment.Type.Underground",urban:"PF2E.Environment.Type.Urban"},SETTINGS:{CampaignFeats:{name:"PF2E.SETTINGS.CampaignFeats.Name",hint:"PF2E.SETTINGS.CampaignFeats.Hint"}},Actor:{documentClasses:{army:ArmyPF2e,character:CharacterPF2e,npc:NPCPF2e,hazard:HazardPF2e,loot:LootPF2e,familiar:FamiliarPF2e,party:PartyPF2e,vehicle:VehiclePF2e}},Item:{documentClasses:{action:AbilityItemPF2e,affliction:AfflictionPF2e,ammo:AmmoPF2e,ancestry:AncestryPF2e,armor:ArmorPF2e,background:BackgroundPF2e,backpack:ContainerPF2e,book:BookPF2e,campaignFeature:CampaignFeaturePF2e,class:ClassPF2e,condition:ConditionPF2e,consumable:ConsumablePF2e,deity:DeityPF2e,effect:EffectPF2e,equipment:EquipmentPF2e,feat:FeatPF2e,heritage:HeritagePF2e,kit:KitPF2e,lore:LorePF2e,melee:MeleePF2e,shield:ShieldPF2e,spell:SpellPF2e,spellcastingEntry:SpellcastingEntryPF2e,treasure:TreasurePF2e,weapon:WeaponPF2e}},JournalEntry:{sheetClass:JournalSheetPF2e},Canvas:{darkness:{default:CONFIG.Canvas.darknessColor,gmVision:13749503}}};function registerHandlebarsHelpers(){Handlebars.registerHelper("pad",(value,length,character)=>String(value).padStart(length,character)),Handlebars.registerHelper("add",(a,b)=>Number(a)+Number(b)),Handlebars.registerHelper("nor",(...args)=>!args.slice(0,-1).some(a=>!!a)),Handlebars.registerHelper("any",(...args)=>args.slice(0,-1).some(a=>!!a)),Handlebars.registerHelper("disabled",condition=>condition?"disabled":""),Handlebars.registerHelper("coalesce",(...args)=>args.find(a=>a!=null)??null),Handlebars.registerHelper("lower",str=>String(str).toLowerCase()),Handlebars.registerHelper("capitalize",str=>String(str).capitalize()),Handlebars.registerHelper("multiply",(a,b)=>Number(a)*Number(b)),Handlebars.registerHelper("percentage",(value,max)=>Number(value)*100/Number(max)),Handlebars.registerHelper("ordinal",value=>{const numericValue=Number(value);return isNaN(numericValue)?null:ordinalString(numericValue)}),Handlebars.registerHelper("sluggify",text2=>sluggify(String(text2))),Handlebars.registerHelper("json",data=>JSON.stringify(data)),Handlebars.registerHelper("actionGlyph",(value,options)=>{const glyph=getActionGlyph(value??"");return glyph?`<span class="action-glyph">${glyph}</span>`:options?.hash.fallback?Handlebars.escapeExpression(value):null}),Handlebars.registerHelper("times",(count,options)=>[...Array(Number(count)||0).keys()].map(i=>options.fn(i,{data:options.data,blockParams:[i]})).join("")),Handlebars.registerHelper("concat",(...params)=>params.slice(0,-1).join("")),Handlebars.registerHelper("developMode",function(options){return""}),Handlebars.registerHelper("isNumber",value=>typeof value=="number"),Handlebars.registerHelper("isNullish",value=>value==null),Handlebars.registerHelper("signedInteger",(value,options)=>{const number=Number(value)||0,emptyStringZero=!!options.hash.emptyStringZero,zeroIsNegative=!!options.hash.zeroIsNegative;return signedInteger(number,{emptyStringZero,zeroIsNegative})}),Handlebars.registerHelper("includes",(data,element)=>Array.isArray(data)?data.includes(element):typeof data=="string"?data.includes(String(element)):data instanceof Set?data.has(element):e$3(data)&&(typeof element=="number"||typeof element=="string")?element in data:!1),Handlebars.registerHelper("omit",(data,maybeKeys)=>pickOrOmit("omit",data,maybeKeys)),Handlebars.registerHelper("pick",(data,maybeKeys)=>pickOrOmit("pick",data,maybeKeys)),Handlebars.registerHelper("raw",function(options){return options.fn(this)}),Handlebars.registerHelper("resolvePath",function(path){const stringPath=String(path);return`systems/pf2e/${stringPath[0]==="/"||stringPath[0]==="\\"?stringPath.substring(1):stringPath}`})}__name(registerHandlebarsHelpers,"registerHandlebarsHelpers"),__name2(registerHandlebarsHelpers,"registerHandlebarsHelpers");function pickOrOmit(type2,data,maybeKeys){if(!e$2(data))return data;const keys=typeof maybeKeys=="string"?maybeKeys.startsWith("[")&&maybeKeys.endsWith("]")?JSON.parse(maybeKeys):[maybeKeys]:typeof maybeKeys=="number"?[maybeKeys]:[];return type2==="omit"?n$1(data,keys):t$3(data,keys)}__name(pickOrOmit,"pickOrOmit"),__name2(pickOrOmit,"pickOrOmit");function registerFonts(){CONFIG.fontDefinitions.Eczar={editor:!0,fonts:[{urls:["systems/pf2e/fonts/eczar-v16-latin-ext_latin-regular.woff2"],style:"normal",weight:"400"},{urls:["systems/pf2e/fonts/eczar-v16-latin-ext_latin-500.woff2"],style:"normal",weight:"500"},{urls:["systems/pf2e/fonts/eczar-v16-latin-ext_latin-600.woff2"],style:"normal",weight:"600"},{urls:["systems/pf2e/fonts/eczar-v16-latin-ext_latin-700.woff2"],style:"normal",weight:"700"},{urls:["systems/pf2e/fonts/eczar-v16-latin-ext_latin-800.woff2"],style:"normal",weight:"800"}]},CONFIG.fontDefinitions.Gelasio={editor:!1,fonts:[{urls:["systems/pf2e/fonts/gelasio-v9-latin-ext_latin-regular.woff2"],style:"normal",weight:"400"},{urls:["systems/pf2e/fonts/gelasio-v9-latin-ext_latin-italic.woff2"],style:"italic",weight:"400"},{urls:["systems/pf2e/fonts/gelasio-v9-latin-ext_latin-500.woff2"],style:"normal",weight:"500"},{urls:["systems/pf2e/fonts/gelasio-v9-latin-ext_latin-500italic.woff2"],style:"italic",weight:"500"},{urls:["systems/pf2e/fonts/gelasio-v9-latin-ext_latin-600.woff2"],style:"normal",weight:"600"},{urls:["systems/pf2e/fonts/gelasio-v9-latin-ext_latin-600italic.woff2"],style:"italic",weight:"600"},{urls:["systems/pf2e/fonts/gelasio-v9-latin-ext_latin-700.woff2"],style:"normal",weight:"700"},{urls:["systems/pf2e/fonts/gelasio-v9-latin-ext_latin-700italic.woff2"],style:"italic",weight:"700"}]},CONFIG.fontDefinitions["La Belle Aurore"]={editor:!0,fonts:[{urls:["systems/pf2e/fonts/la-belle-aurore-v16-latin-regular.woff2"],style:"normal",weight:"400"}]},CONFIG.fontDefinitions.Pathfinder2eActions={editor:!1,fonts:[{urls:["systems/pf2e/fonts/pathfinder-2e-actions.woff2"]}]},CONFIG.fontDefinitions.Roboto={editor:!0,fonts:[{urls:["systems/pf2e/fonts/roboto-v30-latin-ext_latin_cyrillic-regular.woff2"],style:"normal",weight:"400"},{urls:["systems/pf2e/fonts/roboto-v30-latin-ext_latin_cyrillic-italic.woff2"],style:"italic",weight:"400"},{urls:["systems/pf2e/fonts/roboto-v30-latin-ext_latin_cyrillic-500.woff2"],style:"normal",weight:"500"},{urls:["systems/pf2e/fonts/roboto-v30-latin-ext_latin_cyrillic-500italic.woff2"],style:"italic",weight:"500"},{urls:["systems/pf2e/fonts/roboto-v30-latin-ext_latin_cyrillic-700.woff2"],style:"normal",weight:"700"},{urls:["systems/pf2e/fonts/roboto-v30-latin-ext_latin_cyrillic-700italic.woff2"],style:"italic",weight:"700"},{urls:["systems/pf2e/fonts/roboto-v30-latin-ext_latin_cyrillic-900.woff2"],style:"normal",weight:"900"},{urls:["systems/pf2e/fonts/roboto-v30-latin-ext_latin_cyrillic-900italic.woff2"],style:"italic",weight:"900"}]},CONFIG.fontDefinitions["Roboto Condensed"]={editor:!1,fonts:[{urls:["systems/pf2e/fonts/roboto-condensed-v24-latin-ext_latin_cyrillic-regular.woff2"],style:"normal",weight:"400"},{urls:["systems/pf2e/fonts/roboto-condensed-v24-latin-ext_latin_cyrillic-italic.woff2"],style:"italic",weight:"400"},{urls:["systems/pf2e/fonts/roboto-condensed-v24-latin-ext_latin_cyrillic-700.woff2"],style:"normal",weight:"700"},{urls:["systems/pf2e/fonts/roboto-condensed-v24-latin-ext_latin_cyrillic-700italic.woff2"],style:"italic",weight:"700"}]},CONFIG.fontDefinitions["Roboto Mono"]={editor:!1,fonts:[{urls:["systems/pf2e/fonts/roboto-mono-v21-latin-ext_latin_cyrillic-regular.woff2"],style:"normal",weight:"400"},{urls:["systems/pf2e/fonts/roboto-mono-v21-latin-ext_latin_cyrillic-500.woff2"],style:"normal",weight:"500"},{urls:["systems/pf2e/fonts/roboto-mono-v21-latin-ext_latin_cyrillic-700.woff2"],style:"italic",weight:"700"}]},CONFIG.fontDefinitions.Vollkorn={editor:!0,fonts:[{urls:["systems/pf2e/fonts/vollkorn-v20-latin-ext_latin_cyrillic-regular.woff2"],style:"normal",weight:"400"},{urls:["systems/pf2e/fonts/vollkorn-v20-latin-ext_latin_cyrillic-500.woff2"],style:"normal",weight:"500"},{urls:["systems/pf2e/fonts/vollkorn-v20-latin-ext_latin_cyrillic-700.woff2"],style:"normal",weight:"600"},{urls:["systems/pf2e/fonts/vollkorn-v20-latin-ext_latin_cyrillic-900.woff2"],style:"normal",weight:"700"}]},delete CONFIG.fontDefinitions.Arial,delete CONFIG.fontDefinitions.Courier,delete CONFIG.fontDefinitions["Courier New"],delete CONFIG.fontDefinitions.Times,delete CONFIG.fontDefinitions["Times New Roman"]}__name(registerFonts,"registerFonts"),__name2(registerFonts,"registerFonts");function registerKeybindings(){game.keybindings.register("pf2e","cycle-token-stack",{name:"PF2E.Keybinding.CycleTokenStack.Label",hint:"PF2E.Keybinding.CycleTokenStack.Hint",editable:[{key:"KeyZ",modifiers:[]}],onUp:__name2(()=>canvas.tokens.cycleStack(),"onUp")}),game.keybindings.register("pf2e","toggle-party-sheet",{name:"PF2E.Keybinding.TogglePartySheet.Label",hint:"PF2E.Keybinding.TogglePartySheet.Hint",editable:[{key:"KeyP",modifiers:[]}],onDown:__name2(()=>{const party=(()=>{if(game.user.isGM){const token=canvas.ready&&canvas.tokens.controlled.length===1?canvas.tokens.controlled[0]:null;return token?.actor?.isOfType("party")?token.actor:game.actors.party}else if(game.user.character?.isOfType("character")){const pcParties=Array.from(game.user.character.parties);return pcParties.find(p=>p.active)??pcParties.at(0)??null}return null})();if(!party)return!1;const{sheet}=party;return sheet.rendered?sheet._minimized?sheet.maximize():sheet.close():sheet.render(!0),!0},"onDown")});let previousCompendiumBrowserTab="";game.keybindings.register("pf2e","open-compendium-browser",{name:"PF2E.Keybinding.OpenCompendiumBrowser.Label",hint:"PF2E.Keybinding.OpenCompendiumBrowser.Hint",editable:[],onDown:__name2(()=>{const cb=game.pf2e.compendiumBrowser;return cb.rendered?cb.minimized?cb.maximize():(previousCompendiumBrowserTab=htmlQuery(cb.element,"nav .active")?.dataset.tabName??"",cb.close()):objectHasKey(cb.tabs,previousCompendiumBrowserTab)?cb.tabs[previousCompendiumBrowserTab].open():cb.render({force:!0}),!0},"onDown")}),game.modules.get("gm-vision")?.active||game.keybindings.register("pf2e","gmVision",{name:"PF2E.Keybinding.GMVision.Label",hint:"PF2E.Keybinding.GMVision.Hint",editable:[{key:"KeyG",modifiers:["Control"]}],restricted:!0,onDown:__name2(()=>(ui.controls.control?.name==="lighting"?ui.controls.control.tools.gmVision?.onChange?.(new PointerEvent("click"),!game.pf2e.settings.gmVision):game.settings.set("pf2e","gmVision",!game.settings.get("pf2e","gmVision")),!0),"onDown")})}__name(registerKeybindings,"registerKeybindings"),__name2(registerKeybindings,"registerKeybindings");function registerTemplates(){const templatePaths=["chat/check/roll.hbs","chat/check/target-dc-result.hbs","chat/damage/damage-taken.hbs","dice/damage-roll.hbs","dice/damage-tooltip.hbs","actors/character/partials/elemental-blast.hbs","actors/character/partials/feat-slot.hbs","actors/character/partials/header.hbs","actors/character/partials/sidebar.hbs","actors/character/partials/strike.hbs","actors/character/tabs/actions.hbs","actors/character/tabs/biography.hbs","actors/character/tabs/character.hbs","actors/character/tabs/crafting.hbs","actors/character/tabs/effects.hbs","actors/character/tabs/feats.hbs","actors/character/tabs/inventory.hbs","actors/character/tabs/pfs.hbs","actors/character/tabs/proficiencies.hbs","actors/character/tabs/spellcasting.hbs","actors/hazard/partials/header.hbs","actors/hazard/partials/sidebar.hbs","actors/party/kingdom/tabs/main.hbs","actors/party/kingdom/tabs/activities.hbs","actors/party/kingdom/tabs/world.hbs","actors/party/kingdom/tabs/features.hbs","actors/party/kingdom/tabs/ongoing.hbs","actors/party/kingdom/partials/build-entry-boosts.hbs","actors/party/kingdom/partials/settlement.hbs","actors/partials/action.hbs","actors/partials/carry-type.hbs","actors/partials/coinage.hbs","actors/partials/dying-pips.hbs","actors/partials/effects.hbs","actors/partials/encumbrance.hbs","actors/partials/inventory-header.hbs","actors/partials/inventory.hbs","actors/partials/item-line.hbs","actors/partials/modifiers-tooltip.hbs","actors/partials/spell-collection.hbs","actors/partials/toggles.hbs","actors/partials/total-bulk.hbs","actors/character/partials/proficiencylevels-dropdown.hbs","actors/character/icons/d20.hbs","actors/character/icons/pfs.hbs","actors/character/icons/plus.hbs","actors/npc/tabs/main.hbs","actors/npc/tabs/inventory.hbs","actors/npc/tabs/effects.hbs","actors/npc/tabs/spells.hbs","actors/npc/tabs/notes.hbs","actors/npc/partials/header.hbs","actors/npc/partials/sidebar.hbs","actors/npc/partials/action.hbs","actors/npc/partials/attack.hbs","items/action-details.hbs","items/action-sidebar.hbs","items/affliction-details.hbs","items/affliction-sidebar.hbs","items/ammo-details.hbs","items/ancestry-details.hbs","items/ancestry-sidebar.hbs","items/armor-details.hbs","items/background-details.hbs","items/backpack-details.hbs","items/book-details.hbs","items/campaign-feature-details.hbs","items/campaign-feature-sidebar.hbs","items/class-details.hbs","items/condition-details.hbs","items/condition-sidebar.hbs","items/consumable-details.hbs","items/deity-details.hbs","items/effect-details.hbs","items/effect-sidebar.hbs","items/equipment-details.hbs","items/feat-details.hbs","items/feat-sidebar.hbs","items/heritage-details.hbs","items/heritage-sidebar.hbs","items/kit-details.hbs","items/lore-details.hbs","items/melee-details.hbs","items/mystify-panel.hbs","items/physical-sidebar.hbs","items/rules-panel.hbs","items/shield-details.hbs","items/spell-details.hbs","items/spell-overlay.hbs","items/treasure-details.hbs","items/weapon-details.hbs","items/partials/ability-activation.hbs","items/partials/addendum.hbs","items/partials/apex.hbs","items/partials/duration.hbs","items/partials/other-tags.hbs","items/partials/self-applied-effect.hbs","actors/loot/inventory.hbs","actors/loot/sidebar.hbs","actors/vehicle/vehicle-header.hbs","actors/vehicle/sidebar.hbs","actors/vehicle/tabs/details.hbs","actors/vehicle/tabs/actions.hbs","actors/vehicle/tabs/inventory.hbs","actors/vehicle/tabs/description.hbs","actors/vehicle/tabs/effects.hbs","compendium-browser/settings/settings.hbs","compendium-browser/settings/pack-settings.hbs","compendium-browser/settings/source-settings.hbs","chat/action/header.hbs","system/actions/repair/chat-button-partial.hbs","system/actions/repair/repair-result-partial.hbs","system/actions/repair/item-heading-partial.hbs","partials/publication-data.hbs","system/settings/basic-setting.hbs"].map(t2=>`systems/pf2e/templates/${t2}`);foundry.applications.handlebars.loadTemplates(templatePaths)}__name(registerTemplates,"registerTemplates"),__name2(registerTemplates,"registerTemplates");var on_click$2=__name2((_,isExpanded)=>set(isExpanded,!get(isExpanded)),"on_click$2"),root_1$5=from_html('<button type="button" class="flat expand-section svelte-pv9137" aria-label="expand"><i></i> <span> </span></button>'),on_click_1$1=__name2((__1,props,$$props)=>$$props.clearButton?.clear(),"on_click_1$1"),root_3$4=from_html('<button type="button" class="clear-filter svelte-pv9137"></button>'),root$9=from_html('<fieldset class="svelte-pv9137"><legend class="svelte-pv9137"><!> <!></legend> <!></fieldset>');function Filter_container($$anchor,$$props){push($$props,!0);const props=rest_props($$props,["$$slots","$$events","$$legacy"]);let isExpanded=state(proxy($$props.isExpanded));var fieldset=root$9(),legend=child(fieldset),node=child(legend);{var consequent=__name2($$anchor2=>{var button=root_1$5();button.__click=[on_click$2,isExpanded];var i=child(button),span=sibling(i,2),text2=child(span);template_effect($0=>{set_attribute(button,"aria-expanded",get(isExpanded)),set_class(i,1,`fa-solid fa-fw ${get(isExpanded)?"fa-chevron-down":"fa-chevron-up"}`,"svelte-pv9137"),set_text(text2,$0)},[()=>game.i18n.localize($$props.label)]),append($$anchor2,button)},"consequent"),alternate=__name2($$anchor2=>{var text_1=text();template_effect($0=>set_text(text_1,$0),[()=>game.i18n.localize($$props.label)]),append($$anchor2,text_1)},"alternate");if_block(node,$$render=>{"isExpanded"in props?$$render(consequent):$$render(alternate,!1)})}var node_1=sibling(node,2);{var consequent_1=__name2($$anchor2=>{var button_1=root_3$4();button_1.__click=[on_click_1$1,props,$$props],button_1.textContent=game.i18n.localize("PF2E.CompendiumBrowser.Filter.ClearFilter"),append($$anchor2,button_1)},"consequent_1");if_block(node_1,$$render=>{$$props.clearButton?.options.visible&&$$render(consequent_1)})}var node_2=sibling(legend,2);{var consequent_2=__name2($$anchor2=>{var fragment_1=comment(),node_3=first_child(fragment_1);snippet(node_3,()=>$$props.children),append($$anchor2,fragment_1)},"consequent_2");if_block(node_2,$$render=>{(get(isExpanded)===void 0||get(isExpanded))&&$$render(consequent_2)})}append($$anchor,fieldset),pop()}__name(Filter_container,"Filter_container"),__name2(Filter_container,"Filter_container"),delegate(["click"]);var read_methods=["forEach","isDisjointFrom","isSubsetOf","isSupersetOf"],set_like_methods=["difference","intersection","symmetricDifference","union"],inited=!1;class SvelteSet extends Set{static{__name(this,"SvelteSet")}static{__name2(this,"SvelteSet")}#sources=new Map;#version=state(0);#size=state(0);#update_version=update_version||-1;constructor(value){if(super(),value){for(var element of value)super.add(element);this.#size.v=super.size}inited||this.#init()}#source(value){return update_version===this.#update_version?state(value):source(value)}#init(){inited=!0;var proto=SvelteSet.prototype,set_proto=Set.prototype;for(const method of read_methods)proto[method]=function(...v){return get(this.#version),set_proto[method].apply(this,v)};for(const method of set_like_methods)proto[method]=function(...v){get(this.#version);var set2=set_proto[method].apply(this,v);return new SvelteSet(set2)}}has(value){var has=super.has(value),sources=this.#sources,s=sources.get(value);if(s===void 0){if(!has)return get(this.#version),!1;s=this.#source(!0),sources.set(value,s)}return get(s),has}add(value){return super.has(value)||(super.add(value),set(this.#size,super.size),increment(this.#version)),this}delete(value){var deleted=super.delete(value),sources=this.#sources,s=sources.get(value);return s!==void 0&&(sources.delete(value),set(s,!1)),deleted&&(set(this.#size,super.size),increment(this.#version)),deleted}clear(){if(super.size!==0){super.clear();var sources=this.#sources;for(var s of sources.values())set(s,!1);sources.clear(),set(this.#size,0),increment(this.#version)}}keys(){return this.values()}values(){return get(this.#version),super.values()}entries(){return get(this.#version),super.entries()}[Symbol.iterator](){return this.keys()}get size(){return get(this.#size)}}var root$8=from_html('<div class="traits-select svelte-hv2bvq"><!></div>');function Traits_select($$anchor,$$props){const props=rest_props($$props,["$$slots","$$events","$$legacy"]),i18n={empty:game.i18n.localize("PF2E.CompendiumBrowser.TraitsComponent.Empty"),nomatch:game.i18n.localize("PF2E.CompendiumBrowser.TraitsComponent.NoMatch")};var div=root$8(),node=child(div);Svelecte_pf2e(node,spread_props(()=>props,{get i18n(){return i18n}})),append($$anchor,div)}__name(Traits_select,"Traits_select"),__name2(Traits_select,"Traits_select");function onChangeConjunction(event2,traits){const value=event2.currentTarget.value;value!=="and"&&value!=="or"||traits(traits().conjunction=value,!0)}__name(onChangeConjunction,"onChangeConjunction"),__name2(onChangeConjunction,"onChangeConjunction");var root_2$4=from_html('<div class="sv-item--container"><div class="sv-item--wrap in-selection is-multi"><div> </div></div> <button class="sv-item--btn svelte-mmf5km" tabindex="-1" type="button" aria-label="not option" data-action="not"><i class="fa-solid fa-ban fa-2xs svelte-mmf5km"></i></button> <button class="sv-item--btn svelte-mmf5km" tabindex="-1" type="button" aria-label="deslect" data-action="deselect"><svg height="16" width="16" viewBox="0 0 20 20" aria-hidden="true" focusable="false"><path d="M14.348 14.849c-0.469 0.469-1.229 0.469-1.697 0l-2.651-3.030-2.651 3.029c-0.469 0.469-1.229 0.469-1.697 0-0.469-0.469-0.469-1.229 0-1.697l2.758-3.15-2.759-3.152c-0.469-0.469-0.469-1.228 0-1.697s1.228-0.469 1.697 0l2.652 3.031 2.651-3.031c0.469-0.469 1.228-0.469 1.697 0s0.469 1.229 0 1.697l-2.758 3.152 2.758 3.15c0.469 0.469 0.469 1.229 0 1.698z"></path></svg></button></div>'),root$7=from_html('<!> <div class="filter-conjunction svelte-mmf5km"><label class="checkbox"><input type="radio" name="filter-conjunction-and" value="and" class="svelte-mmf5km"/> </label> <label class="checkbox"><input type="radio" name="filter-conjunction-or" value="or" class="svelte-mmf5km"/> </label></div>',1);function Traits($$anchor,$$props){push($$props,!0);const traitSelection=__name2(($$anchor2,options=noop,itemAction=noop)=>{var fragment=comment(),node=first_child(fragment);each(node,19,options,opt=>opt.value,($$anchor3,opt,index2)=>{var div=root_2$4(),div_1=child(div),div_2=child(div_1);let classes;var text2=child(div_2),button=sibling(div_1,2);button.__click=()=>onClickNot(get(index2));var button_1=sibling(button,2);action$J(button_1,($$node,$$action_arg)=>itemAction()?.($$node,$$action_arg),()=>get(opt)),template_effect($0=>{classes=set_class(div_2,1,"sv-item--content svelte-mmf5km",null,classes,$0),set_text(text2,get(opt).label)},[()=>({not:exclude.has(get(opt).value)})]),append($$anchor3,div)}),append($$anchor2,fragment)},"traitSelection"),traits=prop($$props,"traits",15),exclude=proxy(new SvelteSet);function onChangeTraits(newSelection){traits(traits().selected=newSelection.map(n2=>traits().selected.find(s=>s.value===n2.value)??n2),!0)}__name(onChangeTraits,"onChangeTraits"),__name2(onChangeTraits,"onChangeTraits");function onClickNot(index2){const selected=traits().selected.at(index2);selected&&(selected.not=!selected.not,selected.not?exclude.add(selected.value):exclude.delete(selected.value))}__name(onClickNot,"onClickNot"),__name2(onClickNot,"onClickNot"),onMount(()=>{for(const selected of traits().selected)selected.not&&exclude.add(selected.value)});var fragment_1=root$7(),node_1=first_child(fragment_1);{let $0=user_derived(()=>traits().selected.map(s=>s.value));Traits_select(node_1,{get options(){return traits().options},multiple:!0,closeAfterSelect:!0,clearable:!0,creatable:!1,get selection(){return traitSelection},onChange:onChangeTraits,placeholder:game.i18n.localize("PF2E.SelectLabel"),get value(){return get($0)}})}var div_3=sibling(node_1,2),label=child(div_3),input=child(label);input.__change=[onChangeConjunction,traits];var text_1=sibling(input);text_1.nodeValue=` ${game.i18n.localize("PF2E.CompendiumBrowser.Filter.Conjunction.AndLabel")??""}`;var label_1=sibling(label,2),input_1=child(label_1);input_1.__change=[onChangeConjunction,traits];var text_2=sibling(input_1);text_2.nodeValue=` ${game.i18n.localize("PF2E.CompendiumBrowser.Filter.Conjunction.OrLabel")??""}`,template_effect(()=>{set_checked(input,traits().conjunction==="and"),set_checked(input_1,traits().conjunction==="or")}),append($$anchor,fragment_1),pop()}__name(Traits,"Traits"),__name2(Traits,"Traits"),delegate(["click","change"]);function onChangeLevel(event2,level){const name2=event2.currentTarget.name,value=Math.clamp(Number(event2.currentTarget.value),level().min,level().max);name2==="from"?(value>level().to&&level(level().to=value,!0),level(level().from=value,!0)):name2==="to"&&(value<level().from&&level(level().from=value,!0),level(level().to=value,!0)),level(level().changed=level().from!==level().min||level().to!==level().max,!0)}__name(onChangeLevel,"onChangeLevel"),__name2(onChangeLevel,"onChangeLevel");var root_1$4=from_html("<option> </option>"),root_2$3=from_html("<option> </option>"),root$6=from_html('<div class="levels-container svelte-hxey6l"><div class="inputs svelte-hxey6l"><select name="from" class="svelte-hxey6l"></select> - <select name="to" class="svelte-hxey6l"></select></div></div>');function Level($$anchor,$$props){push($$props,!0);const level=prop($$props,"level",15);var div=root$6(),div_1=child(div),select=child(div_1);select.__change=[onChangeLevel,level],each(select,21,()=>t$c(level().min,level().max+1),index,($$anchor2,n2)=>{var option=root_1$4(),text2=child(option),option_value={};template_effect(()=>{set_text(text2,get(n2)),option_value!==(option_value=get(n2))&&(option.value=(option.__value=get(n2))??"")}),append($$anchor2,option)});var select_value;init_select(select);var select_1=sibling(select,2);select_1.__change=[onChangeLevel,level],each(select_1,21,()=>t$c(level().min,level().max+1),index,($$anchor2,n2)=>{var option_1=root_2$3(),text_1=child(option_1),option_1_value={};template_effect(()=>{set_text(text_1,get(n2)),option_1_value!==(option_1_value=get(n2))&&(option_1.value=(option_1.__value=get(n2))??"")}),append($$anchor2,option_1)});var select_1_value;init_select(select_1),template_effect(()=>{select_value!==(select_value=level().from)&&(select.value=(select.__value=level().from)??"",select_option(select,level().from)),select_1_value!==(select_1_value=level().to)&&(select_1.value=(select_1.__value=level().to)??"",select_option(select_1,level().to))}),transition(3,div,()=>slide),append($$anchor,div),pop()}__name(Level,"Level"),__name2(Level,"Level"),delegate(["change"]);function onChangeRange(event2,range,$$props){const activeTab=game.pf2e.compendiumBrowser.activeTab;if(!activeTab)return;const elName=event2.currentTarget.name,elValue=event2.currentTarget.value;elName==="lowerBound"?range(range().values=activeTab.parseRangeFilterInput($$props.name,elValue,range().values.inputMax),!0):elName==="upperBound"&&range(range().values=activeTab.parseRangeFilterInput($$props.name,range().values.inputMin,elValue),!0),range(range().changed=!0,!0)}__name(onChangeRange,"onChangeRange"),__name2(onChangeRange,"onChangeRange");var root$5=from_html('<div class="ranges-container svelte-p8uv99"><div class="inputs svelte-p8uv99"><input type="text" autocomplete="off" name="lowerBound" class="svelte-p8uv99"/> - <input type="text" autocomplete="off" name="upperBound" class="svelte-p8uv99"/></div></div>');function Ranges($$anchor,$$props){push($$props,!0);const range=prop($$props,"range",15);var div=root$5(),div_1=child(div),input=child(div_1);input.__change=[onChangeRange,range,$$props];var input_1=sibling(input,2);input_1.__change=[onChangeRange,range,$$props],template_effect(()=>{set_attribute(input,"placeholder",range().defaultMin),set_attribute(input_1,"placeholder",range().defaultMax)}),bind_value(input,()=>range().values.inputMin,$$value=>range(range().values.inputMin=$$value,!0)),bind_value(input_1,()=>range().values.inputMax,$$value=>range(range().values.inputMax=$$value,!0)),transition(3,div,()=>slide),append($$anchor,div),pop()}__name(Ranges,"Ranges"),__name2(Ranges,"Ranges"),delegate(["change"]);var root_1$3=from_html('<input type="search" class="filter-sources svelte-obnnay" spellcheck="false"/>'),on_change=__name2((event2,onChangeCheckbox,name2,option)=>onChangeCheckbox(event2,{name:name2(),option:option()}),"on_change"),root_3$3=from_html('<label class="svelte-obnnay"><input type="checkbox"/> </label>'),root$4=from_html('<div class="checkbox-container svelte-obnnay"><!> <!></div>');function Checkboxes($$anchor,$$props){push($$props,!0);const checkbox=prop($$props,"checkbox",15);let searchTerm=state("");function onChangeCheckbox(event2,data){const checked=event2.currentTarget.checked;checked?checkbox().selected.push(data.name):checkbox(checkbox().selected=checkbox().selected.filter(name2=>name2!==data.name),!0),data.option.selected=checked}__name(onChangeCheckbox,"onChangeCheckbox"),__name2(onChangeCheckbox,"onChangeCheckbox");const onSearchSource=foundry.utils.debounce(event2=>{event2.target instanceof HTMLInputElement&&set(searchTerm,event2.target.value.trim().toLocaleLowerCase(game.i18n.lang),!0)},250);var div=root$4(),node=child(div);{var consequent=__name2($$anchor2=>{var input=root_1$3();set_attribute(input,"placeholder",game.i18n.localize("PF2E.CompendiumBrowser.Filter.FilterSources")),input.__input=onSearchSource,append($$anchor2,input)},"consequent");if_block(node,$$render=>{$$props.searchable&&$$render(consequent)})}var node_1=sibling(node,2);each(node_1,17,()=>t$f(checkbox().options),index,($$anchor2,$$item)=>{var $$array=user_derived(()=>to_array(get($$item),2));let name2=__name2(()=>get($$array)[0],"name"),option=__name2(()=>get($$array)[1],"option");var fragment=comment(),node_2=first_child(fragment);{var consequent_1=__name2($$anchor3=>{var label=root_3$3(),input_1=child(label);input_1.__change=[on_change,onChangeCheckbox,name2,option];var text2=sibling(input_1);template_effect($0=>{set_attribute(input_1,"name",name2()),set_checked(input_1,option().selected),set_text(text2,` ${$0??""}`)},[()=>game.i18n.localize(option().label)]),append($$anchor3,label)},"consequent_1");if_block(node_2,$$render=>{(!$$props.searchable||!get(searchTerm)||option().selected||option().label.toLocaleLowerCase(game.i18n.lang).includes(get(searchTerm)))&&$$render(consequent_1)})}append($$anchor2,fragment)}),transition(3,div,()=>slide),append($$anchor,div),pop()}__name(Checkboxes,"Checkboxes"),__name2(Checkboxes,"Checkboxes"),delegate(["input","change"]);function onChangeSortOrder(_,filter){filter(filter().order.direction=filter().order.direction==="asc"?"desc":"asc",!0)}__name(onChangeSortOrder,"onChangeSortOrder"),__name2(onChangeSortOrder,"onChangeSortOrder");function onChangeSortValue(event2,filter){const value=event2.currentTarget.value;if(!value)return;const data=filter().order.options[value];data&&(filter(filter().order.type=data.type,!0),filter(filter().order.direction="asc",!0))}__name(onChangeSortValue,"onChangeSortValue"),__name2(onChangeSortValue,"onChangeSortValue");var root_1$2=from_html("<option> </option>"),root_2$2=from_html("<i></i>"),root_3$2=from_html("<i></i>"),root_6$1=from_html("<option> </option>"),root_5$1=from_html('<label class="svelte-165ifxu"> <div class="select-container svelte-165ifxu"><select class="svelte-165ifxu"><option>-</option><!></select></div></label>'),on_click$1=__name2((__1,$$props)=>$$props.resetFilters(),"on_click$1"),root$3=from_html('<div class="control-area svelte-165ifxu"><div class="headercontainer svelte-165ifxu"><input name="textFilter" type="search" autocomplete="off" spellcheck="false"/> <div class="order-by-select svelte-165ifxu"><label id="sort-order" class="svelte-165ifxu"> <div class="select-container svelte-165ifxu"><select class="svelte-165ifxu"></select> <button aria-labelledby="sort-order" type="button" class="order-button svelte-165ifxu"><!></button></div></label> <!></div> <button type="button" class="clear-filters svelte-165ifxu"></button></div> <!> <!> <!> <!> <!></div>');function Filters($$anchor,$$props){push($$props,!0);const filter=prop($$props,"filter",15);function getClearFunction(data,options){return()=>{if("selected"in data){for(const opt of data.selected)data.options[opt].selected=!1;data.selected=[]}else if("from"in data)data.from=data.min,data.to=data.max,data.changed=!1;else if("values"in data&&options?.name){const activeTab=game.pf2e.compendiumBrowser.activeTab;if(!activeTab)return;data.values=activeTab.parseRangeFilterInput(options.name,data.defaultMin,data.defaultMax),data.changed=!1}}}__name(getClearFunction,"getClearFunction"),__name2(getClearFunction,"getClearFunction");const onSearch=foundry.utils.debounce(event2=>{event2.target instanceof HTMLInputElement&&filter(filter().search.text=event2.target.value.trim(),!0)},250);var div=root$3(),div_1=child(div),input=child(div_1);input.__input=onSearch,set_attribute(input,"placeholder",game.i18n.localize("PF2E.CompendiumBrowser.Filter.SearchPlaceholder"));var div_2=sibling(input,2),label_1=child(div_2),text2=child(label_1);text2.nodeValue=`${game.i18n.localize("PF2E.CompendiumBrowser.Filter.OrderByLabel")??""}: `;var div_3=sibling(text2),select=child(div_3);select.__change=[onChangeSortValue,filter],each(select,21,()=>t$f(filter().order.options),index,($$anchor2,$$item)=>{var $$array=user_derived(()=>to_array(get($$item),2));let key=__name2(()=>get($$array)[0],"key"),data=__name2(()=>get($$array)[1],"data");var option=root_1$2(),text_1=child(option),option_value={};template_effect($0=>{set_text(text_1,$0),option_value!==(option_value=key())&&(option.value=(option.__value=key())??"")},[()=>game.i18n.localize(data().label)]),append($$anchor2,option)});var button=sibling(select,2);button.__click=[onChangeSortOrder,filter];var node=child(button);{var consequent=__name2($$anchor2=>{var i=root_2$2();template_effect(()=>set_class(i,1,`fa-solid fa-sort-${filter().order.type??""}-up`,"svelte-165ifxu")),append($$anchor2,i)},"consequent"),alternate=__name2($$anchor2=>{var i_1=root_3$2();template_effect(()=>set_class(i_1,1,`fa-solid fa-sort-${filter().order.type??""}-down-alt`,"svelte-165ifxu")),append($$anchor2,i_1)},"alternate");if_block(node,$$render=>{filter().order.direction==="asc"?$$render(consequent):$$render(alternate,!1)})}var node_1=sibling(label_1,2);{var consequent_1=__name2($$anchor2=>{var fragment=comment(),node_2=first_child(fragment);each(node_2,17,()=>t$f(filter().selects),index,($$anchor3,$$item)=>{var $$array_1=user_derived(()=>to_array(get($$item),2));let key=__name2(()=>get($$array_1)[0],"key"),data=__name2(()=>get($$array_1)[1],"data");var label_2=root_5$1(),text_2=child(label_2),div_4=sibling(text_2),select_1=child(div_4),option_1=child(select_1);option_1.value=option_1.__value="";var node_3=sibling(option_1);each(node_3,17,()=>t$f(data().options),index,($$anchor4,$$item2,$$index_1,$$array_2)=>{var $$array_3=user_derived(()=>to_array(get($$item2),2));let key2=__name2(()=>get($$array_3)[0],"key2"),label=__name2(()=>get($$array_3)[1],"label");var option_2=root_6$1(),text_3=child(option_2),option_2_value={};template_effect($0=>{set_text(text_3,$0),option_2_value!==(option_2_value=key2())&&(option_2.value=(option_2.__value=key2())??"")},[()=>game.i18n.localize(label())]),append($$anchor4,option_2)}),template_effect($0=>{set_text(text_2,`${$0??""}: `),set_attribute(select_1,"data-key",key())},[()=>game.i18n.localize(data().label)]),bind_select_value(select_1,()=>filter().selects[key()].selected,$$value=>filter(filter().selects[key()].selected=$$value,!0)),append($$anchor3,label_2)}),append($$anchor2,fragment)},"consequent_1");if_block(node_1,$$render=>{"selects"in filter()&&$$render(consequent_1)})}var button_1=sibling(div_2,2);button_1.__click=[on_click$1,$$props],button_1.textContent=game.i18n.localize("PF2E.CompendiumBrowser.Filter.ClearAllFilters");var node_4=sibling(div_1,2);Filter_container(node_4,{label:"PF2E.Traits",children:__name2(($$anchor2,$$slotProps)=>{Traits($$anchor2,{get traits(){return filter().traits},set traits($$value){filter(filter().traits=$$value,!0)}})},"children"),$$slots:{default:!0}});var node_5=sibling(node_4,2);each(node_5,17,()=>Object.entries(filter().checkboxes),index,($$anchor2,$$item)=>{var $$array_4=user_derived(()=>to_array(get($$item),2));let key=__name2(()=>get($$array_4)[0],"key"),checkbox=__name2(()=>get($$array_4)[1],"checkbox");{let $0=user_derived(()=>({options:{visible:checkbox().selected.length>0},clear:getClearFunction(checkbox())}));Filter_container($$anchor2,{get isExpanded(){return checkbox().isExpanded},get clearButton(){return get($0)},get label(){return checkbox().label},children:__name2(($$anchor3,$$slotProps)=>{Checkboxes($$anchor3,{get checkbox(){return filter().checkboxes[key()]},set checkbox($$value){filter(filter().checkboxes[key()]=$$value,!0)}})},"children"),$$slots:{default:!0}})}});var node_6=sibling(node_5,2);{var consequent_2=__name2($$anchor2=>{{let $0=user_derived(()=>({options:{visible:filter().source.selected.length>0},clear:getClearFunction(filter().source)}));Filter_container($$anchor2,{get isExpanded(){return filter().source.isExpanded},get clearButton(){return get($0)},label:"PF2E.CompendiumBrowser.Filter.Source",children:__name2(($$anchor3,$$slotProps)=>{Checkboxes($$anchor3,{searchable:!0,get checkbox(){return filter().source},set checkbox($$value){filter(filter().source=$$value,!0)}})},"children"),$$slots:{default:!0}})}},"consequent_2");if_block(node_6,$$render=>{filter().source&&$$render(consequent_2)})}var node_7=sibling(node_6,2);{var consequent_3=__name2($$anchor2=>{var fragment_6=comment(),node_8=first_child(fragment_6);each(node_8,17,()=>t$f(filter().ranges),index,($$anchor3,$$item)=>{var $$array_5=user_derived(()=>to_array(get($$item),2));let name2=__name2(()=>get($$array_5)[0],"name"),range=__name2(()=>get($$array_5)[1],"range");{let $0=user_derived(()=>({options:{visible:range().changed},clear:getClearFunction(range(),{name:name2()})}));Filter_container($$anchor3,{get isExpanded(){return range().isExpanded},get clearButton(){return get($0)},get label(){return range().label},children:__name2(($$anchor4,$$slotProps)=>{Ranges($$anchor4,{get name(){return name2()},get range(){return filter().ranges[name2()]},set range($$value){filter(filter().ranges[name2()]=$$value,!0)}})},"children"),$$slots:{default:!0}})}}),append($$anchor2,fragment_6)},"consequent_3");if_block(node_7,$$render=>{"ranges"in filter()&&$$render(consequent_3)})}var node_9=sibling(node_7,2);{var consequent_4=__name2($$anchor2=>{{let $0=user_derived(()=>({options:{visible:filter().level.changed},clear:getClearFunction(filter().level)}));Filter_container($$anchor2,{get isExpanded(){return filter().level.isExpanded},get clearButton(){return get($0)},label:"PF2E.CompendiumBrowser.Filter.Levels",children:__name2(($$anchor3,$$slotProps)=>{Level($$anchor3,{get level(){return filter().level},set level($$value){filter(filter().level=$$value,!0)}})},"children"),$$slots:{default:!0}})}},"consequent_4");if_block(node_9,$$render=>{"level"in filter()&&$$render(consequent_4)})}template_effect(()=>set_value(input,filter().search.text)),bind_select_value(select,()=>filter().order.by,$$value=>filter(filter().order.by=$$value,!0)),append($$anchor,div),pop()}__name(Filters,"Filters"),__name2(Filters,"Filters"),delegate(["input","change","click"]);var on_click=__name2((_,onClickButton,entry)=>onClickButton(entry.uuid,"open-sheet"),"on_click"),root_1$1=from_html('<span class="action-glyph"> </span>'),root_3$1=from_html('<span data-tooltip="PF2E.Rarity"> </span>'),root_2$1=from_html('<div class="tags paizo-style svelte-1vfrdc6"><!></div>'),root_4=from_html('<div class="price svelte-1vfrdc6" data-tooltip="PF2E.PriceLabel"> </div>'),root_5=from_html('<div class="level svelte-1vfrdc6"><span data-tooltip="PF2E.LevelLabel"> </span></div>'),root_6=from_html('<div class="level svelte-1vfrdc6"><span data-tooltip="PF2E.Item.Spell.Rank.Label"> </span></div>'),on_click_1=__name2((__1,onClickButton,entry)=>onClickButton(entry.uuid,"take-item"),"on_click_1"),on_click_2=__name2((__2,onClickButton,entry)=>onClickButton(entry.uuid,"buy-item"),"on_click_2"),root_7=from_html('<button class="equipment-action flat svelte-1vfrdc6" aria-label="take item" data-tooltip="PF2E.CompendiumBrowser.TakeLabel"><i class="fa-regular fa-hand-rock svelte-1vfrdc6"></i></button> <button class="equipment-action flat svelte-1vfrdc6" aria-label="buy item" data-tooltip="PF2E.CompendiumBrowser.BuyLabel"><i class="fa-solid fa-coins svelte-1vfrdc6"></i></button>',1),root$2=from_html('<li draggable="true" class="svelte-1vfrdc6"><div class="image svelte-1vfrdc6"><img loading="lazy" class="svelte-1vfrdc6"/></div> <div class="name svelte-1vfrdc6"><button class="flat result-link svelte-1vfrdc6"> </button> <!></div> <!> <!> <!> <!> <!></li>');function Result_item($$anchor,$$props){push($$props,!0);const entry=$$props.entry,activeTabName=$$props.activeTabName;async function onClickButton(uuid,action2){switch(action2){case"buy-item":buyPhysicalItem(uuid);break;case"open-sheet":(await fromUuid(uuid))?.sheet.render(!0);break;case"take-item":takePhysicalItem(uuid);break}}__name(onClickButton,"onClickButton"),__name2(onClickButton,"onClickButton");function onDragStart(event2,uuid){event2.stopPropagation();const item=htmlClosest(event2.target,"li"),browser=game.pf2e.compendiumBrowser;!item||!event2.dataTransfer||(event2.dataTransfer?.setDragImage(item,0,0),gsap.to(browser.element,{duration:.25,opacity:.125,pointerEvents:"none"}),event2.dataTransfer.setData("text/plain",JSON.stringify({type:foundry.utils.parseUuid(uuid)?.type,uuid})),item.addEventListener("dragend",()=>{window.setTimeout(()=>{gsap.to(browser.element,{duration:.25,opacity:1,pointerEvents:""})},500)},{once:!0}))}__name(onDragStart,"onDragStart"),__name2(onDragStart,"onDragStart");async function takePhysicalItem(uuid){const actors=getSelectedActors({include:["character","loot","npc","party"],assignedFallback:!0});if(actors.length===0){ui.notifications.error(game.i18n.format("PF2E.ErrorMessage.NoTokenSelected"));return}const item=await getPhysicalItem(uuid);for(const actor of actors){const sizedItem=item.isOfType("kit")?item.clone():sizeItemForActor(item,actor);await actor.inventory.add(sizedItem,{stack:!0})}actors.length===1&&game.user.character&&actors[0]===game.user.character?ui.notifications.info(game.i18n.format("PF2E.CompendiumBrowser.AddedItemToCharacter",{item:item.name,character:game.user.character.name})):ui.notifications.info(game.i18n.format("PF2E.CompendiumBrowser.AddedItem",{item:item.name}))}__name(takePhysicalItem,"takePhysicalItem"),__name2(takePhysicalItem,"takePhysicalItem");async function buyPhysicalItem(uuid){const actors=getSelectedActors({include:["character","loot","npc"],assignedFallback:!0});if(actors.length===0)if(game.user.character?.isOfType("character"))actors.push(game.user.character);else{ui.notifications.error(game.i18n.format("PF2E.ErrorMessage.NoTokenSelected"));return}const item=await getPhysicalItem(uuid);let purchaseSuccesses=0;for(const actor of actors)if(await actor.inventory.removeCoins(item.price.value)){purchaseSuccesses+=1;const sizedItem=item.isOfType("kit")?item.clone():sizeItemForActor(item,actor);await actor.inventory.add(sizedItem,{stack:!0})}actors.length===1?purchaseSuccesses===1?ui.notifications.info(game.i18n.format("PF2E.CompendiumBrowser.BoughtItemWithCharacter",{item:item.name,character:actors[0].name})):ui.notifications.warn(game.i18n.format("PF2E.CompendiumBrowser.FailedToBuyItemWithCharacter",{item:item.name,character:actors[0].name})):purchaseSuccesses===actors.length?ui.notifications.info(game.i18n.format("PF2E.CompendiumBrowser.BoughtItemWithAllCharacters",{item:item.name})):ui.notifications.warn(game.i18n.format("PF2E.CompendiumBrowser.FailedToBuyItemWithSomeCharacters",{item:item.name}))}__name(buyPhysicalItem,"buyPhysicalItem"),__name2(buyPhysicalItem,"buyPhysicalItem");async function getPhysicalItem(uuid){const item=await fromUuid(uuid);if(!item?.isOfType("physical","kit"))throw ErrorPF2e("Unexpected failure retrieving compendium item");return item}__name(getPhysicalItem,"getPhysicalItem"),__name2(getPhysicalItem,"getPhysicalItem");var li=root$2(),div=child(li),img2=child(div),div_1=sibling(div,2),button=child(div_1);button.__click=[on_click,onClickButton,entry];var text2=child(button),node=sibling(button,2);{var consequent=__name2($$anchor2=>{var span=root_1$1(),text_1=child(span);template_effect(()=>set_text(text_1,entry.actionGlyph)),append($$anchor2,span)},"consequent");if_block(node,$$render=>{entry.actionGlyph&&$$render(consequent)})}var node_1=sibling(div_1,2);{var consequent_2=__name2($$anchor2=>{var div_2=root_2$1(),node_2=child(div_2);{var consequent_1=__name2($$anchor3=>{var span_1=root_3$1(),text_2=child(span_1);template_effect($0=>{set_class(span_1,1,`tag rarity ${entry.rarity??""}`,"svelte-1vfrdc6"),set_text(text_2,$0)},[()=>game.i18n.localize(CONFIG.PF2E.rarityTraits[entry.rarity])]),append($$anchor3,span_1)},"consequent_1");if_block(node_2,$$render=>{entry.rarity!=="common"&&$$render(consequent_1)})}append($$anchor2,div_2)},"consequent_2");if_block(node_1,$$render=>{entry.rarity&&$$render(consequent_2)})}var node_3=sibling(node_1,2);{var consequent_3=__name2($$anchor2=>{var div_3=root_4(),text_3=child(div_3);template_effect($0=>set_text(text_3,$0),[()=>entry.price.toString({short:!0})]),append($$anchor2,div_3)},"consequent_3");if_block(node_3,$$render=>{entry.price&&$$render(consequent_3)})}var node_4=sibling(node_3,2);{var consequent_4=__name2($$anchor2=>{var div_4=root_5(),span_2=child(div_4),text_4=child(span_2);template_effect(()=>set_text(text_4,entry.level)),append($$anchor2,div_4)},"consequent_4");if_block(node_4,$$render=>{entry.level!==void 0&&$$render(consequent_4)})}var node_5=sibling(node_4,2);{var consequent_5=__name2($$anchor2=>{var div_5=root_6(),span_3=child(div_5),text_5=child(span_3);template_effect(()=>set_text(text_5,entry.rank)),append($$anchor2,div_5)},"consequent_5");if_block(node_5,$$render=>{entry.rank&&$$render(consequent_5)})}var node_6=sibling(node_5,2);{var consequent_6=__name2($$anchor2=>{var fragment=root_7(),button_1=first_child(fragment);button_1.__click=[on_click_1,onClickButton,entry];var button_2=sibling(button_1,2);button_2.__click=[on_click_2,onClickButton,entry],append($$anchor2,fragment)},"consequent_6");if_block(node_6,$$render=>{activeTabName==="equipment"&&$$render(consequent_6)})}template_effect(()=>{set_attribute(img2,"src",entry.img),set_attribute(img2,"alt",entry.name),set_text(text2,entry.name)}),event$1("dragstart",li,event2=>onDragStart(event2,entry.uuid)),append($$anchor,li),pop()}__name(Result_item,"Result_item"),__name2(Result_item,"Result_item"),delegate(["click"]);var root$1=from_html('<div class="browser-tab svelte-nwz3p5" data-tooltip-class="pf2e"><!> <ul class="result-list svelte-nwz3p5"></ul></div>');function Browser_tab($$anchor,$$props){if(push($$props,!0),!$$props.activeTabName)throw ErrorPF2e(`Invalid tab name: "${$$props.activeTabName}"!`);const browser=game.pf2e.compendiumBrowser,tab=user_derived(()=>browser.tabs[$$props.activeTabName]);function resetFilters(){get(tab).resetFilters()}__name(resetFilters,"resetFilters"),__name2(resetFilters,"resetFilters");function onscroll(){if(!$$props.activeTabName)return;const resultList=$$props.state.resultList;resultList.scrollTop+resultList.clientHeight>=resultList.scrollHeight-5&&(get(tab).resultLimit+=CompendiumBrowser.RESULT_LIMIT)}__name(onscroll,"onscroll"),__name2(onscroll,"onscroll"),user_effect(()=>{get(tab).isGMOnly&&!game.user.isGM&&($$props.state.activeTabName="",console.error("PF2e System | This browser tab is flagged as GM-only!"))});var div=root$1(),node=child(div);Filters(node,{resetFilters,get filter(){return get(tab).filterData},set filter($$value){get(tab).filterData=$$value}});var ul=sibling(node,2);each(ul,21,()=>get(tab).results.slice(0,get(tab).resultLimit),entry=>entry.uuid,($$anchor2,entry)=>{Result_item($$anchor2,{get activeTabName(){return $$props.activeTabName},get entry(){return get(entry)}})}),bind_this(ul,$$value=>$$props.state.resultList=$$value,()=>$$props?.state?.resultList),template_effect(()=>set_attribute(div,"data-tab-name",$$props.activeTabName)),event$1("scroll",ul,onscroll),append($$anchor,div),pop()}__name(Browser_tab,"Browser_tab"),__name2(Browser_tab,"Browser_tab");var root_2=from_html('<button type="button"> </button>'),root_1=from_html('<nav class="tabs svelte-19xx45a"></nav>'),root_3=from_html('<div class="browser-tab" data-tooltip-class="pf2e"><div class="landing-page svelte-19xx45a"></div></div>'),root=from_html("<!> <!>",1);function App($$anchor,$$props){push($$props,!0);const browser=game.pf2e.compendiumBrowser,tabs2=user_derived(()=>browser.tabsArray.filter(t2=>t2.visible)),state2=$$props.state;async function onClickNav(event2){if(!(event2.target instanceof HTMLElement))return;const clickedTab=event2.target.dataset.tabName;tupleHasValue(browser.dataTabsList,clickedTab)&&(browser.activeTab=browser.tabs[clickedTab],await browser.activeTab.init(),state2.activeTabName=clickedTab)}__name(onClickNav,"onClickNav"),__name2(onClickNav,"onClickNav");var fragment=root(),node=first_child(fragment);{var consequent=__name2($$anchor2=>{var nav=root_1();each(nav,21,()=>get(tabs2),index,($$anchor3,tab)=>{var button=root_2();button.__click=onClickNav;let classes;var text2=child(button);template_effect($0=>{set_attribute(button,"data-tab-name",get(tab).tabName),classes=set_class(button,1,"svelte-19xx45a",null,classes,$0),set_text(text2,get(tab).label)},[()=>({active:state2.activeTabName===get(tab).tabName})]),append($$anchor3,button)}),append($$anchor2,nav)},"consequent");if_block(node,$$render=>{get(tabs2).length>1&&$$render(consequent)})}var node_1=sibling(node,2);{var consequent_1=__name2($$anchor2=>{var div=root_3(),div_1=child(div);div_1.textContent=game.i18n.localize("PF2E.CompendiumBrowser.Hint"),append($$anchor2,div)},"consequent_1"),alternate=__name2($$anchor2=>{Browser_tab($$anchor2,{get state(){return state2},get activeTabName(){return state2.activeTabName},set activeTabName($$value){state2.activeTabName=$$value}})},"alternate");if_block(node_1,$$render=>{state2.activeTabName?$$render(alternate,!1):$$render(consequent_1)})}append($$anchor,fragment),pop()}__name(App,"App"),__name2(App,"App"),delegate(["click"]);class PackLoader{static{__name(this,"PackLoader")}static{__name2(this,"PackLoader")}loadedSources=[];sourcesSettings;constructor(){this.sourcesSettings=game.settings.get("pf2e","compendiumBrowserSources")}async*loadPacks(documentType,packs,indexFields){const localize=localizer("PF2E.ProgressBar"),sources=this.#getSources(),progress=ui.notifications.info("",{progress:!0}),increment2=1/packs.length;for(const packId of packs){const pack=game.packs.get(packId);if(!pack){progress.update({pct:progress.pct+increment2});continue}if(progress.update({message:localize("LoadingPack",{pack:pack.metadata.label}),pct:progress.pct+increment2}),pack.documentName===documentType){const index2=await pack.getIndex({fields:indexFields});if((index2.contents.at(0)??{}).system){const filteredIndex=this.#createFilteredIndex(index2,sources);this.#setModuleArt(packId,filteredIndex),yield{pack,index:filteredIndex}}else ui.notifications.warn(game.i18n.format("PF2E.BrowserWarnPackNotLoaded",{pack:pack.collection}))}}progress.update({message:localize("LoadingComplete"),pct:1})}#setModuleArt(packName,index2){if(packName.startsWith("pf2e."))for(const record of index2){const uuid=`Compendium.${packName}.Actor.${record._id}`,actorArt=game.compendiumArt.get(uuid)?.actor??game.pf2e.system.moduleArt.map.get(uuid)?.img;record.img=actorArt??record.img}}#getSources(){const sources=new Set;for(const[slug,source2]of Object.entries(this.sourcesSettings.sources))source2?.load&&sources.add(slug);return sources}#createFilteredIndex(index2,sources){if(sources.size===0||game.user.isGM&&this.sourcesSettings.ignoreAsGM)return index2;const filteredIndex=new Collection,knownSources=Object.keys(this.sourcesSettings.sources);for(const data of index2){const source2=this.#getSourceFromIndexData(data);(!source2&&this.sourcesSettings.showEmptySources||sources.has(source2)||this.sourcesSettings.showUnknownSources&&source2&&!knownSources.includes(source2))&&filteredIndex.set(data._id,foundry.utils.deepClone(data))}return filteredIndex}async updateSources(packs){await this.#loadSources(packs);for(const source2 of this.loadedSources){const slug=sluggify(source2);this.sourcesSettings.sources[slug]===void 0&&(this.sourcesSettings.sources[slug]={load:this.sourcesSettings.showUnknownSources,name:source2})}this.sourcesSettings.sources=Object.fromEntries(Object.entries(this.sourcesSettings.sources).sort((a,b)=>a[0].localeCompare(b[0],game.i18n.lang)))}async#loadSources(packs){const localize=localizer("PF2E.ProgressBar"),progress=ui.notifications.info("",{progress:!0}),increment2=1/packs.length,loadedSources=new Set,indexFields=["system.publication.title","system.source.value"],knownDocumentTypes=["Actor","Item"];for(const packId of packs){const pack=game.packs.get(packId);if(!pack||!knownDocumentTypes.includes(pack.documentName)){progress.update({pct:progress.pct+increment2});continue}progress.update({message:localize("LoadingPack",{pack:pack?.metadata.label??""}),pct:progress.pct+increment2});const index2=await pack.getIndex({fields:indexFields});for(const element of index2){const source2=this.#getSourceFromIndexData(element);source2&&source2!==""&&loadedSources.add(source2)}}progress.update({message:localize("LoadingComplete"),pct:1});const loadedSourcesArray=Array.from(loadedSources).sort();this.loadedSources=loadedSourcesArray}#getSourceFromIndexData(indexData){const system2=indexData.system;return system2?sluggify(system2.publication?.title??system2.details?.publication?.title??system2.source?.value??system2.details?.source?.value??""):""}reset(){this.loadedSources=[]}async hardReset(packs){this.reset(),this.sourcesSettings={ignoreAsGM:!0,showEmptySources:!0,showUnknownSources:!0,sources:{}},await this.updateSources(packs)}}class CompendiumBrowserSettingsApp extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"CompendiumBrowserSettingsApp")}static{__name2(this,"CompendiumBrowserSettingsApp")}#tabSettings={action:{label:"PF2E.CompendiumBrowser.TabAbilities"},bestiary:{label:"PF2E.CompendiumBrowser.TabBestiary"},campaignFeature:{label:"PF2E.CompendiumBrowser.TabCampaign"},equipment:{label:"PF2E.CompendiumBrowser.TabEquipment"},feat:{label:"PF2E.CompendiumBrowser.TabFeat"},hazard:{label:"PF2E.CompendiumBrowser.TabHazard"},spell:{label:"PF2E.CompendiumBrowser.TabSpell"}};static DEFAULT_OPTIONS={id:"compendium-browser-settings",classes:["compendium-browser"],tag:"form",position:{width:800,height:700},window:{resizable:!0,title:"PF2E.CompendiumBrowser.Settings.Title"},form:{submitOnChange:!1,closeOnSubmit:!0,handler:this.#onSubmit}};static PARTS={mainWindow:{template:"systems/pf2e/templates/compendium-browser/settings/settings.hbs",scrollable:[".settings-container"]}};tabGroups={settings:"packs"};async _preFirstRender(context,options){await super._preFirstRender(context,options);const browser=game.pf2e.compendiumBrowser;return browser.packLoader.updateSources(browser.loadedPacksAll())}_attachPartListeners(partId,html2,options){super._attachPartListeners(partId,html2,options);const sourceSearch=htmlQuery(html2,"input[data-element=setting-sources-search]"),sourceToggle=htmlQuery(html2,"input[data-action=setting-sources-toggle-visible]"),sourceSettings=htmlQueryAll(html2,"label[data-element=setting-source]");sourceSearch?.addEventListener("input",()=>{const value=sourceSearch.value?.trim().toLocaleLowerCase(game.i18n.lang);for(const element of sourceSettings){const name2=element.dataset.name?.toLocaleLowerCase(game.i18n.lang),shouldBeHidden=!!value&&!!name2&&!name2.includes(value);element.classList.toggle("hidden",shouldBeHidden)}sourceToggle&&(sourceToggle.checked=!1)}),sourceToggle?.addEventListener("click",()=>{for(const element of sourceSettings){const checkbox=htmlQuery(element,"input[type=checkbox]");!element.classList.contains("hidden")&&checkbox&&(checkbox.checked=sourceToggle.checked)}}),htmlQuery(html2,"button[data-action=settings-sources-delete]")?.addEventListener("click",async()=>{const localize=localizer("PF2E.SETTINGS.CompendiumBrowserSources");if(await foundry.applications.api.DialogV2.confirm({window:{title:localize("DeleteAllTitle")},content:`
                    <p>
                        ${localize("DeleteAllQuestion")}
                    </p>
                    <p>
                        ${localize("DeleteAllInfo")}
                    </p>`})){const browser=game.pf2e.compendiumBrowser;await browser.packLoader.hardReset(browser.loadedPacksAll()),await game.settings.set("pf2e","compendiumBrowserSources",browser.packLoader.sourcesSettings),await browser.resetInitializedTabs(),await this.render(),this.changeTab("source","settings",{force:!0}),browser.render({force:!0})}})}async _prepareContext(_options){game.settings.get("pf2e","campaignType")==="none"&&(this.#tabSettings.campaignFeature.hidden=!0);const browser=game.pf2e.compendiumBrowser;for(const[name2,settings]of Object.entries(browser.settings))if(objectHasKey(this.#tabSettings,name2)){const duplicates=new Set,seen=new Set;for(const setting of Object.values(settings))if(!(!setting||setting.package==="pf2e")){if(seen.has(setting.package)){duplicates.add(setting.package);continue}seen.add(setting.package)}for(const setting of Object.values(settings))!setting||setting.package==="pf2e"||duplicates.has(setting.package)&&(setting.showFullId=!0);this.#tabSettings[name2].settings=settings}else console.warn(`Unknown Compendium Browser setting "${name2}"!`);return{user:game.user,tabSettings:this.#tabSettings,sources:browser.packLoader.sourcesSettings}}static async#onSubmit(_event,_form,formData){const browser=game.pf2e.compendiumBrowser,settings=browser.settings,getCheckboxValue=__name2(key=>formData.get(key)==="true","getCheckboxValue");for(const[t2,packs]of Object.entries(settings))for(const[key,pack]of Object.entries(packs))pack.load=getCheckboxValue(`${t2}-${key}`);await game.settings.set("pf2e","compendiumBrowserPacks",settings);for(const[key,source2]of Object.entries(browser.packLoader.sourcesSettings.sources)){if(!source2?.name){delete browser.packLoader.sourcesSettings.sources[key];continue}source2.load=getCheckboxValue(`source-${key}`)}browser.packLoader.sourcesSettings.showEmptySources=getCheckboxValue("show-empty-sources"),browser.packLoader.sourcesSettings.showUnknownSources=getCheckboxValue("show-unknown-sources"),browser.packLoader.sourcesSettings.ignoreAsGM=getCheckboxValue("ignore-as-gm"),await game.settings.set("pf2e","compendiumBrowserSources",browser.packLoader.sourcesSettings),await browser.resetInitializedTabs(),ui.notifications.info("PF2E.CompendiumBrowser.Settings.Saved",{localize:!0})}}class CompendiumBrowserTab{static{__name(this,"CompendiumBrowserTab")}static{__name2(this,"CompendiumBrowserTab")}browser;#filterData=state();get filterData(){return get(this.#filterData)}set filterData(value){set(this.#filterData,value,!0)}#results=user_derived(()=>{if(!this.filterData)return[];this.browser.resetListElement();const searchText=foundry.applications.ux.SearchFilter.cleanQuery(this.filterData.search.text);if(searchText){const searchResult=this.searchEngine.search(searchText);return this.sortResult(searchResult.filter(this.filterIndexData.bind(this)))}return this.sortResult(this.indexData.filter(this.filterIndexData.bind(this)))});get results(){return get(this.#results)}set results(value){set(this.#results,value)}#resultLimit=state(proxy(CompendiumBrowser.RESULT_LIMIT));get resultLimit(){return get(this.#resultLimit)}set resultLimit(value){set(this.#resultLimit,value,!0)}indexData=[];isInitialized=!1;totalItemCount=0;#visible=state(!0);get visible(){return get(this.#visible)}set visible(value){set(this.#visible,value,!0)}searchFields=[];storeFields=[];#MAX_TABLE_SIZE=1e3;get label(){return game.i18n.localize(this.tabLabel)}get isGMOnly(){return!1}constructor(browser){this.browser=browser}async init(force){if(this.isInitialized&&!force)return;await this.loadData();const wordSegmenter="Segmenter"in Intl?new Intl.Segmenter(game.i18n.lang,{granularity:"word"}):{segment(term){return[{segment:term}]}};this.searchEngine=new MiniSearch({fields:this.searchFields,idField:"uuid",processTerm:__name2(term=>term.length<=1||CompendiumDirectoryPF2e.STOP_WORDS.has(term)?null:Array.from(wordSegmenter.segment(term)).map(t2=>foundry.applications.ux.SearchFilter.cleanQuery(t2.segment.toLocaleLowerCase(game.i18n.lang)).replace(/['"]/g,"")).filter(t2=>t2.length>1),"processTerm"),storeFields:this.storeFields,searchOptions:{combineWith:"AND",prefix:!0}}),this.searchEngine.addAll(this.indexData),this.defaultFilterData=foundry.utils.deepClone(this.filterData),this.isInitialized=!0}async open(options){if(options?.filter&&!this.isInitialized)throw ErrorPF2e("Tried to pass filter data to an uninitialized tab!");return this.browser.openTab(this.tabName,options)}async getFilterData(){return this.isInitialized||await this.init(),foundry.utils.deepClone(this.defaultFilterData)}resetFilters(){this.filterData=foundry.utils.deepClone(this.defaultFilterData)}isOfType(...types){return types.some(t2=>this.tabName===t2)}filterTraits(traits,selected,condition){const selectedTraits=selected.filter(s=>!s.not).map(s=>s.value);return selected.filter(t2=>t2.not).map(s=>s.value).some(t2=>traits.includes(t2))?!1:selectedTraits.length?condition==="and"?selectedTraits.every(t2=>traits.includes(t2)):selectedTraits.some(t2=>traits.includes(t2)):!0}sortResult(result){if(!this.filterData)return[];const order=this.filterData.order,lang=game.i18n.lang,sorted=result.sort((entryA,entryB)=>{switch(order.by){case"name":return entryA.name.localeCompare(entryB.name,lang);case"level":return entryA.level-entryB.level||entryA.name.localeCompare(entryB.name,lang);case"price":return entryA.priceInCopper-entryB.priceInCopper||entryA.name.localeCompare(entryB.name,lang);case"rank":return entryA.rank-entryB.rank||entryA.name.localeCompare(entryB.name,lang);default:return 0}});return order.direction==="asc"?sorted:sorted.reverse()}parseRangeFilterInput(_name,lower,upper){return{min:Number(lower)||0,max:Number(upper)||0,inputMin:lower,inputMax:upper}}arrayIncludes(array,other){return other.some(value=>array.includes(value))}generateCheckboxOptions(configData,sort=!0){const localized=t$5(configData,v=>game.i18n.localize(e$3(v)?v.label:v));return Object.entries(sort?this.sortedConfig(localized):localized).reduce((result,[key,label])=>({...result,[key]:{label,selected:!1}}),{})}generateMultiselectOptions(optionsRecord,sort=!0){const options=Object.entries(optionsRecord).map(([value,label])=>({value,label:game.i18n.localize(label)}));return sort&&options.sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang)),options}generateSourceCheckboxOptions(sources){return[...sources].sort().reduce((result,source2)=>({...result,[sluggify(source2)]:{label:source2,selected:!1}}),{})}sortedConfig(obj){return Object.fromEntries([...Object.entries(obj)].sort((entryA,entryB)=>entryA[1].localeCompare(entryB[1],game.i18n.lang)))}hasAllIndexFields(data,indexFields){for(const field of indexFields)if(foundry.utils.getProperty(data,field)===void 0&&!/\.(?:source|publication)/.test(field))return!1;return!0}#getRollTableResults({initial=0,weight=1}){return this.results.map((entry,index2)=>{const rangeMinMax=initial+index2+1;return{type:"document",documentUuid:entry.uuid,weight,range:[rangeMinMax,rangeMinMax],drawn:!1}})}async createRollTable(){if(!this.isInitialized)throw ErrorPF2e(`Compendium Browser Tab "${this.tabName}" is not initialized!`);if(this.results.length>this.#MAX_TABLE_SIZE){ui.notifications.warn(game.i18n.format("PF2E.CompendiumBrowser.RollTable.TooManyResults",{size:this.results.length,maxSize:this.#MAX_TABLE_SIZE}));return}const content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/compendium-browser/roll-table-dialog.hbs",{count:this.results.length});foundry.applications.api.DialogV2.confirm({content,window:{title:"PF2E.CompendiumBrowser.RollTable.CreateLabel"},yes:{callback:__name2((_event,_button,dialog)=>{const dialogEl=dialog.element,name2=htmlQuery(dialogEl,"input[name=name]")?.value||game.i18n.localize("PF2E.CompendiumBrowser.Title"),weight=Number(htmlQuery(dialogEl,"input[name=weight]")?.value)||1,results=this.#getRollTableResults({weight});RollTable.create({name:name2,results,formula:`1d${results.length}`},{renderSheet:!0})},"callback"),default:!0}})}async addToRollTable(){if(!this.isInitialized)throw ErrorPF2e(`Compendium Browser Tab "${this.tabName}" is not initialized!`);if(this.results.length>this.#MAX_TABLE_SIZE){ui.notifications.warn(game.i18n.format("PF2E.CompendiumBrowser.RollTable.TooManyResults",{size:this.results.length,maxSize:this.#MAX_TABLE_SIZE}));return}const content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/compendium-browser/roll-table-dialog.hbs",{count:this.results.length,rollTables:game.tables.contents});foundry.applications.api.DialogV2.confirm({window:{title:"PF2E.CompendiumBrowser.RollTable.SelectTableTitle"},content,yes:{callback:__name2((_event,_button,dialog)=>{const html2=dialog.element,option=htmlQuery(html2,"select[name=roll-table]")?.selectedOptions[0];if(!option)return;const weight=Number(htmlQuery(html2,"input[name=weight]")?.value)||1,table=game.tables.get(option.value,{strict:!0});table.createEmbeddedDocuments("TableResult",this.#getRollTableResults({initial:table.results.size,weight})),table?.sheet?.render({force:!0})},"callback")}})}}class CompendiumBrowserActionTab extends CompendiumBrowserTab{static{__name(this,"CompendiumBrowserActionTab")}static{__name2(this,"CompendiumBrowserActionTab")}tabName="action";tabLabel="PF2E.CompendiumBrowser.TabAbilities";searchFields=["name","originalName"];storeFields=["type","name","img","uuid","traits","source","category","actionType"];constructor(browser){super(browser),this.filterData=this.prepareFilterData()}async loadData(){console.debug("PF2e System | Compendium Browser | Started loading actions");const actions=[],indexFields=["img","system.actionType.value","system.category","system.traits.value","system.actionType.value","system.publication","system.source"],publications=new Set;for await(const{pack,index:index2}of this.browser.packLoader.loadPacks("Item",this.browser.loadedPacks("action"),indexFields)){console.debug(`PF2e System | Compendium Browser | ${pack.metadata.label} - Loading`);for(const actionData of index2)if(actionData.type==="action"){if(!this.hasAllIndexFields(actionData,indexFields)){console.warn(`Action '${actionData.name}' does not have all required data fields. Consider unselecting pack '${pack.metadata.label}' in the compendium browser settings.`);continue}actionData.system.actionType.value==="passive"&&(actionData.img=getActionIcon("passive"));const{system:system2}=actionData,pubSource=String(system2.publication?.title??system2.source?.value??"").trim(),sourceSlug=sluggify(pubSource);pubSource&&publications.add(pubSource),actions.push({type:actionData.type,name:actionData.name,originalName:actionData.originalName,img:actionData.img,uuid:actionData.uuid,traits:actionData.system.traits.value.map(t2=>t2.replace(/^hb_/,"")),actionType:actionData.system.actionType.value,category:actionData.system.category,source:sourceSlug})}}this.indexData=actions,this.filterData.traits.options=this.generateMultiselectOptions(CONFIG.PF2E.actionTraits),this.filterData.checkboxes.types.options=this.generateCheckboxOptions(CONFIG.PF2E.actionTypes),this.filterData.checkboxes.category.options=this.generateCheckboxOptions(t$3(CONFIG.PF2E.actionCategories,["familiar"])),this.filterData.source.options=this.generateSourceCheckboxOptions(publications),console.debug("PF2e System | Compendium Browser | Finished loading actions")}filterIndexData(entry){const{checkboxes,source:source2,traits}=this.filterData;return!(checkboxes.types.selected.length&&!checkboxes.types.selected.includes(entry.actionType)||checkboxes.category.selected.length&&!checkboxes.category.selected.includes(entry.category)||!this.filterTraits(entry.traits,traits.selected,traits.conjunction)||source2.selected.length&&!source2.selected.includes(entry.source))}prepareFilterData(){return{checkboxes:{types:{isExpanded:!0,label:"PF2E.ActionActionTypeLabel",options:{},selected:[]},category:{isExpanded:!0,label:"PF2E.CompendiumBrowser.Filter.Categories",options:{},selected:[]}},source:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Source",options:{},selected:[]},traits:{conjunction:"and",options:[],selected:[]},order:{by:"name",direction:"asc",options:{name:{label:"Name",type:"alpha"}},type:"alpha"},search:{text:""}}}}class CompendiumBrowserBestiaryTab extends CompendiumBrowserTab{static{__name(this,"CompendiumBrowserBestiaryTab")}static{__name2(this,"CompendiumBrowserBestiaryTab")}tabName="bestiary";tabLabel="PF2E.CompendiumBrowser.TabBestiary";index=["img","system.details.level.value","system.details.publication.title","system.details.source.value","system.traits"];searchFields=["name","originalName"];storeFields=["type","name","img","uuid","level","actorSize","traits","rarity","source"];constructor(browser){super(browser),this.filterData=this.prepareFilterData()}get isGMOnly(){return!0}async loadData(){const bestiaryActors=[],publications=new Set,indexFields=[...this.index];for await(const{pack,index:index2}of this.browser.packLoader.loadPacks("Actor",this.browser.loadedPacks("bestiary"),indexFields)){console.debug(`PF2e System | Compendium Browser | ${pack.metadata.label} - ${index2.size} entries found`);for(const actorData of index2.filter(d=>d.type==="npc")){if(!this.hasAllIndexFields(actorData,this.index)){console.warn(`Actor '${actorData.name}' does not have all required data fields. Consider unselecting pack '${pack.metadata.label}' in the compendium browser settings.`);continue}const{details}=actorData.system,pubSource=String(details.publication?.title??details.source?.value??"").trim(),sourceSlug=sluggify(pubSource);pubSource&&publications.add(pubSource),bestiaryActors.push({type:actorData.type,name:actorData.name,originalName:actorData.originalName,img:actorData.img,uuid:actorData.uuid,level:actorData.system.details.level.value,actorSize:actorData.system.traits.size.value,traits:actorData.system.traits.value.map(t2=>t2.replace(/^hb_/,"")),rarity:actorData.system.traits.rarity,source:sourceSlug})}console.debug(`PF2e System | Compendium Browser | ${pack.metadata.label} - Loaded`)}this.indexData=bestiaryActors,this.filterData.checkboxes.sizes.options=this.generateCheckboxOptions(CONFIG.PF2E.actorSizes),this.filterData.traits.options=this.generateMultiselectOptions(CONFIG.PF2E.creatureTraits),this.filterData.checkboxes.rarity.options=this.generateCheckboxOptions(CONFIG.PF2E.rarityTraits,!1),this.filterData.source.options=this.generateSourceCheckboxOptions(publications),console.debug("PF2e System | Compendium Browser | Finished loading Bestiary actors")}filterIndexData(entry){const{checkboxes,source:source2,traits,level}=this.filterData;return!(!(entry.level>=level.from&&entry.level<=level.to)||checkboxes.sizes.selected.length&&!checkboxes.sizes.selected.includes(entry.actorSize)||!this.filterTraits(entry.traits,traits.selected,traits.conjunction)||source2.selected.length&&!source2.selected.includes(entry.source)||checkboxes.rarity.selected.length&&!checkboxes.rarity.selected.includes(entry.rarity))}prepareFilterData(){return{checkboxes:{sizes:{isExpanded:!0,label:"PF2E.CompendiumBrowser.Filter.Sizes",options:{},selected:[]},rarity:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Rarities",options:{},selected:[]}},source:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Source",options:{},selected:[]},traits:{conjunction:"and",options:[],selected:[]},order:{by:"level",direction:"asc",options:{name:{label:"Name",type:"alpha"},level:{label:"PF2E.LevelLabel",type:"numeric"}},type:"numeric"},level:{changed:!1,isExpanded:!1,min:-1,max:25,from:-1,to:25},search:{text:""}}}}class CompendiumBrowserCampaignFeaturesTab extends CompendiumBrowserTab{static{__name(this,"CompendiumBrowserCampaignFeaturesTab")}static{__name2(this,"CompendiumBrowserCampaignFeaturesTab")}tabName="campaignFeature";tabLabel="PF2E.CompendiumBrowser.TabCampaign";searchFields=["name","originalName"];storeFields=["type","name","img","uuid","level","category","traits","source"];constructor(browser){super(browser),this.filterData=this.prepareFilterData()}async loadData(){console.debug("PF2e System | Compendium Browser | Started loading feats");const feats=[],publications=new Set,indexFields=["img","system.actionType.value","system.actions.value","system.category","system.level.value","system.prerequisites.value","system.traits","system.publication","system.source"];for await(const{pack,index:index2}of this.browser.packLoader.loadPacks("Item",this.browser.loadedPacks("campaignFeature"),indexFields)){console.debug(`PF2e System | Compendium Browser | ${pack.metadata.label} - ${index2.size} entries found`);for(const featData of index2.filter(i=>i.type==="campaignFeature")){featData.filters={};const{system:system2}=featData,pubSource=String(system2.publication?.title??system2.source?.value??"").trim(),sourceSlug=sluggify(pubSource);pubSource&&publications.add(pubSource),feats.push({type:featData.type,name:featData.name,originalName:featData.originalName,img:featData.img,uuid:featData.uuid,level:featData.system.level?.value,category:featData.system.category,traits:featData.system.traits.value.map(t2=>t2.replace(/^hb_/,"")),rarity:featData.system.traits.rarity,source:sourceSlug})}}this.indexData=feats,this.filterData.checkboxes.category.options=this.generateCheckboxOptions(KINGMAKER_CATEGORIES),this.filterData.checkboxes.rarity.options=this.generateCheckboxOptions(CONFIG.PF2E.rarityTraits),this.filterData.source.options=this.generateSourceCheckboxOptions(publications),this.filterData.traits.options=this.generateMultiselectOptions(CONFIG.PF2E.kingmakerTraits),console.debug("PF2e System | Compendium Browser | Finished loading feats")}filterIndexData(entry){const{checkboxes,source:source2,traits,level}=this.filterData,entryLevel=entry.level??0;return!(!(entryLevel>=level.from&&entryLevel<=level.to)||checkboxes.category.selected.length&&!checkboxes.category.selected.includes(entry.category)||!this.filterTraits(entry.traits,traits.selected,traits.conjunction)||source2.selected.length&&!source2.selected.includes(entry.source)||checkboxes.rarity.selected.length&&!checkboxes.rarity.selected.includes(entry.rarity))}prepareFilterData(){return{checkboxes:{category:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Categories",options:{},selected:[]},rarity:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Rarities",options:{},selected:[]}},source:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Source",options:{},selected:[]},traits:{conjunction:"and",options:[],selected:[]},order:{by:"level",direction:"asc",options:{name:{label:"Name",type:"alpha"},level:{label:"PF2E.LevelLabel",type:"numeric"}},type:"numeric"},level:{changed:!1,isExpanded:!1,min:0,max:20,from:0,to:20},search:{text:""}}}}class CompendiumBrowserEquipmentTab extends CompendiumBrowserTab{static{__name(this,"CompendiumBrowserEquipmentTab")}static{__name2(this,"CompendiumBrowserEquipmentTab")}tabName="equipment";tabLabel="PF2E.CompendiumBrowser.TabEquipment";searchFields=["name","originalName"];storeFields=["type","name","img","uuid","level","category","group","price","priceInCopper","traits","rarity","source"];constructor(browser){super(browser),this.filterData=this.prepareFilterData()}async loadData(){console.debug("PF2e System | Compendium Browser | Started loading inventory items");const inventoryItems=[],itemTypes=[...PHYSICAL_ITEM_TYPES,"kit"],baseFields=["img","system.price","system.traits","system.publication","system.source"],physicalItemFields=[...baseFields,"system.level.value"],runedItemFields=[...physicalItemFields,"system.runes"],armorAndWeaponFields=[...runedItemFields,"system.category","system.group"],indexFields=n([...armorAndWeaponFields]).sort(),publications=new Set;for await(const{pack,index:index2}of this.browser.packLoader.loadPacks("Item",this.browser.loadedPacks("equipment"),indexFields)){console.debug(`PF2e System | Compendium Browser | ${pack.metadata.label} - ${index2.size} entries found`);for(const itemData of index2)if(!(itemData.type==="treasure"&&itemData.system.category==="coin")&&itemTypes.includes(itemData.type)){if((()=>{switch(itemData.type){case"armor":case"weapon":return!this.hasAllIndexFields(itemData,armorAndWeaponFields);case"kit":return!this.hasAllIndexFields(itemData,baseFields);case"shield":return!this.hasAllIndexFields(itemData,runedItemFields);default:return!this.hasAllIndexFields(itemData,physicalItemFields)}})()){console.warn(`Item '${itemData.name}' does not have all required data fields. Consider unselecting pack '${pack.metadata.label}' in the compendium browser settings.`);continue}const priceValue=itemData.system.price.value,priceCoins=typeof priceValue=="string"?Coins.fromString(priceValue):new Coins(priceValue),coinValue=priceCoins.copperValue,{system:system2}=itemData,pubSource=String(system2.publication?.title??system2.source?.value??"").trim(),sourceSlug=sluggify(pubSource);pubSource&&publications.add(pubSource);const traits=itemData.system.traits.value??[],runes=itemData.system.runes,traditionTraits=MAGIC_TRADITIONS;!traits.some(t2=>traditionTraits.has(t2))&&["armor","shield","weapon"].includes(itemData.type)&&(runes.potency||runes.reinforcing||runes.resilient||runes.striking)&&traits.push("magical"),inventoryItems.push({type:itemData.type,name:itemData.name,originalName:itemData.originalName,img:itemData.img,uuid:itemData.uuid,level:itemData.system.level?.value??0,category:itemData.system.category??"",group:itemData.system.group??"",price:priceCoins,priceInCopper:coinValue,traits:n(itemData.system.traits.value),rarity:itemData.system.traits.rarity,source:sourceSlug})}}this.indexData=inventoryItems,this.filterData.checkboxes.armorTypes.options=this.generateCheckboxOptions(CONFIG.PF2E.armorCategories),foundry.utils.mergeObject(this.filterData.checkboxes.armorTypes.options,this.generateCheckboxOptions(CONFIG.PF2E.armorGroups)),this.filterData.checkboxes.weaponTypes.options=this.generateCheckboxOptions(CONFIG.PF2E.weaponCategories),foundry.utils.mergeObject(this.filterData.checkboxes.weaponTypes.options,this.generateCheckboxOptions(CONFIG.PF2E.weaponGroups)),this.filterData.traits.options=this.generateMultiselectOptions({...CONFIG.PF2E.armorTraits,...CONFIG.PF2E.consumableTraits,...CONFIG.PF2E.equipmentTraits,...CONFIG.PF2E.shieldTraits,...CONFIG.PF2E.weaponTraits}),this.filterData.checkboxes.itemTypes.options=this.generateCheckboxOptions({ammo:"TYPES.Item.ammo",weapon:"TYPES.Item.weapon",shield:"TYPES.Item.shield",armor:"TYPES.Item.armor",equipment:"TYPES.Item.equipment",consumable:"TYPES.Item.consumable",treasure:"TYPES.Item.treasure",backpack:"TYPES.Item.backpack",kit:"TYPES.Item.kit"}),this.filterData.checkboxes.rarity.options=this.generateCheckboxOptions(CONFIG.PF2E.rarityTraits,!1),this.filterData.source.options=this.generateSourceCheckboxOptions(publications),console.debug("PF2e System | Compendium Browser | Finished loading inventory items")}filterIndexData(entry){const{checkboxes,source:source2,traits,ranges,level}=this.filterData;return!(!(entry.level>=level.from&&entry.level<=level.to)||!(entry.priceInCopper>=ranges.price.values.min&&entry.priceInCopper<=ranges.price.values.max)||checkboxes.itemTypes.selected.length>0&&!checkboxes.itemTypes.selected.includes(entry.type)||checkboxes.armorTypes.selected.length>0&&!this.arrayIncludes(checkboxes.armorTypes.selected,[entry.category,entry.group])||checkboxes.weaponTypes.selected.length>0&&!this.arrayIncludes(checkboxes.weaponTypes.selected,[entry.category,entry.group])||!this.filterTraits(entry.traits,traits.selected,traits.conjunction)||source2.selected.length>0&&!source2.selected.includes(entry.source)||checkboxes.rarity.selected.length>0&&!checkboxes.rarity.selected.includes(entry.rarity))}parseRangeFilterInput(name2,lower,upper){if(name2==="price"){const minCoins=Coins.fromString(lower),maxCoins=Coins.fromString(upper);return{min:minCoins.copperValue,max:maxCoins.copperValue,inputMin:minCoins.toString({short:!0,unit:"raw"}),inputMax:maxCoins.toString({short:!0,unit:"raw"})}}return super.parseRangeFilterInput(name2,lower,upper)}prepareFilterData(){const defaultMinPrice=new Coins({cp:0}),defaultMaxPrice=new Coins({gp:2e5}),minPriceString=defaultMinPrice.toString({short:!0,unit:"raw"}),maxPriceString=defaultMaxPrice.toString({short:!0,unit:"raw"});return{checkboxes:{itemTypes:{isExpanded:!0,label:"PF2E.CompendiumBrowser.Filter.InventoryTypes",options:{},selected:[]},rarity:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Rarities",options:{},selected:[]},armorTypes:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.ArmorFilters",options:{},selected:[]},weaponTypes:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.WeaponFilters",options:{},selected:[]}},traits:{conjunction:"and",options:[],selected:[]},source:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Source",options:{},selected:[]},order:{by:"level",direction:"asc",options:{name:{label:"Name",type:"alpha"},level:{label:"PF2E.LevelLabel",type:"numeric"},price:{label:"PF2E.PriceLabel",type:"numeric"}},type:"numeric"},ranges:{price:{changed:!1,defaultMin:minPriceString,defaultMax:maxPriceString,isExpanded:!1,label:"PF2E.PriceLabel",values:{min:defaultMinPrice.copperValue,max:defaultMaxPrice.copperValue,inputMin:minPriceString,inputMax:maxPriceString}}},level:{changed:!1,isExpanded:!1,min:0,max:30,from:0,to:30},search:{text:""}}}}class CompendiumBrowserFeatTab extends CompendiumBrowserTab{static{__name(this,"CompendiumBrowserFeatTab")}static{__name2(this,"CompendiumBrowserFeatTab")}tabName="feat";tabLabel="PF2E.CompendiumBrowser.TabFeat";searchFields=["name","originalName"];storeFields=["type","name","img","uuid","level","category","skills","traits","rarity","source"];#creatureTraits=CONFIG.PF2E.creatureTraits;constructor(browser){super(browser),this.filterData=this.prepareFilterData()}async loadData(){console.debug("PF2e System | Compendium Browser | Started loading feats");const feats=[],publications=new Set,indexFields=["img","system.actionType.value","system.actions.value","system.category","system.level.value","system.prerequisites.value","system.traits","system.publication","system.source"];for await(const{pack,index:index2}of this.browser.packLoader.loadPacks("Item",this.browser.loadedPacks("feat"),indexFields)){console.debug(`PF2e System | Compendium Browser | ${pack.metadata.label} - ${index2.size} entries found`);for(const featData of index2)if(featData.type==="feat"){featData.filters={};const categoryPaths=["system.category","system.featType.value"],nonCategoryPaths=indexFields.filter(f=>!categoryPaths.includes(f)),categoryPathFound=categoryPaths.some(p=>foundry.utils.hasProperty(featData,p));if(!this.hasAllIndexFields(featData,nonCategoryPaths)||!categoryPathFound){console.warn(`Feat "${featData.name}" does not have all required data fields.`,`Consider unselecting pack "${pack.metadata.label}" in the compendium browser settings.`);continue}const featType=featData.system.featType;e$2(featType)&&"value"in featType&&typeof featType.value=="string"&&(featData.system.category=featType.value,delete featData.system.featType);const prerequisitesArr=featData.system.prerequisites.value.map(prerequisite=>prerequisite?.value?prerequisite.value.toLowerCase():""),skills=new Set;for(const prereq of prerequisitesArr)for(const[key,value]of Object.entries(CONFIG.PF2E.skills)){const translated=game.i18n.localize(value.label).toLocaleLowerCase(game.i18n.lang);(prereq.includes(key)||prereq.includes(translated))&&skills.add(key)}const pubSource=featData.system.publication?.title??featData.system.source?.value??"",sourceSlug=sluggify(pubSource);pubSource&&publications.add(pubSource),feats.push({type:featData.type,name:featData.name,originalName:featData.originalName,img:featData.img,uuid:featData.uuid,level:featData.system.level.value,category:featData.system.category,skills:[...skills],traits:featData.system.traits.value.map(t2=>t2.replace(/^hb_/,"")),rarity:featData.system.traits.rarity,source:sourceSlug})}}this.indexData=feats,this.filterData.checkboxes.category.options=this.generateCheckboxOptions(CONFIG.PF2E.featCategories),this.filterData.checkboxes.skills.options=this.generateCheckboxOptions(CONFIG.PF2E.skills),this.filterData.checkboxes.rarity.options=this.generateCheckboxOptions(CONFIG.PF2E.rarityTraits),this.filterData.source.options=this.generateSourceCheckboxOptions(publications),this.filterData.traits.options=this.generateMultiselectOptions(CONFIG.PF2E.featTraits),console.debug("PF2e System | Compendium Browser | Finished loading feats")}filterTraits(traits,selected,condition){if(this.filterData.checkboxes.category.selected.includes("ancestry")&&!traits.some(t2=>t2 in this.#creatureTraits)){const withoutAncestryTraits=selected.filter(t2=>!(t2.value in this.#creatureTraits));return super.filterTraits(traits,withoutAncestryTraits,condition)}return super.filterTraits(traits,selected,condition)}filterIndexData(entry){const{checkboxes,source:source2,traits,level}=this.filterData;return!(!(entry.level>=level.from&&entry.level<=level.to)||checkboxes.category.selected.length&&!checkboxes.category.selected.includes(entry.category)||checkboxes.skills.selected.length&&!this.arrayIncludes(checkboxes.skills.selected,entry.skills)||!this.filterTraits(entry.traits,traits.selected,traits.conjunction)||source2.selected.length&&!source2.selected.includes(entry.source)||checkboxes.rarity.selected.length&&!checkboxes.rarity.selected.includes(entry.rarity))}prepareFilterData(){return{checkboxes:{category:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Categories",options:{},selected:[]},skills:{isExpanded:!1,label:"PF2E.SkillsLabel",options:{},selected:[]},rarity:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Rarities",options:{},selected:[]}},source:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Source",options:{},selected:[]},traits:{conjunction:"and",options:[],selected:[]},order:{by:"level",direction:"asc",options:{name:{label:"Name",type:"alpha"},level:{label:"PF2E.LevelLabel",type:"numeric"}},type:"numeric"},level:{changed:!1,isExpanded:!1,min:0,max:20,from:0,to:20},search:{text:""}}}}class CompendiumBrowserHazardTab extends CompendiumBrowserTab{static{__name(this,"CompendiumBrowserHazardTab")}static{__name2(this,"CompendiumBrowserHazardTab")}tabName="hazard";tabLabel="PF2E.CompendiumBrowser.TabHazard";searchFields=["name","originalName"];storeFields=["type","name","img","uuid","level","complexity","traits","rarity","source"];index=["img","system.details.level.value","system.details.isComplex","system.traits"];constructor(browser){super(browser),this.filterData=this.prepareFilterData()}get isGMOnly(){return!0}async loadData(){console.debug("PF2e System | Compendium Browser | Started loading Hazard actors");const hazardActors=[],publications=new Set,indexFields=[...this.index,"system.details.publication","system.details.source"];for await(const{pack,index:index2}of this.browser.packLoader.loadPacks("Actor",this.browser.loadedPacks("hazard"),indexFields)){console.debug(`PF2e System | Compendium Browser | ${pack.metadata.label} - ${index2.size} entries found`);for(const actorData of index2.filter(d=>d.type==="hazard")){if(!this.hasAllIndexFields(actorData,this.index)){console.warn(`Hazard '${actorData.name}' does not have all required data fields. Consider unselecting pack '${pack.metadata.label}' in the compendium browser settings.`);continue}const{details}=actorData.system,pubSource=String(details.publication?.title??details.source?.value??"").trim(),sourceSlug=sluggify(pubSource);pubSource&&publications.add(pubSource),hazardActors.push({type:actorData.type,name:actorData.name,originalName:actorData.originalName,img:actorData.img,uuid:actorData.uuid,level:actorData.system.details.level.value,complexity:actorData.system.details.isComplex?"complex":"simple",traits:actorData.system.traits.value,rarity:actorData.system.traits.rarity,source:sourceSlug})}console.debug(`PF2e System | Compendium Browser | ${pack.metadata.label} - Loaded`)}this.indexData=hazardActors,this.filterData.checkboxes.complexity.options=this.generateCheckboxOptions({simple:"PF2E.Actor.Hazard.Simple",complex:"PF2E.TraitComplex"},!1),this.filterData.traits.options=this.generateMultiselectOptions(CONFIG.PF2E.hazardTraits),this.filterData.checkboxes.rarity.options=this.generateCheckboxOptions(CONFIG.PF2E.rarityTraits,!1),this.filterData.source.options=this.generateSourceCheckboxOptions(publications),console.debug("PF2e System | Compendium Browser | Finished loading Hazard actors")}filterIndexData(entry){const{checkboxes,source:source2,traits,level}=this.filterData;return!(!(entry.level>=level.from&&entry.level<=level.to)||checkboxes.complexity.selected.length&&!checkboxes.complexity.selected.includes(entry.complexity)||!this.filterTraits(entry.traits,traits.selected,traits.conjunction)||source2.selected.length&&!source2.selected.includes(entry.source)||checkboxes.rarity.selected.length&&!checkboxes.rarity.selected.includes(entry.rarity))}prepareFilterData(){return{checkboxes:{complexity:{isExpanded:!0,label:"PF2E.CompendiumBrowser.Filter.Complexity",options:{},selected:[]},rarity:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Rarities",options:{},selected:[]}},source:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Source",options:{},selected:[]},traits:{conjunction:"and",options:[],selected:[]},order:{by:"level",direction:"asc",options:{name:{label:"Name",type:"alpha"},level:{label:"PF2E.LevelLabel",type:"numeric"}},type:"numeric"},level:{changed:!1,isExpanded:!1,min:-1,max:25,from:-1,to:25},search:{text:""}}}}class CompendiumBrowserSpellTab extends CompendiumBrowserTab{static{__name(this,"CompendiumBrowserSpellTab")}static{__name2(this,"CompendiumBrowserSpellTab")}tabName="spell";tabLabel="PF2E.CompendiumBrowser.TabSpell";searchFields=["name","originalName"];storeFields=["type","name","img","uuid","rank","time","traditions","traits","categories","rarity","source"];constructor(browser){super(browser),this.filterData=this.prepareFilterData()}async loadData(){console.debug("PF2e System | Compendium Browser | Started loading spells");const spells=[],times=new Set,publications=new Set,indexFields=["img","system.level.value","system.time","system.traits","system.publication","system.ritual","system.source"],data=this.browser.packLoader.loadPacks("Item",this.browser.loadedPacks("spell"),indexFields);for await(const{pack,index:index2}of data){console.debug(`PF2e System | Compendium Browser | ${pack.metadata.label} - ${index2.size} entries found`);for(const spellData of index2)if(spellData.filters={},spellData.type==="spell"){if("system"in spellData&&e$2(spellData.system)&&(spellData.system.ritual??=null),!this.hasAllIndexFields(spellData,indexFields)){console.warn(`Item '${spellData.name}' does not have all required data fields. Consider unselecting pack '${pack.metadata.label}' in the compendium browser settings.`);continue}const isCantrip=spellData.system.traits.value.includes("cantrip"),isFocusSpell=spellData.system.traits.value.includes("focus")||isCantrip&&(spellData.system.traits.traditions??[]).length===0,isRitual=!!spellData.system.ritual,categories=[!isCantrip&&!isFocusSpell&&!isRitual?"spell":null,isCantrip?"cantrip":null,isFocusSpell?"focus":null,isRitual?"ritual":null].filter(e$1),actionGlyph=getActionGlyph(spellData.system.time.value),time=spellData.system.time.value;if(time&&typeof time=="string"){const normalizedTime=time.toLocaleLowerCase("en").includes("reaction")?"reaction":sluggify(time);times.add(normalizedTime),spellData.system.time.value=normalizedTime}const{system:system2}=spellData,pubSource=String(system2.publication?.title??system2.source?.value??"").trim(),sourceSlug=sluggify(pubSource);pubSource&&publications.add(pubSource),spells.push({type:spellData.type,name:spellData.name,originalName:spellData.originalName,img:spellData.img,uuid:spellData.uuid,rank:spellData.system.level.value,categories,time:spellData.system.time,actionGlyph,traditions:spellData.system.traits.traditions,traits:spellData.system.traits.value.map(t2=>t2.replace(/^hb_/,"")),rarity:spellData.system.traits.rarity,source:sourceSlug})}}this.indexData=spells,this.filterData.checkboxes.traditions.options=this.generateCheckboxOptions(CONFIG.PF2E.magicTraditions);for(let rank=1;rank<=10;rank++)this.filterData.checkboxes.rank.options[rank]={label:game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:ordinalString(rank)}),selected:!1};this.filterData.checkboxes.rarity.options=this.generateCheckboxOptions(CONFIG.PF2E.rarityTraits,!1),this.filterData.traits.options=this.generateMultiselectOptions(n$1(CONFIG.PF2E.spellTraits,Array.from(MAGIC_TRADITIONS))),this.filterData.source.options=this.generateSourceCheckboxOptions(publications),this.filterData.checkboxes.category.options=this.generateCheckboxOptions({spell:"TYPES.Item.spell",cantrip:"PF2E.TraitCantrip",focus:"PF2E.TraitFocus",ritual:"PF2E.Item.Spell.Ritual.Label"},!1),this.filterData.selects.timefilter.options=[...times].sort().reduce((result,time)=>({...result,[sluggify(time)]:time}),{}),console.debug("PF2e System | Compendium Browser | Finished loading spells")}filterIndexData(indexData){const{checkboxes,source:source2,traits,selects}=this.filterData;return!(checkboxes.rank.selected.length>0&&!checkboxes.rank.selected.map(r2=>Number(r2)).includes(indexData.rank)||checkboxes.category.selected.length>0&&!t$k([...checkboxes.category.selected].sort(),indexData.categories.sort())||selects.timefilter.selected&&selects.timefilter.selected!==indexData.time.value||checkboxes.traditions.selected.length>0&&r$1(checkboxes.traditions.selected,indexData.traditions).length===0||!this.filterTraits(indexData.traits,traits.selected,traits.conjunction)||checkboxes.rarity.selected.length>0&&!checkboxes.rarity.selected.includes(indexData.rarity)||source2.selected.length>0&&!source2.selected.includes(indexData.source))}prepareFilterData(){return{checkboxes:{category:{isExpanded:!0,label:"PF2E.CompendiumBrowser.Filter.Categories",options:{},selected:[]},traditions:{isExpanded:!0,label:"PF2E.CompendiumBrowser.Filter.Traditions",options:{},selected:[]},rank:{isExpanded:!0,label:"PF2E.Item.Spell.Rank.Plural",options:{},selected:[]},rarity:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Rarities",options:{},selected:[]}},source:{isExpanded:!1,label:"PF2E.CompendiumBrowser.Filter.Source",options:{},selected:[]},traits:{conjunction:"and",options:[],selected:[]},selects:{timefilter:{label:"PF2E.CompendiumBrowser.Filter.CastingTime",options:{},selected:""}},order:{by:"rank",direction:"asc",options:{name:{label:"Name",type:"alpha"},rank:{label:"PF2E.Item.Spell.Rank.Label",type:"numeric"}},type:"numeric"},search:{text:""}}}}class CompendiumBrowser extends SvelteApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"CompendiumBrowser")}static{__name2(this,"CompendiumBrowser")}static RESULT_LIMIT=100;root=App;activeTab;dataTabsList=["action","bestiary","campaignFeature","equipment","feat","hazard","spell"];packLoader=new PackLoader;tabs;tabsArray;constructor(options={}){super(options),this.tabs={action:new CompendiumBrowserActionTab(this),bestiary:new CompendiumBrowserBestiaryTab(this),campaignFeature:new CompendiumBrowserCampaignFeaturesTab(this),equipment:new CompendiumBrowserEquipmentTab(this),feat:new CompendiumBrowserFeatTab(this),hazard:new CompendiumBrowserHazardTab(this),spell:new CompendiumBrowserSpellTab(this)},this.tabsArray=t$8(this.tabs),this.activeTab=this.tabs.action,this.initCompendiumList()}static DEFAULT_OPTIONS={id:"compendium-browser",classes:["compendium-browser"],position:{width:800,height:700},window:{icon:"fa-solid fa-atlas",controls:[{action:"openSettings",icon:"fa-solid fa-gears",label:"PF2E.CompendiumBrowser.Settings.OpenSettings"},{action:"addToRollTable",icon:"fa-solid fa-list",label:"PF2E.CompendiumBrowser.RollTable.AddLabel"},{action:"createRollTable",icon:"fa-solid fa-list",label:"PF2E.CompendiumBrowser.RollTable.CreateLabel"}],resizable:!0,title:"PF2E.CompendiumBrowser.Title"},actions:{addToRollTable:__name2(function(){this.activeTab&&(this.toggleControls(!1),this.activeTab.addToRollTable())},"addToRollTable"),createRollTable:__name2(function(){this.activeTab&&(this.toggleControls(!1),this.activeTab.createRollTable())},"createRollTable"),openSettings:__name2(function(){this.toggleControls(!1),new CompendiumBrowserSettingsApp().render({force:!0})},"openSettings")}};async _onFirstRender(context,options){await super._onFirstRender(context,options),this.#setVisibleTabs()}_onClose(options){super._onClose(options);for(const tab of this.tabsArray)tab.filterData.search.text=""}_getHeaderControls(){const controls=super._getHeaderControls(),gmControls=["addToRollTable","createRollTable","openSettings"];for(const control of controls)!game.user.isGM&&gmControls.includes(control.action)&&(control.visible=!1);return controls}async _prepareContext(_options){return{state:{activeTabName:"",resultList:document.createElement("ul")}}}#setVisibleTabs(visible){const isGM=game.user.isGM,showCampaign=game.settings.get("pf2e","campaignType")!=="none";for(const tab of this.tabsArray)tab.visible=visible?visible.includes(tab.tabName):!0,!showCampaign&&tab.tabName==="campaignFeature"&&(tab.visible=!1),tab.isGMOnly&&!isGM&&(tab.visible=!1)}resetListElement(){untrack(()=>this.activeTab.resultLimit=CompendiumBrowser.RESULT_LIMIT),this.$state.resultList?.scrollTo({top:0,behavior:"instant"})}async openTab(tabName,options){if(!this.dataTabsList.includes(tabName))throw ErrorPF2e(`Unknown tab "${tabName}"`);if(this.activeTab=this.tabs[tabName],this.activeTab.isGMOnly&&!game.user.isGM)throw ErrorPF2e("Tried to open GM-only browser tab!");if(options?.filter){if(!this.activeTab.isInitialized)throw ErrorPF2e("Tried to pass filter data to an uninitialized tab!");this.activeTab.filterData=options.filter}if(await this.activeTab.init(),this.rendered||await this.render({force:!0}),options?.hideNavigation)this.#setVisibleTabs([]);else if(options?.showTabs){if(!options.showTabs.every(t2=>this.dataTabsList.includes(t2)))throw ErrorPF2e(`Unknown tab name in "${options.showTabs}"`);options.showTabs.includes(tabName)||options.showTabs.push(tabName),this.#setVisibleTabs(options.showTabs)}else this.#setVisibleTabs();this.$state.activeTabName=tabName,this.bringToFront()}async openActionTab(options){const actionTab=this.tabs.action,filter=await actionTab.getFilterData(),types=filter.checkboxes.types,traits=filter.traits;types.selected=[];for(const type2 in types.options)options.types?.includes(type2)&&(types.options[type2].selected=!0,types.selected.push(type2));const traitFilters=options.traits??[];if(traits.selected=traitFilters.length?traits.options.filter(trait=>traitFilters.includes(trait.value)):[],options.categories?.length){const optionsToSwitch=t$3(filter.checkboxes.category.options,options.categories);Object.values(optionsToSwitch).forEach(o=>o.selected=!0),filter.checkboxes.category.selected=Object.keys(optionsToSwitch)}actionTab.open({filter})}async openSpellTab(entry,maxRank=10,category=null){const spellTab=this.tabs.spell,filter=await spellTab.getFilterData(),traditions=filter.checkboxes.traditions;if(category&&filter.checkboxes.category.options[category]&&(filter.checkboxes.category.options[category].selected=!0,filter.checkboxes.category.selected.push(category)),(entry.category==="ritual"||entry.isFocusPool)&&(filter.checkboxes.category.options[entry.category].selected=!0,filter.checkboxes.category.selected.push(entry.category)),maxRank){const ranks=Array.from(Array(maxRank).keys()).map(l=>String(l+1));for(const rank of ranks)filter.checkboxes.rank.options[rank].selected=!0,filter.checkboxes.rank.selected.push(rank);["prepared","spontaneous","innate"].includes(entry.category)&&!category&&(filter.checkboxes.category.options.spell.selected=!0,filter.checkboxes.category.selected.push("spell"))}entry.tradition&&!entry.isFocusPool&&entry.category!=="ritual"&&(traditions.options[entry.tradition].selected=!0,traditions.selected.push(entry.tradition)),spellTab.open({filter})}initCompendiumList(){const settings={action:{},bestiary:{},campaignFeature:{},hazard:{},equipment:{},feat:{},spell:{}},browsableTypes=new Set(["action","campaignFeature","feat","kit","hazard","npc","spell",...PHYSICAL_ITEM_TYPES]),typeToTab=new Map([["action","action"],["campaignFeature","campaignFeature"],["feat","feat"],["kit","equipment"],["hazard","hazard"],["npc","bestiary"],["spell","spell"],...Array.from(PHYSICAL_ITEM_TYPES).map(t2=>[t2,"equipment"])]),userSettings=game.settings.get("pf2e","compendiumBrowserPacks");for(const pack of game.packs){if(!pack.testUserPermission(game.user,"LIMITED"))continue;const tabNames=n(n(pack.index.map(entry=>entry.type)).filter(t2=>setHasElement(browsableTypes,t2)).flatMap(t2=>typeToTab.get(t2)??[]));for(const tabName of tabNames)settings[tabName][pack.collection]={load:userSettings[tabName]?.[pack.collection]?.load!==!1,name:pack.metadata.label,package:pack.metadata.packageName}}for(const tab of this.dataTabsList)settings[tab]=Object.fromEntries(Object.entries(settings[tab]).sort(([_collectionA,dataA],[_collectionB,dataB])=>dataA?.name.localeCompare(dataB?.name??"",game.i18n.lang)??1));this.settings=settings}loadedPacks(tab){return Object.entries(this.settings[tab]??[]).flatMap(([collection,info])=>info?.load?[collection]:[])}loadedPacksAll(){return n(this.dataTabsList.flatMap(t2=>this.loadedPacks(t2))).sort()}async resetInitializedTabs(){for(const tab of this.tabsArray)tab.isInitialized&&await tab.init(!0);this.$state.activeTabName=""}}class EffectsPanel extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"EffectsPanel")}static{__name2(this,"EffectsPanel")}get#token(){return canvas.tokens.controlled.at(0)?.document??null}get#actor(){return this.#token?.actor??game.user?.character??null}refresh=foundry.utils.debounce(this.render.bind(this),100);static DEFAULT_OPTIONS={id:"effects-panel",tag:"article",window:{frame:!1,positioned:!1},actions:{handleClick:{handler:this.#onClickHandleClick,buttons:[0,2]}}};static PARTS={main:{template:"systems/pf2e/templates/system/effects/panel.hbs",scrollable:[""],root:!0}};static async#onClickHandleClick(event2,effectEl){const actor=this.#actor,itemId=effectEl.dataset.itemId??"",effect=actor?.conditions.get(itemId)??actor?.items.get(itemId);event2.button===0?actor&&effect?.isOfType("condition")&&effect.slug==="persistent-damage"?await effect.onEndTurn({token:this.#token}):effect instanceof AbstractEffectPF2e&&await effect.increase():event2.button===2&&(effect instanceof AbstractEffectPF2e?await effect.decrease():this.refresh())}async _prepareContext(){const actor=this.#actor;return!actor||!game.user.settings.showEffectPanel?{afflictions:[],conditions:[],effects:[],actor:null,user:{isGM:!1}}:{afflictions:await this.#getViewData(actor.itemTypes.affliction??[]),conditions:await this.#getViewData(actor.conditions.active),effects:await this.#getViewData(actor.itemTypes.effect),actor,user:{isGM:game.user.isGM}}}#getRemainingDurationLabel(effect){const system2=effect.system;if(effect.totalDuration===1/0)return system2.duration.unit==="encounter"?system2.expired?game.i18n.localize("PF2E.EffectPanel.Expired"):game.i18n.localize("PF2E.EffectPanel.UntilEncounterEnds"):game.i18n.localize("PF2E.EffectPanel.UnlimitedDuration");if(system2.expired)return game.i18n.localize("PF2E.EffectPanel.Expired");const remaining=effect.remainingDuration.remaining,initiative=system2.start.initiative??0,expiry=system2.duration.expiry;if(remaining>=63072e3)return game.i18n.format("PF2E.EffectPanel.RemainingDuration.MultipleYears",{years:Math.floor(remaining/31536e3)});if(remaining>=31536e3)return game.i18n.localize("PF2E.EffectPanel.RemainingDuration.SingleYear");if(remaining>=1209600)return game.i18n.format("PF2E.EffectPanel.RemainingDuration.MultipleWeeks",{weeks:Math.floor(remaining/604800)});if(remaining>604800)return game.i18n.localize("PF2E.EffectPanel.RemainingDuration.SingleWeek");if(remaining>=172800)return game.i18n.format("PF2E.EffectPanel.RemainingDuration.MultipleDays",{days:Math.floor(remaining/86400)});if(remaining>7200)return game.i18n.format("PF2E.EffectPanel.RemainingDuration.MultipleHours",{hours:Math.floor(remaining/3600)});if(remaining>120)return game.i18n.format("PF2E.EffectPanel.RemainingDuration.MultipleMinutes",{minutes:Math.floor(remaining/60)});if(remaining>=12)return game.i18n.format("PF2E.EffectPanel.RemainingDuration.MultipleRounds",{rounds:Math.floor(remaining/6)});if(remaining>=6)return game.i18n.localize("PF2E.EffectPanel.RemainingDuration.SingleRound");if(remaining>=2)return game.i18n.format("PF2E.EffectPanel.RemainingDuration.MultipleSeconds",{seconds:remaining});if(remaining===1)return game.i18n.localize("PF2E.EffectPanel.RemainingDuration.SingleSecond");{const key=expiry==="turn-end"?"PF2E.EffectPanel.RemainingDuration.ZeroRoundsExpireTurnEnd":"PF2E.EffectPanel.RemainingDuration.ZeroRoundsExpireTurnStart";return game.i18n.format(key,{initiative})}}async#getViewData(effects){return await Promise.all(effects.map(async effect=>({effect,description:(await effect.getDescription()).value,remaining:effect instanceof EffectPF2e?this.#getRemainingDurationLabel(effect):null})))}async _onFirstRender(context,options){return createTooltipListener(this.element,{selector:".effect-item[data-item-id]",locked:!0,direction:"LEFT",cssClass:"pf2e effect-info application",align:"top",render:__name2(async effectEl=>{const actor=this.#actor,itemId=effectEl.dataset.itemId??"",effect=actor?.conditions.get(itemId)??actor?.items.get(itemId);if(!actor||!effect)return null;const viewData=(await this.#getViewData([effect]))[0];if(!viewData)throw ErrorPF2e("Error creating view data for effect");const content=createHTMLElement("div",{innerHTML:await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/system/effects/tooltip.hbs",viewData)}).firstElementChild;return content instanceof HTMLElement?(content.querySelector("[data-action=recover-persistent-damage]")?.addEventListener("click",()=>{effect.isOfType("condition")&&effect.rollRecovery()}),content.querySelector("[data-action=edit]")?.addEventListener("click",()=>{effect.isOfType("condition")&&effect.slug==="persistent-damage"?new PersistentDamageEditor({actor,selectedItemId:effect.id}).render({force:!0}):effect.sheet.render(!0)}),content.querySelector("[data-action=send-to-chat]")?.addEventListener("click",()=>{effect.toMessage()}),content):null},"render")}),super._onFirstRender(context,options)}async _onRender(context,options){await super._onRender(context,options);const html2=this.element;options?.force&&document.getElementById("ui-right-column-1")?.appendChild(html2);for(const effectEl of htmlQueryAll(html2,".effect-item[data-item-id]")){const iconElem=effectEl.querySelector(":scope > .icon");if(!iconElem)continue;const valueContainer=htmlQuery(iconElem,".value"),textElement=htmlQuery(valueContainer,"strong");if(valueContainer&&textElement){const parentWidth=valueContainer.clientWidth,scale=textElement.clientWidth?Math.clamp(parentWidth/textElement.clientWidth,.75,1):1;scale<1&&(valueContainer.style.transformOrigin="left",valueContainer.style.transform=`scaleX(${scale})`,valueContainer.style.width=`${1/scale*100+1}%`),textElement.style.display="inline"}}}}const debouncedRender=foundry.utils.debounce(()=>{canvas.tokens.hud.render()},20);class StatusEffects{static{__name(this,"StatusEffects")}static{__name2(this,"StatusEffects")}static#lastCombatantToken=null;static#ICON_THEME_DIRS={default:"systems/pf2e/icons/conditions/",blackWhite:"systems/pf2e/icons/conditions-2/"};static#conditionSummaries=null;static initialize(){const iconTheme=game.settings.get("pf2e","statusEffectType");CONFIG.controlIcons.defeated=game.settings.get("pf2e","deathIcon"),CONFIG.PF2E.statusEffects.lastIconTheme=iconTheme,CONFIG.PF2E.statusEffects.iconDir=this.#ICON_THEME_DIRS[iconTheme],this.#updateStatusIcons()}static reset(){CONFIG.controlIcons.defeated=game.settings.get("pf2e","deathIcon"),this.#updateStatusIcons(),this.refresh()}static get conditions(){return this.#conditionSummaries??=t$9(Array.from(CONDITION_SLUGS),s=>[s,{name:game.i18n.localize(`PF2E.condition.${s}.name`),rules:game.i18n.localize(`PF2E.condition.${s}.rules`),summary:game.i18n.localize(`PF2E.condition.${s}.summary`)}])}static async migrateStatusEffectUrls(chosenSetting){console.debug("PF2e System | Changing status effect icon types");const iconDir=this.#ICON_THEME_DIRS[chosenSetting];if(CONFIG.PF2E.statusEffects.iconDir=iconDir,CONFIG.PF2E.statusEffects.lastIconTheme=chosenSetting,this.#updateStatusIcons(),await resetActors(),canvas.ready)for(const token of canvas.tokens.placeables)token.drawEffects()}static#activateListeners(html2){for(const control of htmlQueryAll(html2,".effect-control"))control.addEventListener("click",event2=>{this.#setStatusValue(control,event2)}),control.addEventListener("contextmenu",event2=>{this.#setStatusValue(control,event2)}),control.addEventListener("mouseover",()=>{this.#showStatusLabel(control)}),control.addEventListener("mouseout",()=>{this.#showStatusLabel(control)})}static#updateStatusIcons(){const directory=game.settings.get("pf2e","statusEffectType")==="default"?"conditions":"conditions-2";CONFIG.statusEffects=Object.entries(CONFIG.PF2E.statusEffects.conditions).map(([id,name2])=>({id,name:name2,img:`systems/pf2e/icons/${directory}/${id}.webp`})),CONFIG.statusEffects.push({id:"dead",name:"PF2E.Actor.Dead",img:CONFIG.controlIcons.defeated})}static async onRenderTokenHUD(html2,tokenData){const token=canvas.tokens.get(tokenData._id??"");if(!token)return;const iconGrid=html2.querySelector(".status-effects");if(!iconGrid)return;const affectingConditions=token.actor?.conditions.active.filter(c=>c.isInHUD)??[],titleBar=document.createElement("div");titleBar.className="title-bar",iconGrid.append(titleBar);const statusIcons=iconGrid.querySelectorAll(".effect-control"),deathIcon=game.settings.get("pf2e","deathIcon");for(const icon of statusIcons){const newImg=document.createElement("img");newImg.src=icon.src;const anchor=createHTMLElement("a",{classes:["effect-control"],dataset:{...icon.dataset},children:[newImg]});delete anchor.dataset.action,icon.replaceWith(anchor);const slug=anchor.dataset.statusId??"",actorType=token.actor?.type??"";(slug==="hidden"&&["loot","vehicle"].includes(actorType)||slug==="broken"&&!["loot","vehicle"].includes(actorType))&&(anchor.style.display="none");const affecting=affectingConditions.filter(c=>c.slug===slug);if((affecting.length>0||icon.src===deathIcon&&token.actor?.statuses.has("dead"))&&anchor.classList.add("active"),affecting.length>0){const isOverridden=affecting.every(c=>c.system.references.overriddenBy.length>0),isLocked=affecting.every(c=>c.isLocked),hasValue=affecting.some(c=>c.value);if(isOverridden){anchor.classList.add("overridden");const badge=fontAwesomeIcon("angle-double-down");badge.classList.add("badge"),anchor.append(badge)}else if(isLocked){anchor.classList.add("locked");const badge=fontAwesomeIcon("lock");badge.classList.add("badge"),anchor.append(badge)}else if(hasValue){anchor.classList.add("valued");const value=Math.max(...affecting.map(c=>c.value??1)).toString(),badge=createHTMLElement("i",{classes:["badge"],children:[value]});anchor.append(badge)}}}this.#activateListeners(iconGrid)}static onUpdateEncounter(encounter){if(!(game.user.isGM&&game.settings.get("pf2e","statusEffectShowCombatMessage")))return;if(!encounter.started){this.#lastCombatantToken=null;return}const{combatant}=encounter,token=combatant?.token;combatant&&token&&token.id!==this.#lastCombatantToken&&typeof combatant.initiative=="number"&&!combatant.defeated&&(this.#lastCombatantToken=token.id,this.#createChatMessage(token,combatant.hidden))}static#showStatusLabel(control){const titleBar=control.closest(".status-effects")?.querySelector(".title-bar");titleBar&&control.title&&(titleBar.innerText=control.title,titleBar.classList.toggle("active"))}static async#setStatusValue(control,event2){event2.preventDefault(),event2.stopPropagation();const slug=control.dataset.statusId;if(!setHasElement(CONDITION_SLUGS,slug)&&slug!=="dead")return;const tokensAndActors=n$2(canvas.tokens.controlled.map(t2=>t2.actor?[t2,t2.actor]:null).filter(e$1),([,a])=>a);for(const[token,actor]of tokensAndActors){if(slug==="persistent-damage"){new PersistentDamageEditor({actor}).render({force:!0});continue}const condition=actor.conditions.bySlug(slug,{temporary:!1}).sort((a,b)=>Number(b.active)-Number(a.active)).find(c=>c.isInHUD&&!c.system.references.parent);if(event2.type==="click")typeof condition?.value=="number"?game.pf2e.ConditionManager.updateConditionValue(condition.id,token,condition.value+1):objectHasKey(CONFIG.PF2E.conditionTypes,slug)?actor.increaseCondition(slug):this.#toggleStatus(token,control,event2);else if(event2.type==="contextmenu")if(event2.ctrlKey&&slug!=="dead"){const conditionIds=actor.conditions.bySlug(slug,{temporary:!1}).map(c=>c.id);actor.deleteEmbeddedDocuments("Item",conditionIds)}else condition?.value?game.pf2e.ConditionManager.updateConditionValue(condition.id,token,condition.value-1):this.#toggleStatus(token,control,event2)}}static async#toggleStatus(token,control,event2){const{actor}=token;if(!actor)return;const slug=control.dataset.statusId??"";if(!setHasElement(CONDITION_SLUGS,slug)&&slug!=="dead")return;const affecting=actor?.conditions.bySlug(slug,{active:!0,temporary:!1}).find(c=>!c.system.references.parent),conditionIds=[];if(event2.type==="click"&&!affecting)if(objectHasKey(CONFIG.PF2E.conditionTypes,slug)){const newCondition=game.pf2e.ConditionManager.getCondition(slug).toObject();await token.actor?.createEmbeddedDocuments("Item",[newCondition])}else slug==="dead"&&await token.actor?.toggleStatusEffect(slug,{overlay:!0});else event2.type==="contextmenu"&&(affecting&&conditionIds.push(affecting.id),conditionIds.length>0&&await token.actor?.deleteEmbeddedDocuments("Item",conditionIds))}static async#createChatMessage(token,whisper=!1){if(!token?.actor)return null;const conditions=await Promise.all(token.actor.conditions.active.map(async c=>({...t$3(c,["name","img"]),description:await TextEditorPF2e.enrichHTML(c.description)})));if(conditions.length===0)return null;const content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/chat/participant-conditions.hbs",{conditions}),messageSource={author:game.user.id,speaker:ChatMessagePF2e.getSpeaker({token}),content,style:CONST.CHAT_MESSAGE_STYLES.OTHER},isNPCEvent=!token.actor?.hasPlayerOwner;return(whisper||isNPCEvent&&game.settings.get("pf2e","metagame_secretCondition"))&&(messageSource.whisper=ChatMessage.getWhisperRecipients("GM").map(u=>u.id)),ChatMessagePF2e.create(messageSource)}static refresh(){canvas.ready&&canvas.tokens.hud.rendered&&debouncedRender()}}async function remigrate(versionRange){if(!game.ready){ui.notifications.warn("PF2E.Migrations.WorldNotReady",{localize:!0});return}if(game.user.role!==CONST.USER_ROLES.GAMEMASTER){ui.notifications.error("PF2E.Migrations.OnlyGMCanUse",{localize:!0});return}const migrations=MigrationList.constructRange(versionRange.from,versionRange.to);if(migrations.length===0||versionRange.from<MigrationRunner.RECOMMENDED_SAFE_VERSION){ui.notifications.error(game.i18n.format("PF2E.Migrations.OutsideSchemaRange",{minimum:MigrationRunner.RECOMMENDED_SAFE_VERSION,maximum:MigrationRunner.LATEST_SCHEMA_VERSION}));return}return new MigrationRunner(migrations).runMigration(!0)}__name(remigrate,"remigrate"),__name2(remigrate,"remigrate");function labelSampleTasks(sampleTasks){const unlabeled=[];let rank;for(rank in sampleTasks)unlabeled.push({rank,text:sampleTasks[rank]});return unlabeled.sort((t1,t2)=>PROFICIENCY_RANKS.indexOf(t1.rank)-PROFICIENCY_RANKS.indexOf(t2.rank)),unlabeled.map(task=>({label:CONFIG.PF2E.proficiencyRanks[task.rank],text:task.text}))}__name(labelSampleTasks,"labelSampleTasks"),__name2(labelSampleTasks,"labelSampleTasks");class BaseActionVariant{static{__name(this,"BaseActionVariant")}static{__name2(this,"BaseActionVariant")}#action;#cost;#description;name;#slug;#traits;constructor(action2,data){this.#action=action2,data&&(this.#cost=data.cost,this.#description=data.description,this.name=data.name?.trim(),this.#slug=data.slug?.trim(),this.#traits=data.traits)}get cost(){return this.#cost??this.#action.cost}get description(){return this.#description?.trim()||this.#action.description}get glyph(){return getActionGlyph(this.cost??null)}get slug(){return this.#slug||sluggify(this.name??"")||this.#action.slug}get traits(){return this.#traits??this.#action.traits}async toMessage(options){const description=this.description||this.#action.description,name2=this.name?`${game.i18n.localize(this.#action.name)} - ${game.i18n.localize(this.name)}`:game.i18n.localize(this.#action.name),sampleTasks=this.#action.sampleTasks?labelSampleTasks(this.#action.sampleTasks):void 0,traitLabels=CONFIG.PF2E.actionTraits,traitDescriptions2=CONFIG.PF2E.traitsDescriptions,traits=this.traits.map(trait=>({description:traitDescriptions2[trait],label:traitLabels[trait]??trait,slug:trait})),content=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/actions/base/chat-message-content.hbs",{description,glyph:this.glyph,name:name2,sampleTasks,traits});return ChatMessagePF2e.create({blind:options?.blind,content,whisper:options?.whisper})}}class BaseAction{static{__name(this,"BaseAction")}static{__name2(this,"BaseAction")}cost;description;img;name;sampleTasks;section;slug;traits;#variants;constructor(data){this.cost=data.cost,this.description=data.description,this.img=data.img,this.name=data.name.trim(),this.sampleTasks=data.sampleTasks,this.section=data.section,this.slug=data.slug?.trim()||sluggify(this.name),this.traits=data.traits??[],this.#variants=Array.isArray(data.variants)?data.variants.map(this.toActionVariant.bind(this)):data.variants?[this.toActionVariant(data.variants)]:[]}get glyph(){if(this.#variants.length===1)return this.#variants[0].glyph;const numbers=this.#variants.filter(variant=>typeof variant.cost=="number").sort();if(this.#variants.length===numbers.length&&numbers.length>1){const first=numbers.shift()?.cost,last=numbers.pop()?.cost,key=first===last?String(first):first===2||last===2?`${first} or ${last}`:`${first} to ${last}`;return getActionGlyph(key)}return getActionGlyph(this.cost??"")}get variants(){const variants=this.#variants.map(variant=>[variant.slug,variant]);return new Collection(variants)}getDefaultVariant(options){const variants=this.variants;if(options?.variant&&!variants.size)throw game.i18n.format("PF2E.ActionsWarning.Variants.None",{action:game.i18n.localize(this.name),variant:options.variant});if(!options?.variant&&variants.size>1)throw game.i18n.format("PF2E.ActionsWarning.Variants.Multiple",{action:game.i18n.localize(this.name)});const variant=variants.get(options?.variant??"");if(options?.variant&&!variant)throw game.i18n.format("PF2E.ActionsWarning.Variants.Nonexistent",{action:game.i18n.localize(this.name),variant:options.variant});return variant??this.toActionVariant()}async toMessage(options){return options?.variant?this.getDefaultVariant(options).toMessage(options):this.toActionVariant().toMessage(options)}async use(options){return this.getDefaultVariant(options).use(options)}}async function toEffectItem(effect){return typeof effect=="string"?await fromUuid(effect):effect}__name(toEffectItem,"toEffectItem"),__name2(toEffectItem,"toEffectItem");class SimpleActionVariant extends BaseActionVariant{static{__name(this,"SimpleActionVariant")}static{__name2(this,"SimpleActionVariant")}#action;#effect;constructor(action2,data){super(action2,data),this.#action=action2,this.#effect=data?.effect??action2.effect}get effect(){return this.#effect??this.#action.effect}async use(options={}){const actors=[];if(Array.isArray(options.actors)?actors.push(...options.actors):options.actors?actors.push(options.actors):actors.push(...getSelectedActors({exclude:["loot","party"],assignedFallback:!0})),actors.length===0)throw new Error(game.i18n.localize("PF2E.ActionsWarning.NoActor"));const traitLabels=CONFIG.PF2E.actionTraits,traitDescriptions2=CONFIG.PF2E.traitsDescriptions,traits=this.traits.concat(options.traits??[]).map(trait=>({description:traitDescriptions2[trait],label:traitLabels[trait]??trait,slug:trait})),effect=options?.effect===!1?void 0:await toEffectItem(options?.effect??this.effect),name2=this.name?`${game.i18n.localize(this.#action.name)} - ${game.i18n.localize(this.name)}`:game.i18n.localize(this.#action.name),flavor=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/actions/simple/chat-message-flavor.hbs",{effect,glyph:this.glyph,name:name2,traits}),results=[];for(const actor of actors){const data={flavor,speaker:ChatMessage.getSpeaker({actor})},message=options.message?.create??!0?await ChatMessagePF2e.create(data):new ChatMessagePF2e(data),item=effect&&actor.isOwner?(await actor.createEmbeddedDocuments("Item",[effect.toObject()]))[0]:void 0;results.push({actor,effect:item,message})}return results}}class SimpleAction extends BaseAction{static{__name(this,"SimpleAction")}static{__name2(this,"SimpleAction")}effect;constructor(data){super(data),this.effect=data.effect}toActionVariant(data){return new SimpleActionVariant(this,data)}}function toRollNoteSource(data){return data.selector??="",data}__name(toRollNoteSource,"toRollNoteSource"),__name2(toRollNoteSource,"toRollNoteSource");function isValidDifficultyClass(dc){if(e$3(dc)&&"value"in dc&&typeof dc.value=="number")return!0;const slug=String(dc);return["ac","armor","perception"].includes(slug)||tupleHasValue(SAVE_TYPES,slug)||slug in CONFIG.PF2E.skills}__name(isValidDifficultyClass,"isValidDifficultyClass"),__name2(isValidDifficultyClass,"isValidDifficultyClass");class SingleCheckActionVariant extends BaseActionVariant{static{__name(this,"SingleCheckActionVariant")}static{__name2(this,"SingleCheckActionVariant")}#action;#difficultyClass;#modifiers;#notes;#rollOptions;#statistic;constructor(action2,data){super(action2,data),this.#action=action2,data&&(this.#difficultyClass=data.difficultyClass,this.#modifiers=data?.modifiers,this.#notes=data.notes?data.notes.map(toRollNoteSource):void 0,this.#statistic=data.statistic,this.#rollOptions=data.slug?[`action:${action2.slug}:${data.slug.trim()}`,...data.rollOptions??[]]:data.rollOptions)}get difficultyClass(){return this.#difficultyClass??this.#action.difficultyClass}get modifiers(){return this.#modifiers??this.#action.modifiers}get notes(){return this.#notes??this.#action.notes}get rollOptions(){return this.#rollOptions?[...this.#action.rollOptions,...this.#rollOptions]:this.#action.rollOptions}get statistic(){return this.#statistic??this.#action.statistic}preview(options={}){const slugs=this.#statistic||this.#action.statistic;return(Array.isArray(slugs)?slugs:[slugs]).map(candidate=>this.toActionCheckPreview({actor:options.actor,rollOptions:this.rollOptions,slug:candidate})).filter(preview=>!!preview)}async use(options={}){const modifiers=this.modifiers.map(raw=>new Modifier(raw)).concat(options.modifiers??[]);if(options.multipleAttackPenalty){const map=options.multipleAttackPenalty,modifier=map>0?Math.min(2,map)*-5:map;modifiers.push(new Modifier({label:"PF2E.MultipleAttackPenalty",modifier}))}const notes=this.notes.concat(options.notes??[]).map(toRollNoteSource).map(note=>new RollNotePF2e(note)),rollOptions=this.rollOptions.concat(options.rollOptions??[]),slug=options.statistic?.trim()||(Array.isArray(this.statistic)?this.statistic[0]:this.statistic),title=this.name?`${game.i18n.localize(this.#action.name)} - ${game.i18n.localize(this.name)}`:game.i18n.localize(this.#action.name),difficultyClass=Number.isNumeric(options.difficultyClass)?{value:Number(options.difficultyClass)}:isValidDifficultyClass(options.difficultyClass)?options.difficultyClass:this.difficultyClass,results=[];return await ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,title,actionGlyph:getActionGlyph(this.cost??null),callback:__name2(result=>results.push(result),"callback"),checkContext:__name2(opts=>this.checkContext(opts,{modifiers,rollOptions,slug}),"checkContext"),createMessage:options.message?.create,difficultyClass,event:options.event,extraNotes:__name2(selector=>notes.map(note=>(note.selector||=selector,note)),"extraNotes"),target:__name2(()=>options.target instanceof ActorPF2e?{token:null,actor:options.target}:options.target instanceof TokenPF2e&&options.target.actor?{token:options.target.document,actor:options.target.actor}:null,"target"),traits:this.traits.concat(options?.traits??[])}),results}checkContext(opts,data){return ActionMacroHelpers.defaultCheckContext(opts,data)}toActionCheckPreview(args){if(args.actor){const statistic=args.actor.getStatistic(args.slug);if(statistic){const modifiers=[...statistic.modifiers,...this.modifiers.map(modifier2=>new Modifier(modifier2))],modifier=new StatisticModifier(args.slug,modifiers,new Set(args.rollOptions).union(statistic.dc.options));return{label:statistic.label,modifier:modifier.totalModifier,slug:args.slug}}}else return{label:ActionMacroHelpers.getSimpleCheckLabel(args.slug)??game.i18n.localize(args.slug),slug:args.slug};return null}}class SingleCheckAction extends BaseAction{static{__name(this,"SingleCheckAction")}static{__name2(this,"SingleCheckAction")}difficultyClass;modifiers;notes;rollOptions;statistic;constructor(data){super(data),this.difficultyClass=data.difficultyClass,this.modifiers=data.modifiers??[],this.notes=(data.notes??[]).map(toRollNoteSource),this.rollOptions=[`action:${this.slug}`,...data.rollOptions??[]],this.statistic=data.statistic}preview(options={}){return this.getDefaultVariant(options).preview(options)}toActionVariant(data){return new SingleCheckActionVariant(this,data)}}const PREFIX$w="PF2E.Actions.Balance";function balance(options){const slug=options?.skill??"acrobatics",rollOptions=["action:balance"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$w}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["move"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Balance","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Balance","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Balance","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.Balance","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(balance,"balance"),__name2(balance,"balance");const action$I=new SingleCheckAction({cost:1,description:`${PREFIX$w}.Description`,img:"icons/skills/movement/figure-running-gray.webp",name:`${PREFIX$w}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$w}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$w}.Notes.success`},{outcome:["failure"],text:`${PREFIX$w}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$w}.Notes.criticalFailure`}],sampleTasks:{untrained:`${PREFIX$w}.SampleTasks.Untrained`,trained:`${PREFIX$w}.SampleTasks.Trained`,expert:`${PREFIX$w}.SampleTasks.Expert`,master:`${PREFIX$w}.SampleTasks.Master`,legendary:`${PREFIX$w}.SampleTasks.Legendary`},section:"skill",slug:"balance",statistic:"acrobatics",traits:["move"]}),PREFIX$v="PF2E.Actions.ManeuverInFlight";async function maneuverInFlight(options){const slug=options?.skill??"acrobatics",rollOptions=["action:maneuver-in-flight"],modifiers=options?.modifiers;return ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$v}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["move"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$v}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.note(selector,PREFIX$v,"failure"),ActionMacroHelpers.note(selector,PREFIX$v,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(maneuverInFlight,"maneuverInFlight"),__name2(maneuverInFlight,"maneuverInFlight");const action$H=new SingleCheckAction({cost:1,description:`${PREFIX$v}.Description`,img:"icons/skills/movement/feet-winged-boots-blue.webp",name:`${PREFIX$v}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX$v}.Notes.success`},{outcome:["failure"],text:`${PREFIX$v}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$v}.Notes.criticalFailure`}],sampleTasks:{trained:`${PREFIX$v}.SampleTasks.Trained`,expert:`${PREFIX$v}.SampleTasks.Expert`,master:`${PREFIX$v}.SampleTasks.Master`,legendary:`${PREFIX$v}.SampleTasks.Legendary`},section:"skill",slug:"maneuver-in-flight",statistic:"acrobatics",traits:["move"]}),PREFIX$u="PF2E.Actions.Squeeze";function squeeze(options){const slug=options?.skill??"acrobatics",rollOptions=["action:squeeze"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:`${PREFIX$u}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["exploration","move"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Squeeze","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Squeeze","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Squeeze","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(squeeze,"squeeze"),__name2(squeeze,"squeeze");const action$G=new SingleCheckAction({description:`${PREFIX$u}.Description`,img:"icons/skills/movement/figure-running-gray.webp",name:`${PREFIX$u}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$u}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$u}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$u}.Notes.criticalFailure`}],sampleTasks:{trained:`${PREFIX$u}.SampleTasks.Trained`,master:`${PREFIX$u}.SampleTasks.Master`},section:"skill",slug:"squeeze",statistic:"acrobatics",traits:["exploration","move"]}),PREFIX$t="PF2E.Actions.TumbleThrough";function tumbleThrough(options){const slug=options?.skill??"acrobatics",rollOptions=["action:tumble-through"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$t}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["move"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"reflex",extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$t}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.outcomesNote(selector,`${PREFIX$t}.Notes.failure`,["failure","criticalFailure"])],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(tumbleThrough,"tumbleThrough"),__name2(tumbleThrough,"tumbleThrough");const action$F=new SingleCheckAction({cost:1,description:`${PREFIX$t}.Description`,difficultyClass:"reflex",img:"icons/skills/movement/figure-running-gray.webp",name:`${PREFIX$t}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX$t}.Notes.success`},{outcome:["failure","criticalFailure"],text:`${PREFIX$t}.Notes.failure`}],section:"skill",slug:"tumble-through",statistic:"acrobatics",traits:["move"]});function arcaneSlam(options){const{actor:target,token}=ActionMacroHelpers.target(),slug=options?.skill??"acrobatics",rollOptions=["action:arcane-slam"];ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"D",title:"PF2E.Actions.ArcaneSlam.Title",checkContext:__name2(opts=>{const modifiers=options.modifiers?.length?[...options.modifiers]:[];if(opts.actor instanceof CreaturePF2e&&opts.target instanceof CreaturePF2e){const attackerSize=opts.actor.system.traits.size,targetSize=opts.target.system.traits.size,sizeDifference=attackerSize.difference(targetSize),sizeModifier=new Modifier("PF2E.Actions.ArcaneSlam.Modifier.SizeDifference",Math.clamp(2*sizeDifference,-4,4),"circumstance");sizeModifier.modifier&&modifiers.push(sizeModifier)}return ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug})},"checkContext"),traits:["automaton"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"fortitude",extraNotes:__name2(selector=>{const notes=[ActionMacroHelpers.note(selector,"PF2E.Actions.ArcaneSlam","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.ArcaneSlam","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.ArcaneSlam","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.ArcaneSlam","criticalFailure")];if(!target){const translated=game.i18n.localize("PF2E.Actions.ArcaneSlam.Notes.NoTarget");notes.unshift(new RollNotePF2e({selector,text:`<p class="compact-text">${translated}</p>`,predicate:new Predicate,outcome:[]}))}return notes},"extraNotes"),target:__name2(()=>target&&token?{actor:target,token}:null,"target")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(arcaneSlam,"arcaneSlam"),__name2(arcaneSlam,"arcaneSlam");const PREFIX$s="PF2E.Actions.Climb";function climb(options){const slug=options?.skill??"athletics",rollOptions=["action:climb"],modifiers=(options?.modifiers??[]).concat(new Modifier({slug:"climb-speed",label:`${PREFIX$s}.Modifier.ClimbSpeed`,modifier:4,type:"circumstance",predicate:["speed:climb"]}));ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$s}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["move"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,PREFIX$s,"criticalSuccess"),ActionMacroHelpers.note(selector,PREFIX$s,"success"),ActionMacroHelpers.note(selector,PREFIX$s,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(climb,"climb"),__name2(climb,"climb");const action$E=new SingleCheckAction({cost:1,description:`${PREFIX$s}.Description`,img:"icons/skills/movement/arrow-upward-blue.webp",modifiers:[{slug:"climb-speed",label:`${PREFIX$s}.Modifier.ClimbSpeed`,modifier:4,type:"circumstance",predicate:["speed:climb"]}],name:`${PREFIX$s}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$s}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$s}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$s}.Notes.criticalFailure`}],sampleTasks:{untrained:`${PREFIX$s}.SampleTasks.Untrained`,trained:`${PREFIX$s}.SampleTasks.Trained`,expert:`${PREFIX$s}.SampleTasks.Expert`,master:`${PREFIX$s}.SampleTasks.Master`,legendary:`${PREFIX$s}.SampleTasks.Legendary`},section:"skill",slug:"climb",statistic:"athletics",traits:["move"]}),PREFIX$r="PF2E.Actions.Disarm";function disarmCheckContext(opts,data){const weapon=ActionMacroHelpers.getBestEquippedItemForAction(opts.actor,["disarm"],data.slug),modifiers=data.modifiers?.length?[...data.modifiers]:[];if(weapon&&weapon.slug!=="basic-unarmed"){const modifier=ActionMacroHelpers.getWeaponPotencyModifier(weapon,data.slug);modifier&&modifiers.push(modifier)}return ActionMacroHelpers.defaultCheckContext(opts,{...data,modifiers})}__name(disarmCheckContext,"disarmCheckContext"),__name2(disarmCheckContext,"disarmCheckContext");function disarm(options){const slug=options?.skill??"athletics",modifiers=options?.modifiers,rollOptions=["action:disarm"];ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$r}.Title`,checkContext:__name2(opts=>disarmCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["attack"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"reflex",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Disarm","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Disarm","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Disarm","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(disarm,"disarm"),__name2(disarm,"disarm");class DisarmActionVariant extends SingleCheckActionVariant{static{__name(this,"DisarmActionVariant")}static{__name2(this,"DisarmActionVariant")}checkContext(opts,data){return disarmCheckContext(opts,data)}}class DisarmAction extends SingleCheckAction{static{__name(this,"DisarmAction")}static{__name2(this,"DisarmAction")}constructor(){super({cost:1,description:`${PREFIX$r}.Description`,difficultyClass:"reflex",img:"icons/skills/melee/unarmed-punch-fist-white.webp",name:`${PREFIX$r}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$r}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$r}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$r}.Notes.criticalFailure`}],section:"skill",slug:"disarm",statistic:"athletics",traits:["attack"]})}toActionVariant(data){return new DisarmActionVariant(this,data)}}const action$D=new DisarmAction,PREFIX$q="PF2E.Actions.ForceOpen";function forceOpen(options){const slug=options?.skill??"athletics",rollOptions=["action:force-open"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$q}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["attack"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.ForceOpen","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.ForceOpen","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.ForceOpen","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(forceOpen,"forceOpen"),__name2(forceOpen,"forceOpen");const action$C=new SingleCheckAction({cost:1,description:`${PREFIX$q}.Description`,img:"icons/skills/melee/unarmed-punch-fist-white.webp",name:`${PREFIX$q}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$q}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$q}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$q}.Notes.criticalFailure`}],sampleTasks:{untrained:`${PREFIX$q}.SampleTasks.Untrained`,trained:`${PREFIX$q}.SampleTasks.Trained`,expert:`${PREFIX$q}.SampleTasks.Expert`,master:`${PREFIX$q}.SampleTasks.Master`,legendary:`${PREFIX$q}.SampleTasks.Legendary`},section:"skill",slug:"force-open",statistic:"athletics",traits:["attack"]}),PREFIX$p="PF2E.Actions.Grapple";function grappleCheckContext(opts,data){const weapon=ActionMacroHelpers.getBestEquippedItemForAction(opts.actor,["grapple"],data.slug),modifiers=data.modifiers?.length?[...data.modifiers]:[];if(weapon&&weapon.traits.has("grapple")){const modifier=ActionMacroHelpers.getWeaponPotencyModifier(weapon,data.slug);modifier&&modifiers.push(modifier)}return ActionMacroHelpers.defaultCheckContext(opts,{...data,modifiers})}__name(grappleCheckContext,"grappleCheckContext"),__name2(grappleCheckContext,"grappleCheckContext");function grapple(options){const slug=options?.skill??"athletics",modifiers=options?.modifiers,rollOptions=["action:grapple"];ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$p}.Title`,checkContext:__name2(opts=>grappleCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["attack"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"fortitude",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,PREFIX$p,"criticalSuccess"),ActionMacroHelpers.note(selector,PREFIX$p,"success"),ActionMacroHelpers.note(selector,PREFIX$p,"failure"),ActionMacroHelpers.note(selector,PREFIX$p,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(grapple,"grapple"),__name2(grapple,"grapple");class GrappleActionVariant extends SingleCheckActionVariant{static{__name(this,"GrappleActionVariant")}static{__name2(this,"GrappleActionVariant")}checkContext(opts,data){return grappleCheckContext(opts,data)}}class GrappleAction extends SingleCheckAction{static{__name(this,"GrappleAction")}static{__name2(this,"GrappleAction")}constructor(){super({cost:1,description:`${PREFIX$p}.Description`,difficultyClass:"fortitude",img:"icons/skills/melee/unarmed-punch-fist-white.webp",name:`${PREFIX$p}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$p}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$p}.Notes.success`},{outcome:["failure"],text:`${PREFIX$p}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$p}.Notes.criticalFailure`}],section:"skill",slug:"grapple",statistic:"athletics",traits:["attack"]})}toActionVariant(data){return new GrappleActionVariant(this,data)}}const action$B=new GrappleAction,PREFIX$o="PF2E.Actions.HighJump";function highJump(options){const slug=options?.skill??"athletics",rollOptions=["action:stride","action:leap","action:high-jump"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"D",title:`${PREFIX$o}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["move"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??{value:30},extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,PREFIX$o,"criticalSuccess"),ActionMacroHelpers.note(selector,PREFIX$o,"success"),ActionMacroHelpers.note(selector,PREFIX$o,"failure"),ActionMacroHelpers.note(selector,PREFIX$o,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(highJump,"highJump"),__name2(highJump,"highJump");const action$A=new SingleCheckAction({cost:2,description:`${PREFIX$o}.Description`,difficultyClass:{value:30},img:"icons/skills/movement/figure-running-gray.webp",name:`${PREFIX$o}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$o}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$o}.Notes.success`},{outcome:["failure"],text:`${PREFIX$o}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$o}.Notes.criticalFailure`}],rollOptions:["action:stride","action:leap"],section:"skill",slug:"high-jump",statistic:"athletics",traits:["move"]}),PREFIX$n="PF2E.Actions.LongJump";function longJump(options){const slug=options?.skill??"athletics",rollOptions=["action:stride","action:leap","action:long-jump"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"D",title:`${PREFIX$n}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["move"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??{value:15},extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$n}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.note(selector,PREFIX$n,"failure"),ActionMacroHelpers.note(selector,PREFIX$n,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(longJump,"longJump"),__name2(longJump,"longJump");const action$z=new SingleCheckAction({cost:2,description:`${PREFIX$n}.Description`,difficultyClass:{value:15},img:"icons/skills/movement/figure-running-gray.webp",name:`${PREFIX$n}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX$n}.Notes.success`},{outcome:["failure"],text:`${PREFIX$n}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$n}.Notes.criticalFailure`}],rollOptions:["action:stride","action:leap"],section:"skill",slug:"long-jump",statistic:"athletics",traits:["move"]}),PREFIX$m="PF2E.Actions.Reposition";function reposition(options){const slug=options?.skill??"athletics",modifiers=options?.modifiers,rollOptions=["action:reposition","forced-movement"];ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$m}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["attack"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"fortitude",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,PREFIX$m,"criticalSuccess"),ActionMacroHelpers.note(selector,PREFIX$m,"success"),ActionMacroHelpers.note(selector,PREFIX$m,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(reposition,"reposition"),__name2(reposition,"reposition");const action$y=new SingleCheckAction({cost:1,description:`${PREFIX$m}.Description`,difficultyClass:"fortitude",img:"icons/skills/movement/figure-running-gray.webp",name:`${PREFIX$m}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$m}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$m}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$m}.Notes.criticalFailure`}],rollOptions:["forced-movement"],section:"skill",slug:"reposition",statistic:"athletics",traits:["attack"]}),PREFIX$l="PF2E.Actions.Shove";function shoveCheckContext(opts,data){const weapon=ActionMacroHelpers.getBestEquippedItemForAction(opts.actor,["shove"],data.slug),modifiers=data.modifiers?.length?[...data.modifiers]:[];if(weapon&&weapon.traits.has("shove")){const modifier=ActionMacroHelpers.getWeaponPotencyModifier(weapon,data.slug);modifier&&modifiers.push(modifier)}return ActionMacroHelpers.defaultCheckContext(opts,{...data,modifiers})}__name(shoveCheckContext,"shoveCheckContext"),__name2(shoveCheckContext,"shoveCheckContext");function shove(options){const slug=options?.skill??"athletics",modifiers=options?.modifiers,rollOptions=["action:shove","forced-movement"];ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$l}.Title`,checkContext:__name2(opts=>shoveCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["attack"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"fortitude",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,PREFIX$l,"criticalSuccess"),ActionMacroHelpers.note(selector,PREFIX$l,"success"),ActionMacroHelpers.note(selector,PREFIX$l,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(shove,"shove"),__name2(shove,"shove");class ShoveActionVariant extends SingleCheckActionVariant{static{__name(this,"ShoveActionVariant")}static{__name2(this,"ShoveActionVariant")}checkContext(opts,data){return shoveCheckContext(opts,data)}}class ShoveAction extends SingleCheckAction{static{__name(this,"ShoveAction")}static{__name2(this,"ShoveAction")}constructor(){super({cost:1,description:`${PREFIX$l}.Description`,difficultyClass:"fortitude",img:"icons/skills/melee/unarmed-punch-fist-white.webp",name:`${PREFIX$l}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$l}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$l}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$l}.Notes.criticalFailure`}],rollOptions:["forced-movement"],section:"skill",slug:"shove",statistic:"athletics",traits:["attack"]})}toActionVariant(data){return new ShoveActionVariant(this,data)}}const action$x=new ShoveAction,PREFIX$k="PF2E.Actions.Swim";function swim(options){const slug=options?.skill??"athletics",rollOptions=["action:swim"],modifiers=(options?.modifiers??[]).concat(new Modifier({slug:"swim-speed",label:`${PREFIX$k}.Modifier.SwimSpeed`,modifier:4,type:"circumstance",predicate:["speed:swim"]}));ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$k}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["move"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,PREFIX$k,"criticalSuccess"),ActionMacroHelpers.note(selector,PREFIX$k,"success"),ActionMacroHelpers.note(selector,PREFIX$k,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(swim,"swim"),__name2(swim,"swim");const action$w=new SingleCheckAction({cost:1,description:`${PREFIX$k}.Description`,img:"icons/skills/movement/figure-running-gray.webp",modifiers:[{slug:"swim-speed",label:`${PREFIX$k}.Modifier.SwimSpeed`,modifier:4,type:"circumstance",predicate:["speed:swim"]}],name:`${PREFIX$k}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$k}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$k}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$k}.Notes.criticalFailure`}],sampleTasks:{untrained:`${PREFIX$k}.SampleTasks.Untrained`,trained:`${PREFIX$k}.SampleTasks.Trained`,expert:`${PREFIX$k}.SampleTasks.Expert`,master:`${PREFIX$k}.SampleTasks.Master`,legendary:`${PREFIX$k}.SampleTasks.Legendary`},section:"skill",slug:"swim",statistic:"athletics",traits:["move"]});function tripCheckContext(opts,data){const item=ActionMacroHelpers.getBestEquippedItemForAction(opts.actor,["trip","ranged-trip"],data.slug),context=ActionMacroHelpers.defaultCheckContext(opts,{item:data.item,modifiers:data.modifiers,rollOptions:data.rollOptions,slug:data.slug});if(item&&context){const modifiers=context.modifiers?.length?[...context.modifiers]:[];if(item.traits.has("trip")||item.traits.has("ranged-trip")){const modifier=ActionMacroHelpers.getWeaponPotencyModifier(item,data.slug);modifier&&modifiers.push(modifier)}item.traits.has("ranged-trip")&&modifiers.push(new Modifier({slug:"ranged-trip",adjustments:extractModifierAdjustments(opts.actor.synthetics.modifierAdjustments,context.rollOptions,"ranged-trip"),type:"circumstance",label:CONFIG.PF2E.weaponTraits["ranged-trip"],modifier:-2})),context.modifiers=modifiers}return context}__name(tripCheckContext,"tripCheckContext"),__name2(tripCheckContext,"tripCheckContext");function trip(options){const slug=options?.skill??"athletics",modifiers=options?.modifiers,rollOptions=["action:trip","inflicts:prone"];ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:"PF2E.Actions.Trip.Title",checkContext:__name2(opts=>tripCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["attack"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"reflex",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Trip","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Trip","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Trip","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(trip,"trip"),__name2(trip,"trip");class TripActionVariant extends SingleCheckActionVariant{static{__name(this,"TripActionVariant")}static{__name2(this,"TripActionVariant")}checkContext(opts,data){return tripCheckContext(opts,data)}}class TripAction extends SingleCheckAction{static{__name(this,"TripAction")}static{__name2(this,"TripAction")}constructor(){super({cost:1,description:"PF2E.Actions.Trip.Description",difficultyClass:"reflex",img:"icons/skills/melee/unarmed-punch-fist-white.webp",name:"PF2E.Actions.Trip.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Trip.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Trip.Notes.success"},{outcome:["criticalFailure"],text:"PF2E.Actions.Trip.Notes.criticalFailure"}],rollOptions:["inflicts:prone"],section:"skill",slug:"trip",statistic:"athletics",traits:["attack"]})}toActionVariant(data){return new TripActionVariant(this,data)}}const action$v=new TripAction;function determineSizeBonus(actorSize,targetSize){const sizeDifference=actorSize.difference(targetSize);return Math.clamp(2*sizeDifference,-4,4)}__name(determineSizeBonus,"determineSizeBonus"),__name2(determineSizeBonus,"determineSizeBonus");function whirlingThrow(options){const slug=options?.skill??"athletics",rollOptions=["action:whirling-throw"];ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:"PF2E.Actions.WhirlingThrow.Title",checkContext:__name2(opts=>{const modifiers=options.modifiers?.length?[...options.modifiers]:[];if(opts.actor instanceof CreaturePF2e&&opts.target instanceof CreaturePF2e){const actorSize=opts.actor.system.traits.size,targetSize=opts.target.system.traits.size,sizeModifier=new Modifier("Size Modifier",determineSizeBonus(actorSize,targetSize),"circumstance");sizeModifier.modifier&&modifiers.push(sizeModifier)}return ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug})},"checkContext"),traits:["monk"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"fortitude",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.WhirlingThrow","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.WhirlingThrow","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.WhirlingThrow","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.WhirlingThrow","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(whirlingThrow,"whirlingThrow"),__name2(whirlingThrow,"whirlingThrow");class AidActionVariant extends SingleCheckActionVariant{static{__name(this,"AidActionVariant")}static{__name2(this,"AidActionVariant")}async use(options){if(!options?.statistic)throw new Error(game.i18n.localize("PF2E.Actions.Aid.Warning.NoStatistic"));const rollOption=`action:aid:${options.statistic}`;return options.rollOptions??=[],options.rollOptions.includes(rollOption)||options.rollOptions.push(rollOption),super.use(options)}}class AidAction extends SingleCheckAction{static{__name(this,"AidAction")}static{__name2(this,"AidAction")}constructor(){super({cost:"reaction",description:"PF2E.Actions.Aid.Description",difficultyClass:{value:15},name:"PF2E.Actions.Aid.Title",notes:[{outcome:["criticalFailure"],text:"PF2E.Actions.Aid.Notes.criticalFailure",title:"PF2E.Check.Result.Degree.Check.criticalFailure"},{outcome:["criticalSuccess"],text:"PF2E.Actions.Aid.Notes.criticalSuccess",title:"PF2E.Check.Result.Degree.Check.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Aid.Notes.success",title:"PF2E.Check.Result.Degree.Check.success"}],section:"basic",slug:"aid",statistic:""})}toActionVariant(data){return new AidActionVariant(this,data)}}const aid=new AidAction,crawl=new SimpleAction({cost:1,description:"PF2E.Actions.Crawl.Description",name:"PF2E.Actions.Crawl.Title",section:"basic",slug:"crawl",traits:["move"]}),delay=new SimpleAction({cost:"free",description:"PF2E.Actions.Delay.Description",name:"PF2E.Actions.Delay.Title",section:"basic",slug:"delay"});class DropProneActionVariant extends SimpleActionVariant{static{__name(this,"DropProneActionVariant")}static{__name2(this,"DropProneActionVariant")}async use(options={}){return super.use(options).then(async results=>{for(const result of results)result.actor.hasCondition("prone")||await result.actor.toggleCondition("prone");return results})}}class DropProneAction extends SimpleAction{static{__name(this,"DropProneAction")}static{__name2(this,"DropProneAction")}constructor(){super({cost:1,description:"PF2E.Actions.DropProne.Description",name:"PF2E.Actions.DropProne.Title",section:"basic",slug:"drop-prone",traits:["move"]})}toActionVariant(data){return new DropProneActionVariant(this,data)}}const dropProne=new DropProneAction,toHighestModifier=__name2((highest,current)=>current.totalModifier>(highest?.totalModifier??Number.MIN_SAFE_INTEGER)?current:highest,"toHighestModifier");function unarmedStrikeWithHighestModifier(opts,data){const actionRollOptions=["action:escape","action:escape:unarmed"],{rollOptions}=opts.buildContext({actor:opts.actor,rollOptions:actionRollOptions,target:opts.target}),actor=opts.actor,statistic=(actor instanceof CharacterPF2e?actor.system.actions.filter(strike=>strike.weaponTraits.map(trait=>trait.name).includes("unarmed")):actor instanceof NPCPF2e?actor.system.actions.filter(strike=>strike.item.category==="unarmed"):[]).map(strike=>{const modifiers=(strike.modifiers??[]).concat(data.modifiers??[]);return new StatisticModifier("unarmed",modifiers,rollOptions)}).reduce(toHighestModifier,null);return statistic?{actor,rollOptions,statistic}:null}__name(unarmedStrikeWithHighestModifier,"unarmedStrikeWithHighestModifier"),__name2(unarmedStrikeWithHighestModifier,"unarmedStrikeWithHighestModifier");function escapeCheckContext(opts,data){const unarmed=data.slug&&data.slug!=="unarmed"?null:unarmedStrikeWithHighestModifier(opts,data),highest=(data.slug?[data.slug]:["acrobatics","athletics"]).filter(slug=>slug!=="unarmed").map(slug=>opts.actor.getStatistic(slug)).filter(statistic=>!!statistic).map(statistic=>{const actionRollOptions=["action:escape",`action:escape:${statistic.slug}`],rollOptions=opts.buildContext({actor:opts.actor,rollOptions:actionRollOptions,target:opts.target}).rollOptions;return{actor:opts.actor,rollOptions,statistic:new StatisticModifier(statistic.slug,statistic.modifiers.concat(data.modifiers??[]),rollOptions)}}).reduce((highest2,current)=>!highest2||current.statistic.totalModifier>(highest2?.statistic.totalModifier??0)?current:highest2,unarmed);if(highest){const{checkType,stat:slug,subtitle}=ActionMacroHelpers.resolveStat(highest.statistic.slug,opts.actor);return{modifiers:data.modifiers,rollOptions:highest.rollOptions,slug,statistic:highest.statistic,subtitle,type:checkType}}throw new CheckContextError("No applicable statistic to roll for Escape check.",opts.actor,"null")}__name(escapeCheckContext,"escapeCheckContext"),__name2(escapeCheckContext,"escapeCheckContext");function escape(options){const slug=options?.skill??"",modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,checkContext:__name2(opts=>escapeCheckContext(opts,{modifiers,slug}),"checkContext"),actionGlyph:options.glyph??"A",title:"PF2E.Actions.Escape.Title",traits:["attack"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"athletics",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Escape","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Escape","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Escape","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(escape,"escape"),__name2(escape,"escape");class EscapeActionVariant extends SingleCheckActionVariant{static{__name(this,"EscapeActionVariant")}static{__name2(this,"EscapeActionVariant")}get statistic(){return""}checkContext(opts,data){return escapeCheckContext(opts,data)}toActionCheckPreview(options){return this.#unarmedCheckPreview(options)??super.toActionCheckPreview(options)}#unarmedCheckPreview(args){if(args.slug==="unarmed"){if(args.actor){const options={actor:args.actor,buildContext:__name2(()=>({rollOptions:args.rollOptions}),"buildContext")},data={rollOptions:args.rollOptions,slug:args.slug},statistic=unarmedStrikeWithHighestModifier(options,data)?.statistic;if(statistic)return{label:game.i18n.localize("PF2E.TraitUnarmed"),modifier:statistic.totalModifier,slug:args.slug}}return{label:game.i18n.localize("PF2E.TraitUnarmed"),slug:args.slug}}return null}}class EscapeAction extends SingleCheckAction{static{__name(this,"EscapeAction")}static{__name2(this,"EscapeAction")}constructor(){super({cost:1,description:"PF2E.Actions.Escape.Description",difficultyClass:"athletics",img:"icons/skills/movement/figure-running-gray.webp",name:"PF2E.Actions.Escape.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Escape.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Escape.Notes.success"},{outcome:["criticalFailure"],text:"PF2E.Actions.Escape.Notes.criticalFailure"}],section:"basic",slug:"escape",statistic:["unarmed","acrobatics","athletics"],traits:["attack"]})}toActionVariant(data){return new EscapeActionVariant(this,data)}}const action$u=new EscapeAction,interact=new SimpleAction({cost:1,description:"PF2E.Actions.Interact.Description",name:"PF2E.Actions.Interact.Title",section:"basic",slug:"interact",traits:["manipulate"]}),leap=new SimpleAction({cost:1,description:"PF2E.Actions.Leap.Description",name:"PF2E.Actions.Leap.Title",section:"basic",slug:"leap",traits:["move"]}),ready=new SimpleAction({cost:2,description:"PF2E.Actions.Ready.Description",name:"PF2E.Actions.Ready.Title",section:"basic",slug:"ready",traits:["concentrate"]}),release=new SimpleAction({cost:"free",description:"PF2E.Actions.Release.Description",name:"PF2E.Actions.Release.Title",section:"basic",slug:"release",traits:["manipulate"]});function seek(options){const slug=options?.skill??"perception",rollOptions=["action:seek"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:"PF2E.Actions.Seek.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["concentrate","secret"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Seek","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Seek","success")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(seek,"seek"),__name2(seek,"seek");const action$t=new SingleCheckAction({cost:1,description:"PF2E.Actions.Seek.Description",img:"icons/skills/movement/arrow-upward-yellow.webp",name:"PF2E.Actions.Seek.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Seek.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Seek.Notes.success"}],section:"basic",slug:"seek",statistic:"perception",traits:["concentrate","secret"]});function senseMotive(options){const slug=options?.skill??"perception",rollOptions=["action:sense-motive"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:"PF2E.Actions.SenseMotive.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["concentrate","secret"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"deception",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.SenseMotive","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.SenseMotive","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.SenseMotive","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.SenseMotive","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(senseMotive,"senseMotive"),__name2(senseMotive,"senseMotive");const action$s=new SingleCheckAction({cost:1,description:"PF2E.Actions.SenseMotive.Description",difficultyClass:"deception",img:"icons/skills/movement/arrow-upward-yellow.webp",name:"PF2E.Actions.SenseMotive.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.SenseMotive.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.SenseMotive.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.SenseMotive.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.SenseMotive.Notes.criticalFailure"}],section:"basic",slug:"sense-motive",statistic:"perception",traits:["concentrate","secret"]});class StandActionVariant extends SimpleActionVariant{static{__name(this,"StandActionVariant")}static{__name2(this,"StandActionVariant")}async use(options={}){return super.use(options).then(async results=>{for(const result of results)result.actor.hasCondition("prone")&&await result.actor.toggleCondition("prone");return results})}}class StandAction extends SimpleAction{static{__name(this,"StandAction")}static{__name2(this,"StandAction")}constructor(){super({cost:1,description:"PF2E.Actions.Stand.Description",name:"PF2E.Actions.Stand.Title",section:"basic",slug:"stand",traits:["move"]})}toActionVariant(data){return new StandActionVariant(this,data)}}const stand=new StandAction,step=new SimpleAction({cost:1,description:"PF2E.Actions.Step.Description",name:"PF2E.Actions.Step.Title",section:"basic",slug:"step",traits:["move"]}),stride=new SimpleAction({cost:1,description:"PF2E.Actions.Stride.Description",name:"PF2E.Actions.Stride.Title",section:"basic",slug:"stride",traits:["move"]}),takeCover=new SimpleAction({cost:1,description:"PF2E.Actions.TakeCover.Description",effect:"Compendium.pf2e.other-effects.I9lfZUiCwMiGogVi",img:"systems/pf2e/icons/conditions-2/status_acup.webp",name:"PF2E.Actions.TakeCover.Title",section:"basic",slug:"take-cover"});function tamper(options){const slug=options?.skill??"crafting",rollOptions=["action:tamper"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:"PF2E.Actions.Tamper.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["inventor","manipulate"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"reflex",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Tamper","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Tamper","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Tamper","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(tamper,"tamper"),__name2(tamper,"tamper");const PREFIX$j="PF2E.Actions.IdentifyAlchemy",action$r=new SingleCheckAction({description:`${PREFIX$j}.Description`,name:`${PREFIX$j}.Title`,notes:[{outcome:["criticalSuccess","success"],text:`${PREFIX$j}.Notes.success`},{outcome:["failure"],text:`${PREFIX$j}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$j}.Notes.criticalFailure`}],section:"skill",slug:"identify-alchemy",statistic:"crafting",traits:["concentrate","exploration","secret"]}),PREFIX$i="PF2E.Actions.CreateADiversion",CREATE_A_DIVERSION_VARIANTS=["distracting-words","gesture","trick"];function createADiversion(options){const{title,traits,variant}=(()=>{const mainTitle=game.i18n.localize(`${PREFIX$i}.Title`);switch(options?.variant){case"distracting-words":return{title:mainTitle+" - "+game.i18n.localize(`${PREFIX$i}.DistractingWords.Title`),traits:["auditory","linguistic","mental"],variant:options.variant};case"gesture":return{title:mainTitle+" - "+game.i18n.localize(`${PREFIX$i}.Gesture.Title`),traits:["manipulate","mental"],variant:options.variant};case"trick":return{title:mainTitle+" - "+game.i18n.localize(`${PREFIX$i}.Trick.Title`),traits:["manipulate","mental"],variant:options.variant};default:{const variant2=options?.variant?`'${options.variant}'`:"null",variants=CREATE_A_DIVERSION_VARIANTS.map(v=>`'${v}'`).join(", ");throw ui.notifications.error(game.i18n.format(`${PREFIX$i}.Warning.UnknownVariant`,{variant:variant2,variants})),new Error(`Unknown variant ${variant2} for Create a Diversion, use one of ${variants}.`)}}})(),slug=options?.skill??"deception",rollOptions=["action:create-a-diversion",`action:create-a-diversion:${variant}`],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits,event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"perception",extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$i}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.outcomesNote(selector,`${PREFIX$i}.Notes.failure`,["failure","criticalFailure"])],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(createADiversion,"createADiversion"),__name2(createADiversion,"createADiversion");const action$q=new SingleCheckAction({cost:1,description:`${PREFIX$i}.Description`,difficultyClass:"perception",img:"icons/skills/social/theft-pickpocket-bribery-brown.webp",name:`${PREFIX$i}.Title`,notes:[{outcome:["criticalSuccess","success"],text:`${PREFIX$i}.Notes.success`},{outcome:["criticalFailure","failure"],text:`${PREFIX$i}.Notes.failure`}],section:"skill",slug:"create-a-diversion",statistic:"deception",traits:["mental"],variants:[{name:`${PREFIX$i}.DistractingWords.Title`,slug:"distracting-words",traits:["auditory","linguistic","mental"]},{name:`${PREFIX$i}.Gesture.Title`,slug:"gesture",traits:["manipulate","mental"]},{name:`${PREFIX$i}.Trick.Title`,slug:"trick",traits:["manipulate","mental"]}]}),PREFIX$h="PF2E.Actions.Feint";function feint(options){const slug=options?.skill??"deception",rollOptions=["action:feint"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$h}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["mental"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"perception",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,PREFIX$h,"criticalSuccess"),ActionMacroHelpers.note(selector,PREFIX$h,"success"),ActionMacroHelpers.note(selector,PREFIX$h,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(feint,"feint"),__name2(feint,"feint");const action$p=new SingleCheckAction({cost:1,description:`${PREFIX$h}.Description`,difficultyClass:"perception",img:"icons/skills/social/theft-pickpocket-bribery-brown.webp",name:`${PREFIX$h}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$h}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$h}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$h}.Notes.criticalFailure`}],section:"skill",slug:"feint",statistic:"deception",traits:["mental"]}),PREFIX$g="PF2E.Actions.Impersonate";function impersonate(options){const slug=options?.skill??"deception",rollOptions=["action:impersonate"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:`${PREFIX$g}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["concentrate","exploration","manipulate","secret"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"perception",extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$g}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.note(selector,PREFIX$g,"failure"),ActionMacroHelpers.note(selector,PREFIX$g,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(impersonate,"impersonate"),__name2(impersonate,"impersonate");const action$o=new SingleCheckAction({description:`${PREFIX$g}.Description`,difficultyClass:"perception",img:"icons/skills/social/theft-pickpocket-bribery-brown.webp",name:`${PREFIX$g}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX$g}.Notes.success`},{outcome:["failure"],text:`${PREFIX$g}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$g}.Notes.criticalFailure`}],section:"skill",slug:"impersonate",statistic:"deception",traits:["concentrate","exploration","manipulate","secret"]}),PREFIX$f="PF2E.Actions.Lie";function lie(options){const slug=options?.skill??"deception",rollOptions=["action:lie"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:`${PREFIX$f}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["auditory","concentrate","linguistic","mental","secret"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"perception",extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$f}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.outcomesNote(selector,`${PREFIX$f}.Notes.failure`,["failure","criticalFailure"])],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(lie,"lie"),__name2(lie,"lie");const action$n=new SingleCheckAction({description:`${PREFIX$f}.Description`,difficultyClass:"perception",img:"icons/skills/social/theft-pickpocket-bribery-brown.webp",name:`${PREFIX$f}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX$f}.Notes.success`},{outcome:["failure","criticalFailure"],text:`${PREFIX$f}.Notes.failure`}],section:"skill",slug:"lie",statistic:"deception",traits:["auditory","concentrate","linguistic","mental","secret"]});function bonMot(options){const slug=options?.skill??"diplomacy",rollOptions=["action:bon-mot"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:"PF2E.Actions.BonMot.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["auditory","concentrate","emotion","linguistic","mental"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"will",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.BonMot","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.BonMot","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.BonMot","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(bonMot,"bonMot"),__name2(bonMot,"bonMot");const PREFIX$e="PF2E.Actions.GatherInformation";function gatherInformation(options){const slug=options?.skill??"diplomacy",rollOptions=["action:gather-information"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:`${PREFIX$e}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["exploration","secret"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$e}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.note(selector,PREFIX$e,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(gatherInformation,"gatherInformation"),__name2(gatherInformation,"gatherInformation");const action$m=new SingleCheckAction({description:`${PREFIX$e}.Description`,img:"icons/skills/social/diplomacy-handshake-blue.webp",name:`${PREFIX$e}.Title`,notes:[{outcome:["criticalSuccess","success"],text:`${PREFIX$e}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$e}.Notes.criticalFailure`}],sampleTasks:{untrained:`${PREFIX$e}.SampleTasks.Untrained`,trained:`${PREFIX$e}.SampleTasks.Trained`,expert:`${PREFIX$e}.SampleTasks.Expert`,master:`${PREFIX$e}.SampleTasks.Master`,legendary:`${PREFIX$e}.SampleTasks.Legendary`},section:"skill",slug:"gather-information",statistic:"diplomacy",traits:["exploration","secret"]}),PREFIX$d="PF2E.Actions.MakeAnImpression";function makeAnImpression(options){const slug=options?.skill??"diplomacy",rollOptions=["action:make-an-impression"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.MakeAnImpression.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["auditory","concentrate","exploration","linguistic","mental"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"will",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.MakeAnImpression","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.MakeAnImpression","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.MakeAnImpression","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(makeAnImpression,"makeAnImpression"),__name2(makeAnImpression,"makeAnImpression");const action$l=new SingleCheckAction({description:`${PREFIX$d}.Description`,difficultyClass:"will",img:"icons/skills/social/diplomacy-peace-alliance.webp",name:`${PREFIX$d}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$d}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$d}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$d}.Notes.criticalFailure`}],section:"skill",slug:"make-an-impression",statistic:"diplomacy",traits:["auditory","concentrate","exploration","linguistic","mental"]}),PREFIX$c="PF2E.Actions.Request";function request(options){const slug=options?.skill??"diplomacy",rollOptions=["action:request"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$c}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["auditory","concentrate","linguistic","mental"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Request","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Request","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Request","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.Request","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(request,"request"),__name2(request,"request");const action$k=new SingleCheckAction({cost:1,description:`${PREFIX$c}.Description`,img:"icons/skills/social/diplomacy-peace-alliance.webp",name:`${PREFIX$c}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$c}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$c}.Notes.success`},{outcome:["failure"],text:`${PREFIX$c}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$c}.Notes.criticalFailure`}],section:"skill",slug:"request",statistic:"diplomacy",traits:["auditory","concentrate","linguistic","mental"]}),affixATalisman=new SimpleAction({description:"PF2E.Actions.AffixATalisman.Description",name:"PF2E.Actions.AffixATalisman.Title",slug:"affix-a-talisman",traits:["exploration","manipulate"]});function avoidNotice(options){const slug=options?.skill??"stealth",rollOptions=["action:avoid-notice"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.AvoidNotice.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["exploration"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.AvoidNotice","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.AvoidNotice","success")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(avoidNotice,"avoidNotice"),__name2(avoidNotice,"avoidNotice");const action$j=new SingleCheckAction({description:"PF2E.Actions.AvoidNotice.Description",img:"systems/pf2e/icons/conditions/unnoticed.webp",name:"PF2E.Actions.AvoidNotice.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.AvoidNotice.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.AvoidNotice.Notes.success"}],slug:"avoid-notice",statistic:"stealth",traits:["exploration"]});function senseDirection(options){const modifiers=[new Modifier({label:"PF2E.Actions.SenseDirection.Modifier.NoCompass",modifier:-2,predicate:[{not:"compass-in-possession"}],type:"item"})].concat(options?.modifiers??[]),slug=options?.skill??"survival",rollOptions=["action:sense-direction"];ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.SenseDirection.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["exploration","secret"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.SenseDirection","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.SenseDirection","success")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(senseDirection,"senseDirection"),__name2(senseDirection,"senseDirection");const action$i=new SingleCheckAction({description:"PF2E.Actions.SenseDirection.Description",img:"icons/skills/movement/arrow-upward-yellow.webp",modifiers:[{label:"PF2E.Actions.SenseDirection.Modifier.NoCompass",modifier:-2,predicate:[{not:"compass-in-possession"}],type:"item"}],name:"PF2E.Actions.SenseDirection.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.SenseDirection.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.SenseDirection.Notes.success"}],sampleTasks:{untrained:"PF2E.Actions.SenseDirection.SampleTasks.Untrained",trained:"PF2E.Actions.SenseDirection.SampleTasks.Trained",expert:"PF2E.Actions.SenseDirection.SampleTasks.Expert",master:"PF2E.Actions.SenseDirection.SampleTasks.Master",legendary:"PF2E.Actions.SenseDirection.SampleTasks.Legendary"},slug:"sense-direction",statistic:"survival",traits:["exploration","secret"]});function track(options){const slug=options?.skill??"survival",rollOptions=["action:track"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.Track.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["concentrate","exploration","move"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Track","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Track","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.Track","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(track,"track"),__name2(track,"track");const action$h=new SingleCheckAction({description:"PF2E.Actions.Track.Description",img:"icons/skills/movement/arrows-up-trio-red.webp",name:"PF2E.Actions.Track.Title",notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.Track.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Track.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Track.Notes.criticalFailure"}],sampleTasks:{untrained:"PF2E.Actions.Track.SampleTasks.Untrained",trained:"PF2E.Actions.Track.SampleTasks.Trained",expert:"PF2E.Actions.Track.SampleTasks.Expert",master:"PF2E.Actions.Track.SampleTasks.Master",legendary:"PF2E.Actions.Track.SampleTasks.Legendary"},slug:"track",statistic:"survival",traits:["concentrate","exploration","move"]});function decipherWriting(options){if(!options?.skill){ui.notifications.warn(game.i18n.localize("PF2E.Actions.DecipherWriting.Warning.NoSkill"));return}const{skill:slug}=options,rollOptions=["action:decipher-writing",`action:decipher-writing:${slug}`],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.DecipherWriting.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["concentrate","exploration","secret"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.DecipherWriting","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.DecipherWriting","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.DecipherWriting","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.DecipherWriting","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(decipherWriting,"decipherWriting"),__name2(decipherWriting,"decipherWriting");class DecipherWritingActionVariant extends SingleCheckActionVariant{static{__name(this,"DecipherWritingActionVariant")}static{__name2(this,"DecipherWritingActionVariant")}async use(options){if(!options?.statistic)throw new Error(game.i18n.localize("PF2E.Actions.DecipherWriting.Warning.NoSkill"));const rollOption=`action:decipher-writing:${options.statistic}`;return options.rollOptions??=[],options.rollOptions.includes(rollOption)||options.rollOptions.push(rollOption),super.use(options)}}class DecipherWritingAction extends SingleCheckAction{static{__name(this,"DecipherWritingAction")}static{__name2(this,"DecipherWritingAction")}constructor(){super({description:"PF2E.Actions.DecipherWriting.Description",img:"icons/skills/social/diplomacy-writing-letter.webp",name:"PF2E.Actions.DecipherWriting.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.DecipherWriting.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.DecipherWriting.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.DecipherWriting.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.DecipherWriting.Notes.criticalFailure"}],sampleTasks:{trained:"PF2E.Actions.DecipherWriting.SampleTasks.Trained",expert:"PF2E.Actions.DecipherWriting.SampleTasks.Expert",master:"PF2E.Actions.DecipherWriting.SampleTasks.Master",legendary:"PF2E.Actions.DecipherWriting.SampleTasks.Legendary"},section:"skill",slug:"decipher-writing",statistic:["arcana","occultism","religion","society"],traits:["concentrate","exploration","secret"]})}toActionVariant(data){return new DecipherWritingActionVariant(this,data)}}const action$g=new DecipherWritingAction,PREFIX$b="PF2E.Actions.IdentifyMagic";class IdentifyMagicActionVariant extends SingleCheckActionVariant{static{__name(this,"IdentifyMagicActionVariant")}static{__name2(this,"IdentifyMagicActionVariant")}async use(options){if(!options?.statistic)return Promise.reject(game.i18n.localize(`${PREFIX$b}.Warning.NoStatistic`));const rollOption=`action:identify-magic:${options.statistic}`;return options.rollOptions??=[],options.rollOptions.includes(rollOption)||options.rollOptions.push(rollOption),super.use(options)}}class IdentifyMagicAction extends SingleCheckAction{static{__name(this,"IdentifyMagicAction")}static{__name2(this,"IdentifyMagicAction")}constructor(){super({description:`${PREFIX$b}.Description`,name:`${PREFIX$b}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$b}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$b}.Notes.success`},{outcome:["failure"],text:`${PREFIX$b}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$b}.Notes.criticalFailure`}],section:"skill",slug:"identify-magic",statistic:["arcana","nature","occultism","religion"],traits:["concentrate","exploration","secret"]})}toActionVariant(data){return new IdentifyMagicActionVariant(this,data)}}const identifyMagic=new IdentifyMagicAction,PREFIX$a="PF2E.Actions.LearnASpell";class LearnASpellActionVariant extends SingleCheckActionVariant{static{__name(this,"LearnASpellActionVariant")}static{__name2(this,"LearnASpellActionVariant")}async use(options){if(!options?.statistic)return Promise.reject(game.i18n.localize(`${PREFIX$a}.Warning.NoSkill`));const rollOption=`action:learn-a-spell:${options.statistic}`;return options.rollOptions??=[],options.rollOptions.includes(rollOption)||options.rollOptions.push(rollOption),super.use(options)}}class LearnASpellAction extends SingleCheckAction{static{__name(this,"LearnASpellAction")}static{__name2(this,"LearnASpellAction")}constructor(){super({description:`${PREFIX$a}.Description`,name:`${PREFIX$a}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$a}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$a}.Notes.success`},{outcome:["failure"],text:`${PREFIX$a}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$a}.Notes.criticalFailure`}],section:"skill",slug:"learn-a-spell",statistic:["arcana","nature","occultism","religion"],traits:["concentrate","exploration"]})}toActionVariant(data){return new LearnASpellActionVariant(this,data)}}const learnASpell=new LearnASpellAction,PREFIX$9="PF2E.Actions.RecallKnowledge";class RecallKnowledgeActionVariant extends SingleCheckActionVariant{static{__name(this,"RecallKnowledgeActionVariant")}static{__name2(this,"RecallKnowledgeActionVariant")}async use(options){if(!options?.statistic)throw new Error(game.i18n.localize(`${PREFIX$9}.Warning.NoSkill`));const rollOption=`action:recall-knowledge:${options.statistic}`;if(options.rollOptions??=[],options.rollOptions.includes(rollOption)||options.rollOptions.push(rollOption),!options.difficultyClass){const target=options.target instanceof ActorPF2e?options.target:options.target instanceof TokenPF2e?options.target.actor:ActionMacroHelpers.target()?.actor;if(target instanceof NPCPF2e&&objectHasKey(CONFIG.PF2E.skills,options.statistic)){const identification=target.identificationDCs;identification.skills.includes(options.statistic)&&(options.difficultyClass={value:identification.standard.dc,visible:!1})}}return super.use(options)}}class RecallKnowledgeAction extends SingleCheckAction{static{__name(this,"RecallKnowledgeAction")}static{__name2(this,"RecallKnowledgeAction")}constructor(){super({cost:1,description:`${PREFIX$9}.Description`,name:`${PREFIX$9}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$9}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$9}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$9}.Notes.criticalFailure`}],sampleTasks:{untrained:`${PREFIX$9}.SampleTasks.Untrained`,trained:`${PREFIX$9}.SampleTasks.Trained`,expert:`${PREFIX$9}.SampleTasks.Expert`,master:`${PREFIX$9}.SampleTasks.Master`,legendary:`${PREFIX$9}.SampleTasks.Legendary`},section:"skill",slug:"recall-knowledge",statistic:["arcana","crafting","medicine","nature","occultism","religion","society"],traits:["concentrate","secret"]})}toActionVariant(data){return new RecallKnowledgeActionVariant(this,data)}}const recallKnowledge=new RecallKnowledgeAction;function subsist(options){if(!options?.skill){ui.notifications.warn(game.i18n.localize("PF2E.Actions.Subsist.Warning.NoSkill"));return}const modifiers=[new Modifier({label:"PF2E.Actions.Subsist.AfterExplorationPenalty",modifier:-5,predicate:["action:subsist:after-exploration"]})].concat(options?.modifiers??[]),{skill:slug}=options,rollOptions=["action:subsist",`action:subsist:${slug}`];ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.Subsist.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["downtime"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Subsist","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Subsist","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Subsist","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.Subsist","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(subsist,"subsist"),__name2(subsist,"subsist");class SubsistActionVariant extends SingleCheckActionVariant{static{__name(this,"SubsistActionVariant")}static{__name2(this,"SubsistActionVariant")}async use(options={}){if(!options?.statistic)throw new Error(game.i18n.localize("PF2E.Actions.Subsist.Warning.NoSkill"));const rollOption=`action:subsist:${options.statistic}`;return options.rollOptions??=[],options.rollOptions.includes(rollOption)||options.rollOptions.push(rollOption),super.use(options)}}class SubsistAction extends SingleCheckAction{static{__name(this,"SubsistAction")}static{__name2(this,"SubsistAction")}constructor(){super({description:"PF2E.Actions.Subsist.Description",img:"icons/environment/settlement/city-hall.webp",modifiers:[{label:"PF2E.Actions.Subsist.AfterExplorationPenalty",modifier:-5,predicate:["action:subsist:after-exploration"]}],name:"PF2E.Actions.Subsist.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Subsist.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Subsist.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Subsist.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Subsist.Notes.criticalFailure"}],sampleTasks:{untrained:"PF2E.Actions.Subsist.SampleTasks.Untrained",trained:"PF2E.Actions.Subsist.SampleTasks.Trained",expert:"PF2E.Actions.Subsist.SampleTasks.Expert",master:"PF2E.Actions.Subsist.SampleTasks.Master",legendary:"PF2E.Actions.Subsist.SampleTasks.Legendary"},section:"skill",slug:"subsist",statistic:["society","survival"],traits:["downtime"]})}toActionVariant(data){return new SubsistActionVariant(this,data)}}const action$f=new SubsistAction;function coerce(options){const slug=options?.skill??"intimidation",rollOptions=["action:coerce"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.Coerce.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["auditory","concentrate","emotion","exploration","linguistic","mental"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"will",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Coerce","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Coerce","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.Coerce","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.Coerce","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(coerce,"coerce"),__name2(coerce,"coerce");const action$e=new SingleCheckAction({description:"PF2E.Actions.Coerce.Description",difficultyClass:"will",img:"icons/skills/social/intimidation-impressing.webp",name:"PF2E.Actions.Coerce.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Coerce.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Coerce.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.Coerce.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.Coerce.Notes.criticalFailure"}],section:"skill",slug:"coerce",statistic:"intimidation",traits:["auditory","concentrate","emotion","exploration","linguistic","mental"]});function demoralize(options){const slug=options?.skill??"intimidation",rollOptions=["action:demoralize"],modifiers=[new Modifier({label:"PF2E.Actions.Demoralize.Unintelligible",modifier:-4,predicate:["action:demoralize:unintelligible"],type:"circumstance"})].concat(options?.modifiers??[]);ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:"PF2E.Actions.Demoralize.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["auditory","concentrate","emotion","fear","mental"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"will",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.Demoralize","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.Demoralize","success")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(demoralize,"demoralize"),__name2(demoralize,"demoralize");const action$d=new SingleCheckAction({cost:1,description:"PF2E.Actions.Demoralize.Description",difficultyClass:"will",img:"icons/skills/social/intimidation-impressing.webp",modifiers:[{label:"PF2E.Actions.Demoralize.Unintelligible",modifier:-4,predicate:["action:demoralize:unintelligible"],type:"circumstance"}],name:"PF2E.Actions.Demoralize.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.Demoralize.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.Demoralize.Notes.success"}],section:"skill",slug:"demoralize",statistic:"intimidation",traits:["auditory","concentrate","emotion","fear","mental"]}),PREFIX$8="PF2E.Actions.AdministerFirstAid",ADMINISTER_FIRST_AID_VARIANTS=["stabilize","stop-bleeding"];function stabilizeDifficultyClass(target){if(!target?.isOfType("creature"))return null;const{dying}=target.attributes;if(!dying?.value)throw new Error(game.i18n.localize(`${PREFIX$8}.Warning.TargetNotDying`));const dcModifier=new Modifier({slug:"dying-recovery",label:"PF2E.ModifierTitle",modifier:5+dying.recoveryDC+dying.value-10});return new Statistic(target,{slug:"administer-first-aid",label:`${PREFIX$8}.Stabilize.Title`,dc:{label:`${PREFIX$8}.Stabilize.DifficultyClass.Label`,modifiers:[dcModifier]}}).dc}__name(stabilizeDifficultyClass,"stabilizeDifficultyClass"),__name2(stabilizeDifficultyClass,"stabilizeDifficultyClass");function administerFirstAid(options){const{notes,title,variant}=(()=>{const mainTitle=game.i18n.localize(`${PREFIX$8}.Title`);switch(options?.variant){case"stabilize":return{notes:{criticalFailure:`${PREFIX$8}.Stabilize.Notes.criticalFailure`,success:`${PREFIX$8}.Stabilize.Notes.success`},title:mainTitle+" - "+game.i18n.localize(`${PREFIX$8}.Stabilize.Title`),variant:options.variant};case"stop-bleeding":return{notes:{criticalFailure:`${PREFIX$8}.StopBleeding.Notes.criticalFailure`,success:`${PREFIX$8}.StopBleeding.Notes.success`},title:mainTitle+" - "+game.i18n.localize(`${PREFIX$8}.StopBleeding.Title`),variant:options.variant};default:{const variant2=options?.variant?`'${options.variant}'`:"null",variants=ADMINISTER_FIRST_AID_VARIANTS.map(v=>`'${v}'`).join(", "),error=`${PREFIX$8}.Warning.UnknownVariant`;throw ui.notifications.error(game.i18n.format(error,{variant:variant2,variants})),new Error(`Unknown variant ${variant2} for Administer First Aid, use one of ${variants}.`)}}})(),slug=options?.skill??"medicine",rollOptions=["action:administer-first-aid",`action:administer-first-aid:${variant}`],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"D",title,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["manipulate"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??(target=>{if(variant==="stabilize"&&target)try{return stabilizeDifficultyClass(target)}catch(error){if(error instanceof Error)ui.notifications.warn(error.message);else throw error}return null}),extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,notes.success,["success","criticalSuccess"]),ActionMacroHelpers.outcomesNote(selector,notes.criticalFailure,["criticalFailure"])],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(administerFirstAid,"administerFirstAid"),__name2(administerFirstAid,"administerFirstAid");class AdministerFirstAidAction extends SingleCheckAction{static{__name(this,"AdministerFirstAidAction")}static{__name2(this,"AdministerFirstAidAction")}constructor(){super({cost:2,description:`${PREFIX$8}.Description`,img:"icons/skills/wounds/blood-cells-red.webp",name:`${PREFIX$8}.Title`,section:"skill",slug:"administer-first-aid",statistic:"medicine",traits:["manipulate"],variants:[{description:`${PREFIX$8}.Stabilize.Description`,name:`${PREFIX$8}.Stabilize.Title`,notes:[{outcome:["criticalSuccess","success"],text:`${PREFIX$8}.Stabilize.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$8}.Stabilize.Notes.criticalFailure`}],slug:"stabilize"},{description:`${PREFIX$8}.StopBleeding.Description`,name:`${PREFIX$8}.StopBleeding.Title`,notes:[{outcome:["criticalSuccess","success"],text:`${PREFIX$8}.StopBleeding.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$8}.StopBleeding.Notes.criticalFailure`}],slug:"stop-bleeding"}]})}}const action$c=new AdministerFirstAidAction;function treatDisease(options){const slug=options?.skill??"medicine",rollOptions=["action:treat-disease"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.TreatDisease.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["downtime","manipulate"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.TreatDisease","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.TreatDisease","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.TreatDisease","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(treatDisease,"treatDisease"),__name2(treatDisease,"treatDisease");const action$b=new SingleCheckAction({description:"PF2E.Actions.TreatDisease.Description",img:"systems/pf2e/icons/effects/treat-disease.webp",name:"PF2E.Actions.TreatDisease.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.TreatDisease.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.TreatDisease.Notes.success"},{outcome:["criticalFailure"],text:"PF2E.Actions.TreatDisease.Notes.criticalFailure"}],section:"skill",slug:"treat-disease",statistic:"medicine",traits:["downtime","manipulate"]});function treatPoison(options){const slug=options?.skill??"medicine",rollOptions=["action:treat-poison"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:"PF2E.Actions.TreatPoison.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["manipulate"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.TreatPoison","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.TreatPoison","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.TreatPoison","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(treatPoison,"treatPoison"),__name2(treatPoison,"treatPoison");const action$a=new SingleCheckAction({cost:1,description:"PF2E.Actions.TreatPoison.Description",img:"systems/pf2e/icons/effects/treat-poison.webp",name:"PF2E.Actions.TreatPoison.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.TreatPoison.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.TreatPoison.Notes.success"},{outcome:["criticalFailure"],text:"PF2E.Actions.TreatPoison.Notes.criticalFailure"}],section:"skill",slug:"treat-poison",statistic:"medicine",traits:["manipulate"]}),PREFIX$7="PF2E.Actions.CommandAnAnimal";function commandAnAnimal(options){const slug=options?.skill??"nature",rollOptions=["action:command-an-animal"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$7}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["auditory","concentrate"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"will",extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$7}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.note(selector,PREFIX$7,"failure"),ActionMacroHelpers.note(selector,PREFIX$7,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(commandAnAnimal,"commandAnAnimal"),__name2(commandAnAnimal,"commandAnAnimal");const action$9=new SingleCheckAction({cost:1,description:`${PREFIX$7}.Description`,difficultyClass:"will",img:"icons/creatures/mammals/goat-horned-blue.webp",name:`${PREFIX$7}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX$7}.Notes.success`},{outcome:["failure"],text:`${PREFIX$7}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$7}.Notes.criticalFailure`}],section:"skill",slug:"command-an-animal",statistic:"nature",traits:["auditory","concentrate"]}),PREFIX$6="PF2E.Actions.Perform",PERFORM_VARIANT_TRAITS={acting:["auditory","linguistic","visual"],comedy:["auditory","linguistic","visual"],dance:["move","visual"],keyboards:["auditory","manipulate"],oratory:["auditory","linguistic"],percussion:["auditory","manipulate"],singing:["auditory","linguistic"],strings:["auditory","manipulate"],winds:["auditory","manipulate"]};function perform(options){const traits=PERFORM_VARIANT_TRAITS[options?.variant??""];if(!traits){const msg=game.i18n.format(`${PREFIX$6}.Warning.UnknownVariant`,{variant:options.variant});ui.notifications.warn(msg);return}const slug=options?.skill??"performance",rollOptions=["action:perform",`action:perform:${options.variant}`],modifiers=options?.modifiers,mainTitle=`${PREFIX$6}.Title`,subtitle=`${PREFIX$6}.${options.variant.charAt(0).toUpperCase()}${options.variant.slice(1)}.Title`;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"1",title:`${game.i18n.localize(mainTitle)} - ${game.i18n.localize(subtitle)}`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["concentrate",...traits].sort(),event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"will",extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,PREFIX$6,"criticalSuccess"),ActionMacroHelpers.note(selector,PREFIX$6,"success"),ActionMacroHelpers.note(selector,PREFIX$6,"failure"),ActionMacroHelpers.note(selector,PREFIX$6,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(perform,"perform"),__name2(perform,"perform");const action$8=new SingleCheckAction({cost:1,description:`${PREFIX$6}.Description`,img:"systems/pf2e/icons/conditions/dazzled.webp",name:`${PREFIX$6}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$6}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$6}.Notes.success`},{outcome:["failure"],text:`${PREFIX$6}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$6}.Notes.criticalFailure`}],sampleTasks:{untrained:`${PREFIX$6}.SampleTasks.Untrained`,trained:`${PREFIX$6}.SampleTasks.Trained`,expert:`${PREFIX$6}.SampleTasks.Expert`,master:`${PREFIX$6}.SampleTasks.Master`,legendary:`${PREFIX$6}.SampleTasks.Legendary`},section:"skill",slug:"perform",statistic:"performance",traits:["concentrate"],variants:[{name:`${PREFIX$6}.Acting.Title`,slug:"acting",traits:["auditory","concentrate","linguistic","visual"]},{name:`${PREFIX$6}.Comedy.Title`,slug:"comedy",traits:["auditory","concentrate","linguistic","visual"]},{name:`${PREFIX$6}.Dance.Title`,slug:"dance",traits:["concentrate","move","visual"]},{name:`${PREFIX$6}.Keyboards.Title`,slug:"keyboards",traits:["auditory","concentrate","manipulate"]},{name:`${PREFIX$6}.Oratory.Title`,slug:"oratory",traits:["auditory","concentrate","linguistic"]},{name:`${PREFIX$6}.Percussion.Title`,slug:"percussion",traits:["auditory","concentrate","manipulate"]},{name:`${PREFIX$6}.Singing.Title`,slug:"singing",traits:["auditory","concentrate","linguistic"]},{name:`${PREFIX$6}.Strings.Title`,slug:"strings",traits:["auditory","concentrate","manipulate"]},{name:`${PREFIX$6}.Winds.Title`,slug:"winds",traits:["auditory","concentrate","manipulate"]}]});async function createForgeryCallback(result,callback){const societyDC=(()=>{if(result.actor instanceof CreaturePF2e){const systemFlags=result.message?.flags.pf2e,modifiers=systemFlags.modifiers.filter(modifier=>modifier.enabled).map(modifier=>({...modifier,predicate:[]})).map(modifier=>new Modifier(modifier));return result.actor.skills.society.extend({slug:result.actor.skills.society.slug,modifiers}).withRollOptions({extraRollOptions:systemFlags.context.options,origin:result.actor}).dc}return null})(),gmNotes=["criticalSuccess","success"].includes(result.outcome??"")?game.i18n.format("PF2E.Actions.CreateForgery.ForgedDocument.SuccessGmNote",{societyDC:societyDC?.value??null}):["criticalFailure","failure"].includes(result.outcome??"")?game.i18n.format("PF2E.Actions.CreateForgery.ForgedDocument.FailureGmNote",{failure:game.i18n.localize("PF2E.Actions.CreateForgery.Notes.failure"),success:game.i18n.localize("PF2E.Actions.CreateForgery.Notes.success"),total:result.roll.total}):"";await Item.create({img:"systems/pf2e/icons/equipment/adventuring-gear/scroll-case.webp",name:game.i18n.localize("PF2E.Actions.CreateForgery.ForgedDocument.Name"),type:"equipment",system:{description:{gm:gmNotes,value:game.i18n.format("PF2E.Actions.CreateForgery.ForgedDocument.Description",{societyDC:societyDC?.value??null})}}},{parent:result.actor});const notification=game.i18n.format("PF2E.Actions.CreateForgery.ForgedDocumentCreatedNotification",{name:result.actor.name});ui.notifications.info(notification),callback?.(result)}__name(createForgeryCallback,"createForgeryCallback"),__name2(createForgeryCallback,"createForgeryCallback");function createForgery(options){const modifiers=[new Modifier({label:"PF2E.Actions.CreateForgery.UnspecificHandwriting",modifier:4,predicate:["action:create-forgery:unspecific-handwriting"],type:"circumstance"})].concat(options?.modifiers??[]),slug=options?.skill??"society",rollOptions=["action:create-forgery"];return ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph,title:"PF2E.Actions.CreateForgery.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["downtime","secret"],event:options.event,callback:__name2(async result=>createForgeryCallback(result,options?.callback),"callback"),difficultyClass:options.difficultyClass??{value:20},extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.CreateForgery","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.CreateForgery","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.CreateForgery","failure"),ActionMacroHelpers.note(selector,"PF2E.Actions.CreateForgery","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(createForgery,"createForgery"),__name2(createForgery,"createForgery");class CreateForgeryActionVariant extends SingleCheckActionVariant{static{__name(this,"CreateForgeryActionVariant")}static{__name2(this,"CreateForgeryActionVariant")}async use(options={}){return super.use(options).then(async results=>{for(const result of results)await createForgeryCallback(result);return results})}}class CreateForgeryAction extends SingleCheckAction{static{__name(this,"CreateForgeryAction")}static{__name2(this,"CreateForgeryAction")}constructor(){super({description:"PF2E.Actions.CreateForgery.Description",difficultyClass:{value:20},img:"icons/skills/social/theft-pickpocket-bribery-brown.webp",modifiers:[{label:"PF2E.Actions.CreateForgery.UnspecificHandwriting",modifier:4,predicate:["action:create-forgery:unspecific-handwriting"],type:"circumstance"}],name:"PF2E.Actions.CreateForgery.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.CreateForgery.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.CreateForgery.Notes.success"},{outcome:["failure"],text:"PF2E.Actions.CreateForgery.Notes.failure"},{outcome:["criticalFailure"],text:"PF2E.Actions.CreateForgery.Notes.criticalFailure"}],section:"skill",slug:"create-forgery",statistic:"society",traits:["downtime","secret"]})}toActionVariant(data){return new CreateForgeryActionVariant(this,data)}}const action$7=new CreateForgeryAction,arrestAFall=new SingleCheckAction({cost:"reaction",description:"PF2E.Actions.ArrestAFall.Description",difficultyClass:{value:15},name:"PF2E.Actions.ArrestAFall.Title",notes:[{outcome:["success","criticalSuccess"],text:"PF2E.Actions.ArrestAFall.Notes.success"}],section:"specialty-basic",slug:"arrest-a-fall",statistic:["reflex","acrobatics"]}),avertGaze=new SimpleAction({cost:1,description:"PF2E.Actions.AvertGaze.Description",effect:"Compendium.pf2e.other-effects.ZXUOdZqUW22OX3ge",img:"icons/magic/perception/eye-ringed-glow-angry-small-red.webp",name:"PF2E.Actions.AvertGaze.Title",section:"specialty-basic",slug:"avert-gaze"}),burrow=new SimpleAction({cost:1,description:"PF2E.Actions.Burrow.Description",name:"PF2E.Actions.Burrow.Title",section:"specialty-basic",slug:"burrow",traits:["move"]}),dismiss=new SimpleAction({cost:1,description:"PF2E.Actions.Dismiss.Description",name:"PF2E.Actions.Dismiss.Title",section:"specialty-basic",slug:"dismiss",traits:["concentrate"]}),fly=new SimpleAction({cost:1,description:"PF2E.Actions.Fly.Description",name:"PF2E.Actions.Fly.Title",section:"specialty-basic",slug:"fly",traits:["move"]}),PREFIX$5="PF2E.Actions.GrabAnEdge",grabAnEdge=new SingleCheckAction({cost:"reaction",description:`${PREFIX$5}.Description`,name:`${PREFIX$5}.Title`,notes:[{outcome:["criticalSuccess"],text:`${PREFIX$5}.Notes.criticalSuccess`},{outcome:["success"],text:`${PREFIX$5}.Notes.success`},{outcome:["criticalFailure"],text:`${PREFIX$5}.Notes.criticalFailure`}],section:"specialty-basic",slug:"grab-an-edge",statistic:["reflex","acrobatics"],traits:["manipulate"]}),mount=new SimpleAction({cost:1,description:"PF2E.Actions.Mount.Description",name:"PF2E.Actions.Mount.Title",section:"specialty-basic",slug:"mount",traits:["move"]}),pointOut=new SimpleAction({cost:1,description:"PF2E.Actions.PointOut.Description",name:"PF2E.Actions.PointOut.Title",section:"specialty-basic",slug:"point-out",traits:["auditory","manipulate","visual"]}),sustain=new SimpleAction({cost:1,description:"PF2E.Actions.Sustain.Description",name:"PF2E.Actions.Sustain.Title",section:"specialty-basic",slug:"sustain",traits:["concentrate"]}),PREFIX$4="PF2E.Actions.ConcealAnObject";function concealAnObject(options){const slug=options?.skill??"stealth",rollOptions=["action:conceal-an-object"],modifiers=options?.modifiers;return ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$4}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["manipulate","secret"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"perception",extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$4}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.outcomesNote(selector,`${PREFIX$4}.Notes.failure`,["failure","criticalFailure"])],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(concealAnObject,"concealAnObject"),__name2(concealAnObject,"concealAnObject");const action$6=new SingleCheckAction({cost:1,description:`${PREFIX$4}.Description`,difficultyClass:"perception",img:"systems/pf2e/icons/conditions/hidden.webp",name:`${PREFIX$4}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX$4}.Notes.success`},{outcome:["failure","criticalFailure"],text:`${PREFIX$4}.Notes.failure`}],section:"skill",slug:"conceal-an-object",statistic:"stealth",traits:["manipulate","secret"]}),PREFIX$3="PF2E.Actions.Hide";function hide(options){const slug=options?.skill??"stealth",rollOptions=["action:hide"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$3}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["secret"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"perception",extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$3}.Notes.success`,["success","criticalSuccess"])],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(hide,"hide"),__name2(hide,"hide");const action$5=new SingleCheckAction({cost:1,description:`${PREFIX$3}.Description`,difficultyClass:"perception",img:"systems/pf2e/icons/conditions/hidden.webp",name:`${PREFIX$3}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX$3}.Notes.success`}],section:"skill",slug:"hide",statistic:"stealth",traits:["secret"]}),PREFIX$2="PF2E.Actions.Sneak";function sneak(options){const slug=options?.skill??"stealth",rollOptions=["action:sneak"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$2}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["move","secret"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"perception",extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$2}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.note(selector,PREFIX$2,"failure"),ActionMacroHelpers.note(selector,PREFIX$2,"criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(sneak,"sneak"),__name2(sneak,"sneak");const action$4=new SingleCheckAction({cost:1,description:`${PREFIX$2}.Description`,difficultyClass:"perception",img:"systems/pf2e/icons/conditions/hidden.webp",name:`${PREFIX$2}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX$2}.Notes.success`},{outcome:["failure"],text:`${PREFIX$2}.Notes.failure`},{outcome:["criticalFailure"],text:`${PREFIX$2}.Notes.criticalFailure`}],section:"skill",slug:"sneak",statistic:"stealth",traits:["move","secret"]}),PREFIX$1="PF2E.Actions.PalmAnObject";function palmAnObject(options){const slug=options?.skill??"thievery",rollOptions=["action:palm-an-object"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX$1}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["manipulate"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"perception",extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX$1}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.outcomesNote(selector,`${PREFIX$1}.Notes.failure`,["failure","criticalFailure"])],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(palmAnObject,"palmAnObject"),__name2(palmAnObject,"palmAnObject");const action$3=new SingleCheckAction({cost:1,description:`${PREFIX$1}.Description`,difficultyClass:"perception",img:"systems/pf2e/icons/features/classes/thief.webp",name:`${PREFIX$1}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX$1}.Notes.success`},{outcome:["failure","criticalFailure"],text:`${PREFIX$1}.Notes.failure`}],section:"skill",slug:"palm-an-object",statistic:"thievery",traits:["manipulate"]});function disableDevice(options){const slug=options?.skill??"thievery",rollOptions=["action:disable-a-device","action:disable-device"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options?.actors,actionGlyph:options?.glyph??"D",title:"PF2E.Actions.DisableDevice.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["manipulate"],event:options?.event,callback:options?.callback,difficultyClass:options?.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.DisableDevice","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.DisableDevice","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.DisableDevice","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(disableDevice,"disableDevice"),__name2(disableDevice,"disableDevice");const action$2=new SingleCheckAction({cost:2,description:"PF2E.Actions.DisableDevice.Description",img:"systems/pf2e/icons/features/classes/thief.webp",name:"PF2E.Actions.DisableDevice.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.DisableDevice.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.DisableDevice.Notes.success"},{outcome:["criticalFailure"],text:"PF2E.Actions.DisableDevice.Notes.criticalFailure"}],rollOptions:["action:disable-a-device"],section:"skill",slug:"disable-device",statistic:"thievery",traits:["manipulate"]});function pickALock(options){const slug=options?.skill??"thievery",rollOptions=["action:pick-a-lock"],modifiers=options?.modifiers;ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"D",title:"PF2E.Actions.PickALock.Title",checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["manipulate"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass,extraNotes:__name2(selector=>[ActionMacroHelpers.note(selector,"PF2E.Actions.PickALock","criticalSuccess"),ActionMacroHelpers.note(selector,"PF2E.Actions.PickALock","success"),ActionMacroHelpers.note(selector,"PF2E.Actions.PickALock","criticalFailure")],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(pickALock,"pickALock"),__name2(pickALock,"pickALock");const action$1=new SingleCheckAction({cost:2,description:"PF2E.Actions.PickALock.Description",img:"systems/pf2e/icons/features/classes/thief.webp",name:"PF2E.Actions.PickALock.Title",notes:[{outcome:["criticalSuccess"],text:"PF2E.Actions.PickALock.Notes.criticalSuccess"},{outcome:["success"],text:"PF2E.Actions.PickALock.Notes.success"},{outcome:["criticalFailure"],text:"PF2E.Actions.PickALock.Notes.criticalFailure"}],section:"skill",slug:"pick-a-lock",statistic:"thievery",traits:["manipulate"]}),PREFIX="PF2E.Actions.Steal";function steal(options){const modifiers=[new Modifier({label:"PF2E.Actions.Steal.Pocketed",modifier:-5,predicate:["action:steal:pocketed"]})].concat(options?.modifiers??[]),slug=options?.skill??"thievery",rollOptions=["action:steal"];ActionMacroHelpers.simpleRollActionCheck({actors:options.actors,actionGlyph:options.glyph??"A",title:`${PREFIX}.Title`,checkContext:__name2(opts=>ActionMacroHelpers.defaultCheckContext(opts,{modifiers,rollOptions,slug}),"checkContext"),traits:["manipulate"],event:options.event,callback:options.callback,difficultyClass:options.difficultyClass??"perception",extraNotes:__name2(selector=>[ActionMacroHelpers.outcomesNote(selector,`${PREFIX}.Notes.success`,["success","criticalSuccess"]),ActionMacroHelpers.outcomesNote(selector,`${PREFIX}.Notes.failure`,["failure","criticalFailure"])],"extraNotes")}).catch(error=>{throw ui.notifications.error(error.message),error})}__name(steal,"steal"),__name2(steal,"steal");const action=new SingleCheckAction({cost:1,description:`${PREFIX}.Description`,difficultyClass:"perception",img:"systems/pf2e/icons/features/classes/thief.webp",modifiers:[{label:"PF2E.Actions.Steal.Pocketed",modifier:-5,predicate:["action:steal:pocketed"]}],name:`${PREFIX}.Title`,notes:[{outcome:["success","criticalSuccess"],text:`${PREFIX}.Notes.success`},{outcome:["failure","criticalFailure"],text:`${PREFIX}.Notes.failure`}],section:"skill",slug:"steal",statistic:"thievery",traits:["manipulate"]}),ActionMacros={escape,seek,senseMotive,arcaneSlam,tamper,avoidNotice,senseDirection,track,balance,maneuverInFlight,squeeze,tumbleThrough,climb,disarm,forceOpen,grapple,highJump,longJump,reposition,shove,swim,trip,whirlingThrow,craft,repair,createADiversion,feint,impersonate,lie,bonMot,gatherInformation,makeAnImpression,request,decipherWriting,subsist,coerce,demoralize,administerFirstAid,treatDisease,treatPoison,commandAnAnimal,perform,createForgery,concealAnObject,hide,sneak,palmAnObject,disableDevice,pickALock,steal},SystemActions=[action$c,affixATalisman,aid,arrestAFall,avertGaze,action$j,action$I,burrow,action$E,action$e,action$9,action$6,crawl,action$q,action$7,action$g,delay,action$d,action$2,action$D,dismiss,dropProne,action$u,action$p,fly,action$C,action$m,grabAnEdge,action$B,action$5,action$A,action$r,identifyMagic,action$o,interact,leap,learnASpell,action$n,action$z,action$l,action$H,mount,action$3,action$8,action$1,pointOut,ready,recallKnowledge,release,action$y,action$k,action$t,action$i,action$s,action$x,action$4,action$G,stand,action,step,stride,action$f,sustain,action$w,takeCover,action$h,action$b,action$a,action$v,action$F];class EffectTracker{static{__name(this,"EffectTracker")}static{__name2(this,"EffectTracker")}effects=[];auraEffects=new Collection;#insert(effect,duration){if(this.effects.length===0)this.effects.push(effect);else{for(let index2=0;index2<this.effects.length;index2++){const other=this.effects[index2],remaining=other.remainingDuration.remaining;if(!(duration.remaining>remaining)){if(remaining>duration.remaining){this.effects.splice(index2,0,effect);return}else if(!((effect.system.start.initiative??0)>(other.system.start.initiative??0))){if((other.system.start.initiative??0)>(effect.system.start.initiative??0)){this.effects.splice(index2,0,effect);return}else if(other.system.duration.expiry==="turn-start"&&effect.system.duration.expiry==="turn-end"){this.effects.splice(index2,0,effect);return}}}}this.effects.push(effect)}}register(effect){effect.fromAura&&(canvas.ready||!effect.actor.isToken)&&effect.id&&this.auraEffects.set(effect.uuid,effect);const index2=this.effects.findIndex(e2=>e2.id===effect.id),systemData=effect.system,duration=systemData.duration.unit;switch(duration){case"unlimited":case"encounter":{duration==="unlimited"&&(systemData.expired=!1),index2>=0&&index2<this.effects.length&&this.effects.splice(index2,1);return}default:{const duration2=effect.remainingDuration;if(effect.system.expired=duration2.expired,this.effects.length===0||index2<0)this.#insert(effect,duration2);else{const existing=this.effects[index2];duration2.remaining!==existing.remainingDuration.remaining&&(this.effects.splice(index2,1),this.#insert(effect,duration2))}}}}unregister(toRemove){this.effects=this.effects.filter(e2=>e2!==toRemove),this.auraEffects.delete(toRemove.uuid)}async refresh(options={}){if(options.resetItemData){const actors=new Set(this.effects.flatMap(e2=>e2.actor??[]));for(const actor of actors)actor.reset();game.pf2e.effectPanel.refresh()}const actorsToUpdate=new Set(this.effects.filter(e2=>e2.isExpired).map(e2=>e2.actor));if(game.pf2e.settings.automation.removeEffects)for(const actor of actorsToUpdate)await this.#removeExpired(actor)}async#removeExpired(actor){actor.primaryUpdater===game.user&&await actor.deleteEmbeddedDocuments("Item",actor.itemTypes.effect.filter(e2=>e2.isExpired).map(e2=>e2.id))}async onEncounterEnd(encounter){if(!game.pf2e.settings.automation.removeEffects)return;const actors=encounter.combatants.contents.flatMap(c=>c.actor??[]).filter(a=>game.user===a.primaryUpdater);for(const actor of actors){const expiresNow=actor.itemTypes.effect.filter(e2=>e2.system.duration.unit==="encounter");if(expiresNow.length===0)continue;const deletes=expiresNow.map(e2=>e2.id);await actor.deleteEmbeddedDocuments("Item",deletes);for(const effect of expiresNow)this.unregister(effect)}}}class ModuleArt{static{__name(this,"ModuleArt")}static{__name2(this,"ModuleArt")}map=new Map;async refresh(){this.map.clear();const activeModules=[...game.modules.entries()].filter(([_key,m])=>m.active);for(const[moduleKey,foundryModule]of activeModules){const flags=foundryModule.flags[moduleKey];if(!e$2(flags))continue;const moduleArt=await this.#getArtMap(flags["pf2e-art"]);if(moduleArt)for(const[packName,art]of Object.entries(moduleArt)){const pack=game.packs.get(`pf2e.${packName}`);if(!pack){console.warn(`PF2e System | Failed pack lookup from module art registration (${moduleKey}): ${packName}`);continue}const index2=pack.indexed?pack.index:await pack.getIndex();for(const[actorId,paths]of Object.entries(art)){const record=index2.get(actorId);if(!record)continue;record.img=paths.actor;const actorArtPartial={img:paths.actor,prototypeToken:{texture:{src:typeof paths.token=="string"?paths.token:paths.token.img}}};typeof paths.token!="string"&&(typeof paths.token.scale=="number"&&(actorArtPartial.prototypeToken.texture.scaleX=paths.token.scale,actorArtPartial.prototypeToken.texture.scaleY=paths.token.scale,actorArtPartial.prototypeToken.flags={pf2e:{autoscale:!1}}),typeof paths.token.randomImg=="boolean"&&(actorArtPartial.prototypeToken.randomImg=paths.token.randomImg)),this.map.set(`Compendium.pf2e.${packName}.Actor.${actorId}`,actorArtPartial)}}}const apps=foundry.applications.instances.values().filter(w=>w instanceof foundry.applications.sidebar.apps.Compendium);for(const compendium of apps)compendium.render()}async#getArtMap(art){if(art){if(this.#isModuleArt(art))return art;if(typeof art=="string")try{const response=await fetch(art);if(!response.ok)return console.warn(`PF2e System | Failed loading art mapping file at ${art}`),null;const map=await response.json();return this.#isModuleArt(map)?map:null}catch(error){error instanceof Error&&console.warn(`PF2e System | ${error.message}`)}}else return null;return null}#isModuleArt(record){return e$2(record)&&Object.values(record).every(packToArt=>e$2(packToArt)&&Object.values(packToArt).every(art=>e$2(art)&&"actor"in art&&typeof isImageFilePath(art.actor)&&"token"in art&&(isImageOrVideoPath(art.token)||e$2(art.token)&&"img"in art.token&&isImageOrVideoPath(art.token.img)&&(!("scale"in art.token)||typeof art.token.scale=="number"&&art.token.scale>0)&&(!("randomImg"in art.token)||typeof art.token.randomImg=="boolean"))))}}const SetGamePF2e={onInit:__name2(()=>{const actions=new Collection(SystemActions.map(action2=>[action2.slug,action2]));for(const[name2,action2]of Object.entries({encouragingWords,raiseAShield,restForTheNight,earnIncome:showEarnIncomePopup,steelYourResolve,takeABreather,treatWounds,...ActionMacros}))actions[name2]=action2;const initSafe={Check,CheckModifier,Coins,ConditionManager,Dice:DicePF2e,ElementalBlast,Modifier,ModifierType:{ABILITY:"ability",PROFICIENCY:"proficiency",CIRCUMSTANCE:"circumstance",ITEM:"item",POTENCY:"potency",STATUS:"status",UNTYPED:"untyped"},Predicate,RuleElement,RuleElements,StatisticModifier,StatusEffects,TextEditor:TextEditorPF2e,actions,effectPanel:new EffectsPanel,effectTracker:new EffectTracker,gm:{calculateXP,checkPrompt,editPersistent,launchTravelSheet,perceptionForSelected,stealthForSelected,xpFromEncounter},rollActionMacro,rollItemMacro,system:{generateItemName,moduleArt:new ModuleArt,remigrate,sluggify},variantRules:{AutomaticBonusProgression:AutomaticBonusProgression$1}};game.pf2e=foundry.utils.mergeObject(game.pf2e??{},initSafe);const campaignType=game.settings.get("pf2e","campaignType");game.pf2e.settings={automation:{flanking:game.settings.get("pf2e","automation.flankingDetection"),reachEnforcement:game.settings.get("pf2e","automation.reachEnforcement"),removeEffects:game.settings.get("pf2e","automation.removeExpiredEffects")},campaign:{feats:{enabled:game.settings.get("pf2e","campaignFeats"),sections:game.settings.get("pf2e","campaignFeatSections")},languages:game.settings.get("pf2e","homebrew.languageRarities"),mythic:game.settings.get("pf2e","mythic"),type:campaignType==="none"?null:campaignType},critFumble:{buttons:game.settings.get("pf2e","critFumbleButtons"),cards:game.settings.get("pf2e","drawCritFumble")},distanceDisplay:game.settings.get("pf2e","distanceDisplay"),encumbrance:game.settings.get("pf2e","automation.encumbrance"),gmVision:game.settings.get("pf2e","gmVision"),iwr:game.settings.get("pf2e","automation.iwr"),metagame:{breakdowns:game.settings.get("pf2e","metagame_showBreakdowns"),dcs:game.settings.get("pf2e","metagame_showDC"),secretChecks:game.settings.get("pf2e","metagame_secretChecks"),partyStats:game.settings.get("pf2e","metagame_showPartyStats"),partyVision:game.settings.get("pf2e","metagame_partyVision"),results:game.settings.get("pf2e","metagame_showResults")},rbv:game.settings.get("pf2e","automation.rulesBasedVision"),tokens:{autoscale:game.settings.get("pf2e","tokens.autoscale"),nameVisibility:game.settings.get("pf2e","metagame_tokenSetsNameVisibility"),nathMode:game.settings.get("pf2e","nathMode")},totm:game.settings.get("pf2e","totmToggles"),variants:{abp:game.settings.get("pf2e","automaticBonusVariant"),fa:game.settings.get("pf2e","freeArchetypeVariant"),gab:game.settings.get("pf2e","gradualBoostsVariant"),pwol:{enabled:game.settings.get("pf2e","proficiencyVariant"),modifiers:[game.settings.get("pf2e","proficiencyUntrainedModifier"),game.settings.get("pf2e","proficiencyTrainedModifier"),game.settings.get("pf2e","proficiencyExpertModifier"),game.settings.get("pf2e","proficiencyMasterModifier"),game.settings.get("pf2e","proficiencyLegendaryModifier")]},stamina:game.settings.get("pf2e","staminaVariant")},worldClock:game.settings.get("pf2e","worldClock")}},"onInit"),onSetup:__name2(()=>{},"onSetup"),onReady:__name2(()=>{game.pf2e.compendiumBrowser=new CompendiumBrowser,game.pf2e.worldClock=new WorldClock},"onReady")},fields$o=foundry.data.fields;class AutomationSettings extends SettingsMenuPF2e{static{__name(this,"AutomationSettings")}static{__name2(this,"AutomationSettings")}static namespace="automation";static SETTINGS=["rulesBasedVision","iwr","removeExpiredEffects","flankingDetection","encumbrance","lootableNPCs","reachEnforcement"];static get defaultOptions(){return Object.assign(super.defaultOptions,{submitOnChange:!1})}static get settings(){const prefix=`${AutomationSettings.namespace}.`;return{rulesBasedVision:{prefix,name:"PF2E.SETTINGS.Automation.RulesBasedVision.Name",hint:"PF2E.SETTINGS.Automation.RulesBasedVision.Hint",default:!0,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.rbv=!!value;for(const token of canvas.scene?.tokens??[])token.reset();canvas.perception.update({initializeLighting:!0,initializeVision:!0})},"onChange")},iwr:{prefix,name:"PF2E.SETTINGS.Automation.IWR.Name",hint:"PF2E.SETTINGS.Automation.IWR.Hint",default:!0,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.iwr=!!value},"onChange")},removeExpiredEffects:{prefix,name:"PF2E.SETTINGS.Automation.RemoveExpiredEffects.Name",hint:"PF2E.SETTINGS.Automation.RemoveExpiredEffects.Hint",default:!0,type:Boolean},flankingDetection:{prefix,name:"PF2E.SETTINGS.Automation.FlankingDetection.Name",hint:"PF2E.SETTINGS.Automation.FlankingDetection.Hint",default:!0,type:Boolean},encumbrance:{prefix,name:"PF2E.SETTINGS.Automation.Encumbrance.Name",hint:"PF2E.SETTINGS.Automation.Encumbrance.Hint",default:!1,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.encumbrance=!!value},"onChange")},lootableNPCs:{prefix,name:"PF2E.SETTINGS.Automation.LootableNPCs.Name",hint:"PF2E.SETTINGS.Automation.LootableNPCs.Hint",default:!0,type:Boolean},reachEnforcement:{name:"PF2E.SETTINGS.Automation.ReachEnforcement.Name",hint:"PF2E.SETTINGS.Automation.ReachEnforcement.Hint",prefix,type:new fields$o.SetField(new fields$o.StringField({required:!0,label:"PF2E.SETTINGS.Automation.ReachEnforcement.Name",choices:t$9(["corpses","doors","loot","merchants"],v=>[v,`PF2E.SETTINGS.Automation.ReachEnforcement.${v}`])}),{required:!0,initial:["doors"]}),onChange:__name2(value=>{if(!(value instanceof Set))throw ErrorPF2e("Unexpected setting value");game.pf2e.settings.automation.reachEnforcement=value},"onChange")}}}}const MetagameSettingsConfig={showDC:{prefix:"metagame_",name:"PF2E.SETTINGS.Metagame.ShowDC.Name",hint:"PF2E.SETTINGS.Metagame.ShowDC.Hint",default:!1,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.metagame.dcs=!!value},"onChange")},showResults:{prefix:"metagame_",name:"PF2E.SETTINGS.Metagame.ShowResults.Name",hint:"PF2E.SETTINGS.Metagame.ShowResults.Hint",default:!0,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.metagame.results=!!value},"onChange")},showBreakdowns:{prefix:"metagame_",name:"PF2E.SETTINGS.Metagame.ShowBreakdowns.Name",hint:"PF2E.SETTINGS.Metagame.ShowBreakdowns.Hint",default:!1,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.metagame.breakdowns=!!value},"onChange")},secretDamage:{prefix:"metagame_",name:"PF2E.SETTINGS.Metagame.SecretDamage.Name",hint:"PF2E.SETTINGS.Metagame.SecretDamage.Hint",default:!1,type:Boolean},secretCondition:{prefix:"metagame_",name:"PF2E.SETTINGS.Metagame.SecretCondition.Name",hint:"PF2E.SETTINGS.Metagame.SecretCondition.Hint",default:!1,type:Boolean},partyVision:{prefix:"metagame_",name:"PF2E.SETTINGS.Metagame.PartyVision.Name",hint:"PF2E.SETTINGS.Metagame.PartyVision.Hint",default:!1,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.metagame.partyVision=!!value,canvas.ready&&canvas.scene&&canvas.perception.update({initializeVision:!0,refreshLighting:!0})},"onChange")},showPartyStats:{prefix:"metagame_",name:"PF2E.SETTINGS.Metagame.ShowPartyStats.Name",hint:"PF2E.SETTINGS.Metagame.ShowPartyStats.Hint",default:!0,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.metagame.partyStats=!!value,resetActors(game.actors.filter(a=>a.isOfType("party")))},"onChange")},tokenSetsNameVisibility:{prefix:"metagame_",name:"PF2E.SETTINGS.Metagame.TokenSetsNameVisibility.Name",hint:"PF2E.SETTINGS.Metagame.TokenSetsNameVisibility.Hint",default:!1,type:Boolean,onChange:__name2(async value=>{game.pf2e.settings.tokens.nameVisibility=!!value,ui.combat.render();const renderedMessages=document.querySelectorAll("#chat-log > li");for(const rendered of Array.from(renderedMessages)){const message=game.messages.get(rendered?.dataset.messageId??"");message&&await ui.chat.updateMessage(message)}},"onChange")},secretChecks:{prefix:"metagame_",name:"PF2E.SETTINGS.Metagame.SecretChecks.Name",hint:"PF2E.SETTINGS.Metagame.SecretChecks.Hint",default:!1,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.metagame.secretChecks=!!value},"onChange")}};class MetagameSettings extends SettingsMenuPF2e{static{__name(this,"MetagameSettings")}static{__name2(this,"MetagameSettings")}static namespace="metagame";static get settings(){return MetagameSettingsConfig}static get SETTINGS(){return Object.keys(this.settings)}}const fields$n=foundry.data.fields;class VariantRulesSettings extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"VariantRulesSettings")}static{__name2(this,"VariantRulesSettings")}static DEFAULT_OPTIONS={id:"variant-rules-settings",window:{icon:"fa-solid fa-blender",title:"PF2E.SETTINGS.Variant.Title",contentTag:"form",contentClasses:["standard-form"]},position:{width:560},form:{handler:VariantRulesSettings.#onSubmit,closeOnSubmit:!0}};static PARTS={settings:{template:"systems/pf2e/templates/system/settings/variant-rules.hbs"},footer:{template:"templates/generic/form-footer.hbs"}};static#SETTINGS={gradualBoostsVariant:{type:new fields$n.BooleanField({label:"PF2E.SETTINGS.Variant.GradualBoosts.Name",hint:"PF2E.SETTINGS.Variant.GradualBoosts.Hint"}),onChange:__name2(value=>{game.pf2e.settings.variants.gab=!!value,resetActors(game.actors.filter(a=>a.type==="character"))},"onChange")},staminaVariant:{type:new fields$n.BooleanField({label:"PF2E.SETTINGS.Variant.Stamina.Name",hint:"PF2E.SETTINGS.Variant.Stamina.Hint"}),onChange:__name2(value=>{game.pf2e.settings.variants.stamina=!!value,resetActors(game.actors.filter(a=>a.type==="character"))},"onChange")},freeArchetypeVariant:{type:new fields$n.BooleanField({label:"PF2E.SETTINGS.Variant.FreeArchetype.Name",hint:"PF2E.SETTINGS.Variant.FreeArchetype.Hint"}),onChange:__name2(value=>{game.pf2e.settings.variants.fa=!!value,resetActors(game.actors.filter(a=>a.type==="character"))},"onChange")},automaticBonusVariant:{type:new fields$n.StringField({required:!0,label:"PF2E.SETTINGS.Variant.AutomaticBonus.Name",hint:"PF2E.SETTINGS.Variant.AutomaticBonus.Hint",choices:{noABP:"PF2E.SETTINGS.Variant.AutomaticBonus.Choices.noABP",ABPFundamentalPotency:"PF2E.SETTINGS.Variant.AutomaticBonus.Choices.ABPFundamentalPotency",ABPRulesAsWritten:"PF2E.SETTINGS.Variant.AutomaticBonus.Choices.ABPRulesAsWritten"},initial:"noABP"}),onChange:__name2(value=>{const choices=["noABP","ABPFundamentalPotency","ABPRulesAsWritten"];game.pf2e.settings.variants.abp=tupleHasValue(choices,value)?value:game.pf2e.settings.variants.abp,resetActors(game.actors.filter(a=>a.type==="character"))},"onChange")},mythic:{type:new fields$n.StringField({required:!0,label:"PF2E.SETTINGS.Variant.Mythic.Name",hint:"PF2E.SETTINGS.Variant.Mythic.Hint",choices:t$9(["disabled","enabled","variant-tiers"],key=>[key,`PF2E.SETTINGS.Variant.Mythic.Choices.${key}`]),initial:"disabled"}),onChange:__name2(value=>{const choices=["disabled","enabled","variant-tiers"];game.pf2e.settings.campaign.mythic=tupleHasValue(choices,value)?value:"disabled",resetActors(game.actors.filter(a=>a.isOfType("character")))},"onChange")},proficiencyVariant:{type:new fields$n.BooleanField({label:"PF2E.SETTINGS.Variant.Proficiency.Name",hint:"PF2E.SETTINGS.Variant.Proficiency.Hint"}),onChange:__name2(value=>{game.pf2e.settings.variants.pwol.enabled=!!value,resetActors(game.actors.filter(a=>a.type==="character"))},"onChange")},proficiencyUntrainedModifier:{default:-2,type:new fields$n.NumberField({label:"PF2E.SETTINGS.Variant.Proficiency.Rank.Untrained",required:!0,nullable:!1,integer:!0,initial:-2}),onChange:__name2(value=>{game.pf2e.settings.variants.pwol.modifiers[0]=Number(value)||0},"onChange")},proficiencyTrainedModifier:{type:new fields$n.NumberField({label:"PF2E.SETTINGS.Variant.Proficiency.Rank.Trained",required:!0,nullable:!1,integer:!0,initial:2}),onChange:__name2(value=>{game.pf2e.settings.variants.pwol.modifiers[1]=Number(value)||0},"onChange")},proficiencyExpertModifier:{type:new fields$n.NumberField({label:"PF2E.SETTINGS.Variant.Proficiency.Rank.Expert",required:!0,nullable:!1,integer:!0,initial:4}),onChange:__name2(value=>{game.pf2e.settings.variants.pwol.modifiers[2]=Number(value)||0},"onChange")},proficiencyMasterModifier:{type:new fields$n.NumberField({label:"PF2E.SETTINGS.Variant.Proficiency.Rank.Master",required:!0,nullable:!1,integer:!0,initial:6}),onChange:__name2(value=>{game.pf2e.settings.variants.pwol.modifiers[3]=Number(value)||0},"onChange")},proficiencyLegendaryModifier:{type:new fields$n.NumberField({label:"PF2E.SETTINGS.Variant.Proficiency.Rank.Legendary",required:!0,nullable:!1,integer:!0,initial:8}),onChange:__name2(value=>{game.pf2e.settings.variants.pwol.modifiers[4]=Number(value)||0},"onChange")}};static register(){game.settings.registerMenu("pf2e","variantRules",{name:"PF2E.SETTINGS.Variant.Name",label:"PF2E.SETTINGS.Variant.Label",hint:"PF2E.SETTINGS.Variant.Hint",icon:"fa-solid fa-blender",type:VariantRulesSettings,restricted:!0});for(const[key,data]of Object.entries(VariantRulesSettings.#SETTINGS))game.settings.register("pf2e",key,{...data,name:data.type.label,scope:"world",config:!1})}async _prepareContext(options){const context=await super._prepareContext(options);return Object.assign(context,{settings:t$5(VariantRulesSettings.#SETTINGS,(v,k)=>({...v,value:game.settings.get("pf2e",k),pwolModifier:/proficiency[A-Z][a-z]+Modifier/i.test(k)})),buttons:[{type:"submit",icon:"fa-solid fa-floppy-disk",label:"SETTINGS.Save"},{type:"reset",icon:"fa-solid fa-arrow-rotate-left",label:"PF2E.SETTINGS.ResetChanges"}],rootId:this.id})}_onChangeForm(_formConfig,event2){const pwolCheckbox=this.form?.elements.namedItem("pf2e.proficiencyVariant");event2.target===pwolCheckbox&&pwolCheckbox instanceof HTMLInputElement&&this.form?.querySelectorAll("fieldset input[type=number]").forEach(input=>{input.disabled=!pwolCheckbox.checked})}static async#onSubmit(_event,_form,formData){const submitData=formData.object,promises=[];for(const key of Object.keys(VariantRulesSettings.#SETTINGS)){const value=submitData[`pf2e.${key}`];value!==void 0&&promises.push(game.settings.set("pf2e",key,value))}await Promise.all(promises)}}const fields$m=foundry.data.fields;function registerSettings(){game.settings.register("pf2e","tokens.autoscale",{name:"PF2E.SETTINGS.Tokens.Autoscale.Name",hint:"PF2E.SETTINGS.Tokens.Autoscale.Hint",scope:"world",config:!0,default:!0,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.tokens.autoscale=!!value},"onChange")}),game.settings.register("pf2e","identifyMagicNotMatchingTraditionModifier",{name:"PF2E.SETTINGS.IdentifyMagicNotMatchingTraditionModifier.Name",hint:"PF2E.SETTINGS.IdentifyMagicNotMatchingTraditionModifier.Hint",choices:{0:"PF2E.SETTINGS.IdentifyMagicNotMatchingTraditionModifier.Choices.0",2:"PF2E.SETTINGS.IdentifyMagicNotMatchingTraditionModifier.Choices.2",5:"PF2E.SETTINGS.IdentifyMagicNotMatchingTraditionModifier.Choices.5",10:"PF2E.SETTINGS.IdentifyMagicNotMatchingTraditionModifier.Choices.10"},type:Number,default:5,scope:"world",config:!0}),game.settings.register("pf2e","critRule",{name:"PF2E.SETTINGS.CritRule.Name",hint:"PF2E.SETTINGS.CritRule.Hint",scope:"world",config:!0,default:"doubledamage",type:String,choices:{doubledamage:"PF2E.SETTINGS.CritRule.Choices.Doubledamage",doubledice:"PF2E.SETTINGS.CritRule.Choices.Doubledice"},onChange:__name2(()=>{for(const sheet of Object.values(ui.windows).filter(w=>w instanceof ActorSheetPF2e))sheet.render()},"onChange")}),game.settings.register("pf2e","minimumRulesUI",{name:"PF2E.SETTINGS.MinimumRulesUI.Name",hint:"PF2E.SETTINGS.MinimumRulesUI.Hint",scope:"world",config:!0,default:CONST.USER_ROLES.ASSISTANT,type:Number,choices:{1:"USER.RolePlayer",2:"USER.RoleTrusted",3:"USER.RoleAssistant",4:"USER.RoleGamemaster"},onChange:__name2(()=>{const itemSheets=Object.values(ui.windows).filter(w=>w instanceof ItemSheetPF2e);for(const sheet of itemSheets)sheet.render()},"onChange")});const distanceDisplays=["always","encounters","never"];game.settings.register("pf2e","distanceDisplay",{name:"PF2E.SETTINGS.DistanceDisplay.Name",hint:"PF2E.SETTINGS.DistanceDisplay.Hint",scope:"client",config:!0,type:new fields$m.StringField({required:!0,nullable:!1,choices:t$9(distanceDisplays,v=>[v,`PF2E.SETTINGS.DistanceDisplay.${v}`]),initial:"always"}),onChange:__name2(value=>{tupleHasValue(distanceDisplays,value)&&(game.pf2e.settings.distanceDisplay=value)},"onChange")}),game.settings.register("pf2e","compendiumBrowserPacks",{name:"PF2E.SETTINGS.CompendiumBrowserPacks.Name",hint:"PF2E.SETTINGS.CompendiumBrowserPacks.Hint",default:{},type:Object,scope:"world",onChange:__name2(()=>{game.pf2e.compendiumBrowser.initCompendiumList()},"onChange")}),game.settings.register("pf2e","compendiumBrowserSources",{name:"PF2E.SETTINGS.compendiumBrowserSources.Name",hint:"PF2E.SETTINGS.compendiumBrowserSources.Hint",default:{ignoreAsGM:!0,showEmptySources:!0,showUnknownSources:!0,sources:{}},type:Object,scope:"world",onChange:__name2(()=>{game.pf2e.compendiumBrowser.packLoader.reset(),game.pf2e.compendiumBrowser.initCompendiumList()},"onChange")}),game.settings.register("pf2e","critFumbleButtons",{name:game.i18n.localize("PF2E.SETTINGS.critFumbleCardButtons.name"),hint:game.i18n.localize("PF2E.SETTINGS.critFumbleCardButtons.hint"),scope:"world",config:!0,default:!1,type:Boolean,requiresReload:!0}),game.settings.register("pf2e","drawCritFumble",{name:game.i18n.localize("PF2E.SETTINGS.critFumbleCards.name"),hint:game.i18n.localize("PF2E.SETTINGS.critFumbleCards.hint"),scope:"world",config:!0,default:!1,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.critFumble.cards=!!value},"onChange")});const iconChoices={blackWhite:"PF2E.SETTINGS.statusEffectType.blackWhite",default:"PF2E.SETTINGS.statusEffectType.default"};game.settings.register("pf2e","statusEffectType",{name:"PF2E.SETTINGS.statusEffectType.name",hint:"PF2E.SETTINGS.statusEffectType.hint",scope:"world",config:!0,default:"default",type:String,choices:iconChoices,onChange:__name2(iconType=>{StatusEffects.migrateStatusEffectUrls(iconType)},"onChange")}),game.settings.register("pf2e","totmToggles",{name:"PF2E.SETTINGS.TOTMToggles.Name",hint:"PF2E.SETTINGS.TOTMToggles.Hint",scope:"world",config:!0,default:!1,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.totm=!!value,resetActors()},"onChange")}),game.settings.register("pf2e","deathIcon",{name:"PF2E.SETTINGS.DeathIcon.Name",hint:"PF2E.SETTINGS.DeathIcon.Hint",scope:"world",config:!1,default:"icons/svg/skull.svg",type:String,onChange:__name2(choice=>{isImageOrVideoPath(choice)?StatusEffects.reset():choice||game.settings.set("pf2e","deathIcon","icons/svg/skull.svg")},"onChange")}),game.settings.register("pf2e","nathMode",{name:"PF2E.SETTINGS.NathMode.Name",hint:"PF2E.SETTINGS.NathMode.Hint",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("pf2e","statusEffectShowCombatMessage",{name:"PF2E.SETTINGS.statusEffectShowCombatMessage.name",hint:"PF2E.SETTINGS.statusEffectShowCombatMessage.hint",scope:"world",config:!0,default:!0,type:Boolean}),game.settings.registerMenu("pf2e","automation",{name:"PF2E.SETTINGS.Automation.Name",label:"PF2E.SETTINGS.Automation.Label",hint:"PF2E.SETTINGS.Automation.Hint",icon:"fa-solid fa-robot",type:AutomationSettings,restricted:!0}),game.settings.register("pf2e","automation.actorsDeadAtZero",{name:"PF2E.SETTINGS.Automation.ActorsDeadAtZero.Name",hint:"PF2E.SETTINGS.Automation.ActorsDeadAtZero.Hint",scope:"world",config:!1,choices:{neither:"PF2E.SETTINGS.Automation.ActorsDeadAtZero.Neither",npcsOnly:"PF2E.SETTINGS.Automation.ActorsDeadAtZero.NPCsOnly",both:"PF2E.SETTINGS.Automation.ActorsDeadAtZero.Both"},default:"both",type:String}),AutomationSettings.registerSettings(),game.settings.registerMenu("pf2e","metagame",{name:"PF2E.SETTINGS.Metagame.Name",label:"PF2E.SETTINGS.Metagame.Label",hint:"PF2E.SETTINGS.Metagame.Hint",icon:"fa-solid fa-brain",type:MetagameSettings,restricted:!0}),MetagameSettings.registerSettings(),game.settings.registerMenu("pf2e","homebrew",{name:"PF2E.SETTINGS.Homebrew.Name",label:"PF2E.SETTINGS.Homebrew.Label",hint:"PF2E.SETTINGS.Homebrew.Hint",icon:"fa-solid fa-beer-mug-empty",type:HomebrewElements,restricted:!0}),HomebrewElements.registerSettings(),VariantRulesSettings.register(),WorldClockSettings.register(),game.settings.register("pf2e","campaignFeatSections",{name:"Campaign Feat Sections",scope:"world",config:!1,default:[],type:Array,onChange:__name2(value=>{game.pf2e.settings.campaign.feats.sections=Array.isArray(value)?value:game.pf2e.settings.campaign.feats.sections,resetActors(game.actors.filter(a=>a.isOfType("character")))},"onChange")}),game.settings.register("pf2e","gmVision",{name:"PF2E.SETTINGS.GMVision",scope:"client",config:!1,default:!1,type:Boolean,onChange:__name2(value=>{game.pf2e.settings.gmVision=!!value;const color=value?CONFIG.PF2E.Canvas.darkness.gmVision:CONFIG.PF2E.Canvas.darkness.default;CONFIG.Canvas.darknessColor=color,canvas.activeLayer&&ui.controls.render({reset:!0}),canvas.environment.initialize();for(const token of canvas.tokens.placeables)token.initializeVisionSource();canvas.perception.update({refreshLighting:!0,refreshVision:!0,refreshSounds:!0,refreshOcclusion:!0})},"onChange")}),game.settings.register("pf2e","seenLastStopMessage",{name:"Seen Last Stop Before Remaster Message",scope:"world",config:!1,type:Boolean,default:!1}),registerTrackingSettings(),registerWorldSchemaVersion()}__name(registerSettings,"registerSettings"),__name2(registerSettings,"registerSettings");function registerTrackingSettings(){game.settings.register("pf2e","createdFirstParty",{name:"Created First Party",scope:"world",config:!1,default:!1,type:Boolean}),game.settings.register("pf2e","activeParty",{name:"Active Party",scope:"world",config:!1,type:String,default:"",onChange:__name2(()=>{ui.actors.render({parts:["parties"]})},"onChange")}),game.settings.register("pf2e","activePartyFolderState",{name:"Active Party Opened or closed",scope:"client",config:!1,type:new fields$m.BooleanField({required:!0,nullable:!1,initial:!0})}),game.settings.register("pf2e","worldSystemVersion",{name:"World System Version",scope:"world",config:!1,default:game.system.version,type:String}),game.settings.register("pf2e","seenRemasterJournalEntry",{name:"Seen Remaster journal entry?",scope:"world",config:!1,default:!1,type:Boolean})}__name(registerTrackingSettings,"registerTrackingSettings"),__name2(registerTrackingSettings,"registerTrackingSettings");function registerWorldSchemaVersion(){game.settings.register("pf2e","worldSchemaVersion",{name:"PF2E.SETTINGS.WorldSchemaVersion.Name",hint:"PF2E.SETTINGS.WorldSchemaVersion.Hint",scope:"world",config:!0,default:MigrationRunner.LATEST_SCHEMA_VERSION,type:Number,requiresReload:!0})}__name(registerWorldSchemaVersion,"registerWorldSchemaVersion"),__name2(registerWorldSchemaVersion,"registerWorldSchemaVersion");var define_UUID_REDIRECTS_default={"Compendium.pf2e.actionspf2e.Item.0b3TTeQGFOiy6ykz":"Compendium.pf2e.actionspf2e.Item.34E7k2YRcsOU5uyl","Compendium.pf2e.actionspf2e.Item.8iCas8MeyqSXmE2a":"Compendium.pf2e.adventure-specific-actions.Item.6hrDW8tF6CDIaZl7","Compendium.pf2e.actionspf2e.Item.9zdI8S6ceGIgnAkT":"Compendium.pf2e.actionspf2e.Item.34E7k2YRcsOU5uyl","Compendium.pf2e.actionspf2e.Item.CrUPaPlsxy2bswaT":"Compendium.pf2e.adventure-specific-actions.Item.jwo5CvftA5puYp7i","Compendium.pf2e.actionspf2e.Item.F4Tz0YFz1Lr4eVZR":"Compendium.pf2e.adventure-specific-actions.Item.rKWfjflS15KEB3Yt","Compendium.pf2e.actionspf2e.Item.wwvPiG2kET2rkSAG":"Compendium.pf2e.actionspf2e.Item.34E7k2YRcsOU5uyl","Compendium.pf2e.bestiary-effects.Item.0ifqiVhhKULXJyf9":"Compendium.pf2e.bestiary-effects.Item.5Gol6tr9MtL9eR1u","Compendium.pf2e.bestiary-effects.Item.3QUaxNvpHDmf9cTo":"Compendium.pf2e.bestiary-effects.Item.5Gol6tr9MtL9eR1u","Compendium.pf2e.bestiary-effects.Item.4HJJdogS751Z04lD":"Compendium.pf2e.bestiary-effects.Item.QqC9xymSXSVunDgl","Compendium.pf2e.bestiary-effects.Item.bV70ZxnUAoYnfXaZ":"Compendium.pf2e.bestiary-effects.Item.5Gol6tr9MtL9eR1u","Compendium.pf2e.bestiary-effects.Item.HGP0c0tOK2WnC4p5":"Compendium.pf2e.bestiary-effects.Item.68oispwYGLUUxjzt","Compendium.pf2e.bestiary-effects.Item.svXRrZvixRInmabj":"Compendium.pf2e.bestiary-effects.Item.5Gol6tr9MtL9eR1u","Compendium.pf2e.bestiary-effects.Item.v1oNhc9xa8nWxmFQ":"Compendium.pf2e.bestiary-effects.Item.68oispwYGLUUxjzt","Compendium.pf2e.bestiary-effects.Item.VAy6IZ0ck7ALVL4b":"Compendium.pf2e.bestiary-effects.Item.5Gol6tr9MtL9eR1u","Compendium.pf2e.bestiary-effects.Item.vbxcQIjLVWa43sdt":"Compendium.pf2e.bestiary-effects.Item.5Gol6tr9MtL9eR1u","Compendium.pf2e.bestiary-effects.Item.vGL5LlFxVJqjy1gM":"Compendium.pf2e.bestiary-effects.Item.68oispwYGLUUxjzt","Compendium.pf2e.bestiary-effects.Item.vJAHjBoEuFKGQoGs":"Compendium.pf2e.bestiary-effects.Item.5Gol6tr9MtL9eR1u","Compendium.pf2e.bestiary-effects.Item.vKTvlFD2OSgTPuvl":"Compendium.pf2e.bestiary-effects.Item.68oispwYGLUUxjzt","Compendium.pf2e.bestiary-effects.Item.Vz9Cb8FEzNwfH3mE":"Compendium.pf2e.bestiary-effects.Item.68oispwYGLUUxjzt","Compendium.pf2e.bestiary-effects.Item.Y5vsF5Kb8oNIccWo":"Compendium.pf2e.bestiary-effects.Item.5Gol6tr9MtL9eR1u","Compendium.pf2e.bestiary-effects.Item.zBQM4rzLfkLzpET6":"Compendium.pf2e.bestiary-effects.Item.5Gol6tr9MtL9eR1u","Compendium.pf2e.book-of-the-dead-bestiary.Actor.KhHVStbsPSuPElFI":"Compendium.pf2e.agents-of-edgewatch-bestiary.Actor.SgkV5RtcK72d0HwI","Compendium.pf2e.campaign-effects.Item.2NKpljDuFttd9054":"Compendium.pf2e.adventure-specific-actions.Item.3yYlHV7GBrafsDwE","Compendium.pf2e.campaign-effects.Item.4ZGa4tzrh2vLNZR3":"Compendium.pf2e.adventure-specific-actions.Item.sjLNgLFyDvTt6VVV","Compendium.pf2e.campaign-effects.Item.54Q1eRCmuu6ueM4j":"Compendium.pf2e.adventure-specific-actions.Item.VMpc8QWEZxSH8Mr4","Compendium.pf2e.campaign-effects.Item.7vui0qQPmlM5SD99":"Compendium.pf2e.adventure-specific-actions.Item.w1nzN61S6NfkDH7Y","Compendium.pf2e.campaign-effects.Item.8Nj0vGsCqiyb9WgY":"Compendium.pf2e.adventure-specific-actions.Item.UnQ8oHYc0dBJHZv9","Compendium.pf2e.campaign-effects.Item.DvHX1hgZE6a6jhTm":"Compendium.pf2e.adventure-specific-actions.Item.fsxCcyWpag5iuWOU","Compendium.pf2e.campaign-effects.Item.gYzQuqQy3egp45kj":"Compendium.pf2e.adventure-specific-actions.Item.KtqDsKBuOmCkbDcR","Compendium.pf2e.campaign-effects.Item.ir1MMSrUECPiRs07":"Compendium.pf2e.adventure-specific-actions.Item.SnIvcCNASDzgevQK","Compendium.pf2e.campaign-effects.Item.M5vBlRWVnXoyRpqS":"Compendium.pf2e.adventure-specific-actions.Item.pHXGTgjwWY3OBRF2","Compendium.pf2e.campaign-effects.Item.N2EqUYDVS5I3rnKS":"Compendium.pf2e.adventure-specific-actions.Item.ekiKKfsBDFEeVmun","Compendium.pf2e.campaign-effects.Item.PEZoeYCF2R2nZG88":"Compendium.pf2e.adventure-specific-actions.Item.g6iKvH7Y3InQtZ8K","Compendium.pf2e.campaign-effects.Item.QXXgTRJyycu8FYyD":"Compendium.pf2e.adventure-specific-actions.Item.0HChyDaXdpXN11q4","Compendium.pf2e.campaign-effects.Item.R4oTPhsKSqCBd64F":"Compendium.pf2e.adventure-specific-actions.Item.KbQXDTBi5MKtHbpU","Compendium.pf2e.campaign-effects.Item.rl2s1MXAXnGOQF9c":"Compendium.pf2e.adventure-specific-actions.Item.DVILYNQVB2hx9Chl","Compendium.pf2e.campaign-effects.Item.rSlgE1Xlt3RDwYr4":"Compendium.pf2e.adventure-specific-actions.Item.YdG3UwVBia5AyLjO","Compendium.pf2e.campaign-effects.Item.SidX2yZ5Z0ORfpdr":"Compendium.pf2e.adventure-specific-actions.Item.w4t0ElpqNQRFCaPJ","Compendium.pf2e.classfeatures.Item.1mMdsSIVsyyqNr2t":"Compendium.pf2e.classfeatures.Item.1RfnAiyQ5FR7vnuH","Compendium.pf2e.classfeatures.Item.6FsusoMYxxjyIkVh":"Compendium.pf2e.classfeatures.Item.1RfnAiyQ5FR7vnuH","Compendium.pf2e.classfeatures.Item.7PutMrgKIaAeKBuU":"Compendium.pf2e.classfeatures.Item.aSOgbQWMwStTTmap","Compendium.pf2e.classfeatures.Item.ccrTv2j7eplr2JU8":"Compendium.pf2e.classfeatures.Item.aSOgbQWMwStTTmap","Compendium.pf2e.classfeatures.Item.cFe6vFb3gSDyNeS9":"Compendium.pf2e.classfeatures.Item.1RfnAiyQ5FR7vnuH","Compendium.pf2e.classfeatures.Item.eNFYMQMS2BszErCX":"Compendium.pf2e.classfeatures.Item.aSOgbQWMwStTTmap","Compendium.pf2e.classfeatures.Item.F5BHEav90oOJ2LwN":"Compendium.pf2e.classfeatures.Item.9XLUh9iMepZesdmc","Compendium.pf2e.classfeatures.Item.jklanV9AbZDnZHaD":"Compendium.pf2e.classfeatures.Item.aSOgbQWMwStTTmap","Compendium.pf2e.classfeatures.Item.Ju2Tp5s5iBB76tQO":"Compendium.pf2e.classfeatures.Item.1RfnAiyQ5FR7vnuH","Compendium.pf2e.classfeatures.Item.lDjKVZ48zbqQf3CU":"Compendium.pf2e.classfeatures.Item.aSOgbQWMwStTTmap","Compendium.pf2e.classfeatures.Item.lURKSJZAGKVD6cH9":"Compendium.pf2e.classfeatures.Item.1RfnAiyQ5FR7vnuH","Compendium.pf2e.classfeatures.Item.MizJPiKnopfpGmvw":"Compendium.pf2e.classfeatures.Item.aSOgbQWMwStTTmap","Compendium.pf2e.classfeatures.Item.rgLaxC3I2L7HSPNn":"Compendium.pf2e.classfeatures.Item.aSOgbQWMwStTTmap","Compendium.pf2e.classfeatures.Item.S4uY5ap2yhDRqhd0":"Compendium.pf2e.classfeatures.Item.aSOgbQWMwStTTmap","Compendium.pf2e.classfeatures.Item.T9gUmwghw16itUAO":"Compendium.pf2e.classfeatures.Item.aSOgbQWMwStTTmap","Compendium.pf2e.classfeatures.Item.tzDW9l4lBwXCVYtz":"Compendium.pf2e.classfeatures.Item.g3HTg0z3doXZZzAV","Compendium.pf2e.classfeatures.Item.zFY2PlJTObXpcQW4":"Compendium.pf2e.classfeatures.Item.aSOgbQWMwStTTmap","Compendium.pf2e.deities.Item.boZ8nMI06JtBo7Nv":"Compendium.pf2e.deities.Item.8ZSywyo8YQPduo92","Compendium.pf2e.equipment.Item.5Lode4gkHo4QUZbQ":"Compendium.pf2e.equipment.Item.JMvp1ca4IhLy4cGj","Compendium.pf2e.equipment-srd.Item.h7gsRKv6rORYgsv0":"Compendium.pf2e.equipment-srd.Item.y34yjumCFakrbtdw","Compendium.pf2e.equipment-srd.Item.P2DjThbSOWwra49r":"Compendium.pf2e.equipment-srd.Item.0QgniSjpzksm5riV","Compendium.pf2e.equipment-effects.Item.187xZfkgmYqQ0jnV":"Compendium.pf2e.equipment-effects.Item.p5KpVsJVzhoJ4OrS","Compendium.pf2e.equipment-effects.Item.19ECULG5Zp593jQX":"Compendium.pf2e.equipment-effects.Item.nbMEBxeqZIdOgysR","Compendium.pf2e.equipment-effects.Item.1mKjaWC65KWPuFR4":"Compendium.pf2e.equipment-effects.Item.TjBxxlTvb6tJP1jS","Compendium.pf2e.equipment-effects.Item.2lbFUkCiZ21kGSub":"Compendium.pf2e.equipment-effects.Item.r1IsOaxM5tgVU29b","Compendium.pf2e.equipment-effects.Item.25hZRK3gPvZHMIah":"Compendium.pf2e.equipment-effects.Item.Plga97M3LVFZqhiP","Compendium.pf2e.equipment-effects.Item.2MzNdLHge0l8B6sQ":"Compendium.pf2e.equipment-effects.Item.FTj94xTqZbaCs4jT","Compendium.pf2e.equipment-effects.Item.4G9qnI0oRyL6eKFQ":"Compendium.pf2e.equipment-effects.Item.LdmzgBOTjCete4F7","Compendium.pf2e.equipment-effects.Item.54yMDgR34XuYOwJk":"Compendium.pf2e.equipment-effects.Item.fLcp28dxFCOcBibw","Compendium.pf2e.equipment-effects.Item.5o33sch67Z8j5Vom":"Compendium.pf2e.equipment-effects.Item.6A8jsLR7upLGuRiv","Compendium.pf2e.equipment-effects.Item.5oYKYXAexr0vhx84":"Compendium.pf2e.other-effects.Item.TGGdM7XnjQkkijK7","Compendium.pf2e.equipment-effects.Item.5WLda1tGUiKoSj1K":"Compendium.pf2e.equipment-effects.Item.g8JS6wsw5sRWOJLg","Compendium.pf2e.equipment-effects.Item.6dsPjRKjCPd9BWPt":"Compendium.pf2e.equipment-effects.Item.sOwAqyQ6MaoSqaY1","Compendium.pf2e.equipment-effects.Item.6fIGdO15P8EbUBWR":"Compendium.pf2e.equipment-effects.Item.nBGodDOQTCWBXjNd","Compendium.pf2e.equipment-effects.Item.6s6eUNmnEYals8qB":"Compendium.pf2e.equipment-effects.Item.LqeLET7SuBja2ck9","Compendium.pf2e.equipment-effects.Item.7M6eKhMaEkSrbkji":"Compendium.pf2e.equipment-effects.Item.r1IsOaxM5tgVU29b","Compendium.pf2e.equipment-effects.Item.7z1iY4AaNEAIKuAU":"Compendium.pf2e.equipment-effects.Item.TjBxxlTvb6tJP1jS","Compendium.pf2e.equipment-effects.Item.8kfSF8P4NOh09YvZ":"Compendium.pf2e.equipment-effects.Item.m4WpxepWRV1u1Kcw","Compendium.pf2e.equipment-effects.Item.8zKGaGrkTd8ALqJO":"Compendium.pf2e.equipment-effects.Item.34gtdURRTZMS5bDK","Compendium.pf2e.equipment-effects.Item.9MeHc072G4L8AJkp":"Compendium.pf2e.equipment-effects.Item.lPRuIRbu0rHBkoKY","Compendium.pf2e.equipment-effects.Item.9NWyfYxrEBl1gi0m":"Compendium.pf2e.equipment-effects.Item.Hq1FthmyHvDDuESp","Compendium.pf2e.equipment-effects.Item.A4rAKGVzPzeegNRp":"Compendium.pf2e.equipment-effects.Item.YUj20zJ4bNAoc0nJ","Compendium.pf2e.equipment-effects.Item.Acox3S5hpJAqq1jc":"Compendium.pf2e.equipment-effects.Item.R5ugeFK3MPwkbv0s","Compendium.pf2e.equipment-effects.Item.agDVcRyoS4NTHkht":"Compendium.pf2e.equipment-effects.Item.oqwrw6XztVlS9tEG","Compendium.pf2e.equipment-effects.Item.AwpSNXaKloq2KQNy":"Compendium.pf2e.equipment-effects.Item.mQgA7XmjVI6WG6oq","Compendium.pf2e.equipment-effects.Item.BADJFyRYRxxxI16e":"Compendium.pf2e.equipment-effects.Item.Plga97M3LVFZqhiP","Compendium.pf2e.equipment-effects.Item.Bg4hNMqBx0yqmWYJ":"Compendium.pf2e.equipment-effects.Item.oaR6YGiZKg8a2971","Compendium.pf2e.equipment-effects.Item.bIOHtDiqtJZB86tV":"Compendium.pf2e.equipment-effects.Item.rmVyC6Xb8O9WPvZz","Compendium.pf2e.equipment-effects.Item.BTWuGksjSU1SYUcf":"Compendium.pf2e.equipment-effects.Item.rmVyC6Xb8O9WPvZz","Compendium.pf2e.equipment-effects.Item.BUTZM5XEhAtAu7OB":"Compendium.pf2e.equipment-effects.Item.Iw3CtHFpD3gGVjis","Compendium.pf2e.equipment-effects.Item.Bwh3kiNX8nxEwVZ5":"Compendium.pf2e.equipment-effects.Item.bKEx53h6lrFOYvpu","Compendium.pf2e.equipment-effects.Item.ccMa75bqXo3ZnlHM":"Compendium.pf2e.equipment-effects.Item.nQ6vM1CRLyvQdGLG","Compendium.pf2e.equipment-effects.Item.ceIvpmxWqBJpBHIn":"Compendium.pf2e.equipment-effects.Item.mHIdEC7RX6isILiM","Compendium.pf2e.equipment-effects.Item.CGkWnH402Q45HEVt":"Compendium.pf2e.equipment-effects.Item.bHCpqwKH9JM8FZa6","Compendium.pf2e.equipment-effects.Item.d6SzOHtupw1I5EFQ":"Compendium.pf2e.equipment-effects.Item.LfhCO3rP5ImzPyNY","Compendium.pf2e.equipment-effects.Item.D8cI0uhI3YFFQssp":"Compendium.pf2e.equipment-effects.Item.PBvLrztlLIfr2dlV","Compendium.pf2e.equipment-effects.Item.DaN3N9bOzqDhOng0":"Compendium.pf2e.equipment-effects.Item.LbaYzs0dQuFj8FXJ","Compendium.pf2e.equipment-effects.Item.dEsaVzTWOctpl8XP":"Compendium.pf2e.equipment-effects.Item.rmVyC6Xb8O9WPvZz","Compendium.pf2e.equipment-effects.Item.DfAyZW2vkhTygZVC":"Compendium.pf2e.equipment-effects.Item.jgaDboqENQJaS1sW","Compendium.pf2e.equipment-effects.Item.Dg19mPbwX5kBr10t":"Compendium.pf2e.equipment-effects.Item.AYLthNtyUlWmKqhW","Compendium.pf2e.equipment-effects.Item.doyduaLONE2FVxAc":"Compendium.pf2e.equipment-effects.Item.rmVyC6Xb8O9WPvZz","Compendium.pf2e.equipment-effects.Item.dMbRTs2YvnDwtUEj":"Compendium.pf2e.equipment-effects.Item.5mQ51m1lqQlvfi8n","Compendium.pf2e.equipment-effects.Item.dv0IKm5syOdP759w":"Compendium.pf2e.equipment-effects.Item.LdmzgBOTjCete4F7","Compendium.pf2e.equipment-effects.Item.E2uy6gqOXi1HRVBU":"Compendium.pf2e.equipment-effects.Item.oaR6YGiZKg8a2971","Compendium.pf2e.equipment-effects.Item.e6dXfbKzv5sNr1zh":"Compendium.pf2e.equipment-effects.Item.UhV9TLdFjtSOppog","Compendium.pf2e.equipment-effects.Item.Ee2xfKX1yyqGIDZj":"Compendium.pf2e.other-effects.Item.TGGdM7XnjQkkijK7","Compendium.pf2e.equipment-effects.Item.eNVSBXuOiAaN152C":"Compendium.pf2e.equipment-effects.Item.UjXwDvLoSe9infGg","Compendium.pf2e.equipment-effects.Item.EpB7yJPEuG6ez4z3":"Compendium.pf2e.equipment-effects.Item.lPRuIRbu0rHBkoKY","Compendium.pf2e.equipment-effects.Item.ECGvrM0eAaJlm1VC":"Compendium.pf2e.equipment-effects.Item.WJ9L6rgUTZVV7vEE","Compendium.pf2e.equipment-effects.Item.EqXWI80FBz59VC6v":"Compendium.pf2e.equipment-effects.Item.rmVyC6Xb8O9WPvZz","Compendium.pf2e.equipment-effects.Item.ESuBosh3t1pXEcBj":"Compendium.pf2e.other-effects.Item.1FrAlPeNseApVrX3","Compendium.pf2e.equipment-effects.Item.etJW0w4CiSFgMrWP":"Compendium.pf2e.equipment-effects.Item.kdcVvwVVsttZgX1Y","Compendium.pf2e.equipment-effects.Item.EwHufLQI1z1QzqZU":"Compendium.pf2e.equipment-effects.Item.mHIdEC7RX6isILiM","Compendium.pf2e.equipment-effects.Item.F8nQOLVWmpp9G5hZ":"Compendium.pf2e.equipment-effects.Item.nbMEBxeqZIdOgysR","Compendium.pf2e.equipment-effects.Item.Fb4QI4zlmoqfwHY0":"Compendium.pf2e.equipment-effects.Item.WLvFC2eE80SEZpUg","Compendium.pf2e.equipment-effects.Item.FbFl95WRpzrrijh3":"Compendium.pf2e.equipment-effects.Item.kdcVvwVVsttZgX1Y","Compendium.pf2e.equipment-effects.Item.FqSsAjkaHfVFCw0P":"Compendium.pf2e.equipment-effects.Item.p5KpVsJVzhoJ4OrS","Compendium.pf2e.equipment-effects.Item.FTxP7qt4SqZXAkJu":"Compendium.pf2e.equipment-effects.Item.AYLthNtyUlWmKqhW","Compendium.pf2e.equipment-effects.Item.gaEXUewHgPpM3zfW":"Compendium.pf2e.equipment-effects.Item.hozXQvKqp62DnawX","Compendium.pf2e.equipment-effects.Item.GAU5xqIEe2D280TB":"Compendium.pf2e.equipment-effects.Item.fLcp28dxFCOcBibw","Compendium.pf2e.equipment-effects.Item.giTLR7zUHTs9ysBQ":"Compendium.pf2e.equipment-effects.Item.Iw3CtHFpD3gGVjis","Compendium.pf2e.equipment-effects.Item.gU3uZE2ihLnpQN0b":"Compendium.pf2e.equipment-effects.Item.rdHzCYZEWpy2rTfI","Compendium.pf2e.equipment-effects.Item.gZOED4T3o6giterN":"Compendium.pf2e.equipment-effects.Item.M1HKNPpqkjFI9A4q","Compendium.pf2e.equipment-effects.Item.h0Zh8tDF9zJBHZXA":"Compendium.pf2e.equipment-effects.Item.OxCVZSvWVJsOGAZN","Compendium.pf2e.equipment-effects.Item.h9ukqhz7qgNuOlxh":"Compendium.pf2e.equipment-effects.Item.DbUEGIKxH6d1GgVw","Compendium.pf2e.equipment-effects.Item.haywlcUtG6hV1LAy":"Compendium.pf2e.equipment-effects.Item.oqwrw6XztVlS9tEG","Compendium.pf2e.equipment-effects.Item.HeRHBo2NaKy5IxhU":"Compendium.pf2e.equipment-effects.Item.mVgLCbZgafIylRzh","Compendium.pf2e.equipment-effects.Item.Hnt3Trd7TiFICB06":"Compendium.pf2e.equipment-effects.Item.UhV9TLdFjtSOppog","Compendium.pf2e.equipment-effects.Item.HoZWmT4yvGso7pHM":"Compendium.pf2e.equipment-effects.Item.OxCVZSvWVJsOGAZN","Compendium.pf2e.equipment-effects.Item.HP08UtbCwi7GTNSD":"Compendium.pf2e.equipment-effects.Item.bHCpqwKH9JM8FZa6","Compendium.pf2e.equipment-effects.Item.id20P4pj7zDKeLmy":"Compendium.pf2e.other-effects.Item.TGGdM7XnjQkkijK7","Compendium.pf2e.equipment-effects.Item.IiPqlP4C7YTjkE9w":"Compendium.pf2e.equipment-effects.Item.5mQ51m1lqQlvfi8n","Compendium.pf2e.equipment-effects.Item.iOY4XqVZNiQ5esdu":"Compendium.pf2e.equipment-effects.Item.WRvZ2Nq3wquisD4Y","Compendium.pf2e.equipment-effects.Item.Ja3PlqLuD9aSaPNZ":"Compendium.pf2e.equipment-effects.Item.9e6iVkPpGqJYwMyb","Compendium.pf2e.equipment-effects.Item.JGlkg3US7Tk1SirV":"Compendium.pf2e.equipment-effects.Item.JaPNzmgD7p7hHH8o","Compendium.pf2e.equipment-effects.Item.JnnyamqQrAEcyI6F":"Compendium.pf2e.equipment-effects.Item.V4JoVnOfKze8cRan","Compendium.pf2e.equipment-effects.Item.jrBkGqJyjPTtuuZV":"Compendium.pf2e.equipment-effects.Item.49e80oS2x19jiGw9","Compendium.pf2e.equipment-effects.Item.kgEOxqF1q4Sy6r97":"Compendium.pf2e.equipment-effects.Item.PuWZyFzJCkbq1Inj","Compendium.pf2e.equipment-effects.Item.kgotU0sFmtAHYySB":"Compendium.pf2e.equipment-effects.Item.VOSQ77DV4BnAkP7m","Compendium.pf2e.equipment-effects.Item.kkDbalYEavzRpYlp":"Compendium.pf2e.equipment-effects.Item.mVgLCbZgafIylRzh","Compendium.pf2e.equipment-effects.Item.kkXy5JWC7OTBqTKg":"Compendium.pf2e.equipment-effects.Item.2qHgwcYtCg4csC2w","Compendium.pf2e.equipment-effects.Item.KtQXsv7mCvMMGXdK":"Compendium.pf2e.equipment-effects.Item.49e80oS2x19jiGw9","Compendium.pf2e.equipment-effects.Item.kyLLXUQ9zSEvC4py":"Compendium.pf2e.equipment-effects.Item.g8JS6wsw5sRWOJLg","Compendium.pf2e.equipment-effects.Item.KYzuzY8TNZmwqgBx":"Compendium.pf2e.equipment-effects.Item.Iw3CtHFpD3gGVjis","Compendium.pf2e.equipment-effects.Item.LhNZNHvmSs54c3Lj":"Compendium.pf2e.equipment-effects.Item.k8Gt8zfPOhkYOn1A","Compendium.pf2e.equipment-effects.Item.LH0IDLLF4RsT3KvM":"Compendium.pf2e.equipment-effects.Item.UjXwDvLoSe9infGg","Compendium.pf2e.equipment-effects.Item.LZ8q9ctapWVrGxhE":"Compendium.pf2e.equipment-effects.Item.m6z7OrJgF4XQFNpa","Compendium.pf2e.equipment-effects.Item.M3EFomnN5xArdQmV":"Compendium.pf2e.equipment-effects.Item.sOwAqyQ6MaoSqaY1","Compendium.pf2e.equipment-effects.Item.M5veiDPQNQBevg7m":"Compendium.pf2e.equipment-effects.Item.rmVyC6Xb8O9WPvZz","Compendium.pf2e.equipment-effects.Item.mi4Md1fB2XThCand":"Compendium.pf2e.equipment-effects.Item.TjBxxlTvb6tJP1jS","Compendium.pf2e.equipment-effects.Item.mkjcgwDBeaOUolVe":"Compendium.pf2e.equipment-effects.Item.zDQmjp5YSwZtrgX9","Compendium.pf2e.equipment-effects.Item.MRxkqo5HIowjXL5T":"Compendium.pf2e.equipment-effects.Item.r1IsOaxM5tgVU29b","Compendium.pf2e.equipment-effects.Item.MvvAy8oi9ITEqsG0":"Compendium.pf2e.equipment-effects.Item.KFq5wnjdzyrycEnB","Compendium.pf2e.equipment-effects.Item.NddLhLIQYgZYrPTR":"Compendium.pf2e.equipment-effects.Item.LbaYzs0dQuFj8FXJ","Compendium.pf2e.equipment-effects.Item.NE7Fm5YnUhD4ySX3":"Compendium.pf2e.equipment-effects.Item.hPxrIpuL54XRlA2h","Compendium.pf2e.equipment-effects.Item.neZPoQF4hW3A31dd":"Compendium.pf2e.equipment-effects.Item.6A8jsLR7upLGuRiv","Compendium.pf2e.equipment-effects.Item.nJRoiSyd67eQ1dYj":"Compendium.pf2e.equipment-effects.Item.LdmzgBOTjCete4F7","Compendium.pf2e.equipment-effects.Item.o9N5EUN5ajuXSTVX":"Compendium.pf2e.equipment-effects.Item.bHBehLniirjNAnVh","Compendium.pf2e.equipment-effects.Item.OAN5Fj21PJPhIqRU":"Compendium.pf2e.equipment-effects.Item.UhV9TLdFjtSOppog","Compendium.pf2e.equipment-effects.Item.odnWi4WQCVHYmHFZ":"Compendium.pf2e.equipment-effects.Item.AJNUrLJgTC0AdBhS","Compendium.pf2e.equipment-effects.Item.okxiX9E2IrwLXCrK":"Compendium.pf2e.equipment-effects.Item.nBGodDOQTCWBXjNd","Compendium.pf2e.equipment-effects.Item.OrZfOsrh2qYMPBNo":"Compendium.pf2e.equipment-effects.Item.DbUEGIKxH6d1GgVw","Compendium.pf2e.equipment-effects.Item.OVEn6314ZAul4bbi":"Compendium.pf2e.equipment-effects.Item.bHBehLniirjNAnVh","Compendium.pf2e.equipment-effects.Item.owA1eQU6LTP3A3of":"Compendium.pf2e.equipment-effects.Item.WLvFC2eE80SEZpUg","Compendium.pf2e.equipment-effects.Item.OwHOtzI31nrfYKQ9":"Compendium.pf2e.equipment-effects.Item.34gtdURRTZMS5bDK","Compendium.pf2e.equipment-effects.Item.P882YXPpESinSvrJ":"Compendium.pf2e.equipment-effects.Item.WARLTi8unmPgmnNw","Compendium.pf2e.equipment-effects.Item.P99n3BdPkaemfhWf":"Compendium.pf2e.equipment-effects.Item.4tepFOJLhZSelPoa","Compendium.pf2e.equipment-effects.Item.p9jROgkqozXB52UJ":"Compendium.pf2e.equipment-effects.Item.WRV0XjiEHdlBpduS","Compendium.pf2e.equipment-effects.Item.pgWhwSGZd8JT5IlF":"Compendium.pf2e.equipment-effects.Item.grXFmNl8Zy3VRVpR","Compendium.pf2e.equipment-effects.Item.pnBdSjOtQb9T1ajL":"Compendium.pf2e.equipment-effects.Item.9mIS76oZkxXQ4g3T","Compendium.pf2e.equipment-effects.Item.PpLxndUSgzgs6dd0":"Compendium.pf2e.equipment-effects.Item.lPRuIRbu0rHBkoKY","Compendium.pf2e.equipment-effects.Item.pr12dSHV4nIyVG5n":"Compendium.pf2e.equipment-effects.Item.ft5LjQSa8mZkklhM","Compendium.pf2e.equipment-effects.Item.pzR7ohtc1KKCSWIS":"Compendium.pf2e.equipment-effects.Item.JaPNzmgD7p7hHH8o","Compendium.pf2e.equipment-effects.Item.q1EhQ716bPSgJVnC":"Compendium.pf2e.equipment-effects.Item.eh7EqmDBDW30ShCu","Compendium.pf2e.equipment-effects.Item.q58ahUEjUzTXffRN":"Compendium.pf2e.equipment-effects.Item.VZCcjwsQX1wnYlTn","Compendium.pf2e.equipment-effects.Item.q6Qq3Ie3M22XI5bw":"Compendium.pf2e.equipment-effects.Item.2qHgwcYtCg4csC2w","Compendium.pf2e.equipment-effects.Item.QapoFh0tbUgMwSIB":"Compendium.pf2e.equipment-effects.Item.lO95TwgihBdTilAB","Compendium.pf2e.equipment-effects.Item.qFT6TJU5EObpoixe":"Compendium.pf2e.equipment-effects.Item.EjLVjt3GMeHM0Ai3","Compendium.pf2e.equipment-effects.Item.qoV03Fk6HSzZUCmv":"Compendium.pf2e.equipment-effects.Item.bKEx53h6lrFOYvpu","Compendium.pf2e.equipment-effects.Item.QTmnUgiJnPli1dS0":"Compendium.pf2e.equipment-effects.Item.k8Gt8zfPOhkYOn1A","Compendium.pf2e.equipment-effects.Item.QuZ5frBMJF3gi7RY":"Compendium.pf2e.equipment-effects.Item.TjBxxlTvb6tJP1jS","Compendium.pf2e.equipment-effects.Item.Qvjw5RYhglGcVRhF":"Compendium.pf2e.equipment-effects.Item.IiDpW99zrh7zHxmQ","Compendium.pf2e.equipment-effects.Item.qVKrrKpTghgMIuGH":"Compendium.pf2e.equipment-effects.Item.mVgLCbZgafIylRzh","Compendium.pf2e.equipment-effects.Item.qWeEmDft3tRWlIwy":"Compendium.pf2e.equipment-effects.Item.KFq5wnjdzyrycEnB","Compendium.pf2e.equipment-effects.Item.QXJLvL2k3WqlF0SN":"Compendium.pf2e.equipment-effects.Item.V4JoVnOfKze8cRan","Compendium.pf2e.equipment-effects.Item.qYa5BDssyIfPQg2r":"Compendium.pf2e.equipment-effects.Item.KFq5wnjdzyrycEnB","Compendium.pf2e.equipment-effects.Item.R106i7WCXvHLGMTu":"Compendium.pf2e.equipment-effects.Item.mVgLCbZgafIylRzh","Compendium.pf2e.equipment-effects.Item.R1kZsBMZdGZ3ATkA":"Compendium.pf2e.equipment-effects.Item.PuWZyFzJCkbq1Inj","Compendium.pf2e.equipment-effects.Item.REgzMqcWgJfMULmJ":"Compendium.pf2e.equipment-effects.Item.nBGodDOQTCWBXjNd","Compendium.pf2e.equipment-effects.Item.Rfw1T5NXIoeUbJzt":"Compendium.pf2e.equipment-effects.Item.ft5LjQSa8mZkklhM","Compendium.pf2e.equipment-effects.Item.RLsdvhmTh64Mmty9":"Compendium.pf2e.equipment-effects.Item.LdmzgBOTjCete4F7","Compendium.pf2e.equipment-effects.Item.rnVjsjav50CHwMVr":"Compendium.pf2e.equipment-effects.Item.LfhCO3rP5ImzPyNY","Compendium.pf2e.equipment-effects.Item.RxtpVyOywdrt29Q6":"Compendium.pf2e.equipment-effects.Item.WJ9L6rgUTZVV7vEE","Compendium.pf2e.equipment-effects.Item.sEa4TGXGBxku1V7o":"Compendium.pf2e.equipment-effects.Item.k8Gt8zfPOhkYOn1A","Compendium.pf2e.equipment-effects.Item.SpUT3mCa2NVKruJ9":"Compendium.pf2e.equipment-effects.Item.49e80oS2x19jiGw9","Compendium.pf2e.equipment-effects.Item.T38SHe842S43a8bB":"Compendium.pf2e.equipment-effects.Item.EPqnA5OlNpwr41Os","Compendium.pf2e.equipment-effects.Item.tcHG8NlsYmHdziko":"Compendium.pf2e.equipment-effects.Item.m4WpxepWRV1u1Kcw","Compendium.pf2e.equipment-effects.Item.TD9divhkTjGIegop":"Compendium.pf2e.equipment-effects.Item.49e80oS2x19jiGw9","Compendium.pf2e.equipment-effects.Item.Tioloj3bTlFnQDqa":"Compendium.pf2e.equipment-effects.Item.VZCcjwsQX1wnYlTn","Compendium.pf2e.equipment-effects.Item.tLGzSCcfxflLSqzw":"Compendium.pf2e.equipment-effects.Item.UjXwDvLoSe9infGg","Compendium.pf2e.equipment-effects.Item.tNaFPSbNkcyHS50y":"Compendium.pf2e.equipment-effects.Item.WARLTi8unmPgmnNw","Compendium.pf2e.equipment-effects.Item.TOqm2yCf1IE1DKtF":"Compendium.pf2e.equipment-effects.Item.LfhCO3rP5ImzPyNY","Compendium.pf2e.equipment-effects.Item.TU67AK08CUsP7pl4":"Compendium.pf2e.equipment-effects.Item.EPqnA5OlNpwr41Os","Compendium.pf2e.equipment-effects.Item.U3wQTWZ3FiLJPA0O":"Compendium.pf2e.equipment-effects.Item.34gtdURRTZMS5bDK","Compendium.pf2e.equipment-effects.Item.u7200u7lh40am0jb":"Compendium.pf2e.equipment-effects.Item.WRV0XjiEHdlBpduS","Compendium.pf2e.equipment-effects.Item.uf3KI1n1MkP7htbJ":"Compendium.pf2e.equipment-effects.Item.DbUEGIKxH6d1GgVw","Compendium.pf2e.equipment-effects.Item.UihgHdEj0GsaRaAL":"Compendium.pf2e.equipment-effects.Item.PBvLrztlLIfr2dlV","Compendium.pf2e.equipment-effects.Item.UlalLihKzDxcOdXL":"Compendium.pf2e.equipment-effects.Item.lO95TwgihBdTilAB","Compendium.pf2e.equipment-effects.Item.uOr8APVmEJ0E3lgz":"Compendium.pf2e.equipment-effects.Item.5XdkHIUgc6psBxQq","Compendium.pf2e.equipment-effects.Item.UPMZe0oKVpUgDaOE":"Compendium.pf2e.equipment-effects.Item.WRvZ2Nq3wquisD4Y","Compendium.pf2e.equipment-effects.Item.UTtX0xLGYci6P43I":"Compendium.pf2e.equipment-effects.Item.6p2Sjl7XxCc55ft4","Compendium.pf2e.equipment-effects.Item.VCypzSu659eC6jNi":"Compendium.pf2e.equipment-effects.Item.VOSQ77DV4BnAkP7m","Compendium.pf2e.equipment-effects.Item.vOgD9wfStLX1utte":"Compendium.pf2e.equipment-effects.Item.Nbgf8zvHimdQqIu6","Compendium.pf2e.equipment-effects.Item.vdNgW5I9AnI1x4Nq":"Compendium.pf2e.equipment-effects.Item.YUj20zJ4bNAoc0nJ","Compendium.pf2e.equipment-effects.Item.viCX9fZzTWGuoO85":"Compendium.pf2e.equipment-effects.Item.eeGWTG9ZAha4IIOY","Compendium.pf2e.equipment-effects.Item.Vj2vytSr9jEtesYu":"Compendium.pf2e.equipment-effects.Item.p5KpVsJVzhoJ4OrS","Compendium.pf2e.equipment-effects.Item.vKooOkXHvtqCgZYg":"Compendium.pf2e.equipment-effects.Item.UjXwDvLoSe9infGg","Compendium.pf2e.equipment-effects.Item.VMVrJA4SkyOfklmj":"Compendium.pf2e.equipment-effects.Item.R5ugeFK3MPwkbv0s","Compendium.pf2e.equipment-effects.Item.vOU4Yv2MyAfYBbmF":"Compendium.pf2e.equipment-effects.Item.kdcVvwVVsttZgX1Y","Compendium.pf2e.equipment-effects.Item.VPDBv6t8nBt3Vfp7":"Compendium.pf2e.equipment-effects.Item.p5KpVsJVzhoJ4OrS","Compendium.pf2e.equipment-effects.Item.VrYfR2WuyA15zFhq":"Compendium.pf2e.equipment-effects.Item.UhV9TLdFjtSOppog","Compendium.pf2e.equipment-effects.Item.vw6BbXYsEgCR3dPt":"Compendium.pf2e.equipment-effects.Item.gAQaizpMbZLDbzg7","Compendium.pf2e.equipment-effects.Item.Wa4317cqU4lJ8vAQ":"Compendium.pf2e.equipment-effects.Item.VOSQ77DV4BnAkP7m","Compendium.pf2e.equipment-effects.Item.wcjEjFKLcPisk4jK":"Compendium.pf2e.equipment-effects.Item.KJXNLvJAl0mNnGvn","Compendium.pf2e.equipment-effects.Item.WGmrfhdQzlNzyMrq":"Compendium.pf2e.equipment-effects.Item.KJXNLvJAl0mNnGvn","Compendium.pf2e.equipment-effects.Item.WOblH0tb7WQ8qgM2":"Compendium.pf2e.equipment-effects.Item.FTj94xTqZbaCs4jT","Compendium.pf2e.equipment-effects.Item.wTZnKkT0K4Tdy8mD":"Compendium.pf2e.equipment-effects.Item.eh7EqmDBDW30ShCu","Compendium.pf2e.equipment-effects.Item.wyLEew86nhNUXASu":"Compendium.pf2e.equipment-effects.Item.VOSQ77DV4BnAkP7m","Compendium.pf2e.equipment-effects.Item.Wylo8ttAkExaX6Gs":"Compendium.pf2e.equipment-effects.Item.gAQaizpMbZLDbzg7","Compendium.pf2e.equipment-effects.Item.XGHrqFn9QXdTM42R":"Compendium.pf2e.equipment-effects.Item.2qHgwcYtCg4csC2w","Compendium.pf2e.equipment-effects.Item.XNtUmlnvHujFw4dq":"Compendium.pf2e.equipment-effects.Item.Empv55xGFN2Mk3cu","Compendium.pf2e.equipment-effects.Item.xSw7cTboMvP8sJAq":"Compendium.pf2e.equipment-effects.Item.rdHzCYZEWpy2rTfI","Compendium.pf2e.equipment-effects.Item.xMG5PrT6NvCFYGqI":"Compendium.pf2e.equipment-effects.Item.mQgA7XmjVI6WG6oq","Compendium.pf2e.equipment-effects.Item.XwCBalKJf3CiEiFa":"Compendium.pf2e.other-effects.Item.1FrAlPeNseApVrX3","Compendium.pf2e.equipment-effects.Item.XWenziR7J3mwKV4W":"Compendium.pf2e.other-effects.Item.1FrAlPeNseApVrX3","Compendium.pf2e.equipment-effects.Item.XzxADtNpUlRff972":"Compendium.pf2e.equipment-effects.Item.zDQmjp5YSwZtrgX9","Compendium.pf2e.equipment-effects.Item.YAZ1iri403S8XcrH":"Compendium.pf2e.equipment-effects.Item.hozXQvKqp62DnawX","Compendium.pf2e.equipment-effects.Item.yd0qnTSjz6d9rgxU":"Compendium.pf2e.equipment-effects.Item.m6z7OrJgF4XQFNpa","Compendium.pf2e.equipment-effects.Item.YflZZ7EG7JJkdX0d":"Compendium.pf2e.equipment-effects.Item.9mIS76oZkxXQ4g3T","Compendium.pf2e.equipment-effects.Item.yvabfuAO74pvH8hh":"Compendium.pf2e.equipment-effects.Item.kdcVvwVVsttZgX1Y","Compendium.pf2e.equipment-effects.Item.YsV7tB15XrSCKNnB":"Compendium.pf2e.equipment-effects.Item.IiDpW99zrh7zHxmQ","Compendium.pf2e.equipment-effects.Item.Yxssrnh9UZJAM0V7":"Compendium.pf2e.equipment-effects.Item.lPRuIRbu0rHBkoKY","Compendium.pf2e.equipment-effects.Item.yzENPvcYIxegPflt":"Compendium.pf2e.equipment-effects.Item.M1HKNPpqkjFI9A4q","Compendium.pf2e.equipment-effects.Item.Z9oPh462q82IYIZ6":"Compendium.pf2e.equipment-effects.Item.lPRuIRbu0rHBkoKY","Compendium.pf2e.equipment-effects.Item.ZP9Uq4PVTgzJ3wEi":"Compendium.pf2e.equipment-effects.Item.nQ6vM1CRLyvQdGLG","Compendium.pf2e.extinction-curse-bestiary.Actor.YAKZUBOth75W2mWT":"Compendium.pf2e.pathfinder-monster-core-2.Actor.i2fRfiIWOJeZedcx","Compendium.pf2e.familiar-abilities.Item.5gwqSpkRqWzrbDDU":"Compendium.pf2e.familiar-abilities.Item.mK3mAUWiRLZZYNdz","Compendium.pf2e.familiar-abilities.Item.K5OLRDsGCfPZ6mO6":"Compendium.pf2e.familiar-abilities.Item.mK3mAUWiRLZZYNdz","Compendium.pf2e.familiar-abilities.Item.SxWYVgqNMsq0OijU":"Compendium.pf2e.familiar-abilities.Item.BXssJhTJjKrfojwG","Compendium.pf2e.familiar-abilities.Item.VHQUZcjUxfC3GcJ9":"Compendium.pf2e.familiar-abilities.Item.BXssJhTJjKrfojwG","Compendium.pf2e.familiar-abilities.Item.vpw2ReYdcyQBpdqn":"Compendium.pf2e.familiar-abilities.Item.BXssJhTJjKrfojwG","Compendium.pf2e.feats-srd.Item.aVRuchEAJITim82y":"Compendium.pf2e.feats-srd.Item.aVRuchEAJIvnd70k","Compendium.pf2e.feats-srd.Item.ERCd44zQMYI4rgqM":"Compendium.pf2e.feats-srd.Item.5Unc9AhGAAw1klFN","Compendium.pf2e.feats-srd.Item.LIEbgqgSXkGIli8u":"Compendium.pf2e.feats-srd.Item.5Unc9AhGAAw1klFN","Compendium.pf2e.feats-srd.Item.Nd7C7X9LYyp0TaET":"Compendium.pf2e.feats-srd.Item.5Unc9AhGAAw1klFN","Compendium.pf2e.feats-srd.Item.WZLw9UrIyCz6Eiqo":"Compendium.pf2e.feats-srd.Item.5Unc9AhGAAw1klFN","Compendium.pf2e.feat-effects.Item.0r2V1nK5pV31IUPY":"Compendium.pf2e.campaign-effects.Item.IlSPZvli2IcLVPyi","Compendium.pf2e.feat-effects.Item.2c30Drdg84bWLcRn":"Compendium.pf2e.feat-effects.Item.jUUjgpEEOeZeG7II","Compendium.pf2e.feat-effects.Item.2RwhJ9fbJtcQjW6s":"Compendium.pf2e.feat-effects.Item.NviQYIVZbPCSWLqT","Compendium.pf2e.feat-effects.Item.5TzKmEqFyLHBG2ua":"Compendium.pf2e.feat-effects.Item.jUUjgpEEOeZeG7II","Compendium.pf2e.feat-effects.Item.AAgoUuwMvHzqNhIN":"Compendium.pf2e.feat-effects.Item.zcJii1XyOne9EvMr","Compendium.pf2e.feat-effects.Item.AclYG5JuBFrjCY3I":"Compendium.pf2e.feat-effects.Item.zZ25N1zpXA8GNhFL","Compendium.pf2e.feat-effects.Item.AJlunjfAIOq2Sg0p":"Compendium.pf2e.feat-effects.Item.NviQYIVZbPCSWLqT","Compendium.pf2e.feat-effects.Item.aqnx6IDcB7ARLxS5":"Compendium.pf2e.feat-effects.Item.fILVhS5NuCtGXfri","Compendium.pf2e.feat-effects.Item.aWOvmdaTK1jS3H72":"Compendium.pf2e.feat-effects.Item.Jt7NnE7WeR7e9V6Q","Compendium.pf2e.feat-effects.Item.bIU1q05vzkKBtFj2":"Compendium.pf2e.feat-effects.Item.eecIuD6sGPX0FJcT","Compendium.pf2e.feat-effects.Item.bl4HXm1e4NQ0iJs5":"Compendium.pf2e.feat-effects.Item.ImkjllInxmrdDCOq","Compendium.pf2e.feat-effects.Item.bliWctLi7jlKUTUe":"Compendium.pf2e.feat-effects.Item.NviQYIVZbPCSWLqT","Compendium.pf2e.feat-effects.Item.cH8JD3ub4eEKuIAD":"Compendium.pf2e.feat-effects.Item.eecIuD6sGPX0FJcT","Compendium.pf2e.feat-effects.Item.CNnIS8jWVj00nPwF":"Compendium.pf2e.feat-effects.Item.Jt7NnE7WeR7e9V6Q","Compendium.pf2e.feat-effects.Item.CtrZFI3RV0yPNzTv":"Compendium.pf2e.feat-effects.Item.GoSls6SKCFmSoDxT","Compendium.pf2e.feat-effects.Item.Cumdy84uIkUHG9zF":"Compendium.pf2e.feat-effects.Item.NMmsJyeMTawpgLVR","Compendium.pf2e.feat-effects.Item.DhvSMIFs6xifgQHX":"Compendium.pf2e.feat-effects.Item.8HGz3rQCHNgdAqFC","Compendium.pf2e.feat-effects.Item.dvOfGUuvG8ihcN8d":"Compendium.pf2e.feat-effects.Item.zZ25N1zpXA8GNhFL","Compendium.pf2e.feat-effects.Item.E8MiV00QEhH5n18L":"Compendium.pf2e.feat-effects.Item.lPtt7PojWBwPOaYt","Compendium.pf2e.feat-effects.Item.eA14bUF7xhNCzw2v":"Compendium.pf2e.feat-effects.Item.ImkjllInxmrdDCOq","Compendium.pf2e.feat-effects.Item.fh8TgCfiifVk0eqU":"Compendium.pf2e.campaign-effects.Item.b1sZC0knPcr7B6Gz","Compendium.pf2e.feat-effects.Item.G1IRkppxJCYdfqXo":"Compendium.pf2e.feat-effects.Item.lPtt7PojWBwPOaYt","Compendium.pf2e.feat-effects.Item.GbbwJhwSNLw06XpO":"Compendium.pf2e.feat-effects.Item.lPtt7PojWBwPOaYt","Compendium.pf2e.feat-effects.Item.GCEOngH5zL0rRyle":"Compendium.pf2e.feat-effects.Item.jUUjgpEEOeZeG7II","Compendium.pf2e.feat-effects.Item.GlpZyxAGhy5QNqkm":"Compendium.pf2e.feat-effects.Item.zZ25N1zpXA8GNhFL","Compendium.pf2e.feat-effects.Item.HjCXHDZT6GkCyiuG":"Compendium.pf2e.feat-effects.Item.NviQYIVZbPCSWLqT","Compendium.pf2e.feat-effects.Item.I4Ozf6mTnd3X0Oax":"Compendium.pf2e.feat-effects.Item.5v0ndPPMfZwhiVZF","Compendium.pf2e.feat-effects.Item.IYeAJ0sB2zCgus1b":"Compendium.pf2e.feat-effects.Item.1WqXbwhfT1f6OrPU","Compendium.pf2e.feat-effects.Item.JFBjqNV6jSEl0Nul":"Compendium.pf2e.feat-effects.Item.9YO84RSGcq3XcA0E","Compendium.pf2e.feat-effects.Item.jZYRxGHyArCci6AF":"Compendium.pf2e.feat-effects.Item.NviQYIVZbPCSWLqT","Compendium.pf2e.feat-effects.Item.kAgUld9PcI4XkHbq":"Compendium.pf2e.feat-effects.Item.FyaekbWsazkJhJda","Compendium.pf2e.feat-effects.Item.KceTcamIZ4ZrQJLD":"Compendium.pf2e.feat-effects.Item.WrWSieH9Acy6XuzV","Compendium.pf2e.feat-effects.Item.KgR1myc4OLzVxfxn":"Compendium.pf2e.feat-effects.Item.5v0ndPPMfZwhiVZF","Compendium.pf2e.feat-effects.Item.KkbFlNfcQQUfSVXd":"Compendium.pf2e.feat-effects.Item.ImkjllInxmrdDCOq","Compendium.pf2e.feat-effects.Item.KVbS7AbhQdeuA0J6":"Compendium.pf2e.feat-effects.Item.9AUcoY48H5LrVZiF","Compendium.pf2e.feat-effects.Item.lbe8XDSZB8gwyg90":"Compendium.pf2e.campaign-effects.Item.IlSPZvli2IcLVPyi","Compendium.pf2e.feat-effects.Item.MZDh3170EFIfOwTO":"Compendium.pf2e.feat-effects.Item.1XlJ9xLzL19GHoOL","Compendium.pf2e.feat-effects.Item.o04gwnrVtzWyIEs8":"Compendium.pf2e.feat-effects.Item.CXMDSu8pKh0OJkUo","Compendium.pf2e.feat-effects.Item.OkcblqWj4aHVAkrp":"Compendium.pf2e.feat-effects.Item.zZ25N1zpXA8GNhFL","Compendium.pf2e.feat-effects.Item.oKJr59FYdDORxLcR":"Compendium.pf2e.campaign-effects.Item.ICT4vGhOmPbriy16","Compendium.pf2e.feat-effects.Item.OKOqC1wswrh9jXqP":"Compendium.pf2e.campaign-effects.Item.IlSPZvli2IcLVPyi","Compendium.pf2e.feat-effects.Item.OqH6IaeOwRWkGPrk":"Compendium.pf2e.feat-effects.Item.Nv70aqcQgCBpDYp8","Compendium.pf2e.feat-effects.Item.oX51Db6IxnUI64dT":"Compendium.pf2e.feat-effects.Item.jUUjgpEEOeZeG7II","Compendium.pf2e.feat-effects.Item.q2kY0TzXloJ8HLNO":"Compendium.pf2e.campaign-effects.Item.0PDng7D5Aj0szeSU","Compendium.pf2e.feat-effects.Item.QTG73gxKSNkiEWdY":"Compendium.pf2e.feat-effects.Item.NviQYIVZbPCSWLqT","Compendium.pf2e.feat-effects.Item.rUKtp4q8y73AvCbo":"Compendium.pf2e.feat-effects.Item.vhSYlQiAQMLuXqoc","Compendium.pf2e.feat-effects.Item.ruRAfGJnik7lRavk":"Compendium.pf2e.feat-effects.Item.SVGW8CLKwixFlnTv","Compendium.pf2e.feat-effects.Item.SKjVvQcRQmnDoouw":"Compendium.pf2e.campaign-effects.Item.n6PAwAqignNXd75G","Compendium.pf2e.feat-effects.Item.T5rsLTqS274B9Mly":"Compendium.pf2e.feat-effects.Item.8HGz3rQCHNgdAqFC","Compendium.pf2e.feat-effects.Item.U1MpMtRnFqEDBJwd":"Compendium.pf2e.feat-effects.Item.CXMDSu8pKh0OJkUo","Compendium.pf2e.feat-effects.Item.uA1Ofqoyi0UiZIPk":"Compendium.pf2e.feat-effects.Item.vhSYlQiAQMLuXqoc","Compendium.pf2e.feat-effects.Item.vE9NePtP32DyfJSr":"Compendium.pf2e.feat-effects.Item.VOOShYoB4gTopZtg","Compendium.pf2e.feat-effects.Item.VIScVb6Hl7KwoWfH":"Compendium.pf2e.feat-effects.Item.bmVwaN0C4e9fE2Sz","Compendium.pf2e.feat-effects.Item.x4Sb3qaMJo8x1r3X":"Compendium.pf2e.feat-effects.Item.jUUjgpEEOeZeG7II","Compendium.pf2e.feat-effects.Item.XC3dRbwfu35vuvmM":"Compendium.pf2e.feat-effects.Item.ImkjllInxmrdDCOq","Compendium.pf2e.feat-effects.Item.yfbP64r4a9e5oyli":"Compendium.pf2e.feat-effects.Item.aKRo5TIhUtu0kyEr","Compendium.pf2e.feat-effects.Item.z4pnE8KyUdEkJmru":"Compendium.pf2e.feat-effects.Item.vhSYlQiAQMLuXqoc","Compendium.pf2e.feat-effects.Item.ZMFgz4GYSsFeaKKK":"Compendium.pf2e.campaign-effects.Item.84OsM8ml9VUAlNze","Compendium.pf2e.feat-effects.Item.ZSgB3imGveukWUxs":"Compendium.pf2e.feat-effects.Item.lPtt7PojWBwPOaYt","Compendium.pf2e.feats-srd.Item.NQTpuGhB7Rq9zJkt":"Compendium.pf2e.feats-srd.Item.ZELjVKOohGw3ECwB","Compendium.pf2e.feats-srd.Item.xWWcxZUgQTaHZHkY":"Compendium.pf2e.feats-srd.Item.xblAUCASehLA9fbc","Compendium.pf2e.fists-of-the-ruby-phoenix-bestiary.Actor.v85RucvwE8lGq7oY":"Compendium.pf2e.lost-omens-bestiary.Actor.GP61YtH3RvicMTkf","Compendium.pf2e.heritages.Item.3reGfXH0S82hM7Gp":"Compendium.pf2e.heritages.Item.1oLMOmLpurfWTTff","Compendium.pf2e.heritages.Item.lj5iHaiY0IwCCptd":"Compendium.pf2e.heritages.Item.1oLMOmLpurfWTTff","Compendium.pf2e.lost-omens-bestiary.Actor.wjNbuzeqoVSR0Wwm":"Compendium.pf2e.lost-omens-bestiary.Actor.gZ2qX5vbWg7otMVT","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.1MxubcO4SB8PwmKT":"Compendium.pf2e.lost-omens-bestiary.Actor.1MxubcO4SB8PwmKT","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.1SIx3wcRvplbfwk3":"Compendium.pf2e.lost-omens-bestiary.Actor.1SIx3wcRvplbfwk3","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.4DQotKcUZebLfeeL":"Compendium.pf2e.lost-omens-bestiary.Actor.4DQotKcUZebLfeeL","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.98wPo6efoFhxdVwl":"Compendium.pf2e.lost-omens-bestiary.Actor.98wPo6efoFhxdVwl","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.AIQMB0ysHNeodKG4":"Compendium.pf2e.lost-omens-bestiary.Actor.AIQMB0ysHNeodKG4","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.FrLxEXUPE3mMLrYN":"Compendium.pf2e.lost-omens-bestiary.Actor.FrLxEXUPE3mMLrYN","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.JmGKKXdAxUkJtdTm":"Compendium.pf2e.lost-omens-bestiary.Actor.JmGKKXdAxUkJtdTm","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.K2AOcLMDOVNbgPXp":"Compendium.pf2e.lost-omens-bestiary.Actor.K2AOcLMDOVNbgPXp","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.KTabPRN489yjTvek":"Compendium.pf2e.lost-omens-bestiary.Actor.KTabPRN489yjTvek","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.LVY9JAhTnBC2SeqZ":"Compendium.pf2e.lost-omens-bestiary.Actor.LVY9JAhTnBC2SeqZ","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.UgGyHJ39EHztCV5m":"Compendium.pf2e.lost-omens-bestiary.Actor.UgGyHJ39EHztCV5m","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.fGZeQOarR6Im7Lnk":"Compendium.pf2e.lost-omens-bestiary.Actor.fGZeQOarR6Im7Lnk","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.gZ2qX5vbWg7otMVT":"Compendium.pf2e.lost-omens-bestiary.Actor.gZ2qX5vbWg7otMVT","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.lhr2fjewILo4nyUZ":"Compendium.pf2e.lost-omens-bestiary.Actor.lhr2fjewILo4nyUZ","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.qbfMDAa3RXvwyG7k":"Compendium.pf2e.lost-omens-bestiary.Actor.qbfMDAa3RXvwyG7k","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.qmw82W0WhPkn9UTW":"Compendium.pf2e.lost-omens-bestiary.Actor.qmw82W0WhPkn9UTW","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.wj7dVmPstRWzcLzC":"Compendium.pf2e.lost-omens-bestiary.Actor.wj7dVmPstRWzcLzC","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.wjNbuzeqoVSR0Wwm":"Compendium.pf2e.lost-omens-bestiary.Actor.gZ2qX5vbWg7otMVT","Compendium.pf2e.lost-omens-impossible-lands-bestiary.Actor.xl2UxOFVSDGqaVS5":"Compendium.pf2e.lost-omens-bestiary.Actor.xl2UxOFVSDGqaVS5","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.8K5v5q9Y01hcSNug":"Compendium.pf2e.lost-omens-bestiary.Actor.8K5v5q9Y01hcSNug","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.As0M3PvmrR2055pk":"Compendium.pf2e.lost-omens-bestiary.Actor.As0M3PvmrR2055pk","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.BxChohV8FBiyAnEc":"Compendium.pf2e.lost-omens-bestiary.Actor.BxChohV8FBiyAnEc","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.EyGpKm5MkHepWuNM":"Compendium.pf2e.lost-omens-bestiary.Actor.EyGpKm5MkHepWuNM","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.IWk8dWUf4Q4D8iww":"Compendium.pf2e.lost-omens-bestiary.Actor.IWk8dWUf4Q4D8iww","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.N5pG7rsbN1lL1ysb":"Compendium.pf2e.lost-omens-bestiary.Actor.N5pG7rsbN1lL1ysb","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.NvyAvzxxfb8XEQr2":"Compendium.pf2e.lost-omens-bestiary.Actor.NvyAvzxxfb8XEQr2","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.QUyqY6JiZNkEyTnd":"Compendium.pf2e.lost-omens-bestiary.Actor.QUyqY6JiZNkEyTnd","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.RVVSRRYAhQ3dVK2h":"Compendium.pf2e.lost-omens-bestiary.Actor.RVVSRRYAhQ3dVK2h","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.TfEGDGqUk3LpokZZ":"Compendium.pf2e.lost-omens-bestiary.Actor.TfEGDGqUk3LpokZZ","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.XSWDwaLEyshEKSZE":"Compendium.pf2e.lost-omens-bestiary.Actor.XSWDwaLEyshEKSZE","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.aXXvrcggR8EQJOdm":"Compendium.pf2e.lost-omens-bestiary.Actor.aXXvrcggR8EQJOdm","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.bo3BDHT7P1IK7oLp":"Compendium.pf2e.lost-omens-bestiary.Actor.bo3BDHT7P1IK7oLp","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.hbvxQn0T0m4WoAmZ":"Compendium.pf2e.lost-omens-bestiary.Actor.hbvxQn0T0m4WoAmZ","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.j0t62tXPYhBzCLUO":"Compendium.pf2e.lost-omens-bestiary.Actor.j0t62tXPYhBzCLUO","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.ld3hMGWfeUT7enNf":"Compendium.pf2e.lost-omens-bestiary.Actor.ld3hMGWfeUT7enNf","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.rBlu1EsygXwCkOvd":"Compendium.pf2e.lost-omens-bestiary.Actor.rBlu1EsygXwCkOvd","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.rMby02NQRHNrDcTj":"Compendium.pf2e.lost-omens-bestiary.Actor.rMby02NQRHNrDcTj","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.rVnJUXPgAPCeW1tS":"Compendium.pf2e.lost-omens-bestiary.Actor.rVnJUXPgAPCeW1tS","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.rayMMWNm61ivtxuU":"Compendium.pf2e.lost-omens-bestiary.Actor.rayMMWNm61ivtxuU","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.rrJqsVeBKizuyqRY":"Compendium.pf2e.lost-omens-bestiary.Actor.rrJqsVeBKizuyqRY","Compendium.pf2e.lost-omens-mwangi-expanse-bestiary.Actor.x2udXsqiLZachJHY":"Compendium.pf2e.lost-omens-bestiary.Actor.x2udXsqiLZachJHY","Compendium.pf2e.lost-omens-highhelm-bestiary.Actor.6X4zL4GSS9aUcP9f":"Compendium.pf2e.lost-omens-bestiary.Actor.6X4zL4GSS9aUcP9f","Compendium.pf2e.lost-omens-highhelm-bestiary.Actor.AbaAJaz8p6sSsaqy":"Compendium.pf2e.lost-omens-bestiary.Actor.AbaAJaz8p6sSsaqy","Compendium.pf2e.lost-omens-highhelm-bestiary.Actor.IGoJDxjMiADXa1bm":"Compendium.pf2e.lost-omens-bestiary.Actor.IGoJDxjMiADXa1bm","Compendium.pf2e.lost-omens-highhelm-bestiary.Actor.McZDmNR9sldfnsBw":"Compendium.pf2e.lost-omens-bestiary.Actor.McZDmNR9sldfnsBw","Compendium.pf2e.lost-omens-highhelm-bestiary.Actor.cWHQmwUkLYBlFOGX":"Compendium.pf2e.lost-omens-bestiary.Actor.cWHQmwUkLYBlFOGX","Compendium.pf2e.lost-omens-highhelm-bestiary.Actor.fQvTnIpC2Wq1U32z":"Compendium.pf2e.lost-omens-bestiary.Actor.fQvTnIpC2Wq1U32z","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.0ypo8Vt3B6p9DqAt":"Compendium.pf2e.lost-omens-bestiary.Actor.0ypo8Vt3B6p9DqAt","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.10srqxC7QZy0dq2g":"Compendium.pf2e.lost-omens-bestiary.Actor.10srqxC7QZy0dq2g","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.5PwT7t6eTC0qcK7E":"Compendium.pf2e.lost-omens-bestiary.Actor.5PwT7t6eTC0qcK7E","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.7a57dwK5XrV78ajM":"Compendium.pf2e.lost-omens-bestiary.Actor.7a57dwK5XrV78ajM","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.Bi6bi9Ko5x9OJfDT":"Compendium.pf2e.lost-omens-bestiary.Actor.Bi6bi9Ko5x9OJfDT","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.C87bRxKDTuJXGkPG":"Compendium.pf2e.lost-omens-bestiary.Actor.C87bRxKDTuJXGkPG","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.CgNC8uWPrJbGDklJ":"Compendium.pf2e.lost-omens-bestiary.Actor.CgNC8uWPrJbGDklJ","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.EXyfhhX9GLOnK1uZ":"Compendium.pf2e.lost-omens-bestiary.Actor.EXyfhhX9GLOnK1uZ","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.EmWSRL2aYBcHCgrW":"Compendium.pf2e.lost-omens-bestiary.Actor.EmWSRL2aYBcHCgrW","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.FhgZOBWNMa5t7pYV":"Compendium.pf2e.lost-omens-bestiary.Actor.FhgZOBWNMa5t7pYV","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.G1jYZOjA3E3BqrIM":"Compendium.pf2e.lost-omens-bestiary.Actor.G1jYZOjA3E3BqrIM","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.IO7sPevkM0zvnWbi":"Compendium.pf2e.lost-omens-bestiary.Actor.IO7sPevkM0zvnWbi","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.JX7k6wFmZLqNjK0k":"Compendium.pf2e.lost-omens-bestiary.Actor.JX7k6wFmZLqNjK0k","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.K7hgO9SEBai2jwYj":"Compendium.pf2e.lost-omens-bestiary.Actor.K7hgO9SEBai2jwYj","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.KLxdUFCvZ7HkAP1E":"Compendium.pf2e.lost-omens-bestiary.Actor.KLxdUFCvZ7HkAP1E","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.KdOwmclPVpcTSPjF":"Compendium.pf2e.lost-omens-bestiary.Actor.KdOwmclPVpcTSPjF","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.KeKlBbO3hfT5mzqO":"Compendium.pf2e.lost-omens-bestiary.Actor.KeKlBbO3hfT5mzqO","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.LK3SgIKJqqo4Q4NQ":"Compendium.pf2e.lost-omens-bestiary.Actor.LK3SgIKJqqo4Q4NQ","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.N3OJ0wxik4wEgTg7":"Compendium.pf2e.lost-omens-bestiary.Actor.N3OJ0wxik4wEgTg7","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.O4gEaG5vzkLFl7J1":"Compendium.pf2e.lost-omens-bestiary.Actor.O4gEaG5vzkLFl7J1","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.OF0fZDjNapydddM1":"Compendium.pf2e.lost-omens-bestiary.Actor.OF0fZDjNapydddM1","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.OLgKekTU0LOYwoxd":"Compendium.pf2e.lost-omens-bestiary.Actor.OLgKekTU0LOYwoxd","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.RqdL0YzNF1dG163i":"Compendium.pf2e.lost-omens-bestiary.Actor.RqdL0YzNF1dG163i","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.VCC4nw6EXvqwgmCp":"Compendium.pf2e.lost-omens-bestiary.Actor.VCC4nw6EXvqwgmCp","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.W0oF6Dl7G4UeTBSC":"Compendium.pf2e.lost-omens-bestiary.Actor.W0oF6Dl7G4UeTBSC","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.WdnuPiAoRFaymR8R":"Compendium.pf2e.lost-omens-bestiary.Actor.WdnuPiAoRFaymR8R","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.XCW1WzJqwGUS1cGi":"Compendium.pf2e.lost-omens-bestiary.Actor.XCW1WzJqwGUS1cGi","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.XLDh6o6vBRCDEKsl":"Compendium.pf2e.lost-omens-bestiary.Actor.XLDh6o6vBRCDEKsl","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.XwBFT7VO9M7M6AgQ":"Compendium.pf2e.lost-omens-bestiary.Actor.XwBFT7VO9M7M6AgQ","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.a1vTm01GBVF4TI8f":"Compendium.pf2e.lost-omens-bestiary.Actor.a1vTm01GBVF4TI8f","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.bhLbKN7MJofTabfK":"Compendium.pf2e.lost-omens-bestiary.Actor.bhLbKN7MJofTabfK","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.hLyLnBn7lEFstUG2":"Compendium.pf2e.lost-omens-bestiary.Actor.hLyLnBn7lEFstUG2","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.hfi0qJePy2cf4Fqe":"Compendium.pf2e.lost-omens-bestiary.Actor.hfi0qJePy2cf4Fqe","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.j3NhCEMLVm4HSsgr":"Compendium.pf2e.lost-omens-bestiary.Actor.j3NhCEMLVm4HSsgr","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.jInkcz2UYdaCzsBU":"Compendium.pf2e.lost-omens-bestiary.Actor.jInkcz2UYdaCzsBU","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.kdkmTLlqzOYVxb50":"Compendium.pf2e.lost-omens-bestiary.Actor.kdkmTLlqzOYVxb50","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.mE9MQ0hnRmlR9m94":"Compendium.pf2e.lost-omens-bestiary.Actor.mE9MQ0hnRmlR9m94","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.ns6fmJ8469hzBOtM":"Compendium.pf2e.lost-omens-bestiary.Actor.ns6fmJ8469hzBOtM","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.qcdNzMiO3XxPHLPJ":"Compendium.pf2e.lost-omens-bestiary.Actor.qcdNzMiO3XxPHLPJ","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.sXZExyaijbRnKI2S":"Compendium.pf2e.lost-omens-bestiary.Actor.sXZExyaijbRnKI2S","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.vI7wAKNDX05DShWy":"Compendium.pf2e.lost-omens-bestiary.Actor.vI7wAKNDX05DShWy","Compendium.pf2e.lost-omens-monsters-of-myth-bestiary.Actor.zE2ykzHZKNS3Rnc3":"Compendium.pf2e.lost-omens-bestiary.Actor.zE2ykzHZKNS3Rnc3","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.0J8xJV4NXaphEWgM":"Compendium.pf2e.lost-omens-bestiary.Actor.0J8xJV4NXaphEWgM","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.0yF82Lo495lKarLS":"Compendium.pf2e.lost-omens-bestiary.Actor.0yF82Lo495lKarLS","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.2hQmiIASF1pvbWhX":"Compendium.pf2e.lost-omens-bestiary.Actor.2hQmiIASF1pvbWhX","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.374PRwbW4i4Xw1Fe":"Compendium.pf2e.lost-omens-bestiary.Actor.374PRwbW4i4Xw1Fe","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.3utPtrLWLyNO1hxt":"Compendium.pf2e.lost-omens-bestiary.Actor.3utPtrLWLyNO1hxt","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.6bACPcPqi8syNcVg":"Compendium.pf2e.lost-omens-bestiary.Actor.6bACPcPqi8syNcVg","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.6v2HzHeT1mNLaqg9":"Compendium.pf2e.lost-omens-bestiary.Actor.6v2HzHeT1mNLaqg9","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.7RTjMCDWQVc6MKNI":"Compendium.pf2e.lost-omens-bestiary.Actor.7RTjMCDWQVc6MKNI","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.7ZSjqT2yiJB5OKgk":"Compendium.pf2e.lost-omens-bestiary.Actor.7ZSjqT2yiJB5OKgk","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.8AANjQtU703ghIsR":"Compendium.pf2e.lost-omens-bestiary.Actor.8AANjQtU703ghIsR","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.9jvXTVcMNTx3kGfU":"Compendium.pf2e.lost-omens-bestiary.Actor.9jvXTVcMNTx3kGfU","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.AKYrUoUmunt46Vy8":"Compendium.pf2e.lost-omens-bestiary.Actor.AKYrUoUmunt46Vy8","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.B65InLN9TZjlascU":"Compendium.pf2e.lost-omens-bestiary.Actor.B65InLN9TZjlascU","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.DkQWhW0CelytSWAV":"Compendium.pf2e.lost-omens-bestiary.Actor.DkQWhW0CelytSWAV","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.GP61YtH3RvicMTkf":"Compendium.pf2e.lost-omens-bestiary.Actor.GP61YtH3RvicMTkf","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.KcwFM5tI2R4jDalx":"Compendium.pf2e.lost-omens-bestiary.Actor.KcwFM5tI2R4jDalx","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.Lhcwzt64Do7afrbF":"Compendium.pf2e.lost-omens-bestiary.Actor.Lhcwzt64Do7afrbF","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.Mu3obsMXZ0OYlQpo":"Compendium.pf2e.lost-omens-bestiary.Actor.Mu3obsMXZ0OYlQpo","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.XzCBhm6im8iS1UFd":"Compendium.pf2e.lost-omens-bestiary.Actor.XzCBhm6im8iS1UFd","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.fXlmbjtV3spZlmGS":"Compendium.pf2e.lost-omens-bestiary.Actor.fXlmbjtV3spZlmGS","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.k5f4vITTc7mclQzH":"Compendium.pf2e.lost-omens-bestiary.Actor.k5f4vITTc7mclQzH","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.mu36UlW90zHYuzww":"Compendium.pf2e.lost-omens-bestiary.Actor.mu36UlW90zHYuzww","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.n9LLGRKgPI8fDRBk":"Compendium.pf2e.lost-omens-bestiary.Actor.n9LLGRKgPI8fDRBk","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.pcs9Shzxhu62xL4V":"Compendium.pf2e.lost-omens-bestiary.Actor.pcs9Shzxhu62xL4V","Compendium.pf2e.lost-omens-tian-xia-world-guide.Actor.zrx1qjf1WbSYllvz":"Compendium.pf2e.lost-omens-bestiary.Actor.zrx1qjf1WbSYllvz","Compendium.pf2e.lost-omens-travel-guide-bestiary.Actor.FMGyuNpkxMRR1Jrw":"Compendium.pf2e.lost-omens-bestiary.Actor.FMGyuNpkxMRR1Jrw","Compendium.pf2e.lost-omens-travel-guide-bestiary.Actor.MQBH5svYUyhd3RsK":"Compendium.pf2e.lost-omens-bestiary.Actor.MQBH5svYUyhd3RsK","Compendium.pf2e.lost-omens-travel-guide-bestiary.Actor.Oefb1ZCYp2DolpZr":"Compendium.pf2e.lost-omens-bestiary.Actor.Oefb1ZCYp2DolpZr","Compendium.pf2e.lost-omens-travel-guide-bestiary.Actor.mpT2AbFjoyDBDN5l":"Compendium.pf2e.lost-omens-bestiary.Actor.mpT2AbFjoyDBDN5l","Compendium.pf2e.lost-omens-travel-guide-bestiary.Actor.yRhCsQsoz1Uqvkmk":"Compendium.pf2e.lost-omens-bestiary.Actor.yRhCsQsoz1Uqvkmk","Compendium.pf2e.menace-under-otari-bestiary.Actor.0oWKApY5FR8IO7GG":"Compendium.pf2e.menace-under-otari-bestiary.Actor.YReM6QbqwUz3UTP7","Compendium.pf2e.menace-under-otari-bestiary.Actor.0plBflWwrCWQO2RO":"Compendium.pf2e.menace-under-otari-bestiary.Actor.Xo4IGzw28hivgMmM","Compendium.pf2e.menace-under-otari-bestiary.Actor.2H2AEwQnfKJC0nrd":"Compendium.pf2e.menace-under-otari-bestiary.Actor.N98ug9jQHqeFoK1N","Compendium.pf2e.menace-under-otari-bestiary.Actor.2vyM10zN0JYdzyxt":"Compendium.pf2e.menace-under-otari-bestiary.Actor.mEZUTqNIgu0ASApu","Compendium.pf2e.menace-under-otari-bestiary.Actor.4MwjCsa5O9aAjxSm":"Compendium.pf2e.menace-under-otari-bestiary.Actor.IyhbcdTVmkV4pSju","Compendium.pf2e.menace-under-otari-bestiary.Actor.5H8ZX7y5IkUBhvhF":"Compendium.pf2e.menace-under-otari-bestiary.Actor.trchDxbDR2TiPMxT","Compendium.pf2e.menace-under-otari-bestiary.Actor.5MVBU86ZRw2ANMQn":"Compendium.pf2e.menace-under-otari-bestiary.Actor.sEgjgitJmwYYa4mV","Compendium.pf2e.menace-under-otari-bestiary.Actor.5xjmJoJvBhASkEKS":"Compendium.pf2e.menace-under-otari-bestiary.Actor.PLZk6zY5iwccPTPS","Compendium.pf2e.menace-under-otari-bestiary.Actor.6NdqvKIlxo4cGhf8":"Compendium.pf2e.menace-under-otari-bestiary.Actor.A4VgQIHsqJKssQOM","Compendium.pf2e.menace-under-otari-bestiary.Actor.7AzIsyvVOg19fSoa":"Compendium.pf2e.menace-under-otari-bestiary.Actor.9YPFqikAmURwcTEO","Compendium.pf2e.menace-under-otari-bestiary.Actor.7EuWv6tGtOASvzbG":"Compendium.pf2e.menace-under-otari-bestiary.Actor.SZCf0IZkf36plwVd","Compendium.pf2e.menace-under-otari-bestiary.Actor.9sa2KE4Fbh3OPH7M":"Compendium.pf2e.menace-under-otari-bestiary.Actor.H7z7VHzlHlEFev1r","Compendium.pf2e.menace-under-otari-bestiary.Actor.AYwdybUfm4meGUTJ":"Compendium.pf2e.menace-under-otari-bestiary.Actor.iIJPJcDT8wlJ8z5M","Compendium.pf2e.menace-under-otari-bestiary.Actor.AuCC04X2AO8oFN75":"Compendium.pf2e.menace-under-otari-bestiary.Actor.uBNm3R9wbLTPrM9i","Compendium.pf2e.menace-under-otari-bestiary.Actor.BKPRkJgq7ehsW7uX":"Compendium.pf2e.menace-under-otari-bestiary.Actor.NRBgcu0LkXXp8mtp","Compendium.pf2e.menace-under-otari-bestiary.Actor.CF82XJwObLx0TPnV":"Compendium.pf2e.menace-under-otari-bestiary.Actor.x7Aa4Tvr9eBaHryF","Compendium.pf2e.menace-under-otari-bestiary.Actor.EtRqBsWh1Hv1toqh":"Compendium.pf2e.menace-under-otari-bestiary.Actor.V90OYOMyyPLPJuod","Compendium.pf2e.menace-under-otari-bestiary.Actor.Hkq9ZS2J2iKnT7vT":"Compendium.pf2e.menace-under-otari-bestiary.Actor.9InGpxq5xbbHaL9f","Compendium.pf2e.menace-under-otari-bestiary.Actor.KsWAIXTTh3mfNWOY":"Compendium.pf2e.menace-under-otari-bestiary.Actor.AJ5LuNMVPLCydryP","Compendium.pf2e.menace-under-otari-bestiary.Actor.LHHgGSs0ELCR4CYK":"Compendium.pf2e.menace-under-otari-bestiary.Actor.iLkQt8A99nQWUI8k","Compendium.pf2e.menace-under-otari-bestiary.Actor.M8oJOKJ4AgrLZcJQ":"Compendium.pf2e.menace-under-otari-bestiary.Actor.NW68bxCLC6oDHxL9","Compendium.pf2e.menace-under-otari-bestiary.Actor.NVWaLagWOu5tCCZu":"Compendium.pf2e.menace-under-otari-bestiary.Actor.VQPzDz3xnCQGFOGL","Compendium.pf2e.menace-under-otari-bestiary.Actor.Oilfs8Atv2LjAsUS":"Compendium.pf2e.menace-under-otari-bestiary.Actor.BN5Lb6IsQ9Wyu3rL","Compendium.pf2e.menace-under-otari-bestiary.Actor.RTzFvmdSCf5yhguy":"Compendium.pf2e.menace-under-otari-bestiary.Actor.5vBG8a8dnJfmVd3Y","Compendium.pf2e.menace-under-otari-bestiary.Actor.Rr1wwJ1jIIhRZbXh":"Compendium.pf2e.menace-under-otari-bestiary.Actor.AcUb8s5fiktYw8Fx","Compendium.pf2e.menace-under-otari-bestiary.Actor.UjREHs2JQoO85Glt":"Compendium.pf2e.menace-under-otari-bestiary.Actor.9cBuzDV8seJqhNKJ","Compendium.pf2e.menace-under-otari-bestiary.Actor.XrmHgbKgcHDi4OnK":"Compendium.pf2e.menace-under-otari-bestiary.Actor.VotlWUsFKdOrHWF6","Compendium.pf2e.menace-under-otari-bestiary.Actor.YdBCG0vzOA5BgoIi":"Compendium.pf2e.menace-under-otari-bestiary.Actor.7w1w7VTnIWMBdFux","Compendium.pf2e.menace-under-otari-bestiary.Actor.ZPjQkKVMi3xoPcU0":"Compendium.pf2e.menace-under-otari-bestiary.Actor.DBTbqI9QQRtlJwWh","Compendium.pf2e.menace-under-otari-bestiary.Actor.aeCoh4u6c5kt1iCs":"Compendium.pf2e.menace-under-otari-bestiary.Actor.cvfIkEF6xmWn2soN","Compendium.pf2e.menace-under-otari-bestiary.Actor.cBHpMcVaLRPZu9po":"Compendium.pf2e.menace-under-otari-bestiary.Actor.sAfjpjAS56jtrUbi","Compendium.pf2e.menace-under-otari-bestiary.Actor.cZDiyluplFqRxmGy":"Compendium.pf2e.menace-under-otari-bestiary.Actor.CFlx1tkRxKC9qAC7","Compendium.pf2e.menace-under-otari-bestiary.Actor.eq4tLYV3efCS2ouP":"Compendium.pf2e.menace-under-otari-bestiary.Actor.Rr1u6WvZEdPw1s6v","Compendium.pf2e.menace-under-otari-bestiary.Actor.gdXok08bITkhowDJ":"Compendium.pf2e.menace-under-otari-bestiary.Actor.Twvzy1yRo6m6dM8D","Compendium.pf2e.menace-under-otari-bestiary.Actor.gvCCATlH9mPGWbsp":"Compendium.pf2e.menace-under-otari-bestiary.Actor.htK4dElL6YvFCLkz","Compendium.pf2e.menace-under-otari-bestiary.Actor.hiGwRWdxAsoCII4f":"Compendium.pf2e.menace-under-otari-bestiary.Actor.xN5J9S485LxFZMkL","Compendium.pf2e.menace-under-otari-bestiary.Actor.jGzVwekcRX5aQpbT":"Compendium.pf2e.menace-under-otari-bestiary.Actor.sA2dFdRUwiapo69Z","Compendium.pf2e.menace-under-otari-bestiary.Actor.jVZRROs0GzDjVrgi":"Compendium.pf2e.menace-under-otari-bestiary.Actor.fLLKuOXwPq1Iq0U4","Compendium.pf2e.menace-under-otari-bestiary.Actor.jeAGl6OAVrrIPgu3":"Compendium.pf2e.menace-under-otari-bestiary.Actor.RTviEfjYnsXa0wkT","Compendium.pf2e.menace-under-otari-bestiary.Actor.jnmUcTs4hn1c5bz9":"Compendium.pf2e.menace-under-otari-bestiary.Actor.aeOzCBpwnUVcpqxI","Compendium.pf2e.menace-under-otari-bestiary.Actor.lFlXmieuHTBIonhj":"Compendium.pf2e.menace-under-otari-bestiary.Actor.1uVwkGlqYzyWaDMy","Compendium.pf2e.menace-under-otari-bestiary.Actor.mX47c0W9rizbmMBM":"Compendium.pf2e.menace-under-otari-bestiary.Actor.mX47c0W9rizbmMBM","Compendium.pf2e.menace-under-otari-bestiary.Actor.r9w1n85mp9Ip4QiS":"Compendium.pf2e.menace-under-otari-bestiary.Actor.BIZfjoz8DZt75EDn","Compendium.pf2e.menace-under-otari-bestiary.Actor.rPaHIh0ICnTLnRO6":"Compendium.pf2e.menace-under-otari-bestiary.Actor.PcHQDmPTztw32PhL","Compendium.pf2e.menace-under-otari-bestiary.Actor.shT19KaQjWRVrHLI":"Compendium.pf2e.menace-under-otari-bestiary.Actor.Ky5eNRvN71O0tY9l","Compendium.pf2e.menace-under-otari-bestiary.Actor.wCmlY4TixUlPm5Qx":"Compendium.pf2e.menace-under-otari-bestiary.Actor.vN2alMciNlKpBpKN","Compendium.pf2e.menace-under-otari-bestiary.Actor.wqPYzMNgYvrO6oEP":"Compendium.pf2e.menace-under-otari-bestiary.Actor.kB7FNn3vosp6cqQg","Compendium.pf2e.npc-gallery.Actor.KvcFqH6H4TFCuBZA":"Compendium.pf2e.pathfinder-monster-core.Actor.ZXiFjrQbhvboEZTL","Compendium.pf2e.npc-gallery.Actor.sZ9RwN8zIzpztW3N":"Compendium.pf2e.pathfinder-monster-core.Actor.jTszZSs0K6vOqidM","Compendium.pf2e.npc-gallery.Actor.0Ex7rBuiJVu2NwCz":"Compendium.pf2e.pathfinder-npc-core.Actor.hR9n5d0tfyOkeZFb","Compendium.pf2e.npc-gallery.Actor.0Kb4z4h8KVqfrIju":"Compendium.pf2e.pathfinder-npc-core.Actor.jOASgCgSyk3enLfP","Compendium.pf2e.npc-gallery.Actor.1iz7O6DLDJqStojd":"Compendium.pf2e.pathfinder-npc-core.Actor.mgEMfxh0VUbBepc2","Compendium.pf2e.npc-gallery.Actor.1NZ1ZAgcUlWKmQSs":"Compendium.pf2e.pathfinder-npc-core.Actor.XrXTfNGxEWLE9Qqb","Compendium.pf2e.npc-gallery.Actor.1sWw5OgmpazLVqRQ":"Compendium.pf2e.pathfinder-npc-core.Actor.x7Mnb3F4r6JvXD9C","Compendium.pf2e.npc-gallery.Actor.1U1URD7IyddoD5zE":"Compendium.pf2e.pathfinder-npc-core.Actor.HBcKkBXyGaWXZxSs","Compendium.pf2e.npc-gallery.Actor.3lZhmvNLQkiYGAof":"Compendium.pf2e.pathfinder-npc-core.Actor.3R2J90R84AUgFJH2","Compendium.pf2e.npc-gallery.Actor.51E3fdESgGjQxcMv":"Compendium.pf2e.pathfinder-npc-core.Actor.Y0MSOv0l5ePhP3Co","Compendium.pf2e.npc-gallery.Actor.5LvpvIMhaYLcyAk6":"Compendium.pf2e.pathfinder-npc-core.Actor.55Hb1FTqRGtoGuJt","Compendium.pf2e.npc-gallery.Actor.7eJJIIVEDB3EFFcZ":"Compendium.pf2e.pathfinder-npc-core.Actor.3jkmJgV4zwygUqLy","Compendium.pf2e.npc-gallery.Actor.7GGHuOlSzcaF2AdL":"Compendium.pf2e.pathfinder-npc-core.Actor.BcJ36KvuUysWW3BD","Compendium.pf2e.npc-gallery.Actor.7RF95b3WHkvHWLrv":"Compendium.pf2e.pathfinder-npc-core.Actor.GXmIABEvzmySOHRH","Compendium.pf2e.npc-gallery.Actor.8coHofIpLa5ZnjAF":"Compendium.pf2e.pathfinder-npc-core.Actor.nnrvoNBUzKyKQLu4","Compendium.pf2e.npc-gallery.Actor.8WFGygPv7UHh7zdJ":"Compendium.pf2e.pathfinder-npc-core.Actor.h4gPulyY9uzkAbyo","Compendium.pf2e.npc-gallery.Actor.9jDT7EhtlZtNpCz7":"Compendium.pf2e.pathfinder-npc-core.Actor.OAxxUyACpMlX3q1X","Compendium.pf2e.npc-gallery.Actor.aJR3f8YcAkmfx7im":"Compendium.pf2e.pathfinder-npc-core.Actor.STds4rxF5ESFLLML","Compendium.pf2e.npc-gallery.Actor.Ap87yR4WOs0wKHx7":"Compendium.pf2e.pathfinder-npc-core.Actor.GbPDSJeXjHc1VRN2","Compendium.pf2e.npc-gallery.Actor.B09JfuBZHjcRXztU":"Compendium.pf2e.pathfinder-npc-core.Actor.sSa18Ra6zGc4Mp71","Compendium.pf2e.npc-gallery.Actor.B0pZAGooj735FGfw":"Compendium.pf2e.pathfinder-npc-core.Actor.Yl6pxCXAoFECt89L","Compendium.pf2e.npc-gallery.Actor.B13dyXTo1xWVyj2R":"Compendium.pf2e.pathfinder-npc-core.Actor.94fOoBeUT8PgTywH","Compendium.pf2e.npc-gallery.Actor.cAOWcPIjtZYXYZ3i":"Compendium.pf2e.pathfinder-npc-core.Actor.qCKNT6U8O0su578A","Compendium.pf2e.npc-gallery.Actor.Cnm5zWmuTEYy6mPx":"Compendium.pf2e.pathfinder-npc-core.Actor.fBd8Cfe7fRtF8HoJ","Compendium.pf2e.npc-gallery.Actor.DD2JNeRxO79WFlOL":"Compendium.pf2e.pathfinder-npc-core.Actor.fpwpA2JmpbwREa5a","Compendium.pf2e.npc-gallery.Actor.DFurZlcpcNrUmmER":"Compendium.pf2e.pathfinder-npc-core.Actor.MNb1Hjd2gKimnfvV","Compendium.pf2e.npc-gallery.Actor.DSA03902sWGot0ev":"Compendium.pf2e.pathfinder-npc-core.Actor.GKDMvepxkEsUnN5d","Compendium.pf2e.npc-gallery.Actor.EslFhpdvQf7KN8W3":"Compendium.pf2e.pathfinder-npc-core.Actor.qtD7Xa8Mgl0Y63os","Compendium.pf2e.npc-gallery.Actor.EzD6YlNXL48rN8nq":"Compendium.pf2e.pathfinder-npc-core.Actor.u1Np0sUKfkTxrNT1","Compendium.pf2e.npc-gallery.Actor.G2ftdkyJ5WDonL0C":"Compendium.pf2e.pathfinder-npc-core.Actor.a36bfgbqp1lt2bik","Compendium.pf2e.npc-gallery.Actor.GoGNtiHuYycppLPk":"Compendium.pf2e.pathfinder-npc-core.Actor.dNATu2RQLFYY3hYn","Compendium.pf2e.npc-gallery.Actor.GRtEwNQgKQ9j9JPK":"Compendium.pf2e.pathfinder-npc-core.Actor.UcyRCjAUf7mijca0","Compendium.pf2e.npc-gallery.Actor.gzirsGA07yG6CaG8":"Compendium.pf2e.pathfinder-npc-core.Actor.4okKASZDvBWTSu1U","Compendium.pf2e.npc-gallery.Actor.hK8Tpg3baKWzmPEv":"Compendium.pf2e.pathfinder-npc-core.Actor.Xxnho8AZopSuhgHP","Compendium.pf2e.npc-gallery.Actor.Hle05FibgOeZr7wF":"Compendium.pf2e.pathfinder-npc-core.Actor.XqIKuHK4R6yFOKbs","Compendium.pf2e.npc-gallery.Actor.IaSxoVNZFYatdfjI":"Compendium.pf2e.pathfinder-npc-core.Actor.xxH95k9qf6lLit4W","Compendium.pf2e.npc-gallery.Actor.ImdKLPgazv4MSI0F":"Compendium.pf2e.pathfinder-npc-core.Actor.HbYwSi428oXESdNh","Compendium.pf2e.npc-gallery.Actor.IQJT1Bg9FhvHHEap":"Compendium.pf2e.pathfinder-npc-core.Actor.xjJV1G5FBeLV4KPQ","Compendium.pf2e.npc-gallery.Actor.Jg9OEmo68KC91PgC":"Compendium.pf2e.pathfinder-npc-core.Actor.EuDz8wgZY3nxyBTr","Compendium.pf2e.npc-gallery.Actor.JsTI2SEZdg2j03gf":"Compendium.pf2e.pathfinder-npc-core.Actor.d47PtIdozWwSOtur","Compendium.pf2e.npc-gallery.Actor.K8mtLJ5jgxfqxTCv":"Compendium.pf2e.pathfinder-npc-core.Actor.taNAx8xPuOJ3EmxC","Compendium.pf2e.npc-gallery.Actor.kmHYc2fvhd4QsUEV":"Compendium.pf2e.pathfinder-npc-core.Actor.BcSzGmSxCn0uWkxU","Compendium.pf2e.npc-gallery.Actor.KPUDfkVpemug2gKj":"Compendium.pf2e.pathfinder-npc-core.Actor.FBq4bqtKUBpJUCMU","Compendium.pf2e.npc-gallery.Actor.KUDsYCHduF0JE3yf":"Compendium.pf2e.pathfinder-npc-core.Actor.bMKM6SKTBN8M4I8K","Compendium.pf2e.npc-gallery.Actor.ldaY3QcPczuFoqBC":"Compendium.pf2e.pathfinder-npc-core.Actor.txVORfqTxVCMD75C","Compendium.pf2e.npc-gallery.Actor.lemVxzg2Pnx9Nu3d":"Compendium.pf2e.pathfinder-npc-core.Actor.55t4OPNXDx6fAeZd","Compendium.pf2e.npc-gallery.Actor.lfXQECIiN0zZdf95":"Compendium.pf2e.pathfinder-npc-core.Actor.r7nprCpuqhEulxjD","Compendium.pf2e.npc-gallery.Actor.lTcX8tk6JjQBFcq1":"Compendium.pf2e.pathfinder-npc-core.Actor.0iyGP5rLXE6NxdRr","Compendium.pf2e.npc-gallery.Actor.mblLgQ9NMR2mMI99":"Compendium.pf2e.pathfinder-npc-core.Actor.zqesJ7AlPM39Qqcw","Compendium.pf2e.npc-gallery.Actor.ny37LcdsPLY9Osby":"Compendium.pf2e.pathfinder-npc-core.Actor.qQzry7keeMVUzfpt","Compendium.pf2e.npc-gallery.Actor.o9dAbSVn4Vi4ejjc":"Compendium.pf2e.pathfinder-npc-core.Actor.0So6avVuyVG7YOfs","Compendium.pf2e.npc-gallery.Actor.p94aKz7KsiAQJscm":"Compendium.pf2e.pathfinder-npc-core.Actor.oIHp4amcx8ecZRwM","Compendium.pf2e.npc-gallery.Actor.PLOfWPKwB7pE4arv":"Compendium.pf2e.pathfinder-npc-core.Actor.BYpxg06tP5hI6CzQ","Compendium.pf2e.npc-gallery.Actor.pMKrTXmrzDOc9avN":"Compendium.pf2e.pathfinder-npc-core.Actor.MKwLXGzr48qU0hZR","Compendium.pf2e.npc-gallery.Actor.PoIuzIWFnlAQ8pdH":"Compendium.pf2e.pathfinder-npc-core.Actor.eF87AWFclYpu1cgD","Compendium.pf2e.npc-gallery.Actor.pZOgcQRwXrX9g0s8":"Compendium.pf2e.pathfinder-npc-core.Actor.fadWrz7SnifBx4yz","Compendium.pf2e.npc-gallery.Actor.QAodADCKmbkf53CE":"Compendium.pf2e.pathfinder-npc-core.Actor.GkatOjGPdFT9z0od","Compendium.pf2e.npc-gallery.Actor.QZmckb7O3PNgY7D6":"Compendium.pf2e.pathfinder-npc-core.Actor.Wv4jaiD6X8negvH2","Compendium.pf2e.npc-gallery.Actor.R5SWtNtQt8l7WLYk":"Compendium.pf2e.pathfinder-npc-core.Actor.lSRNLWRwi9Vhfy25","Compendium.pf2e.npc-gallery.Actor.rsATu823vatRe7QJ":"Compendium.pf2e.pathfinder-npc-core.Actor.Aktz95gNNzfAiTzk","Compendium.pf2e.npc-gallery.Actor.saUg5rtaO9kI9Vir":"Compendium.pf2e.pathfinder-npc-core.Actor.vGcspyaP2VOwurMk","Compendium.pf2e.npc-gallery.Actor.sKSfQmJMEsj8QN12":"Compendium.pf2e.pathfinder-npc-core.Actor.PBb2WprHhEIQE9jN","Compendium.pf2e.npc-gallery.Actor.SwjcZsbkcq6PhiXc":"Compendium.pf2e.pathfinder-npc-core.Actor.PXukrrvpLA40chXN","Compendium.pf2e.npc-gallery.Actor.t7QwdZ2m7AbuRWqd":"Compendium.pf2e.pathfinder-npc-core.Actor.vEdg4AXGWfet1Cgy","Compendium.pf2e.npc-gallery.Actor.tbiThWX0gAVZAMor":"Compendium.pf2e.pathfinder-npc-core.Actor.vfFB2za4zaQnXYIa","Compendium.pf2e.npc-gallery.Actor.TCzxsJQjUpy02CsJ":"Compendium.pf2e.pathfinder-npc-core.Actor.CFBDZzfWCANLJcpF","Compendium.pf2e.npc-gallery.Actor.TgeUj2IiyoTeZHIO":"Compendium.pf2e.pathfinder-npc-core.Actor.thDJ5N0wUvI1JOa6","Compendium.pf2e.npc-gallery.Actor.Tj03FbN4SSr0o953":"Compendium.pf2e.pathfinder-npc-core.Actor.5KojtpJA0T5xoum4","Compendium.pf2e.npc-gallery.Actor.u3tXaX3sOtCvuHW3":"Compendium.pf2e.pathfinder-npc-core.Actor.bZRZahVaMyzTbJ4u","Compendium.pf2e.npc-gallery.Actor.vkLhqX5oR1t89puZ":"Compendium.pf2e.pathfinder-npc-core.Actor.AdZ4EklEmpHViycl","Compendium.pf2e.npc-gallery.Actor.w4VJ6h4mysbpdoN4":"Compendium.pf2e.pathfinder-npc-core.Actor.14yAShROmGYdRS1Z","Compendium.pf2e.npc-gallery.Actor.W9lhKuDeS670LzLx":"Compendium.pf2e.pathfinder-npc-core.Actor.mbuHsZrLEieLEES0","Compendium.pf2e.npc-gallery.Actor.wfsT2QDtQhsFXQfE":"Compendium.pf2e.pathfinder-npc-core.Actor.oaqt9bociCp9e3Yr","Compendium.pf2e.npc-gallery.Actor.WTCFE1BYdZGWJHh7":"Compendium.pf2e.pathfinder-npc-core.Actor.0t2jNg5tpwWbCYx4","Compendium.pf2e.npc-gallery.Actor.X1cSs1jhTtx1zTI4":"Compendium.pf2e.pathfinder-npc-core.Actor.6CRUvM2p9csP735v","Compendium.pf2e.npc-gallery.Actor.X7LmMMEOFUUicQ2O":"Compendium.pf2e.pathfinder-npc-core.Actor.ndCqM6yNTg2QPZwK","Compendium.pf2e.npc-gallery.Actor.xY2WjwebqTNXAP0q":"Compendium.pf2e.pathfinder-npc-core.Actor.APn9B54hhRtr0oCQ","Compendium.pf2e.npc-gallery.Actor.Za701s0CV37YPOyo":"Compendium.pf2e.pathfinder-npc-core.Actor.pHaQew7IEmk198Wz","Compendium.pf2e.npc-gallery.Actor.Zd0K8TOkthc4a4l7":"Compendium.pf2e.pathfinder-npc-core.Actor.sYcMzx8RcgaIxyLu","Compendium.pf2e.npc-gallery.Actor.zQfufnnLCTzQ165S":"Compendium.pf2e.pathfinder-npc-core.Actor.3qDYEHtyAobpCg5r","Compendium.pf2e.other-effects.Item.la8rWwUtReElgTS6":"Compendium.pf2e.feat-effects.Item.la8rWwUtReElgTS6","Compendium.pf2e.pathfinder-bestiary-2.Actor.12vyw160K7p3M3Mt":"Compendium.pf2e.pathfinder-monster-core.Actor.zeK0ii5YaynhtQi0","Compendium.pf2e.pathfinder-bestiary-2.Actor.340AwQpRXGblw1kF":"Compendium.pf2e.pathfinder-monster-core.Actor.UMlGhyoHMvhVW6kv","Compendium.pf2e.pathfinder-bestiary-2.Actor.3YcsuATyahEMygNy":"Compendium.pf2e.pathfinder-monster-core.Actor.bsrQp0pLgvjJr6mC","Compendium.pf2e.pathfinder-bestiary-2.Actor.7SVhYtnBn967Hy8O":"Compendium.pf2e.pathfinder-monster-core.Actor.SMLMW81mKN5VlcVV","Compendium.pf2e.pathfinder-bestiary-2.Actor.8a9N2iPA5HLpkWaF":"Compendium.pf2e.pathfinder-monster-core.Actor.drcSWbCIWc7P4lKO","Compendium.pf2e.pathfinder-bestiary-2.Actor.8usfZlFqdD9cchPJ":"Compendium.pf2e.pathfinder-monster-core.Actor.YZ4G7eRQ49dTVtjb","Compendium.pf2e.pathfinder-bestiary-2.Actor.a8Ih1RIr4UUV4QCL":"Compendium.pf2e.pathfinder-monster-core.Actor.Wlupxz7dmKb6BYcr","Compendium.pf2e.pathfinder-bestiary-2.Actor.ABrzFoOqQohQqU6C":"Compendium.pf2e.pathfinder-monster-core.Actor.00uNOPsU5VognIcB","Compendium.pf2e.pathfinder-bestiary-2.Actor.dBUiB3Hyh0hN8Exc":"Compendium.pf2e.pathfinder-monster-core.Actor.loYbh3SealeYmxai","Compendium.pf2e.pathfinder-bestiary-2.Actor.dwyt7e1EZPjw9KBB":"Compendium.pf2e.pathfinder-monster-core.Actor.wvP8zBmI0PDO1Uq2","Compendium.pf2e.pathfinder-bestiary-2.Actor.EOiOqs1vHCxZAj3T":"Compendium.pf2e.pathfinder-monster-core.Actor.2p7MEk4SdXfLbzxO","Compendium.pf2e.pathfinder-bestiary-2.Actor.fRLrlY25qXkOMBNG":"Compendium.pf2e.pathfinder-monster-core.Actor.dY1wqHKN6PV4oJ07","Compendium.pf2e.pathfinder-bestiary-2.Actor.fv91xoQJlogVbruW":"Compendium.pf2e.pathfinder-monster-core.Actor.X3QcYLr2rBcIsJrC","Compendium.pf2e.pathfinder-bestiary-2.Actor.GnKay44MFMZkqXRi":"Compendium.pf2e.pathfinder-monster-core.Actor.3zqVFz4FfRYv5Sgy","Compendium.pf2e.pathfinder-bestiary-2.Actor.H8KNSMb9uo2mJF3P":"Compendium.pf2e.pathfinder-monster-core.Actor.9sGgANyNFCKnu06t","Compendium.pf2e.pathfinder-bestiary-2.Actor.HBkk9MYLomjKDKr4":"Compendium.pf2e.pathfinder-monster-core.Actor.cRBVKMNukkRgELMs","Compendium.pf2e.pathfinder-bestiary-2.Actor.HhSoTr6mpwV09Y4k":"Compendium.pf2e.pathfinder-monster-core.Actor.DEZNEMDhWXvv7BrT","Compendium.pf2e.pathfinder-bestiary-2.Actor.JCoILqEvwovT7tkj":"Compendium.pf2e.pathfinder-monster-core.Actor.Hl1Nnnda8KSf0Obp","Compendium.pf2e.pathfinder-bestiary-2.Actor.M4mDroIJlrBYfHkM":"Compendium.pf2e.pathfinder-monster-core.Actor.TlDmc2ZKeIAJuD5v","Compendium.pf2e.pathfinder-bestiary-2.Actor.MUVc2ZjwGtlpcuX1":"Compendium.pf2e.pathfinder-monster-core.Actor.TwFcW5O5J1SdsYv3","Compendium.pf2e.pathfinder-bestiary-2.Actor.N7Ej1AyPPolzboex":"Compendium.pf2e.pathfinder-monster-core.Actor.sC4B1pjGrKFXhjOQ","Compendium.pf2e.pathfinder-bestiary-2.Actor.NtezcliwnH4R1tJw":"Compendium.pf2e.pathfinder-monster-core.Actor.mEjCLVRt7iDiNZL6","Compendium.pf2e.pathfinder-bestiary-2.Actor.o2IbtStBj11QCRvS":"Compendium.pf2e.pathfinder-monster-core.Actor.LiURMjxzav8SBKSq","Compendium.pf2e.pathfinder-bestiary-2.Actor.oSQ3Q9tzTohksAtf":"Compendium.pf2e.pathfinder-monster-core.Actor.KH1GkazaI59zftst","Compendium.pf2e.pathfinder-bestiary-2.Actor.PAGytLw1QnAiNYC2":"Compendium.pf2e.pathfinder-monster-core.Actor.y2w2jjs2O3gP0H5v","Compendium.pf2e.pathfinder-bestiary-2.Actor.QR3AC4mkpfz6KPSh":"Compendium.pf2e.pathfinder-monster-core.Actor.YhVYGhzNrOFQROui","Compendium.pf2e.pathfinder-bestiary-2.Actor.R0dyG06kbNYiCqRW":"Compendium.pf2e.pathfinder-monster-core.Actor.VGPtiSeeT7CYgWrv","Compendium.pf2e.pathfinder-bestiary-2.Actor.RqcIiiNNEkF28ui2":"Compendium.pf2e.pathfinder-monster-core.Actor.uco1YijAEotYjdnF","Compendium.pf2e.pathfinder-bestiary-2.Actor.rZdaxjM7CFVAEq2e":"Compendium.pf2e.pathfinder-monster-core.Actor.dUI8N2AXDGcf3qRD","Compendium.pf2e.pathfinder-bestiary-2.Actor.s0wn50S5mGxagSAa":"Compendium.pf2e.pathfinder-monster-core.Actor.0jSkyGbnMiN6kzwH","Compendium.pf2e.pathfinder-bestiary-2.Actor.SpnJQIHLeiJOjEWR":"Compendium.pf2e.pathfinder-monster-core.Actor.JSKZryHwf0Ggq8KR","Compendium.pf2e.pathfinder-bestiary-2.Actor.SYaC46yrqcyp16Dq":"Compendium.pf2e.pathfinder-monster-core.Actor.yS0bUM8R6hb4fIx2","Compendium.pf2e.pathfinder-bestiary-2.Actor.uiTUtcXixZ6TdKYE":"Compendium.pf2e.pathfinder-monster-core.Actor.74TxKGaW7RPzTdbm","Compendium.pf2e.pathfinder-bestiary-2.Actor.URYQ5goPCmrQvJf5":"Compendium.pf2e.pathfinder-monster-core.Actor.mEZUTqNIgu0ASApu","Compendium.pf2e.pathfinder-bestiary-2.Actor.Va2LUALLnnfWX3wq":"Compendium.pf2e.pathfinder-monster-core.Actor.iy5XBb2u4BOVxjtz","Compendium.pf2e.pathfinder-bestiary-2.Actor.W2gd0emEVbD8EGmf":"Compendium.pf2e.pathfinder-monster-core.Actor.tuuSayyL0A5R6hZh","Compendium.pf2e.pathfinder-bestiary-2.Actor.wBGUIPJMm9Van9GQ":"Compendium.pf2e.pathfinder-monster-core.Actor.CIQgNHkiUtBQR2NJ","Compendium.pf2e.pathfinder-bestiary-2.Actor.WMiPblOVq5w2Fa1x":"Compendium.pf2e.pathfinder-monster-core.Actor.KdW5UeZSqeTZZlo5","Compendium.pf2e.pathfinder-bestiary-2.Actor.XCNRztCxn6EbJ0gr":"Compendium.pf2e.pathfinder-monster-core.Actor.8w0LwQHkip8nzFo0","Compendium.pf2e.pathfinder-bestiary-2.Actor.Xv74O1mFzzP06IXl":"Compendium.pf2e.pathfinder-monster-core.Actor.eFGPKbhix65FSG9u","Compendium.pf2e.pathfinder-bestiary-2.Actor.XZZdG5RosoYsF237":"Compendium.pf2e.pathfinder-monster-core.Actor.uzH85ifDz5GU525p","Compendium.pf2e.pathfinder-bestiary-2.Actor.Y1lwEf06O1ijOnwt":"Compendium.pf2e.pathfinder-monster-core.Actor.YKMvlKA1AZJlXtz9","Compendium.pf2e.pathfinder-bestiary-2.Actor.yIpB2uLyeBWQjfsn":"Compendium.pf2e.pathfinder-monster-core.Actor.s492qJ4psEb4FXuy","Compendium.pf2e.pathfinder-bestiary-2.Actor.z39LYFGYmOsoGVSh":"Compendium.pf2e.pathfinder-monster-core.Actor.CHVMOXznjUDcb3XP","Compendium.pf2e.pathfinder-bestiary-3.Actor.7bTj2DC91yEdJiLq":"Compendium.pf2e.pathfinder-monster-core.Actor.NxLQHUMs57TktiZa","Compendium.pf2e.pathfinder-bestiary-3.Actor.8M91u7Q3javRQVEY":"Compendium.pf2e.pathfinder-monster-core.Actor.nFhAJSpbJz1w71EU","Compendium.pf2e.pathfinder-bestiary-3.Actor.cMBXcfS0DuZ7O2vm":"Compendium.pf2e.pathfinder-monster-core.Actor.1ZRHjuGOluR4IUrs","Compendium.pf2e.pathfinder-bestiary-3.Actor.CXCdPqMRX58sBQ9G":"Compendium.pf2e.pathfinder-npc-core.Actor.02AGznZTv5jjcnOg","Compendium.pf2e.pathfinder-bestiary-3.Actor.HPVVewX9vqKH94xf":"Compendium.pf2e.pathfinder-monster-core.Actor.q95mjOkL678a1Wnt","Compendium.pf2e.pathfinder-bestiary-3.Actor.i3Ui3hHIBZnHl0Le":"Compendium.pf2e.pathfinder-monster-core.Actor.H9CHNiW18cRFocNO","Compendium.pf2e.pathfinder-bestiary-3.Actor.iLoVkzve6Nu3gErr":"Compendium.pf2e.pathfinder-monster-core.Actor.oNR29GreK0AxLucN","Compendium.pf2e.pathfinder-bestiary-3.Actor.KSKettq5j3A7UsIh":"Compendium.pf2e.pathfinder-monster-core.Actor.YAGc6gQ5VrvWyR37","Compendium.pf2e.pathfinder-bestiary-3.Actor.mgQSYE94vb2ICVjL":"Compendium.pf2e.pathfinder-monster-core.Actor.pzQhR0mc8HEhXLOZ","Compendium.pf2e.pathfinder-bestiary-3.Actor.NUWL7LHDqmP0c7OB":"Compendium.pf2e.pathfinder-monster-core.Actor.rmJItn5jMW7Af0Iy","Compendium.pf2e.pathfinder-bestiary-3.Actor.ooyJuLQ3AivRwLpa":"Compendium.pf2e.pathfinder-monster-core.Actor.OoUrk7aHE5wq9nLs","Compendium.pf2e.pathfinder-bestiary-3.Actor.phOYPM1OVAKPg68l":"Compendium.pf2e.pathfinder-monster-core.Actor.hvVFocY8r72XEaqQ","Compendium.pf2e.pathfinder-bestiary-3.Actor.PJCeh8sj9Sm5Eqz8":"Compendium.pf2e.pathfinder-monster-core.Actor.UuQHd4v6gG8ONdCt","Compendium.pf2e.pathfinder-bestiary-3.Actor.QUzBzxRy6HLeK7ja":"Compendium.pf2e.pathfinder-monster-core.Actor.IrssIkWkW6fsbHJL","Compendium.pf2e.pathfinder-bestiary-3.Actor.rVtBZrHnWM3lvSs7":"Compendium.pf2e.pathfinder-monster-core.Actor.6UrgCT8MwC8CeGbu","Compendium.pf2e.pathfinder-bestiary-3.Actor.SQKdvPIhWkrHlkbn":"Compendium.pf2e.pathfinder-npc-core.Actor.jAdRgBHut1h1et10","Compendium.pf2e.pathfinder-bestiary-3.Actor.vOTFqODTDDC2BDLx":"Compendium.pf2e.pathfinder-npc-core.Actor.uFQsIRC0zz3sNNIW","Compendium.pf2e.pathfinder-bestiary-3.Actor.XmOYhscNHFw7M2G0":"Compendium.pf2e.pathfinder-monster-core.Actor.yj2nhIS8ZsAJh2l5","Compendium.pf2e.pathfinder-bestiary-3.Actor.ZDGYrJ68aTzZ2EtT":"Compendium.pf2e.pathfinder-monster-core.Actor.9VMoTqyVaKc4ZR4H","Compendium.pf2e.pathfinder-bestiary.Actor.05E3kkjoLZVjFOeO":"Compendium.pf2e.pathfinder-monster-core.Actor.wy8Ve0m3wbHMo1U1","Compendium.pf2e.pathfinder-bestiary.Actor.05wwpHHsBlxBbdkN":"Compendium.pf2e.pathfinder-monster-core.Actor.XDNJSVxOOryeuN44","Compendium.pf2e.pathfinder-bestiary.Actor.0hnnwyqLfYVIenzd":"Compendium.pf2e.pathfinder-monster-core.Actor.6yTmbDaZmrkXUJ4t","Compendium.pf2e.pathfinder-bestiary.Actor.0plBflWwrCWQO2RO":"Compendium.pf2e.pathfinder-monster-core.Actor.Xo4IGzw28hivgMmM","Compendium.pf2e.pathfinder-bestiary.Actor.0rfropeocJWXC6pg":"Compendium.pf2e.pathfinder-monster-core.Actor.yclRuradTmZbdKFQ","Compendium.pf2e.pathfinder-bestiary.Actor.0SAlss24nUMdX9r8":"Compendium.pf2e.pathfinder-monster-core.Actor.hGYIynV60GGfg8Du","Compendium.pf2e.pathfinder-bestiary.Actor.0SJqmk4ItwL31Rg9":"Compendium.pf2e.pathfinder-monster-core.Actor.GNwLVbfFx8EPz7xO","Compendium.pf2e.pathfinder-bestiary.Actor.1CzZINpYRcNBKDnO":"Compendium.pf2e.pathfinder-monster-core.Actor.V8w4iOwUMPqYnqVE","Compendium.pf2e.pathfinder-bestiary.Actor.2GRPw4VK6zfCS2Qw":"Compendium.pf2e.pathfinder-monster-core.Actor.9wNjq9BirBoxyJVH","Compendium.pf2e.pathfinder-bestiary.Actor.2H2AEwQnfKJC0nrd":"Compendium.pf2e.pathfinder-monster-core.Actor.N98ug9jQHqeFoK1N","Compendium.pf2e.pathfinder-bestiary.Actor.2HvXtedQziTTfI0S":"Compendium.pf2e.pathfinder-monster-core.Actor.S67oZ1mvVNz9FTUE","Compendium.pf2e.pathfinder-bestiary.Actor.2IrbfdtWyXiGOLBA":"Compendium.pf2e.pathfinder-monster-core.Actor.k0HUy6WdbZUNfG8X","Compendium.pf2e.pathfinder-bestiary.Actor.2IrWQjtFvsen8ioo":"Compendium.pf2e.pathfinder-monster-core.Actor.wNkS1ArFjS6ZsrPS","Compendium.pf2e.pathfinder-bestiary.Actor.3kLXBdtKpUsU8ey5":"Compendium.pf2e.pathfinder-monster-core.Actor.aj4ZJUULa7VoPYWy","Compendium.pf2e.pathfinder-bestiary.Actor.3VsQFEdIN5e1uWle":"Compendium.pf2e.pathfinder-monster-core.Actor.WamGnH8v0QHz8NFr","Compendium.pf2e.pathfinder-bestiary.Actor.45Eo7MFWG3ShikvD":"Compendium.pf2e.pathfinder-monster-core.Actor.bgKwwvO0uDGD7XsG","Compendium.pf2e.pathfinder-bestiary.Actor.45neevf5aLl0YPyk":"Compendium.pf2e.pathfinder-monster-core.Actor.H8Xq9hZP5bEEI3Hf","Compendium.pf2e.pathfinder-bestiary.Actor.4BBzo72pHOpecoIp":"Compendium.pf2e.pathfinder-monster-core.Actor.wepiUEi2Lxl8j1BH","Compendium.pf2e.pathfinder-bestiary.Actor.4h9jhODg2NwiYsPg":"Compendium.pf2e.pathfinder-monster-core.Actor.vijBriZmbUJjbJNH","Compendium.pf2e.pathfinder-bestiary.Actor.4htFfofrXLkbWMRg":"Compendium.pf2e.pathfinder-monster-core.Actor.9cBuzDV8seJqhNKJ","Compendium.pf2e.pathfinder-bestiary.Actor.4MwjCsa5O9aAjxSm":"Compendium.pf2e.pathfinder-monster-core.Actor.IyhbcdTVmkV4pSju","Compendium.pf2e.pathfinder-bestiary.Actor.4p07SH4zdmVZ405I":"Compendium.pf2e.pathfinder-monster-core.Actor.MCgSMT680ic6kr5k","Compendium.pf2e.pathfinder-bestiary.Actor.4zXn6xaaxo1DtIRk":"Compendium.pf2e.pathfinder-monster-core.Actor.S1XgBHtXIOV3JjLy","Compendium.pf2e.pathfinder-bestiary.Actor.5Azg87M6OnQ7Q4ZS":"Compendium.pf2e.pathfinder-monster-core.Actor.ECe2DkOgSSqXHBqv","Compendium.pf2e.pathfinder-bestiary.Actor.5H8ZX7y5IkUBhvhF":"Compendium.pf2e.pathfinder-monster-core.Actor.trchDxbDR2TiPMxT","Compendium.pf2e.pathfinder-bestiary.Actor.5hQk5NJk4L10txyW":"Compendium.pf2e.pathfinder-monster-core.Actor.xgKDQB6ZYmAutwAm","Compendium.pf2e.pathfinder-bestiary.Actor.5MVBU86ZRw2ANMQn":"Compendium.pf2e.pathfinder-monster-core.Actor.sEgjgitJmwYYa4mV","Compendium.pf2e.pathfinder-bestiary.Actor.5pk6bfodgnllSIOy":"Compendium.pf2e.pathfinder-monster-core.Actor.ka7bXO7HIfBxk8Gy","Compendium.pf2e.pathfinder-bestiary.Actor.5U13zQ77DIcqpH9U":"Compendium.pf2e.pathfinder-monster-core.Actor.h3JksV9Idr9eZLkE","Compendium.pf2e.pathfinder-bestiary.Actor.6CQEelygt968CB7m":"Compendium.pf2e.pathfinder-monster-core.Actor.CYt04IKRQeiC9Ly9","Compendium.pf2e.pathfinder-bestiary.Actor.6eabIbxzYepfZAHX":"Compendium.pf2e.pathfinder-monster-core.Actor.Np5Z7RMQzvSNnH0h","Compendium.pf2e.pathfinder-bestiary.Actor.70JDH25JLTC4t5Ko":"Compendium.pf2e.pathfinder-monster-core.Actor.ClAXGpqu4ZsYuNle","Compendium.pf2e.pathfinder-bestiary.Actor.7JvA7kTqCUwcJoNe":"Compendium.pf2e.pathfinder-monster-core.Actor.httXfBPGseF9csXa","Compendium.pf2e.pathfinder-bestiary.Actor.7ZgQuis8r8YQyUnI":"Compendium.pf2e.pathfinder-monster-core.Actor.alPZcKVrHTcMdtIU","Compendium.pf2e.pathfinder-bestiary.Actor.80TiZrVvIBW7E6L2":"Compendium.pf2e.pathfinder-monster-core.Actor.rEDhI2oI4TqTICN2","Compendium.pf2e.pathfinder-bestiary.Actor.8BloAdRqlLpt5bNg":"Compendium.pf2e.pathfinder-monster-core.Actor.P8pNcpNeXQcj6lBB","Compendium.pf2e.pathfinder-bestiary.Actor.8JvzSTwQWtOsxRfL":"Compendium.pf2e.pathfinder-monster-core.Actor.a4LgD3NrgkiINvru","Compendium.pf2e.pathfinder-bestiary.Actor.8meqlz36gPHTTvNz":"Compendium.pf2e.pathfinder-monster-core.Actor.ciLdEf6sld8h2a2j","Compendium.pf2e.pathfinder-bestiary.Actor.8r8Ar08ojdJuPeiH":"Compendium.pf2e.pathfinder-monster-core.Actor.WBPEvEqIGvxeQKlp","Compendium.pf2e.pathfinder-bestiary.Actor.8U8K0YEghIErml35":"Compendium.pf2e.pathfinder-monster-core.Actor.jh3XmHoFtcGYkdJm","Compendium.pf2e.pathfinder-bestiary.Actor.8uXLbKKzxN5O0ZhM":"Compendium.pf2e.pathfinder-monster-core.Actor.RJFpwZIGbuOuCtXr","Compendium.pf2e.pathfinder-bestiary.Actor.9AlfVoEMLwDODjxl":"Compendium.pf2e.pathfinder-monster-core.Actor.VDm2XhfNwhgiJOxD","Compendium.pf2e.pathfinder-bestiary.Actor.9FZMzpAu4XhCI0IB":"Compendium.pf2e.pathfinder-monster-core.Actor.63gNd2JNUDcAjYzo","Compendium.pf2e.pathfinder-bestiary.Actor.9hOuoOONmp6500GZ":"Compendium.pf2e.pathfinder-monster-core.Actor.mathcxCcrQmn9Jj8","Compendium.pf2e.pathfinder-bestiary.Actor.9llfviiJg5bJlBth":"Compendium.pf2e.pathfinder-monster-core.Actor.IGzoFGlVbkit8hnH","Compendium.pf2e.pathfinder-bestiary.Actor.9qjXP1Lho1UmAihJ":"Compendium.pf2e.pathfinder-monster-core.Actor.7v1gykqjBO1YHDfu","Compendium.pf2e.pathfinder-bestiary.Actor.9sa2KE4Fbh3OPH7M":"Compendium.pf2e.pathfinder-monster-core.Actor.H7z7VHzlHlEFev1r","Compendium.pf2e.pathfinder-bestiary.Actor.9X7hOvCKy1bqw0g6":"Compendium.pf2e.pathfinder-monster-core.Actor.4ISm82EYQeOndynw","Compendium.pf2e.pathfinder-bestiary.Actor.aeCoh4u6c5kt1iCs":"Compendium.pf2e.pathfinder-monster-core.Actor.cvfIkEF6xmWn2soN","Compendium.pf2e.pathfinder-bestiary.Actor.AiPXegCJ1leUslTm":"Compendium.pf2e.pathfinder-monster-core.Actor.md1fhwGMwDv4NNwO","Compendium.pf2e.pathfinder-bestiary.Actor.aNWiP985fISjClGo":"Compendium.pf2e.pathfinder-monster-core.Actor.0rm0UDbXvwg4sSxQ","Compendium.pf2e.pathfinder-bestiary.Actor.atrhmCtNKx1MR06I":"Compendium.pf2e.pathfinder-monster-core.Actor.QIXc18xHrEWDmtKW","Compendium.pf2e.pathfinder-bestiary.Actor.AuCC04X2AO8oFN75":"Compendium.pf2e.pathfinder-monster-core.Actor.uBNm3R9wbLTPrM9i","Compendium.pf2e.pathfinder-bestiary.Actor.AYwdybUfm4meGUTJ":"Compendium.pf2e.pathfinder-monster-core.Actor.iIJPJcDT8wlJ8z5M","Compendium.pf2e.pathfinder-bestiary.Actor.b6qiHvyx6ymROTBL":"Compendium.pf2e.pathfinder-monster-core.Actor.GJShyw6HgV25ywqU","Compendium.pf2e.pathfinder-bestiary.Actor.B7b0alybm5U34nFV":"Compendium.pf2e.pathfinder-monster-core.Actor.15TyWlbDQWNjMKeL","Compendium.pf2e.pathfinder-bestiary.Actor.b8NQkby4QV4uOqFT":"Compendium.pf2e.pathfinder-monster-core.Actor.AZIG0COCaDBronJa","Compendium.pf2e.pathfinder-bestiary.Actor.B8QjalVNcWjuqgG7":"Compendium.pf2e.pathfinder-monster-core.Actor.3QyqHIuAXE3YVLUh","Compendium.pf2e.pathfinder-bestiary.Actor.BAD7npndaooB3Pz1":"Compendium.pf2e.pathfinder-monster-core.Actor.fWAjkhQ0y50Eh2BT","Compendium.pf2e.pathfinder-bestiary.Actor.bAjHCeyNcPRqOmLv":"Compendium.pf2e.pathfinder-monster-core.Actor.RqX0vfUjlycKjGyp","Compendium.pf2e.pathfinder-bestiary.Actor.BeptBpCJ4Ny4biOH":"Compendium.pf2e.pathfinder-monster-core.Actor.v1UK3IwCB8wCbL3L","Compendium.pf2e.pathfinder-bestiary.Actor.bIw7czN0E3rENrVd":"Compendium.pf2e.pathfinder-monster-core.Actor.MkupNnMKqDBElhhp","Compendium.pf2e.pathfinder-bestiary.Actor.bIXfNKFWduf8MH0f":"Compendium.pf2e.pathfinder-monster-core.Actor.oopxVowT2jnUQJiS","Compendium.pf2e.pathfinder-bestiary.Actor.bjJUZKcA47Qp0ZwL":"Compendium.pf2e.pathfinder-monster-core.Actor.HLM55InRGOAUkqoH","Compendium.pf2e.pathfinder-bestiary.Actor.BKPRkJgq7ehsW7uX":"Compendium.pf2e.pathfinder-monster-core.Actor.NRBgcu0LkXXp8mtp","Compendium.pf2e.pathfinder-bestiary.Actor.BLFEu9jCKPAMko01":"Compendium.pf2e.pathfinder-monster-core.Actor.1AZoRkLec47xrTqY","Compendium.pf2e.pathfinder-bestiary.Actor.bLMoqt9xqTZKnjxr":"Compendium.pf2e.pathfinder-monster-core.Actor.Hg7nCvltRBQOiijQ","Compendium.pf2e.pathfinder-bestiary.Actor.bxAJWWKrEMjgNkUp":"Compendium.pf2e.pathfinder-monster-core.Actor.BxOlYmZiwLRpxGWp","Compendium.pf2e.pathfinder-bestiary.Actor.c3iA9lkU1QY4YCY6":"Compendium.pf2e.pathfinder-monster-core.Actor.lYoAwofYGbhWL75Q","Compendium.pf2e.pathfinder-bestiary.Actor.c6AE2Mh8BRtBgbtz":"Compendium.pf2e.pathfinder-monster-core.Actor.z2l8K7woKYPkm0qz","Compendium.pf2e.pathfinder-bestiary.Actor.C9s5tBxVValC2HTE":"Compendium.pf2e.pathfinder-monster-core.Actor.xnpuGO8jEMba9wy5","Compendium.pf2e.pathfinder-bestiary.Actor.cBHpMcVaLRPZu9po":"Compendium.pf2e.pathfinder-monster-core.Actor.sAfjpjAS56jtrUbi","Compendium.pf2e.pathfinder-bestiary.Actor.cDgOfBCrWcpYwRVS":"Compendium.pf2e.pathfinder-monster-core.Actor.lUBkzsSqMfQBczU1","Compendium.pf2e.pathfinder-bestiary.Actor.cDm6PzhO5nXlkGoi":"Compendium.pf2e.pathfinder-monster-core.Actor.YReM6QbqwUz3UTP7","Compendium.pf2e.pathfinder-bestiary.Actor.CFHLgMj8zHLqcagc":"Compendium.pf2e.pathfinder-monster-core.Actor.PUPnGG406PanzIvL","Compendium.pf2e.pathfinder-bestiary.Actor.CJP3GGBXuGgkaj6C":"Compendium.pf2e.pathfinder-monster-core.Actor.6K4RWus85o8iqy0t","Compendium.pf2e.pathfinder-bestiary.Actor.Cq8sRhVVF0hagBu6":"Compendium.pf2e.pathfinder-monster-core.Actor.pPQyoQHTxrE2U7px","Compendium.pf2e.pathfinder-bestiary.Actor.CSefkWGVmA5yGxNR":"Compendium.pf2e.pathfinder-monster-core.Actor.bGp2t0UteEYu3BGe","Compendium.pf2e.pathfinder-bestiary.Actor.cZsaAKlEYWZUO1CV":"Compendium.pf2e.pathfinder-monster-core.Actor.3IPLvfez8DzwwNqm","Compendium.pf2e.pathfinder-bestiary.Actor.cXSTuUJct5iepH75":"Compendium.pf2e.pathfinder-monster-core.Actor.h4cMwW2K34KheWtD","Compendium.pf2e.pathfinder-bestiary.Actor.cZDiyluplFqRxmGy":"Compendium.pf2e.pathfinder-monster-core.Actor.CFlx1tkRxKC9qAC7","Compendium.pf2e.pathfinder-bestiary.Actor.d9W89Yv6zyvfxZuG":"Compendium.pf2e.pathfinder-monster-core.Actor.hmcXFrf8xwrYQIg6","Compendium.pf2e.pathfinder-bestiary.Actor.dEecX0AEfl32KUVN":"Compendium.pf2e.pathfinder-monster-core.Actor.eI6rRuxIPSZcm9OC","Compendium.pf2e.pathfinder-bestiary.Actor.DPEmRRXYevk3ADqW":"Compendium.pf2e.pathfinder-monster-core.Actor.z9jEyLrsoBMmh9qg","Compendium.pf2e.pathfinder-bestiary.Actor.Dwgl1DzJAYE3ienu":"Compendium.pf2e.pathfinder-monster-core.Actor.oZVeE7D70bHOrs1d","Compendium.pf2e.pathfinder-bestiary.Actor.DX1xNtucLTenn3P3":"Compendium.pf2e.pathfinder-monster-core.Actor.nMC9d7ORMz3cdaHa","Compendium.pf2e.pathfinder-bestiary.Actor.E0LCMHVp4sxAbQYa":"Compendium.pf2e.pathfinder-monster-core.Actor.kkAllKGsVCZVGFpf","Compendium.pf2e.pathfinder-bestiary.Actor.E0PIGtVfc5PFVT2C":"Compendium.pf2e.pathfinder-monster-core.Actor.9Bl1ua3uLqodv47s","Compendium.pf2e.pathfinder-bestiary.Actor.E4ctF7Fvi3cdkgQq":"Compendium.pf2e.pathfinder-monster-core.Actor.A4VgQIHsqJKssQOM","Compendium.pf2e.pathfinder-bestiary.Actor.E5RDV3n7GnjAspQ5":"Compendium.pf2e.pathfinder-monster-core.Actor.XZWUQklzWF6YFPmG","Compendium.pf2e.pathfinder-bestiary.Actor.e8rmI5xt6IANatfX":"Compendium.pf2e.pathfinder-monster-core.Actor.3vkQLclK0z4LhAh7","Compendium.pf2e.pathfinder-bestiary.Actor.E9rT02pPDLq7rARq":"Compendium.pf2e.pathfinder-monster-core.Actor.vN2alMciNlKpBpKN","Compendium.pf2e.pathfinder-bestiary.Actor.EhB5Q98OO25DDOOl":"Compendium.pf2e.pathfinder-monster-core.Actor.WZRHV2WU0SkpbtJI","Compendium.pf2e.pathfinder-bestiary.Actor.eHLDsL1LG3jQ1H6Y":"Compendium.pf2e.pathfinder-monster-core.Actor.tashopA1s2fAbSXA","Compendium.pf2e.pathfinder-bestiary.Actor.EibxkD9y30YmPaLH":"Compendium.pf2e.pathfinder-monster-core.Actor.smItqlbr0iuDJ8nL","Compendium.pf2e.pathfinder-bestiary.Actor.eP96NzLFSjua4NS5":"Compendium.pf2e.pathfinder-monster-core.Actor.qtJ36jlcRQw5sBnr","Compendium.pf2e.pathfinder-bestiary.Actor.ePa0KmNPpR4zUPfX":"Compendium.pf2e.pathfinder-monster-core.Actor.qyCcr32PVcnNm4Wr","Compendium.pf2e.pathfinder-bestiary.Actor.eQdLBzkluS1fvVC8":"Compendium.pf2e.pathfinder-monster-core.Actor.SZCf0IZkf36plwVd","Compendium.pf2e.pathfinder-bestiary.Actor.ETwmjdnmSkqGdD5r":"Compendium.pf2e.pathfinder-monster-core.Actor.ybkelAOtSIA06fnj","Compendium.pf2e.pathfinder-bestiary.Actor.Ey19J4nTn1dQvLtE":"Compendium.pf2e.pathfinder-monster-core.Actor.vRAdYovWcy2euwuL","Compendium.pf2e.pathfinder-bestiary.Actor.f3c1CS2W8Tft3hW7":"Compendium.pf2e.pathfinder-monster-core.Actor.EYiIQh526d0HLiDu","Compendium.pf2e.pathfinder-bestiary.Actor.Fa1S0A8fAx3SkO9h":"Compendium.pf2e.pathfinder-monster-core.Actor.YUI465JYqM65iimj","Compendium.pf2e.pathfinder-bestiary.Actor.fgsDAeZHVbHRhSE8":"Compendium.pf2e.pathfinder-monster-core.Actor.MrzlaE7k1PEsd3iQ","Compendium.pf2e.pathfinder-bestiary.Actor.FHfrIJCdKTzy2rrR":"Compendium.pf2e.pathfinder-monster-core.Actor.1a5faH5CCtFfbQHO","Compendium.pf2e.pathfinder-bestiary.Actor.FJo8VkrM7kLkHa5D":"Compendium.pf2e.pathfinder-monster-core.Actor.EDYKUdYmilw3rgJg","Compendium.pf2e.pathfinder-bestiary.Actor.fkBcMpr3Yxxfvz9v":"Compendium.pf2e.pathfinder-monster-core.Actor.hSSe2FxlXKvjKsEw","Compendium.pf2e.pathfinder-bestiary.Actor.FPKoiMXENk5FouXp":"Compendium.pf2e.pathfinder-monster-core.Actor.mx2Xpra7bRJP0GuX","Compendium.pf2e.pathfinder-bestiary.Actor.fxYMucI5b2IUoBpw":"Compendium.pf2e.pathfinder-monster-core.Actor.xz2NZqSG5YVl17dc","Compendium.pf2e.pathfinder-bestiary.Actor.gdXok08bITkhowDJ":"Compendium.pf2e.pathfinder-monster-core.Actor.Twvzy1yRo6m6dM8D","Compendium.pf2e.pathfinder-bestiary.Actor.gfRXFd24U633OC9r":"Compendium.pf2e.pathfinder-monster-core.Actor.lFDYJOIp2knQ0IRY","Compendium.pf2e.pathfinder-bestiary.Actor.gioxLqV8N4p9iIAh":"Compendium.pf2e.pathfinder-monster-core.Actor.mQJL411e9Iz8dJoh","Compendium.pf2e.pathfinder-bestiary.Actor.GssFAdolUA3ghg2e":"Compendium.pf2e.pathfinder-monster-core.Actor.pyTr1VOPrPYH8UNg","Compendium.pf2e.pathfinder-bestiary.Actor.gWxpeqOQ54Jd4HTG":"Compendium.pf2e.pathfinder-monster-core.Actor.AcUb8s5fiktYw8Fx","Compendium.pf2e.pathfinder-bestiary.Actor.gX66KyBxUOvMv5Sf":"Compendium.pf2e.pathfinder-monster-core.Actor.kLhBdqKOMHDGjdFz","Compendium.pf2e.pathfinder-bestiary.Actor.H2ZxTHZOEigpH4LK":"Compendium.pf2e.pathfinder-monster-core.Actor.dFzTXkrpoOOdbzuW","Compendium.pf2e.pathfinder-bestiary.Actor.HbROgIcU9Z9m6XuD":"Compendium.pf2e.pathfinder-monster-core.Actor.Gu0cJHGwPd547OtC","Compendium.pf2e.pathfinder-bestiary.Actor.HeoH8hi5iieKPuJ2":"Compendium.pf2e.pathfinder-monster-core.Actor.zQraVA7SUjd6qGNh","Compendium.pf2e.pathfinder-bestiary.Actor.hiGwRWdxAsoCII4f":"Compendium.pf2e.pathfinder-monster-core.Actor.xN5J9S485LxFZMkL","Compendium.pf2e.pathfinder-bestiary.Actor.Hkq9ZS2J2iKnT7vT":"Compendium.pf2e.pathfinder-monster-core.Actor.9InGpxq5xbbHaL9f","Compendium.pf2e.pathfinder-bestiary.Actor.HpY0addhUqtHMgUN":"Compendium.pf2e.pathfinder-monster-core.Actor.1x0BdpVQLX7o3rrA","Compendium.pf2e.pathfinder-bestiary.Actor.hXpqjD3eBRxlemNs":"Compendium.pf2e.pathfinder-monster-core.Actor.yogotW0edcHEPeuR","Compendium.pf2e.pathfinder-bestiary.Actor.HyOf4CfAIhC3qWtz":"Compendium.pf2e.pathfinder-monster-core.Actor.pH2yNe16EnoJ8R0i","Compendium.pf2e.pathfinder-bestiary.Actor.i1HEQ6f15fMEcHQf":"Compendium.pf2e.pathfinder-monster-core.Actor.Ytp0kRaG8iexmPfN","Compendium.pf2e.pathfinder-bestiary.Actor.I4CpyMUsWfFYdpL5":"Compendium.pf2e.pathfinder-monster-core.Actor.yPYQC2bfOYmqcfIB","Compendium.pf2e.pathfinder-bestiary.Actor.I4o2Gqpr2ioiUXA9":"Compendium.pf2e.pathfinder-monster-core.Actor.7w1w7VTnIWMBdFux","Compendium.pf2e.pathfinder-bestiary.Actor.i6Rd1BE30hhyKxwo":"Compendium.pf2e.pathfinder-monster-core.Actor.E2XL2egIA3QaSDBM","Compendium.pf2e.pathfinder-bestiary.Actor.iA9lbwH0qROTjCva":"Compendium.pf2e.pathfinder-monster-core.Actor.V90OYOMyyPLPJuod","Compendium.pf2e.pathfinder-bestiary.Actor.iD3YlM0QzI2SrjD6":"Compendium.pf2e.pathfinder-monster-core.Actor.v7LH85fl189pXMsR","Compendium.pf2e.pathfinder-bestiary.Actor.In2nNwo3JL1RXQhj":"Compendium.pf2e.pathfinder-monster-core.Actor.CLf9k9A9ApTAkZeL","Compendium.pf2e.pathfinder-bestiary.Actor.io7johJlZinrSCiH":"Compendium.pf2e.pathfinder-monster-core.Actor.gRy6Ci6zb1s4Nvy5","Compendium.pf2e.pathfinder-bestiary.Actor.IpzDMSmJ42alvf9F":"Compendium.pf2e.pathfinder-monster-core.Actor.5SFDHViyTCZ47TR5","Compendium.pf2e.pathfinder-bestiary.Actor.IQsTNM8aXcCUmFu0":"Compendium.pf2e.pathfinder-monster-core.Actor.vqYrJ33XgoeQUUle","Compendium.pf2e.pathfinder-bestiary.Actor.iSwUKe7cEytclS7r":"Compendium.pf2e.pathfinder-monster-core.Actor.4MoqBCDQA6FR1sPw","Compendium.pf2e.pathfinder-bestiary.Actor.IUzKFRX0uHl1yxkn":"Compendium.pf2e.pathfinder-monster-core.Actor.5meW7DytYnF7Iq2V","Compendium.pf2e.pathfinder-bestiary.Actor.Ix1PziAEk9IIMYBz":"Compendium.pf2e.pathfinder-monster-core.Actor.WioQ6rOeMRuTOliY","Compendium.pf2e.pathfinder-bestiary.Actor.IXen98RbUlbxDWBD":"Compendium.pf2e.pathfinder-monster-core.Actor.Iwk2qT4lVyrvoz3B","Compendium.pf2e.pathfinder-bestiary.Actor.J0dSbywBRgD2kf19":"Compendium.pf2e.pathfinder-monster-core.Actor.6aaBmiOgqZ5h2IhW","Compendium.pf2e.pathfinder-bestiary.Actor.jeAGl6OAVrrIPgu3":"Compendium.pf2e.pathfinder-monster-core.Actor.RTviEfjYnsXa0wkT","Compendium.pf2e.pathfinder-bestiary.Actor.jGzVwekcRX5aQpbT":"Compendium.pf2e.pathfinder-monster-core.Actor.sA2dFdRUwiapo69Z","Compendium.pf2e.pathfinder-bestiary.Actor.JkBJ8B07ElXrfDaG":"Compendium.pf2e.pathfinder-monster-core.Actor.EH84J9FedbK3ax50","Compendium.pf2e.pathfinder-bestiary.Actor.jMiiQDIDxW9ZMvCV":"Compendium.pf2e.pathfinder-monster-core.Actor.bveW59P2mTiiFVIt","Compendium.pf2e.pathfinder-bestiary.Actor.jnmUcTs4hn1c5bz9":"Compendium.pf2e.pathfinder-monster-core.Actor.aeOzCBpwnUVcpqxI","Compendium.pf2e.pathfinder-bestiary.Actor.jP8CO6z7bNIhOuqQ":"Compendium.pf2e.pathfinder-monster-core.Actor.2jtRdYo9ey7osDUH","Compendium.pf2e.pathfinder-bestiary.Actor.jVZRROs0GzDjVrgi":"Compendium.pf2e.pathfinder-monster-core.Actor.fLLKuOXwPq1Iq0U4","Compendium.pf2e.pathfinder-bestiary.Actor.Jy2va0NTTbaUH1zP":"Compendium.pf2e.pathfinder-monster-core.Actor.ExVmw8bSvUd2wYkI","Compendium.pf2e.pathfinder-bestiary.Actor.k3Lt3bWBadXvlIbG":"Compendium.pf2e.pathfinder-monster-core.Actor.zpd6b6UPP72ZELCj","Compendium.pf2e.pathfinder-bestiary.Actor.K9Hw43co8fhwmKkM":"Compendium.pf2e.pathfinder-monster-core.Actor.VCYF0NAfPKwTHkK1","Compendium.pf2e.pathfinder-bestiary.Actor.KclNszYZ7sjwE9nX":"Compendium.pf2e.pathfinder-monster-core.Actor.JwOlSrHk1pkAKMRn","Compendium.pf2e.pathfinder-bestiary.Actor.kfeL172Ix3x1YRc9":"Compendium.pf2e.pathfinder-monster-core.Actor.Ro49rEZwBLkkoEKE","Compendium.pf2e.pathfinder-bestiary.Actor.kFQorgvvyozQVSKi":"Compendium.pf2e.pathfinder-monster-core.Actor.Q1wybC7rSc4MIF9g","Compendium.pf2e.pathfinder-bestiary.Actor.kkFVngQUGTACeggf":"Compendium.pf2e.pathfinder-monster-core.Actor.QCPpQya5TEUuIxQn","Compendium.pf2e.pathfinder-bestiary.Actor.KpxhSWRIhG7ns5NA":"Compendium.pf2e.pathfinder-monster-core.Actor.NcYbJS5PWBGdNDqh","Compendium.pf2e.pathfinder-bestiary.Actor.KsWAIXTTh3mfNWOY":"Compendium.pf2e.pathfinder-monster-core.Actor.AJ5LuNMVPLCydryP","Compendium.pf2e.pathfinder-bestiary.Actor.KxN9aGFGPxl6oLGF":"Compendium.pf2e.pathfinder-monster-core.Actor.aWiTcxAySoYjUP6T","Compendium.pf2e.pathfinder-bestiary.Actor.l17XDoK0UIjXUvOv":"Compendium.pf2e.pathfinder-monster-core.Actor.Z5QezXy38ZHyt3O3","Compendium.pf2e.pathfinder-bestiary.Actor.l3Pe8FsFbLvft1Fq":"Compendium.pf2e.pathfinder-monster-core.Actor.6KF6TQvLHHpE0uAM","Compendium.pf2e.pathfinder-bestiary.Actor.LDQpLwN40OGefZD0":"Compendium.pf2e.pathfinder-monster-core.Actor.tpNP1UooPPHMyZye","Compendium.pf2e.pathfinder-bestiary.Actor.lFlXmieuHTBIonhj":"Compendium.pf2e.pathfinder-monster-core.Actor.1uVwkGlqYzyWaDMy","Compendium.pf2e.pathfinder-bestiary.Actor.lo4fR4jDVzLdwwkH":"Compendium.pf2e.pathfinder-monster-core.Actor.V4rVnbjJbcOIdC4Z","Compendium.pf2e.pathfinder-bestiary.Actor.LVhVb7abhv4onzZZ":"Compendium.pf2e.pathfinder-monster-core.Actor.oaxKg1yQDmK2PWXG","Compendium.pf2e.pathfinder-bestiary.Actor.m3x8q5rZ6zh9x82s":"Compendium.pf2e.pathfinder-monster-core.Actor.BPznJcLvfkpfeQ2q","Compendium.pf2e.pathfinder-bestiary.Actor.M6RknN77XTo23v45":"Compendium.pf2e.pathfinder-monster-core.Actor.XKOQ3ll9TGNso0uB","Compendium.pf2e.pathfinder-bestiary.Actor.mblGfyIXWhiaNpFw":"Compendium.pf2e.pathfinder-monster-core.Actor.X2vz6CrMaHIso0ha","Compendium.pf2e.pathfinder-bestiary.Actor.mGr4e6fH3w8ewcSX":"Compendium.pf2e.pathfinder-monster-core.Actor.kKFfigxrJ2vbJazp","Compendium.pf2e.pathfinder-bestiary.Actor.mqz4MfBwFxlBQeHs":"Compendium.pf2e.pathfinder-monster-core.Actor.HKXa9E91WLy6dAZA","Compendium.pf2e.pathfinder-bestiary.Actor.myEeYWWAgnkLwtIb":"Compendium.pf2e.pathfinder-monster-core.Actor.zkl6planCbeCuAdS","Compendium.pf2e.pathfinder-bestiary.Actor.N62zM3aTelygWIt2":"Compendium.pf2e.pathfinder-monster-core.Actor.bb5Z4z4EHb5LbCLK","Compendium.pf2e.pathfinder-bestiary.Actor.NbGLrlt7RYdFFBQ5":"Compendium.pf2e.pathfinder-monster-core.Actor.yYicb7uJH4EaBO4v","Compendium.pf2e.pathfinder-bestiary.Actor.NeYU7wwCv0RUesZ1":"Compendium.pf2e.pathfinder-monster-core.Actor.ToteDLIM7jCyHwDH","Compendium.pf2e.pathfinder-bestiary.Actor.nFMZjWQL6pd9XdqR":"Compendium.pf2e.pathfinder-monster-core.Actor.9YPFqikAmURwcTEO","Compendium.pf2e.pathfinder-bestiary.Actor.nkWnoEHWUsBLgNje":"Compendium.pf2e.pathfinder-monster-core.Actor.bVn0EUj4xrOWjtna","Compendium.pf2e.pathfinder-bestiary.Actor.NpcS7iocNNsno6lE":"Compendium.pf2e.pathfinder-monster-core.Actor.llSpQyOTaylpqgnW","Compendium.pf2e.pathfinder-bestiary.Actor.NVWaLagWOu5tCCZu":"Compendium.pf2e.pathfinder-monster-core.Actor.VQPzDz3xnCQGFOGL","Compendium.pf2e.pathfinder-bestiary.Actor.NymSyXbXqfkGLFWF":"Compendium.pf2e.pathfinder-monster-core.Actor.0qaGLx8ads9blcfS","Compendium.pf2e.pathfinder-bestiary.Actor.o3DRwRKeJrl83Wv9":"Compendium.pf2e.pathfinder-monster-core.Actor.qOAuCiPgsjpjDgA1","Compendium.pf2e.pathfinder-bestiary.Actor.O3J59mUJ6DHQZZ6F":"Compendium.pf2e.pathfinder-monster-core.Actor.YiGZxwT2xTVYQyTu","Compendium.pf2e.pathfinder-bestiary.Actor.O5YbsTSlX5VhciP4":"Compendium.pf2e.pathfinder-monster-core.Actor.qlxVPpwVFw5qIVQM","Compendium.pf2e.pathfinder-bestiary.Actor.oBMIc2S8ekmDgPpi":"Compendium.pf2e.pathfinder-monster-core.Actor.0Dsy2I3mu86Czjm0","Compendium.pf2e.pathfinder-bestiary.Actor.Oc5NXZmMkSDCRNlQ":"Compendium.pf2e.pathfinder-monster-core.Actor.gWgMg7cARqOe82O6","Compendium.pf2e.pathfinder-bestiary.Actor.oGIWTW0WqQxYNJOD":"Compendium.pf2e.pathfinder-monster-core.Actor.5KstOkXabrOlZaKR","Compendium.pf2e.pathfinder-bestiary.Actor.Oilfs8Atv2LjAsUS":"Compendium.pf2e.pathfinder-monster-core.Actor.BN5Lb6IsQ9Wyu3rL","Compendium.pf2e.pathfinder-bestiary.Actor.oiXbo1VSfDrHpIQm":"Compendium.pf2e.pathfinder-monster-core.Actor.BoXCGLACP9vuIZkZ","Compendium.pf2e.pathfinder-bestiary.Actor.oJaC1WbXQuQX2d2J":"Compendium.pf2e.pathfinder-monster-core.Actor.X7PaA6XgvrY5ByfM","Compendium.pf2e.pathfinder-bestiary.Actor.oMcHaTX5unOHC2Pm":"Compendium.pf2e.pathfinder-monster-core.Actor.YRyTBciVtCnO7J0Z","Compendium.pf2e.pathfinder-bestiary.Actor.oMsOm06HhX1gG0Jz":"Compendium.pf2e.pathfinder-monster-core.Actor.SipdgBCL7XuuEjn6","Compendium.pf2e.pathfinder-bestiary.Actor.OPavstjKhgcp30fc":"Compendium.pf2e.pathfinder-monster-core.Actor.BMpBXSq8T20WdUDl","Compendium.pf2e.pathfinder-bestiary.Actor.oSvWsqFnQLS5wlvg":"Compendium.pf2e.pathfinder-monster-core.Actor.893mp411SdYren3H","Compendium.pf2e.pathfinder-bestiary.Actor.PCh2kxeSYWRit9TE":"Compendium.pf2e.pathfinder-monster-core.Actor.HMfH0CI1CQCXB9Xr","Compendium.pf2e.pathfinder-bestiary.Actor.PfcS6WzhMGzds5Wf":"Compendium.pf2e.pathfinder-monster-core.Actor.D2Pe38jYbeBxUaxU","Compendium.pf2e.pathfinder-bestiary.Actor.pG3UPgbAxNCXAyQE":"Compendium.pf2e.pathfinder-monster-core.Actor.F2Xhn4rqPAj55w3O","Compendium.pf2e.pathfinder-bestiary.Actor.PiAGhPEzJMC2egQk":"Compendium.pf2e.pathfinder-monster-core.Actor.yQ2mosomuAPiLMkU","Compendium.pf2e.pathfinder-bestiary.Actor.PiZkpRK23u89h82S":"Compendium.pf2e.pathfinder-monster-core.Actor.NW68bxCLC6oDHxL9","Compendium.pf2e.pathfinder-bestiary.Actor.pkNWilK2pHZ5TDsd":"Compendium.pf2e.pathfinder-monster-core.Actor.WoICHri7raCYv1wU","Compendium.pf2e.pathfinder-bestiary.Actor.pMoAlNjMJ7DArLPh":"Compendium.pf2e.pathfinder-monster-core.Actor.yv7hdQ3MO3pLgCF5","Compendium.pf2e.pathfinder-bestiary.Actor.pTkz08ak9YlKRsOY":"Compendium.pf2e.pathfinder-monster-core.Actor.qYw2ToefDK5Vrwgu","Compendium.pf2e.pathfinder-bestiary.Actor.pyFvLyQsyYjOz0xI":"Compendium.pf2e.pathfinder-monster-core.Actor.2SixuEUfKpEyfOEY","Compendium.pf2e.pathfinder-bestiary.Actor.q3LrTrfnCvoUXuRz":"Compendium.pf2e.pathfinder-monster-core.Actor.ccAeM0tNgf5aVokj","Compendium.pf2e.pathfinder-bestiary.Actor.Q8FAcsuta4p6d8KS":"Compendium.pf2e.pathfinder-monster-core.Actor.MX2cLbODuo4gECPJ","Compendium.pf2e.pathfinder-bestiary.Actor.Qa7HaKfKiosEPr94":"Compendium.pf2e.pathfinder-monster-core.Actor.rdgs2gxTWxkyanD6","Compendium.pf2e.pathfinder-bestiary.Actor.qcZvFCAnslI9XNTR":"Compendium.pf2e.pathfinder-monster-core.Actor.h7je8nkscJQ2Ac8j","Compendium.pf2e.pathfinder-bestiary.Actor.qfuoFK2GXBJusQ33":"Compendium.pf2e.pathfinder-monster-core.Actor.KDbJ402jFuvn5frX","Compendium.pf2e.pathfinder-bestiary.Actor.QGTSPki2eoLuavif":"Compendium.pf2e.pathfinder-monster-core.Actor.3nUt7cW8fqE5IpyE","Compendium.pf2e.pathfinder-bestiary.Actor.qHqhUWeNUZRET9xV":"Compendium.pf2e.pathfinder-monster-core.Actor.AFWmiIBJ7ypgydQD","Compendium.pf2e.pathfinder-bestiary.Actor.qpRJOzx3bJ7rolHp":"Compendium.pf2e.pathfinder-monster-core.Actor.ZeUxgpNi5AXr9pX6","Compendium.pf2e.pathfinder-bestiary.Actor.QQQhNnCit9XLMMoN":"Compendium.pf2e.pathfinder-monster-core.Actor.WG4Tk2k9Lm21CEQv","Compendium.pf2e.pathfinder-bestiary.Actor.qr46S4VDnaUK0GcM":"Compendium.pf2e.pathfinder-monster-core.Actor.fRjJkktWp7s8NBN7","Compendium.pf2e.pathfinder-bestiary.Actor.QRjjE4TJNfaDhhQC":"Compendium.pf2e.pathfinder-monster-core.Actor.FFnsYr2aIfDGnUVS","Compendium.pf2e.pathfinder-bestiary.Actor.QRRX82FIjBKd8pzs":"Compendium.pf2e.pathfinder-monster-core.Actor.KHTYbQgR5hnFZdGL","Compendium.pf2e.pathfinder-bestiary.Actor.QT2gA8WMaT2cuXr7":"Compendium.pf2e.pathfinder-monster-core.Actor.BlTEvlCUKPOfBYMR","Compendium.pf2e.pathfinder-bestiary.Actor.quXuocHuT2US7cWz":"Compendium.pf2e.pathfinder-monster-core.Actor.v4KP0HYaygoFOIlo","Compendium.pf2e.pathfinder-bestiary.Actor.r9w1n85mp9Ip4QiS":"Compendium.pf2e.pathfinder-monster-core.Actor.BIZfjoz8DZt75EDn","Compendium.pf2e.pathfinder-bestiary.Actor.r9WAwtCLxoJMjd8J":"Compendium.pf2e.pathfinder-monster-core.Actor.WNUvjcKRAqdguWfN","Compendium.pf2e.pathfinder-bestiary.Actor.RiKjpztTt7tZbOeo":"Compendium.pf2e.pathfinder-monster-core.Actor.Bkr0soTDhQq1qjWx","Compendium.pf2e.pathfinder-bestiary.Actor.RMSx2C27yty0MTva":"Compendium.pf2e.pathfinder-monster-core.Actor.FH58AcRBZIfrHKvv","Compendium.pf2e.pathfinder-bestiary.Actor.rPaHIh0ICnTLnRO6":"Compendium.pf2e.pathfinder-monster-core.Actor.PcHQDmPTztw32PhL","Compendium.pf2e.pathfinder-bestiary.Actor.rPHxXClTnoPYHYuZ":"Compendium.pf2e.pathfinder-monster-core.Actor.mX47c0W9rizbmMBM","Compendium.pf2e.pathfinder-bestiary.Actor.RTUp97xNDutzYpuY":"Compendium.pf2e.pathfinder-monster-core.Actor.bVn0EUj4xrOWjtna","Compendium.pf2e.pathfinder-bestiary.Actor.RTzFvmdSCf5yhguy":"Compendium.pf2e.pathfinder-monster-core.Actor.5vBG8a8dnJfmVd3Y","Compendium.pf2e.pathfinder-bestiary.Actor.RXEnAk6cbSnk3w7O":"Compendium.pf2e.pathfinder-monster-core.Actor.Cqi8jadYpUTajIC6","Compendium.pf2e.pathfinder-bestiary.Actor.S5z0mtoEhbz7BvE9":"Compendium.pf2e.pathfinder-monster-core.Actor.ZW8ARUrNdc3zewLM","Compendium.pf2e.pathfinder-bestiary.Actor.saKs2Qaor8QktboH":"Compendium.pf2e.pathfinder-monster-core.Actor.PvYl5kItb7xoE8Is","Compendium.pf2e.pathfinder-bestiary.Actor.ScNPruIwcIJNuSHb":"Compendium.pf2e.pathfinder-monster-core.Actor.bVn0EUj4xrOWjtna","Compendium.pf2e.pathfinder-bestiary.Actor.ScOT6QOlXIsevhNq":"Compendium.pf2e.pathfinder-monster-core.Actor.xC6v5Ef8mDt05QFK","Compendium.pf2e.pathfinder-bestiary.Actor.sf42HB8VsWGlYixP":"Compendium.pf2e.pathfinder-monster-core.Actor.Yadztw8CmYuWfA7k","Compendium.pf2e.pathfinder-bestiary.Actor.Sft7n3LMmnTxhhYn":"Compendium.pf2e.pathfinder-monster-core.Actor.x7Aa4Tvr9eBaHryF","Compendium.pf2e.pathfinder-bestiary.Actor.SP72xojHR0UGAWcs":"Compendium.pf2e.pathfinder-monster-core.Actor.6EgJNAJss45TQqpa","Compendium.pf2e.pathfinder-bestiary.Actor.sPClc6y3dT3XZupv":"Compendium.pf2e.pathfinder-monster-core.Actor.6wPW2dvpt86Ou6bL","Compendium.pf2e.pathfinder-bestiary.Actor.SuWpn5yZdsHDHpL2":"Compendium.pf2e.pathfinder-monster-core.Actor.oyfheSs1ta4xvtEg","Compendium.pf2e.pathfinder-bestiary.Actor.t4JYGYJqT1CaqKvh":"Compendium.pf2e.pathfinder-monster-core.Actor.ePJcp2ADOjJYYQ5Q","Compendium.pf2e.pathfinder-bestiary.Actor.T5CUuPsMPb17d6Qy":"Compendium.pf2e.pathfinder-monster-core.Actor.eP4a0FAbus3tNTbc","Compendium.pf2e.pathfinder-bestiary.Actor.tKaOsbg8cmIUSjSE":"Compendium.pf2e.pathfinder-monster-core.Actor.XEjkJ8fQqLc02hrU","Compendium.pf2e.pathfinder-bestiary.Actor.tm3Tixb7IDoLdJ5k":"Compendium.pf2e.pathfinder-monster-core.Actor.BCPpwj9uCiS7bF9C","Compendium.pf2e.pathfinder-bestiary.Actor.ToSwRvspZ0IB7SHQ":"Compendium.pf2e.pathfinder-monster-core.Actor.LN7MXD38Zs2bDoW6","Compendium.pf2e.pathfinder-bestiary.Actor.tr75FAbdOkrfQviy":"Compendium.pf2e.pathfinder-monster-core.Actor.gCmfPEfqS60BiuVP","Compendium.pf2e.pathfinder-bestiary.Actor.triuze3NMe4kWpdS":"Compendium.pf2e.pathfinder-monster-core.Actor.eke1AhiUjNPpyRhG","Compendium.pf2e.pathfinder-bestiary.Actor.tTmml7T2Knz2NrLd":"Compendium.pf2e.pathfinder-monster-core.Actor.JRBUBgJymEeEE4hm","Compendium.pf2e.pathfinder-bestiary.Actor.tXHUr947sanB5tdN":"Compendium.pf2e.pathfinder-monster-core.Actor.2k0JX3RFTVRf0KS2","Compendium.pf2e.pathfinder-bestiary.Actor.U1L3MFKHe0sNvLoU":"Compendium.pf2e.pathfinder-monster-core.Actor.jR4E2I2tmQ6sd5DR","Compendium.pf2e.pathfinder-bestiary.Actor.uCw15c4AnIrOy5AV":"Compendium.pf2e.pathfinder-monster-core.Actor.IxezJU9rIKKyd3LY","Compendium.pf2e.pathfinder-bestiary.Actor.UPm2rwIevsX9Odbm":"Compendium.pf2e.pathfinder-monster-core.Actor.702acAJ1OPRBjcni","Compendium.pf2e.pathfinder-bestiary.Actor.URREWYZtc8QJ9ld6":"Compendium.pf2e.pathfinder-monster-core.Actor.Rr1u6WvZEdPw1s6v","Compendium.pf2e.pathfinder-bestiary.Actor.UYHtIbN0JVaIYcgs":"Compendium.pf2e.pathfinder-monster-core.Actor.f9fjSDdcBKkEPoIi","Compendium.pf2e.pathfinder-bestiary.Actor.v92cB3RBUMhysOpD":"Compendium.pf2e.pathfinder-monster-core.Actor.diU0V2M3LiMDMsS0","Compendium.pf2e.pathfinder-bestiary.Actor.VAWmwDA08ZLQd8lW":"Compendium.pf2e.pathfinder-monster-core.Actor.2mg30nJR6P3HJDSd","Compendium.pf2e.pathfinder-bestiary.Actor.VcUdFYNaxauNr5Hn":"Compendium.pf2e.pathfinder-monster-core.Actor.1Qqu3b4J4aJYEQOX","Compendium.pf2e.pathfinder-bestiary.Actor.vEFENJJixCdmBNl5":"Compendium.pf2e.pathfinder-monster-core.Actor.aYDbWuOj66nve8r4","Compendium.pf2e.pathfinder-bestiary.Actor.vJwnApm0HkadGR7w":"Compendium.pf2e.pathfinder-monster-core.Actor.2rMLYkUR47ZCQMUg","Compendium.pf2e.pathfinder-bestiary.Actor.vmN9SCUJxN1MIXwp":"Compendium.pf2e.pathfinder-monster-core.Actor.R427CMT90S7fv7MY","Compendium.pf2e.pathfinder-bestiary.Actor.VoLW6eUxMSsXvgVP":"Compendium.pf2e.pathfinder-monster-core.Actor.3t1z62LREP4nnIDr","Compendium.pf2e.pathfinder-bestiary.Actor.vUKCuAgLQdz5akgp":"Compendium.pf2e.pathfinder-monster-core.Actor.9rXYGu7D3umIW1sv","Compendium.pf2e.pathfinder-bestiary.Actor.vxKqnzwcxNAgLp7C":"Compendium.pf2e.pathfinder-monster-core.Actor.k5p4mRDT26DrDXPA","Compendium.pf2e.pathfinder-bestiary.Actor.w20FfmKH7ukghczT":"Compendium.pf2e.pathfinder-monster-core.Actor.pkhNqTDUttoAzcKn","Compendium.pf2e.pathfinder-bestiary.Actor.WAgQt9pkzgPOlcJI":"Compendium.pf2e.pathfinder-monster-core.Actor.zAxKR8XWtQm2rqh4","Compendium.pf2e.pathfinder-bestiary.Actor.waPgKbjhijeZ00Zm":"Compendium.pf2e.pathfinder-monster-core.Actor.qRUqoezeEnQ2KdyT","Compendium.pf2e.pathfinder-bestiary.Actor.wifELOkkRO2634bc":"Compendium.pf2e.pathfinder-monster-core.Actor.s2TkernjfKVEhlJY","Compendium.pf2e.pathfinder-bestiary.Actor.WiOY3YbiKEJKIQQz":"Compendium.pf2e.pathfinder-monster-core.Actor.zT3fSxNatEbrkCzN","Compendium.pf2e.pathfinder-bestiary.Actor.wjw8FQp4icafYash":"Compendium.pf2e.pathfinder-monster-core.Actor.XgGeD4fz5m7nQQlN","Compendium.pf2e.pathfinder-bestiary.Actor.wKVZdVVcXtvLxgsY":"Compendium.pf2e.pathfinder-monster-core.Actor.I00S3LWnDJfCn4zv","Compendium.pf2e.pathfinder-bestiary.Actor.wMomrpcaC8QvIdlj":"Compendium.pf2e.pathfinder-monster-core.Actor.V1Kr5aiPaTM0mDFu","Compendium.pf2e.pathfinder-bestiary.Actor.WNiNj0Brn2LCYmwd":"Compendium.pf2e.pathfinder-monster-core.Actor.uNNOQFvuMq8ZsQkn","Compendium.pf2e.pathfinder-bestiary.Actor.WNqPRMjKW0oCHZ8X":"Compendium.pf2e.pathfinder-monster-core.Actor.f15mNNhOT3aq66VQ","Compendium.pf2e.pathfinder-bestiary.Actor.wpmvdP5w936Kmq0e":"Compendium.pf2e.pathfinder-monster-core.Actor.Ehtm5k9iBYTvSUcZ","Compendium.pf2e.pathfinder-bestiary.Actor.wqPYzMNgYvrO6oEP":"Compendium.pf2e.pathfinder-monster-core.Actor.kB7FNn3vosp6cqQg","Compendium.pf2e.pathfinder-bestiary.Actor.wRQ7TZdd0n5UIIao":"Compendium.pf2e.pathfinder-monster-core.Actor.KgJq51AeYrENo3Db","Compendium.pf2e.pathfinder-bestiary.Actor.wuaSG22lLjQ6yali":"Compendium.pf2e.pathfinder-monster-core.Actor.5iqkL9Me5164H7NY","Compendium.pf2e.pathfinder-bestiary.Actor.x6wfK4UCJ6wYok9t":"Compendium.pf2e.pathfinder-monster-core.Actor.0H54u83vZ1w3xHcD","Compendium.pf2e.pathfinder-bestiary.Actor.x81PGKEsOtPquFVa":"Compendium.pf2e.pathfinder-monster-core.Actor.bVn0EUj4xrOWjtna","Compendium.pf2e.pathfinder-bestiary.Actor.x8ZWNcFOfpJYjXOw":"Compendium.pf2e.pathfinder-monster-core.Actor.k4fqHhiax2GPrkbh","Compendium.pf2e.pathfinder-bestiary.Actor.XbClt5wkqECrQToJ":"Compendium.pf2e.pathfinder-monster-core.Actor.C1gYuDSwTkTIkAcC","Compendium.pf2e.pathfinder-bestiary.Actor.XLqbEDjmGpIc4XoY":"Compendium.pf2e.pathfinder-monster-core.Actor.PLZk6zY5iwccPTPS","Compendium.pf2e.pathfinder-bestiary.Actor.XoXf5ExS95Vv6lNf":"Compendium.pf2e.pathfinder-monster-core.Actor.Oq31fcKwH0EE9R89","Compendium.pf2e.pathfinder-bestiary.Actor.XrmHgbKgcHDi4OnK":"Compendium.pf2e.pathfinder-monster-core.Actor.VotlWUsFKdOrHWF6","Compendium.pf2e.pathfinder-bestiary.Actor.XUTUBrQixSs7VLov":"Compendium.pf2e.pathfinder-monster-core.Actor.iNwaxIYuD0OTDNjJ","Compendium.pf2e.pathfinder-bestiary.Actor.XVX9Uhqb8shG5Pwm":"Compendium.pf2e.pathfinder-monster-core.Actor.PlkRv9NMKq9TShYf","Compendium.pf2e.pathfinder-bestiary.Actor.xYlOudjXyTakF1m8":"Compendium.pf2e.pathfinder-monster-core.Actor.4Ejgj6p1LAu1RAN3","Compendium.pf2e.pathfinder-bestiary.Actor.Y3T7XfC2BeiNBmuS":"Compendium.pf2e.pathfinder-monster-core.Actor.irl1wnfk4b83JWkY","Compendium.pf2e.pathfinder-bestiary.Actor.YdlmpfZso6GwPr2D":"Compendium.pf2e.pathfinder-monster-core.Actor.bVn0EUj4xrOWjtna","Compendium.pf2e.pathfinder-bestiary.Actor.yIXRooXdsKtbcw2D":"Compendium.pf2e.pathfinder-monster-core.Actor.jkp7THTZMc0ivN8Y","Compendium.pf2e.pathfinder-bestiary.Actor.ypLkUfuHHfNDsVUQ":"Compendium.pf2e.pathfinder-monster-core.Actor.JGwKk83oX4gTGlqe","Compendium.pf2e.pathfinder-bestiary.Actor.YUk9S6caKqheRsUQ":"Compendium.pf2e.pathfinder-monster-core.Actor.F3ungAqpGjFotwUK","Compendium.pf2e.pathfinder-bestiary.Actor.yxCmLBpw6xqWFU3E":"Compendium.pf2e.pathfinder-monster-core.Actor.TZt3H39oxVdZRKs9","Compendium.pf2e.pathfinder-bestiary.Actor.yzyaD2yGDrxmYh7P":"Compendium.pf2e.pathfinder-monster-core.Actor.gGdIV6uUHzX23vz6","Compendium.pf2e.pathfinder-bestiary.Actor.z0l0lHc79NbMxiqZ":"Compendium.pf2e.pathfinder-monster-core.Actor.Ky5eNRvN71O0tY9l","Compendium.pf2e.pathfinder-bestiary.Actor.zA1I5YXI9GCSaksP":"Compendium.pf2e.pathfinder-monster-core.Actor.H8lGFF3PKUv2yRL2","Compendium.pf2e.pathfinder-bestiary.Actor.zBPGUUP788b0g1Ng":"Compendium.pf2e.pathfinder-monster-core.Actor.z1TEwL0plpK4l2uf","Compendium.pf2e.pathfinder-bestiary.Actor.zJro50sLFmOcDLdO":"Compendium.pf2e.pathfinder-monster-core.Actor.kohQQtOfhwxbzWZB","Compendium.pf2e.pathfinder-bestiary.Actor.zJZqpx6pPW7dxEUV":"Compendium.pf2e.pathfinder-monster-core.Actor.BWm17BRQYGMLqtNe","Compendium.pf2e.pathfinder-bestiary.Actor.Zn0p5YjELMjEwkqx":"Compendium.pf2e.pathfinder-monster-core.Actor.6mdq7UV9gFXAEOpJ","Compendium.pf2e.pathfinder-bestiary.Actor.ZPAM4OavHmdgmGnw":"Compendium.pf2e.pathfinder-monster-core.Actor.sldauWtSyK4JEiRl","Compendium.pf2e.pathfinder-bestiary.Actor.ZPjQkKVMi3xoPcU0":"Compendium.pf2e.pathfinder-monster-core.Actor.DBTbqI9QQRtlJwWh","Compendium.pf2e.pathfinder-bestiary.Actor.zRNHsSxi1g3IFYFu":"Compendium.pf2e.pathfinder-monster-core.Actor.pVbggIyXxCo8pPue","Compendium.pf2e.pathfinder-bestiary.Actor.ZsduIlmluQe4ZxFy":"Compendium.pf2e.pathfinder-monster-core.Actor.uUP9MQscB0EFPptr","Compendium.pf2e.pathfinder-bestiary.Actor.zUvgAbgeQH5t6DWs":"Compendium.pf2e.pathfinder-monster-core.Actor.9SNpsnwlzZjH4DQf","Compendium.pf2e.pathfinder-bestiary.Actor.Zv6eaumsdz4HdxRV":"Compendium.pf2e.pathfinder-monster-core.Actor.tUWchW8dXavTFeBy","Compendium.pf2e.pathfinder-bestiary.Actor.ZzMJ7Y4qxapAVvlF":"Compendium.pf2e.pathfinder-monster-core.Actor.9qERA2jk7Yv74Hqq","Compendium.pf2e.pfs-season-1-bestiary.Actor.bfTmy4404MFMykxH":"Compendium.pf2e.pathfinder-monster-core.Actor.4MoqBCDQA6FR1sPw","Compendium.pf2e.pfs-season-1-bestiary.Actor.pJck5AXRMWcAequ5":"Compendium.pf2e.pathfinder-monster-core.Actor.EH84J9FedbK3ax50","Compendium.pf2e.pfs-season-4-bestiary.Actor.oH2KT9LhUs299AN9":"Compendium.pf2e.pathfinder-monster-core.Actor.BxOlYmZiwLRpxGWp","Compendium.pf2e.spell-effects.Item.0JPnBD7yzrmrbZ0m":"Compendium.pf2e.spell-effects.Item.83md7JyfA5WnWaOZ","Compendium.pf2e.spell-effects.Item.0o984LjzIFXxeXIF":"Compendium.pf2e.spell-effects.Item.1XlF12UbvJsTZxfp","Compendium.pf2e.spell-effects.Item.0q2716S34XL1y9Hh":"Compendium.pf2e.spell-effects.Item.fGK6zJ7mWz9D5QYo","Compendium.pf2e.spell-effects.Item.0R42NyuEZMVALjQs":"Compendium.pf2e.spell-effects.Item.Ig9p2rDXGYHpEuTx","Compendium.pf2e.spell-effects.Item.14AFzcwkN019dzcl":"Compendium.pf2e.spell-effects.Item.iN6shVYuzvQ4A95i","Compendium.pf2e.spell-effects.Item.1gTnFmfLUQnCo3TK":"Compendium.pf2e.spell-effects.Item.FT5Tt2DKBRutDqbV","Compendium.pf2e.spell-effects.Item.1t64Sf8wYsoo7iFt":"Compendium.pf2e.spell-effects.Item.83md7JyfA5WnWaOZ","Compendium.pf2e.spell-effects.Item.1VuHjj32wge2gPOr":"Compendium.pf2e.spell-effects.Item.Dcva6SCHr9vWE7nJ","Compendium.pf2e.spell-effects.Item.2Ss5VblfZNHg1HjN":"Compendium.pf2e.spell-effects.Item.tfdDpf9xSWgQer5g","Compendium.pf2e.spell-effects.Item.2wfrhRLmmgPSKbAZ":"Compendium.pf2e.spell-effects.Item.Dcva6SCHr9vWE7nJ","Compendium.pf2e.spell-effects.Item.3zdBGENpmaze1bpq":"Compendium.pf2e.spell-effects.Item.ciQhlQbQcarzRYzf","Compendium.pf2e.spell-effects.Item.4Lt69zSeYElEfDrZ":"Compendium.pf2e.spell-effects.Item.FT5Tt2DKBRutDqbV","Compendium.pf2e.spell-effects.Item.4VOZP2ArmS12nvz8":"Compendium.pf2e.spell-effects.Item.0WYy3bY7HJ7TDSYD","Compendium.pf2e.spell-effects.Item.5R3ewWLFkgqTvZsc":"Compendium.pf2e.spell-effects.Item.AF4vQ1xoOiJ1ewH1","Compendium.pf2e.spell-effects.Item.6embuvXCpS3YOD5u":"Compendium.pf2e.feat-effects.Item.MiucWR2AbIhr34qD","Compendium.pf2e.spell-effects.Item.6Ev2ytJZfr2t33iy":"Compendium.pf2e.spell-effects.Item.1XlF12UbvJsTZxfp","Compendium.pf2e.spell-effects.Item.6qvLnIkWAoGvTIWy":"Compendium.pf2e.spell-effects.Item.dU4viL9kh554TKeB","Compendium.pf2e.spell-effects.Item.6SG8wVmppv4oXZtx":"Compendium.pf2e.spell-effects.Item.34yP4e2e6jpY1Bsi","Compendium.pf2e.spell-effects.Item.7tfF8ifVvOKNud8t":"Compendium.pf2e.spell-effects.Item.ciQhlQbQcarzRYzf","Compendium.pf2e.spell-effects.Item.8aNZhlkzRTRKlKag":"Compendium.pf2e.spell-effects.Item.1pC1qjvCuAKzjYo8","Compendium.pf2e.spell-effects.Item.8eWLR0WCf5258z8X":"Compendium.pf2e.spell-effects.Item.Qp0dlhJaCzXIx73r","Compendium.pf2e.spell-effects.Item.A48jNUOAmCljx8Ru":"Compendium.pf2e.spell-effects.Item.iN6shVYuzvQ4A95i","Compendium.pf2e.spell-effects.Item.afJCG4vC5WF5h5IB":"Compendium.pf2e.spell-effects.Item.CWC2fPmlgixoIKy5","Compendium.pf2e.spell-effects.Item.alyNtkHLNnt98Ewz":"Compendium.pf2e.feat-effects.Item.BJldFHlx4kwMY3rX","Compendium.pf2e.spell-effects.Item.AM49w68oKykc2fHI":"Compendium.pf2e.spell-effects.Item.fGK6zJ7mWz9D5QYo","Compendium.pf2e.spell-effects.Item.AnCRD7kDcG0DDGKn":"Compendium.pf2e.spell-effects.Item.6gRRjn0h0DAUh7nQ","Compendium.pf2e.spell-effects.Item.b5OyBdc0bolgWZZT":"Compendium.pf2e.spell-effects.Item.mKw9WvqnhaUsPvvy","Compendium.pf2e.spell-effects.Item.b8bfWIICHOsGVzjp":"Compendium.pf2e.spell-effects.Item.oMtbVNQ5YFmmQUlU","Compendium.pf2e.spell-effects.Item.blBXnWb1Y8q8YYMh":"Compendium.pf2e.spell-effects.Item.PQuQtDixruZmmvT4","Compendium.pf2e.spell-effects.Item.BsGZdgiEElNlgZVv":"Compendium.pf2e.spell-effects.Item.0WYy3bY7HJ7TDSYD","Compendium.pf2e.spell-effects.Item.byXkHIKFwuKrZ55M":"Compendium.pf2e.spell-effects.Item.iN6shVYuzvQ4A95i","Compendium.pf2e.spell-effects.Item.BIIYUbCsJxb0P8gm":"Compendium.pf2e.spell-effects.Item.Ptnncwp118gIvmvG","Compendium.pf2e.spell-effects.Item.C3RdbEQTvawqKAhw":"Compendium.pf2e.spell-effects.Item.mKw9WvqnhaUsPvvy","Compendium.pf2e.spell-effects.Item.c4cIfS2974nUJDPt":"Compendium.pf2e.spell-effects.Item.jeH78c7kyk376PKS","Compendium.pf2e.spell-effects.Item.cTBYHfiXDOA09G4b":"Compendium.pf2e.spell-effects.Item.Ig9p2rDXGYHpEuTx","Compendium.pf2e.spell-effects.Item.czteoX2cggQzfkK9":"Compendium.pf2e.spell-effects.Item.1XlF12UbvJsTZxfp","Compendium.pf2e.spell-effects.Item.D0Qj5tC1hGUjzQc4":"Compendium.pf2e.spell-effects.Item.uPmHi7ZiCj7PWM9N","Compendium.pf2e.spell-effects.Item.dCQCzapIk53xmDo5":"Compendium.pf2e.spell-effects.Item.Dcva6SCHr9vWE7nJ","Compendium.pf2e.spell-effects.Item.dEsaufFnfYihu5Ex":"Compendium.pf2e.spell-effects.Item.pzbU0cdyRvE66XBi","Compendium.pf2e.spell-effects.Item.DliizYpHcmBG130w":"Compendium.pf2e.spell-effects.Item.Qp0dlhJaCzXIx73r","Compendium.pf2e.spell-effects.Item.DrNpuMj14wVj4bWF":"Compendium.pf2e.spell-effects.Item.1pC1qjvCuAKzjYo8","Compendium.pf2e.spell-effects.Item.DwM5qcFp4JgKhXrY":"Compendium.pf2e.spell-effects.Item.jeH78c7kyk376PKS","Compendium.pf2e.spell-effects.Item.dy4neJZ1g1XQnUZL":"Compendium.pf2e.spell-effects.Item.IKdTcUwGtnkvrCed","Compendium.pf2e.spell-effects.Item.Eik8Fj8nGo2GLcbn":"Compendium.pf2e.spell-effects.Item.oMtbVNQ5YFmmQUlU","Compendium.pf2e.spell-effects.Item.EKdqKCuyWSkpXpyJ":"Compendium.pf2e.spell-effects.Item.ciQhlQbQcarzRYzf","Compendium.pf2e.spell-effects.Item.ETgzIIv3M2zvclAR":"Compendium.pf2e.spell-effects.Item.1pC1qjvCuAKzjYo8","Compendium.pf2e.spell-effects.Item.EUxTav62IXTz5CxW":"Compendium.pf2e.spell-effects.Item.hfcFc8cV5wF2evWP","Compendium.pf2e.spell-effects.Item.F10ofwC0k1ELIaV4":"Compendium.pf2e.spell-effects.Item.slI9P4jUp3ERPCqX","Compendium.pf2e.spell-effects.Item.fKeZDm8kpDFK5HWp":"Compendium.pf2e.spell-effects.Item.83md7JyfA5WnWaOZ","Compendium.pf2e.spell-effects.Item.fLOQMycP5tmXgPv9":"Compendium.pf2e.spell-effects.Item.AF4vQ1xoOiJ1ewH1","Compendium.pf2e.spell-effects.Item.FR4ucNi2ceHZdrpB":"Compendium.pf2e.spell-effects.Item.7zJPd2BsFl82qFRV","Compendium.pf2e.spell-effects.Item.fwaAe71qfnK7SiOB":"Compendium.pf2e.spell-effects.Item.PQuQtDixruZmmvT4","Compendium.pf2e.spell-effects.Item.g4E9l4uA62LcRBJS":"Compendium.pf2e.spell-effects.Item.CWC2fPmlgixoIKy5","Compendium.pf2e.spell-effects.Item.GhGoZdAZtzZTYCzj":"Compendium.pf2e.spell-effects.Item.Dcva6SCHr9vWE7nJ","Compendium.pf2e.spell-effects.Item.gKGErrsS1WoAyWub":"Compendium.pf2e.spell-effects.Item.OH3sdHE6xWwOjq9v","Compendium.pf2e.spell-effects.Item.HDKJAUXMbtxnBdgR":"Compendium.pf2e.spell-effects.Item.mKw9WvqnhaUsPvvy","Compendium.pf2e.spell-effects.Item.hdOb5Iu6Zd3pHoGI":"Compendium.pf2e.spell-effects.Item.pzbU0cdyRvE66XBi","Compendium.pf2e.spell-effects.Item.heAj9paC8ZRh7QEj":"Compendium.pf2e.spell-effects.Item.jeH78c7kyk376PKS","Compendium.pf2e.spell-effects.Item.ib58LaffEUIypuzL":"Compendium.pf2e.spell-effects.Item.1XlF12UbvJsTZxfp","Compendium.pf2e.spell-effects.Item.iiV80Kexj6vPmzqU":"Compendium.pf2e.spell-effects.Item.fGK6zJ7mWz9D5QYo","Compendium.pf2e.spell-effects.Item.iqtjMVl6rGQhX2k8":"Compendium.pf2e.spell-effects.Item.uPmHi7ZiCj7PWM9N","Compendium.pf2e.spell-effects.Item.itmiGioGNuVvt4QE":"Compendium.pf2e.spell-effects.Item.fGK6zJ7mWz9D5QYo","Compendium.pf2e.spell-effects.Item.IVAPEtALVgSNOBdk":"Compendium.pf2e.spell-effects.Item.Ptnncwp118gIvmvG","Compendium.pf2e.spell-effects.Item.j6po934p4jcUVC6l":"Compendium.pf2e.spell-effects.Item.iN6shVYuzvQ4A95i","Compendium.pf2e.spell-effects.Item.JhihziXQuoteftdd":"Compendium.pf2e.spell-effects.Item.lyLMiauxIVUM3oF1","Compendium.pf2e.spell-effects.Item.jtW3VfI5Kktuy3GH":"Compendium.pf2e.spell-effects.Item.1pC1qjvCuAKzjYo8","Compendium.pf2e.spell-effects.Item.jtMo6qS47hPx6EbR":"Compendium.pf2e.spell-effects.Item.fGK6zJ7mWz9D5QYo","Compendium.pf2e.spell-effects.Item.jUUFipVlyAYEBFNI":"Compendium.pf2e.spell-effects.Item.Ptnncwp118gIvmvG","Compendium.pf2e.spell-effects.Item.KcBqo33ekJHxZLHo":"Compendium.pf2e.spell-effects.Item.jeH78c7kyk376PKS","Compendium.pf2e.spell-effects.Item.kxMBdANwCcF841uA":"Compendium.pf2e.spell-effects.Item.Qp0dlhJaCzXIx73r","Compendium.pf2e.spell-effects.Item.LgqKCxm8A09WCLxm":"Compendium.pf2e.spell-effects.Item.83md7JyfA5WnWaOZ","Compendium.pf2e.spell-effects.Item.lywUJljQy2SxRZQt":"Compendium.pf2e.spell-effects.Item.hfcFc8cV5wF2evWP","Compendium.pf2e.spell-effects.Item.LzsCQ1mRnPYDzNpo":"Compendium.pf2e.spell-effects.Item.Ptnncwp118gIvmvG","Compendium.pf2e.spell-effects.Item.m1tQTBrolf7uZBW0":"Compendium.pf2e.spell-effects.Item.pzbU0cdyRvE66XBi","Compendium.pf2e.spell-effects.Item.MJSoRFfEdM4j5mNG":"Compendium.pf2e.spell-effects.Item.yEQXaB7XyaROVqyb","Compendium.pf2e.spell-effects.Item.MjtPtndJx31q2N9R":"Compendium.pf2e.feat-effects.Item.94Vuzui165y0rgP5","Compendium.pf2e.spell-effects.Item.mr6mlkUMeStdChxi":"Compendium.pf2e.spell-effects.Item.Dcva6SCHr9vWE7nJ","Compendium.pf2e.spell-effects.Item.N1EM3jRyT8PCG1Py":"Compendium.pf2e.spell-effects.Item.Ig9p2rDXGYHpEuTx","Compendium.pf2e.spell-effects.Item.n6NK7wqhTxWr3ij8":"Compendium.pf2e.spell-effects.Item.7zJPd2BsFl82qFRV","Compendium.pf2e.spell-effects.Item.nbW4udOUTrCGL3Gf":"Compendium.pf2e.spell-effects.Item.iN6shVYuzvQ4A95i","Compendium.pf2e.spell-effects.Item.nWEx5kpkE8YlBZvy":"Compendium.pf2e.spell-effects.Item.1pC1qjvCuAKzjYo8","Compendium.pf2e.spell-effects.Item.oaRt210JV4GZIHmJ":"Compendium.pf2e.feat-effects.Item.0jKdU1YdER9dLBdx","Compendium.pf2e.spell-effects.Item.OeCn76SB92GPOZwr":"Compendium.pf2e.spell-effects.Item.1pC1qjvCuAKzjYo8","Compendium.pf2e.spell-effects.Item.otK6eG3b3FV7n2xP":"Compendium.pf2e.spell-effects.Item.fcalovjrB3bzpiDH","Compendium.pf2e.spell-effects.Item.PhBrHvBwvq8rni9C":"Compendium.pf2e.spell-effects.Item.1XlF12UbvJsTZxfp","Compendium.pf2e.spell-effects.Item.phIoucsDa3iplMm2":"Compendium.pf2e.spell-effects.Item.Qp0dlhJaCzXIx73r","Compendium.pf2e.spell-effects.Item.PkofF4bxkDUgeIoE":"Compendium.pf2e.spell-effects.Item.GhNVAYtoF5hK3AlD","Compendium.pf2e.spell-effects.Item.pocsoEi84Mr2buOc":"Compendium.pf2e.spell-effects.Item.1XlF12UbvJsTZxfp","Compendium.pf2e.spell-effects.Item.PpkOZVoHkBZUmddx":"Compendium.pf2e.spell-effects.Item.ciQhlQbQcarzRYzf","Compendium.pf2e.spell-effects.Item.q4EEYltjqpRGiLsP":"Compendium.pf2e.spell-effects.Item.uPmHi7ZiCj7PWM9N","Compendium.pf2e.spell-effects.Item.qbOpis7pIkXJbM2B":"Compendium.pf2e.spell-effects.Item.uPmHi7ZiCj7PWM9N","Compendium.pf2e.spell-effects.Item.qcrUH9YItV0eujQB":"Compendium.pf2e.spell-effects.Item.Fi66csT9OiBGmPZ0","Compendium.pf2e.spell-effects.Item.qo7DoF11Xl9gqmFc":"Compendium.pf2e.spell-effects.Item.fGK6zJ7mWz9D5QYo","Compendium.pf2e.spell-effects.Item.qRyynMOflGajgAR3":"Compendium.pf2e.spell-effects.Item.34yP4e2e6jpY1Bsi","Compendium.pf2e.spell-effects.Item.rAGOerZJH2TY6nvO":"Compendium.pf2e.spell-effects.Item.Fi66csT9OiBGmPZ0","Compendium.pf2e.spell-effects.Item.R3j6song8sYLY5vG":"Compendium.pf2e.spell-effects.Item.dU4viL9kh554TKeB","Compendium.pf2e.spell-effects.Item.rEsgDhunQ5Yx8KZx":"Compendium.pf2e.spell-effects.Item.oMtbVNQ5YFmmQUlU","Compendium.pf2e.spell-effects.Item.rHXOZAFBdRXIlxt5":"Compendium.pf2e.spell-effects.Item.1pC1qjvCuAKzjYo8","Compendium.pf2e.spell-effects.Item.RLUhIyqH84Dle4vo":"Compendium.pf2e.spell-effects.Item.6gRRjn0h0DAUh7nQ","Compendium.pf2e.spell-effects.Item.ROuGwXEvFznzGE9k":"Compendium.pf2e.spell-effects.Item.fcalovjrB3bzpiDH","Compendium.pf2e.spell-effects.Item.S75DOLjKaSJGMc0D":"Compendium.pf2e.spell-effects.Item.jeH78c7kyk376PKS","Compendium.pf2e.spell-effects.Item.sccNh8j1PKLHCKh1":"Compendium.pf2e.spell-effects.Item.Fi66csT9OiBGmPZ0","Compendium.pf2e.spell-effects.Item.ScF0ECWnfXMHYLDL":"Compendium.pf2e.spell-effects.Item.IKdTcUwGtnkvrCed","Compendium.pf2e.spell-effects.Item.sDN9b4bjCGH2nQnG":"Compendium.pf2e.spell-effects.Item.fGK6zJ7mWz9D5QYo","Compendium.pf2e.spell-effects.Item.sE2txm68yZSFMV3v":"Compendium.pf2e.spell-effects.Item.yEQXaB7XyaROVqyb","Compendium.pf2e.spell-effects.Item.sfJyQKmoxSRo6FyP":"Compendium.pf2e.spell-effects.Item.OH3sdHE6xWwOjq9v","Compendium.pf2e.spell-effects.Item.SjfDoeymtnYKoGUD":"Compendium.pf2e.spell-effects.Item.OH3sdHE6xWwOjq9v","Compendium.pf2e.spell-effects.Item.TAAWbJgfESltn2we":"Compendium.pf2e.spell-effects.Item.PQuQtDixruZmmvT4","Compendium.pf2e.spell-effects.Item.U2eD42cGwdvQMdN0":"Compendium.pf2e.spell-effects.Item.uIMaMzd6pcKmMNPJ","Compendium.pf2e.spell-effects.Item.u0AznkjTZAVnCMNp":"Compendium.pf2e.spell-effects.Item.1XlF12UbvJsTZxfp","Compendium.pf2e.spell-effects.Item.Um25D1qLtZWOSBny":"Compendium.pf2e.spell-effects.Item.iN6shVYuzvQ4A95i","Compendium.pf2e.spell-effects.Item.uStjY2mD6seP1K7I":"Compendium.pf2e.spell-effects.Item.IKdTcUwGtnkvrCed","Compendium.pf2e.spell-effects.Item.v051JKN0Dj3ve5cF":"Compendium.pf2e.spell-effects.Item.yEQXaB7XyaROVqyb","Compendium.pf2e.spell-effects.Item.V4a9pZHNUlddAwTA":"Compendium.pf2e.spell-effects.Item.1pC1qjvCuAKzjYo8","Compendium.pf2e.spell-effects.Item.V7jAnItnVqtfCAKt":"Compendium.pf2e.spell-effects.Item.jy4edd6pvJvJgOSP","Compendium.pf2e.spell-effects.Item.W0PjCMyGOpKAuyKX":"Compendium.pf2e.spell-effects.Item.qlz0sJIvqc0FdUdr","Compendium.pf2e.spell-effects.Item.w9HpSwBLByNyRXvi":"Compendium.pf2e.spell-effects.Item.FD9Ce5pqcZYstcMI","Compendium.pf2e.spell-effects.Item.WEpgIGFwtRb3ef1x":"Compendium.pf2e.spell-effects.Item.Fi66csT9OiBGmPZ0","Compendium.pf2e.spell-effects.Item.wqh8D9kHGItZBvtQ":"Compendium.pf2e.spell-effects.Item.K8NWxqtnrSg26KPJ","Compendium.pf2e.spell-effects.Item.xKJVqN1ETnNH3tFg":"Compendium.pf2e.spell-effects.Item.LT5AV9vSN3T9x3J9","Compendium.pf2e.spell-effects.Item.Xl48OsJ47oDVZAVQ":"Compendium.pf2e.spell-effects.Item.PQuQtDixruZmmvT4","Compendium.pf2e.spell-effects.Item.Xlwt1wpjEKWBLUjK":"Compendium.pf2e.spell-effects.Item.Dcva6SCHr9vWE7nJ","Compendium.pf2e.spell-effects.Item.XMOWgJV8UXWmpgk0":"Compendium.pf2e.spell-effects.Item.1XlF12UbvJsTZxfp","Compendium.pf2e.spell-effects.Item.xsy1yaCj0SVsn502":"Compendium.pf2e.spell-effects.Item.OH3sdHE6xWwOjq9v","Compendium.pf2e.spell-effects.Item.YCno88Te0nfwFgVo":"Compendium.pf2e.spell-effects.Item.K8NWxqtnrSg26KPJ","Compendium.pf2e.spell-effects.Item.yke7fAUDxUNzouQc":"Compendium.pf2e.spell-effects.Item.AF4vQ1xoOiJ1ewH1","Compendium.pf2e.spell-effects.Item.yq6iu0Qxg3YEbb6s":"Compendium.pf2e.spell-effects.Item.AF4vQ1xoOiJ1ewH1","Compendium.pf2e.spell-effects.Item.zdpTPf157rXl3tEJ":"Compendium.pf2e.spell-effects.Item.CWC2fPmlgixoIKy5","Compendium.pf2e.spell-effects.Item.zIRnnuj4lARq43DA":"Compendium.pf2e.spell-effects.Item.IKdTcUwGtnkvrCed","Compendium.pf2e.spells-srd.Item.0jWBnIDFpJjJShdQ":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.3P3M9SysSesALyoT":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.6mmEz1UoTHGB7Sy9":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.bmDgIbLa5NfkP97J":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.fnDBgdEeuzHRupDu":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.jupppBeFqhe6LMIb":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.k9M0kUhhHHGYquiA":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.kfsv7zSHb3pr7s9v":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.N0h3UodJFKdNQw1Y":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.NXm8z4W4YZazE2gn":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.t5HAnKSHfSfHAJwH":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.tC9HJ3sfQJFTacrE":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.spells-srd.Item.tvBhGfGcg2fsMOMe":"Compendium.pf2e.spells-srd.Item.JcobNl4iE9HmMYtE","Compendium.pf2e.strength-of-thousands-bestiary.Actor.DaOSfNGARU0QeMsp":"Compendium.pf2e.vehicles.Actor.8rXCF2Fr4iA0VmFx","Compendium.pf2e.the-slithering-bestiary.Actor.idj4GBmsLUNUbk9r":"Compendium.pf2e.pathfinder-bestiary.Actor.Tpuqwt6Af29EMtqX"};const Init={listen:__name2(()=>{Hooks.once("init",()=>{if(console.log("PF2e System | Initializing Pathfinder 2nd Edition System"),delete game.system.documentTypes.Item.affliction,CONFIG.PF2E=PF2ECONFIG,CONFIG.debug.ruleElement??=!1,setPerceptionModes(),CONFIG.time.roundTime=6,CONFIG.Combat.initiative.decimals=0,CONFIG.ui.actors=ActorDirectoryPF2e,CONFIG.ui.items=ItemDirectoryPF2e,CONFIG.ui.chat=ChatLogPF2e,CONFIG.ui.combat=EncounterTracker,CONFIG.ui.compendium=CompendiumDirectoryPF2e,CONFIG.specialStatusEffects.BLIND="blinded",document.querySelector("#ui-top")!==null){const uiTop=document.querySelector("#ui-top"),template=document.createElement("template");template.setAttribute("id","pf2e-effects-panel"),uiTop?.insertAdjacentElement("afterend",template)}for(const[from,to]of t$f(define_UUID_REDIRECTS_default))CONFIG.compendium.uuidRedirects[from]=to;CONFIG.TinyMCE.extended_valid_elements="pf2-action[action|glyph]",CONFIG.TinyMCE.content_css.push("systems/pf2e/styles/pf2e.css"),CONFIG.TinyMCE.style_formats=(CONFIG.TinyMCE.style_formats??[]).concat({title:"PF2E",items:[{title:"Icons 1 2 3 F R",inline:"span",classes:["action-glyph"],wrapper:!0},{title:"Inline Header",block:"h4",classes:"inline-header"},{title:"Info Block",block:"section",classes:"info",wrapper:!0,exact:!0,merge_siblings:!1},{title:"Stat Block",block:"section",classes:"statblock",wrapper:!0,exact:!0,merge_siblings:!1},{title:"Trait",block:"section",classes:"traits",wrapper:!0},{title:"Written Note",block:"p",classes:"message"},{title:"GM Text Block",block:"div",wrapper:!0,attributes:{"data-visibility":"gm"}},{title:"GM Text Inline",inline:"span",attributes:{"data-visibility":"gm"}}]}),CONFIG.ux.TextEditor=TextEditorPF2e,CONFIG.TextEditor.enrichers.push({pattern:/@(Check|Localize|Template)\[([^\]]+)\](?:{([^}]+)})?/g,enricher:__name2((match,options)=>TextEditorPF2e.enrichString(match,options),"enricher")}),CONFIG.TextEditor.enrichers.push({pattern:/@(Damage)\[((?:[^[\]]|\[[^[\]]*\])*)\](?:{([^}]+)})?/g,enricher:__name2((match,options)=>TextEditorPF2e.enrichString(match,options),"enricher")}),CONFIG.TextEditor.enrichers.push({pattern:/\[\[\/(act)\s+(?<slug>[-a-z]+)(?:\s+(?<options>[^\]]+))?\]\](?:\{(?<label>[^}]+)\})?/g,enricher:__name2((match,options)=>TextEditorPF2e.enrichString(match,options),"enricher")}),registerFonts(),registerHandlebarsHelpers(),registerKeybindings(),registerSettings(),registerTemplates(),MystifiedTraits.compile(),SetGamePF2e.onInit();const prototypeFields=foundry.documents.BaseActor.schema.fields.prototypeToken.fields;prototypeFields.displayName.initial=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,prototypeFields.displayBars.initial=CONST.TOKEN_DISPLAY_MODES.OWNER_HOVER,prototypeFields.lockRotation.initial=!0;for(const element of htmlQueryAll(document.head,"link[rel=stylesheet]")){const href=element.getAttribute("href");href?.startsWith("modules/")&&href.endsWith("tagify.css")&&element.setAttribute("disabled","")}game.pf2e.StatusEffects.initialize()})},"listen")},LightingRefresh={listen:__name2(()=>{Hooks.on("lightingRefresh",()=>{SceneDarknessAdjuster.instance.onLightingRefresh(canvas.darknessLevel)})},"listen")},fields$l=foundry.data.fields;class ActorSystemModel extends foundry.abstract.TypeDataModel{static{__name(this,"ActorSystemModel")}static{__name2(this,"ActorSystemModel")}static defineSchema(){return{_migration:new fields$l.SchemaField({version:new fields$l.NumberField({required:!0,nullable:!0,positive:!0,initial:null}),previous:new fields$l.SchemaField({foundry:new fields$l.StringField({required:!0,nullable:!0,initial:null}),system:new fields$l.StringField({required:!0,nullable:!0,initial:null}),schema:new fields$l.NumberField({required:!0,nullable:!0,positive:!0,initial:null})},{required:!0,nullable:!0,initial:null})})}}}const fields$k=foundry.data.fields;class ArmySystemData extends ActorSystemModel{static{__name(this,"ArmySystemData")}static{__name2(this,"ArmySystemData")}static defineSchema(){const parent=super.defineSchema();function createWeaponSchema(){return{name:new fields$k.StringField({required:!0,nullable:!1}),potency:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:0})}}__name(createWeaponSchema,"createWeaponSchema"),__name2(createWeaponSchema,"createWeaponSchema");function getLevelDefault(record,level){return typeof level=="number"&&level in record?record[level]:record[1]}return __name(getLevelDefault,"getLevelDefault"),__name2(getLevelDefault,"getLevelDefault"),{...parent,ac:new fields$k.SchemaField({value:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:__name2(d=>getLevelDefault(ARMY_STATS.ac,d.details?.level?.value),"initial")}),potency:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:0})}),attributes:new fields$k.SchemaField({hp:new fields$k.SchemaField({value:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:4}),temp:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:0}),max:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:4}),routThreshold:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:2})})}),details:new fields$k.SchemaField({level:new fields$k.SchemaField({value:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:1})}),description:new fields$k.HTMLField({required:!0,nullable:!1,initial:""})}),consumption:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:1}),scouting:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:__name2(d=>getLevelDefault(ARMY_STATS.scouting,d.details?.level?.value),"initial")}),recruitmentDC:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:15}),saves:new fields$k.SchemaField({maneuver:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:__name2(d=>getLevelDefault(ARMY_STATS.strongSave,d.details?.level?.value),"initial")}),morale:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,initial:__name2(d=>getLevelDefault(ARMY_STATS.weakSave,d.details?.level?.value),"initial")})}),weapons:new fields$k.SchemaField({melee:new fields$k.SchemaField(createWeaponSchema(),{required:!0,nullable:!0,initial:null}),ranged:new fields$k.SchemaField(createWeaponSchema(),{required:!0,nullable:!0,initial:null})}),resources:new fields$k.SchemaField({ammunition:new fields$k.SchemaField({value:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:0})}),potions:new fields$k.SchemaField({value:new fields$k.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:0})})}),traits:new fields$k.SchemaField({value:new fields$k.ArrayField(new fields$k.StringField({required:!0,nullable:!1})),rarity:new fields$k.StringField({required:!0,nullable:!1,choices:RARITIES,initial:"common"}),type:new fields$k.StringField({required:!0,nullable:!1,choices:ARMY_TYPES,initial:"infantry"})})}}}const fields$j=foundry.data.fields;class FamiliarSystemData extends ActorSystemModel{static{__name(this,"FamiliarSystemData")}static{__name2(this,"FamiliarSystemData")}static defineSchema(){return{...super.defineSchema(),master:new fields$j.SchemaField({id:new fields$j.ForeignDocumentField(CharacterPF2e,{idOnly:!0,required:!0,nullable:!0,initial:null}),ability:new fields$j.StringField({required:!0,nullable:!0,choices:Array.from(ATTRIBUTE_ABBREVIATIONS),initial:null})}),attributes:new fields$j.SchemaField({hp:new fields$j.SchemaField({value:new fields$j.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:5}),temp:new fields$j.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:0})})}),details:new fields$j.SchemaField({creature:new fields$j.SchemaField({value:new fields$j.StringField({required:!0,nullable:!1,blank:!0,initial:""})})})}}prepareBaseData(){super.prepareBaseData();const master=this.parent.master;this.details={alliance:master?.alliance??"party",creature:this.details.creature,languages:{value:[],details:""},level:{value:master?.level??0}},this.traits={value:["minion"],rarity:"common",size:new ActorSizePF2e({value:"tiny"})};const system2=this;system2.perception={senses:[{type:"low-light-vision",acuity:"precise",range:1/0,source:null}]},system2.skills={},system2.saves={fortitude:{},reflex:{},will:{}}}prepareDerivedData(){super.prepareDerivedData(),this.traits.value=n(this.traits.value).sort()}}const fields$i=foundry.data.fields;class HazardSystemData extends ActorSystemModel{static{__name(this,"HazardSystemData")}static{__name2(this,"HazardSystemData")}static defineSchema(){const hazardTraits2=CONFIG.PF2E.hazardTraits,sizes=CONFIG.PF2E.actorSizes,immunityTypes2=CONFIG.PF2E.immunityTypes,weaknessTypes2=CONFIG.PF2E.weaknessTypes,resistanceTypes2=CONFIG.PF2E.resistanceTypes,requiredInteger=__name2(({min,initial=min})=>new fields$i.NumberField({required:!0,nullable:!1,integer:!0,min,initial}),"requiredInteger"),blankableString=__name2(()=>new fields$i.StringField({required:!0,nullable:!1,blank:!0,initial:""}),"blankableString"),createSaveDataSchema=__name2(()=>new fields$i.SchemaField({value:new fields$i.NumberField({required:!0,nullable:!1,integer:!0,initial:0})}),"createSaveDataSchema");return{...super.defineSchema(),traits:new fields$i.SchemaField({value:new LaxArrayField(new fields$i.StringField({required:!0,nullable:!1,choices:hazardTraits2,initial:void 0})),rarity:new RarityField,size:new fields$i.SchemaField({value:new fields$i.StringField({required:!0,nullable:!1,choices:sizes,initial:"lg"})})}),attributes:new fields$i.SchemaField({hp:new fields$i.SchemaField({value:requiredInteger({min:0}),max:requiredInteger({min:0}),temp:requiredInteger({min:0}),details:blankableString()}),ac:new fields$i.SchemaField({value:new fields$i.NumberField}),hardness:requiredInteger({min:0}),stealth:new fields$i.SchemaField({value:new fields$i.NumberField({required:!0,nullable:!0,initial:null}),details:blankableString()}),immunities:new LaxArrayField(new fields$i.SchemaField({type:new fields$i.StringField({required:!0,nullable:!1,choices:immunityTypes2,initial:void 0}),exceptions:new LaxArrayField(new fields$i.StringField({required:!0,nullable:!1,choices:immunityTypes2,initial:void 0}))})),weaknesses:new LaxArrayField(new fields$i.SchemaField({type:new fields$i.StringField({required:!0,nullable:!1,choices:weaknessTypes2,initial:void 0}),value:requiredInteger({min:1}),exceptions:new LaxArrayField(new fields$i.StringField({required:!0,nullable:!1,choices:weaknessTypes2,initial:void 0}))})),resistances:new LaxArrayField(new fields$i.SchemaField({type:new fields$i.StringField({required:!0,nullable:!1,choices:resistanceTypes2,initial:void 0}),value:requiredInteger({min:1}),exceptions:new LaxArrayField(new fields$i.StringField({required:!0,nullable:!1,choices:resistanceTypes2,initial:void 0})),doubleVs:new LaxArrayField(new fields$i.StringField({required:!0,nullable:!1,choices:resistanceTypes2,initial:void 0}))})),emitsSound:new DataUnionField([new fields$i.StringField({required:!0,nullable:!1,choices:["encounter"],initial:void 0}),new fields$i.BooleanField({required:!0,nullable:!1,initial:void 0})],{required:!0,nullable:!1,initial:"encounter"})}),details:new fields$i.SchemaField({description:new fields$i.HTMLField({required:!0,nullable:!1,initial:""}),level:new fields$i.SchemaField({value:requiredInteger({min:-1,initial:1})}),isComplex:new fields$i.BooleanField({required:!0,nullable:!1,initial:!1}),disable:blankableString(),routine:blankableString(),reset:blankableString(),publication:new PublicationField}),saves:new fields$i.SchemaField({fortitude:createSaveDataSchema(),reflex:createSaveDataSchema(),will:createSaveDataSchema()})}}}const fields$h=foundry.data.fields;class LootSystemData extends ActorSystemModel{static{__name(this,"LootSystemData")}static{__name2(this,"LootSystemData")}static defineSchema(){return{...super.defineSchema(),details:new fields$h.SchemaField({description:new fields$h.HTMLField({required:!0,nullable:!1,initial:""}),level:new fields$h.SchemaField({value:new fields$h.NumberField({required:!0,nullable:!1,min:0,integer:!0,initial:0})})}),lootSheetType:new fields$h.StringField({required:!0,nullable:!1,choices:["Loot","Merchant"],initial:"Loot"}),hiddenWhenEmpty:new fields$h.BooleanField}}}const fields$g=foundry.data.fields;class PartySystemData extends ActorSystemModel{static{__name(this,"PartySystemData")}static{__name2(this,"PartySystemData")}static defineSchema(){return{...super.defineSchema(),details:new fields$g.SchemaField({description:new fields$g.HTMLField({required:!0,nullable:!1,initial:""}),members:new fields$g.ArrayField(new fields$g.SchemaField({uuid:new fields$g.DocumentUUIDField({required:!0,nullable:!1,initial:void 0})}))}),campaign:new fields$g.SchemaField(Kingdom.defineSchema(),{required:!1,nullable:!0,initial:null})}}prepareBaseData(){super.prepareBaseData(),this.details.level={value:0},this.attributes={reach:{base:0,manipulate:0},flanking:{canFlank:!1,canGangUp:[],flankable:!1,offGuardable:!1},immunities:[],weaknesses:[],resistances:[]},this.movement={speeds:{travel:{value:0}}}}prepareDerivedData(){super.prepareDerivedData();const members=this.parent.members;this.details.level.value=Math.round(t$h(members.filter(m=>m.isOfType("character")),m=>m.level)),this.details.alliance=members.some(m=>m.alliance==="party")?"party":members.some(m=>m.alliance==="opposition")?"opposition":null,this.attributes.reach.manipulate=members.reduce((highest,a)=>Math.max(a.system.attributes.reach.manipulate,highest),0),this.movement.speeds.travel.value=Math.min(...members.length===0?[0]:members.map(a=>a.system.movement.speeds.travel.value))}}const fields$f=foundry.data.fields;class VehicleSystemData extends ActorSystemModel{static{__name(this,"VehicleSystemData")}static{__name2(this,"VehicleSystemData")}static defineSchema(){const vehicleTraits2=CONFIG.PF2E.vehicleTraits,sizes=CONFIG.PF2E.actorSizes,requiredInteger=__name2(({min,initial=min})=>new fields$f.NumberField({required:!0,nullable:!1,integer:!0,min,initial}),"requiredInteger"),blankableString=__name2(()=>new fields$f.StringField({required:!0,nullable:!1,blank:!0,initial:""}),"blankableString"),spaceDimension=__name2(()=>new fields$f.NumberField({required:!0,nullable:!1,integer:!0,min:5,step:5,max:300,initial:5}),"spaceDimension"),immunityTypes2=CONFIG.PF2E.immunityTypes,weaknessTypes2=CONFIG.PF2E.weaknessTypes,resistanceTypes2=CONFIG.PF2E.resistanceTypes;return{...super.defineSchema(),traits:new fields$f.SchemaField({value:new LaxArrayField(new fields$f.StringField({required:!0,nullable:!1,choices:vehicleTraits2,initial:void 0})),rarity:new RarityField,size:new fields$f.SchemaField({value:new fields$f.StringField({required:!0,nullable:!1,choices:sizes,initial:"lg"})})}),attributes:new fields$f.SchemaField({hp:new fields$f.SchemaField({value:requiredInteger({min:0}),max:requiredInteger({min:0}),temp:requiredInteger({min:0}),details:blankableString()}),ac:new fields$f.SchemaField({value:requiredInteger({min:-1/0,initial:0})}),hardness:requiredInteger({min:0}),collisionDC:new fields$f.SchemaField({value:requiredInteger({min:-1/0,initial:0})}),collisionDamage:new fields$f.SchemaField({value:blankableString()}),immunities:new LaxArrayField(new fields$f.SchemaField({type:new fields$f.StringField({required:!0,nullable:!1,choices:immunityTypes2,initial:void 0}),exceptions:new LaxArrayField(new fields$f.StringField({required:!0,nullable:!1,choices:immunityTypes2,initial:void 0}))})),weaknesses:new LaxArrayField(new fields$f.SchemaField({type:new fields$f.StringField({required:!0,nullable:!1,choices:weaknessTypes2,initial:void 0}),value:requiredInteger({min:1}),exceptions:new LaxArrayField(new fields$f.StringField({required:!0,nullable:!1,choices:weaknessTypes2,initial:void 0}))})),resistances:new LaxArrayField(new fields$f.SchemaField({type:new fields$f.StringField({required:!0,nullable:!1,choices:resistanceTypes2,initial:void 0}),value:requiredInteger({min:1}),exceptions:new LaxArrayField(new fields$f.StringField({required:!0,nullable:!1,choices:resistanceTypes2,initial:void 0})),doubleVs:new LaxArrayField(new fields$f.StringField({required:!0,nullable:!1,choices:resistanceTypes2,initial:void 0}))})),emitsSound:new DataUnionField([new fields$f.StringField({required:!0,nullable:!1,choices:["encounter"],initial:void 0}),new fields$f.BooleanField({required:!0,nullable:!1,initial:void 0})],{required:!0,nullable:!1,initial:"encounter"})}),details:new fields$f.SchemaField({description:new fields$f.HTMLField({required:!0,nullable:!1,initial:""}),level:new fields$f.SchemaField({value:requiredInteger({min:-1,initial:0})}),price:requiredInteger({min:0}),space:new fields$f.SchemaField({long:spaceDimension(),wide:spaceDimension(),high:spaceDimension()}),crew:blankableString(),passengers:blankableString(),pilotingCheck:blankableString(),AC:requiredInteger({min:0}),speed:blankableString(),publication:new PublicationField}),saves:new fields$f.SchemaField({fortitude:new fields$f.SchemaField({value:requiredInteger({min:-1/0,initial:0})})})}}prepareBaseData(){super.prepareBaseData(),this.details.alliance=null;const size=this.traits.size,dimensions=this.parent.dimensions;size.long=dimensions.length,size.wide=dimensions.width,this.attributes.immunities.some(i=>i.type==="object-immunities")||this.attributes.immunities.push(new Immunity({type:"object-immunities",source:"TYPES.Actor.vehicle"}));const driveSpeed=Math.floor(Number.parseInt(this.details.speed))||null;this.movement={speeds:{drive:{value:driveSpeed}}}}}const fields$e=foundry.data.fields;class AbilityTraitToggles extends foundry.abstract.DataModel{static{__name(this,"AbilityTraitToggles")}static{__name2(this,"AbilityTraitToggles")}static defineSchema(){return{mindshift:new fields$e.SchemaField({selected:new fields$e.BooleanField},{required:!1,nullable:!0,initial:void 0})}}get item(){return this.parent.parent}get operableTraits(){return this.item.system.traits.value.includes("mindshift")?["mindshift"]:[]}prepareData(){const selected=this.mindshift?.selected??!1,item=this.item;this.mindshift=item.system.traits.value.includes("mindshift")?{selected}:null,this.mindshift?.selected&&item.system.traits.otherTags.push("mindshifted")}getDamageAlterations(){return this.mindshift?.selected?[new DamageAlteration({mode:"override",property:"damage-type",slug:"mindshift",value:"mental"})]:[]}getSheetData(){return["mindshift"].map(t2=>{const data=this[t2];return data?{trait:t2,selected:data.selected,icon:"brain",classes:"damage color mental",tooltip:CONFIG.PF2E.actionTraits[t2]}:null}).filter(e$1)}async update({trait,selected}){const current=this[trait]?.selected;return current===selected||typeof current!="boolean"?!1:!!await this.item.update({[`system.traits.toggles.${trait}.selected`]:selected})}}const fields$d=foundry.data.fields;class FrequencyField extends fields$d.SchemaField{static{__name(this,"FrequencyField")}static{__name2(this,"FrequencyField")}constructor(){const frequencies=CONFIG.PF2E.frequencies;super({value:new fields$d.NumberField({required:!1,nullable:!1,integer:!0,min:0,initial:void 0}),max:new fields$d.NumberField({required:!0,nullable:!1,integer:!0,positive:!0,initial:1}),per:new fields$d.StringField({required:!0,nullable:!1,choices:frequencies,initial:"round"})},{required:!1,nullable:!0,initial:void 0})}}class AbilitySystemData extends ItemSystemModel{static{__name(this,"AbilitySystemData")}static{__name2(this,"AbilitySystemData")}static LOCALIZATION_PREFIXES=[...super.LOCALIZATION_PREFIXES,"PF2E.Item.Ability"];static defineSchema(){const traitChoices=CONFIG.PF2E.actionTraits,abilityTypes=CONFIG.PF2E.actionTypes,categories=CONFIG.PF2E.actionCategories;return{...super.defineSchema(),traits:new fields$d.SchemaField({otherTags:new fields$d.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0})),value:new LaxArrayField(new fields$d.StringField({required:!0,nullable:!1,choices:traitChoices,initial:void 0})),toggles:new fields$d.EmbeddedDataField(AbilityTraitToggles,{required:!1,nullable:!1,initial:void 0})}),actionType:new fields$d.SchemaField({value:new fields$d.StringField({choices:abilityTypes,required:!0,nullable:!1,initial:"action"})}),actions:new fields$d.SchemaField({value:new fields$d.NumberField({choices:[1,2,3],nullable:!0,initial:1})}),category:new fields$d.StringField({required:!0,nullable:!0,choices:categories,initial:null}),deathNote:new fields$d.BooleanField({required:!1,nullable:!1,initial:void 0}),frequency:new FrequencyField,selfEffect:new fields$d.SchemaField({uuid:new fields$d.DocumentUUIDField({required:!0,nullable:!1,initial:void 0}),name:new fields$d.StringField({required:!0,nullable:!1,initial:void 0})},{required:!1,nullable:!0,initial:void 0})}}prepareBaseData(){super.prepareBaseData(),this.deathNote??=!1,this.frequency??=null,this.parent.actor&&this.frequency&&(this.frequency.value??=this.frequency.max),this.selfEffect??=null,this.actionType.value==="passive"&&(this.selfEffect=null),this.traits.toggles??=new AbilityTraitToggles(this.traits.toggles??{},{parent:this})}prepareDerivedData(){this.traits.toggles.prepareData()}}const originalAncestryTraits=t$4(ancestryTraits);class AbilitySheetPF2e extends ItemSheetPF2e{static{__name(this,"AbilitySheetPF2e")}static{__name2(this,"AbilitySheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,dragDrop:[{dropSelector:".tab[data-tab=details]"}],hasSidebar:!0}}get validTraits(){return n$1(this.item.constructor.validTraits,[...originalAncestryTraits,"archetype","cantrip","class","dedication","focus","general","skill","summoned"])}async getData(options={}){const sheetData=await super.getData(options);return{...sheetData,fields:this.item.system.schema.fields,actionTypes:CONFIG.PF2E.actionTypes,actionsNumber:CONFIG.PF2E.actionsNumber,actionTraits:CONFIG.PF2E.actionTraits,frequencies:CONFIG.PF2E.frequencies,proficiencies:CONFIG.PF2E.proficiencyLevels,selfEffect:createSelfEffectSheetData(sheetData.data.selfEffect)}}activateListeners($html){if(super.activateListeners($html),!this.isEditable)return;const html2=$html[0];activateActionSheetListeners(this.item,html2)}async _onDrop(event2){const item=await getItemFromDragEvent(event2);if(item&&!await handleSelfEffectDrop(this,item))throw ErrorPF2e("Invalid item drop")}}foundry.data.fields;const fields$c=foundry.data.fields;class CampaignFeatureSystemData extends ItemSystemModel{static{__name(this,"CampaignFeatureSystemData")}static{__name2(this,"CampaignFeatureSystemData")}static defineSchema(){const actionTypes=CONFIG.PF2E.actionTypes,kingmakerTraits2=CONFIG.PF2E.kingmakerTraits;return{...super.defineSchema(),campaign:new fields$c.StringField({required:!0,nullable:!1,choices:["kingmaker"],initial:"kingmaker"}),category:new fields$c.StringField({required:!0,nullable:!1,choices:KINGMAKER_CATEGORY_TYPES,initial:"kingdom-activity"}),level:new fields$c.SchemaField({value:new fields$c.NumberField({required:!0,nullable:!1,integer:!0,min:1,max:30,initial:1})}),traits:new fields$c.SchemaField({value:new LaxArrayField(new fields$c.StringField({required:!0,nullable:!1,choices:kingmakerTraits2,initial:void 0})),otherTags:new fields$c.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0}))}),actionType:new fields$c.SchemaField({value:new fields$c.StringField({required:!0,nullable:!1,choices:actionTypes,initial:"passive"})}),actions:new fields$c.SchemaField({value:new fields$c.NumberField({required:!0,nullable:!0,choices:[1,2,3]})}),prerequisites:new fields$c.SchemaField({value:new fields$c.ArrayField(new fields$c.SchemaField({value:new fields$c.StringField({required:!0,nullable:!1,initial:void 0})}))}),location:new fields$c.StringField({required:!0,nullable:!0,blank:!1,initial:null}),frequency:new FrequencyField}}prepareBaseData(){super.prepareBaseData(),this.frequency??=null,this.actor&&this.frequency&&(this.frequency.value??=this.frequency.max)}}const fields$b=foundry.data.fields;class ABCFeatureEntryField extends fields$b.SchemaField{static{__name(this,"ABCFeatureEntryField")}static{__name2(this,"ABCFeatureEntryField")}constructor(){super({uuid:new fields$b.DocumentUUIDField({required:!0,nullable:!1}),img:new fields$b.FilePathField({categories:["IMAGE"],required:!0,nullable:!1}),name:new fields$b.StringField({required:!0,nullable:!1}),level:new fields$b.NumberField({required:!0,nullable:!1,integer:!0,min:0})})}}const fields$a=foundry.data.fields;class ClassSystemData extends ItemSystemModel{static{__name(this,"ClassSystemData")}static{__name2(this,"ClassSystemData")}static LOCALIZATION_PREFIXES=["PF2E.Item.Class"];static defineSchema(){const createLevelLists=__name2(initial=>new fields$a.SchemaField({value:new fields$a.ArrayField(new fields$a.NumberField({required:!0,min:1,nullable:!1}),{initial})}),"createLevelLists");return{...super.defineSchema(),items:new RecordField(new fields$a.StringField({required:!0,nullable:!1}),new ABCFeatureEntryField),traits:new fields$a.SchemaField({otherTags:new fields$a.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0})),rarity:new RarityField}),keyAbility:new fields$a.SchemaField({value:new fields$a.ArrayField(new fields$a.StringField({choices:[...ATTRIBUTE_ABBREVIATIONS],required:!0,nullable:!1})),selected:new fields$a.StringField({choices:[...ATTRIBUTE_ABBREVIATIONS],required:!0,nullable:!0,initial:null})}),hp:new fields$a.NumberField({required:!0,nullable:!1,min:4,max:12,initial:6}),perception:new ProficiencyRankField,savingThrows:new fields$a.SchemaField({fortitude:new ProficiencyRankField,reflex:new ProficiencyRankField,will:new ProficiencyRankField}),attacks:new fields$a.SchemaField({simple:new ProficiencyRankField,martial:new ProficiencyRankField,advanced:new ProficiencyRankField,unarmed:new ProficiencyRankField,other:new fields$a.SchemaField({name:new fields$a.StringField,rank:new ProficiencyRankField})}),defenses:new fields$a.SchemaField({unarmored:new ProficiencyRankField,light:new ProficiencyRankField,medium:new ProficiencyRankField,heavy:new ProficiencyRankField}),spellcasting:new ProficiencyRankField,trainedSkills:new fields$a.SchemaField({value:new LaxArrayField(new fields$a.StringField({choices:getCompatSkills,required:!0,nullable:!1})),additional:new fields$a.NumberField({required:!0,nullable:!1,min:0,integer:!0,initial:0})}),ancestryFeatLevels:createLevelLists([1,5,9,13,17]),classFeatLevels:createLevelLists([1,2,4,6,8,10,12,14,16,18,20]),generalFeatLevels:createLevelLists([3,7,11,15,19]),skillFeatLevels:createLevelLists([2,4,6,8,10,12,14,16,18,20]),skillIncreaseLevels:createLevelLists([3,5,7,9,11,13,15,17,19])}}}const fields$9=foundry.data.fields;class ConditionSystemData extends ItemSystemModel{static{__name(this,"ConditionSystemData")}static{__name2(this,"ConditionSystemData")}static defineSchema(){const effectTraits2=CONFIG.PF2E.effectTraits,damageTypes2=CONFIG.PF2E.damageTypes,createRefListSchema=__name2(()=>new fields$9.ArrayField(new fields$9.SchemaField({id:new fields$9.StringField({required:!0,nullable:!1}),type:new fields$9.StringField({choices:["condition"],required:!0,initial:"condition"})})),"createRefListSchema");return{...super.defineSchema(),traits:new fields$9.SchemaField({otherTags:new fields$9.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0})),value:new LaxArrayField(new fields$9.StringField({required:!0,nullable:!1,choices:effectTraits2,initial:void 0}))}),fromSpell:new fields$9.BooleanField({required:!0,nullable:!1}),group:new fields$9.StringField({required:!0,nullable:!0,initial:null}),value:new fields$9.SchemaField({isValued:new fields$9.BooleanField({required:!0,nullable:!1,initial:!1}),value:new fields$9.NumberField({required:!0,nullable:!0,initial:null})}),persistent:new fields$9.SchemaField({formula:new fields$9.StringField({required:!0,nullable:!1}),damageType:new fields$9.StringField({choices:damageTypes2,required:!0,nullable:!1,initial:"untyped"}),dc:new fields$9.NumberField({required:!0,nullable:!1,initial:15}),criticalHit:new fields$9.BooleanField({required:!0,nullable:!1,initial:!1})},{required:!0,nullable:!0,initial:null}),references:new fields$9.SchemaField({parent:new fields$9.SchemaField({id:new fields$9.StringField({required:!0,nullable:!1})},{required:!0,nullable:!0,initial:null}),children:createRefListSchema(),overrides:createRefListSchema(),overriddenBy:createRefListSchema()}),overrides:new fields$9.ArrayField(new fields$9.StringField)}}prepareBaseData(){this.duration={value:-1,unit:"unlimited",expiry:null}}}const fields$8=foundry.data.fields;class EffectSystemData extends ItemSystemModel{static{__name(this,"EffectSystemData")}static{__name2(this,"EffectSystemData")}static defineSchema(){const effectTraits2=CONFIG.PF2E.effectTraits;return{...super.defineSchema(),level:new fields$8.SchemaField({value:new fields$8.NumberField({required:!0,nullable:!1,integer:!0,initial:1})}),traits:new fields$8.SchemaField({otherTags:new fields$8.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0})),value:new LaxArrayField(new fields$8.StringField({required:!0,nullable:!1,choices:effectTraits2,initial:void 0}))}),duration:new fields$8.SchemaField({value:new fields$8.NumberField({required:!0,nullable:!1,initial:-1,min:-1}),unit:new fields$8.StringField({choices:[...EFFECT_TIME_UNITS,"unlimited","encounter"],initial:"unlimited"}),expiry:new fields$8.StringField({choices:["turn-start","turn-end","round-end"],required:!0,nullable:!0,initial:null}),sustained:new fields$8.BooleanField({required:!0,nullable:!1,initial:!1})}),tokenIcon:new fields$8.SchemaField({show:new fields$8.BooleanField({required:!0,nullable:!1,initial:!0})}),unidentified:new fields$8.BooleanField({required:!0,nullable:!1,initial:!1}),start:new fields$8.SchemaField({value:new fields$8.NumberField({required:!0,nullable:!1,initial:0}),initiative:new fields$8.NumberField({required:!0,nullable:!0,initial:null})}),badge:new EffectBadgeField,fromSpell:new fields$8.BooleanField({required:!0,nullable:!1}),context:new EffectContextField}}prepareBaseData(){["unlimited","encounter"].includes(this.duration.unit)?this.duration.expiry=null:this.duration.expiry||="turn-start";const badge=this.badge;badge?.type==="formula"?badge.label=null:badge&&(badge.min=badge.labels?1:badge.min??1,badge.max=badge.labels?.length??badge.max??1/0,badge.value=Math.clamp(badge.value,badge.min,badge.max),badge.label=badge.labels?.at(badge.value-1)?.trim()||null,badge.type==="value"&&badge.reevaluate&&(badge.reevaluate.initial??=badge.value))}}class EffectBadgeField extends fields$8.TypedSchemaField{static{__name(this,"EffectBadgeField")}static{__name2(this,"EffectBadgeField")}constructor(){const reevaluationEvent=["initiative-roll","turn-start","turn-end"],createLabelsField=__name2(()=>new fields$8.ArrayField(new fields$8.StringField({required:!0,blank:!0}),{required:!1,nullable:!0,initial:null}),"createLabelsField");super({counter:new fields$8.SchemaField({type:new fields$8.StringField({choices:["counter"],required:!0}),labels:createLabelsField(),min:new fields$8.NumberField({required:!1,nullable:!0,integer:!0}),max:new fields$8.NumberField({required:!1,nullable:!0,integer:!0}),value:new fields$8.NumberField({required:!0,nullable:!1}),loop:new fields$8.BooleanField({required:!1,nullable:!1})}),value:new fields$8.SchemaField({type:new fields$8.StringField({choices:["value"],required:!0}),labels:createLabelsField(),value:new fields$8.NumberField({required:!0,nullable:!1}),reevaluate:new fields$8.SchemaField({event:new fields$8.StringField({choices:reevaluationEvent,required:!0,nullable:!1}),formula:new fields$8.StringField({required:!0,nullable:!1}),initial:new fields$8.NumberField({required:!1,nullable:!1})},{required:!0,nullable:!0,initial:null})}),formula:new fields$8.SchemaField({type:new fields$8.StringField({choices:["formula"],required:!0}),labels:createLabelsField(),value:new fields$8.StringField({required:!0,nullable:!1,blank:!0}),evaluate:new fields$8.BooleanField({required:!1,nullable:!1}),reevaluate:new fields$8.StringField({choices:reevaluationEvent,required:!0,nullable:!0,initial:null})})},{required:!0,nullable:!0,initial:null})}}const fields$7=foundry.data.fields;class FeatSystemData extends ItemSystemModel{static{__name(this,"FeatSystemData")}static{__name2(this,"FeatSystemData")}static defineSchema(){const featTraits2=CONFIG.PF2E.featTraits,featCategories2=CONFIG.PF2E.featCategories,actionTypes=CONFIG.PF2E.actionTypes,attributes=CONFIG.PF2E.abilities,senseTypes=CONFIG.PF2E.senses,senseAcuities2=CONFIG.PF2E.senseAcuities,languages=CONFIG.PF2E.languages;let increasableProficiencies=null;const getIncreasableProficiencies=__name2(()=>increasableProficiencies??={...CONFIG.PF2E.saves,...CONFIG.PF2E.classTraits,...CONFIG.PF2E.armorCategories,...CONFIG.PF2E.weaponCategories,perception:"PF2E.PerceptionLabel",spellcasting:"PF2E.Item.Spell.Plural"},"getIncreasableProficiencies");return{...super.defineSchema(),level:new fields$7.SchemaField({value:new fields$7.NumberField({required:!0,nullable:!1,integer:!0,min:1,max:30,initial:1}),taken:new fields$7.NumberField({required:!1,nullable:!0,integer:!0,min:1,max:30,initial:void 0})}),traits:new fields$7.SchemaField({otherTags:new fields$7.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0})),value:new LaxArrayField(new fields$7.StringField({required:!0,nullable:!1,choices:featTraits2,initial:void 0})),rarity:new RarityField,toggles:new fields$7.EmbeddedDataField(AbilityTraitToggles,{required:!1,nullable:!1,initial:void 0})}),category:new fields$7.StringField({required:!0,nullable:!1,choices:featCategories2,initial:"bonus"}),onlyLevel1:new fields$7.BooleanField({required:!0,nullable:!1,initial:!1}),maxTakable:new fields$7.NumberField({required:!0,nullable:!0,positive:!0,integer:!0,initial:1}),actionType:new fields$7.SchemaField({value:new fields$7.StringField({required:!0,nullable:!1,choices:actionTypes,initial:"passive"})}),actions:new fields$7.SchemaField({value:new fields$7.NumberField({required:!0,nullable:!0,choices:[1,2,3]})}),prerequisites:new fields$7.SchemaField({value:new fields$7.ArrayField(new fields$7.SchemaField({value:new fields$7.StringField({required:!0,nullable:!1,initial:void 0})}))}),frequency:new FrequencyField,subfeatures:new fields$7.SchemaField({keyOptions:new fields$7.ArrayField(new fields$7.StringField({required:!0,nullable:!1,choices:attributes,initial:void 0}),{required:!1,nullable:!1,initial:void 0}),languages:new fields$7.SchemaField({slots:new fields$7.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:0}),granted:new fields$7.ArrayField(new fields$7.StringField({required:!0,nullable:!1,choices:languages}))},{required:!1,nullable:!1,initial:void 0}),proficiencies:new RecordField(new fields$7.StringField({required:!0,nullable:!1,choices:getIncreasableProficiencies}),new fields$7.SchemaField({rank:new fields$7.NumberField({required:!0,nullable:!1,integer:!0,min:1,max:4,initial:void 0}),attribute:new fields$7.StringField({required:!0,nullable:!0,choices:attributes,initial:null})})),senses:new RecordField(new fields$7.StringField({required:!0,nullable:!1,choices:senseTypes}),new fields$7.SchemaField({acuity:new fields$7.StringField({required:!1,nullable:!1,choices:senseAcuities2,initial:void 0}),range:new fields$7.NumberField({required:!0,min:5,step:5,max:300}),special:new fields$7.SchemaField({ancestry:new fields$7.BooleanField,llv:new fields$7.BooleanField,second:new fields$7.BooleanField})})),suppressedFeatures:new fields$7.ArrayField(new fields$7.DocumentUUIDField({required:!0,nullable:!1,initial:void 0}))}),selfEffect:new fields$7.SchemaField({uuid:new fields$7.DocumentUUIDField({required:!0,nullable:!1,initial:void 0}),name:new fields$7.StringField({required:!0,nullable:!1,initial:void 0})},{required:!1,nullable:!0,initial:void 0}),location:new fields$7.StringField({required:!0,nullable:!0,blank:!1,initial:null})}}prepareBaseData(){super.prepareBaseData(),this.maxTakable??=1/0,this.frequency??=null,this.selfEffect??=null,this.actor&&this.frequency&&(this.frequency.value??=this.frequency.max),this.traits.toggles??=new AbilityTraitToggles({},{parent:this});const subfeatures=this.subfeatures;subfeatures.keyOptions??=[],subfeatures.languages??={slots:0,granted:[]},subfeatures.senses??={},subfeatures.suppressedFeatures??=[]}prepareDerivedData(){this.traits.toggles.prepareData()}}const fields$6=foundry.data.fields;class HeritageSystemData extends ItemSystemModel{static{__name(this,"HeritageSystemData")}static{__name2(this,"HeritageSystemData")}static defineSchema(){const creatureTraits2=CONFIG.PF2E.creatureTraits;return{...super.defineSchema(),traits:new fields$6.SchemaField({otherTags:new fields$6.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0})),value:new LaxArrayField(new fields$6.StringField({required:!0,nullable:!1,choices:creatureTraits2,initial:void 0})),rarity:new RarityField}),ancestry:new fields$6.SchemaField({name:new fields$6.StringField({required:!0,nullable:!1,blank:!0}),slug:new SlugField({required:!0,nullable:!1}),uuid:new fields$6.DocumentUUIDField({required:!0,nullable:!1})},{required:!0,nullable:!0,initial:null})}}}const fields$5=foundry.data.fields;class PriceField extends fields$5.SchemaField{static{__name(this,"PriceField")}static{__name2(this,"PriceField")}constructor(){const denominationField=__name2(()=>new fields$5.NumberField({required:!1,nullable:!1,integer:!0,min:0}),"denominationField");super({value:new PrunedSchemaField(t$9(COIN_DENOMINATIONS.toReversed(),d=>[d,denominationField()]),{required:!0,nullable:!1}),per:new fields$5.NumberField({required:!0,nullable:!1,integer:!0,positive:!0,initial:1}),sizeSensitive:new fields$5.BooleanField({required:!1,nullable:!1,initial:void 0})})}initialize(source2){const initialized=super.initialize(source2);return initialized.value=new Coins(initialized.value),initialized.sizeSensitive??=!1,initialized}}const fields$4=foundry.data.fields;class KitEntriesField extends RecordField{static{__name(this,"KitEntriesField")}static{__name2(this,"KitEntriesField")}constructor(depth=0){const hasNestedItems=depth<=2,valueSchemaData=__name2(()=>({uuid:new fields$4.DocumentUUIDField({required:!0,nullable:!1,initial:void 0}),img:new fields$4.FilePathField({categories:["IMAGE"],base64:!1,required:!0,nullable:!1,initial:void 0}),quantity:new fields$4.NumberField({required:!0,integer:!0,positive:!0,nullable:!1,initial:void 0}),name:new fields$4.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),isContainer:new fields$4.BooleanField({required:!0,nullable:!1,initial:void 0}),items:hasNestedItems?new KitEntriesField(depth+1):new NullField}),"valueSchemaData");super(new fields$4.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),new fields$4.SchemaField(valueSchemaData(),{required:!0,nullable:!1,initial:void 0}))}}class KitSystemData extends ItemSystemModel{static{__name(this,"KitSystemData")}static{__name2(this,"KitSystemData")}static defineSchema(){const fields2=foundry.data.fields,traitChoices={...CONFIG.PF2E.classTraits};return{...super.defineSchema(),traits:new fields2.SchemaField({otherTags:new fields2.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0})),value:new fields2.ArrayField(new fields2.StringField({required:!0,nullable:!1,choices:traitChoices,initial:void 0}))}),items:new KitEntriesField,price:new PriceField}}}const fields$3=foundry.data.fields;class MeleeSystemData extends ItemSystemModel{static{__name(this,"MeleeSystemData")}static{__name2(this,"MeleeSystemData")}static LOCALIZATION_PREFIXES=[...super.LOCALIZATION_PREFIXES,"PF2E.Item.NPCAttack"];static defineSchema(){const traitChoices=CONFIG.PF2E.npcAttackTraits;return{...super.defineSchema(),traits:new fields$3.SchemaField({otherTags:new fields$3.ArrayField(new SlugField({required:!0,nullable:!1,initial:void 0})),value:new LaxArrayField(new fields$3.StringField({required:!0,nullable:!1,choices:traitChoices,initial:void 0}))}),action:new fields$3.StringField({choices:NPC_ATTACK_ACTIONS,required:!0,nullable:!1,initial:"strike"}),area:new fields$3.SchemaField({type:new fields$3.StringField({choices:EFFECT_AREA_SHAPES,required:!0,nullable:!1,initial:"burst"}),value:new fields$3.NumberField({min:5,max:50,step:5,required:!0,nullable:!1,initial:5})},{required:!0,nullable:!0,initial:null}),damageRolls:new RecordField(new fields$3.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),new fields$3.SchemaField({damage:new fields$3.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}),damageType:new fields$3.StringField({required:!0,nullable:!1,initial:"bludgeoning",choices:CONFIG.PF2E.damageTypes}),category:new fields$3.StringField({required:!0,nullable:!0,initial:null,choices:damageCategoriesUnique})})),bonus:new fields$3.SchemaField({value:new fields$3.NumberField({required:!0,nullable:!1,integer:!0,initial:0})}),attackEffects:new fields$3.SchemaField({value:new fields$3.ArrayField(new fields$3.StringField({required:!0,nullable:!1,blank:!1,initial:void 0}))}),range:new fields$3.SchemaField({increment:new fields$3.NumberField({required:!0,integer:!0,min:5,step:5,max:500,nullable:!0,initial:null}),max:new fields$3.NumberField({required:!0,integer:!0,min:5,step:5,max:500,nullable:!0,initial:null})},{required:!0,nullable:!0,initial:null})}}prepareBaseData(){super.prepareBaseData(),this.action!=="strike"&&(this.area??={type:"burst",value:5}),this.material={type:null,grade:null,effects:[]},this.runes={property:[]};for(const attackDamage of Object.values(this.damageRolls))attackDamage.damageType==="bleed"&&(attackDamage.category="persistent")}static migrateData(source2){const migrated=super.migrateData(source2);if(!e$2(migrated.traits)||!Array.isArray(migrated.traits.value))return migrated;const rangeData=getLegacyRangeData(migrated.traits.value);return rangeData&&(migrated.range??={increment:rangeData.increment,max:rangeData.max},migrated.traits.value=migrated.traits.value.filter(t2=>!/^(?:range-increment|range)-\d+$/.test(t2))),migrated}}const TREASURE_CATEGORIES=Object.freeze(["art-object","coin","gem","material","credstick"]),fields$2=foundry.data.fields;class TreasureSystemData extends ItemSystemModel{static{__name(this,"TreasureSystemData")}static{__name2(this,"TreasureSystemData")}static LOCALIZATION_PREFIXES=[...super.LOCALIZATION_PREFIXES,"PF2E.Item.Treasure"];static defineSchema(){const unidentifiedImg="systems/pf2e/icons/unidentified_item_icons/adventuring_gear.webp";return{...super.defineSchema(),baseItem:new fields$2.StringField({required:!0,nullable:!0,blank:!1}),bulk:new fields$2.SchemaField({value:new fields$2.NumberField({required:!0,nullable:!1,min:0,max:1e3,initial:.1,validate:__name2(v=>typeof v=="number"&&(v===.1||Number.isInteger(v)),"validate")})}),category:new fields$2.StringField({required:!0,nullable:!0,choices:TREASURE_CATEGORIES}),containerId:new fields$2.StringField({required:!0,nullable:!0,blank:!1,validate:__name2(v=>typeof v=="string"&&foundry.data.validators.isValidId(v),"validate")}),equipped:new fields$2.SchemaField({carryType:new fields$2.StringField({required:!0,nullable:!1,choices:ITEM_CARRY_TYPES,initial:"worn"})}),hardness:new fields$2.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:0}),hp:new fields$2.SchemaField({max:new fields$2.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:0}),value:new fields$2.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:0})}),identification:new fields$2.SchemaField({status:new fields$2.StringField({required:!0,nullable:!1,choices:["identified","unidentified"],initial:"identified"}),unidentified:new fields$2.SchemaField({img:new fields$2.FilePathField({required:!0,categories:["IMAGE"],nullable:!1,initial:unidentifiedImg}),name:new fields$2.StringField({required:!0,nullable:!1}),data:new fields$2.SchemaField({description:new fields$2.SchemaField({value:new fields$2.HTMLField})})},{required:!0,nullable:!0})}),level:new fields$2.SchemaField({value:new fields$2.NumberField({required:!0,nullable:!1,integer:!0,min:0,max:30,initial:0})}),material:new fields$2.SchemaField({type:new fields$2.StringField({required:!0,nullable:!0,choices:PRECIOUS_MATERIAL_TYPES.values().toArray()}),grade:new fields$2.StringField({required:!0,nullable:!0,choices:["low","standard","high"]})}),price:new PriceField,quantity:new fields$2.NumberField({required:!0,nullable:!1,integer:!0,min:0,initial:1}),size:new fields$2.StringField({required:!0,choices:["tiny","med","lg","huge","grg"],initial:"med"}),temporary:new fields$2.BooleanField({required:!1}),traits:new fields$2.SchemaField({value:new LaxArrayField(new fields$2.StringField({required:!0,choices:["precious"]})),rarity:new RarityField,otherTags:new fields$2.ArrayField(new SlugField({required:!0,initial:void 0}))})}}static migrateData(source2){const migrated=super.migrateData(source2);return migrated.size==="sm"&&(migrated.size="med"),migrated.stackGroup==="coins"?migrated.category="coin":migrated.stackGroup==="gems"&&(migrated.category="gem"),migrated}get stackGroup(){if(this.slug==="upb")return"upb";switch(this.category){case"coin":return"coins";case"gem":return"gems";default:return null}}prepareBaseData(){super.prepareBaseData(),this.price.sizeSensitive=!1,this.category==="coin"&&(this.size="med")}}class DoorControlPF2e extends foundry.canvas.containers.DoorControl{static{__name(this,"DoorControlPF2e")}static{__name2(this,"DoorControlPF2e")}_onMouseDown(event2){const wallDoc=this.wall.document,requiresReach=game.pf2e.settings.automation.reachEnforcement.has("doors");if(event2.button!==0||!requiresReach||wallDoc.isOwner||!game.user.can("WALL_DOORS")||game.paused)return super._onMouseDown(event2);const testPoints=[{x:wallDoc.c[0],y:wallDoc.c[1]},{x:wallDoc.c[2],y:wallDoc.c[3]},this.center];if(n([canvas.tokens.controlled,game.user.character?.getActiveTokens(!0,!1)??[]].flat()).some(token=>{const actor=token.actor;if(!actor?.isOwner||!actor.isOfType("creature","party"))return!1;const reach=actor.system.attributes.reach,manipulate=Math.max(reach.manipulate,5);return testPoints.some(p=>token.distanceTo(p)<=manipulate)}))return super._onMouseDown(event2);ui.notifications.warn("PF2E.Wall.Door.OutOfReach",{localize:!0})}}class EnvironmentCanvasGroupPF2e extends foundry.canvas.groups.EnvironmentCanvasGroup{static{__name(this,"EnvironmentCanvasGroupPF2e")}static{__name2(this,"EnvironmentCanvasGroupPF2e")}initialize(config={}){const scene=game.scenes.viewed;return scene&&(config.environment=foundry.utils.mergeObject(config.environment??{},{globalLight:t$3(scene.environment.globalLight,["enabled","darkness"])})),super.initialize(config)}}class TerrainDataPF2e extends foundry.data.TerrainData{static{__name(this,"TerrainDataPF2e")}static{__name2(this,"TerrainDataPF2e")}static getMovementCostFunction(token,options){return canvas.grid.isSquare?(_from,_to,distance,segment)=>{if(segment.teleport)return 0;const difficulty=Math.clamp(Math.trunc(segment.terrain?.difficulty??1),1,3);if(difficulty===1)return distance;const addend=(difficulty-1)*canvas.grid.distance,multiplier=this.#getMitigationMultiplier(token.actor,difficulty);return distance+addend*multiplier}:super.getMovementCostFunction(token,options)}static#getMitigationMultiplier(actor,difficulty){const mitigationFeatures=actor?.isOfType("creature")?actor.system.movement.terrain:null;if(!mitigationFeatures)return 1;const ignoreAllDifficult=mitigationFeatures.difficult.ignored.some(i=>i.environment==="all"&&i.feature==="all");switch(difficulty){case 3:return mitigationFeatures.greater.ignored.some(i=>i.environment==="all"&&i.feature==="all")?0:ignoreAllDifficult?.5:1;default:return ignoreAllDifficult?0:1}}}class TokenRulerPF2e extends foundry.canvas.placeables.tokens.TokenRuler{static{__name(this,"TokenRulerPF2e")}static{__name2(this,"TokenRulerPF2e")}static WAYPOINT_LABEL_TEMPLATE="systems/pf2e/templates/scene/token/ruler/waypoint-label.hbs";static ACTION_MARKER_TEMPLATE="systems/pf2e/templates/scene/token/ruler/action-marker.hbs";static#hudContainerObserver=new MutationObserver(()=>{TokenRulerPF2e.#counterAlign()});static observeHudContainer(){TokenRulerPF2e.#hudContainerObserver.disconnect(),TokenRulerPF2e.#hudContainerObserver.observe(canvas.hud.element,{attributes:!0}),TokenRulerPF2e.#counterAlign()}#renderedPath=null;#glyphMarkedPoints=[];#labelsObserver=null;get#labelsEl(){return document.getElementById(`token-ruler-${this.token.document.id}`)}static#counterAlign(){document.getElementById("measurement")?.style?.setProperty("--counter-scale",(1/canvas.stage.scale.x).toFixed(4))}async draw(){if(await super.draw(),!canvas.grid.isSquare)return;const path=canvas.tokens._rulerPaths.children.at(-1);this.#renderedPath=path instanceof PIXI.Graphics?path:null,await foundry.applications.handlebars.getTemplate(TokenRulerPF2e.ACTION_MARKER_TEMPLATE)}clear(){super.clear(),this.#glyphMarkedPoints.length=0}destroy(){super.destroy(),this.#glyphMarkedPoints.length=0,this.#labelsObserver?.disconnect(),this.#labelsObserver=null}refresh(rulerData){if(!canvas.grid.isSquare)return super.refresh(rulerData);if(this.#glyphMarkedPoints.length=0,super.refresh(rulerData),canvas.ready&&canvas.grid.isSquare){const labelsEl=this.#labelsEl;delete labelsEl?.dataset.glyphMarked,labelsEl&&!this.#labelsObserver&&(this.#labelsObserver=new MutationObserver(()=>{"glyphMarked"in labelsEl.dataset||this.#renderActionGlyphs()}),this.#labelsObserver.observe(labelsEl,{childList:!0}))}}#getSpeed(rulerAction){const actor=this.token.actor;if(!actor?.isOwner&&actor?.alliance!=="party")return null;if(actor.isOfType("creature")){const speeds=actor.system.movement.speeds;switch(rulerAction){case"walk":return speeds.land.value;case"crawl":return speeds.land.crawl;case"step":return speeds.land.step;default:return tupleHasValue(MOVEMENT_TYPES,rulerAction)?speeds[rulerAction]?.value??null:null}}return actor.isOfType("vehicle")?actor.system.movement.speeds.drive.value:null}_getWaypointLabelContext(waypoint,state2){if(waypoint.action==="displace")return;const context=super._getWaypointLabelContext(waypoint,state2);if(!context||!canvas.grid.isSquare)return context;const speed=this.#getSpeed(waypoint.action);if(!speed)return context;const measurement=waypoint.measurement,accruedCost=measurement.cost,deltaDistance=measurement.backward?.distance??0;if(context.cost.additional={total:Math.max(0,measurement.cost-measurement.distance),delta:Math.max(0,waypoint.cost-deltaDistance)},accruedCost>0&&(!waypoint.next||accruedCost%speed===0)){const actionsSpent=Math.ceil(accruedCost/speed),clampedCost=Math.clamp(actionsSpent,1,3);context.actionCost={actions:clampedCost,overage:actionsSpent>3}}return context}_getGridHighlightStyle(waypoint,offset){return this.#logGlyphMarkedPoint(waypoint),super._getGridHighlightStyle(waypoint,offset)}#logGlyphMarkedPoint(waypoint){if(!this.#renderedPath||!waypoint.intermediate||waypoint.hidden||waypoint.cost===0)return;const speed=this.#getSpeed(waypoint.action);if(!speed)return;const measurement=waypoint.measurement,remainder=measurement.cost%speed,markedPoints=this.#glyphMarkedPoints,tokenRect=t$3(waypoint,["x","y","width","height"]),squareLength=canvas.grid.distance,nextCost=measurement.forward?.cost??0;if(remainder===0)markedPoints.push(Object.assign(tokenRect,{actionsSpent:measurement.cost/speed}));else if([speed-nextCost,speed-(nextCost-squareLength)].includes(remainder)){const totalCost=measurement.cost+nextCost,actionsSpent=Math.floor(totalCost/speed);totalCost%speed!==0&&markedPoints.push(Object.assign(tokenRect,{actionsSpent}))}}async#renderActionGlyphs(){const labelsEl=this.#labelsEl;if(!labelsEl)return;labelsEl.dataset.glyphMarked="";const templatePath=TokenRulerPF2e.ACTION_MARKER_TEMPLATE;for(const point of this.#glyphMarkedPoints){const cost=Math.clamp(point.actionsSpent,1,3),overage=point.actionsSpent-cost>0,html2=await foundry.applications.handlebars.renderTemplate(templatePath,{cost,overage}),element=foundry.utils.parseHTML(html2),topLeft=canvas.grid.getTopLeftPoint(point);element.style.setProperty("--position-x",`${Math.round(topLeft.x)}px`),element.style.setProperty("--position-y",`${Math.round(topLeft.y)}px`),element.style.setProperty("--ui-scale",canvas.dimensions.uiScale.toString()),labelsEl.append(element)}}}class ActorsPF2e extends foundry.documents.collections.Actors{static{__name(this,"ActorsPF2e")}static{__name2(this,"ActorsPF2e")}get party(){const activePartyId=game.settings.get("pf2e","activeParty"),actor=this.get(activePartyId);return actor?.isOfType("party")?actor:this.find(a=>a.isOfType("party"))??null}_initialize(){super._initialize();const familiars=[],parties=[];for(const actor of this.values())actor.isOfType("familiar")?familiars.push(actor):actor.isOfType("party")&&parties.push(actor);for(const actor of[...familiars,...parties])this.delete(actor.id),this.set(actor.id,actor)}_getVisibleTreeContents(){return super._getVisibleTreeContents().filter(a=>a.isOfType("creature")&&!a.parties.size||!a.isOfType("party","creature"))}}const fields$1=foundry.data.fields,regionBehaviors=foundry.data.regionBehaviors;class DifficultTerrainBehaviorType extends regionBehaviors.ModifyMovementCostRegionBehaviorType{static{__name(this,"DifficultTerrainBehaviorType")}static{__name2(this,"DifficultTerrainBehaviorType")}static defineSchema(){const movementTypes=Object.keys(super.defineSchema().difficulties.fields),numberFields=t$9(movementTypes,t2=>[t2,new fields$1.NumberField({required:!0,nullable:!0,choices:{1:"",2:"PF2E.Region.DifficultTerrain.DifficultTerrain",3:"PF2E.Region.DifficultTerrain.GreaterDifficultTerrain"},initial:1,label:CONFIG.Token.movement.actions[t2].label})]);return{difficulties:new fields$1.SchemaField(numberFields)}}static migrateData(source2){const migrated=super.migrateData(source2);if(!e$2(migrated.difficulties))return migrated;for(const[key,value]of Object.entries(migrated.difficulties))migrated.difficulties[key]=Math.clamp(Math.trunc(Number(value))||1,1,3);return migrated}}function monkeyPatchFoundry(){foundry.prosemirror.ProseMirrorMenu.prototype._isMarkActive=isMarkActive,foundry.prosemirror.ProseMirrorMenu.prototype._isNodeActive=isNodeActive,foundry.prosemirror.ProseMirrorMenu.prototype._toggleTextBlock=toggleTextBlock}__name(monkeyPatchFoundry,"monkeyPatchFoundry"),__name2(monkeyPatchFoundry,"monkeyPatchFoundry");const superIsMarkActive=foundry.prosemirror.ProseMirrorMenu.prototype._isMarkActive,superIsNodeActive=foundry.prosemirror.ProseMirrorMenu.prototype._isNodeActive;function isMarkActive(item){item.action.startsWith("pf2e-")||superIsMarkActive.call(this,item);const state2=this.view.state,{from,$from,to,empty}=state2.selection,markCompare=__name2(mark=>mark.type!==item.mark?!1:item.attrs?foundry.utils.objectsEqual(mark.attrs,item.attrs):!0,"markCompare");if(empty)return $from.marks().some(markCompare);let active=!1;return state2.doc.nodesBetween(from,to,node=>(node.marks.some(markCompare)&&(active=!0),!active)),active}__name(isMarkActive,"isMarkActive"),__name2(isMarkActive,"isMarkActive");function isNodeActive(item){if(!item.action.startsWith("pf2e-"))return superIsNodeActive.call(this,item);const state2=this.view.state,{$from,$to,empty}=state2.selection;return empty||$from.sameParent($to)?state2.doc.nodeAt($from.pos)?.type===item.node||hasAncestor($from,item.node,item.attrs):!1}__name(isNodeActive,"isNodeActive"),__name2(isNodeActive,"isNodeActive");function toggleTextBlock(node,options){const state2=this.view.state,{$from,$to}=state2.selection,range=$from.blockRange($to);if(!range)return;const attrs=options?.attrs??null;hasAncestor($from,node,attrs)&&(node=this.schema.nodes.paragraph,e$2(attrs?._preserve)&&attrs._preserve?.class&&delete attrs._preserve),this.view.dispatch(state2.tr.setBlockType(range.start,range.end,node,attrs))}__name(toggleTextBlock,"toggleTextBlock"),__name2(toggleTextBlock,"toggleTextBlock");function hasAncestor(pos,other,attrs){if(!pos.depth||!other)return!1;for(let i=pos.depth;i>0;i--){const node=pos.node(i);if(node.type===other)return attrs?foundry.utils.objectsEqual(node.attrs,attrs):!0}return!1}__name(hasAncestor,"hasAncestor"),__name2(hasAncestor,"hasAncestor");class ClientDatabaseBackendPF2e extends foundry.data.ClientDatabaseBackend{static{__name(this,"ClientDatabaseBackendPF2e")}static{__name2(this,"ClientDatabaseBackendPF2e")}async _getDocuments(documentClass,operation,user){const type2=documentClass.documentName;if(!["Actor","Item"].includes(type2)||operation.index||operation.parent||operation.pack?.startsWith("pf2e."))return super._getDocuments(documentClass,operation,user);const request2={action:"get",type:type2,operation},response=new foundry.abstract.DocumentSocketResponse(await foundry.helpers.SocketInterface.dispatch("modifyDocument",request2));return Promise.all(response.result.filter(d=>e$2(d)).map(async data=>{e$2(data._stats??={})&&operation.pack&&(data._stats.compendiumSource=`Compendium.${operation.pack}.${type2}.${data._id}`);const document2=documentClass.fromSource(data,{pack:operation.pack}),migrations=MigrationList.constructFromVersion(document2.schemaVersion);if(migrations.length>0)try{await MigrationRunner.ensureSchemaVersion(document2,migrations)}catch(error){error instanceof Error&&console.error(error.message)}return document2}))}}class Load{static{__name(this,"Load")}static{__name2(this,"Load")}static listen(){CONFIG.DatabaseBackend=new ClientDatabaseBackendPF2e,CONFIG.ActiveEffect.documentClass=ActiveEffectPF2e,CONFIG.Actor.collection=ActorsPF2e,CONFIG.Actor.defaultType="character",CONFIG.Actor.documentClass=ActorProxyPF2e,CONFIG.AmbientLight.documentClass=AmbientLightDocumentPF2e,CONFIG.AmbientLight.objectClass=AmbientLightPF2e,CONFIG.ChatMessage.documentClass=ChatMessagePF2e,CONFIG.Combat.documentClass=EncounterPF2e,CONFIG.Combatant.documentClass=CombatantPF2e,CONFIG.Item.defaultType="action",CONFIG.Item.documentClass=ItemProxyPF2e,CONFIG.Macro.documentClass=MacroPF2e,CONFIG.MeasuredTemplate.defaults.angle=90,CONFIG.MeasuredTemplate.defaults.width=1,CONFIG.MeasuredTemplate.documentClass=MeasuredTemplateDocumentPF2e,CONFIG.MeasuredTemplate.objectClass=MeasuredTemplatePF2e,CONFIG.Region.documentClass=RegionDocumentPF2e,CONFIG.Region.objectClass=RegionPF2e,CONFIG.RegionBehavior.dataModels.environment=EnvironmentBehaviorType,CONFIG.RegionBehavior.dataModels.environmentFeature=EnvironmentFeatureBehaviorType,CONFIG.RegionBehavior.dataModels.modifyMovementCost=DifficultTerrainBehaviorType,CONFIG.RegionBehavior.documentClass=RegionBehaviorPF2e,CONFIG.RegionBehavior.typeIcons.environment="fa-solid fa-mountain-sun",CONFIG.RegionBehavior.typeIcons.environmentFeature="fa-solid fa-wind",CONFIG.RegionBehavior.typeLabels.environment="PF2E.Region.Environment.Label",CONFIG.RegionBehavior.typeLabels.environmentFeature="PF2E.Region.EnvironmentFeature.Label",CONFIG.Scene.documentClass=ScenePF2e,CONFIG.Tile.documentClass=TileDocumentPF2e,CONFIG.Token.documentClass=TokenDocumentPF2e,CONFIG.Token.movement.TerrainData=TerrainDataPF2e,CONFIG.Token.objectClass=TokenPF2e,CONFIG.Token.prototypeSheetClass=PrototypeTokenConfigPF2e,CONFIG.Token.rulerClass=TokenRulerPF2e,Load.#configureMovement(),CONFIG.User.documentClass=UserPF2e,CONFIG.Actor.dataModels.army=ArmySystemData,CONFIG.Actor.dataModels.familiar=FamiliarSystemData,CONFIG.Actor.dataModels.hazard=HazardSystemData,CONFIG.Actor.dataModels.loot=LootSystemData,CONFIG.Actor.dataModels.party=PartySystemData,CONFIG.Actor.dataModels.vehicle=VehicleSystemData,CONFIG.Item.dataModels.action=AbilitySystemData,CONFIG.Item.dataModels.campaignFeature=CampaignFeatureSystemData,CONFIG.Item.dataModels.class=ClassSystemData,CONFIG.Item.dataModels.condition=ConditionSystemData,CONFIG.Item.dataModels.effect=EffectSystemData,CONFIG.Item.dataModels.feat=FeatSystemData,CONFIG.Item.dataModels.heritage=HeritageSystemData,CONFIG.Item.dataModels.kit=KitSystemData,CONFIG.Item.dataModels.melee=MeleeSystemData,CONFIG.Item.dataModels.treasure=TreasureSystemData,CONFIG.Canvas.doorControlClass=DoorControlPF2e,CONFIG.Canvas.exploredColor=2500134,CONFIG.Canvas.groups.effects.groupClass=EffectsCanvasGroupPF2e,CONFIG.Canvas.groups.environment.groupClass=EnvironmentCanvasGroupPF2e,CONFIG.Canvas.layers.lighting.layerClass=LightingLayerPF2e,CONFIG.Canvas.layers.templates.layerClass=TemplateLayerPF2e,CONFIG.Canvas.layers.tokens.layerClass=TokenLayerPF2e,CONFIG.Canvas.rulerClass=RulerPF2e,CONFIG.Dice.rolls.push(CheckRoll,StrikeAttackRoll,DamageRoll,DamageInstance);for(const TermCls of[ArithmeticExpression,Grouping,InstancePool,IntermediateDie])CONFIG.Dice.termTypes[TermCls.name]=TermCls;Math.btwn=(v,gte,lte)=>v>=gte&&v<=lte,Math.eq=(a,b)=>a===b,Math.gt=(a,b)=>a>b,Math.gte=(a,b)=>a>=b,Math.lt=(a,b)=>a<b,Math.lte=(a,b)=>a<=b,Math.ne=(a,b)=>a!==b,Math.ternary=(condition,ifTrue,ifFalse)=>condition?ifTrue:ifFalse,Math.match=(...args)=>args.find(a=>a!==null)??0,Math.when=(condition,then)=>condition?then:null,CONFIG.queries["pf2e.trade"]=TradeDialog.handleQuery,Actor.DEFAULT_ICON="systems/pf2e/icons/default-icons/mystery-man.svg",CONFIG.Actor.typeIcons={familiar:"fa-solid fa-cat",hazard:"fa-solid fa-hill-rockslide",loot:"fa-solid fa-treasure-chest"},CONFIG.Item.typeIcons={action:"fa-solid fa-person-running-fast",affliction:"fa-solid fa-biohazard",ancestry:"fa-solid fa-person-fairy",armor:"fa-solid fa-shirt-long-sleeve",background:"fa-solid fa-baby",backpack:"fa-solid fa-sack",book:"fa-solid fa-book",class:"fa-solid fa-user-beard-bolt",condition:"fa-solid fa-face-zany",consumable:"fa-solid fa-flask-round-potion",deity:"fa-solid fa-hamsa",effect:"fa-solid fa-person-rays",equipment:"fa-solid fa-hat-cowboy",feat:"fa-solid fa-medal",heritage:"fa-solid fa-wreath-laurel",shield:"fa-solid fa-shield-halved",spell:"fa-solid fa-sparkles",treasure:"fa-solid fa-gem",weapon:"fa-solid fa-sword"},window.AutomaticBonusProgression=AutomaticBonusProgression$1,window.customElements.define(HTMLTagifyTagsElement.tagName,HTMLTagifyTagsElement),monkeyPatchFoundry(),document.addEventListener("mouseup",()=>{const element=document.activeElement;element instanceof HTMLButtonElement&&!element.classList.contains("pm-dropdown")&&element.blur()}),this.#initializeHotReload()}static#configureMovement(){const movementActions=CONFIG.Token.movement.actions;for(const key of["crawl","climb","jump"])delete movementActions[key]?.getCostFunction;movementActions.walk.canSelect=token=>{const actor=token.actor;return!!actor?.isOfType("creature")&&!actor.hasCondition("prone")},movementActions.walk.img=null,movementActions.crawl.canSelect=token=>{const actor=token.actor;return!!actor?.isOfType("creature")&&actor.hasCondition("prone")},movementActions.drive={label:"TOKEN.MOVEMENT.ACTIONS.drive.label",icon:"fa-solid fa-car-side",order:0,canSelect:__name2(t2=>t2.actor?.type==="vhiecle","canSelect"),deriveTerrainDifficulty:__name2(()=>1,"deriveTerrainDifficulty")},movementActions.deploy={label:"TOKEN.MOVEMENT.ACTIONS.deploy.label",icon:"fa-solid fa-person-military-pointing fa-flip-horizontal",order:0,canSelect:__name2(t2=>t2.actor?.type==="army","canSelect")},movementActions.jump.order=1,movementActions.jump.canSelect=tokenDoc=>{const actor=tokenDoc.actor;return!!(actor?.isOfType("creature")&&!actor.hasCondition("prone"))},movementActions.jump.deriveTerrainDifficulty=()=>1,movementActions.fly.order=2,movementActions.fly.canSelect=tokenDoc=>{const actor=tokenDoc.actor;return!!(actor?.isOfType("creature")&&actor.system.movement.speeds.fly)},movementActions.burrow.order=3,movementActions.burrow.canSelect=tokenDoc=>{const actor=tokenDoc.actor;return!!(actor?.isOfType("creature")&&actor.system.movement.speeds.burrow)},movementActions.climb.order=4,movementActions.climb.canSelect=tokenDoc=>!!tokenDoc.actor?.isOfType("creature"),movementActions.climb.deriveTerrainDifficulty=()=>1,movementActions.swim.order=5,movementActions.swim.canSelect=tokenDoc=>!!tokenDoc.actor?.isOfType("creature"),movementActions.travel={order:0,icon:"fa-solid fa-person-hiking",label:"TOKEN.MOVEMENT.ACTIONS.travel.label",canSelect:__name2(tokenDoc=>{const actor=tokenDoc.actor;return actor?actor.isOfType("party")||actor.isOfType("creature")&&!actor.inCombat:!1},"canSelect")},movementActions.blink.order=6}static#initializeHotReload(){}}async function createFirstParty(){game.user!==game.users.activeGM||game.settings.get("pf2e","createdFirstParty")||(game.actors.some(a=>a.isOfType("party"))||(await ActorPF2e.create({_id:CONFIG.PF2E.defaultPartyId,type:"party",name:game.i18n.localize("PF2E.Actor.Party.DefaultName")},{keepId:!0}),await game.settings.set("pf2e","activeParty",CONFIG.PF2E.defaultPartyId)),await game.settings.set("pf2e","createdFirstParty",!0))}__name(createFirstParty,"createFirstParty"),__name2(createFirstParty,"createFirstParty");const appv1$5=foundry.appv1;class MigrationSummary extends appv1$5.api.Application{static{__name(this,"MigrationSummary")}static{__name2(this,"MigrationSummary")}#isRemigrating=!1;constructor(options={}){super(options),this.options.troubleshoot??=!1,this.options.title=options.troubleshoot?game.i18n.localize("PF2E.Migrations.Summary.Troubleshoot.Title"):game.i18n.localize("PF2E.Migrations.Summary.Title");const existing=Object.values(ui.windows).find(app=>app instanceof MigrationSummary);if(existing)return existing.options=foundry.utils.mergeObject(existing.options,options),existing}static get defaultOptions(){return{...super.defaultOptions,id:"migration-summary",width:400,height:"auto",template:"systems/pf2e/templates/system/migration-summary.hbs"}}async getData(){const latestSchemaVersion=MigrationRunner.LATEST_SCHEMA_VERSION,actors={successful:game.actors.filter(actor=>actor.schemaVersion===latestSchemaVersion).length,total:game.actors.size},items={successful:game.items.filter(item=>item.schemaVersion===latestSchemaVersion).length,total:game.items.size},canRemigrate=this.options.troubleshoot||actors.successful<actors.total||items.successful<items.total,helpResourcesText=await TextEditorPF2e.enrichHTML(game.i18n.localize("PF2E.Migrations.Summary.HelpResources"));return{options:this.options,systemVersion:game.system.version,latestSchemaVersion,actors,items,canRemigrate,helpResources:canRemigrate&&this.#isRemigrating,helpResourcesText}}activateListeners($html){super.activateListeners($html);const html2=$html[0],remigrateButton=html2.querySelector("button[data-action=remigrate]");remigrateButton?.addEventListener("click",async()=>{const{LATEST_SCHEMA_VERSION,RECOMMENDED_SAFE_VERSION}=MigrationRunner,lowestVersions={actor:game.actors.size>0?Math.min(...game.actors.map(a=>a.schemaVersion??0)):LATEST_SCHEMA_VERSION,item:game.items.size>0?Math.min(...game.items.map(a=>a.schemaVersion??0)):LATEST_SCHEMA_VERSION},lowestSchemaVersion=Math.max(Math.min(lowestVersions.actor,lowestVersions.item),RECOMMENDED_SAFE_VERSION),result=html2.querySelector(".docs-successful");result&&(result.textContent="...");try{this.#isRemigrating=!0,this.options.troubleshoot=!1,remigrateButton.disabled=!0,await game.pf2e.system.remigrate({from:lowestSchemaVersion}),this.options.troubleshoot=!1,this.render(!1)}catch{return}}),html2.querySelector("button[data-action=close]")?.addEventListener("click",()=>{this.close()})}}function activateSocketListener(){game.socket.on("system.pf2e",async(...[message,userId])=>{const sender=game.users.get(userId,{strict:!0});switch(message.request){case"itemTransfer":game.user.isGM&&(console.debug(`PF2e System | Received item-transfer request from ${sender.name}`),new ItemTransfer(message.data).enact(sender));break;case"refreshSceneControls":!game.user.isGM&&message.data.layer===ui.controls.control?.name&&(console.debug("PF2e System | Refreshing Scene Controls"),ui.controls.render());break;case"showSheet":{const document2=await fromUuid(message.document);if(!sender.isGM||!document2?.sheet)return;const{tab,campaign}=message.options??{};if(campaign){if(!(document2 instanceof PartyPF2e))return;const type2=campaign===!0?null:campaign;return document2.campaign?.renderSheet?.({tab,type:type2})}document2.sheet.render(!0,{tab});break}default:throw ErrorPF2e(`Received unrecognized socket emission: ${message.request}`)}})}__name(activateSocketListener,"activateSocketListener"),__name2(activateSocketListener,"activateSocketListener");async function storeInitialWorldVersions(){if(!game.user.hasRole(CONST.USER_ROLES.GAMEMASTER))return;if(game.settings.storage.get("world").getItem("pf2e.worldSystemVersion")||await game.settings.set("pf2e","worldSystemVersion",game.system.version),!game.settings.storage.get("world").getItem("pf2e.worldSchemaVersion")){const minimumVersion=MigrationRunner.RECOMMENDED_SAFE_VERSION,currentVersion=game.actors.size===0?game.settings.get("pf2e","worldSchemaVersion"):Math.max(Math.min(...new Set(game.actors.map(actor=>actor.schemaVersion??minimumVersion))),minimumVersion);await game.settings.set("pf2e","worldSchemaVersion",currentVersion)}}__name(storeInitialWorldVersions,"storeInitialWorldVersions"),__name2(storeInitialWorldVersions,"storeInitialWorldVersions");function extendDragData(){document.body.addEventListener("dragstart",event2=>{const{dataTransfer,target:targetElement}=event2;if(dataTransfer&&targetElement instanceof HTMLAnchorElement){if(targetElement.classList.contains("inline-roll")&&"persistent"in targetElement.dataset&&targetElement.dataset.formula){const data={type:"PersistentDamage",formula:targetElement.dataset.formula};dataTransfer.setData("text/plain",JSON.stringify(data));return}if(targetElement.classList.contains("content-link")){const data=JSON.parse(dataTransfer.getData("text/plain"));if(data.type!=="Item")return;const match=targetElement.innerText.trim().match(/[0-9]+/);match&&(data.value=Number(match[0]));const{message,item:originItem,actor}=resolveActorAndItemFromHTML(targetElement),token=message?.token??actor?.token,containerElement=htmlClosest(targetElement,"[data-cast-rank]"),castRank=Number(containerElement?.dataset.castRank)||message?.flags.pf2e.origin?.castRank||0;if(castRank>0&&(data.level=castRank),actor){const roll=message?.rolls.at(-1),target=message?.target,spellcasting=originItem?.isOfType("spell")&&originItem.spellcasting?{attribute:{type:originItem.attribute,mod:originItem.spellcasting.statistic?.attributeModifier?.value??0},tradition:originItem.spellcasting.tradition}:null;data.context={origin:{actor:actor.uuid,token:token?.uuid??null,item:originItem?.uuid??null,spellcasting,rollOptions:message?.flags.pf2e.origin?.rollOptions??[]},target:target?{actor:target.actor.uuid,token:target.token.uuid}:null,roll:roll?{total:roll.total,degreeOfSuccess:roll instanceof CheckRoll?roll.degreeOfSuccess??null:null}:null}}dataTransfer.setData("text/plain",JSON.stringify(data))}}})}__name(extendDragData,"extendDragData"),__name2(extendDragData,"extendDragData");const Ready={listen:__name2(()=>{Hooks.once("ready",()=>{const blacklistedId=["pf2e-action-support-engine","pf2e-action-support-engine-macros"].find(id=>game.modules.get(id)?.active);if(blacklistedId){const message=`PF2E System halted: module "${blacklistedId}" is not supported.`;ui.notifications.error(message,{permanent:!0}),CONFIG.PF2E={},game.pf2e={};return}console.log("PF2e System | Starting Pathfinder 2nd Edition System"),console.debug("PF2e System | Build mode: production");const defaultGridSettings={gridTemplates:!1,coneTemplateType:"round"};for(const[key,value]of Object.entries(defaultGridSettings))game.settings.get("core",key)!==value&&game.settings.set("core",key,value);SetGamePF2e.onReady(),game.scenes.apps.push(SceneDarknessAdjuster.instance);const currentVersion=game.settings.get("pf2e","worldSchemaVersion");storeInitialWorldVersions().then(async()=>{if(game.user!==game.users.activeGM)return;await createFirstParty();const migrationRunner=new MigrationRunner(MigrationList.constructFromVersion(currentVersion));migrationRunner.needsMigration()&&(currentVersion&&currentVersion<MigrationRunner.MINIMUM_SAFE_VERSION&&ui.notifications.error("Your PF2E system data is from too old a Foundry version and cannot be reliably migrated to the latest version. The process will be attempted, but errors may occur.",{permanent:!0}),await migrationRunner.runMigration(),new MigrationSummary().render(!0));const previous=game.settings.get("pf2e","worldSystemVersion"),current=game.system.version;foundry.utils.isNewerVersion(current,previous)&&await game.settings.set("pf2e","worldSystemVersion",current);const abandonedModules=new Set(["pf2e-rules-based-npc-vision"]),subV11Modules=game.modules.filter(m=>m.active&&(m.esmodules.size>0||m.scripts.size>0)&&!!m.compatibility.verified&&(abandonedModules.has(m.id)||!foundry.utils.isNewerVersion(m.compatibility.verified,"10.312")));for(const badModule of subV11Modules){const message=game.i18n.format("PF2E.ErrorMessage.SubV9Module",{module:badModule.title});ui.notifications.warn(message)}}),game.settings.get("pf2e","homebrew.languageRarities").onReady(),activateSocketListener(),extendDragData(),canvas.ready&&game.user.isGM&&!game.modules.get("gm-vision")?.active&&game.pf2e.settings.gmVision&&(CONFIG.Canvas.darknessColor=CONFIG.PF2E.Canvas.darkness.gmVision,canvas.environment.initialize()),game.pf2e.system.moduleArt.refresh().then(()=>{game.modules.get("babele")?.active&&game.i18n.lang!=="en"?Hooks.once("babele.ready",()=>{ui.compendium.compileSearchIndex()}):ui.compendium.compileSearchIndex()});const inEnvironments=[],hasSceneEnvironments=!!game.scenes.viewed?.flags.pf2e.environmentTypes?.length;for(const token of game.scenes.active?.tokens??[]){const inEnvironmentRegion=!!token.regions?.some(r2=>r2.behaviors.some(b=>!b.disabled&&["environment","environmentFeature"].includes(b.type)));token.actor&&(hasSceneEnvironments||inEnvironmentRegion)&&inEnvironments.push(token.actor)}const actorsToReprepare=new Set([...game.combats.contents.flatMap(e2=>e2.combatants.contents).flatMap(c=>c.actor??[]),...inEnvironments.filter(a=>!a.isOfType("familiar","hazard","loot","party"))]);if(resetActors(actorsToReprepare,{sheets:!1,tokens:inEnvironments.length>0}),ui.actors.render({parts:["directory","parties"]}),game.user.isGM&&!game.settings.get("pf2e","seenRemasterJournalEntry")&&(fromUuid("Compendium.pf2e.journals.JournalEntry.6L2eweJuM8W7OCf2").then(entry=>{entry?.sheet.render(!0)}),game.settings.set("pf2e","seenRemasterJournalEntry",!0)),game.combat){for(const encounter of game.combats)encounter.reset();ui.combat.render()}const faDuotone=document.fonts.values().find?.(f=>f.family==="Font Awesome 6 Duotone");faDuotone?.status==="unloaded"&&faDuotone.load(),Sortable.mount(NoJQueryPlugin),Hooks.callAll("pf2e.systemReady")})},"listen")},RenderChatPopout={listen:__name2(()=>{Hooks.on("renderChatPopout",(app,_html,_context,options)=>{ChatLogPF2e.onRenderChatPopout(app,options)})},"listen")},RenderCombatTrackerConfig={listen:__name2(()=>{Hooks.on("renderCombatTrackerConfig",async(_app,html2)=>{const template=await(async()=>{const markup=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/sidebar/encounter-tracker/config.hbs",{values:{deathIcon:game.settings.get("pf2e","deathIcon"),actorsDeadAtZero:game.settings.get("pf2e","automation.actorsDeadAtZero"),deadAtZeroOptions:[{value:"both",label:"PF2E.SETTINGS.Automation.ActorsDeadAtZero.Both"},{value:"npcsOnly",label:"PF2E.SETTINGS.Automation.ActorsDeadAtZero.NPCsOnly"},{value:"neither",label:"PF2E.SETTINGS.Automation.ActorsDeadAtZero.Neither"}]}}),tempElem=document.createElement("div");return tempElem.innerHTML=markup,tempElem.firstElementChild instanceof HTMLTemplateElement?tempElem.firstElementChild:null})();htmlQueryAll(html2,".form-group").at(-1)?.after(...template?.content.children??[]),html2.addEventListener("submit",async()=>{const newIcon=htmlQuery(html2,"file-picker[name=deathIcon]")?.value,newDeadAtZero=htmlQuery(html2,"select[name=actorsDeadAtZero]")?.value;newIcon&&newIcon!==game.settings.get("pf2e","deathIcon")&&await game.settings.set("pf2e","deathIcon",newIcon);const currentDeadAtZero=game.settings.get("pf2e","automation.actorsDeadAtZero");newDeadAtZero&&currentDeadAtZero!==newDeadAtZero&&await game.settings.set("pf2e","automation.actorsDeadAtZero",newDeadAtZero)})})},"listen")},RenderDialog={listen:__name2(()=>{Hooks.on("renderDialogV2",(_dialog,html2)=>{if(html2.classList.contains("dialog")&&html2.classList.contains("item-create")){const select=html2.querySelector("select[name=type]"),option=select?.querySelector("option");if(select&&option){const localize=localizer("PF2E.Item.CreationDialog.Categories");select.append(extractOptGroup(select,localize("Physical"),[...PHYSICAL_ITEM_TYPES,"kit"])),select.append(extractOptGroup(select,localize("Character"),[...PC_ITEM_TYPES])),select.append(extractOptGroup(select,localize("Other"))),option.selected=!0}}})},"listen")};function extractOptGroup(select,label,types){const filtered=[...select.querySelectorAll(":scope > option").values()].filter(option=>!types||types.includes(option.value)),optgroup=document.createElement("optgroup");optgroup.label=label;for(const physicalElement of filtered)optgroup.appendChild(physicalElement);return optgroup}__name(extractOptGroup,"extractOptGroup"),__name2(extractOptGroup,"extractOptGroup");const RenderHUDContainer={listen:__name2(()=>{Hooks.on("renderHeadsUpDisplayContainer",()=>{TokenRulerPF2e.observeHudContainer();const measurementEl=document.getElementById("measurement");measurementEl?.style.setProperty("--counter-scale",(1/canvas.stage.scale.x).toFixed(4));const labelEl=createHTMLElement("div",{id:"token-hover-distance",classes:["waypoint-label"],children:[foundry.applications.fields.createFontAwesomeIcon("ruler"),createHTMLElement("span",{classes:["total-measurement"]})]});labelEl.hidden=!0,measurementEl?.append(labelEl)})},"listen")},RenderRegionLegend={listen:__name2(()=>{Hooks.on("renderRegionLegend",async(_app,html2)=>{const environmentTypes=canvas.scene?.flags.pf2e.environmentTypes;if(!environmentTypes||environmentTypes.length===0)return;const template=await(async()=>{const markup=await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/scene/region-legend-partial.hbs",{environmentTypes:environmentTypes.map(t2=>game.i18n.localize(CONFIG.PF2E.environmentTypes[t2]))}),tempElem=document.createElement("div");return tempElem.innerHTML=markup,tempElem.firstElementChild instanceof HTMLTemplateElement?tempElem.firstElementChild:null})();htmlQuery(html2,"div.region-filters")?.before(...template?.content.children??[])})},"listen")},RenderSettingsConfig={listen:__name2(()=>{Hooks.on("renderSettingsConfig",(_app,html2)=>{const lockedSettings=["core.gridTemplates","core.coneTemplateType"];for(const locked of lockedSettings){const element=htmlQuery(html2,`div[data-setting-id="${locked}"]`);if(!element)continue;const controlElement=htmlQuery(element,"select, input");controlElement&&(controlElement.disabled=!0,controlElement.dataset.tooltip="PF2E.SETTINGS.Core.ManagedBySystem");const label=htmlQuery(element,"label"),lock=createHTMLElement("i",{classes:["fa-solid","fa-lock","fa-fw"]});lock.dataset.tooltip="PF2E.SETTINGS.Core.ManagedBySystem",label?.append(" ",lock)}})},"listen")};class LegalNotice extends foundry.applications.api.DialogV2{static{__name(this,"LegalNotice")}static{__name2(this,"LegalNotice")}static DEFAULT_OPTIONS={id:"license-viewer",window:{title:"PF2E.LegalNotice.Title"},position:{width:560},buttons:[{action:"ok",label:"PF2E.OK",icon:"fa-solid fa-check",default:!0}]};_initializeApplicationOptions(options){return options.content=`<p>${game.i18n.localize("PF2E.LegalNotice.Text")}</p>`,super._initializeApplicationOptions(options)}}const RenderSettings={listen:__name2(()=>{Hooks.on("renderSettings",async(_app,html2)=>{const systemRow=htmlQuery(html2,"section.info .system"),systemInfo=systemRow?.cloneNode(!1);if(!(systemInfo instanceof HTMLElement))throw ErrorPF2e("Unexpected error attaching system information to settings sidebar");systemInfo.classList.remove("system"),systemInfo.classList.add("system-links");const links=[{url:"https://github.com/foundryvtt/pf2e/blob/v13-dev/CHANGELOG.md",label:"PF2E.SETTINGS.Sidebar.Changelog"},{url:"https://github.com/foundryvtt/pf2e/wiki",label:"PF2E.SETTINGS.Sidebar.Wiki"},{url:"https://discord.gg/pf2e",label:"PF2E.SETTINGS.Sidebar.Discord"}].map(data=>{const anchor=createHTMLElement("a",{children:[game.i18n.localize(data.label)]});return anchor.href=data.url,anchor.rel="nofollow noopener",anchor.target="_blank",anchor});systemInfo.append(...links),systemRow?.after(systemInfo);const header=createHTMLElement("h4",{classes:["divider"],children:[game.system.title]}),pf2eSettings=createHTMLElement("section",{classes:["pf2e","flexcol"],children:[header]});html2.querySelector("section.documentation")?.after(pf2eSettings);const createIcon=foundry.applications.fields.createFontAwesomeIcon,licenseButton=document.createElement("button");licenseButton.type="button",licenseButton.append(createIcon("balance-scale")," ",game.i18n.localize("PF2E.LegalNotice.Title")),licenseButton.addEventListener("click",()=>new LegalNotice().render({force:!0}));const remasterButton=document.createElement("button");if(remasterButton.type="button",remasterButton.append(createIcon("rocket"),game.i18n.localize("PF2E.SETTINGS.Sidebar.Remaster")),remasterButton.addEventListener("click",async()=>{(await fromUuid("Compendium.pf2e.journals.JournalEntry.6L2eweJuM8W7OCf2"))?.sheet.render(!0)}),pf2eSettings.append(licenseButton,remasterButton),game.user.isGM){const shootButton=document.createElement("button");shootButton.type="button",shootButton.append(createIcon("wrench"),game.i18n.localize("PF2E.Migrations.Troubleshooting")),shootButton.addEventListener("click",()=>new MigrationSummary({troubleshoot:!0}).render(!0)),pf2eSettings.append(shootButton)}})},"listen")};class PartyClownCar{static{__name(this,"PartyClownCar")}static{__name2(this,"PartyClownCar")}party;token;constructor(token){if(this.token=token,!this.token.scene.isOwner)throw ErrorPF2e("Cannot write to scene");const party=token.actor;if(!party?.isOfType("party"))throw ErrorPF2e("Unexpected actor type");this.party=party}get scene(){return this.token.scene}get memberTokens(){return this.party.members.flatMap(m=>m.getActiveTokens(!0,!0))}toggleState(){return this.memberTokens.length>0?this.#retrieve():this.#deposit()}async#retrieve(){const tokens=this.memberTokens,updates=tokens.map(t2=>({_id:t2.id,...t$3(this.token,["x","y"])}));await this.scene.updateEmbeddedDocuments("Token",updates),await Promise.all(tokens.map(async token=>(await token.object?.animationContexts.get(token.object.movementAnimationName)?.promise,token.delete())))}async#deposit(){const car=this.token;if(!car.object)return;const newTokens=(await Promise.all(this.party.members.map(m=>m.getTokenDocument({x:car.x,y:car.y,actorLink:!0})))).map(t2=>({...t2.toObject(),x:car.x,y:car.y})).sort((a,b)=>b.width-a.width),createdTokens=await this.scene.createEmbeddedDocuments("Token",newTokens),freeSpaces=this.#getDepositSpaces(),placementData=createdTokens.map(token=>{const widthPixels=token.mechanicalBounds.width,square=freeSpaces.findSplice(s=>Math.abs(s.x-token.x)>=widthPixels&&Math.abs(s.y-token.y)>=widthPixels);return{_id:token._id??"",...t$3(square??car,["x","y"])}});await this.scene.updateEmbeddedDocuments("Token",placementData)}#getDepositSpaces(){const placeable=this.token.object;if(!placeable)return[];const center=placeable.center,diameter=placeable.bounds.width*7,radiusPixels=diameter/2,distance=canvas.dimensions?.distance??5,radius=radiusPixels/distance,areaBounds=new PIXI.Rectangle(center.x-radiusPixels,center.y-radiusPixels,diameter,diameter),squares=getAreaSquares({bounds:areaBounds,radius,token:placeable}).filter(s=>s.active);return t(squares.filter(s=>!(s.x===placeable.x&&s.y===placeable.y)&&!(s.center.x===center.x&&s.center.y===center.y)&&!placeable.checkCollision(s.center,{type:"move",mode:"any"})).reverse(),s=>canvas.grid.measurePath([center,s.center]).distance)}}class RenderTokenHUD{static{__name(this,"RenderTokenHUD")}static{__name2(this,"RenderTokenHUD")}static listen(){Hooks.on("renderTokenHUD",(_app,html2,data)=>{game.pf2e.StatusEffects.onRenderTokenHUD(html2,data);const token=canvas.scene?.tokens.get(data._id??"")?.object;RenderTokenHUD.#addClownCarButton(html2,token),token?.actor?.isOfType("army")&&htmlQuery(html2,".control-icon[data-palette=effects]")?.remove()})}static#addClownCarButton(html2,token){if(!token?.actor?.isOfType("party"))return;const willRetrieve=token.actor.members.some(m=>m.getActiveTokens(!0,!0).length>0),img2=document.createElement("img");img2.src="systems/pf2e/icons/other/enter-exit.svg",img2.className=willRetrieve?"retrieve":"deposit";const button=createHTMLElement("button",{classes:["control-icon","clown-car"],dataset:{tooltip:""},aria:{label:game.i18n.localize(`PF2E.Actor.Party.ClownCar.${willRetrieve?"Retrieve":"Deposit"}`)},children:[img2]});button.type="button",button.addEventListener("click",async()=>{if(!button.disabled){button.disabled=!0;try{await new PartyClownCar(token.document).toggleState();const switchToDeposit=img2.className==="retrieve";img2.className=switchToDeposit?"deposit":"retrieve";const locPath=`PF2E.Actor.Party.ClownCar.${switchToDeposit?"Deposit":"Retrieve"}`;button.ariaLabel=game.i18n.localize(locPath)}finally{button.disabled=!1}}}),html2.querySelector("[data-palette=effects]")?.replaceWith(button)}}class ArmySheetPF2e extends ActorSheetPF2e{static{__name(this,"ArmySheetPF2e")}static{__name2(this,"ArmySheetPF2e")}basicWarActions=[];itemRenderer=new ArmyItemRenderer(this);static get defaultOptions(){const options=super.defaultOptions;return{...options,classes:[...options.classes,"army"],width:750,height:625,template:"systems/pf2e/templates/actors/army/sheet.hbs",scrollY:[".sheet-body"]}}async getData(options){const data=await super.getData(options),actor=this.actor,campaignFeatures=actor.itemTypes.campaignFeature;if(!this.basicWarActions.length){const compendiumFeatures=(await game.packs.get("pf2e.kingmaker-features")?.getDocuments({type:"campaignFeature"})??[]).filter(d=>d instanceof ItemPF2e&&d.isOfType("campaignFeature"));this.basicWarActions=compendiumFeatures.filter(d=>d.system.category==="army-war-action"&&d.folder?.id===BASIC_WAR_ACTIONS_FOLDER).map(i=>new ItemProxyPF2e(i.toObject(!0),{parent:this.actor})).filter(i=>i.isOfType("campaignFeature"))}return{...data,description:await TextEditorPF2e.enrichHTML(actor.system.details.description,{rollData:actor.getRollData()}),ac:{value:actor.armorClass.value,breakdown:actor.armorClass.breakdown,adjustmentClass:getAdjustment(actor.armorClass.value,actor._source.system.ac.value+actor.system.ac.potency)},consumption:getAdjustedValue(actor.system.consumption,actor._source.system.consumption,{better:"lower"}),hitPoints:{value:actor.system.attributes.hp.value,max:getAdjustedValue(actor.system.attributes.hp.max,actor._source.system.attributes.hp.max),routThreshold:getAdjustedValue(actor.system.attributes.hp.routThreshold,actor._source.system.attributes.hp.routThreshold,{better:"lower"})},linked:!!actor.prototypeToken.actorLink&&(!actor.token||actor.token.isLinked),armyTypes:t$3(kingmakerTraits,ARMY_TYPES),rarityTraits:CONFIG.PF2E.rarityTraits,saves:t(["maneuver","morale"].map(slug=>{const statistic=this.actor[slug];return{slug,label:statistic.label,mod:statistic.mod,breakdown:statistic.check.breakdown,adjustmentClass:getAdjustment(statistic.mod,this.actor._source.system.saves[slug])}}),s=>s.label),basicWarActions:this.basicWarActions,warActions:[...campaignFeatures.filter(f=>f.category==="army-war-action"),...campaignFeatures.filter(f=>f.category==="army-tactic"&&!!f.actionCost)]}}activateListeners($html){super.activateListeners($html);const html2=$html[0],levelInput=htmlQuery(html2,".level");levelInput?.addEventListener("change",()=>{const value=levelInput.value;this.actor.updateLevel(Number(value))});for(const rollableStat of htmlQueryAll(html2,".rollable")){const statSlug=htmlClosest(rollableStat,"[data-statistic]")?.dataset.statistic;statSlug&&rollableStat.addEventListener("click",event2=>{this.actor.getStatistic(statSlug)?.roll(eventToRollParams(event2,{type:"check"}))})}htmlQuery(html2,"[data-action=link-actor]")?.addEventListener("click",()=>{this.actor.token?ui.notifications.error("PF2E.Kingmaker.Army.Alliance.LinkError",{localize:!0}):this.actor.update({prototypeToken:{actorLink:!0}})});for(const resourceElement of htmlQueryAll(html2,"[data-action=change-resource]")){const resource=resourceElement.dataset.resource;if(!tupleHasValue(["potions","ammunition"],resource))continue;const max=this.actor.system.resources[resource].max;resourceElement.addEventListener("click",()=>{const newValue=Math.clamp(this.actor.system.resources[resource].value+1,0,max);this.actor.update({[`system.resources.${resource}.value`]:newValue})}),resourceElement.addEventListener("contextmenu",event2=>{event2.preventDefault();const newValue=Math.clamp(this.actor.system.resources[resource].value-1,0,max);this.actor.update({[`system.resources.${resource}.value`]:newValue})})}htmlQuery(html2,"[data-action=reset-ammo]")?.addEventListener("click",()=>{const max=this.actor.system.resources.ammunition.max;this.actor.update({"system.resources.ammunition.value":max})}),htmlQuery(html2,"[data-action=use-potion]")?.addEventListener("click",()=>{this.actor.usePotion()});for(const gearElement of htmlQueryAll(html2,"[data-action=change-magic-armor]"))gearElement.addEventListener("click",()=>{const newValue=Math.clamp(this.actor.system.ac.potency+1,0,3);this.actor.update({"system.ac.potency":newValue})}),gearElement.addEventListener("contextmenu",event2=>{event2.preventDefault();const newValue=Math.clamp(this.actor.system.ac.potency-1,0,3);this.actor.update({"system.ac.potency":newValue})});for(const gearElement of htmlQueryAll(html2,"[data-action=change-magic-weapon]")){const gear=gearElement.dataset.weapon;if(!tupleHasValue(["melee","ranged"],gear))continue;const data=this.actor.system.weapons[gear];gearElement.addEventListener("click",()=>{if(data){const newValue=Math.clamp(data.potency+1,0,3);this.actor.update({[`system.weapons.${gear}.potency`]:newValue})}else{const newData={name:"",potency:0};this.actor.update({[`system.weapons.${gear}`]:newData})}}),gearElement.addEventListener("contextmenu",event2=>{if(event2.preventDefault(),!!data)if(data.potency===0)this.actor.update({[`system.weapons.${gear}`]:null});else{const newValue=Math.clamp(data.potency-1,0,3);this.actor.update({[`system.weapons.${gear}.potency`]:newValue})}})}const gearData=getArmyGearData();for(const showGear of htmlQueryAll(html2,"[data-action=show-gear]")){const rawGearType=showGear.dataset.gear,gearType=tupleHasValue(["melee","ranged"],rawGearType)&&!this.actor.system.weapons[rawGearType]?`additional-${rawGearType}`:rawGearType;if(!objectHasKey(gearData,gearType))continue;const kingmakerTraits2=CONFIG.PF2E.kingmakerTraits,actionTraits2=CONFIG.PF2E.actionTraits,descriptions=CONFIG.PF2E.traitsDescriptions;showGear.addEventListener("click",async()=>{const gear=gearData[gearType];ChatMessagePF2e.create({speaker:ChatMessagePF2e.getSpeaker({actor:this.actor}),content:await foundry.applications.handlebars.renderTemplate("systems/pf2e/templates/actors/army/gear-card.hbs",{...gear,level:gear.level??(gear.ranks?.length?`${gear.ranks[0].level}+`:null),traits:gear.traits.map(t2=>({label:game.i18n.localize(kingmakerTraits2[t2]??actionTraits2[t2]??t2),description:game.i18n.localize(descriptions[t2]??"")}))})})})}htmlQuery(html2,"[data-action=edit-description]")?.addEventListener("click",()=>{this.activateEditor("system.details.description")});for(const strikeAttack of htmlQueryAll(html2,"[data-action=strike-attack]")){const type2=htmlClosest(strikeAttack,"[data-strike]")?.dataset.strike,variant=Number(strikeAttack.dataset.variantIndex);objectHasKey(this.actor.strikes,type2)&&strikeAttack.addEventListener("click",event2=>{this.actor.strikes[type2]?.variants[variant]?.roll({event:event2})})}for(const strikeDamage of htmlQueryAll(html2,"[data-action=strike-damage]")){const type2=htmlClosest(strikeDamage,"[data-strike]")?.dataset.strike,outcome=strikeDamage.dataset.outcome==="criticalSuccess"?"critical":"damage";objectHasKey(this.actor.strikes,type2)&&strikeDamage.addEventListener("click",event2=>{this.actor.strikes[type2]?.[outcome]({event:event2})})}}activateClickListener(html2){const handlers=super.activateClickListener(html2);return handlers["toggle-basic-war-action-summary"]=async event2=>{const element=htmlClosest(event2.target,"[data-slug]");element&&this.itemRenderer.toggleSummary(element)},handlers["use-basic-war-action"]=async event2=>{const slug=htmlClosest(event2.target,"[data-slug]")?.dataset.slug;this.basicWarActions.find(a=>a.slug===slug)?.toMessage(event2)},handlers}async _onDropItem(event2,data){const item=await ItemPF2e.fromDropData(data);if(!item)throw ErrorPF2e("Unable to create item from drop data!");if(this.actor.uuid===item.parent?.uuid)return super._onDropItem(event2,data);if(item?.isOfType("campaignFeature")&&(item.isFeat||item.isFeature)){const slotData=this.#getFeatSlotData(event2)??{groupId:"bonus",slotId:null};return(slotData.groupId==="tactics"?this.actor.tactics:this.actor.bonusTactics).insertFeat(item,slotData.slotId)}return super._onDropItem(event2,data)}async _onSortItem(event2,itemSource){const item=this.actor.items.get(itemSource._id);if(item?.isOfType("campaignFeature")&&(item.isFeat||item.isFeature)){const featSlot=this.#getFeatSlotData(event2)??{groupId:"bonus",slotId:null},group=featSlot.groupId==="tactics"?this.actor.tactics:this.actor.bonusTactics,resorting=item.group===group&&!group?.slotted;if(group?.slotted&&!featSlot.slotId)return[];if(!resorting)return group.insertFeat(item,featSlot.slotId)}return super._onSortItem(event2,itemSource)}#getFeatSlotData(event2){const groupId=htmlClosest(event2.target,"[data-group-id]")?.dataset.groupId,slotId=htmlClosest(event2.target,"[data-slot-id]")?.dataset.slotId;return typeof groupId=="string"?{slotId,groupId}:null}}class ArmyItemRenderer extends ItemSummaryRenderer{static{__name(this,"ArmyItemRenderer")}static{__name2(this,"ArmyItemRenderer")}async getItemFromElement(element){const slug=element.dataset.slug;return this.sheet.basicWarActions.find(a=>a.slug===slug)??super.getItemFromElement(element)}}class FamiliarSheetPF2e extends CreatureSheetPF2e{static{__name(this,"FamiliarSheetPF2e")}static{__name2(this,"FamiliarSheetPF2e")}actorConfigClass=null;static get defaultOptions(){const options=super.defaultOptions;return{...options,classes:[...options.classes,"familiar"],width:650,height:680,tabs:[{navSelector:".sheet-navigation",contentSelector:".sheet-content",initial:"attributes"}],template:"systems/pf2e/templates/actors/familiar/sheet.hbs"}}async getData(options){const sheetData=await super.getData(options),familiar=this.actor,masters=game.actors.filter(a=>a.type==="character"&&(a.isOwner||a.id===familiar.master?.id)),size=CONFIG.PF2E.actorSizes[familiar.system.traits.size.value]??null,familiarAbilities=this.actor.master?.attributes?.familiarAbilities;if(sheetData.data.saves)for(const key of["fortitude","reflex","will"]){const save=sheetData.data.saves[key];save.label=CONFIG.PF2E.saves[key]}const skills=Object.values(sheetData.data.skills).sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang));return{...sheetData,attributes:CONFIG.PF2E.abilities,familiarAbilities:{value:familiarAbilities?.value??0,items:t(this.actor.itemTypes.action,a=>a.name,a=>a.sort).map(item=>createAbilityViewData(item))},master:this.actor.master,masters,size,skills}}activateClickListener(html2){const handlers=super.activateClickListener(html2);return handlers["familiar-attack-roll"]=event2=>{this.actor.attackStatistic.roll(eventToRollParams(event2,{type:"check"}))},handlers}}class HazardSheetPF2e extends ActorSheetPF2e{static{__name(this,"HazardSheetPF2e")}static{__name2(this,"HazardSheetPF2e")}static get defaultOptions(){const options=super.defaultOptions;return{...options,classes:[...options.classes,"hazard"],scrollY:["section.content"],width:710,height:680,template:"systems/pf2e/templates/actors/hazard/sheet.hbs"}}get title(){return this.editing?game.i18n.format("PF2E.Actor.Hazard.TitleEdit",{name:super.title}):super.title}get editing(){return this.isEditable&&!!this.actor.getFlag("pf2e","editHazard.value")}async getData(options){const sheetData=await super.getData(options),system2=sheetData.data,actor=this.actor,hasDefenses=actor.hasDefenses,hasImmunities=system2.attributes.immunities.length>0,hasResistances=system2.attributes.resistances.length>0,hasWeaknesses=system2.attributes.weaknesses.length>0,hasIWR=hasDefenses||hasImmunities||hasResistances||hasWeaknesses,rollData=this.actor.getRollData(),enrich=__name2(async content=>TextEditorPF2e.enrichHTML(content??"",{rollData}),"enrich");return sheetData.enrichedContent=foundry.utils.mergeObject(sheetData.enrichedContent,{stealthDetails:await enrich(system2.attributes.stealth.details),description:await enrich(system2.details.description),disable:await enrich(system2.details.disable),routine:await enrich(system2.details.routine),reset:await enrich(system2.details.reset)}),{...sheetData,attacks:await this.#prepareAttacks(),actions:this.#prepareActions(),complexityOptions:[{value:"false",label:"PF2E.Actor.Hazard.Simple"},{value:"true",label:"PF2E.TraitComplex"}],emitsSoundOptions:[{value:"true",label:"PF2E.Actor.Hazard.EmitsSound.True"},{value:"false",label:"PF2E.Actor.Hazard.EmitsSound.False"},{value:"encounter",label:"PF2E.Actor.Hazard.EmitsSound.Encounter"}],editing:this.editing,actorTraits:system2.traits.value.map(t2=>traitSlugToObject(t2,CONFIG.PF2E.hazardTraits)),rarity:CONFIG.PF2E.rarityTraits,rarityLabel:CONFIG.PF2E.rarityTraits[this.actor.rarity],brokenThreshold:system2.attributes.hp.brokenThreshold,saves:this.#prepareSaves(),hasDefenses,hasHPDetails:!!system2.attributes.hp.details,hasSaves:Object.keys(actor.saves??{}).length>0,hasIWR,hasStealth:system2.attributes.stealth.dc!==null,hasDescription:!!system2.details.description?.trim(),hasDisable:!!system2.details.disable?.trim(),hasRoutineDetails:!!system2.details.routine?.trim(),hasResetDetails:!!system2.details.reset?.trim()}}async#prepareAttacks(){const actor=this.actor,results=[];for(const attack of actor.system.actions){const description=attack.description.length>0?await TextEditorPF2e.enrichHTML(attack.description,{rollData:attack.item.getRollData()}):null;results.push({description,damageFormula:String(await attack.damage?.({getFormula:!0})),breakdown:attack.type==="strike"?attack.breakdown:attack.statistic.dc.breakdown,additionalEffects:attack.additionalEffects,attackRollType:attack.attackRollType,glyph:attack.glyph,variants:attack.variants,item:attack.item,traitsAndTags:createNPCAttackTraitsAndTags(attack.item)})}return results}#prepareActions(){const actions=this.actor.itemTypes.action.sort((a,b)=>a.sort-b.sort);return{reaction:actions.filter(a=>a.actionCost?.type==="reaction"),action:actions.filter(a=>a.actionCost?.type!=="reaction")}}#prepareSaves(){if(!this.actor.saves)return[];const results=[];for(const saveType of SAVE_TYPES){const save=this.actor.saves[saveType];(this.editing||save)&&results.push({label:game.i18n.localize(`PF2E.Saves${saveType.titleCase()}Short`),type:saveType,mod:save?.check.mod})}return results}activateListeners($html){super.activateListeners($html);const html2=$html[0],traitsEl=htmlQuery(html2,'tagify-tags[name="system.traits.value"]');if(traitsEl){const tags=tagify(traitsEl,{whitelist:CONFIG.PF2E.hazardTraits}),traitsPrepend=html2.querySelector(".traits-extra");traitsPrepend&&tags.DOM.scope.prepend(traitsPrepend.content)}}activateClickListener(html2){const handlers=super.activateClickListener(html2);return handlers["toggle-edit-mode"]=()=>this.actor.update({"flags.pf2e.editHazard.value":!this.editing}),handlers["edit-section"]=event2=>{const container=htmlClosest(event2.target,".section-container"),name2=htmlQuery(container,"[data-edit]")?.dataset.edit,active=this.editors[name2??""]?.active;return name2&&!active?this.activateEditor(name2):null},handlers}async _updateObject(event2,formData){const emitsSound=formData["system.attributes.emitsSound"];return emitsSound!=="encounter"&&(formData["system.attributes.emitsSound"]=emitsSound==="true"),super._updateObject(event2,formData)}}class DistributeCoinsDialog extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){static{__name(this,"DistributeCoinsDialog")}static{__name2(this,"DistributeCoinsDialog")}constructor(options){super(options),this.actor=options.actor}static DEFAULT_OPTIONS={id:"distribute-coins",tag:"form",window:{icon:"fa-solid fa-coins",title:"Distribute Coins",contentClasses:["standard-form"]},position:{width:400},form:{closeOnSubmit:!0,handler:DistributeCoinsDialog.#onSubmit}};static PARTS={base:{template:"systems/pf2e/templates/actors/distribute-coins.hbs",root:!0}};actor;async _prepareContext(options){const data=await super._prepareContext(options);this.actor.inventory.currency;const playerActors=(this.options.recipients??game.actors.contents).filter(a=>a.hasPlayerOwner&&a.isOfType("character")&&!a.isToken&&!a.system.traits.value.some(t2=>["minion","eidolon"].includes(t2)));return playerActors.length===0&&(ui.notifications.warn("PF2E.loot.NoPlayerCharacters",{localize:!0}),await this.close()),{...data,rootId:this.id,canBreakCoins:!0,actorInfo:playerActors.map(a=>({id:a.id,name:a.name,checked:game.users.players.some(u=>u.active&&u.character?.id===a.id)}))}}static async#onSubmit(_event,form,formData){const actor=this.actor,selectedActors=Array.from(form.elements).flatMap(element=>element instanceof HTMLInputElement&&element.name==="actorIds"&&element.checked?element.value:[]).flatMap(actorId=>{const maybeActor=game.actors.get(actorId);return maybeActor?.isOfType("character")?maybeActor:[]}),playerCount=selectedActors.length;if(playerCount===0)return;const available=actor.inventory.currency,share=new Coins({credits:Math.trunc(available.credits/playerCount),upb:Math.trunc(available.upb/playerCount)});if(formData.object.breakCoins){const thisActorCopperValue=actor.inventory.coins.copperValue-share.scale(playerCount).copperValue,copperToDistribute=Math.trunc(thisActorCopperValue/playerCount);share.cp=copperToDistribute%10,share.sp=Math.trunc(copperToDistribute/10)%10,share.gp=Math.trunc(copperToDistribute/100)%10,share.pp=Math.trunc(copperToDistribute/1e3)}else share.pp=Math.trunc(available.pp/playerCount),share.cp=Math.trunc(available.cp/playerCount),share.gp=Math.trunc(available.gp/playerCount),share.sp=Math.trunc(available.sp/playerCount);if(share.copperValue===0){ui.notifications.warn("Nothing to distribute");return}await Promise.all([actor.inventory.removeCoins(share.scale(playerCount),{byValue:!!formData.object.breakCoins}),...selectedActors.map(a=>a.inventory.addCurrency(share))]);const each2=playerCount>1?"each ":"";let message=`Distributed ${share.toString({unit:"raw"})} ${each2}from ${actor.name} to `;for(const actor2 of selectedActors){const index2=selectedActors.indexOf(actor2);index2===0?message+=`${actor2.name}`:index2<playerCount-1?message+=`, ${actor2.name}`:message+=` and ${actor2.name}.`}ChatMessagePF2e.create({author:game.user.id,style:CONST.CHAT_MESSAGE_STYLES.OTHER,content:message})}}const appv1$4=foundry.appv1;class LootNPCsPopup extends appv1$4.api.FormApplication{static{__name(this,"LootNPCsPopup")}static{__name2(this,"LootNPCsPopup")}static get defaultOptions(){const options=super.defaultOptions;return options.id="loot-NPCs",options.classes=[],options.title="Loot NPCs",options.template="systems/pf2e/templates/actors/loot/loot-npcs-popup.hbs",options.width="auto",options}async getData(){const tokenInfo=(canvas.ready?canvas.tokens.controlled.filter(t2=>t2.actor&&t2.actor.id!==this.object.id):[]).map(t2=>({id:t2.id,name:t2.name,checked:t2.actor?.hasPlayerOwner??!1}));return{...await super.getData(),tokenInfo}}async _updateObject(_event,formData){if(!canvas.ready)return;const lootActor=this.object,selectionData=Array.isArray(formData.selection)?formData.selection:[formData.selection];for(let i=0;i<selectionData.length;i++){const token=canvas.tokens.placeables.find(token2=>token2.actor&&token2.id===this.form[i]?.id);if(!token)throw ErrorPF2e(`Token ${this.form[i]?.id} not found`);selectionData[i]&&token.actor&&await transferItemsBetweenActors(token.actor,lootActor)}}}class LootSheetPF2e extends ActorSheetPF2e{static{__name(this,"LootSheetPF2e")}static{__name2(this,"LootSheetPF2e")}static get defaultOptions(){const options=super.defaultOptions;return{...options,editable:!0,classes:[...options.classes,"loot"],width:650,height:680,tabs:[{navSelector:".sheet-navigation",contentSelector:".sheet-content",initial:"inventory"}]}}get template(){return"systems/pf2e/templates/actors/loot/sheet.hbs"}async getData(){const sheetData=await super.getData(),actor=this.actor,isLoot=actor.system.lootSheetType==="Loot",rollData=actor.getRollData(),description=sheetData.data.details.description;return sheetData.enrichedContent.description=await TextEditorPF2e.enrichHTML(description,{rollData}),{...sheetData,hasActiveParty:!!game.actors.party,isLoot,fields:actor.schema.fields,systemFields:actor.system.schema.fields,lootSheetTypeOptions:[{value:"Loot",label:game.i18n.localize("PF2E.loot.LootLabel")},{value:"Merchant",label:game.i18n.localize("PF2E.loot.MerchantLabel")}]}}activateListeners($html){if(super.activateListeners($html),!this.isEditable)return;const html2=$html[0];htmlQuery(html2,"[data-sidebar-buttons]")?.addEventListener("click",event2=>{const button=htmlClosest(event2.target,"button[data-action]");if(button?.dataset.action==="split-coins")new DistributeCoinsDialog({actor:this.actor}).render(!0);else if(button?.dataset.action==="loot-npcs")canvas.tokens.controlled.some(token=>token.actor?.id!==this.actor.id)?new LootNPCsPopup(this.actor).render(!0):ui.notifications.warn("No tokens selected.");else if(button?.dataset.action==="send-to-party-stash"){if(!game.actors.party)return;transferItemsBetweenActors(this.actor,game.actors.party)}})}prepareInventory(){const preparedInventory=super.prepareInventory();return preparedInventory.showUnitBulkPrice=this.actor.system.lootSheetType==="Merchant",this.actor.isOwner||(preparedInventory.sections=preparedInventory.sections.filter(s=>s.items.length&&s.items.some(i=>!i.hidden))),preparedInventory}prepareInventoryItem(item){const isMerchant=this.actor.system.lootSheetType==="Merchant",data=super.prepareInventoryItem(item);return data.hidden=isMerchant&&item.isOfType("treasure")&&item.isCoinage&&!item.container,data}}const appv1$3=foundry.appv1;class NPCSkillsEditor extends appv1$3.api.DocumentSheet{static{__name(this,"NPCSkillsEditor")}static{__name2(this,"NPCSkillsEditor")}get actor(){return this.object}static get defaultOptions(){return{...super.defaultOptions,classes:["pf2e","npc-skills-editor"],template:"systems/pf2e/templates/actors/npc/skills-editor.hbs",height:"auto",scrollY:[".scroll-container"],sheetConfig:!1,submitOnChange:!0,submitOnClose:!1,closeOnSubmit:!1,resizable:!0,width:500}}get title(){return game.i18n.format("PF2E.Actor.NPC.SkillsEditor.Title",{actor:this.actor.name})}async getData(options){const allSkills=Object.values(this.actor.system.skills);return{...await super.getData(options),actor:this.actor,trainedSkills:allSkills.filter(s=>s.visible&&!s.lore).sort((a,b)=>a.label.localeCompare(b.label)),loreSkills:allSkills.filter(s=>s.visible&&s.lore).sort((a,b)=>a.label.localeCompare(b.label)),untrainedSkills:allSkills.filter(s=>!s.visible).sort((a,b)=>a.label.localeCompare(b.label))}}activateListeners($html){super.activateListeners($html);const html2=$html[0];htmlQuery(html2,"button[data-action=add-skill]")?.addEventListener("click",async event2=>{const slug=htmlQuery(htmlClosest(event2.currentTarget,".skill-selector"),"select")?.value;slug&&slug in CONFIG.PF2E.skills&&await this.actor.update({[`system.skills.${slug}`]:{base:0}})}),htmlQuery(html2,"button[data-action=add-lore]")?.addEventListener("click",async event2=>{const loreName=htmlQuery(htmlClosest(event2.currentTarget,".lore-skill-creator"),"input")?.value.trim();if(loreName){const data={name:loreName,type:"lore",system:{mod:{value:0}}};await this.actor.createEmbeddedDocuments("Item",[data])}});for(const button of htmlQueryAll(html2,"a[data-action=add-special-skill]"))button.addEventListener("click",event2=>{const skill=htmlClosest(event2.target,"[data-skill]")?.dataset.skill;if(!objectHasKey(CONFIG.PF2E.skills,skill))return;const special=foundry.utils.deepClone(this.actor._source.system.skills[skill]?.special??[]);special.push({label:"",base:0}),this.actor.update({[`system.skills.${skill}.special`]:special})});for(const button of htmlQueryAll(html2,"a[data-action=remove-special-skill]"))button.addEventListener("click",event2=>{const skill=htmlClosest(event2.target,"[data-skill]")?.dataset.skill;if(!objectHasKey(CONFIG.PF2E.skills,skill)||!(event2.currentTarget instanceof HTMLElement))return;const index2=Number(event2.currentTarget.dataset.specialSkillIndex),special=this.actor._source.system.skills[skill]?.special?.filter((_,idx)=>index2!==idx)??[];special.length===0?this.actor.update({[`system.skills.${skill}.-=special`]:null}):this.actor.update({[`system.skills.${skill}.special`]:special})});for(const input of htmlQueryAll(html2,"input[data-modifier]"))input.addEventListener("change",async()=>{const modifier=Math.clamp(Math.trunc(Number(input.value)||0),-999,999);if(Number.isInteger(modifier)){const itemId=htmlClosest(input,"[data-item-id]")?.dataset.itemId;await this.actor.items.get(itemId,{strict:!0}).update({"system.mod.value":modifier})}}),input.addEventListener("focus",()=>{input.select()});for(const anchor of htmlQueryAll(html2,"a[data-action=edit-skill]"))anchor.addEventListener("click",()=>{const itemId=htmlClosest(anchor,"[data-item-id]")?.dataset.itemId;this.actor.items.get(itemId,{strict:!0}).sheet.render(!0)});for(const anchor of htmlQueryAll(html2,"a[data-action=remove-skill]"))anchor.addEventListener("click",()=>{const skill=htmlClosest(anchor,"[data-skill]")?.dataset.skill,itemId=htmlClosest(anchor,"[data-item-id]")?.dataset.itemId;skill?this.actor.update({[`system.skills.-=${skill}`]:null}):itemId&&this.actor.items.get(itemId,{strict:!0}).delete()})}async _onChangeInput(event2){if(event2.target instanceof HTMLElement&&event2.target.hasAttribute("name"))return super._onChangeInput(event2)}_updateObject(event2,formData){const data=foundry.utils.expandObject(formData);try{for(const skill of Object.values(data.system?.skills??{})){skill.special=Object.values(skill.special??{});for(const special of skill.special)if(special.predicate=special.predicate&&typeof special.predicate=="string"?JSON.parse(special.predicate):[],special.predicate?.length===0)delete special.predicate;else if(!Array.isArray(special.predicate))throw Error(game.i18n.localize("PF2E.Actor.NPC.SkillsEditor.Error.PredicateArray"))}}catch(ex){throw ex instanceof Error&&ui.notifications.error(ex.message),ex}return super._updateObject(event2,foundry.utils.flattenObject(data))}async _render(force,options){const focusedElement=htmlQuery(this.form,"input:focus, select:focus");if(await super._render(force,options),focusedElement?.id){const newInput=document.getElementById(focusedElement.id);(newInput instanceof HTMLInputElement||newInput instanceof HTMLSelectElement)&&window.setTimeout(()=>{newInput.focus()},0)}}}const appv1$2=foundry.appv1;class RecallKnowledgePopup extends appv1$2.api.Application{static{__name(this,"RecallKnowledgePopup")}static{__name2(this,"RecallKnowledgePopup")}#identificationData;constructor(options,data){super(options),this.#identificationData=data}static get defaultOptions(){return{...super.defaultOptions,id:"recall-knowledge-breakdown",classes:[],title:game.i18n.localize("PF2E.RecallKnowledge.BreakdownTitle"),template:"systems/pf2e/templates/actors/recall-knowledge.hbs",width:600}}async getData(){const identificationData=this.#identificationData;return{standard:{label:localizeList(identificationData.skills.map(s=>game.i18n.localize(CONFIG.PF2E.skills[s].label))),attempts:this.#padAttempts(identificationData.standard.progression)},loreEasy:this.#padAttempts(identificationData.lore[0].progression),loreVeryEasy:this.#padAttempts(identificationData.lore[1].progression)}}#padAttempts(attempts){const result=attempts.map(a=>a.toString());for(let i=result.length;i<6;i++)result.push("-");return result}}class NPCConfig extends CreatureConfig{static{__name(this,"NPCConfig")}static{__name2(this,"NPCConfig")}async getData(options={}){const lootableOptions={default:`PF2E.Actor.NPC.Configure.Lootable.${game.settings.get("pf2e","automation.lootableNPCs")?"DefaultLootable":"DefaultNotLootable"}`,lootable:"PF2E.Actor.NPC.Configure.Lootable.Lootable",notLootable:"PF2E.Actor.NPC.Configure.Lootable.NotLootable"},lootableSelection=(()=>{const storedSelection=this.actor._source.flags.pf2e?.lootable;return typeof storedSelection=="boolean"?storedSelection?"lootable":"notLootable":"default"})();return{...await super.getData(options),lootable:createSheetOptions(lootableOptions,{value:[lootableSelection]})}}async _updateObject(event2,formData){const key="flags.pf2e.lootable",lootable=formData[key];return lootable==="default"?(delete formData[key],formData["flags.pf2e.-=lootable"]=null):formData[key]=lootable==="lootable",super._updateObject(event2,formData)}}class AbstractNPCSheet extends CreatureSheetPF2e{static{__name(this,"AbstractNPCSheet")}static{__name2(this,"AbstractNPCSheet")}actorConfigClass=NPCConfig;static get defaultOptions(){const options=super.defaultOptions;return options.classes.push("pf2e","npc"),{...options,scrollY:[".sidebar"]}}async prepareItems(sheetData){this.#prepareSkills(sheetData.data),this.#prepareSaves(sheetData.data)}async getData(options){const sheetData=await super.getData(options),rollData=this.actor.getRollData();sheetData.enrichedContent.publicNotes=await TextEditorPF2e.enrichHTML(sheetData.data.details.publicNotes,{rollData,secrets:this.actor.isOwner}),sheetData.enrichedContent.privateNotes=await TextEditorPF2e.enrichHTML(sheetData.data.details.privateNotes,{rollData}),sheetData.traitTagifyData=createTagifyTraits(this.actor.system.traits.value,{sourceTraits:this.actor._source.system.traits.value,record:CONFIG.PF2E.creatureTraits});const mythicResource=this.actor.getResource("mythic-points");return mythicResource?.max&&sheetData.specialResources.unshift(mythicResource),sheetData}#prepareSkills(sheetSystemData){for(const skill of Object.values(sheetSystemData.skills))skill.adjustedHigher=skill.value>Number(skill.base),skill.adjustedLower=skill.value<Number(skill.base);sheetSystemData.skills=sortLabeledRecord(sheetSystemData.skills)}#prepareSaves(systemData){for(const saveType of SAVE_TYPES){const save=systemData.saves[saveType];save.labelShort=game.i18n.localize(`PF2E.Saves${saveType.titleCase()}Short`),save.adjustedHigher=save.totalModifier>Number(save.base),save.adjustedLower=save.totalModifier<Number(save.base)}}_canUserView(user){return super._canUserView(user)||this.isLootSheet}activateListeners($html){super.activateListeners($html);const html2=$html[0],traitsEl=htmlQuery(html2,'tagify-tags[name="system.traits.value"]');tagify(traitsEl,{whitelist:CONFIG.PF2E.creatureTraits})}activateClickListener(html2){const handlers=super.activateClickListener(html2),baseRollCheck=handlers["roll-check"];return handlers["roll-check"]=(event2,anchor)=>{const variantIdx="variant"in anchor.dataset?Number(anchor.dataset.variant):null;if(variantIdx===null)return baseRollCheck(event2,anchor);const statisticSlug=htmlClosest(anchor,"[data-statistic]")?.dataset.statistic??"",skill=this.actor.system.skills[statisticSlug],variant=skill?.special?.at(variantIdx);if(!variant)return baseRollCheck(event2,anchor);const statistic=this.actor.getStatistic(statisticSlug),args={...eventToRollParams(event2,{type:"check"}),modifiers:[new Modifier({slug:"variant",label:variant.label,modifier:variant.base-skill.base})]};return anchor.dataset.secret!==void 0&&(args.rollMode=game.user.isGM?"gmroll":"blindroll"),statistic?.roll(args)},handlers["edit-skills"]=()=>{new NPCSkillsEditor(this.actor).render(!0)},handlers}}class NPCSheetPF2e extends AbstractNPCSheet{static{__name(this,"NPCSheetPF2e")}static{__name2(this,"NPCSheetPF2e")}static get defaultOptions(){const options=super.defaultOptions;return options.scrollY.push(".inventory-list",".tab:not(.inventory)"),{...options,width:650,height:680,tabs:[{navSelector:".sheet-tabs",contentSelector:".sheet-body",initial:"main"}]}}get template(){return this.isLootSheet?"systems/pf2e/templates/actors/npc/loot-sheet.hbs":this.actor.limited?"systems/pf2e/templates/actors/limited/npc-sheet.hbs":"systems/pf2e/templates/actors/npc/sheet.hbs"}get title(){if(this.isLootSheet||this.actor.limited){const actorName=!game.pf2e.settings.tokens.nameVisibility||!this.token||this.token.playersCanSeeName?this.token?.name??this.actor.name:"";return this.actor.isDead?`${actorName} [${game.i18n.localize("PF2E.NPC.Dead")}]`:actorName}return super.title}async getData(options){const sheetData=await super.getData(options),{actor,token}=this;if(this.isLootSheet||actor.limited){const actorName=!game.pf2e.settings.tokens.nameVisibility||!token||token.playersCanSeeName?token?.name??actor.name:"";sheetData.actor.name=actorName}sheetData.identificationDCs=(()=>{const data=actor.identificationDCs,skills=data.skills.length>0?localizeList(data.skills.map(s=>game.i18n.localize(CONFIG.PF2E.skills[s].label))):null;return{standard:skills?game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills,dc:data.standard.dc,adjustment:game.i18n.localize(CONFIG.PF2E.dcAdjustments[data.standard.start])}):null,lore:game.i18n.format("PF2E.Actor.NPC.Identification.Lore.Label",{dc1:data.lore[0].dc,adjustment1:game.i18n.localize(CONFIG.PF2E.dcAdjustments[data.lore[0].start]),dc2:data.lore[1].dc,adjustment2:game.i18n.localize(CONFIG.PF2E.dcAdjustments[data.lore[1].start])})}})();const heldShield=actor.heldShield,actorShieldData=sheetData.data.attributes.shield;sheetData.hasShield=!!heldShield||actorShieldData.hp.max>0;const{isElite,isWeak}=actor;sheetData.isElite=isElite,sheetData.isWeak=isWeak,sheetData.notAdjusted=!isElite&&!isWeak,isElite?(sheetData.eliteState="active",sheetData.weakState="inactive"):isWeak?(sheetData.eliteState="inactive",sheetData.weakState="active"):(sheetData.eliteState="inactive",sheetData.weakState="inactive");const actorSource=actor._source,level=sheetData.data.details.level;level.adjustedHigher=level.value>Number(level.base),level.adjustedLower=level.value<Number(level.base);const{ac,hp,hardness}=sheetData.data.attributes,perception=sheetData.data.perception,sourceAttributes=actorSource.system.attributes;ac.adjustedHigher=ac.value>sourceAttributes.ac.value,ac.adjustedLower=ac.value<sourceAttributes.ac.value,hp.adjustedHigher=hp.max>sourceAttributes.hp.max,hp.adjustedLower=hp.max<sourceAttributes.hp.max,perception.adjustedHigher=perception.totalModifier>actorSource.system.perception.mod,perception.adjustedLower=perception.totalModifier<actorSource.system.perception.mod;const speeds=sheetData.data.movement.speeds,noLandTravel=n$1(speeds,["land","travel"]);sheetData.speeds={land:{label:speeds.land.label,value:speeds.land.value,details:sourceAttributes.speed.details,adjustedHigher:speeds.land.value>sourceAttributes.speed.value,adjustedLower:sourceAttributes.speed.value<speeds.land.value},...t$5(noLandTravel,(speed,type2)=>{if(!speed)return null;const legacyValue=sourceAttributes.speed.otherSpeeds.find(s=>s.type===type2)?.value??NaN,adjustedHigher=speed.value>legacyValue,adjustedLower=speed.value<legacyValue;return{label:speed.label,value:speed.value,adjustedHigher,adjustedLower}})};const traits=actor.system.traits.value;return sheetData.hasHardness=traits.includes("construct")||(Number(hardness?.value)||0)>0,sheetData.configLootableNpc=game.settings.get("pf2e","automation.lootableNPCs"),sheetData}async prepareItems(sheetData){super.prepareItems(sheetData),await this.#prepareActions(sheetData),sheetData.spellcastingEntries=await this.prepareSpellcasting()}async prepareSpellcasting(){const entries=await super.prepareSpellcasting();for(const entry of entries){const entryItem=this.actor.items.get(entry.id);entryItem?.isOfType("spellcastingEntry")&&(entry.adjustedHigher=entry.statistic?{dc:entry.statistic.dc.value>entryItem._source.system.spelldc.dc,mod:entry.statistic.check.mod>entryItem._source.system.spelldc.value}:{dc:!1,mod:!1},entry.adjustedLower=entry.statistic?{dc:entry.statistic.dc.value<entryItem._source.system.spelldc.dc,mod:entry.statistic.check.mod<entryItem._source.system.spelldc.value}:{dc:!1,mod:!1})}return entries}async#prepareActions(sheetData){const listFormatter=game.i18n.getListFormatter({style:"long",type:"conjunction"}),attacks=await Promise.all(sheetData.data.actions.map(async attack=>{const item=attack.item,rollData=item.getRollData(),description=await TextEditorPF2e.enrichHTML(item.description,{rollData}),breakdown=attack.type==="strike"?attack.breakdown:attack.statistic.dc.breakdown,damageFormula=item.dealsDamage?String(await attack.damage?.({getFormula:!0})):null,effects=(()=>{const list=attack.additionalEffects.map(e2=>game.i18n.localize(e2.label));return listFormatter.format(list)})();return{...t$3(item,["id","name","sort"]),attackType:attack.attackRollType,glyph:attack.glyph,variants:attack.variants.map((v,idx)=>({label:v.label,breakdown:idx===0?breakdown:null})),traitsAndTags:createNPCAttackTraitsAndTags(item),effects,description,damageFormula}})),actions={passive:{label:game.i18n.localize("PF2E.ActionTypePassive"),actions:[]},active:{label:game.i18n.localize("PF2E.ActionTypeAction"),actions:[]}},baseOrder=["free","reaction","action"],abilities2=t(this.actor.itemTypes.action,a=>a.sort,a=>baseOrder.indexOf(a.actionCost?.type??"action"));for(const item of abilities2){const actionGroup=item.actionCost?"active":"passive";actions[actionGroup].actions.push(createAbilityViewData(item))}sheetData.attacks=attacks,sheetData.actions=actions}activateListeners($html){super.activateListeners($html);const html2=$html[0];if(!this.isEditable)return;const selector=[".attack-input",".dc-input",".key-attribute select"].map(s=>`li[data-spellcasting-entry] ${s}`).join(", ");for(const element of htmlQueryAll(html2,selector))element.addEventListener("change",event2=>{event2.preventDefault(),this.#onChangeSpellcastingEntry(element)})}activateClickListener(html2){const handlers=super.activateClickListener(html2);return handlers["adjust-elite-weak"]=event2=>{const adjustment=htmlClosest(event2.target,"[data-adjustment]")?.dataset.adjustment;if(adjustment==="elite"||adjustment==="weak"){const alreadyHasAdjustment=adjustment===this.actor.system.attributes.adjustment;return this.actor.applyAdjustment(alreadyHasAdjustment?null:adjustment)}},handlers["open-recall-breakdown"]=()=>new RecallKnowledgePopup({},this.actor.identificationDCs).render(!0),handlers["roll-attribute"]=(event2,anchor)=>{const attribute=anchor?.parentElement?.dataset.attribute;if(!setHasElement(ATTRIBUTE_ABBREVIATIONS,attribute))return;const modifier=this.actor.system.abilities[attribute].mod,parts=["@modifier"],title=game.i18n.localize(`PF2E.AbilityCheck.${attribute}`),data={modifier},speaker=ChatMessage.getSpeaker({token:this.token,actor:this.actor});return DicePF2e.d20Roll({event:event2,parts,data,title,speaker})},this.isEditable&&(handlers["generate-attack"]=async event2=>{const actor=this.actor,itemId=htmlClosest(event2.target,"[data-item-id]")?.dataset.itemId??"",item=actor.items.get(itemId,{strict:!0});if(!item.isOfType("weapon"))return;const existing=actor.itemTypes.melee.filter(m=>m.flags.pf2e.linkedWeapon===itemId).map(m=>m.id);if(existing.length>0)if(await foundry.applications.api.DialogV2.confirm({window:{title:"PF2E.Actor.NPC.GenerateAttack.Confirm.Title",icon:"fa-solid hammer-crash"},content:game.i18n.localize("PF2E.Actor.NPC.GenerateAttack.Confirm.Content"),no:{default:!0}}))await actor.deleteEmbeddedDocuments("Item",existing,{render:!1});else return;const attacks=item.toNPCAttacks().map(a=>a.toObject());await actor.createEmbeddedDocuments("Item",attacks),ui.notifications.info(game.i18n.format("PF2E.Actor.NPC.GenerateAttack.Notification",{attack:attacks.at(0)?.name??""}))}),handlers}async#onChangeSpellcastingEntry(element){const itemId=htmlClosest(element,"li[data-spellcasting-entry]")?.dataset.itemId,spellcastingEntry=this.actor.items.get(itemId,{strict:!0}),key=element.dataset.baseProperty?.replace(/data\.items\.\d+\./,"")??"",value=element.classList.contains("focus-points")||element.classList.contains("focus-pool")?Math.min(Number(element.value)||0,3):element.nodeName==="SELECT"?element.value:Number(element.value)||0;await spellcastingEntry.update({[key]:value})}async _updateObject(event2,formData){if(this.actor.isElite||this.actor.isWeak){const{max}=this.actor.system.attributes.hp;formData["system.attributes.hp.max"]===max&&delete formData["system.attributes.hp.max"]}const shield=this.actor.heldShield;return shield&&Number.isInteger(formData["system.attributes.shield.value"])&&await shield.update({"system.hp.value":formData["system.attributes.shield.value"]}),super._updateObject(event2,formData)}}class SimpleNPCSheet extends AbstractNPCSheet{static{__name(this,"SimpleNPCSheet")}static{__name2(this,"SimpleNPCSheet")}static get defaultOptions(){const options=super.defaultOptions;return options.classes.push("simple"),{...options,width:650,height:420,scrollY:[".sheet-body"],template:"systems/pf2e/templates/actors/npc/simple-sheet.hbs"}}}const appv1$1=foundry.appv1;class PartySheetPF2e extends ActorSheetPF2e{static{__name(this,"PartySheetPF2e")}static{__name2(this,"PartySheetPF2e")}currentSummaryView="languages";static get defaultOptions(){const options=super.defaultOptions;return{...options,classes:[...options.classes,"party"],width:720,height:720,template:"systems/pf2e/templates/actors/party/sheet.hbs",scrollY:[...options.scrollY,".tab.active",".tab.active .content",".sidebar"],tabs:[{navSelector:"form > nav",contentSelector:".container",initial:"main"}]}}regionTemplates={overview:"overview.hbs",inventoryMembers:"inventory-members.hbs",exploration:"exploration.hbs",explorationSidebar:"exploration-sidebar.hbs"};_getHeaderButtons(){const buttons=super._getHeaderButtons();return game.user.isGM&&buttons.unshift({label:"JOURNAL.ActionShow",class:"show-sheet",icon:"fa-solid fa-eye",onclick:__name2(()=>{const users=game.users.filter(u=>!u.isSelf);game.socket.emit("system.pf2e",{request:"showSheet",users:users.map(u=>u.uuid),document:this.actor.uuid,options:{tab:this._tabs[0].active}})},"onclick")}),buttons}async getData(options){const base=await super.getData(options),members=this.actor.members,canDistributeCoins=game.user.isGM&&this.isEditable?{enabled:this.actor.inventory.coins.copperValue>0&&members.some(isReallyPC)}:null,travelSpeed=this.actor.system.movement.speeds.travel.value,hexplorationActivities=Object.entries(CONFIG.PF2E.hexplorationActivities).map(([key,activities])=>({speed:Number(key),activities})),totalCurrency=t$1(members,actor=>actor.inventory.currency.copperValue??0)+this.actor.inventory.currency.copperValue,totalWealth=t$1(members,actor=>actor.inventory.totalWealth.copperValue??0)+this.actor.inventory.totalWealth.copperValue;return{...base,playerRestricted:!game.pf2e.settings.metagame.partyStats,restricted:!(game.user.isGM||game.pf2e.settings.metagame.partyStats),members:this.#prepareMembers(),overviewSummary:this.#prepareOverviewSummary(),inventorySummary:{totalCurrency:new Coins({cp:totalCurrency}).toString({decimal:!0}),totalWealth:new Coins({cp:totalWealth}).toString({decimal:!0}),totalBulk:members.map(actor=>actor.inventory.bulk.value).reduce((a,b)=>a.plus(b),this.actor.inventory.bulk.value)},canDistributeCoins,explorationSummary:{speed:travelSpeed,feetPerMinute:travelSpeed*10,milesPerHour:travelSpeed/10,milesPerDay:travelSpeed*.8,activities:hexplorationActivities.find(max=>max.speed>=travelSpeed)?.activities??0},orphaned:this.actor.items.filter(i=>!i.isOfType(...this.actor.allowedItemTypes))}}#prepareMembers(){return this.actor.members.map(actor=>{const observer=actor.testUserPermission(game.user,"OBSERVER"),restricted=!(game.pf2e.settings.metagame.partyStats||observer),genderPronouns=actor.isOfType("character")&&actor.system.details.gender.value.trim()||null,blurb=actor.isOfType("character")&&actor.ancestry&&actor.class?game.i18n.format("PF2E.Actor.Character.Blurb",{level:actor.level,ancestry:actor.ancestry.name,class:actor.class.name}):actor.isOfType("familiar")&&actor.master?game.i18n.format("PF2E.Actor.Familiar.Blurb",{master:actor.master.name}):actor.isOfType("npc")&&actor.system.details.blurb.trim()||null,activities=actor.isOfType("character")?actor.system.exploration.map(id=>actor.items.get(id)).filter(e$1):[],mythicPoints=actor.getResource("mythic-points"),heroPoints=isReallyPC(actor)?actor.getResource("hero-points"):null;return{actor,hasBulk:actor.inventory.bulk.encumberedAfter!==1/0,bestSkills:Object.values(actor.skills??{}).filter(s=>s.proficient&&!s.lore).sort((a,b)=>b.mod-a.mod).slice(0,4).map(s=>({slug:s.slug,mod:s.mod,label:s.label,rank:s.rank})),genderPronouns,blurb,resource:mythicPoints?.max?mythicPoints:heroPoints,owner:actor.isOwner,observer,limited:observer||actor.limited,speeds:Object.values(actor.system.movement.speeds).filter(e$6),senses:condenseSenses(actor.perception.senses.contents).map(r2=>({acuity:r2.acuity,labelFull:r2.label??"",label:CONFIG.PF2E.senses[r2.type]??r2.type})),hp:actor.hitPoints,activities:activities.map(action2=>({uuid:action2.uuid,name:action2.name,img:action2.img,traits:createSheetTags(CONFIG.PF2E.actionTraits,action2.system.traits?.value??[])})),currency:new Coins(actor.inventory.coins.copperValue).toString({decimal:!0}),wealth:actor.inventory.totalWealth.toString({decimal:!0}),restricted}})}#prepareOverviewSummary(){const members=this.actor.members;if(members.length===0)return null;const commonLanguage=game.pf2e.settings.campaign.languages.commonLanguage,allLanguages=new Set(members.flatMap(m=>m.system.details.languages?.value??[]));commonLanguage&&allLanguages.delete(commonLanguage)&&allLanguages.add("common");const baseKnowledgeSkills=["arcana","nature","occultism","religion","crafting","society","medicine"],loreSkills=new Set(members.flatMap(m=>Object.values(m.skills)).filter(s=>s.lore).map(s=>s.slug));function getBestSkill(slug){const statistic=n$4(members,[m=>m.skills[slug]?.mod??-1/0,"desc"])?.skills[slug];return statistic?t$3(statistic,["slug","mod","label","rank"]):null}return __name(getBestSkill,"getBestSkill"),__name2(getBestSkill,"getBestSkill"),{languages:t([...allLanguages].map(language=>({slug:language,label:language==="common"&&commonLanguage?game.i18n.format("PF2E.Actor.Creature.Language.CommonLanguage",{language:game.i18n.localize(CONFIG.PF2E.languages[commonLanguage])}):game.i18n.localize(CONFIG.PF2E.languages[language]),actors:this.#getActorsThatUnderstand(language)})),l=>l.slug==="common"?"":l.label),skills:t(Object.entries(CONFIG.PF2E.skills).map(([slug,{label}])=>getBestSkill(slug)??{mod:0,label,slug,rank:0}),s=>s.label),knowledge:{regular:baseKnowledgeSkills.map(getBestSkill).filter(e$1),lore:t([...loreSkills].map(getBestSkill).filter(e$1),s=>s.label)}}}#getActorsThatUnderstand(slug){return this.actor.members.filter(m=>!!m?.system.details.languages?.value.includes(slug))}setSummaryView(view){const summary=htmlQuery(this.element[0],"[data-tab=overview] .summary");if(!summary)return;const viewElements=htmlQueryAll(summary,"[data-view]:not([data-action=change-view])");for(const element of viewElements)element.hidden=view!==element.dataset.view;for(const button of htmlQueryAll(summary,"[data-action=change-view]"))button.classList.toggle("active",button.dataset.view===view);this.currentSummaryView=view}activateListeners($html){super.activateListeners($html);const html2=$html[0];htmlQuery(html2,"a[data-action=open-meta-setting]")?.addEventListener("click",()=>{const menu=game.settings.menus.get("pf2e.metagame");if(menu){const options={highlightSetting:"showPartyStats"};new menu.type(void 0,options).render(!0)}});for(const rollLink of htmlQueryAll(html2,"[data-action=roll]")){const actorUUID=htmlClosest(rollLink,"[data-actor-uuid]")?.dataset.actorUuid,actor=fromUuidSync(actorUUID??"");actor instanceof ActorPF2e&&rollLink.addEventListener("click",event2=>{const rollMode=rollLink.dataset.secret?game.user.isGM?"gmroll":"blindroll":void 0;actor.getStatistic(rollLink.dataset.statistic??"")?.roll({...eventToRollParams(event2,{type:"check"}),rollMode})})}for(const openSheetLink of htmlQueryAll(html2,"[data-action=open-sheet]")){const tab=openSheetLink.dataset.tab,actorUUID=htmlClosest(openSheetLink,"[data-actor-uuid]")?.dataset.actorUuid,actor=fromUuidSync(actorUUID??"");actor instanceof ActorPF2e&&openSheetLink.addEventListener("click",async()=>actor.sheet.render(!0,{tab}))}this.setSummaryView(this.currentSummaryView);for(const button of htmlQueryAll(html2,"[data-action=change-view]"))button.addEventListener("click",()=>{this.setSummaryView(button.dataset.view??"languages")});for(const memberElem of htmlQueryAll(html2,"[data-actor-uuid]")){const actorUUID=memberElem.dataset.actorUuid,actor=this.document.members.find(m=>m.uuid===actorUUID);if(game.user.isGM&&htmlQuery(memberElem,"a[data-action=remove-member]")?.addEventListener("click",async event2=>{(event2.ctrlKey?!0:await foundry.applications.api.DialogV2.confirm({window:{title:"PF2E.Actor.Party.RemoveMember.Title"},content:game.i18n.localize("PF2E.Actor.Party.RemoveMember.Content"),yes:{default:!0}}))&&actor&&this.document.removeMembers(actor)}),actor?.canUserModify(game.user,"update")){const pips=htmlQuery(memberElem,"a[data-action=adjust-member-resource]"),slug=pips?.dataset.resource??"",resource=actor.getResource(slug);resource&&pips&&(pips.addEventListener("click",async()=>{const newValue=Math.min(resource.value+1,resource.max);await actor.updateResource(slug,newValue)}),pips.addEventListener("contextmenu",async event2=>{event2.preventDefault();const newValue=Math.max(resource.value-1,0);await actor.updateResource(slug,newValue)}))}}for(const languageTag of htmlQueryAll(html2,"[data-language]")){const slug=languageTag.dataset.language,members=this.#getActorsThatUnderstand(slug).map(m=>m.name).join(", "),titleLabel=game.i18n.localize("PF2E.Actor.Party.MembersLabel"),title=createHTMLElement("strong",{children:[titleLabel]}),content=createHTMLElement("span",{children:[title,members]});createTooltipster(languageTag,{content})}for(const skillTag of htmlQueryAll(html2,".summary .skills [data-slug]")){const slug=skillTag.dataset.slug??"",statistics=this.actor.members.map(m=>m.skills[slug]).filter(e$1),labels=t(statistics,s=>s.mod).map(statistic=>{const rank=statistic.rank??(statistic.proficient?1:0),prof=game.i18n.localize(CONFIG.PF2E.proficiencyLevels[rank]),label=`${statistic.actor.name} (${prof}) ${signedInteger(statistic.mod)}`,row=createHTMLElement("div",{children:[label]});return row.style.textAlign="right",row});createTooltipster(skillTag,{content:createHTMLElement("div",{children:labels})})}for(const activityElem of htmlQueryAll(html2,".activity[data-activity-uuid]")){const document2=fromUuidSync(activityElem.dataset.activityUuid??"");if(!(document2 instanceof ItemPF2e))continue;const rollData=document2.getRollData();(async()=>{const content=createHTMLElement("div",{classes:["item-summary"],innerHTML:await TextEditorPF2e.enrichHTML(document2.description,{rollData})});createTooltipster(activityElem,{contentAsHTML:!0,content,interactive:!0,maxWidth:500,side:"right",theme:"crb-hover"})})()}htmlQuery(html2,"button[data-action=distribute-coins]")?.addEventListener("click",()=>{new DistributeCoinsDialog({actor:this.actor,recipients:this.actor.members}).render(!0)}),htmlQuery(html2,"[data-action=clear-exploration]")?.addEventListener("click",async()=>{await Promise.all(this.actor.members.map(m=>m.update({"system.exploration":[]}))),ui.notifications.info("PF2E.Actor.Party.ClearActivities.Complete",{localize:!0})}),htmlQuery(html2,"[data-action=rest]")?.addEventListener("click",event2=>{game.pf2e.actions.restForTheNight({event:event2,actors:this.actor.members})}),htmlQuery(html2,"[data-action=prompt]")?.addEventListener("click",()=>{game.pf2e.gm.checkPrompt({actors:this.actor.members})})}async _onDropItemCreate(itemData){const toTest=Array.isArray(itemData)?itemData:[itemData],supported=[...PHYSICAL_ITEM_TYPES,...this.actor.baseAllowedItemTypes],invalid=toTest.filter(i=>!supported.includes(i.type));if(invalid.length){for(const source2 of invalid){const type2=game.i18n.localize(CONFIG.Item.typeLabels[source2.type]??source2.type.titleCase());ui.notifications.error(game.i18n.format("PF2E.Item.CannotAddType",{type:type2}))}return[]}return super._onDropItemCreate(itemData)}async _onDropItem(event2,data){const droppedRegion=htmlClosest(event2.target,"[data-region]")?.dataset.region,targetActorUUID=htmlClosest(event2.target,"[data-actor-uuid]")?.dataset.actorUuid;if(droppedRegion==="inventoryMembers"&&targetActorUUID){const item=await ItemPF2e.fromDropData(data),targetActor=await fromUuid(targetActorUUID);if(item?.isOfType("physical")&&item.actor&&targetActor instanceof ActorPF2e)return await this.moveItemBetweenActors(event2,item,targetActor),[item];if(!item)return[]}return super._onDropItem(event2,data)}_disableFields(_form){}async#renderRegions(element,data){for(const region of htmlQueryAll(element,"[data-region]")){const regionId=region.dataset.region??"",templateName=this.regionTemplates[regionId];if(!templateName)continue;const template=`systems/pf2e/templates/actors/party/regions/${templateName}`,result=await foundry.applications.handlebars.renderTemplate(template,data);region.innerHTML=result,this._state!==appv1$1.api.Application.RENDER_STATES.RENDERING&&this.activateListeners($(region)),await this.#renderRegions(region,data)}}render(force,options){return options?.actors?(this.getData().then(async data=>{this._saveScrollPositions(this.element),await this.#renderRegions(this.element[0],data),this._restoreScrollPositions(this.element)}),this):super.render(force,options)}async _renderInner(data,options){const result=await super._renderInner(data,options);return await this.#renderRegions(result[0],data),result}async _onDropActor(event2,data){await super._onDropActor(event2,data);const actor=fromUuidSync(data.uuid);actor instanceof CreaturePF2e&&this.document.addMembers(actor)}}class VehicleSheetPF2e extends ActorSheetPF2e{static{__name(this,"VehicleSheetPF2e")}static{__name2(this,"VehicleSheetPF2e")}static get defaultOptions(){const options=super.defaultOptions;return{...options,classes:[...options.classes,"vehicle"],width:670,height:520,tabs:[{navSelector:".sheet-navigation",contentSelector:".sheet-content",initial:"details"}],template:"systems/pf2e/templates/actors/vehicle/sheet.hbs"}}async getData(){const actions={action:{label:game.i18n.localize("PF2E.ActionsActionsHeader"),actions:[]},reaction:{label:game.i18n.localize("PF2E.ActionsReactionsHeader"),actions:[]},free:{label:game.i18n.localize("PF2E.ActionsFreeActionsHeader"),actions:[]}},actor=this.actor;for(const item of actor.itemTypes.action.toSorted((a,b)=>a.sort-b.sort)){const actionType=item.actionCost?.type??"free";actions[actionType].actions.push({...createAbilityViewData(item),img:(()=>{const actionIcon=getActionIcon(item.actionCost),defaultIcon=ItemPF2e.getDefaultArtwork(item._source).img;return item.isOfType("action")&&![actionIcon,defaultIcon].includes(item.img)?item.img:item.system.selfEffect?.img??actionIcon})()})}const description=actor.system.details.description,rollData=actor.getRollData(),enrichedDescription=await foundry.applications.ux.TextEditor.enrichHTML(description,{rollData});return Object.assign(await super.getData(),{systemFields:actor.system.schema.fields,enrichedDescription,actions,actorSizes:CONFIG.PF2E.actorSizes,actorSize:CONFIG.PF2E.actorSizes[this.actor.size],actorRarities:CONFIG.PF2E.rarityTraits,actorRarity:CONFIG.PF2E.rarityTraits[this.actor.system.traits.rarity],ac:getAdjustedValue(this.actor.attributes.ac.value,this.actor._source.system.attributes.ac.value),frequencies:CONFIG.PF2E.frequencies,saves:{fortitude:getAdjustedValue(this.actor.saves.fortitude.mod,this.actor._source.system.saves.fortitude.value)},emitsSoundOptions:[{value:"true",label:"PF2E.Actor.Hazard.EmitsSound.True"},{value:"false",label:"PF2E.Actor.Hazard.EmitsSound.False"},{value:"encounter",label:"PF2E.Actor.Hazard.EmitsSound.Encounter"}]})}activateListeners($html){super.activateListeners($html);const html2=$html[0],titleElem=htmlQuery(html2,"nav > .panel-title");if(!titleElem)throw ErrorPF2e("Unexpected missing DOM element");const initialTitle=htmlQuery(html2,".sheet-navigation .active")?.title;initialTitle&&(titleElem.title=initialTitle);for(const element of htmlQueryAll(html2,".sheet-navigation .item"))element.addEventListener("mouseover",()=>{titleElem.textContent=element.title}),element.addEventListener("mouseout",()=>{const parent=htmlClosest(element,".sheet-navigation"),title=htmlQuery(parent,".item.active")?.title;title&&(titleElem.textContent=title)})}async _updateObject(event2,formData){const emitsSound=formData["system.attributes.emitsSound"];return emitsSound!=="encounter"&&(formData["system.attributes.emitsSound"]=emitsSound==="true"),super._updateObject(event2,formData)}}class AfflictionSheetPF2e extends ItemSheetPF2e{static{__name(this,"AfflictionSheetPF2e")}static{__name2(this,"AfflictionSheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,dragDrop:[{dropSelector:"[data-stage-index]"}],hasSidebar:!0}}async getData(options){const sheetData=await super.getData(options),definingTraits=["disease","poison","curse"],traits=this.item.traits,definingTrait=definingTraits.find(t2=>traits.has(t2));return{...sheetData,itemType:game.i18n.localize(definingTrait?CONFIG.PF2E.actionTraits[definingTrait]:"PF2E.LevelLabel"),conditionTypes:n$1(CONFIG.PF2E.conditionTypes,["persistent-damage"]),damageTypes:CONFIG.PF2E.damageTypes,damageCategories:t$3(CONFIG.PF2E.damageCategories,["precision","persistent","splash"]),durationUnits:n$1(CONFIG.PF2E.timeUnits,["encounter"]),onsetUnits:n$1(CONFIG.PF2E.timeUnits,["encounter","unlimited"]),saves:CONFIG.PF2E.saves,stages:await this.prepareStages(),stageOptions:Object.fromEntries(Array.fromRange(this.item.maxStage,1).map(s=>[s.toString(),game.i18n.format("PF2E.Item.Affliction.Stage",{stage:s})]))}}async prepareStages(){const allEffectUuids=this.item.system.stages.flatMap(s=>s.effects.map(e2=>e2.uuid)),effectDocuments=await UUIDUtils.fromUUIDs(allEffectUuids),effectsByUUID=t$9(effectDocuments,e2=>[e2.uuid,e2]);return this.item.system.stages.map((stage,idx)=>({...stage,stage:idx+1,conditions:stage.conditions.map(data=>{const document2=ConditionManager.getCondition(data.slug);return{...data,document:document2}}),effects:stage.effects.map(effect=>{const document2=effectsByUUID[effect.uuid];return document2 instanceof ItemPF2e?{...effect,name:document2.name,img:document2.img}:effect})}))}activateListeners($html){super.activateListeners($html);const html2=$html[0];htmlQuery(html2,"[data-action=onset-add]")?.addEventListener("click",()=>{const onset={value:1,unit:"minutes"};this.item.update({system:{onset}})}),htmlQuery(html2,"[data-action=onset-delete]")?.addEventListener("click",()=>{this.item.update({system:{"-=onset":null}})}),htmlQuery(html2,"[data-action=add-stage]")?.addEventListener("click",()=>{const stages=foundry.utils.deepClone(this.item._source.system.stages);stages.push({damage:[],conditions:[],effects:[],duration:{value:-1,unit:"unlimited"}}),this.item.update({system:{stages}})});for(const stageElement of htmlQueryAll(html2,".affliction-stage")){const stageIndex=Number(stageElement.dataset.stageIndex),stageData=this.item._source.system.stages[stageIndex];if(stageData){htmlQuery(stageElement,"[data-action=delete-stage]")?.addEventListener("click",()=>{const stages=foundry.utils.deepClone(this.item._source.system.stages);stages.splice(stageIndex,1),this.item.update({"system.stages":stages})}),htmlQuery(stageElement,"[data-action=add-damage]")?.addEventListener("click",()=>{const stages=foundry.utils.deepClone(this.item._source.system.stages);stages[stageIndex].damage.push({formula:"",damageType:"untyped",category:null}),this.item.update({"system.stages":stages})});for(const deleteIcon of htmlQueryAll(stageElement,"[data-action=delete-damage]")){const deleteIdx=Number(htmlClosest(deleteIcon,"[data-idx]")?.dataset.idx);Number.isInteger(deleteIdx)&&deleteIcon.addEventListener("click",()=>{const stages=foundry.utils.deepClone(this.item._source.system.stages);stages[stageIndex].damage.splice(deleteIdx,1),this.item.update({"system.stages":stages})})}htmlQuery(stageElement,"[data-action=add-condition]")?.addEventListener("click",()=>{const stages=foundry.utils.deepClone(this.item._source.system.stages);stages[stageIndex].conditions.push({slug:"frightened",value:1,linked:!0}),this.item.update({"system.stages":stages})});for(const conditionEl of htmlQueryAll(stageElement,".stage-condition[data-condition-index]")){const conditionIndex=Number(conditionEl.dataset.conditionIndex),conditionData=stageData.conditions[conditionIndex];conditionData&&(htmlQuery(conditionEl,"[data-action=link-condition]")?.addEventListener("click",()=>{const stages=foundry.utils.deepClone(this.item._source.system.stages);stages[stageIndex].conditions[conditionIndex].linked=!conditionData.linked,this.item.update({"system.stages":stages})}),htmlQuery(conditionEl,"[data-action=delete-condition]")?.addEventListener("click",()=>{const stages=foundry.utils.deepClone(this.item._source.system.stages);stages[stageIndex].conditions.splice(conditionIndex,1),this.item.update({"system.stages":stages})}))}for(const deleteIcon of htmlQueryAll(stageElement,"[data-action=delete-effect")){const deleteUuid=htmlClosest(deleteIcon,"[data-effect-uuid]")?.dataset.effectUuid;deleteIcon.addEventListener("click",()=>{const stages=foundry.utils.deepClone(this.item._source.system.stages);stages[stageIndex].effects=stages[stageIndex].effects.filter(e2=>e2.uuid!==deleteUuid),this.item.update({"system.stages":stages})})}}}for(const link of htmlQueryAll(html2,"a.document-link[data-uuid]"))link.addEventListener("click",async event2=>{const uuid=htmlClosest(event2.target,"[data-uuid]")?.dataset.uuid;(await fromUuid(uuid??""))?.sheet?.render(!0)})}async _onDrop(event2){if(!this.isEditable)return;const stageIndex=Number(htmlClosest(event2.target,"[data-stage-index]")?.dataset.stageIndex);if(!Number.isInteger(stageIndex)||!this.item._source.system.stages[stageIndex])return super._onDrop(event2);const item=await(async()=>{try{const dataString=event2.dataTransfer?.getData("text/plain"),dropData=JSON.parse(dataString??"");return await ItemPF2e.fromDropData(dropData)??null}catch{return null}})();if(item?.isOfType("effect")){const stages=foundry.utils.deepClone(this.item._source.system.stages);stages[stageIndex].effects.push({uuid:item.uuid}),this.item.update({"system.stages":stages})}else ui.notifications.error("PF2E.Item.Affliction.Error.RestrictedStageItem",{localize:!0})}async _updateObject(event2,formData){const data=foundry.utils.expandObject(formData);if(data.system?.stages)for(const[stageIndex,stageData]of Object.entries(data.system?.stages)){if(!stageData)continue;const sourceData=this.#objectify(this.item._source.system.stages[Number(stageIndex)]||{});data.system.stages[Number(stageIndex)]=foundry.utils.mergeObject(sourceData,stageData)}return super._updateObject(event2,foundry.utils.flattenObject(data))}#objectify(data){return!data||typeof data!="object"?data:Array.isArray(data)?{...data}:t$9(Object.entries(data),([key,value])=>[key,this.#objectify(value)])}}class AmmoSheetPF2e extends PhysicalItemSheetPF2e{static{__name(this,"AmmoSheetPF2e")}static{__name2(this,"AmmoSheetPF2e")}async getData(options){const sheetData=await super.getData(options),item=this.item,ammoChoices=t$a(CONFIG.PF2E.ammoTypes,t$f(),t$b(([key,data])=>({value:key,label:game.i18n.localize(data.label),group:data.weapon?"Specific Weapon":void 0})),t(o=>o.label)),ammoTypeData=item.system.baseItem?CONFIG.PF2E.ammoTypes[item.system.baseItem]:null;return{...sheetData,canHaveUses:!!ammoTypeData?.magazine,isSpecialAmmo:!!item.system.craftableAs,ammoTypes:[{label:"",value:""},...ammoChoices],bulkDisabled:sheetData.bulkDisabled||!!item.system.stackGroup}}activateListeners($html){super.activateListeners($html);const html2=$html[0],specialAmmoCheckbox=html2.querySelector("input[data-action=set-special-ammo]");specialAmmoCheckbox?.addEventListener("change",event2=>{if(event2.stopPropagation(),specialAmmoCheckbox.checked)item.update({system:{craftableAs:[],baseItem:null}});else{const baseItem=item.system.baseItem??"arrows";item.update({system:{craftableAs:null,baseItem}})}});const getInput=__name2(name2=>htmlQuery(html2,`tagify-tags[name="${name2}"]`),"getInput"),item=this.item;if(item.system.craftableAs!==null){const validAmmoTypes=t$l(CONFIG.PF2E.ammoTypes,a=>!a.magazine&&!a.parent);tagify(getInput("system.craftableAs"),{whitelist:validAmmoTypes})}}async _updateObject(event2,formData){return formData["system.baseItem"]||=null,super._updateObject(event2,formData)}}class ABCSheetPF2e extends ItemSheetPF2e{static{__name(this,"ABCSheetPF2e")}static{__name2(this,"ABCSheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,dragDrop:[{dropSelector:".tab[data-tab=details]"}]}}async getData(options){const sheetData=await super.getData(options),features=Object.entries(this.item.toObject().system.items).map(([key,ref])=>({key,item:{...ref,fromWorld:ref.uuid.startsWith("Item.")}})).sort((a,b)=>a.item.level-b.item.level);return{...sheetData,features}}getLocalizedAbilities(traits){return traits!==void 0&&traits.value?traits.value.length===6?{free:game.i18n.localize("PF2E.AbilityFree")}:Object.fromEntries(traits.value.map(x=>[x,CONFIG.PF2E.abilities[x]])):{}}#isValidDrop(event2,feat){const validCategories=(htmlClosest(event2.target,"[data-valid-drops]")?.dataset.validDrops?.split(" ")??[]).filter(f=>setHasElement(FEAT_CATEGORIES,f));if(validCategories.includes(feat.category))return!0;const goodCategories=validCategories.map(c=>game.i18n.localize(CONFIG.PF2E.featCategories[c]));if(goodCategories.length>0){const badCategory=game.i18n.localize(CONFIG.PF2E.featCategories[feat.category]),warning=game.i18n.format("PF2E.Item.ABC.InvalidDrop",{badType:badCategory,goodType:goodCategories[0]});return ui.notifications.warn(warning),!1}return!0}async _onDrop(event2){event2.preventDefault();const dataString=event2.dataTransfer?.getData("text/plain"),dropData=JSON.parse(dataString??""),item=await ItemPF2e.fromDropData(dropData);if(!item?.isOfType("feat")||!this.#isValidDrop(event2,item))return;const entry={uuid:item.uuid,img:item.img,name:item.name,level:item.level},items=this.item.system.items,pathPrefix="system.items";let id;do id=foundry.utils.randomID(5);while(items[id]);await this.item.update({[`${pathPrefix}.${id}`]:entry})}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const li of htmlQueryAll(html2,"li[data-index]")){const index2=li.dataset.index,itemUUID=li.dataset.itemUuid;index2&&(itemUUID&&htmlQuery(li,"a.name")?.addEventListener("click",async()=>{(await fromUuid(itemUUID))?.sheet.render(!0)}),htmlQuery(li,"[data-action=remove]")?.addEventListener("click",()=>{this.item.update({[`system.items.-=${index2}`]:null})}))}}}class AncestrySheetPF2e extends ABCSheetPF2e{static{__name(this,"AncestrySheetPF2e")}static{__name2(this,"AncestrySheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,hasSidebar:!0}}async getData(options){const sheetData=await super.getData(options),itemData=sheetData.item;return{...sheetData,selectedBoosts:Object.fromEntries(Object.entries(itemData.system.boosts).map(([k,b])=>[k,this.getLocalizedAbilities(b)])),selectedFlaws:Object.fromEntries(Object.entries(itemData.system.flaws).map(([k,b])=>[k,this.getLocalizedAbilities(b)])),sizes:createSheetOptions(CONFIG.PF2E.actorSizes,{value:[itemData.system.size]}),languages:createSheetTags(CONFIG.PF2E.languages,itemData.system.languages),additionalLanguages:createSheetTags(CONFIG.PF2E.languages,itemData.system.additionalLanguages),visionTypeOptions:[{value:"normal",label:"PF2E.Item.Ancestry.Vision.Normal"},{value:"low-light-vision",label:"PF2E.Actor.Creature.Sense.Type.LowLightVision"},{value:"darkvision",label:"PF2E.Actor.Creature.Sense.Type.Darkvision"}]}}}class ArmorSheetPF2e extends PhysicalItemSheetPF2e{static{__name(this,"ArmorSheetPF2e")}static{__name2(this,"ArmorSheetPF2e")}async getData(options){const sheetData=await super.getData(options),armor=this.item,adjustedBulkHint=armor.isEquipped||!armor.actor?null:"PF2E.Item.Armor.UnequippedHint",runes=armor.system.runes,propertyRuneSlots=Array.fromRange(armor.isSpecific?runes.property.length:getPropertyRuneSlots(armor)).map(i=>({slug:runes.property[i]??null,label:RUNE_DATA.armor.property[runes.property[i]]?.name??null,disabled:i>0&&!runes.property[i-1]})),specificMagicData=armor._source.system.specific??t$3(armor._source.system,["material","runes"]);return{...sheetData,abpEnabled:AutomaticBonusProgression$1.isEnabled(this.actor),adjustedBulkHint,basePrice:new Coins(armor._source.system.price.value),baseTypes:sortStringRecord(CONFIG.PF2E.baseArmorTypes),categories:CONFIG.PF2E.armorCategories,groups:sortStringRecord(CONFIG.PF2E.armorGroups),otherTags:createSheetTags(CONFIG.PF2E.otherArmorTags,sheetData.data.traits.otherTags),preciousMaterials:this.getMaterialSheetData(armor,MATERIAL_DATA.armor),propertyRuneSlots,runeTypes:{...RUNE_DATA.armor,property:Object.values(RUNE_DATA.armor.property).map(p=>({slug:p.slug,name:game.i18n.localize(p.name)})).sort((a,b)=>a.name.localeCompare(b.name))},grades:t$5(CONFIG.PF2E.grades,(v,slug)=>{const label=game.i18n.localize(v),data=CONFIG.PF2E.armorImprovements[slug];return game.i18n.format("PF2E.Item.Armor.GradeOption",{grade:label,...data})}),specificMagicData}}async _updateObject(event2,formData){formData["system.acBonus"]===null&&(formData["system.acBonus"]=0);const propertyRuneIndices=[0,1,2,3],propertyRuneUpdates=propertyRuneIndices.flatMap(i=>formData[`system.runes.property.${i}`]??[]);if(propertyRuneUpdates.length>0){formData["system.runes.property"]=propertyRuneUpdates.filter(e$1);for(const index2 of propertyRuneIndices)delete formData[`system.runes.property.${index2}`]}return super._updateObject(event2,formData)}}class BackgroundSheetPF2e extends ABCSheetPF2e{static{__name(this,"BackgroundSheetPF2e")}static{__name2(this,"BackgroundSheetPF2e")}async getData(options){const data=await super.getData(options),itemData=data.item;return{...data,trainedSkills:createSheetOptions(CONFIG.PF2E.skills,itemData.system.trainedSkills),selectedBoosts:Object.fromEntries(Object.entries(itemData.system.boosts).map(([k,b])=>[k,this.getLocalizedAbilities(b)]))}}activateListeners($html){super.activateListeners($html);const html2=$html[0];htmlQuery(html2,"a[data-action=add-lore]")?.addEventListener("click",()=>{const lore=[...this.item.system.trainedSkills.lore,""];this.item.update({system:{trainedSkills:{lore}}})});for(const deleteLoreButton of htmlQueryAll(html2,"a[data-action=delete-lore]")){const idx=Number(deleteLoreButton.dataset.index);deleteLoreButton.addEventListener("click",()=>{const lore=[...this.item.system.trainedSkills.lore];lore.splice(idx,1),this.item.update({system:{trainedSkills:{lore}}})})}}_updateObject(event2,formData){const data=foundry.utils.expandObject(formData);return data.system?.trainedSkills?.lore&&(data.system.trainedSkills.lore=Object.values(data.system.trainedSkills.lore)),super._updateObject(event2,foundry.utils.flattenObject(data))}}class BookSheetPF2e extends PhysicalItemSheetPF2e{static{__name(this,"BookSheetPF2e")}static{__name2(this,"BookSheetPF2e")}}class CampaignFeatureSheetPF2e extends ItemSheetPF2e{static{__name(this,"CampaignFeatureSheetPF2e")}static{__name2(this,"CampaignFeatureSheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,hasSidebar:!0}}get validTraits(){return CONFIG.PF2E.kingmakerTraits}async getData(options){const sheetData=await super.getData(options),hasLevel=this.item.behavior!=="activity";return{...sheetData,itemType:hasLevel?game.i18n.localize(this.item.levelLabel):null,categories:KINGMAKER_CATEGORIES,actionTypes:CONFIG.PF2E.actionTypes,actionsNumber:CONFIG.PF2E.actionsNumber,frequencies:CONFIG.PF2E.frequencies,prerequisites:JSON.stringify(this.item.system.prerequisites?.value??[]),isFeat:this.item.isFeat}}activateListeners($html){super.activateListeners($html);const html2=$html[0];activateActionSheetListeners(this.item,html2);const prerequisites=htmlQuery(html2,'tagify-tags[name="system.prerequisites.value"]');prerequisites&&tagify(prerequisites,{editTags:1})}_updateObject(event2,formData){return Array.isArray(formData["system.prerequisites.value"])&&(formData["system.prerequisites.value"]=formData["system.prerequisites.value"].map(value=>({value}))),super._updateObject(event2,formData)}}class ClassSheetPF2e extends ABCSheetPF2e{static{__name(this,"ClassSheetPF2e")}static{__name2(this,"ClassSheetPF2e")}async getData(options){const sheetData=await super.getData(options),itemData=sheetData.item;return{...sheetData,proficiencyChoices:t$9(CONFIG.PF2E.proficiencyLevels,(v,index2)=>[index2,game.i18n.localize(v)]),selectedKeyAbility:this.getLocalizedAbilities(itemData.system.keyAbility),trainedSkills:createSheetTags(CONFIG.PF2E.skills,itemData.system.trainedSkills),ancestryFeatLevels:createSheetTags(CONFIG.PF2E.levels,itemData.system.ancestryFeatLevels),classFeatLevels:createSheetTags(CONFIG.PF2E.levels,itemData.system.classFeatLevels),generalFeatLevels:createSheetTags(CONFIG.PF2E.levels,itemData.system.generalFeatLevels),skillFeatLevels:createSheetTags(CONFIG.PF2E.levels,itemData.system.skillFeatLevels),skillIncreaseLevels:createSheetTags(CONFIG.PF2E.levels,itemData.system.skillIncreaseLevels)}}}class ConditionSheetPF2e extends ItemSheetPF2e{static{__name(this,"ConditionSheetPF2e")}static{__name2(this,"ConditionSheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,hasSidebar:!0}}get validTraits(){return{}}}class ConsumableSheetPF2e extends PhysicalItemSheetPF2e{static{__name(this,"ConsumableSheetPF2e")}static{__name2(this,"ConsumableSheetPF2e")}async getData(options){const sheetData=await super.getData(options),item=this.item,canHaveDamageOrHealing=DAMAGE_OR_HEALING_CONSUMABLE_CATEGORIES.has(item.category),canHaveHealing=canHaveDamageOrHealing&&item.system.category!=="snare"&&!!item.system.damage&&["vitality","void","untyped"].includes(item.system.damage.type),embeddedSpell=item.actor?item.embeddedSpell:null,shouldHaveSpell=!!embeddedSpell||["scroll","wand"].includes(item.system.category);return{...sheetData,canHaveDamageOrHealing,canHaveHealing,categories:sortStringRecord(CONFIG.PF2E.consumableCategories),damageTypes:sortStringRecord(CONFIG.PF2E.damageTypes),damageKindOptions:[{value:"damage",label:"PF2E.DamageLabel"},{value:"healing",label:"PF2E.TraitHealing"}],materialEffects:createSheetTags(CONFIG.PF2E.materialDamageEffects,item.system.material.effects),otherTags:createSheetTags(CONFIG.PF2E.otherConsumableTags,item.system.traits.otherTags),embeddedSpell:shouldHaveSpell?{uuid:embeddedSpell?.uuid??null,img:embeddedSpell?.img,name:embeddedSpell?.name,rank:embeddedSpell?.rank}:null}}activateListeners($html){super.activateListeners($html);const html2=$html[0],item=this.item;html2.querySelector("button[data-action=add-damage]")?.addEventListener("click",()=>{item.update({"system.damage":{formula:"1d4",type:"untyped",kind:"damage"}})}),html2.querySelector("a[data-action=remove-damage]")?.addEventListener("click",()=>{item.update({"system.damage":null})})}}class ContainerSheetPF2e extends PhysicalItemSheetPF2e{static{__name(this,"ContainerSheetPF2e")}static{__name2(this,"ContainerSheetPF2e")}}const DEITY_SANCTIFICATIONS=[{modal:"can",what:["holy"]},{modal:"can",what:["unholy"]},{modal:"can",what:["holy","unholy"]},{modal:"must",what:["holy"]},{modal:"must",what:["unholy"]}];class DeitySheetPF2e extends ItemSheetPF2e{static{__name(this,"DeitySheetPF2e")}static{__name2(this,"DeitySheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,dragDrop:[{dropSelector:".sheet-header, .sheet-content"}]}}async getData(options){const sheetData=await super.getData(options),spellEntries=Object.entries(sheetData.data.spells),spells=(await UUIDUtils.fromUUIDs(Object.values(sheetData.data.spells))).filter(i=>i instanceof SpellPF2e).map(spell=>{const level=Number(spellEntries.find(([,uuid])=>uuid===spell.uuid)?.at(0));return{uuid:spell.uuid,level,name:spell.name,img:spell.img}}).sort((spellA,spellB)=>spellA.level-spellB.level),sanctifications=[{value:"null",label:"PF2E.Item.Deity.Sanctification.None"},...DEITY_SANCTIFICATIONS.map(value=>{const modal=value.modal.capitalize(),what=value.what.map(c=>c.capitalize()).join("");return{value:JSON.stringify(value),label:`PF2E.Item.Deity.Sanctification.${modal}.${what}`}})];return{...sheetData,categories:[{value:"deity",label:"TYPES.Item.deity"},{value:"pantheon",label:"PF2E.Item.Deity.Category.Pantheon"},{value:"covenant",label:"PF2E.Item.Deity.Category.Covenant"},{value:"philosophy",label:"PF2E.Item.Deity.Category.Philosophy"}],sanctifications,skills:t$5(CONFIG.PF2E.skills,s=>s.label),divineFonts:createSheetOptions({harm:"PF2E.Item.Deity.DivineFont.Harm",heal:"PF2E.Item.Deity.DivineFont.Heal"},sheetData.data.font),spells}}activateListeners($html){super.activateListeners($html);const html2=$html[0],getInput=__name2(name2=>htmlQuery(html2,`tagify-tags[name="${name2}"]`),"getInput");tagify(getInput("system.attribute"),{whitelist:CONFIG.PF2E.abilities,maxTags:2}),tagify(getInput("system.skill"),{whitelist:CONFIG.PF2E.skills,maxTags:2}),tagify(getInput("system.weapons"),{whitelist:CONFIG.PF2E.baseWeaponTypes,maxTags:2});const domainWhitelist=t$m(CONFIG.PF2E.deityDomains,(_v,k)=>k.endsWith("-apocryphal"));tagify(getInput("system.domains.primary"),{whitelist:domainWhitelist,maxTags:6}),tagify(getInput("system.domains.alternate"),{whitelist:domainWhitelist,maxTags:6});const clericSpells=htmlQuery(html2,".cleric-spells");if(!clericSpells)return;for(const link of htmlQueryAll(clericSpells,"a[data-action=remove-spell]"))link.addEventListener("click",async()=>{const uuidToRemove=htmlClosest(link,"li")?.dataset.uuid,[levelToRemove]=Object.entries(this.item.system.spells).find(([_level,uuid])=>uuid===uuidToRemove)??[];if(!levelToRemove){this.render(!1);return}await this.item.update({[`system.spells.-=${levelToRemove}`]:null})});const spellLevelInputs=htmlQueryAll(clericSpells,"input[data-action=update-spell-level]");for(const input of spellLevelInputs)input.addEventListener("change",async()=>{const oldLevel=Number(input.dataset.level),uuid=this.item.system.spells[oldLevel];if(!uuid){this.render(!1);return}const newLevel=Math.clamp(Number(input.value)||1,1,10);oldLevel!==newLevel&&await this.item.update({[`system.spells.-=${oldLevel}`]:null,[`system.spells.${newLevel}`]:uuid})})}async _onDrop(event2){if(!this.isEditable)return;const item=await(async()=>{try{const dataString=event2.dataTransfer?.getData("text/plain"),dropData=JSON.parse(dataString??"");return await ItemPF2e.fromDropData(dropData)??null}catch{return null}})();if(!(item instanceof SpellPF2e))throw ErrorPF2e("Invalid item drop on deity sheet");if(item.isCantrip||item.isFocusSpell||item.isRitual){ui.notifications.error("PF2E.Item.Deity.ClericSpells.DropError",{localize:!0});return}await this.item.update({[`system.spells.${item.rank}`]:item.uuid})}async _updateObject(event2,formData){return Array.isArray(formData["system.font"])&&(formData["system.font"]=formData["system.font"].filter(f=>!!f)),typeof formData["system.skill"]=="string"&&(formData["system.skill"]||=null),super._updateObject(event2,formData)}}class EffectSheetPF2e extends ItemSheetPF2e{static{__name(this,"EffectSheetPF2e")}static{__name2(this,"EffectSheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,hasSidebar:!0}}get validTraits(){return{}}async getData(options){const badge=this.item.badge;return{...await super.getData(options),itemType:game.i18n.localize("PF2E.LevelLabel"),badgeType:badge?game.i18n.localize(`PF2E.Item.Effect.Badge.Type.${badge.type}`):"",expiryOptions:[{value:"turn-start",label:"PF2E.Item.Effect.Expiry.StartOfTurn"},{value:"turn-end",label:"PF2E.Item.Effect.Expiry.EndOfTurn"},{value:"round-end",label:"PF2E.Item.Effect.Expiry.EndOfRound"}],reevaluateOptions:[{value:"initiative-roll",label:"PF2E.Item.Effect.Badge.ReevaluateFormula.InitiativeRoll"},{value:"turn-start",label:"PF2E.Item.Effect.Badge.ReevaluateFormula.TurnStart"},{value:"turn-end",label:"PF2E.Item.Effect.Badge.ReevaluateFormula.TurnEnd"}],timeUnits:CONFIG.PF2E.timeUnits}}activateListeners($html){super.activateListeners($html);const html2=$html[0];htmlQuery(html2,"select.badge-type")?.addEventListener("change",event2=>{event2.stopPropagation()}),htmlQuery(html2,"[data-action=badge-add]")?.addEventListener("click",()=>{const badge=htmlQuery(html2,".badge-type")?.value==="formula"?{type:"formula",value:"1d20",evaluate:!0}:{type:"counter",value:1};this.item.update({system:{badge}})}),htmlQuery(html2,"[data-action=badge-delete]")?.addEventListener("click",()=>{this.item.update({"system.badge":null})}),htmlQuery(html2,"[data-action=badge-add-label")?.addEventListener("click",()=>{if(!this.item.system.badge)throw ErrorPF2e("Unexpected error adding badge label");const labels=this.item.system.badge.labels??[];labels.push(""),this.item.update({system:{badge:{labels}}})});for(const deleteIcon of htmlQueryAll(html2,"[data-action=badge-delete-label]")){const index2=Number(deleteIcon.dataset.idx);deleteIcon.addEventListener("click",()=>{const labels=this.item.system.badge?.labels;labels&&(labels.splice(index2,1),labels.length===0?this.item.update({"system.badge.labels":null}):this.item.update({system:{badge:{labels}}}))})}}async _updateObject(event2,formData){const expanded=foundry.utils.expandObject(formData),badge=expanded.system?.badge;badge&&"labels"in badge&&typeof badge.labels=="object"&&(badge.labels=Object.values(badge.labels??[])),super._updateObject(event2,foundry.utils.flattenObject(expanded))}}class EquipmentSheetPF2e extends PhysicalItemSheetPF2e{static{__name(this,"EquipmentSheetPF2e")}static{__name2(this,"EquipmentSheetPF2e")}async getData(options){const item=this.item,sheetData=await super.getData(options),category=item.system.usage.type==="installed"?"upgrade":null;return{...sheetData,itemType:category?game.i18n.format(`PF2E.Item.Equipment.Category.${category}`):sheetData.itemType,otherTags:createSheetTags(CONFIG.PF2E.otherArmorTags,item.system.traits.otherTags)}}}class FeatSheetPF2e extends ItemSheetPF2e{static{__name(this,"FeatSheetPF2e")}static{__name2(this,"FeatSheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,dragDrop:[{dropSelector:".tab[data-tab=details]"}],hasSidebar:!0}}get validTraits(){return this.item.category==="calling"?n$1(CONFIG.PF2E.featTraits,["calling","class"]):CONFIG.PF2E.featTraits}async getData(options){const sheetData=await super.getData(options),feat=this.item,hasLineageTrait=feat.system.traits.value.includes("lineage"),subfeatures=feat.system.subfeatures,showPrerequisites=feat.system.prerequisites.value.length>0&&!["ancestryfeature","curse","deityboon"].includes(feat.category);return{...sheetData,itemType:game.i18n.localize(feat.isFeature?"PF2E.LevelLabel":"PF2E.Item.Feat.LevelLabel"),actionsNumber:CONFIG.PF2E.actionsNumber,actionTypes:CONFIG.PF2E.actionTypes,acuityOptions:CONFIG.PF2E.senseAcuities,attributes:CONFIG.PF2E.abilities,canHaveKeyOptions:featCanHaveKeyOptions(feat),categories:CONFIG.PF2E.featCategories,frequencies:CONFIG.PF2E.frequencies,hasLanguages:subfeatures.languages.slots>0||subfeatures.languages.granted.length>0,hasLineageTrait,hasProficiencies:Object.keys(subfeatures.proficiencies).length>0,hasSenses:Object.keys(subfeatures.senses).length>0,mandatoryTakeOnce:hasLineageTrait||sheetData.data.onlyLevel1,maxTakableOptions:[{value:"1",label:"No"},{value:"2",label:"PF2E.Item.Feat.TakeMultiple.Two"},{value:"3",label:"PF2E.Item.Feat.TakeMultiple.Three"},{value:"4",label:"PF2E.Item.Feat.TakeMultiple.Four"},{value:"5",label:"PF2E.Item.Feat.TakeMultiple.Five"},{value:"Infinity",label:"PF2E.Item.Feat.TakeMultiple.NoLimit"}],languages:this.#getLanguageOptions(),proficiencies:this.#getProficiencyOptions(),proficiencyRankOptions:Object.fromEntries(Object.values(CONFIG.PF2E.proficiencyRanks).map((label,i)=>[`${i}`,label])),selfEffect:createSelfEffectSheetData(sheetData.data.selfEffect),senses:this.#getSenseOptions(),showPrerequisites,suppressedFeatures:(await UUIDUtils.fromUUIDs(this.item.system.subfeatures.suppressedFeatures)).map(f=>t$3(f,["uuid","name","img"]))}}#getLanguageOptions(){const subfeatures=this.item.system.subfeatures,languages=t$4(CONFIG.PF2E.languages).map(slug=>({slug,label:game.i18n.localize(CONFIG.PF2E.languages[slug])})).sort((a,b)=>a.label.localeCompare(b.label));return{slots:subfeatures.languages.slots,granted:{available:languages.filter(l=>!subfeatures.languages.granted.includes(l.slug)),selected:languages.filter(l=>subfeatures.languages.granted.includes(l.slug))}}}#getProficiencyOptions(){const feat=this.item,localize=localizer("PF2E.Actor.Character"),selectedIncreases=feat.system.subfeatures.proficiencies,sourceData=this.item.system._source.subfeatures.proficiencies,invalidKeys=Object.keys(sourceData).filter(k=>!(k in selectedIncreases));return{other:{group:null,options:[{slug:"perception",label:game.i18n.localize("PF2E.PerceptionLabel"),rank:selectedIncreases.perception?.rank??null},{slug:"spellcasting",label:game.i18n.localize("PF2E.Actor.Creature.Spellcasting.ShortLabel"),rank:selectedIncreases.spellcasting?.rank??null},...invalidKeys.map(slug=>({slug,label:slug,rank:null,invalid:!0}))].sort((a,b)=>a.label.localeCompare(b.label))},saves:{group:localize("Proficiency.SavingThrow.Title"),options:t$f(CONFIG.PF2E.saves).map(([slug,label])=>({slug,label:game.i18n.localize(label),rank:selectedIncreases[slug]?.rank??null})).sort((a,b)=>a.label.localeCompare(b.label))},attacks:{group:localize("Proficiency.Attack.Title"),options:t$f(CONFIG.PF2E.weaponCategories).map(([slug,categoryLabel])=>{const label=tupleHasValue(WEAPON_CATEGORIES,slug)?localize(`Proficiency.Attack.${sluggify(slug,{camel:"bactrian"})}`):game.i18n.localize(categoryLabel);return{slug,label,rank:selectedIncreases[slug]?.rank??null}}).sort((a,b)=>a.label.localeCompare(b.label))},defenses:{group:localize("Proficiency.Defense.Title"),options:t$f(CONFIG.PF2E.armorCategories).map(([slug,categoryLabel])=>{const label=tupleHasValue(ARMOR_CATEGORIES,slug)?localize(`Proficiency.Defense.${sluggify(slug,{camel:"bactrian"})}`):game.i18n.localize(categoryLabel);return{slug,label,rank:selectedIncreases[slug]?.rank??null}}).sort((a,b)=>a.label.localeCompare(b.label))},classes:{group:localize("ClassDC.Plural"),options:t$f(CONFIG.PF2E.classTraits).map(([slug,label])=>({slug,label:game.i18n.localize(label),attribute:selectedIncreases[slug]?.attribute??null,rank:selectedIncreases[slug]?.rank??null})).sort((a,b)=>a.label.localeCompare(b.label))}}}#getSenseOptions(){const selections=this.item.system.subfeatures.senses,senses2=t$4(CONFIG.PF2E.senses),sensesWithUnlimitedRange=SENSES_WITH_UNLIMITED_RANGE;return senses2.map(slug=>{const selection=selections[slug];return{slug,label:game.i18n.localize(CONFIG.PF2E.senses[slug]),acuity:SENSES_WITH_MANDATORY_ACUITIES[slug]??selection?.acuity??"precise",range:sensesWithUnlimitedRange.includes(slug)?null:selection?.range??null,special:slug==="darkvision"?selection?.special??null:null,canSetAcuity:!(slug in SENSES_WITH_MANDATORY_ACUITIES),canSetRange:!sensesWithUnlimitedRange.includes(slug),selected:!!selection}}).sort((a,b)=>a.label.localeCompare(b.label,game.i18n.lang))}activateListeners($html){super.activateListeners($html);const html2=$html[0],feat=this.item;activateActionSheetListeners(feat,html2);const getInput=__name2(name2=>htmlQuery(html2,`tagify-tags[name="${name2}"]`),"getInput");tagify(getInput("system.prerequisites.value"),{maxTags:6,delimiters:";"}),tagify(getInput("system.subfeatures.keyOptions"),{whitelist:CONFIG.PF2E.abilities,maxTags:3});const unselectedOptionsSelects=htmlQueryAll(html2,"select[data-unselected-options]");for(const unselectedOptionsSelect of unselectedOptionsSelects)unselectedOptionsSelect.addEventListener("change",event2=>{event2.stopPropagation(),htmlQuery(htmlClosest(unselectedOptionsSelect,"li"),"a[data-action]")?.toggleAttribute("disabled",!unselectedOptionsSelect.value)});this.#activateLanguagesListeners(html2),this.#activateProficienciesListeners(html2),this.#activateSensesListeners(html2),this.#activateSuppressedFeaturesListeners(html2)}#activateLanguagesListeners(html2){const feat=this.item,formGroup=htmlQuery(html2,".form-group[data-languages]"),newLanguageSelect=htmlQuery(formGroup,"select[data-unselected-options]");formGroup?.addEventListener("click",event2=>{const anchor=htmlClosest(event2.target,"a[data-action]");if(!anchor)return;const currentGranted=feat._source.system.subfeatures?.languages?.granted??[];if(anchor.dataset.action==="add-language"){const slug=newLanguageSelect?.value;if(!slug)throw ErrorPF2e("No option selected");slug==="slots"?feat.update({"system.subfeatures.languages.slots":1}):objectHasKey(CONFIG.PF2E.languages,slug)&&this.#getLanguageOptions().granted.available.some(o=>o.slug===slug)&&feat.update({"system.subfeatures.languages.granted":n([...currentGranted,slug])})}else if(anchor.dataset.action==="delete-language"){const slug=anchor.dataset.slug??"";feat.update({"system.subfeatures.languages.granted":currentGranted.filter(l=>l!==slug)})}else anchor.dataset.action==="delete-slots"&&feat.update({"system.subfeatures.languages.slots":0})})}#activateProficienciesListeners(html2){const feat=this.item,formGroup=htmlQuery(html2,".form-group[data-proficiencies]"),newProficiencySelect=htmlQuery(formGroup,"select[data-unselected-options]");formGroup?.addEventListener("click",event2=>{const anchor=htmlClosest(event2.target,"a[data-action]");if(anchor){if(anchor.dataset.action==="add-proficiency"){const slug=newProficiencySelect?.value;if(!slug)throw ErrorPF2e("No option selected");if(Object.values(this.#getProficiencyOptions()).map(o=>o.options).flat(2).filter(o=>!o.rank).map(o=>o.slug).includes(slug)){const data=slug in CONFIG.PF2E.classTraits?{rank:1,attribute:null}:{rank:1};feat.update({[`system.subfeatures.proficiencies.${slug}`]:data})}}else if(anchor.dataset.action==="delete-proficiency"){const slug=anchor.dataset.slug??"";slug in feat.system._source.subfeatures.proficiencies&&feat.update({[`system.subfeatures.proficiencies.-=${slug}`]:null})}}})}#activateSensesListeners(html2){const feat=this.item,formGroup=htmlQuery(html2,".form-group[data-senses]"),newSenseSelect=htmlQuery(formGroup,"select[data-unselected-options]");formGroup?.addEventListener("click",event2=>{const anchor=htmlClosest(event2.target,"a[data-action]");switch(anchor?.dataset.action){case"add-sense":{const slug=newSenseSelect?.value;if(!slug)throw ErrorPF2e("No option selected");if(this.#getSenseOptions().filter(o=>!o.selected).map(o=>o.slug).includes(slug)){const[acuity,range]=["low-light-vision","darkvision","greater-darkvision"].includes(slug)?[void 0,void 0]:["imprecise",30];feat.update({[`system.subfeatures.senses.${slug}`]:{acuity,range}})}break}case"delete-sense":{const slug=anchor.dataset.slug??"";slug in feat.system.subfeatures.senses&&feat.update({[`system.subfeatures.senses.-=${slug}`]:null});break}case"toggle-darkvision-special":{const darkvision2=feat.system.subfeatures.senses.darkvision,special=anchor.dataset.special;if(!darkvision2||!tupleHasValue(["ancestry","llv","second"],special))throw ErrorPF2e("Unexpected failure toggling darkvision special clause");const newSpecial={ancestry:special==="ancestry"?!darkvision2.special?.ancestry:!!darkvision2.special?.ancestry,llv:special==="llv"?!darkvision2.special?.llv:!!darkvision2.special?.llv,second:special==="second"?!darkvision2.special?.second:!!darkvision2.special?.second};special==="ancestry"&&newSpecial.ancestry&&newSpecial.llv?newSpecial.llv=!1:special==="llv"&&newSpecial.llv&&newSpecial.ancestry&&(newSpecial.ancestry=!1),feat.update({"system.subfeatures.senses.darkvision.special":newSpecial})}}})}#activateSuppressedFeaturesListeners(html2){for(const link of htmlQueryAll(html2,"a[data-action=remove-suppressed-feature]"))link.addEventListener("click",async()=>{const uuidToRemove=htmlClosest(link,"li")?.dataset.uuid,newFeatures=this.item._source.system.subfeatures?.suppressedFeatures?.filter(uuid=>uuid!==uuidToRemove);await this.item.update({"system.subfeatures.suppressedFeatures":newFeatures??[]})})}async _onDrop(event2){if(!this.isEditable)return;const item=await getItemFromDragEvent(event2);if(item&&!await handleSelfEffectDrop(this,item)){if(item.isOfType("feat")&&item.category==="classfeature"&&item.sourceId&&item.sourceId!==this.item.sourceId){const feats=this.item._source.system.subfeatures?.suppressedFeatures??[];if(!feats.includes(item.sourceId)){const newFeatures=[...feats,item.sourceId];await this.item.update({"system.subfeatures.suppressedFeatures":newFeatures})}return}throw ErrorPF2e("Invalid item drop")}}_updateObject(event2,formData){Array.isArray(formData["system.prerequisites.value"])&&(formData["system.prerequisites.value"]=formData["system.prerequisites.value"].map(value=>({value}))),formData["system.maxTakable"]===1/0&&(formData["system.maxTakable"]=null);const keyOptionsKey="system.subfeatures.keyOptions",hasEmptyKeyOptions=Array.isArray(formData[keyOptionsKey])&&formData[keyOptionsKey].length===0,hasNoKeyOptions=!(keyOptionsKey in formData);(hasEmptyKeyOptions||hasNoKeyOptions)&&(delete formData[keyOptionsKey],this.item._source.system.subfeatures?.keyOptions&&(formData["system.subfeatures.-=keyOptions"]=null));const pattern=/^system\.subfeatures\.proficiencies\.([a-z]+)\.to$/,proficiencies=Object.keys(formData).filter(k=>pattern.test(k));for(const path of proficiencies){const slug=pattern.exec(path)?.at(1);slug&&slug in CONFIG.PF2E.classTraits&&formData[path]!==1&&(delete formData[`system.subfeatures.proficiencies.${slug}.attribute`],formData[`system.subfeatures.proficiencies.${slug}.-=attribute`]=null)}return super._updateObject(event2,formData)}}class HeritageSheetPF2e extends ItemSheetPF2e{static{__name(this,"HeritageSheetPF2e")}static{__name2(this,"HeritageSheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,dragDrop:[{dropSelector:".sidebar"}],hasSidebar:!0}}async getData(options){const sheetData=await super.getData(options),ancestry=await(async()=>{const item=this.item.system.ancestry?await fromUuid(this.item.system.ancestry.uuid):null;return item instanceof AncestryPF2e?item:null})();return{...sheetData,ancestry,ancestryRefBroken:!!sheetData.data.ancestry&&ancestry===null}}activateListeners($html){super.activateListeners($html),$html.find('a[data-action="remove-ancestry"]').on("click",()=>{this.item.update({"system.ancestry":null})})}async _onDrop(event2){const item=await(async()=>{try{const dataString=event2.dataTransfer?.getData("text/plain"),dropData=JSON.parse(dataString??"");return await ItemPF2e.fromDropData(dropData)??null}catch{return null}})();if(!(item instanceof AncestryPF2e))throw ErrorPF2e("Invalid item drop on heritage sheet");const ancestryReference={name:item.name,slug:item.slug??sluggify(item.name),uuid:item.uuid};await this.item.update({"system.ancestry":ancestryReference})}}class KitSheetPF2e extends ItemSheetPF2e{static{__name(this,"KitSheetPF2e")}static{__name2(this,"KitSheetPF2e")}static get defaultOptions(){return Object.assign(super.defaultOptions,{dragDrop:[{dropSelector:".tab[data-tab=details]"}]})}async getData(options){const items=Object.fromEntries(Object.entries(this.item.system.items).map(([key,ref])=>[key,{...ref,fromWorld:ref.uuid.startsWith("Item.")}]));return{...await super.getData(options),priceString:this.item.price.value.toString(),items}}async _onDrop(event2){event2.preventDefault();const dragData=event2.dataTransfer?.getData("text/plain"),dragItem=JSON.parse(dragData??"");if(dragItem.type!=="Item")return;const item=await fromUuid(dragItem.uuid??"");if(!(item instanceof PhysicalItemPF2e||item instanceof KitPF2e))return;const containerId=htmlClosest(event2.target,"[data-container-id]")?.dataset.containerId,entry={uuid:item.uuid,img:item.img,quantity:1,name:item.name,isContainer:item.type==="backpack"&&!containerId,items:{}};let items=this.item.system.items,pathPrefix="system.items";containerId&&(pathPrefix=`${pathPrefix}.${containerId}.items`,items=items[containerId]?.items??{});let id;do id=foundry.utils.randomID(5);while(items[id]);await this.item.update({[`${pathPrefix}.${id}`]:entry})}async removeItem(event2){const target=htmlClosest(event2.currentTarget??null,"li"),index2=target?.dataset.index;if(!index2)return this.item;const containerId=target.closest("[data-container-id]")?.dataset.containerId,path=containerId&&containerId!==index2?`${containerId}.items.-=${index2}`:`-=${target.dataset.index}`;return await this.item.update({[`system.items.${path}`]:null})??null}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const link of htmlQueryAll(html2,"[data-action=remove]"))link.addEventListener("click",event2=>{this.removeItem(event2)})}async _updateObject(event2,formData){const priceString=String(formData["system.price.value"]??"").trim();return formData["system.price.value"]=Coins.fromString(priceString).toObject(),super._updateObject(event2,formData)}}class MeleeSheetPF2e extends ItemSheetPF2e{static{__name(this,"MeleeSheetPF2e")}static{__name2(this,"MeleeSheetPF2e")}async getData(options){const sheetData=await super.getData(options),item=this.item,isCheck=item.system.action==="strike",itemSource=this.item._source;for(const key of Object.keys(sheetData.data.damageRolls))sheetData.data.damageRolls[key].damage=itemSource.system.damageRolls[key].damage;return{...sheetData,attackActions:t$5(NPC_ATTACK_ACTIONS,a=>game.i18n.localize(a)),areaShapes:t$9(EFFECT_AREA_SHAPES,s=>[s,`PF2E.Area.Shape.${s}`]),damageTypes:CONFIG.PF2E.damageTypes,damageCategories:damageCategoriesUnique,attackEffects:createSheetOptions(this.getAttackEffectOptions(),item.system.attackEffects),modifierOrSave:{label:game.i18n.localize(`PF2E.Actor.NPC.BonusLabel.${isCheck?"modifier":"save"}`),value:item.system.bonus.value+(isCheck?0:10)}}}activateListeners($html){super.activateListeners($html);const html2=$html[0];for(const button of htmlQueryAll(html2,"a[data-action=add-partial]"))button.addEventListener("click",()=>{const newKey=foundry.utils.randomID();this.item.update({[`system.damageRolls.${newKey}`]:{damage:"1d4",damageType:"bludgeoning"}})});for(const button of htmlQueryAll(html2,"a[data-action=remove-partial]"))button.addEventListener("click",()=>{const partialKey=htmlClosest(button,"[data-key]")?.dataset.key;partialKey&&this.item.update({[`system.damageRolls.-=${partialKey}`]:null})})}async _updateObject(event2,formData){const categories=Object.keys(formData).filter(k=>/^system.damageRolls\.[a-z0-9]+\.category$/i.test(k));for(const key of categories)formData[key]||=null;return this.item.system.action!=="strike"&&typeof formData["system.bonus.value"]=="number"&&(formData["system.bonus.value"]-=10),formData["system.range.increment"]&&formData["system.range.increment"]!==this.item.system.range?.increment&&formData["system.range.max"]&&(formData["system.range.max"]=null),super._updateObject(event2,formData)}}class ShieldSheetPF2e extends PhysicalItemSheetPF2e{static{__name(this,"ShieldSheetPF2e")}static{__name2(this,"ShieldSheetPF2e")}async getData(options){const sheetData=await super.getData(options),shield=this.item,isSpecificShield=shield.isSpecific,weaponRunes=shield.system.traits.integrated?.runes,hasPotencyRune=!!weaponRunes?.potency,propertyRuneSlots=(hasPotencyRune?isSpecificShield?weaponRunes.property.map((_p,index2)=>index2):shield.system.material.type==="orichalcum"?[0,1,2,3]:[0,1,2]:[]).map(i=>({slug:weaponRunes?.property[i]??null,disabled:!weaponRunes?.potency||(i===3||weaponRunes.potency<3)&&i>0&&(!weaponRunes.property[i-1]||!isSpecificShield),readOnly:isSpecificShield})),materialData=shield.isBuckler?MATERIAL_DATA.shield.buckler:shield.isTowerShield?MATERIAL_DATA.shield.towerShield:MATERIAL_DATA.shield.shield;return{...sheetData,baseHardness:shield._source.system.hardness,basePrice:new Coins(shield._source.system.price.value),baseTypes:sortStringRecord(CONFIG.PF2E.baseShieldTypes),canChangeMaterial:!shield.isSpecific||!!shield.system.material.type,preciousMaterials:this.getMaterialSheetData(shield,materialData),propertyRuneSlots,reinforcing:t$9(REINFORCING_RUNE_LOC_PATHS,(value,index2)=>[index2,value]),weaponRunes:weaponRunes?RUNE_DATA.weapon:null,grades:t$5(CONFIG.PF2E.grades,v=>game.i18n.localize(v))}}activateListeners($html){super.activateListeners($html);const html2=$html[0];htmlQuery(html2,"input[data-action=toggle-specific")?.addEventListener("change",()=>{const newValue=this.item.system.specific?null:foundry.utils.deepClone({...t$3(this.item._source.system,["material","runes"]),integrated:this.item._source.system.traits.integrated?{runes:this.item._source.system.traits.integrated.runes}:null});this.item.update({"system.specific":newValue})})}_updateObject(event2,formData){const propertyRuneIndices=[0,1,2,3],propertyRuneUpdates=propertyRuneIndices.flatMap(i=>formData[`system.traits.integrated.runes.property.${i}`]??[]);if(propertyRuneUpdates.length>0){formData["system.traits.integrated.runes.property"]=propertyRuneUpdates.filter(e$1);for(const index2 of propertyRuneIndices)delete formData[`system.traits.integrated.runes.property.${index2}`]}return super._updateObject(event2,formData)}}const spellOverridable={traits:"PF2E.Traits",time:"PF2E.Item.Spell.Cast.Noun",target:"PF2E.SpellTargetLabel",area:"PF2E.Area.Label",range:"PF2E.TraitRange",damage:"PF2E.DamageLabel"};class SpellSheetPF2e extends ItemSheetPF2e{static{__name(this,"SpellSheetPF2e")}static{__name2(this,"SpellSheetPF2e")}static get defaultOptions(){return{...super.defaultOptions,dragDrop:[{dragSelector:"[data-variant-id]",dropSelector:"[data-can-drop=true]"}]}}get id(){const baseId=super.id,appliedOverlays=this.item.appliedOverlays;return this.item.isVariant&&appliedOverlays?`${baseId}-${[...appliedOverlays.keys()].join("-")}`:baseId}get validTraits(){return n$1(this.item.constructor.validTraits,Array.from(MAGIC_TRADITIONS))}async getData(options){const sheetData=await super.getData(options),spell=this.item,variants=spell.overlays.overrideVariants.map(variant=>({name:variant.name,variantId:variant.variantId,sort:variant.sort,actions:getActionGlyph(variant.system.time.value)})).sort((a,b)=>a.sort-b.sort),damageKinds=t$5(spell.system.damage,(damage,id)=>{const healingDisabled=!["vitality","void","untyped"].includes(damage.type)||!!damage.category,currentKinds=Array.from(spell.system.damage[id].kinds);return[{value:["damage"],label:"PF2E.DamageLabel",selected:t$6(currentKinds,["damage"]),disabled:!1},{value:["healing"],label:"PF2E.TraitHealing",selected:t$6(currentKinds,["healing"]),disabled:healingDisabled},{value:["damage","healing"],label:"PF2E.Damage.Kind.Both.Label",selected:t$6(currentKinds,["damage","healing"]),disabled:healingDisabled}]});return{...sheetData,areaShapes:t$9(EFFECT_AREA_SHAPES,s=>[s,`PF2E.Area.Shape.${s}`]),itemType:createSpellRankLabel(this.item),variants,isVariant:this.item.isVariant,damageTypes:sortStringRecord(CONFIG.PF2E.damageTypes),damageSubtypes:t$3(CONFIG.PF2E.damageCategories,DAMAGE_CATEGORIES_UNIQUE),damageKinds,materials:CONFIG.PF2E.materialDamageEffects,heightenIntervals:t$c(1,5).map(i=>({value:`${i}`,label:game.i18n.format("PF2E.SpellScalingInterval.Selection",{interval:i})})),heightenOverlays:this.#prepareHeighteningLevels(),canHeighten:this.isEditable&&this.getAvailableHeightenLevels().length>0,defensePassiveOptions:[{value:"ac",label:"PF2E.Check.DC.Specific.armor"},{value:"fortitude-dc",label:"PF2E.Check.DC.Specific.fortitude"},{value:"reflex-dc",label:"PF2E.Check.DC.Specific.reflex"},{value:"will-dc",label:"PF2E.Check.DC.Specific.will"}],defenseSaveOptions:CONFIG.PF2E.saves}}get title(){return this.item.isVariant?game.i18n.format("PF2E.Item.Spell.Variants.SheetTitle",{originalName:this.item.original?.name??""}):super.title}activateListeners($html){super.activateListeners($html);const html2=$html[0];if(this.isEditable&&this.item.isVariant){const levelInput=htmlQuery(html2,'input[name="system.level.value"');levelInput&&(levelInput.readOnly=!0)}tagify(htmlQuery(html2,'tagify-tags[name="system.traits.traditions"]'),{whitelist:CONFIG.PF2E.magicTraditions});for(const anchor of htmlQueryAll(html2,"a[data-action=add-damage-partial]"))anchor.addEventListener("click",()=>{const baseKey=this.#getOverlayFromElement(anchor)?.base??"system",emptyDamage={formula:"",kinds:["damage"],type:"bludgeoning",category:null,materials:[]};this.item.update({[`${baseKey}.damage.${foundry.utils.randomID()}`]:emptyDamage})});for(const anchor of htmlQueryAll(html2,"a[data-action=delete-damage-partial]"))anchor.addEventListener("click",()=>{const overlayData=this.#getOverlayFromElement(anchor),baseKey=overlayData?.base??"system",key=anchor.dataset.id;if(key){const values={[`${baseKey}.damage.-=${key}`]:null};!overlayData&&this.item._source.system.heightening&&(values[`${baseKey}.heightening.damage.-=${key}`]=null),this.item.update(values)}});htmlQuery(html2,"button[data-action=add-interval-heightening]")?.addEventListener("click",event2=>{event2.preventDefault();const baseKey=this.#getOverlayFromElement(event2.target)?.base??"system",data={type:"interval",interval:1,damage:t$9(Object.keys(this.item.system.damage),key=>[key,"0"]),area:0};this.item.update({[`${baseKey}.heightening`]:data})}),htmlQuery(html2,"button[data-action=add-fixed-heightening]")?.addEventListener("click",()=>{const highestLevel=this.item.getHeightenLayers().at(-1)?.level,available=this.getAvailableHeightenLevels(),level=highestLevel&&highestLevel<10?highestLevel+1:available.at(0);level!==void 0&&this.item.update({"system.heightening":{type:"fixed",levels:{[level]:{}}}})}),htmlQuery(html2,"a[data-action=delete-heightening]")?.addEventListener("click",()=>{this.item.update({"system.-=heightening":null})});for(const overlayEditor of htmlQueryAll(html2,"[data-overlay-type=heighten]")){const overlay=this.#getOverlayFromElement(overlayEditor);if(!overlay)continue;htmlQuery(overlayEditor,"a[data-action=delete-overlay]")?.addEventListener("click",()=>{if(overlay.type==="heighten"){const layers=this.item.getHeightenLayers();if(layers.length===1&&layers[0].level===overlay.level){this.item.update({"system.-=heightening":null});return}}const parts=overlay.base.split(".");parts.push(`-=${parts.pop()}`),this.item.update({[parts.join(".")]:null})});for(const addProperty of htmlQueryAll(overlayEditor,"button[data-action=add-overlay-property]")){const property=addProperty.dataset.property;!overlay.system||!property||property in overlay.system||addProperty.addEventListener("click",()=>{try{const value=this.#getDefaultProperty(property);this.item.update({[`${overlay.base}.${property}`]:value})}catch(ex){ex instanceof Error&&ui.notifications.error(ex.message)}})}for(const removeProperty of htmlQueryAll(overlayEditor,"a[data-action=delete-overlay-property]")){const property=removeProperty.dataset.property;property&&removeProperty.addEventListener("click",()=>{const updates={[`${overlay.base}.-=${property}`]:null};property==="damage"&&(updates[`${overlay.base}.-=heightening`]=null),this.item.update(updates)})}const levelSelect=htmlQuery(overlayEditor,"select[data-action=change-heighten-level]");levelSelect?.addEventListener("change",()=>{const newLevel=Number(levelSelect.value),existingData=this.item.getHeightenLayers().find(layer=>layer.level===overlay.level);this.item.update({[`system.heightening.levels.-=${overlay.level}`]:null,[`system.heightening.levels.${newLevel}`]:existingData?.system??{}})})}htmlQuery(html2,"a[data-action=variant-create]")?.addEventListener("click",()=>{this.item.overlays.create("override")});for(const anchor of htmlQueryAll(html2,"a[data-action=edit-variant]"))anchor.addEventListener("click",()=>{const overlayId=anchor.dataset.id;overlayId&&this.item.loadVariant({overlayIds:[overlayId]})?.sheet.render(!0)});for(const anchor of htmlQueryAll(html2,"a[data-action=delete-variant]"))anchor.addEventListener("click",()=>{const id=anchor.dataset.id;if(id){const variant=this.item.loadVariant({overlayIds:[id]});if(!variant)throw ErrorPF2e(`Spell ${this.item.name} (${this.item.uuid}) does not have a variant with id: ${id}`);new foundry.appv1.api.Dialog({title:game.i18n.localize("PF2E.Item.Spell.Variants.DeleteDialogTitle"),content:`<p>${game.i18n.format("PF2E.Item.Spell.Variants.DeleteDialogText",{variantName:variant.name})}</p>`,buttons:{delete:{icon:fontAwesomeIcon("fa-trash").outerHTML,label:game.i18n.localize("PF2E.DeleteShortLabel"),callback:__name2(()=>{this.item.overlays.deleteOverlay(id)},"callback")},cancel:{icon:fontAwesomeIcon("fa-times").outerHTML,label:game.i18n.localize("Cancel")}},default:"cancel"}).render(!0)}});const ritualCheckbox=htmlQuery(html2,"input[data-action=toggle-ritual-data]");ritualCheckbox?.addEventListener("click",async event2=>{event2.preventDefault(),ritualCheckbox.readOnly=!0,await this.item.update({"system.ritual":this.item.system.ritual?null:{primary:{check:""},secondary:{checks:"",casters:0}}})})}async _updateObject(event2,formData){const currentArea=this.item._source.system.area,areaSize="system.area.value"in formData?formData["system.area.value"]:currentArea?.value,areaType=formData["system.area.type"];if(!currentArea&&(areaSize||areaType)?(formData["system.area.value"]=areaSize||5,formData["system.area.type"]=areaType||"burst"):(areaSize===null||areaType==="")&&(delete formData["system.area.value"],delete formData["system.area.type"],formData["system.area"]=null),this.item.original&&this.item.appliedOverlays?.has("override")&&!this.rendered){await this.item.original.overlays.updateOverride(this.item,formData);return}super._updateObject(event2,formData)}_onDragStart(event2){const id=htmlClosest(event2.target,".variant")?.dataset.variantId??"";event2.dataTransfer?.setData("text/plain",JSON.stringify({action:"sort",data:{sourceId:id}}))}async _onDrop(event2){event2.preventDefault();const transferString=event2.dataTransfer?.getData("text/plain");if(!transferString)return;const{action:action2,data}=JSON.parse(transferString)??{};switch(action2){case"sort":{const sourceId=data?.sourceId??"",targetId=htmlClosest(event2.target,".variant")?.dataset.variantId??"";if(sourceId&&targetId&&sourceId!==targetId){const sourceVariant=this.item.loadVariant({overlayIds:[sourceId]}),targetVariant=this.item.loadVariant({overlayIds:[targetId]});if(sourceVariant&&targetVariant){const siblings=this.item.overlays.overrideVariants.filter(variant=>variant.id!==sourceId&&variant.id!==targetId);siblings.push(targetVariant);const sorting=foundry.utils.performIntegerSort(sourceVariant,{target:targetVariant,siblings,sortKey:"sort",sortBefore:!0});for(const s of sorting)await this.item.overlays.updateOverride(s.target,s.update,{render:!1});this.render(!0)}}break}}}getAvailableHeightenLevels(){const heightenLayers=this.item.getHeightenLayers();return[2,3,4,5,6,7,8,9,10].filter(level=>level>this.item.baseRank&&!heightenLayers.some(layer=>layer.level===level))}#getOverlayFromElement(target){const overlayEl=htmlClosest(target,"[data-overlay-type]");if(!overlayEl)return null;const domData=overlayEl.dataset,type2=String(domData.overlayType);if(!tupleHasValue(["heighten","variant"],type2))return null;const id="overlayId"in domData?String(domData.overlayId):null,level="level"in domData?Number(domData.level):null,collectionPath=type2==="heighten"?"system.heightening.levels":"system.variants",base=type2==="heighten"?`${collectionPath}.${level}`:`${collectionPath}.${id}`,system2=(()=>{if(type2==="heighten"){const heightening=this.item.system.heightening;if(heightening?.type==="fixed")return heightening.levels[level]??null}return null})();return{id,level,type:type2,base,dataPath:base,system:system2}}#getDefaultProperty(property){const scaling=this.item.getHeightenLayers().reverse(),baseValue=(()=>{for(const entry of[...scaling,{system:foundry.utils.deepClone(this.item._source.system)}])if(objectHasKey(entry.system,property))return entry.system[property];return null})();if(baseValue)return baseValue;if(property==="area")return{value:5,type:"burst"};throw ErrorPF2e(`Failed to initialize property ${property} for overlay`)}#prepareHeighteningLevels(){return this.item.getHeightenLayers().map(layer=>{const base=`system.heightening.levels.${layer.level}`,missing=[];for(const[key,label]of Object.entries(spellOverridable))key in layer.system||missing.push({key,label});const availableLevels=[layer.level,...this.getAvailableHeightenLevels()].sort((a,b)=>a-b);return{id:null,type:"heighten",level:layer.level,base,dataPath:base,system:layer.system,missing,heightenLevels:availableLevels.map(l=>({value:`${l}`,label:game.i18n.format("PF2E.SpellScalingOverlay.Selection",{level:ordinalString(l)})})),traits:layer.system.traits?.value?createTagifyTraits(layer.system.traits.value,{record:CONFIG.PF2E.spellTraits}):null}})}}class TreasureSheetPF2e extends PhysicalItemSheetPF2e{static{__name(this,"TreasureSheetPF2e")}static{__name2(this,"TreasureSheetPF2e")}async getData(options){const localize=localizer("PF2E.Item.Treasure.FIELDS.category.choices"),data=await super.getData(options);return this.item.system.category==="credstick"&&(data.price.label=this.item.system.price.value.toString({short:!0,unit:"credits"})),Object.assign(data,{categories:t$9(TREASURE_CATEGORIES,c=>[c,localize(c)]),currencies:CONFIG.PF2E.currencies,systemFields:this.item.system.schema.fields})}}class WeaponSheetPF2e extends PhysicalItemSheetPF2e{static{__name(this,"WeaponSheetPF2e")}static{__name2(this,"WeaponSheetPF2e")}get validTraits(){return CONFIG.PF2E.weaponTraits}async getData(options){const sheetData=await super.getData(options),weapon=this.item,runes=weapon.system.runes,propertyRuneSlots=Array.fromRange(weapon.isSpecific?runes.property.length:getPropertyRuneSlots(weapon)).map(i=>({slug:runes.property[i]??null,label:RUNE_DATA.weapon.property[runes.property[i]]?.name??null,adjusted:runes.property[i]&&!weapon._source.system.runes.property.includes(runes.property[i]),disabled:i>0&&!runes.property[i-1]})),abpEnabled=AutomaticBonusProgression$1.isEnabled(this.actor),hintText=abpEnabled?"PF2E.Item.Weapon.FromABP":"PF2E.Item.Weapon.FromMaterialAndRunes",adjustedDiceHint=weapon.system.damage.dice!==weapon._source.system.damage.dice?game.i18n.format(game.i18n.localize(hintText),{property:game.i18n.localize("PF2E.Item.Weapon.Damage.DiceNumber"),value:weapon.system.damage.dice}):null,damageDieFaces=Object.fromEntries(Object.entries(CONFIG.PF2E.damageDie).map(([num,label])=>[Number(num.replace("d","")),label]).sort(([numA],[numB])=>numA-numB)),traitSet=weapon.traits,isComboWeapon=traitSet.has("combination"),weaponRanges=Array.from(WEAPON_RANGES).reduce((ranges,range)=>({...ranges,[range]:game.i18n.format("PF2E.WeaponRangeN",{range})}),{}),rangedOnlyTraits=["combination","thrown","volley-20","volley-30","volley-50"],mandatoryRanged=setHasElement(MANDATORY_RANGED_GROUPS,weapon.group)||rangedOnlyTraits.some(trait=>traitSet.has(trait)),mandatoryMelee=sheetData.data.traits.value.some(trait=>/^thrown-\d+$/.test(trait)),otherTags=(()=>{const otherWeaponTags2=foundry.utils.deepClone(CONFIG.PF2E.otherWeaponTags);return weapon.hands!=="1"&&delete otherWeaponTags2.implement,createSheetTags(otherWeaponTags2,sheetData.data.traits.otherTags)})(),meleeUsage=sheetData.data.meleeUsage??{group:"knife",damage:{type:"piercing",die:"d4"},traits:[]},meleeUsageBaseDamage=Object.entries(CONFIG.PF2E.damageDie).map(([die,label])=>({label:`1${game.i18n.localize(label)}`,value:die})),specificMagicData=weapon._source.system.specific??t$3(weapon._source.system,["material","runes"]),ammoTypes2=t$a(CONFIG.PF2E.ammoTypes,t$f(),t$b(([key,data])=>({value:key,label:game.i18n.localize(data.label),group:data.weapon?game.i18n.localize("PF2E.Item.Ammo.Groups.WeaponSpecific"):void 0})),t(o=>o.label));ammoTypes2.push({value:"dart",label:game.i18n.localize("PF2E.Weapon.Base.dart"),group:game.i18n.localize("PF2E.Item.Ammo.Groups.Weapons")});const ammoData=objectHasKey(CONFIG.PF2E.ammoTypes,this.item.system.ammo?.baseType)?CONFIG.PF2E.ammoTypes[this.item.system.ammo.baseType]:null;return{...sheetData,abpEnabled,adjustedDiceHint,ammoTypes:[{value:"",label:game.i18n.localize("PF2E.Item.Weapon.AnyBasicAmmo")},...ammoTypes2],canHaveCapacity:!ammoData?.magazine,baseTypes:sortStringRecord(CONFIG.PF2E.baseWeaponTypes),categories:CONFIG.PF2E.weaponCategories,conditionTypes:sortStringRecord(CONFIG.PF2E.conditionTypes),damageDice:CONFIG.PF2E.damageDice,damageDie:CONFIG.PF2E.damageDie,damageDieFaces,damageTypes:sortStringRecord(CONFIG.PF2E.damageTypes),expend:weapon.system.expend===null?null:getAdjustedValue(weapon.system.expend,weapon._source.system.expend??1),groups:sortStringRecord(CONFIG.PF2E.weaponGroups),isBomb:weapon.group==="bomb",isComboWeapon,itemBonuses:CONFIG.PF2E.itemBonuses,mandatoryMelee,mandatoryRanged,meleeGroups:sortStringRecord(CONFIG.PF2E.meleeWeaponGroups),meleeUsage,meleeUsageBaseDamage,meleeUsageTraits:createSheetTags(CONFIG.PF2E.weaponTraits,meleeUsage.traits??[]),otherTags,preciousMaterials:this.getMaterialSheetData(weapon,MATERIAL_DATA.weapon),propertyRuneSlots,runeTypes:{...RUNE_DATA.weapon,property:Object.values(RUNE_DATA.weapon.property).map(p=>({slug:p.slug,name:game.i18n.localize(p.name)})).sort((a,b)=>a.name.localeCompare(b.name))},grades:t$5(CONFIG.PF2E.grades,(v,slug)=>{const label=game.i18n.localize(v),data=CONFIG.PF2E.weaponImprovements[slug];return game.i18n.format("PF2E.Item.Weapon.GradeOption",{grade:label,...data})}),specificMagicData,weaponMAP:CONFIG.PF2E.weaponMAP,weaponRanges,weaponReload:CONFIG.PF2E.weaponReload}}activateListeners($html){super.activateListeners($html);const html2=$html[0],pdElements=htmlQueryAll(html2,"[data-action=update-persistent]");for(const element of pdElements)element.addEventListener("change",async event2=>{if(!(event2.target instanceof HTMLInputElement||event2.target instanceof HTMLSelectElement))throw ErrorPF2e("Unexpected error updating persistent damage data");const diceNumber=Number(pdElements.find(e2=>e2.dataset.persistentField==="number")?.value)||0,dieFaces=Number(pdElements.find(e2=>e2.dataset.persistentField==="faces")?.value),baseDamageType=this.item.system.damage.damageType,damageType=pdElements.find(e2=>e2.dataset.persistentField==="type")?.value||baseDamageType;if(!(typeof diceNumber=="number"&&typeof dieFaces=="number"&&damageType))throw ErrorPF2e("Unexpected error updating persistent damage data");const maybeDiceNumber=Math.trunc(Math.abs(Number(event2.target.value)||0));if(event2.target.dataset.persistentField==="number"&&maybeDiceNumber===0)await this.item.update({"system.damage.persistent":null});else if(objectHasKey(CONFIG.PF2E.damageTypes,damageType)){const damage={number:Math.trunc(Math.abs(diceNumber))||1,faces:tupleHasValue([4,6,8,10,12],dieFaces)?dieFaces:null,type:damageType};await this.item.update({"system.damage.persistent":damage})}})}async _updateObject(event2,formData){formData["system.splashDamage.value"]||=0;const weapon=this.item;weapon.system.meleeUsage&&!this.item.traits.has("combination")&&(formData["system.-=meleeUsage"]=null);const propertyRuneIndices=[0,1,2,3],propertyRuneUpdates=propertyRuneIndices.flatMap(i=>{const key=`system.runes.property.${i}`,sourceValue=weapon._source.system.runes.property[i],wasAdjusted=formData[key]!==sourceValue,isEventSource=event2.target&&"name"in event2.target&&event2.target.name===key;return(wasAdjusted&&!isEventSource?sourceValue:formData[key])??[]});if(propertyRuneUpdates.length>0){formData["system.runes.property"]=propertyRuneUpdates.filter(e$1);for(const index2 of propertyRuneIndices)delete formData[`system.runes.property.${index2}`]}const emptyIsNull=["system.reload.value","system.ammo.baseType"];for(const prop2 of emptyIsNull)formData[prop2]||(formData[prop2]=null);return super._updateObject(event2,formData)}}class UserConfigPF2e extends foundry.applications.sheets.UserConfig{static{__name(this,"UserConfigPF2e")}static{__name2(this,"UserConfigPF2e")}static DEFAULT_OPTIONS={window:{contentTag:"div"}};static PARTS={tabs:{template:"templates/generic/tab-navigation.hbs"},main:{template:"systems/pf2e/templates/user/sheet.hbs"},...super.PARTS};static TABS={primary:{tabs:[{id:"core",icon:"fa-solid fa-user",label:"PACKAGECONFIG.Core"},{id:"pf2e",icon:"action-glyph",label:"PF2E.Pathfinder"}],initial:"core"}};async _prepareContext(options){const context=await super._prepareContext(options),createCharacterWidget=context.characterWidget,createAdjustedCharacterWidget=__name2((...args)=>{const widget=createCharacterWidget(...args);for(const option of widget.querySelectorAll("option"))game.actors.get(option.value)?.isOfType("party")&&option.remove();return widget},"createAdjustedCharacterWidget");return Object.assign(context,{tabs:context.tabs??this._prepareTabs("primary"),activeTab:this.tabGroups.primary,characterWidget:createAdjustedCharacterWidget})}}const fields=foundry.data.fields;class SceneConfigPF2e extends foundry.applications.sheets.SceneConfig{static{__name(this,"SceneConfigPF2e")}static{__name2(this,"SceneConfigPF2e")}static DEFAULT_OPTIONS={sheetConfig:!1,actions:{openAutomationSettings:SceneConfigPF2e.#onClickOpenAutomationSettings,openWorldClockSettings:SceneConfigPF2e.#onClickOpenWorldClockSettings}};static TABS=(()=>{const tabsConfig=super.TABS;return tabsConfig.sheet.tabs.push({id:"pf2e",icon:"action-glyph",label:"PF2E.Pathfinder"}),tabsConfig})();_configureRenderParts(options){const parts=super._configureRenderParts(options),footer=parts.footer;return delete parts.footer,parts.pf2e={template:"systems/pf2e/templates/scene/pf2e-panel.hbs"},parts.footer=footer,parts}async _preparePartContext(partId,context,options){const partContext=await super._preparePartContext(partId,context,options);return partId!=="pf2e"?partContext:Object.assign(partContext,{scene:this.document,rbvOptions:[{value:"",label:game.i18n.format("PF2E.SETTINGS.EnabledDisabled.Default",{worldDefault:game.i18n.localize(game.pf2e.settings.rbv?"PF2E.SETTINGS.EnabledDisabled.Enabled":"PF2E.SETTINGS.EnabledDisabled.Disabled")})},{value:"true",label:game.i18n.localize("PF2E.SETTINGS.EnabledDisabled.Enabled")},{value:"false",label:game.i18n.localize("PF2E.SETTINGS.EnabledDisabled.Disabled")}],syncDarknessOptions:[{value:"default",label:game.i18n.format("PF2E.SETTINGS.EnabledDisabled.Default",{worldDefault:game.i18n.localize(game.pf2e.settings.worldClock.syncDarkness?"PF2E.SETTINGS.EnabledDisabled.Enabled":"PF2E.SETTINGS.EnabledDisabled.Disabled")})},{value:"enabled",label:game.i18n.localize("PF2E.SETTINGS.EnabledDisabled.Enabled")},{value:"disabled",label:game.i18n.localize("PF2E.SETTINGS.EnabledDisabled.Disabled")}],environmentTypes:new fields.SetField(new fields.StringField({required:!0,initial:void 0,choices:CONFIG.PF2E.environmentTypes}),{label:"PF2E.Region.Environment.Type.Label",hint:"PF2E.Region.Environment.Type.SceneHint"})})}async _onRender(context,options){await super._onRender(context,options),this.#adjustForm()}#adjustForm(){const scene=this.document;if(!scene.rulesBasedVision)return;const html2=this.element,globalLight=html2.querySelector('input[name="environment.globalLight.enabled"]'),globalLightThreshold=html2.querySelector('range-picker[name="environment.globalLight.darkness.max"]');if(!(globalLight&&globalLightThreshold))throw ErrorPF2e("Unexpected error retrieving scene global light form elements");globalLight.disabled=!0,globalLightThreshold.disabled=!0,globalLight.checked=scene.environment.globalLight.enabled,globalLightThreshold.value=scene.environment.globalLight.darkness.max;const managedBy=createHTMLElement("button",{classes:["inline-control","icon","fa-solid","fa-robot"],dataset:{tooltip:!0,action:"openAutomationSettings"},aria:{label:game.i18n.localize("PF2E.SETTINGS.Automation.RulesBasedVision.ManagedBy")}});managedBy.type="button",managedBy.disabled=!game.user.isGM;for(const input of[globalLight,globalLightThreshold]){const button=managedBy.cloneNode(!0),labelEl=input.closest(".form-group")?.querySelector("label");labelEl?.classList.add("flexrow","managed-by-rbv"),labelEl?.append(button)}if(this.document.darknessSyncedToTime){const darknessInput=html2.querySelector("input[name=darkness]");if(darknessInput){darknessInput.disabled=!0,darknessInput.nextElementSibling?.classList.add("disabled");const managedBy2=WorldClock.createSyncedMessage();darknessInput.closest(".form-group")?.querySelector("p.hint")?.append(managedBy2)}}}_prepareSubmitData(event2,form,formData,updateData){const rbvSetting=formData.object["flags.pf2e.rulesBasedVision"];formData.object["flags.pf2e.rulesBasedVision"]=rbvSetting==="true"?!0:rbvSetting==="false"?!1:null;const hearingRange=formData.object["flags.pf2e.hearingRange"];if(formData.object["flags.pf2e.hearingRange"]=typeof hearingRange=="number"?Math.ceil(Math.clamp(hearingRange||5,5,3e3)/5)*5:null,!t$6(formData.object["flags.pf2e.environmentTypes"],this.document._source.flags?.pf2e?.environmentTypes??[]))for(const token of this.document.tokens)token.actor&&resetActors([token.actor],{tokens:!0});return canvas.scene?.apps["region-legend"]?.render(),super._prepareSubmitData(event2,form,formData,updateData)}static async#onClickOpenAutomationSettings(){const menu=game.settings.menus.get("pf2e.automation");if(menu){const options={highlightSetting:"rulesBasedVision"};new menu.type(void 0,options).render(!0)}}static async#onClickOpenWorldClockSettings(){const menu=game.settings.menus.get("pf2e.worldClock");menu&&new menu.type().render(!0)}}const appv1=foundry.appv1;function registerSheets(){const sheetLabel=game.i18n.localize("PF2E.SheetLabel");foundry.documents.collections.Scenes.registerSheet("pf2e",SceneConfigPF2e,{makeDefault:!0}),foundry.applications.apps.DocumentSheetConfig.registerSheet(TokenDocumentPF2e,"pf2e",TokenConfigPF2e,{makeDefault:!0}),foundry.documents.collections.Actors.unregisterSheet("core",appv1.sheets.ActorSheet);const localizeType=__name2(type2=>{const docType=type2 in CONFIG.PF2E.Actor.documentClasses?"Actor":"Item";return game.i18n.localize(`TYPES.${docType}.${type2}`)},"localizeType");foundry.documents.collections.Actors.registerSheet("pf2e",CharacterSheetPF2e,{types:["character"],label:game.i18n.format(sheetLabel,{type:localizeType("character")}),makeDefault:!0}),foundry.documents.collections.Actors.registerSheet("pf2e",NPCSheetPF2e,{types:["npc"],label:game.i18n.format(sheetLabel,{type:localizeType("npc")}),makeDefault:!0}),foundry.documents.collections.Actors.registerSheet("pf2e",SimpleNPCSheet,{types:["npc"],label:"PF2E.Actor.NPC.SimpleSheet",canBeDefault:!1}),foundry.documents.collections.Actors.registerSheet("pf2e",HazardSheetPF2e,{types:["hazard"],label:game.i18n.format(sheetLabel,{type:localizeType("hazard")})}),foundry.documents.collections.Actors.registerSheet("pf2e",LootSheetPF2e,{types:["loot"],label:game.i18n.format(sheetLabel,{type:localizeType("loot")}),makeDefault:!0}),foundry.documents.collections.Actors.registerSheet("pf2e",FamiliarSheetPF2e,{types:["familiar"],label:game.i18n.format(sheetLabel,{type:localizeType("familiar")}),makeDefault:!0}),foundry.documents.collections.Actors.registerSheet("pf2e",VehicleSheetPF2e,{types:["vehicle"],label:game.i18n.format(sheetLabel,{type:localizeType("vehicle")}),makeDefault:!0}),foundry.documents.collections.Actors.registerSheet("pf2e",PartySheetPF2e,{types:["party"],label:game.i18n.format(sheetLabel,{type:localizeType("party")}),makeDefault:!0}),foundry.documents.collections.Actors.registerSheet("pf2e",ArmySheetPF2e,{types:["army"],label:game.i18n.format(sheetLabel,{type:localizeType("army")}),makeDefault:!0}),foundry.documents.collections.Items.unregisterSheet("core",appv1.sheets.ItemSheet);const itemTypes=["lore","spellcastingEntry"];for(const itemType of itemTypes)foundry.documents.collections.Items.registerSheet("pf2e",ItemSheetPF2e,{types:[itemType],label:game.i18n.format(sheetLabel,{type:localizeType(itemType)}),makeDefault:!0});const sheetEntries=[["action",AbilitySheetPF2e],["affliction",AfflictionSheetPF2e],["ammo",AmmoSheetPF2e],["ancestry",AncestrySheetPF2e],["armor",ArmorSheetPF2e],["background",BackgroundSheetPF2e],["backpack",ContainerSheetPF2e],["book",BookSheetPF2e],["campaignFeature",CampaignFeatureSheetPF2e],["class",ClassSheetPF2e],["condition",ConditionSheetPF2e],["consumable",ConsumableSheetPF2e],["deity",DeitySheetPF2e],["effect",EffectSheetPF2e],["equipment",EquipmentSheetPF2e],["feat",FeatSheetPF2e],["heritage",HeritageSheetPF2e],["kit",KitSheetPF2e],["lore",LoreSheetPF2e],["melee",MeleeSheetPF2e],["shield",ShieldSheetPF2e],["spell",SpellSheetPF2e],["treasure",TreasureSheetPF2e],["weapon",WeaponSheetPF2e]];for(const[type2,Sheet]of sheetEntries)foundry.documents.collections.Items.registerSheet("pf2e",Sheet,{types:[type2],label:game.i18n.format(sheetLabel,{type:localizeType(type2)}),makeDefault:!0});for(const itemType of PHYSICAL_ITEM_TYPES)sheetEntries.some(([type2,_sheet])=>itemType===type2)||foundry.documents.collections.Items.registerSheet("pf2e",PhysicalItemSheetPF2e,{types:[itemType],label:game.i18n.format(sheetLabel,{type:localizeType(itemType)}),makeDefault:!0});foundry.documents.collections.Journal.unregisterSheet("core",appv1.sheets.JournalSheet),foundry.documents.collections.Journal.registerSheet("pf2e",JournalSheetPF2e,{label:__name2(()=>game.i18n.format("SHEETS.DefaultDocumentSheet",{document:game.i18n.localize("DOCUMENT.JournalEntry")}),"label"),makeDefault:!0}),foundry.documents.collections.Users.unregisterSheet("core",foundry.applications.sheets.UserConfig),foundry.documents.collections.Users.registerSheet("pf2e",UserConfigPF2e,{makeDefault:!0,label:__name2(()=>game.i18n.format("SHEETS.DefaultDocumentSheet",{document:game.i18n.localize("DOCUMENT.User")}),"label")})}__name(registerSheets,"registerSheets"),__name2(registerSheets,"registerSheets");const Setup={listen:__name2(()=>{Hooks.once("setup",()=>{InlineRollLinks.activatePF2eListeners(),DestroyableManager.initialize(),registerSheets(),game.settings.settings.get("core.chatBubblesPan").default=!1,game.settings.settings.get("core.combatTrackerConfig").default.skipDefeated=!0,game.settings.settings.get("core.dynamicTokenRing").default="coreBronze",game.settings.settings.get("core.dynamicTokenRingFitMode").default="grid",game.settings.settings.get("core.tokenAutoRotate").default=!1})},"listen")},TargetToken={listen:__name2(()=>{Hooks.on("targetToken",(user,token)=>{const tokenDocument=token.document;ui.combat.refreshTargetDisplay(tokenDocument);const actors=getSelectedActors({include:["creature"]});if(actors.length===1&&tokenDocument.object){const actorToken=actors[0].getActiveTokens(!1,!1).shift();canvas.tokens.highlightObjects&&user===game.user&&actorToken?.flankingHighlight.draw()}})},"listen")},UpdateWorldTime={listen:__name2(()=>{Hooks.on("updateWorldTime",async(_total,diff)=>{game.combat?.started||game.pf2e.effectTracker.refresh({resetItemData:!0});const worldClock=game.pf2e.worldClock;setTimeout(()=>worldClock.render(!1),1),await worldClock.animateDarkness(diff)})},"listen")},HooksPF2e={listen(){const listeners=[Load,CanvasReady,CloseWorldClockSettings,DiceSoNiceReady,DiceSoNiceRollStart,DropCanvasData,GetProseMirrorMenuDropDowns,GetSceneControlButtons,HotbarDrop,I18nInit,Init,LightingRefresh,Ready,RenderChatPopout,RenderCombatTrackerConfig,RenderDialog,RenderHUDContainer,RenderRegionLegend,RenderSettings,RenderSettingsConfig,RenderTokenHUD,Setup,TargetToken,UpdateWorldTime];for(const Listener of listeners)Listener.listen()}};HooksPF2e.listen();export{AutomaticBonusProgression$1 as AutomaticBonusProgression,ElementalBlast,RuleElement};
