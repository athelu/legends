<form class="{{cssClass}} flexcol" autocomplete="off">
  <header class="sheet-header">
    <img class="profile-img" src="{{item.img}}" data-edit="img" title="{{item.name}}" height="64" width="64"/>
    <div class="header-fields">
      <h1 class="charname"><input name="name" type="text" value="{{item.name}}" placeholder="Weapon Name"/></h1>
      
      <!-- Property Tags - NO EMPTY BOXES! -->
      {{#each system.properties as |prop|}}
        {{#if @first}}<div class="weapon-tags">{{/if}}
        <span class="tag property-tag">{{uppercase prop}}</span>
        {{#if @last}}
          {{#if ../system.damage.type}}<span class="tag damage-tag">{{uppercase ../system.damage.type}}</span>{{/if}}
          {{#if (gt ../system.range.normal 0)}}<span class="tag range-tag">{{../system.range.normal}} FT</span>{{/if}}
        </div>
        {{/if}}
      {{else}}
        {{#if system.damage.type}}
        <div class="weapon-tags">
          <span class="tag damage-tag">{{uppercase system.damage.type}}</span>
          {{#if (gt system.range.normal 0)}}<span class="tag range-tag">{{system.range.normal}} FT</span>{{/if}}
        </div>
        {{else}}{{#if (gt system.range.normal 0)}}
        <div class="weapon-tags"><span class="tag range-tag">{{system.range.normal}} FT</span></div>
        {{/if}}{{/if}}
      {{/each}}
      
      <!-- Quick Summary Stats in Header -->
      <div class="weapon-summary-row">
        <div class="summary-stat">
          <label>Damage</label>
          <span class="value">{{system.damage.base}} {{system.damage.type}}</span>
        </div>
        
        <div class="summary-stat">
          <label>Weight</label>
          <span class="value">{{system.weight}} lbs</span>
        </div>
        
        <div class="summary-stat">
          <label>Cost</label>
          <span class="value">{{system.cost}} gp</span>
        </div>
        
        <div class="summary-stat editable">
          <label>Qty</label>
          <input type="number" name="system.quantity" value="{{system.quantity}}" data-dtype="Number" min="0" class="qty-input" />
        </div>
        
        {{#if (gt system.range.normal 0)}}
        <div class="summary-stat">
          <label>Range</label>
          <span class="value">{{system.range.normal}}/{{system.range.medium}}/{{system.range.long}}</span>
        </div>
        {{/if}}
      </div>
    </div>
  </header>

  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="description">Description</a>
    <a class="item" data-tab="details">Details</a>
  </nav>

  <section class="sheet-body">

    <!-- DESCRIPTION Tab -->
    <div class="tab description" data-group="primary" data-tab="description">
      {{editor enrichedDescription target="system.description.value" button=true owner=owner editable=editable}}
    </div>

    <!-- DETAILS Tab -->
    <div class="tab details" data-group="primary" data-tab="details">
      
      <!-- Damage -->
      <div class="section-header">
        <h3>Damage</h3>
      </div>
      
      <div class="form-group-row">
        <div class="form-group">
          <label>Base Damage (Static)</label>
          <input type="number" name="system.damage.base" value="{{system.damage.base}}" data-dtype="Number" min="0" />
          <small>Light: 4, Standard: 6, Heavy 1H: 8, Two-Handed: 10</small>
        </div>
        <div class="form-group">
          <label>Damage Type</label>
          <select name="system.damage.type">
            <option value="slashing" {{#if (eq system.damage.type "slashing")}}selected{{/if}}>Slashing</option>
            <option value="piercing" {{#if (eq system.damage.type "piercing")}}selected{{/if}}>Piercing</option>
            <option value="bludgeoning" {{#if (eq system.damage.type "bludgeoning")}}selected{{/if}}>Bludgeoning</option>
          </select>
        </div>
      </div>

      <div class="damage-explanation">
        <h4>Damage Resolution (Opposed Rolls)</h4>
        <ul>
          <li><strong>Margin 0 (Tie):</strong> Defender wins, no damage</li>
          <li><strong>Margin 1:</strong> Base weapon damage</li>
          <li><strong>Margin 2:</strong> Base weapon damage + Ability value</li>
          <li><strong>Margin 3+ (Critical):</strong> Base weapon damage + Ability value + Condition</li>
        </ul>
        <p><small>Ability value depends on the weapon skill used (Ranged use Dexterity, melee use Strength, Thrown use Strength).</small></p>
      </div>

      <!-- Attack Modes -->
      <div class="section-header">
        <h3>Attack Modes</h3>
      </div>

      <div class="attack-modes-list">
        {{#each system.attackModes as |mode index|}}
        <div class="attack-mode-item" data-index="{{index}}">
          <div class="mode-header">
            <h4>Mode {{add index 1}}: <input type="text" name="system.attackModes.{{index}}.name" value="{{mode.name}}" placeholder="Melee/Ranged/Thrown" style="width: 150px;" /></h4>
            {{#if (gt ../system.attackModes.length 1)}}
            <button type="button" class="remove-attack-mode" data-index="{{index}}">
              <i class="fas fa-trash"></i> Remove
            </button>
            {{/if}}
          </div>
          
          <div class="form-group-row">
            <div class="form-group">
              <label>Type</label>
              <select name="system.attackModes.{{index}}.type">
                <option value="melee" {{#if (eq mode.type "melee")}}selected{{/if}}>Melee</option>
                <option value="ranged" {{#if (eq mode.type "ranged")}}selected{{/if}}>Ranged</option>
                <option value="thrown" {{#if (eq mode.type "thrown")}}selected{{/if}}>Thrown</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Attack Skill</label>
              <select name="system.attackModes.{{index}}.skill">
                <option value="melee" {{#if (eq mode.skill "melee")}}selected{{/if}}>Melee Combat</option>
                <option value="ranged" {{#if (eq mode.skill "ranged")}}selected{{/if}}>Ranged Combat</option>
              </select>
            </div>
            
            <div class="form-group">
              <label>Damage Attribute</label>
              <select name="system.attackModes.{{index}}.damageAttr">
                <option value="strength" {{#if (eq mode.damageAttr "strength")}}selected{{/if}}>Strength</option>
                <option value="dexterity" {{#if (eq mode.damageAttr "dexterity")}}selected{{/if}}>Dexterity</option>
              </select>
            </div>
          </div>
          
          <div class="form-group-row">
            <div class="form-group">
              <label>Defense Type</label>
              <select name="system.attackModes.{{index}}.defenseType">
                <option value="melee" {{#if (eq mode.defenseType "melee")}}selected{{/if}}>Melee (Opposed Roll)</option>
                <option value="ranged-reflex" {{#if (eq mode.defenseType "ranged-reflex")}}selected{{/if}}>Ranged (Reflex if Cover)</option>
                <option value="none" {{#if (eq mode.defenseType "none")}}selected{{/if}}>None (Autohit)</option>
              </select>
            </div>
          </div>
          
          <div class="form-group-row">
            <div class="form-group">
              <label>Short Range</label>
              <input type="number" name="system.attackModes.{{index}}.range.normal" value="{{mode.range.normal}}" data-dtype="Number" min="0" placeholder="0" />
              <small>0 for melee weapons</small>
            </div>
            <div class="form-group">
              <label>Medium Range</label>
              <input type="number" name="system.attackModes.{{index}}.range.medium" value="{{mode.range.medium}}" data-dtype="Number" min="0" placeholder="0" />
            </div>
            <div class="form-group">
              <label>Long Range</label>
              <input type="number" name="system.attackModes.{{index}}.range.long" value="{{mode.range.long}}" data-dtype="Number" min="0" placeholder="0" />
            </div>
          </div>
        </div>
        {{/each}}
        
        <button type="button" class="add-attack-mode">
          <i class="fas fa-plus"></i> Add Attack Mode
        </button>
      </div>

      <!-- Properties -->
      <div class="section-header">
        <h3>Properties</h3>
      </div>
      
      <div class="properties-grid">
        <!-- Hand Usage Properties (Mutually Exclusive) -->
        <div class="property-category">
          <h4>Hand Usage (Choose One)</h4>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="light" {{#if (contains system.properties "light")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Light</span>
              <span class="property-desc">Base damage 4. Only option for off-hand.</span>
            </div>
          </label>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="standard" {{#if (contains system.properties "standard")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Standard</span>
              <span class="property-desc">Base damage 6. Normal one-handed weapon.</span>
            </div>
          </label>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="versatile" {{#if (contains system.properties "versatile")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Versatile</span>
              <span class="property-desc">Base damage 8 (1H) or 9 (2H). Can equip with one or two hands (tracked on actor).</span>
            </div>
          </label>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="two-handed" {{#if (contains system.properties "two-handed")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Two-Handed</span>
              <span class="property-desc">Base damage 10. Requires both hands.</span>
            </div>
          </label>
        </div>

        <!-- Combat Properties -->
        <div class="property-category">
          <h4>Combat Properties</h4>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="finesse" {{#if (contains system.properties "finesse")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Finesse</span>
              <span class="property-desc">Use Agility instead of Strength for attack rolls.</span>
            </div>
          </label>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="reach" {{#if (contains system.properties "reach")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Reach</span>
              <span class="property-desc">Extends melee range by 5ft.</span>
            </div>
          </label>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="monk" {{#if (contains system.properties "monk")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Monk</span>
              <span class="property-desc">Usable with martial arts techniques.</span>
            </div>
          </label>
        </div>

        <!-- Attack Type Properties -->
        <div class="property-category">
          <h4>Attack Types</h4>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="ranged" {{#if (contains system.properties "ranged")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Ranged</span>
              <span class="property-desc">Attacks at distance (requires range values).</span>
            </div>
          </label>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="thrown" {{#if (contains system.properties "thrown")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Thrown</span>
              <span class="property-desc">Can be thrown as a ranged attack.</span>
            </div>
          </label>
        </div>

        <!-- Special Properties -->
        <div class="property-category">
          <h4>Special Properties</h4>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="alternate-strike" {{#if (contains system.properties "alternate-strike")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Alternate Strike</span>
              <span class="property-desc">Can deal an alternate damage type with different base damage.</span>
            </div>
          </label>
          
          <label class="checkbox-property">
            <input type="checkbox" name="system.properties" value="multi-type" {{#if (contains system.properties "multi-type")}}checked{{/if}} />
            <div class="property-info">
              <span class="property-name">Multi-Type</span>
              <span class="property-desc">Deals multiple damage types simultaneously.</span>
            </div>
          </label>
        </div>
      </div>

      <!-- Alternate Strike Details (conditional) -->
      {{#if (contains system.properties "alternate-strike")}}
      <div class="section-header">
        <h3>Alternate Strike Details</h3>
      </div>
      <div class="form-group-row">
        <div class="form-group">
          <label>Alternate Damage Type</label>
          <select name="system.damage.alternateType">
            <option value="" {{#unless system.damage.alternateType}}selected{{/unless}}>Select Type</option>
            <option value="slashing" {{#if (eq system.damage.alternateType "slashing")}}selected{{/if}}>Slashing</option>
            <option value="piercing" {{#if (eq system.damage.alternateType "piercing")}}selected{{/if}}>Piercing</option>
            <option value="bludgeoning" {{#if (eq system.damage.alternateType "bludgeoning")}}selected{{/if}}>Bludgeoning</option>
          </select>
        </div>
        <div class="form-group">
          <label>Alternate Base Damage</label>
          <input type="number" name="system.damage.alternate" value="{{system.damage.alternate}}" data-dtype="Number" min="0" placeholder="0" />
          <small>Base damage when using alternate strike mode</small>
        </div>
      </div>
      {{/if}}

      <!-- Multi-Type Details (conditional) -->
      {{#if (contains system.properties "multi-type")}}
      <div class="section-header">
        <h3>Multi-Type Details</h3>
      </div>
      <div class="form-group">
        <label>Additional Damage Type</label>
        <select name="system.damage.multiType">
          <option value="" {{#unless system.damage.multiType}}selected{{/unless}}>Select Additional Type</option>
          <option value="slashing" {{#if (eq system.damage.multiType "slashing")}}selected{{/if}}>Slashing</option>
          <option value="piercing" {{#if (eq system.damage.multiType "piercing")}}selected{{/if}}>Piercing</option>
          <option value="bludgeoning" {{#if (eq system.damage.multiType "bludgeoning")}}selected{{/if}}>Bludgeoning</option>
        </select>
        <small>Weapon deals both primary and additional damage type simultaneously</small>
      </div>
      {{/if}}

      <!-- Physical Properties -->
      <div class="section-header">
        <h3>Physical Properties</h3>
      </div>
      
      <div class="form-group-row">
        <div class="form-group">
          <label>Weight (lbs)</label>
          <input type="number" name="system.weight" value="{{system.weight}}" data-dtype="Number" step="0.1" min="0" />
        </div>
        <div class="form-group">
          <label>Cost (gp)</label>
          <input type="number" name="system.cost" value="{{system.cost}}" data-dtype="Number" min="0" />
        </div>
        <div class="form-group">
          <label>Quantity</label>
          <input type="number" name="system.quantity" value="{{system.quantity}}" data-dtype="Number" min="0" />
        </div>
      </div>

      <!-- Additional Notes -->
      <div class="section-header">
        <h3>Special Rules & Notes</h3>
      </div>
      
      <div class="form-group">
        <textarea name="system.notes" rows="4" placeholder="Any special rules or notes about this weapon">{{system.notes}}</textarea>
      </div>

    </div>
  </section>
</form>
